<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
h1 { text-align: center; }

#userInfo, #log { margin: 20px auto; max-width: 800px; }
#companies {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin: 20px auto;
  max-width: 800px;
}
.company {
  padding: 10px;
  background: #1f2937;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.company .left { display:flex; flex-direction:column; gap:6px; }
.company .actions { display:flex; gap:6px; align-items:center; }

button { padding: 5px 10px; cursor: pointer; }
#log { max-height: 220px; overflow-y: auto; background: #111827; padding: 10px; border-radius: 8px; }
canvas { background: #111827; border-radius: 8px; display: block; margin: 20px auto; }

#loginModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
#loginModalContent { background: #1f2937; padding: 20px; border-radius: 10px; text-align: center; }
#loginModal input { margin: 10px 0; padding: 5px; width: 80%; }

#downloadSection { text-align: center; margin-top: 20px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
#downloadSection input { padding: 5px; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì˜ì—­ -->
<div id="downloadSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥" />
  <button onclick="handleAdminAction()">ì‹¤í–‰</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let player = { holdings: {}, cash: 5000000 };
let currentUser = null;
let tradeLog = [];

let autoOn = true;
let autoTimer = null;

/* ì¢…ëª© */
const companies = [
  { name: "ë–¡ìë°©ë²”ëŒ€", price: 90000000, history: [90000000] },
  { name: "ì¹´ìŠ¤í‹¸ë¡œ", price: 5000000, history: [500] },
  { name: "ì‚¬ì¿ ë¼", price: 6000000, history: [500] },
  { name: "ì²­ë£¡", price: 5500000, history: [500] },
  { name: "ê²½ì°°ì²­", price: 4500000, history: [500] },
  { name: "EMS", price: 5300000, history: [500] },
  { name: "ì˜¬ë“œë³´ì´", price: 5500000, history: [500] },
  { name: "ì‘ë‘", price: 6500000, history: [800] }
];

/* ===== LocalStorage ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ===== */
function saveState() {
  localStorage.setItem("stockPlayer", JSON.stringify(player));
  localStorage.setItem("stockCompanies", JSON.stringify(companies));
  localStorage.setItem("stockTradeLog", JSON.stringify(tradeLog));
}
function loadState() {
  const p = localStorage.getItem("stockPlayer");
  const c = localStorage.getItem("stockCompanies");
  const t = localStorage.getItem("stockTradeLog");
  if(p) player = JSON.parse(p);
  if(c) {
    const parsed = JSON.parse(c);
    parsed.forEach((pc, i) => {
      if(companies[i]) {
        companies[i].price = pc.price;
        companies[i].history = pc.history;
      }
    });
  }
  if(t) tradeLog = JSON.parse(t);
}

/* ì‚¬ìš©ì ì €ì¥ */
function saveUser(u){ localStorage.setItem('stockUser', JSON.stringify(u)); }
function loadUser(){
  const raw = localStorage.getItem('stockUser');
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}

/* í˜ì´ì§€ ë¡œë“œ */
window.onload = () => {
  loadState();
  const saved = loadUser();
  if(saved && saved.id && saved.name){
    currentUser = saved;
    loginModal.style.display = 'none';
    renderUserInfo(); renderCompanies(); startAuto();
  } else {
    loginModal.style.display = 'flex';
  }
};

/* ë¡œê·¸ì¸ */
document.getElementById('startBtn').onclick = () => {
  const userId = document.getElementById('userId').value.trim();
  const userName = document.getElementById('userName').value.trim();
  if(userId && userName){
    currentUser = { id: userId, name: userName };
    saveUser(currentUser);
    loginModal.style.display = 'none';
    renderUserInfo(); renderCompanies(); startAuto();
  } else { alert('ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
};

/* ë Œë”ë§ */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML =
    `<strong>${currentUser.name}(${currentUser.id})</strong> | í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW`;
}
function renderCompanies() {
  const container = document.getElementById('companies');
  container.innerHTML = '';
  companies.forEach(c => {
    const held = player.holdings[c.name] || 0;
    const div = document.createElement('div');
    div.className = 'company';
    div.innerHTML = `
      <div class="left"><strong>${c.name}</strong> ${c.price.toLocaleString()} KRW | ë³´ìœ : ${held}ì£¼</div>
      <div class="actions">
        <button onclick="buy('${c.name}',1)">ë§¤ìˆ˜</button>
        <button onclick="sell('${c.name}',1)">ë§¤ë„</button>
      </div>
    `;
    container.appendChild(div);
  });
  updateChart();
  renderUserInfo();
}

/* ê±°ë˜ */
function log(msg){ const l=document.getElementById('log'); l.innerHTML = `<div>${msg}</div>`+l.innerHTML; }
function buy(name, qty){
  const c = companies.find(x=>x.name===name);
  if(player.cash < c.price*qty){ alert('í˜„ê¸ˆ ë¶€ì¡±'); return; }
  player.cash -= c.price*qty;
  player.holdings[name] = (player.holdings[name]||0)+qty;
  const now=new Date().toLocaleString();
  log(`âœ… ${currentUser.name}(${currentUser.id}) ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price}`);
  tradeLog.push({ date:now,userId:currentUser.id,userName:currentUser.name,type:'ë§¤ìˆ˜',company:name,qty,price:c.price,cash:player.cash });
  renderCompanies(); saveState();
}
function sell(name, qty){
  const c = companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<qty){ alert('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±'); return; }
  player.cash += c.price*qty;
  player.holdings[name]-=qty;
  const now=new Date().toLocaleString();
  log(`âœ… ${currentUser.name}(${currentUser.id}) ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price}`);
  tradeLog.push({ date:now,userId:currentUser.id,userName:currentUser.name,type:'ë§¤ë„',company:name,qty,price:c.price,cash:player.cash });
  renderCompanies(); saveState();
}

/* ìë™ ë³€ë™ */
function updatePrices(){
  if(!autoOn) return;
  companies.forEach(c=>{
    const shock = (Math.random()-0.5)*0.1;
    c.price = Math.max(1, Math.floor(c.price*(1+shock)));
    c.history.push(c.price);
  });
  renderCompanies(); saveState();
}
function startAuto(){ stopAuto(); autoOn=true; autoTimer=setInterval(updatePrices,5000); }
function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=null; }

/* ì°¨íŠ¸ */
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx,{ type:'line', data:{ labels:Array.from({length:companies[0].history.length},(_,i)=>i),
  datasets:companies.map(c=>({ label:c.name, data:c.history, borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false }))
}, options:{ responsive:true, scales:{ x:{ display:true,title:{ display:true,text:'í‹±'} }, y:{ display:true,title:{ display:true,text:'ê°€ê²©(KRW)'}}}}});
function updateChart(){
  chart.data.labels = Array.from({length:companies[0].history.length},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

/* ê´€ë¦¬ì ì‹¤í–‰ */
function handleAdminAction() {
  const code = document.getElementById('adminCode').value.trim();
  if(code === 'ADMIN123') {
    downloadExcel();
  } else if(code === 'RESET123') {
    if(confirm("âš  ê¸°ì—… ê°€ê²©ê³¼ ê·¸ë˜í”„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ê¸ˆ/ë³´ìœ ì£¼ì‹ì€ ìœ ì§€ë©ë‹ˆë‹¤)")) {
      resetCompaniesOnly();
    }
  } else if(code === 'RESETALL') {
    if(confirm("âš  ëª¨ë“  ë°ì´í„°(í˜„ê¸ˆ/ë³´ìœ ì£¼ì‹/ê¸°ì—…ê°€ê²©/ê±°ë˜ê¸°ë¡)ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      resetAll();
    }
  } else {
    alert('ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.');
  }
}

/* ê¸°ì—… ê°€ê²©/ê·¸ë˜í”„ë§Œ ì´ˆê¸°í™” */
function resetCompaniesOnly() {
  companies.forEach(c => {
    if(c.name === "ë–¡ìë°©ë²”ëŒ€") { c.price = 1000; c.history = [1000]; }
    else if(c.name === "ì¹´ìŠ¤í‹¸ë¡œ") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì‚¬ì¿ ë¼") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì²­ë£¡") { c.price = 500; c.history = [500]; }
    else if(c.name === "ê²½ì°°ì²­") { c.price = 500; c.history = [500]; }
    else if(c.name === "EMS") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì˜¬ë“œë³´ì´") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì‘ë‘") { c.price = 800; c.history = [800]; }
  });
  tradeLog = [];
  saveState();
  renderCompanies(); updateChart();
  log("ğŸ›‘ ê¸°ì—… ê°€ê²©ê³¼ ê·¸ë˜í”„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ê¸ˆ/ë³´ìœ ì£¼ì‹ì€ ìœ ì§€)");
}

/* ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” */
function resetAll() {
  player = { holdings: {}, cash: 5000000 };
  tradeLog = [];
  companies.forEach(c => {
    if(c.name === "ë–¡ìë°©ë²”ëŒ€") { c.price = 1000; c.history = [1000]; }
    else if(c.name === "ì¹´ìŠ¤í‹¸ë¡œ") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì‚¬ì¿ ë¼") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì²­ë£¡") { c.price = 500; c.history = [500]; }
    else if(c.name === "ê²½ì°°ì²­") { c.price = 500; c.history = [500]; }
    else if(c.name === "EMS") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì˜¬ë“œë³´ì´") { c.price = 500; c.history = [500]; }
    else if(c.name === "ì‘ë‘") { c.price = 800; c.history = [800]; }
  });
  localStorage.clear();
  renderUserInfo(); renderCompanies(); updateChart();
  log("ğŸ›‘ ì „ì²´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ê¸ˆ/ë³´ìœ ì£¼ì‹ í¬í•¨)");
}

/* ì—‘ì…€ ë‹¤ìš´ë¡œë“œ */
function downloadExcel(){
  if(tradeLog.length===0){ alert('ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const sortedLog=[...tradeLog].sort((a,b)=>new Date(b.date)-new Date(a.date));
  let csv='ë‚ ì§œ,ê³ ìœ ë²ˆí˜¸,ì´ë¦„,íƒ€ì…,ê¸°ì—…,ê°€ê²©,ìˆ˜ëŸ‰,í˜„ê¸ˆ,ì´ìì‚°\n';
  sortedLog.forEach(t=>{
    const evalQty = t.company && t.company!=='í˜„ê¸ˆ' ? (player.holdings[t.company]||0) : 0;
    const totalAsset = t.cash + evalQty*t.price;
    csv += `${t.date},${t.userId},${t.userName},${t.type},${t.company},${t.price},${t.qty},${t.cash},${totalAsset}\n`;
  });
  const bom=new Uint8Array([0xEF,0xBB,0xBF]);
  const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`trade_log_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click(); document.body.removeChild(a);
}
</script>
</body>
</html>


