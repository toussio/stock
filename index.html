<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:960px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:960px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:6px 10px; cursor:pointer; }
input[type="number"], input[type="text"] { padding:6px; }
#log { max-height:240px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }

/* 로그인 모달 */
#loginModal { display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; width:320px; }
#loginModal input { margin:10px 0; padding:8px; width:100%; box-sizing:border-box; }

/* 관리자 */
#adminSection { text-align:center; margin-top:20px; }
#adminModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModal .panel { background:#1f2937; padding:20px; border-radius:10px; width:720px; max-height:90%; overflow:auto; position:relative; }
#adminModal .panel .close { position:absolute; top:10px; right:10px; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터 (Firestore 자동 초기화)</h1>

<div id="userRow">
  <div id="userInfo"></div>
  <div>
    <input id="acctNo" type="text" placeholder="계좌번호" />
    <input id="cashAmount" type="number" placeholder="금액" />
    <input id="cashMemo" type="text" placeholder="메모(선택)" />
    <button onclick="requestDeposit()">입금 요청</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="960" height="420"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>거래 시작 전 정보 입력</h2>
    <input type="text" id="userId" placeholder="고유번호 입력" />
    <input type="text" id="userName" placeholder="이름 입력" />
    <button id="startBtn">시작</button>
  </div>
</div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력 (ADMIN123)" />
  <button onclick="openAdminPanel()">실행</button>
</div>

<!-- 관리자 모달 -->
<div id="adminModal">
  <div class="panel">
    <button class="close" onclick="closeAdminPanel()">✖</button>
    <h2>관리자 메뉴</h2>
    <div id="requestsList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* Firebase 설정 */
const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.firebasestorage.app", 
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db  = getFirestore(app);

/* 상태 */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;
const MAX_HISTORY = 20;

/* 기업 기본값 */
let companies = [
  { name:"떡잎방범대", price:1000 },
  { name:"카스틸로", price:500 },
  { name:"사쿠라", price:500 },
  { name:"청룡", price:500 },
  { name:"경찰청", price:500 },
  { name:"EMS", price:500 },
  { name:"올드보이", price:500 },
  { name:"작두", price:800 }
];

/* 로그 */
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

/* 로그인 + 자동 초기화 */
async function loginUser(userId,userName){
  // users 초기화
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(!snap.exists()){
    await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
    log(`✅ 새 유저 생성: ${userName} (${userId})`);
    player={ cash:5000000, holdings:{} };
  } else {
    player=snap.data();
  }
  currentUser={ id:userId, name:userName };

  // companies 초기화
  for(const c of companies){
    const ref=doc(db,"companies",c.name);
    const compSnap=await getDoc(ref);
    if(!compSnap.exists()){
      await setDoc(ref,{ price:c.price, history:[c.price], range:0.05 });
      log(`🏢 기업 추가됨: ${c.name}`);
    }
  }

  renderUserInfo(); renderCompanies();
}

document.getElementById("startBtn").addEventListener("click", async ()=>{
  const uid=document.getElementById("userId").value.trim();
  const uname=document.getElementById("userName").value.trim();
  if(!uid||!uname){ alert("입력 필요"); return; }
  await loginUser(uid,uname);
  document.getElementById("loginModal").style.display="none";
});

/* UI */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=
    `<strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> |
     현금: ${player.cash.toLocaleString()} KRW`;
}
function renderCompanies(){
  const container=document.getElementById('companies');
  container.innerHTML='';
  companies.forEach(c=>{
    const div=document.createElement('div');
    div.className='company';
    div.innerHTML=`
      <div><strong>${c.name}</strong><br/>가격: <span id="price-${c.name}">${c.price}</span> KRW</div>
      <div>
        <input type="number" id="qty-${c.name}" value="1" min="1" style="width:60px;">
        <button onclick="buy('${c.name}')">매수</button>
        <button onclick="sell('${c.name}')">매도</button>
      </div>`;
    container.appendChild(div);
  });
  updateChart();
}

/* 거래 */
window.buy=async function(name){
  const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
  const c=companies.find(x=>x.name===name);
  if(player.cash<c.price*qty){ alert("현금 부족"); return; }
  player.cash-=c.price*qty;
  player.holdings[name]=(player.holdings[name]||0)+qty;
  log(`✅ ${name} ${qty}주 매수`);
  renderUserInfo();
};
window.sell=async function(name){
  const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
  const c=companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<qty){ alert("보유 부족"); return; }
  player.cash+=c.price*qty;
  player.holdings[name]-=qty;
  log(`✅ ${name} ${qty}주 매도`);
  renderUserInfo();
};

/* 입금 요청 */
window.requestDeposit=async function(){
  if(!currentUser){ alert("로그인 필요"); return; }
  const acct=document.getElementById("acctNo").value.trim();
  const amt=parseInt(document.getElementById("cashAmount").value,10);
  const memo=document.getElementById("cashMemo").value.trim();
  if(!acct||!amt){ alert("계좌/금액 확인"); return; }
  await addDoc(collection(db,"depositRequests"),{
    userId:currentUser.id,userName:currentUser.name,
    account:acct,amount:amt,memo,approved:null,
    createdAt:serverTimestamp()
  });
  log(`📨 입금 요청: ${amt.toLocaleString()} KRW`);
};

/* 차트 */
const ctx=document.getElementById('chart').getContext('2d');
chart=new Chart(ctx,{ type:'line',
  data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:[c.price],borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false}))},
  options:{ responsive:true, animation:false }
});
function updateChart(){
  chart.data.labels=Array.from({length:companies[0].history?.length||1},(_,i)=>i);
  chart.update();
}
</script>
</body>
</html>
