<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46; --warn:#92400e;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1100px; }
    #depositForm input { padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    #depositForm .memo { min-width:220px; }
    #depositForm button#requestDepositBtn { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    #depositForm button#requestDepositBtn:hover { background:var(--accentH); }

    button { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #chartWrap { position:relative; margin:20px auto; max-width:1100px; height:400px; background:#111827; border-radius:10px; overflow:hidden; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1100px; }
    .company { background:var(--card); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; position:relative; }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:600; }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    .status-badge{ font-size:14px; line-height:1; padding:4px 10px; border-radius:999px; background:#0b1220; border:1px solid #374151; color:var(--ink2); }
    .delisted-badge{ background:#331010; border-color:#7f1d1d; color:#fecaca; }

    #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }
    .log-item { padding:6px 0; border-bottom:1px dashed #374151; font-size:14px; }
    .req-card { background:var(--card); border-radius:10px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:10px; text-align:center; width:min(90%,520px); position:relative; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:8px; width:90%; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    #adminLogin{ text-align:center; margin:20px auto; max-width:1100px; }
    #adminLogin input{ padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:0; border-radius:10px; position:relative;}
    #adminPanelAll { position:fixed; top:50px; left:50px; z-index:9999; width:90%; max-width:1100px; pointer-events:auto; box-shadow:0 20px 40px rgba(0,0,0,.35); }
    #adminPanelHeader { background:#374151; padding:8px 44px 8px 12px; cursor:move; border-radius:10px 10px 0 0; font-weight:700; user-select:none; position:relative; }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    /* íƒ­ ë‚´ë¶€ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    .tab-inner { padding:10px 12px 16px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0; }
    .row input[type="number"], .row input[type="text"] { padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .row label { color:#cbd5e1; font-size:14px; }

    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

  <!-- ìƒë‹¨ ì‚¬ìš©ì ì˜ì—­ -->
  <div id="userRow">
    <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
    <div>
      <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btnOpenWithdraw">ì¶œê¸ˆ ìš”ì²­</button>
      <button id="btnOpenNotice">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button id="btnOpenNews">ğŸ“° ë‰´ìŠ¤ ë³´ê¸° <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span></button>
    </div>
  </div>

  <!-- ì…ê¸ˆ ìš”ì²­ -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button id="requestDepositBtn">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <!-- ì°¨íŠ¸ + ì¢…ëª© ì¹´ë“œ + ë¡œê·¸ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log" aria-live="polite"></div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h2 id="loginTitle">ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
      <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <button id="startBtn">ì‹œì‘</button>
    </div>
  </div>

  <!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="withdrawModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="withdrawTitle">
      <button class="xbtn" id="btnCloseWithdraw" aria-label="ë‹«ê¸°">âœ•</button>
      <h2 id="withdrawTitle">ì¶œê¸ˆ ìš”ì²­</h2>
      <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥"><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
      <input type="text" id="withdrawAccount" placeholder="ë³¸ì¸ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥"><br>
      <button id="submitWithdrawBtn">ìš”ì²­</button>
    </div>
  </div>

  <!-- ê³µì§€ ëª¨ë‹¬ -->
  <div id="noticeModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
      <button class="xbtn" id="btnCloseNotice" aria-label="ë‹«ê¸°">âœ•</button>
      <h2 id="noticeTitle">ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
      <div id="noticeContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button id="btnCloseNotice2">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ -->
  <div id="newsModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="margin-top:40px;" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
      <button class="xbtn" id="btnCloseNews" aria-label="ë‹«ê¸°">âœ•</button>
      <h2 id="newsTitle">ğŸ“° ìµœì‹  ë‰´ìŠ¤</h2>
      <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button id="btnCloseNews2">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ (í•­ìƒ ë³´ì„) -->
  <div id="adminLogin" aria-label="ê´€ë¦¬ì ë¡œê·¸ì¸ ì˜ì—­">
    <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ (ì˜ˆ: graph703)">
    <button id="btnAdminLogin">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ (ê¸°ë³¸ ìˆ¨ê¹€, ë“œë˜ê·¸ ê°€ëŠ¥) -->
  <div id="adminPanelAll" class="admin-panel" style="display:none;">
    <div id="adminPanelHeader">
      âš™ï¸ ê´€ë¦¬ì í†µí•© íŒ¨ë„
      <button class="xbtn" id="btnAdminClose" aria-label="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="tab-inner">
      <div class="row" style="margin-bottom:10px;">
        <button data-tab="graph">ğŸ“Š ê·¸ë˜í”„</button>
        <button data-tab="users">ğŸ‘¥ ìœ ì €</button>
        <button data-tab="finance">ğŸ’³ ì…ì¶œê¸ˆ</button>
        <button data-tab="stock">ğŸ›ï¸ ì£¼ê°€ì¡°ì‘</button>
        <button data-tab="change">ğŸ“ˆ ë°°ìœ¨/í™•ë¥ </button>
        <button data-tab="news">ğŸ“° ë‰´ìŠ¤</button>
        <button data-tab="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
        <button data-tab="delist">ğŸš« ìƒì¥íì§€</button>
      </div>

      <!-- ğŸ“Š ê·¸ë˜í”„ -->
      <div id="tab-graph" class="tab-section">
        <div class="row">
          <button id="marketStartBtn">ì¥ ì‹œì‘</button>
          <button id="marketEndBtn">ì¥ ë§ˆê°</button>
          <button id="resetGraphBtn">ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
        </div>
        <div class="row">
          <label for="allDelta">ì „ì²´ Â±ê¸ˆì•¡</label>
          <input type="number" id="allDelta" placeholder="ì˜ˆ: 10000">
          <button id="adjustAllBtn">ì „ì²´ ì ìš©</button>
        </div>
        <div class="row">
          <label for="intervalInput">ë³€ë™ì£¼ê¸°(ì´ˆ)</label>
          <input type="number" id="intervalInput" value="5">
          <button id="applyIntervalBtn">ì ìš©</button>
        </div>
        <div class="row">
          <label for="deltaMaxInput">1í‹± ìµœëŒ€ë³€ë™(ì›)</label>
          <input type="number" id="deltaMaxInput" value="1000000">
          <button id="applyDeltaBtn">ì ìš©</button>
        </div>
        <hr style="border:0;border-top:1px solid #374151">
        <div id="graphCompanyAdjust"></div>
      </div>

      <!-- ğŸ‘¥ ìœ ì € -->
      <div id="tab-users" class="tab-section" style="display:none;">
        <div id="userList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ğŸ’³ ì…ì¶œê¸ˆ -->
      <div id="tab-finance" class="tab-section" style="display:none;">
        <h3>ì…ê¸ˆ ìš”ì²­</h3>
        <div id="depositRequests">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <h3 style="margin-top:16px;">ì¶œê¸ˆ ìš”ì²­</h3>
        <div id="withdrawRequests">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ğŸ›ï¸ ì£¼ê°€ì¡°ì‘ -->
      <div id="tab-stock" class="tab-section" style="display:none;">
        <div id="stockTuner">ì¢…ëª© ì—†ìŒ</div>
      </div>

      <!-- ğŸ“ˆ ë°°ìœ¨/í™•ë¥  -->
      <div id="tab-change" class="tab-section" style="display:none;">
        <div class="row">
          <label for="globalProfit">ìƒìŠ¹í™•ë¥ </label>
          <input type="number" id="globalProfit" step="0.01" value="0.4">
          <label for="globalLoss">í•˜ë½í™•ë¥ </label>
          <input type="number" id="globalLoss" step="0.01" value="0.6">
          <button id="applyAllChanceBtn">ì „ì²´ í™•ë¥  ì ìš©</button>
        </div>
        <div class="row">
          <label for="allMultiplierVal">ì „ì²´ ë°°ìœ¨</label>
          <input type="number" id="allMultiplierVal" step="0.1" value="1">
          <button id="applyAllMultiplierBtn">ì „ì²´ ë°°ìœ¨ ì ìš©</button>
        </div>
        <div class="row">
          <label for="volatilityInput">ì „ì—­ ë³€ë™í­(%)</label>
          <input type="number" id="volatilityInput" step="0.1" value="1.5">
          <button id="applyVolatilityBtn">ì ìš©</button>
        </div>
        <hr style="border:0;border-top:1px solid #374151">
        <div id="changePanel"></div>
      </div>

      <!-- ğŸ“° ë‰´ìŠ¤ -->
      <div id="tab-news" class="tab-section" style="display:none;">
        <div class="row">
          <input type="text" id="newsTitleInput" placeholder="ë‰´ìŠ¤ ì œëª©">
        </div>
        <div class="row" style="flex-direction:column;align-items:stretch">
          <textarea id="newsBodyInput" placeholder="ë‰´ìŠ¤ ë³¸ë¬¸"></textarea>
          <div class="row" style="justify-content:flex-end;">
            <button id="btnPostNews">ë‰´ìŠ¤ ë“±ë¡</button>
          </div>
        </div>
        <hr style="border:0;border-top:1px solid #374151">
        <div id="newsList">ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ğŸ“¢ ê³µì§€ì‚¬í•­ -->
      <div id="tab-notice" class="tab-section" style="display:none;">
        <div class="row">
          <input type="text" id="noticeTitleInput" placeholder="ê³µì§€ ì œëª©">
        </div>
        <div class="row" style="flex-direction:column;align-items:stretch">
          <textarea id="noticeBodyInput" placeholder="ê³µì§€ ë³¸ë¬¸"></textarea>
          <div class="row" style="justify-content:flex-end;">
            <button id="btnPostNotice">ê³µì§€ ë“±ë¡</button>
          </div>
        </div>
        <hr style="border:0;border-top:1px solid #374151">
        <div id="noticeList">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ğŸš« ìƒì¥íì§€ -->
      <div id="tab-delist" class="tab-section" style="display:none;">
        <div class="row">
          <label for="delistCompanySel">ê¸°ì—…</label>
          <select id="delistCompanySel"><option>ë¡œë”© ì¤‘...</option></select>
          <label for="delistMinutes">ëª©í‘œ ì‹œê°„(ë¶„)</label>
          <input type="number" id="delistMinutes" value="30">
          <button id="btnDelistStart">ìŠ¤ì¼€ì¤„ ì‹œì‘</button>
          <button id="btnDelistCancel">ê³„íš ì·¨ì†Œ</button>
          <button id="btnReviveNow">ì§€ê¸ˆ ë¶€í™œ</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="autoReviveNextOpen"> ë‹¤ìŒ ì¥ ì‹œì‘ ì‹œ ìë™ ë¶€í™œ</label>
        </div>
        <div class="row" id="delistStatus" style="color:#9ca3af">ì§„í–‰ ì¤‘ì¸ ìƒì¥íì§€ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="row" id="delistedItems">ìƒì¥íì§€ëœ ì¢…ëª© ì—†ìŒ</div>
      </div>
    </div>
  </div>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ===== íŒŒíŠ¸ 2, 3, 4ì˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ ì•„ë˜ì— ì´ì–´ ë¶™ì…ë‹ˆë‹¤ ===== -->
</body>
</html>

<script type="module">
/* ================= Firebase (v12) ================= */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
  onSnapshot, writeBatch, increment, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
let app;
try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= DOM Refs ================= */
const $ = (sel) => document.querySelector(sel);
const userInfo = $("#userInfo");
const companiesDiv = $("#companies");
const logDiv = $("#log");

// ë²„íŠ¼ë“¤
const btnLogout = $("#btnLogout");
const startBtn = $("#startBtn");

/* ================= ìƒíƒœ ================= */
let chart = null;
let currentUser = null;
let unsubscribeUser = null;
let marketOpenFlag = false;

let player = { holdings:{}, cash:0 };
const companyStatus = {}; // ìƒì¥íì§€ ìƒíƒœ
const companies = [
  {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:10000000},
  {name:"ì¹´ìŠ¤í‹¸ë¡œ",   basePrice:10000000},
  {name:"ì‚¬ì¿ ë¼",     basePrice:10000000},
  {name:"ì²­ë£¡",       basePrice:10000000},
  {name:"ê²½ì°°ì²­",     basePrice:10000000},
  {name:"Ems",        basePrice:10000000},
  {name:"ì˜¬ë“œë³´ì´",   basePrice:10000000},
  {name:"ì‘ë‘",       basePrice:10000000},
  {name:"ë¹…ë”•",       basePrice:10000000},
  {name:"ìœ í† í”¼ì•„",   basePrice:10000000},
  {name:"inback",     basePrice:10000000},
].map(c => ({...c, id: safeId(c.name), multiplier:1, livePrice:c.basePrice}));

/* ================= ìœ í‹¸ ================= */
const ci = s => String(s||"").toLowerCase();
const safeId = name => String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_');
const escapeHtml = (s='') => s
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

function log(msg){
  if(!logDiv) return;
  const div = document.createElement('div');
  div.className = 'log-item';
  div.innerHTML = msg;
  logDiv.prepend(div);
}

/* ================= ì°¨íŠ¸ ================= */
function initChart(){
  if(chart) return;
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type:"line",
    data:{
      labels:[],
      datasets: companies.map(c => ({
        label:c.name, data:[], borderWidth:2, fill:false, tension:0.25
      }))
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{position:"bottom"} },
      scales:{
        x:{ title:{display:true, text:"ì‹œê°„"} },
        y:{ title:{display:true, text:"ê°€ê²© (KRW)"}, beginAtZero:false }
      }
    }
  });
}
function appendChartPoint(tickMs){
  if(!chart) return;
  const label = new Date(tickMs||Date.now()).toLocaleTimeString();
  chart.data.labels.push(label);
  companies.forEach((c,i)=>{ chart.data.datasets[i].data.push(c.livePrice); });
  const MAX=120;
  if(chart.data.labels.length>MAX){
    chart.data.labels.splice(0, chart.data.labels.length-MAX);
    chart.data.datasets.forEach(d=>{
      if(d.data.length>MAX) d.data.splice(0, d.data.length-MAX);
    });
  }
  chart.update("none");
}

/* ================= ìœ ì € ì¸í„°í˜ì´ìŠ¤ ================= */
function renderUserInfo(){
  if(currentUser){
    userInfo.innerHTML = `ğŸ‘¤ <strong>${escapeHtml(currentUser.name)}</strong> (${escapeHtml(currentUser.id)}) | ğŸ’µ ${(player.cash||0).toLocaleString()} KRW`;
  }else{
    userInfo.textContent="â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...";
  }
}
function initCompaniesUI(){
  let html="";
  companies.forEach(c=>{
    const delisted = !!companyStatus[c.id];
    html += `
      <div class="company" id="card-${c.id}">
        <div class="info">
          <span>${escapeHtml(c.name)}</span>
          <span class="status-badge">${delisted?'ğŸš« ìƒì¥íì§€':'ğŸŸ¡ ëŒ€ê¸°'}</span>
        </div>
        <div>ê°€ê²©: <strong><span id="price-${c.id}">${c.livePrice.toLocaleString()}</span> KRW</strong></div>
        <div>
          ë³´ìœ : <span id="hold-${c.id}">${player.holdings[c.name]||0}</span> ì£¼
        </div>
        <div class="actions">
          <input type="number" id="qty-${c.id}" min="1" value="1">
          <button data-role="buy" data-id="${c.id}">ë§¤ìˆ˜</button>
          <button data-role="sell" data-id="${c.id}">ë§¤ë„</button>
        </div>
      </div>`;
  });
  companiesDiv.innerHTML = html;
  companiesDiv.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const role = btn.dataset.role;
    const id = btn.dataset.id;
    if(!role || !id) return;
    const comp = companies.find(x=>x.id===id);
    if(!comp) return;
    const qty = parseInt(document.getElementById("qty-"+comp.id).value) || 1;
    if(role==='buy') buy(comp, qty);
    if(role==='sell') sell(comp, qty);
  });
}

/* ================= ê±°ë˜ ================= */
async function buy(c, qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  const total = c.livePrice*qty;
  if(player.cash < total) return alert("ğŸ’¸ í˜„ê¸ˆ ë¶€ì¡±");
  player.cash -= total;
  player.holdings[c.name] = (player.holdings[c.name]||0)+qty;
  await setDoc(doc(db,"users",currentUser.id),{
    cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
  },{merge:true});
  renderUserInfo();
  log(`ğŸŸ¢ ë§¤ìˆ˜ì²´ê²°: ${c.name} ${qty}ì£¼`);
}
async function sell(c, qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  if((player.holdings[c.name]||0)<qty) return alert("ë³´ìœ  ë¶€ì¡±");
  const total = c.livePrice*qty;
  player.cash += total;
  player.holdings[c.name]-=qty;
  await setDoc(doc(db,"users",currentUser.id),{
    cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
  },{merge:true});
  renderUserInfo();
  log(`ğŸ”´ ë§¤ë„ì²´ê²°: ${c.name} ${qty}ì£¼`);
}

/* ================= ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ================= */
async function ensureAuth(){
  return new Promise(resolve=>{
    onAuthStateChanged(auth, (user)=>{
      if(user){ resolve(user); }
      else signInAnonymously(auth).then(r=>resolve(r.user));
    });
  });
}
startBtn.addEventListener('click', async ()=>{
  const id=$("#customId").value.trim();
  const name=$("#customName").value.trim();
  if(!id||!name) return alert("ê³ ìœ ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ í•„ìš”");
  await ensureAuth();
  currentUser={id,name};
  await setDoc(doc(db,"users",id),{name,cash:player.cash, holdings:player.holdings, active:true},{merge:true});
  localStorage.setItem("stockUser",JSON.stringify(currentUser));
  $("#loginModal").style.display='none';
  renderUserInfo();
  initCompaniesUI();
});
btnLogout.addEventListener('click', async ()=>{
  if(currentUser){
    await updateDoc(doc(db,"users",currentUser.id),{active:false});
  }
  localStorage.removeItem("stockUser");
  location.reload();
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ë³µì›
window.addEventListener('load', async ()=>{
  await ensureAuth();
  const saved=localStorage.getItem("stockUser");
  if(saved){
    currentUser=JSON.parse(saved);
    $("#loginModal").style.display='none';
    renderUserInfo();
    initCompaniesUI();
  }else{
    $("#loginModal").style.display='flex';
  }
  initChart();
  companies.forEach(c=>c.livePrice=c.basePrice);
  appendChartPoint(Date.now());
});

</script>

<script type="module">
/* ================= Deposit / Withdraw ìš”ì²­ (ì‚¬ìš©ì) ================= */
const acctNo = $("#acctNo");
const cashAmount = $("#cashAmount");
const cashMemo = $("#cashMemo");
const requestDepositBtn = $("#requestDepositBtn");

const withdrawModal = $("#withdrawModal");
const btnCloseWithdraw = $("#btnCloseWithdraw");
const withdrawId = $("#withdrawId");
const withdrawName = $("#withdrawName");
const withdrawAmount = $("#withdrawAmount");
const withdrawAccount = $("#withdrawAccount");
const withdrawFeeInfo = $("#withdrawFeeInfo");
const submitWithdrawBtn = $("#submitWithdrawBtn");

btnCloseWithdraw.addEventListener('click', ()=> withdrawModal.style.display='none');

async function requestDeposit(){
  const id=currentUser?.id||""; const name=currentUser?.name||"";
  const account=acctNo.value.trim(); const amount=parseInt(cashAmount.value)||0;
  const memo=cashMemo.value.trim();
  if(!id||!name||!account||amount<=0){ alert("âš ï¸ ê³„ì¢Œë²ˆí˜¸/ê¸ˆì•¡ í™•ì¸"); return; }
  await addDoc(collection(db,"depositRequests"),{
    userId:id,userName:name,account,amount,memo,status:"pending",createdAt:Date.now()
  });
  alert(`ğŸ’° ${amount.toLocaleString()} KRW ì…ê¸ˆ ìš”ì²­ ì™„ë£Œ`);
  log(`ğŸ’° ì…ê¸ˆ ìš”ì²­: ${amount.toLocaleString()} (${account})`);
  cashAmount.value=""; cashMemo.value=""; acctNo.value="";
}
requestDepositBtn.addEventListener('click', requestDeposit);

withdrawAmount.addEventListener('input', ()=>{
  const amount=parseInt(withdrawAmount.value)||0;
  const fee=Math.floor(amount*0.1);
  withdrawFeeInfo.textContent= amount>0
    ? `ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()} KRW / ì‹¤ì§€ê¸‰ ${(amount-fee).toLocaleString()} KRW`
    : "";
});
submitWithdrawBtn.addEventListener('click', async ()=>{
  const id=withdrawId.value.trim(); const name=withdrawName.value.trim();
  const amount=parseInt(withdrawAmount.value)||0; const account=withdrawAccount.value.trim();
  if(!id||!name||!amount||!account){ alert("âš ï¸ ì¶œê¸ˆ ì •ë³´ ì…ë ¥ í•„ìš”"); return; }
  await addDoc(collection(db,"withdrawRequests"),{
    userId:id,userName:name,amount,account,status:"pending",createdAt:Date.now()
  });
  alert("ğŸ“¤ ì¶œê¸ˆ ìš”ì²­ ì™„ë£Œ");
  log(`ğŸ“¤ ì¶œê¸ˆ ìš”ì²­: ${amount.toLocaleString()} (ê³„ì¢Œ ${account})`);
  withdrawModal.style.display='none';
});

/* ================= ë‰´ìŠ¤ ================= */
const newsModal=$("#newsModal");
const btnOpenNews=$("#btnOpenNews");
const btnCloseNews=$("#btnCloseNews");
const btnCloseNews2=$("#btnCloseNews2");
const newsContent=$("#newsContent");
const newsBadge=$("#newsBadge");

let lastReadNewsAt=Number(localStorage.getItem("lastReadNewsAt")||0);
let newsData=[];

btnOpenNews.addEventListener('click', ()=>{
  newsModal.style.display='flex';
  lastReadNewsAt=Date.now();
  localStorage.setItem("lastReadNewsAt",String(lastReadNewsAt));
  if(newsBadge) newsBadge.style.display='none';
});
btnCloseNews.addEventListener('click', ()=> newsModal.style.display='none');
btnCloseNews2.addEventListener('click', ()=> newsModal.style.display='none');

function renderNewsModal(){
  if(!newsContent) return;
  if(!newsData.length){ newsContent.innerHTML="<p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
  newsContent.innerHTML=newsData.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0; border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||"ì œëª©ì—†ìŒ")}</div>
      <div style="color:#9ca3af; font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||"").replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNews(){
  const qy=query(collection(db,"news"),orderBy("createdAt","desc"));
  onSnapshot(qy,(snap)=>{
    const list=[]; snap.forEach(d=>{ const n={id:d.id,...(d.data()||{})}; if(n.visible!==false) list.push(n); });
    newsData=list;
    renderNewsModal();
    const unread=list.filter(n=>(n.createdAt||0)>lastReadNewsAt).length;
    if(unread>0 && newsBadge){ newsBadge.style.display="inline"; newsBadge.textContent=String(unread); }
  });
}
subscribeNews();

/* ================= ê³µì§€ ================= */
const noticeModal=$("#noticeModal");
const btnOpenNotice=$("#btnOpenNotice");
const btnCloseNotice=$("#btnCloseNotice");
const btnCloseNotice2=$("#btnCloseNotice2");
const noticeContent=$("#noticeContent");

btnOpenNotice.addEventListener('click', ()=> noticeModal.style.display='flex');
btnCloseNotice.addEventListener('click', ()=> noticeModal.style.display='none');
btnCloseNotice2.addEventListener('click', ()=> noticeModal.style.display='none');

let noticeData=[];
function renderNotices(){
  if(!noticeContent) return;
  if(!noticeData.length){ noticeContent.innerHTML="<p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
  noticeContent.innerHTML=noticeData.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0; border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||"ê³µì§€ì‚¬í•­")}</div>
      <div style="color:#9ca3af; font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||"").replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNotices(){
  const qy=query(collection(db,"notices"),orderBy("createdAt","desc"));
  onSnapshot(qy,(snap)=>{
    const list=[]; snap.forEach(d=>list.push({id:d.id,...(d.data()||{})}));
    noticeData=list;
    renderNotices();
  });
}
subscribeNotices();
</script>

<script type="module">
/* ================= ê´€ë¦¬ì ìƒíƒœ ================= */
let ADMIN_MODE=false;
const adminLoginBox=$("#adminLogin");
const adminCode=$("#adminCode");
const btnAdminLogin=$("#btnAdminLogin");
const adminPanel=$("#adminPanelAll");
const btnAdminClose=$("#btnAdminClose");

/* ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= */
function checkAdmin(){
  const code=adminCode.value.trim();
  if(code==="graph703"){   // ğŸ”‘ ê´€ë¦¬ì ì½”ë“œ
    ADMIN_MODE=true;
    adminLoginBox.style.display="none";
    adminPanel.style.display="block";
    alert("âœ… ê´€ë¦¬ì ëª¨ë“œ ì§„ì…");
  }else{
    alert("âŒ ì˜ëª»ëœ ì½”ë“œ");
  }
}
btnAdminLogin.addEventListener("click", checkAdmin);
btnAdminClose.addEventListener("click", ()=>{
  adminPanel.style.display="none";
  adminLoginBox.style.display="block";  // ë‹«ìœ¼ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸ ì°½
});

/* ================= ê´€ë¦¬ì íŒ¨ë„: íƒ­ ì „í™˜ ================= */
function showTab(name){
  document.querySelectorAll(".tab-section").forEach(t=>t.style.display="none");
  const sel=document.getElementById("tab-"+name);
  if(sel) sel.style.display="block";
}
window.showTab=showTab;

/* ================= ê´€ë¦¬ì íŒ¨ë„: ì…ì¶œê¸ˆ ìŠ¹ì¸/ê±°ì ˆ ================= */
async function approveDeposit(id, amount, userId){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥");
  try{
    await updateDoc(doc(db,"users",userId),{cash:increment(amount),updatedAt:Date.now()});
    await updateDoc(doc(db,"depositRequests",id),{status:"approved",updatedAt:Date.now()});
    log(`âœ… ì…ê¸ˆ ìŠ¹ì¸: ${amount.toLocaleString()} (${userId})`);
  }catch(e){ alert("ì…ê¸ˆ ìŠ¹ì¸ ì‹¤íŒ¨: "+(e.message||e)); }
}
async function rejectDeposit(id){
  if(!ADMIN_MODE) return;
  try{
    await updateDoc(doc(db,"depositRequests",id),{status:"rejected",updatedAt:Date.now()});
    log(`âŒ ì…ê¸ˆ ê±°ì ˆ (${id})`);
  }catch(e){ alert("ì…ê¸ˆ ê±°ì ˆ ì‹¤íŒ¨: "+(e.message||e)); }
}
async function approveWithdraw(id, amount, userId){
  if(!ADMIN_MODE) return;
  try{
    const ref=doc(db,"users",userId); const snap=await getDoc(ref);
    const cash=snap.data()?.cash||0;
    if(cash<amount){ alert("âŒ í˜„ê¸ˆ ë¶€ì¡±"); return; }
    await updateDoc(ref,{cash:increment(-amount),updatedAt:Date.now()});
    await updateDoc(doc(db,"withdrawRequests",id),{status:"approved",updatedAt:Date.now()});
    log(`âœ… ì¶œê¸ˆ ìŠ¹ì¸: ${amount.toLocaleString()} (${userId})`);
  }catch(e){ alert("ì¶œê¸ˆ ìŠ¹ì¸ ì‹¤íŒ¨: "+(e.message||e)); }
}
async function rejectWithdraw(id){
  if(!ADMIN_MODE) return;
  try{
    await updateDoc(doc(db,"withdrawRequests",id),{status:"rejected",updatedAt:Date.now()});
    log(`âŒ ì¶œê¸ˆ ê±°ì ˆ (${id})`);
  }catch(e){ alert("ì¶œê¸ˆ ê±°ì ˆ ì‹¤íŒ¨: "+(e.message||e)); }
}

/* ================= windowì— ë°”ì¸ë”© ================= */
window.approveDeposit=approveDeposit;
window.rejectDeposit=rejectDeposit;
window.approveWithdraw=approveWithdraw;
window.rejectWithdraw=rejectWithdraw;
</script>

  <script type="module">
/* ----------------------------------------------------
   Admin Panel â€” Tabs UI ìƒì„± + ì´ë²¤íŠ¸ ë°”ì¸ë”© + êµ¬ë…
   (íŒŒíŠ¸ 4-1 ì´í›„ì— ë¶™ì´ì„¸ìš”)
---------------------------------------------------- */

/* ---------- íƒ­ DOM ---------- */
const tabGraph  = document.getElementById('tab-graph');
const tabUsers  = document.getElementById('tab-users');
const tabFin    = document.getElementById('tab-finance');
const tabStock  = document.getElementById('tab-stock');
const tabChange = document.getElementById('tab-change');
const tabNews   = document.getElementById('tab-news');
const tabNotice = document.getElementById('tab-notice');
const tabDelist = document.getElementById('tab-delist');

const adminPanel = document.getElementById('adminPanelAll');
const adminHeader= document.getElementById('adminPanelHeader');

/* íšŒì‚¬ í—¬í¼ */
const escapeHtml = (s='') => s
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

/* ----------------------------------------------------
   1) íƒ­ë³„ UI ê·¸ë¦¬ê¸°
---------------------------------------------------- */
function renderAdminTabs(){
  if(tabGraph){
    tabGraph.innerHTML = `
      <div style="display:grid; gap:10px;">
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button id="marketStartBtn">â–¶ï¸ ì¥ ì‹œì‘</button>
          <button id="marketEndBtn">â¹ ì¥ ë§ˆê°</button>
          <button id="resetGraphBtn">â™»ï¸ ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
        </div>

        <div class="req-card" style="gap:14px;">
          <div>
            <div><strong>ë³€ë™ ì£¼ê¸°(ì´ˆ)</strong></div>
            <input id="intervalInput" type="number" value="${Math.max(1, Math.floor((window.updateInterval||5000)/1000))}" style="width:120px;">
            <button id="applyIntervalBtn">ì ìš©</button>
          </div>
          <div>
            <div><strong>1í‹± ìµœëŒ€ ë³€ë™(ì›)</strong></div>
            <input id="deltaMaxInput" type="number" value="${window.deltaMax||1000000}" style="width:160px;">
            <button id="applyDeltaBtn">ì ìš©</button>
          </div>
          <div>
            <div><strong>ì „ì²´ ì¼ê´„ ì¡°ì •(Â±ì›)</strong></div>
            <input id="allDelta" type="number" value="0" style="width:160px;">
            <button id="adjustAllBtn">ì „ì²´ ì ìš©</button>
          </div>
        </div>

        <div>
          <h3 style="margin:6px 0 4px;">ê°œë³„ ì¢…ëª© ê°€ê²© ì¡°ì •</h3>
          <div id="graphCompanyAdjust"></div>
        </div>
      </div>
    `;
  }

  if(tabUsers){
    tabUsers.innerHTML = `
      <div style="display:grid; gap:8px;">
        <div class="req-card" style="justify-content:flex-start; gap:10px;">
          <input id="promoteIdInput" type="text" placeholder="ê³ ìœ ë²ˆí˜¸">
          <button id="promoteBtn">ê¶Œí•œ ë¶€ì—¬</button>
          <button id="demoteBtn">ê¶Œí•œ í•´ì œ</button>
        </div>
        <div id="userList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    `;
  }

  if(tabFin){
    tabFin.innerHTML = `
      <div style="display:grid; gap:12px;">
        <div>
          <h3 style="margin:6px 0 4px;">ì…ê¸ˆ ëŒ€ê¸°</h3>
          <div id="depositRequests">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <div>
          <h3 style="margin:10px 0 4px;">ì¶œê¸ˆ ëŒ€ê¸°</h3>
          <div id="withdrawRequests">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    `;
  }

  if(tabStock){
    tabStock.innerHTML = `
      <div id="stockTuner"></div>
    `;
  }

  if(tabChange){
    tabChange.innerHTML = `
      <div class="req-card" style="gap:10px; flex-wrap:wrap;">
        <div>
          <div><strong>ì „ì²´ ìƒìŠ¹í™•ë¥ </strong></div>
          <input id="globalProfit" type="number" step="0.01" min="0" max="1" value="0.4" style="width:120px;">
        </div>
        <div>
          <div><strong>ì „ì²´ í•˜ë½í™•ë¥ </strong></div>
          <input id="globalLoss" type="number" step="0.01" min="0" max="1" value="0.6" style="width:120px;">
        </div>
        <button id="applyAllChanceBtn">ì „ì²´ í™•ë¥  ì ìš©</button>
        <span style="width:12px"></span>
        <div>
          <div><strong>ì „ì²´ ë°°ìœ¨</strong></div>
          <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:120px;">
        </div>
        <button id="applyAllMultiplierBtn">ì „ì²´ ë°°ìœ¨ ì ìš©</button>
        <span style="width:12px"></span>
        <div>
          <div><strong>ì „ì—­ ë³€ë™í­(%)</strong></div>
          <input id="volatilityInput" type="number" step="0.1" value="${typeof window.volatility==='number'?window.volatility:1.5}" style="width:120px;">
        </div>
        <button id="applyVolatilityBtn">ì ìš©</button>
      </div>
      <h3 style="margin:8px 0 4px;">ê°œë³„ ì¢…ëª© ì„¤ì •</h3>
      <div id="changePanel"></div>
    `;
  }

  if(tabNews){
    tabNews.innerHTML = `
      <div class="req-card" style="align-items:flex-start; gap:10px; flex-wrap:wrap;">
        <div style="min-width:220px;">
          <input id="newsTitleInput" type="text" placeholder="ì œëª©" style="width:260px;">
          <textarea id="newsBodyInput" placeholder="ë‚´ìš©" style="width:260px; height:120px;"></textarea>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px; padding-bottom:8px;">
          <button id="btnNewsPost">ë‰´ìŠ¤ ë“±ë¡</button>
        </div>
      </div>
      <div id="newsList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    `;
  }

  if(tabNotice){
    tabNotice.innerHTML = `
      <div class="req-card" style="align-items:flex-start; gap:10px; flex-wrap:wrap;">
        <div style="min-width:220px;">
          <input id="noticeTitleInput" type="text" placeholder="ì œëª©" style="width:260px;">
          <textarea id="noticeBodyInput" placeholder="ë‚´ìš©" style="width:260px; height:120px;"></textarea>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px; padding-bottom:8px;">
          <button id="btnNoticePost">ê³µì§€ ë“±ë¡</button>
        </div>
      </div>
      <div id="noticeList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    `;
  }

  if(tabDelist){
    const opts = (window.companies||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    tabDelist.innerHTML = `
      <div class="req-card" style="gap:10px; flex-wrap:wrap;">
        <div>
          <div><strong>ì¢…ëª©</strong></div>
          <select id="delistCompanySel" style="min-width:180px;">${opts}</select>
        </div>
        <div>
          <div><strong>ëª©í‘œ ì‹œê°„(ë¶„)</strong></div>
          <input id="delistMinutes" type="number" value="30" style="width:120px;">
        </div>
        <button id="delistStartBtn">ìŠ¤ì¼€ì¤„ ì‹œì‘</button>
        <button id="delistCancelBtn">ê³„íš ì·¨ì†Œ</button>
        <button id="delistReviveBtn">ì§€ê¸ˆ ë¶€í™œ</button>
        <label style="display:flex; align-items:center; gap:6px; margin-left:10px;">
          <input id="autoReviveNextOpen" type="checkbox"> ë‹¤ìŒ ê°œì¥ ì‹œ ìë™ ë¶€í™œ
        </label>
      </div>
      <div id="delistStatus" style="color:#9ca3af; margin:8px 0;">ì§„í–‰ ì¤‘ì¸ ìƒì¥íì§€ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="delistedItems" style="margin-top:8px;">ìƒì¥íì§€ëœ ì¢…ëª© ì—†ìŒ</div>
    `;
  }
}

/* ----------------------------------------------------
   2) ê³µí†µ: íŒ¨ë„ ë“œë˜ê·¸(ìˆìœ¼ë©´ í™œì„±í™”)
---------------------------------------------------- */
function enableDrag(panelEl=adminPanel, handleEl=adminHeader){
  if(!panelEl || !handleEl) return;
  let startX=0,startY=0,origX=0,origY=0,dragging=false;
  const down = (e)=>{
    dragging=true;
    const t=e.touches?e.touches[0]:e;
    startX=t.clientX; startY=t.clientY;
    const r=panelEl.getBoundingClientRect(); origX=r.left; origY=r.top;
    document.body.style.userSelect='none';
    handleEl.style.cursor='grabbing';
  };
  const move = (e)=>{
    if(!dragging) return;
    const t=e.touches?e.touches[0]:e;
    panelEl.style.left = (origX + (t.clientX-startX)) + 'px';
    panelEl.style.top  = (origY + (t.clientY-startY)) + 'px';
    e.preventDefault();
  };
  const up = ()=>{
    dragging=false; document.body.style.userSelect=''; handleEl.style.cursor='move';
  };
  handleEl.addEventListener('mousedown',down);
  document.addEventListener('mousemove',move,{passive:false});
  document.addEventListener('mouseup',up);
  handleEl.addEventListener('touchstart',down,{passive:true});
  document.addEventListener('touchmove',move,{passive:false});
  document.addEventListener('touchend',up);
}

/* ----------------------------------------------------
   3) ê·¸ë˜í”„/ê°€ê²©: ë³´ì¡° í•¨ìˆ˜ë“¤ (ìƒˆë¡­ê²Œ ì •ì˜)
---------------------------------------------------- */
import {
  collection, onSnapshot, query, orderBy,
  writeBatch, setDoc, updateDoc, doc, increment, getDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

function refreshCompanyIdsFromDOM(){
  return (window.companies||[]).map(c => ({id:c.id, name:c.name}));
}

async function adjustCompanyPriceById(companyId, delta){
  if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  try{
    await setDoc(doc(window.db,'companyPrices', companyId),
      { current: increment(parseInt(delta||0,10)), updatedAt: Date.now() }, {merge:true});
  }catch(e){ alert('ê°€ê²© ì¡°ì • ì˜¤ë¥˜: '+(e.message||e)); }
}

async function adjustAllPrices(){
  if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const v = parseInt(document.getElementById('allDelta')?.value||'0',10);
  const ids = refreshCompanyIdsFromDOM();
  const batch = writeBatch(window.db);
  const now = Date.now();
  ids.forEach(({id})=>{
    batch.set(doc(window.db,'companyPrices',id), { current: increment(v), updatedAt: now }, {merge:true});
  });
  await batch.commit();
  alert(`âœ… ì „ì²´ ì¢…ëª© ${v>=0?'+':''}${v} ì› ì¡°ì •`);
}

function renderGraphAdjustPanel(){
  const wrap = document.getElementById('graphCompanyAdjust');
  if(!wrap) return;
  const ids = refreshCompanyIdsFromDOM();
  wrap.innerHTML = ids.map(({id,name})=>`
    <div class="req-card" style="gap:8px;">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="number" data-role="adj-input" data-id="${id}" placeholder="Â±ê¸ˆì•¡" style="width:110px;">
        <button data-role="adj-apply" data-id="${id}">ì ìš©</button>
      </div>
    </div>
  `).join('') || 'ì¢…ëª© ì—†ìŒ';
}

/* ë³€ë™ ì£¼ê¸° / ë¸íƒ€ë§¥ìŠ¤ */
async function applyGraphInterval(){
  if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const sec = parseInt(document.getElementById('intervalInput')?.value||'5',10);
  const ms = Math.max(1,sec)*1000;
  try{
    await setDoc(doc(window.db,'marketState','main'), { interval: ms, updatedAt: Date.now() }, {merge:true});
    window.updateInterval = ms;
    alert(`âœ… ë³€ë™ ì£¼ê¸° ì ìš©: ${sec}ì´ˆ`);
  }catch(e){ alert('ì˜¤ë¥˜: '+(e.message||e)); }
}
async function applyDeltaMax(){
  if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const v = parseInt(document.getElementById('deltaMaxInput')?.value||'1000000',10);
  const vv = isNaN(v)?1000000:Math.max(1, v);
  try{
    await setDoc(doc(window.db,'globals','settings'), { deltaMax: vv, updatedAt: Date.now() }, {merge:true});
    window.deltaMax = vv;
    alert(`âœ… 1í‹± ìƒí•œ ì ìš©: ${vv.toLocaleString()} ì›`);
  }catch(e){ alert('ì˜¤ë¥˜: '+(e.message||e)); }
}

/* ----------------------------------------------------
   4) ìœ ì € / ì…ì¶œê¸ˆ íŒ¨ë„
---------------------------------------------------- */
function subscribeUsersPanel(){
  const userList = document.getElementById('userList');
  if(!userList) return;
  userList.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  onSnapshot(collection(window.db,'users'), (snap)=>{
    let html = '';
    snap.forEach(d=>{
      const u={id:d.id, ...(d.data()||{})};
      const hold=u.holdings||{};
      const holdTxt = Object.entries(hold).map(([k,v])=>`${escapeHtml(k)}:${v}`).join(', ') || 'ë³´ìœ  ì—†ìŒ';
      html += `
        <div class="req-card">
          <div>
            <div><strong>${escapeHtml(u.name||'-')}</strong> (${escapeHtml(u.id)}) ${u.active?'ğŸŸ¢':'ğŸ”´'} ${u.isAdmin?'<span style="color:#10b981;">ê´€ë¦¬ìğŸ›¡ï¸</span>':''}</div>
            <div>í˜„ê¸ˆ: ${Number(u.cash||0).toLocaleString()} KRW</div>
            <div>ë³´ìœ : ${holdTxt}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-action="force-logout" data-id="${u.id}">ê°•ì œ ë¡œê·¸ì•„ì›ƒ</button>
            ${u.isAdmin
              ? `<button data-action="demote" data-id="${u.id}">ê¶Œí•œ í•´ì œ</button>`
              : `<button data-action="promote" data-id="${u.id}">ê¶Œí•œ ë¶€ì—¬</button>`
            }
          </div>
        </div>`;
    });
    userList.innerHTML = html || 'ìœ ì € ì—†ìŒ';
  });

  /* ìƒë‹¨ ìˆ˜ë™ ì…ë ¥ ë²„íŠ¼ */
  const promoteBtn = document.getElementById('promoteBtn');
  const demoteBtn  = document.getElementById('demoteBtn');
  const promoteIdInput = document.getElementById('promoteIdInput');
  promoteBtn?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const uid = promoteIdInput?.value.trim(); if(!uid) return alert('ê³ ìœ ë²ˆí˜¸ ì…ë ¥');
    try{ await updateDoc(doc(window.db,'users',uid), { isAdmin:true, updatedAt: Date.now() }); alert('ğŸ›¡ï¸ ê¶Œí•œ ë¶€ì—¬'); }
    catch(e){ alert('ì‹¤íŒ¨: '+(e.message||e)); }
  });
  demoteBtn?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const uid = promoteIdInput?.value.trim(); if(!uid) return alert('ê³ ìœ ë²ˆí˜¸ ì…ë ¥');
    try{ await updateDoc(doc(window.db,'users',uid), { isAdmin:false, updatedAt: Date.now() }); alert('âš ï¸ ê¶Œí•œ í•´ì œ'); }
    catch(e){ alert('ì‹¤íŒ¨: '+(e.message||e)); }
  });

  /* ë¦¬ìŠ¤íŠ¸ ìœ„ì„ ë²„íŠ¼ */
  userList.addEventListener('click', async (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const uid=btn.dataset.id;
    if(btn.dataset.action==='force-logout'){
      try{ await updateDoc(doc(window.db,'users',uid),{active:false,lastLogoutAt:Date.now()}); alert('ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ'); }
      catch(err){ alert('ì˜¤ë¥˜'); }
    }else if(btn.dataset.action==='promote'){
      try{ await updateDoc(doc(window.db,'users',uid),{isAdmin:true,updatedAt:Date.now()}); alert('ê¶Œí•œ ë¶€ì—¬'); }
      catch(err){ alert('ì˜¤ë¥˜'); }
    }else if(btn.dataset.action==='demote'){
      try{ await updateDoc(doc(window.db,'users',uid),{isAdmin:false,updatedAt:Date.now()}); alert('ê¶Œí•œ í•´ì œ'); }
      catch(err){ alert('ì˜¤ë¥˜'); }
    }
  });
}

function subscribeFinanceQueues(){
  const depBox = document.getElementById('depositRequests');
  const wdrBox = document.getElementById('withdrawRequests');

  if(depBox){
    depBox.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    onSnapshot(collection(window.db,'depositRequests'), (snap)=>{
      let html = '';
      snap.forEach(d=>{
        const r={id:d.id, ...(d.data()||{})};
        if(r.status!=='pending') return;
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ê³„ì¢Œ: ${escapeHtml(r.account||'')}</div>
              <div>ê¸ˆì•¡: ${Number(r.amount||0).toLocaleString()} KRW</div>
              <div>ìƒíƒœ: ${escapeHtml(r.status||'')}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-k="dep-approve" data-id="${r.id}" data-amount="${Number(r.amount||0)}" data-user="${escapeHtml(r.userId||'')}">ìŠ¹ì¸</button>
              <button data-k="dep-reject" data-id="${r.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      depBox.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    depBox.addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
      if(b.dataset.k==='dep-approve'){
        const id=b.dataset.id, amt=parseInt(b.dataset.amount||'0',10), uid=b.dataset.user||'';
        try{
          await updateDoc(doc(window.db,'users',uid),{cash:increment(amt),updatedAt:Date.now()});
          await updateDoc(doc(window.db,'depositRequests',id),{status:'approved',updatedAt:Date.now()});
        }catch(err){ alert('ìŠ¹ì¸ ì‹¤íŒ¨: '+(err.message||err)); }
      }else if(b.dataset.k==='dep-reject'){
        try{ await updateDoc(doc(window.db,'depositRequests',b.dataset.id),{status:'rejected',updatedAt:Date.now()}); }
        catch(err){ alert('ê±°ì ˆ ì‹¤íŒ¨: '+(err.message||err)); }
      }
    });
  }

  if(wdrBox){
    wdrBox.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    onSnapshot(collection(window.db,'withdrawRequests'), (snap)=>{
      let html = '';
      snap.forEach(d=>{
        const r={id:d.id, ...(d.data()||{})};
        if(r.status!=='pending') return;
        const amt=Number(r.amount||0), fee=Math.floor(amt*0.1);
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ìš”ì²­ì•¡: ${amt.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(Math.max(0,amt-fee)).toLocaleString()})</div>
              <div>ìƒíƒœ: ${escapeHtml(r.status||'')}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-k="wdr-approve" data-id="${r.id}" data-amount="${amt}" data-user="${escapeHtml(r.userId||'')}">ìŠ¹ì¸</button>
              <button data-k="wdr-reject" data-id="${r.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      wdrBox.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    wdrBox.addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
      if(b.dataset.k==='wdr-approve'){
        const id=b.dataset.id, amt=parseInt(b.dataset.amount||'0',10), uid=b.dataset.user||'';
        try{
          const us=await getDoc(doc(window.db,'users',uid));
          const cash=Number(us.data()?.cash||0);
          if(cash<amt) return alert('ì‚¬ìš©ì í˜„ê¸ˆ ë¶€ì¡±');
          await updateDoc(doc(window.db,'users',uid),{cash:increment(-amt),updatedAt:Date.now()});
          await updateDoc(doc(window.db,'withdrawRequests',id),{status:'approved',updatedAt:Date.now()});
        }catch(err){ alert('ìŠ¹ì¸ ì‹¤íŒ¨: '+(err.message||err)); }
      }else if(b.dataset.k==='wdr-reject'){
        try{ await updateDoc(doc(window.db,'withdrawRequests',b.dataset.id),{status:'rejected',updatedAt:Date.now()}); }
        catch(err){ alert('ê±°ì ˆ ì‹¤íŒ¨: '+(err.message||err)); }
      }
    });
  }
}

/* ----------------------------------------------------
   5) ì£¼ê°€ ì¡°ì‘(í‹± ì´ë™) / ë°°ìœ¨/í™•ë¥ 
---------------------------------------------------- */
function renderStockTuner(){
  const host = document.getElementById('stockTuner'); if(!host) return;
  const ids = refreshCompanyIdsFromDOM();
  host.innerHTML = ids.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:6px;">
        <button data-role="tune" data-id="${id}" data-delta="-100000">-10ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="-10000">-1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="10000">+1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="100000">+10ë§Œ</button>
      </div>
    </div>
  `).join('') || 'ì¢…ëª© ì—†ìŒ';
  host.addEventListener('click', async (e)=>{
    const b=e.target.closest('button[data-role="tune"]'); if(!b) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    await adjustCompanyPriceById(b.dataset.id, parseInt(b.dataset.delta||'0',10));
  });
}

function renderChangePanel(){
  const host = document.getElementById('changePanel'); if(!host) return;
  const ids = refreshCompanyIdsFromDOM();
  host.innerHTML = ids.map(({id,name})=>`
    <div class="req-card">
      <div style="min-width:220px;">
        <div><strong>${escapeHtml(name)}</strong></div>
        <div style="font-size:12px;color:#9ca3af;">ë°°ìœ¨/í™•ë¥  ì €ì¥ ì¦‰ì‹œ ë°˜ì˜</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="number" step="0.1" value="1" style="width:90px;" data-role="mul"   data-id="${id}">
        <button data-role="mul-apply"    data-id="${id}">ë°°ìœ¨ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="0.01" min="0" max="1" value="0.4" style="width:90px;" data-role="up"  data-id="${id}">
        <input type="number" step="0.01" min="0" max="1" value="0.6" style="width:90px;" data-role="down"data-id="${id}">
        <button data-role="chance-apply" data-id="${id}">í™•ë¥ ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="1" value="10000" style="width:100px;" data-role="bump" data-id="${id}">
        <button data-role="bump-apply"   data-id="${id}">ì¦‰ì‹œÂ±ë°˜ì˜</button>
      </div>
    </div>
  `).join('') || 'ì¢…ëª© ì—†ìŒ';

  host.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const id=b.dataset.id, role=b.dataset.role;
    if(role==='mul-apply'){
      const v = Number(host.querySelector(`input[data-role="mul"][data-id="${id}"]`)?.value||1);
      const m = isNaN(v)?1:Math.max(0,v);
      await setDoc(doc(window.db,'companySettings',id),{ multiplier:m, updatedAt:Date.now() },{merge:true});
      alert('ë°°ìœ¨ ì ìš©');
    }else if(role==='chance-apply'){
      const up  = Number(host.querySelector(`input[data-role="up"][data-id="${id}"]`)?.value||0.4);
      const down= Number(host.querySelector(`input[data-role="down"][data-id="${id}"]`)?.value||0.6);
      if(up<0||down<0||(up+down)<=0) return alert('0~1 ë²”ìœ„, í•©ê³„>0');
      await setDoc(doc(window.db,'companyChances',id),{ profit:up, loss:down, updatedAt:Date.now() },{merge:true});
      alert('í™•ë¥  ì ìš©');
    }else if(role==='bump-apply'){
      const delta = parseInt(host.querySelector(`input[data-role="bump"][data-id="${id}"]`)?.value||'0',10);
      await adjustCompanyPriceById(id, delta);
    }
  });

  document.getElementById('applyAllChanceBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const p=parseFloat(document.getElementById('globalProfit')?.value||'0.4');
    const l=parseFloat(document.getElementById('globalLoss')?.value||'0.6');
    if(isNaN(p)||isNaN(l)||p<0||l<0||(p+l)<=0) return alert('ì˜ëª»ëœ ê°’');
    for(const {id} of refreshCompanyIdsFromDOM()){
      await setDoc(doc(window.db,'companyChances',id),{ profit:p, loss:l, updatedAt:Date.now() },{merge:true});
    }
    alert('âœ… ì „ì²´ í™•ë¥  ì ìš©');
  });

  document.getElementById('applyAllMultiplierBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const v=Number(document.getElementById('allMultiplierVal')?.value||1);
    const m=isNaN(v)?1:Math.max(0,v);
    for(const {id} of refreshCompanyIdsFromDOM()){
      await setDoc(doc(window.db,'companySettings',id),{ multiplier:m, updatedAt:Date.now() },{merge:true});
    }
    alert('âœ… ì „ì²´ ë°°ìœ¨ ì ìš©');
  });

  document.getElementById('applyVolatilityBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const v=Number(document.getElementById('volatilityInput')?.value||1.5);
    const vv=isNaN(v)?1.5:Math.max(0,v);
    await setDoc(doc(window.db,'globals','settings'),{ volatility:vv, updatedAt:Date.now() },{merge:true});
    window.volatility = vv;
    alert(`âœ… ì „ì—­ ë³€ë™í­ ${vv}% ì ìš©`);
  });
}

/* ----------------------------------------------------
   6) ë‰´ìŠ¤/ê³µì§€: ê´€ë¦¬ ë“±ë¡ + ë¦¬ìŠ¤íŠ¸ (í‘œì‹œ/ìˆ¨ê¹€/ì‚­ì œ)
---------------------------------------------------- */
function bindNewsNoticePostButtons(){
  document.getElementById('btnNewsPost')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const title=(document.getElementById('newsTitleInput')?.value||'').trim();
    const content=(document.getElementById('newsBodyInput')?.value||'').trim();
    if(!title||!content) return alert('ì œëª©/ë‚´ìš© ì…ë ¥');
    await addDoc(collection(window.db,'news'),{ title, content, createdAt: Date.now(), visible:true });
    alert('ğŸ“° ë‰´ìŠ¤ ë“±ë¡');
    document.getElementById('newsTitleInput').value='';
    document.getElementById('newsBodyInput').value='';
  });

  document.getElementById('btnNoticePost')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const title=(document.getElementById('noticeTitleInput')?.value||'').trim();
    const content=(document.getElementById('noticeBodyInput')?.value||'').trim();
    if(!title||!content) return alert('ì œëª©/ë‚´ìš© ì…ë ¥');
    await addDoc(collection(window.db,'notices'),{ title, content, createdAt: Date.now() });
    alert('ğŸ“¢ ê³µì§€ ë“±ë¡');
    document.getElementById('noticeTitleInput').value='';
    document.getElementById('noticeBodyInput').value='';
  });
}

/* ê´€ë¦¬ììš© ë¦¬ìŠ¤íŠ¸ êµ¬ë…/ìœ„ì„ */
function subscribeNewsAdmin(){
  const list = document.getElementById('newsList'); if(!list) return;
  list.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  const qy=query(collection(window.db,'news'), orderBy('createdAt','desc'));
  onSnapshot(qy,(snap)=>{
    let html='';
    snap.forEach(d=>{
      const n={id:d.id, ...(d.data()||{})};
      const dt=new Date(n.createdAt||Date.now()).toLocaleString();
      const title=escapeHtml(n.title||'ì œëª© ì—†ìŒ');
      const body =escapeHtml(n.content||'');
      const short=body.length>140?body.slice(0,140)+'...':body;
      const vis=(n.visible!==false);
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
            <div style="color:${vis?'#10b981':'#ef4444'}; font-size:12px; margin-top:4px;">${vis?'í‘œì‹œì¤‘':'ìˆ¨ê¹€'}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="news-toggle" data-visible="${vis}" data-id="${n.id}">${vis?'ìˆ¨ê¹€':'í‘œì‹œ'}</button>
            <button data-role="news-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const id=b.dataset.id, role=b.dataset.role;
    if(role==='news-toggle'){
      const cur=b.dataset.visible==='true';
      try{ await updateDoc(doc(window.db,'news',id),{visible:!cur,updatedAt:Date.now()}); }catch(err){ alert('ì˜¤ë¥˜'); }
    }else if(role==='news-del'){
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ await deleteDoc(doc(window.db,'news',id)); }catch(err){ alert('ì‚­ì œ ì˜¤ë¥˜'); }
    }
  });
}
function subscribeNoticeAdmin(){
  const list = document.getElementById('noticeList'); if(!list) return;
  list.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  const qy=query(collection(window.db,'notices'), orderBy('createdAt','desc'));
  onSnapshot(qy,(snap)=>{
    let html='';
    snap.forEach(d=>{
      const n={id:d.id, ...(d.data()||{})};
      const dt=new Date(n.createdAt||Date.now()).toLocaleString();
      const title=escapeHtml(n.title||'ê³µì§€ì‚¬í•­');
      const body =escapeHtml(n.content||'');
      const short=body.length>140?body.slice(0,140)+'...':body;
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="notice-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    if(b.dataset.role==='notice-del'){
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ await deleteDoc(doc(window.db,'notices',b.dataset.id)); }catch(err){ alert('ì‚­ì œ ì‹¤íŒ¨'); }
    }
  });
}

/* ----------------------------------------------------
   7) ìƒì¥íì§€/ë¶€í™œ + ìƒíƒœ í‘œì‹œ
---------------------------------------------------- */
let __delistPlan = null;
function subscribeDelistForAdmin(){
  const statusEl = document.getElementById('delistStatus');
  const listEl   = document.getElementById('delistedItems');

  onSnapshot(doc(window.db,'marketState','main'), (snap)=>{
    const d=snap.exists()?snap.data():{};
    __delistPlan = d.delistPlan || null;
    const auto = !!d.autoReviveNextOpen;
    const chk = document.getElementById('autoReviveNextOpen');
    if(chk) chk.checked = auto;

    if(!statusEl) return;
    if(!__delistPlan || !__delistPlan.active){
      statusEl.style.color='#9ca3af';
      statusEl.textContent='ì§„í–‰ ì¤‘ì¸ ìƒì¥íì§€ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.';
    }else{
      const remain = Math.max(0, (__delistPlan.endAt - Date.now()));
      const mm=Math.floor(remain/60000), ss=Math.floor((remain%60000)/1000);
      const name=(window.companies||[]).find(x=>x.id===__delistPlan.companyId)?.name || __delistPlan.companyId;
      statusEl.style.color='#fbbf24';
      statusEl.textContent=`ì§„í–‰ ì¤‘: [${name}] ${mm}ë¶„ ${ss}ì´ˆ í›„ 0ì› íì§€ ì˜ˆì •`;
    }
  });

  onSnapshot(collection(window.db,'companyStatus'), (snap)=>{
    if(!listEl) return;
    const items=[];
    snap.forEach(s=>{
      const data=s.data()||{};
      if(data.delisted){
        const id=s.id;
        const name=(window.companies||[]).find(x=>x.id===id)?.name || id;
        items.push(`${escapeHtml(name)} (íì§€ ì‹œê°: ${data.delistedAt?new Date(data.delistedAt).toLocaleString():'-'})`);
      }
    });
    listEl.innerHTML = items.length ? items.map(t=>`<div>â€¢ ${t}</div>`).join('') : 'ìƒì¥íì§€ëœ ì¢…ëª© ì—†ìŒ';
  });

  /* ë²„íŠ¼ í•¸ë“¤ëŸ¬ */
  document.getElementById('delistStartBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const sel = document.getElementById('delistCompanySel')?.value||'';
    const mins= parseInt(document.getElementById('delistMinutes')?.value||'30',10);
    if(!sel) return alert('ì¢…ëª© ì„ íƒ');
    const now=Date.now();
    const plan={ companyId: sel, startAt: now, endAt: now+mins*60000, active:true, mode:'toZero' };
    await setDoc(doc(window.db,'marketState','main'),{ delistPlan:plan, updatedAt: now },{merge:true});
    alert('ğŸš« ìƒì¥íì§€ ê³„íš ì‹œì‘');
  });

  document.getElementById('delistCancelBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    await setDoc(doc(window.db,'marketState','main'),{ delistPlan:{active:false}, updatedAt: Date.now() },{merge:true});
    alert('íì§€ ê³„íš ì·¨ì†Œ');
  });

  document.getElementById('delistReviveBtn')?.addEventListener('click', async ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const batch=writeBatch(window.db); const now=Date.now();
    (window.companies||[]).forEach(c=>{
      batch.set(doc(window.db,'companyStatus',c.id),{delisted:false, revivedAt:now},{merge:true});
      batch.set(doc(window.db,'companyPrices',c.id),{current:c.basePrice, updatedAt:now},{merge:true});
    });
    await batch.commit(); alert('âœ… ì „ì²´ ì¢…ëª© ë¶€í™œ');
  });

  document.getElementById('autoReviveNextOpen')?.addEventListener('change', async (e)=>{
    if(!window.ADMIN_MODE) return;
    try{
      await setDoc(doc(window.db,'marketState','main'),{ autoReviveNextOpen: !!e.target.checked, updatedAt: Date.now() },{merge:true});
    }catch(err){ console.warn(err); }
  });
}

/* ----------------------------------------------------
   8) ê·¸ë˜í”„ íƒ­ ë²„íŠ¼ ë°”ì¸ë”©(ê¸°ì¡´ í•¨ìˆ˜ í˜¸ì¶œ)
---------------------------------------------------- */
function bindGraphButtons(){
  document.getElementById('marketStartBtn')?.addEventListener('click', ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ'); window.marketStart?.();
  });
  document.getElementById('marketEndBtn')?.addEventListener('click', ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ'); window.marketEnd?.();
  });
  document.getElementById('resetGraphBtn')?.addEventListener('click', ()=>{
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ'); window.resetGraph?.();
  });
  document.getElementById('applyIntervalBtn')?.addEventListener('click', applyGraphInterval);
  document.getElementById('applyDeltaBtn')?.addEventListener('click', applyDeltaMax);
  document.getElementById('adjustAllBtn')?.addEventListener('click', adjustAllPrices);

  /* ê°œë³„ ì¡°ì • ìœ„ì„ */
  document.getElementById('graphCompanyAdjust')?.addEventListener('click', async (e)=>{
    const b=e.target.closest('button[data-role="adj-apply"]'); if(!b) return;
    if(!window.ADMIN_MODE) return alert('ê´€ë¦¬ìë§Œ');
    const id=b.dataset.id;
    const input = document.querySelector(`input[data-role="adj-input"][data-id="${id}"]`);
    const delta=parseInt(input?.value||'0',10);
    await adjustCompanyPriceById(id, delta);
  });
}

/* ----------------------------------------------------
   9) ì´ˆê¸°í™” â€” ë Œë”/ë°”ì¸ë”©/êµ¬ë…
---------------------------------------------------- */
function initAdminPanel(){
  renderAdminTabs();
  enableDrag();

  // ê·¸ë˜í”„ íƒ­
  renderGraphAdjustPanel();
  bindGraphButtons();

  // ìœ ì €/ì…ì¶œê¸ˆ
  subscribeUsersPanel();
  subscribeFinanceQueues();

  // ì£¼ê°€ì¡°ì‘ / ë°°ìœ¨Â·í™•ë¥ 
  renderStockTuner();
  renderChangePanel();

  // ë‰´ìŠ¤/ê³µì§€
  bindNewsNoticePostButtons();
  subscribeNewsAdmin();
  subscribeNoticeAdmin();

  // ìƒì¥íì§€
  subscribeDelistForAdmin();

  // ê¸°ë³¸ íƒ­
  window.showTab?.('graph');
}

/* íŒ¨ë„ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ í•œë²ˆë§Œ ì´ˆê¸°í™” ë˜ë„ë¡ */
let __adminInited=false;
const btnAdminLogin = document.getElementById('btnAdminLogin');
btnAdminLogin?.addEventListener('click', ()=>{
  // íŒŒíŠ¸ 4-1ì˜ checkAdmin ì´í›„ ADMIN_MODEê°€ trueê°€ ë˜ë©´ ì‹¤í–‰
  setTimeout(()=>{
    if(window.ADMIN_MODE && !__adminInited){
      __adminInited=true;
      initAdminPanel();
    }
  }, 50);
});

/* í˜¹ì‹œ ì´ë¯¸ ADMIN_MODE=true ìƒíƒœì—ì„œ ë¦¬ë¡œë“œëœ ê²½ìš° ëŒ€ë¹„ */
if(window.ADMIN_MODE && !__adminInited && adminPanel?.style.display==='block'){
  __adminInited=true;
  initAdminPanel();
}
</script>
