<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>떡잎방범대 주식 센터</title>

  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
      --chip:#0b1220; --chipBorder:#374151;
      --muted:#9ca3af; --muted2:#6b7280;
      --green:#10b981; --red:#ef4444; --yellow:#eab308;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }
    h2,h3,h4{margin:0 0 10px}
    small{color:var(--muted)}

    /* 상단 사용자/버튼줄 */
    #userRow,#log { margin:20px auto; max-width:1200px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; display:flex; align-items:center; gap:10px; }

    /* 폼/버튼 */
    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1200px; flex-wrap:wrap; }
    #depositForm input { padding:10px 12px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); }
    #depositForm .memo { min-width:260px; }

    button {
      padding:10px 12px; cursor:pointer; border-radius:10px; background:var(--accent); color:var(--ink);
      border:1px solid transparent; transition:filter .15s ease, background .15s;
    }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    .btn-outline { background:transparent; border-color:var(--chipBorder); }
    .btn-danger  { background:var(--danger); }
    .btn-ok      { background:var(--ok); }
    .btn-green   { background:#14532d; }
    .btn-red     { background:#7f1d1d; }
    .btn-chip    { background:var(--chip); border:1px solid var(--chipBorder); }

    /* 차트 */
    #chartWrap { position:relative; margin:20px auto; max-width:1200px; height:420px; background:#111827; border-radius:12px; overflow:hidden; border:1px solid #1f2937; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    /* 종목 카드 */
    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1200px; }
    .company { background:var(--card); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; transition:filter .2s ease, opacity .2s ease, transform .08s ease; border:1px solid #273244; }
    .company:hover{ transform: translateY(-1px); }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:700; }
    .status-badge{ font-size:13px; line-height:1; padding:5px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder); color:var(--ink2); }
    .status-badge.delisted{ background:#111827; border-color:#4b5563; color:#9ca3af; }
    .company.delisted{ opacity:.6; filter:grayscale(.2); }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:10px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    /* 로그 */
    #log { max-height:260px; overflow-y:auto; background:#111827; padding:12px; border-radius:12px; border:1px solid #1f2937; }

    /* 카드 & 모달 등 공통 */
    .req-card { background:var(--card); border-radius:12px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; border:1px solid #273244; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grow { flex:1 1 auto; }
    .muted { color:var(--muted); }
    .muted2 { color:var(--muted2); }
    .chip { background:var(--chip); border:1px solid var(--chipBorder); padding:6px 10px; border-radius:999px; font-size:12px; }
    .kbd { padding:3px 6px; border-radius:6px; background:#0b1220; border:1px solid #374151; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#e5e7eb; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:12px; text-align:center; width:min(92%,540px); position:relative; border:1px solid #273244; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:10px; width:92%; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--red); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    /* 관리자 패널 */
    .admin-panel{display:none; max-width:1200px; margin:20px auto; background:var(--card); padding:10px; border-radius:12px; position:relative; border:1px solid #273244; }
    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:10px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); width:260px; }
    #adminLogin .row{justify-content:center}

    /* 드래그 가능한 관리자 패널 (화면 밖 이동 허용) */
    #adminPanelAll {
      position:fixed; top:50px; left:50px; z-index:9999;
      width:92%; max-width:1200px;
      pointer-events:auto;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #adminPanelHeader {
      background:#374151; padding:10px 44px 10px 12px; cursor:move;
      border-radius:12px 12px 0 0; font-weight:700; user-select:none;
      position:relative; border-bottom:1px solid #1f2937;
      display:flex; align-items:center; justify-content:space-between;
    }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    /* 탭 버튼바 */
    .tabbar{ display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
    .tabbar button{ border-radius:999px; padding:8px 12px; }
    .tab-section{ display:block; }

    /* 섹션 카드 */
    .section { background:#111827; border-radius:12px; padding:12px; border:1px solid #1f2937; }
    .section h3{ margin-bottom:6px; }

    /* 빠른 주가조작 상단 툴바 */
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px; border-radius:10px; background:#0b1220; border:1px solid #1f2937; }
    .toolbar select, .toolbar input[type="number"], .toolbar input[type="range"]{
      padding:8px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink);
    }
    .toolbar .value{ min-width:78px; text-align:center; }

    /* 카드 그리드 */
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .grid-4{ display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; }

    /* 상장폐지 타이머 리스트 */
    .delist-row { display:grid; grid-template-columns: 1.4fr 1fr 1.2fr 1fr; gap:10px; align-items:center; }
    .delist-row .cell{ padding:8px; border:1px solid var(--chipBorder); background:var(--chip); border-radius:10px; }
    .delist-row .cell strong{ display:block; margin-bottom:4px; }
    .badge { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #374151; font-size:12px; }
    .badge.green{ color:#34d399; border-color:#14532d; background:#082516; }
    .badge.red{ color:#f87171; border-color:#7f1d1d; background:#290e0e; }
    .badge.yellow{ color:#facc15; border-color:#854d0e; background:#2b1b07; }

    /* 반응형 */
    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } .grid-4{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } .delist-row{ grid-template-columns:1fr; } .grid-4{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } .grid-3{ grid-template-columns:1fr; } .grid-4{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h1>떡잎방범대 주식 센터</h1>

  <!-- 상단 사용자 패널 -->
  <div id="userRow">
    <div id="userInfo">
      <span>⏳ 로그인 대기중...</span>
      <span id="marketStatusChip" class="chip">시장 상태: <strong id="marketStatusText">대기</strong></span>
    </div>
    <div class="row">
      <button class="btn-outline" onclick="logout()">로그아웃</button>
      <button onclick="openWithdrawModal()">출금 요청</button>
      <button onclick="openNoticeModal()">📢 공지사항</button>
      <button onclick="openNewsModal()">📰 뉴스 보기 <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span></button>
    </div>
  </div>

  <!-- 입금 요청 -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="인게임 계좌번호 (예: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="금액 (예: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="메모 (선택)">
    <button onclick="requestDeposit()">입금 요청</button>
  </div>

  <!-- 차트/종목/로그 -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- 로그인 모달 (유저) -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>정보 입력 후 시작</h2>
      <p class="muted">게임용 고유번호와 이름을 입력하세요.</p>
      <input type="text" id="customId" placeholder="고유번호 입력 (예: U-0001)"><br>
      <input type="text" id="customName" placeholder="이름 입력"><br>
      <button id="startBtn">시작</button>
    </div>
  </div>

  <!-- 출금 요청 모달 -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeWithdrawModal()">✕</button>
      <h2>출금 요청</h2>
      <div class="stack">
        <input type="text" id="withdrawId" placeholder="고유번호 입력">
        <input type="text" id="withdrawName" placeholder="이름 입력">
        <input type="number" id="withdrawAmount" placeholder="출금 금액 입력" oninput="updateWithdrawFee()">
        <div id="withdrawFeeInfo" class="muted" style="min-height:20px;"></div>
        <input type="text" id="withdrawAccount" placeholder="본인 계좌번호 입력">
        <div class="row" style="justify-content:center;">
          <button class="btn-ok" onclick="submitWithdraw()">요청</button>
          <button class="btn-outline" onclick="closeWithdrawModal()">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 공지 모달 -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeNoticeModal()">✕</button>
      <h2>📢 공지사항</h2>
      <div id="noticeContent" style="text-align:left; max-height:360px; overflow-y:auto; margin-top:10px;">
        <p>현재 등록된 공지사항이 없습니다.</p>
      </div>
      <div class="row" style="justify-content:center; margin-top:8px;">
        <button class="btn-outline" onclick="closeNoticeModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 뉴스 모달 -->
  <div id="newsModal" class="modal">
    <div class="modal-content" style="margin-top:40px;">
      <button class="xbtn" onclick="closeNewsModal()">✕</button>
      <h2>📰 최신 뉴스</h2>
      <div id="newsContent" style="text-align:left; max-height:360px; overflow-y:auto; margin-top:10px;">
        <p>현재 등록된 뉴스가 없습니다.</p>
      </div>
      <div class="row" style="justify-content:center; margin-top:8px;">
        <button class="btn-outline" onclick="closeNewsModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 관리자 로그인 (2단계) -->
  <div id="adminLogin" class="section" style="margin: 28px auto; max-width: 1200px;">
    <h3>🛡️ 관리자 로그인 (2단계)</h3>
    <div class="row" style="margin-top:6px;">
      <div class="stack">
        <label class="muted">1) 관리자 코드</label>
        <div class="row">
          <input type="password" id="adminCode" placeholder="관리자 코드 입력 (예: ADBEN7732)">
          <button onclick="checkAdminCode()">확인</button>
        </div>
        <small id="adminCodeStatus" class="muted">관리자 코드 검증 필요</small>
      </div>

      <div class="stack">
        <label class="muted">2) 관리자 이메일 (링크 로그인)</label>
        <div class="row">
          <input id="adminEmail" type="email" placeholder="관리자 이메일 (예: moast60@gmail.com)" style="width:320px;">
          <button id="sendLinkBtn" class="btn-green" onclick="sendAdminEmailLink()" disabled>링크 전송</button>
          <button id="finishEmailLinkBtn" class="btn-outline" onclick="finishAdminEmailLink()" disabled>링크로 로그인 완료</button>
        </div>
        <small class="muted">※ 받은 메일의 링크를 클릭한 뒤, 이 버튼으로 완료 처리</small>
        <small id="adminEmailStatus" class="muted">관리자 메일 미검증</small>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <span class="chip">허용 관리자: <strong id="adminAllowListChip">불러오는 중...</strong></span>
      <span class="chip">상태: <strong id="adminAuthState">미인증</strong></span>
    </div>
  </div>

  <!-- 관리자 통합 패널 (드래그 가능, 화면 밖 이동 허용) -->
  <div id="adminPanelAll" class="admin-panel" style="display:none;">
    <div id="adminPanelHeader">
      <div>⚙️ 관리자 통합 패널</div>
      <button class="xbtn" onclick="closeAdmin('adminPanelAll')">✕</button>
    </div>

    <div style="padding:10px;">
      <!-- 탭 버튼 -->
      <div class="tabbar">
        <button onclick="showTab('graph')">📊 그래프</button>
        <button onclick="showTab('users')">👥 유저</button>
        <button onclick="showTab('finance')">💳 입출금</button>
        <button onclick="showTab('stock')">🎛️ 주가조작</button>
        <button onclick="showTab('change')">📈 배율/확률</button>
        <button onclick="showTab('news')">📰 뉴스</button>
        <button onclick="showTab('notice')">📢 공지사항</button>
        <button onclick="showTab('delist')">⚫ 상장폐지</button>
      </div>

      <!-- 그래프 -->
      <div id="tab-graph" class="tab-section">
        <div class="section">
          <h3>📊 그래프/금액 제어 패널</h3>
          <div class="row" style="margin-top:6px;">
            <button class="btn-ok" onclick="marketStart()">장 시작 + 시세 시작</button>
            <button class="btn-outline" onclick="marketEnd()">장 마감 + 시세 정지</button>
            <button class="btn-chip" onclick="resetGraph()">그래프 초기화</button>

            <label class="chip">전체 조정 ±금액</label>
            <input type="number" id="allDelta" value="100" style="width:120px;">
            <button class="btn-chip" onclick="adjustAllPrices()">적용</button>
          </div>

          <div class="grid-3" style="margin-top:12px;">
            <div class="stack">
              <strong>⏱️ 변동 주기 (초)</strong>
              <div class="row">
                <input type="number" id="intervalInput" value="5" min="1" style="width:120px;">
                <button onclick="applyGraphInterval()">적용</button>
              </div>
              <small class="muted">드라이버(갱신 담당) 브라우저에서만 타이머가 돌고 전체에 동기화됩니다.</small>
            </div>
            <div class="stack">
              <strong>📊 변동폭 상한(±원)</strong>
              <div class="row">
                <input type="number" id="deltaMaxInput" value="1000000" min="1" style="width:160px;">
                <button onclick="applyDeltaMax()">적용</button>
              </div>
            </div>
            <div class="stack">
              <strong>📈 전역 변동폭 (%)</strong>
              <div class="row">
                <input type="number" id="volatilityInput" step="0.1" value="1.5" style="width:140px;">
                <button onclick="applyVolatility()">적용</button>
              </div>
            </div>
          </div>

          <hr style="opacity:.2; margin:12px 0">

          <h4>📈 개별 종목 금액 조정</h4>
          <div id="graphCompanyAdjust" class="stack"></div>
          <p class="muted" style="margin-top:6px;">※ '현재가(livePrice)'를 직접 조정합니다.</p>
        </div>
      </div>

      <!-- 유저 -->
      <div id="tab-users" class="tab-section" style="display:none;">
        <div class="section">
          <h3>👥 유저 상태 패널</h3>
          <div class="req-card">
            <div>
              <div><strong>관리자 권한 관리</strong></div>
              <div class="muted" style="font-size:12px;">고유번호와 이름을 입력하여 관리자 권한을 부여/해제</div>
            </div>
            <div class="row">
              <input id="promoteIdInput" type="text" placeholder="고유번호" style="width:160px;">
              <input id="promoteNameInput" type="text" placeholder="이름" style="width:160px;">
              <button onclick="promoteAdmin()">권한 부여</button>
              <button class="btn-outline" onclick="demoteAdmin()">권한 해제</button>
            </div>
          </div>
          <div id="userList">로드 중...</div>
        </div>
      </div>

      <!-- 입출금 -->
      <div id="tab-finance" class="tab-section" style="display:none;">
        <div class="section">
          <h3>💳 입/출금 요청 패널</h3>
          <h4 style="margin-top:8px;">입금 요청</h4>
          <div id="depositRequests" class="stack">대기중인 입금 요청 없음</div>
          <h4 style="margin-top:12px;">출금 요청</h4>
          <div id="withdrawRequests" class="stack">대기중인 출금 요청 없음</div>
        </div>
      </div>

      <!-- 주가조작 (개선 UI 포함) -->
      <div id="tab-stock" class="tab-section" style="display:none;">
        <div class="section">
          <h3>🎛️ 주가 조작 패널</h3>

          <!-- 빠른 조작 툴바 -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">종목</label>
            <select id="quickCompanySelect"></select>

            <label class="chip">틱 크기(원)</label>
            <input type="range" id="quickTickRange" min="100" max="1000000" step="100">
            <span class="value" id="quickTickValue">10,000</span>

            <button class="btn-green" onclick="quickNudge(+1)">+ 틱</button>
            <button class="btn-red" onclick="quickNudge(-1)">- 틱</button>

            <span style="width:12px"></span>

            <label class="chip">연속 틱</label>
            <input type="number" id="quickBurstCount" value="1" min="1" max="50" style="width:80px;">
            <button class="btn-chip" onclick="quickBurst(+1)">상승 연속</button>
            <button class="btn-chip" onclick="quickBurst(-1)">하락 연속</button>
          </div>

          <!-- 자연틱 설정 -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">자연틱 간격(ms)</label>
            <input type="number" id="stockTickIntervalInput" value="1200" min="200" step="100" style="width:120px;">

            <label class="chip">기본 틱(원)</label>
            <input type="number" id="stockTickSizeInput" value="10000" min="100" step="100" style="width:120px;">

            <label class="chip">부드러움(0~1)</label>
            <input type="number" id="stockSmoothingInput" value="0.35" min="0" max="1" step="0.05" style="width:100px;">

            <label class="chip">랜덤성 σ</label>
            <input type="number" id="stockSigmaInput" value="0.8" min="0" max="5" step="0.1" style="width:100px;">

            <button onclick="applyNaturalTick()" class="btn-chip">자연틱 적용</button>
            <button onclick="toggleNaturalTick()" class="btn-outline" id="toggleNaturalTickBtn">자연틱 시작</button>
          </div>

          <div class="stack" style="margin-top:10px;">
            <div id="stockTuner"></div>
          </div>
        </div>
      </div>

      <!-- 배율/확률 -->
      <div id="tab-change" class="tab-section" style="display:none;">
        <div class="section">
          <h3>📈 배율 & 확률 관리 패널</h3>

          <div class="grid-3" style="margin-top:8px;">
            <div class="row">
              <label class="chip">전체 이득%</label>
              <input id="globalProfit" type="number" step="0.01" min="0" max="1" value="0.4" style="width:100px;">
              <label class="chip">전체 손해%</label>
              <input id="globalLoss" type="number" step="0.01" min="0" max="1" value="0.6" style="width:100px;">
              <button onclick="setAllChances()">전체 확률 적용</button>
            </div>

            <div class="row">
              <label class="chip">전체 배율(변동폭 배수)</label>
              <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:120px;">
              <button onclick="setAllMultipliers()">전체 배율 적용</button>
            </div>

            <div class="row">
              <button onclick="runScenario('riseEnd')">📈 상승종료</button>
              <button class="btn-outline" onclick="runScenario('fallEnd')">📉 하락종료</button>
            </div>
          </div>

          <div id="changePanel" class="stack" style="margin-top:12px;"></div>
        </div>
      </div>

      <!-- 뉴스 -->
      <div id="tab-news" class="tab-section" style="display:none;">
        <div class="section">
          <h3>📰 뉴스 관리 패널</h3>
          <div class="stack" style="margin-bottom:10px;">
            <input type="text" id="newsTitleInput" placeholder="뉴스 제목">
            <textarea id="newsBodyInput" placeholder="뉴스 내용"></textarea>
            <div class="row">
              <button onclick="postNews()">등록</button>
            </div>
          </div>
          <h4>등록된 뉴스</h4>
          <div id="newsList" class="stack">불러오는 중...</div>
        </div>
      </div>

      <!-- 공지사항 -->
      <div id="tab-notice" class="tab-section" style="display:none;">
        <div class="section">
          <h3>📢 공지사항 관리 패널</h3>
          <div class="stack" style="margin-bottom:10px;">
            <input type="text" id="noticeTitleInput" placeholder="공지 제목">
            <textarea id="noticeBodyInput" placeholder="공지 내용"></textarea>
            <div class="row">
              <button onclick="postNotice()">등록</button>
            </div>
          </div>
          <h4>등록된 공지사항</h4>
          <div id="noticeList" class="stack">불러오는 중...</div>
        </div>
      </div>

      <!-- 상장폐지 (타이머 UI 포함) -->
      <div id="tab-delist" class="tab-section" style="display:none;">
        <div class="section">
          <h3>⚫ 상장폐지 관리 패널</h3>
          <p class="muted" style="margin:6px 0 10px;">상장폐지된 종목은 거래(매수/매도)가 불가능하며 가격 시뮬레이션에서도 제외됩니다.</p>

          <!-- 빠른 예약/복구 -->
          <div class="toolbar">
            <label class="chip">종목</label>
            <select id="delistCompanySelect"></select>

            <label class="chip">상장폐지까지 지연(분)</label>
            <input type="number" id="delistDelayMinutes" value="10" min="1" step="1" style="width:100px;">

            <label class="chip">자동 복구(분)</label>
            <input type="number" id="delistAutoRestoreMinutes" value="0" min="0" step="1" style="width:100px;">
            <span class="muted">(0=복구 없음)</span>

            <button onclick="scheduleDelist()" class="btn-red">상장폐지 예약</button>
            <button onclick="cancelScheduledDelist()" class="btn-outline">예약 취소</button>
            <button onclick="forceDelistNow()" class="btn-red">즉시 상장폐지</button>
            <button onclick="restoreDelistedNow()" class="btn-chip">즉시 복구</button>
          </div>

          <!-- 특정 시각 예약 -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">특정 시각 예약</label>
            <input type="datetime-local" id="delistAtDatetime">
            <button onclick="scheduleDelistAt()" class="btn-chip">해당 시각에 상장폐지</button>
            <span class="muted">※ 자동 복구(분)는 위 입력값을 사용</span>
          </div>

          <!-- 타이머 현황 -->
          <div class="stack" style="margin-top:10px;">
            <div class="row" style="align-items:center; gap:12px;">
              <h4 style="margin:0;">⏲️ 예약 현황</h4>
              <span class="badge yellow" id="delistTimerHeartbeat">대기</span>
              <button class="btn-outline" onclick="refreshDelistTimers()">새로고침</button>
            </div>
            <div id="delistTimersList" class="stack">
              <!-- JS에서 예약된 타이머 행 렌더링 -->
              <div class="muted">예약된 상장폐지 타이머가 없습니다.</div>
            </div>
          </div>

          <hr style="opacity:.2; margin:12px 0">

          <!-- 종목별 상태/버튼 -->
          <div id="delistPanel" class="stack">불러오는 중...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js (PART 3에서 사용) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PART 2~4에서 모든 스크립트를 채워 넣음 -->
  <script>
    /* 이 블록은 PART 2~4에서 구현될 함수가 불려도,
       HTML 파트만 테스트할 때 에러가 안나도록 안전 no-op 바인딩만 둡니다. */

    const noop = ()=>{};
    window.logout = noop;
    window.openWithdrawModal = noop; window.closeWithdrawModal = noop; window.submitWithdraw = noop; window.updateWithdrawFee = noop;
    window.openNoticeModal = noop; window.closeNoticeModal = noop;
    window.openNewsModal = noop; window.closeNewsModal = noop;

    window.requestDeposit = noop;

    window.showTab = function(name){
      document.querySelectorAll('#adminPanelAll .tab-section').forEach(sec => sec.style.display = 'none');
      const t = document.getElementById('tab-'+name);
      if(t) t.style.display='block';
    };

    // 관리자 2단계 관련 no-op (PART 2에서 구현)
    window.checkAdminCode = noop;
    window.sendAdminEmailLink = noop;
    window.finishAdminEmailLink = noop;

    // 그래프/가격
    window.marketStart = noop;
    window.marketEnd = noop;
    window.resetGraph = noop;
    window.adjustAllPrices = noop;
    window.applyGraphInterval = noop;
    window.applyDeltaMax = noop;
    window.applyVolatility = noop;

    // 변경/확률/배율
    window.setAllMultipliers = noop;
    window.setAllChances = noop;
    window.runScenario = noop;

    // 주가조작(향상 UI)
    window.quickNudge = noop;
    window.quickBurst = noop;
    window.applyNaturalTick = noop;
    window.toggleNaturalTick = noop;

    // 상장폐지 타이머
    window.scheduleDelist = noop;
    window.cancelScheduledDelist = noop;
    window.forceDelistNow = noop;
    window.restoreDelistedNow = noop;
    window.scheduleDelistAt = noop;
    window.refreshDelistTimers = noop;

    // 관리자 권한/유저/입출금/뉴스/공지
    window.promoteAdmin = noop;
    window.demoteAdmin = noop;
    window.postNews = noop;
    window.deleteNews = noop;
    window.toggleNewsVisibility = noop;
    window.postNotice = noop;
    window.deleteNotice = noop;
  </script>
</body>
</html>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged,
    sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
    onSnapshot, query, orderBy, deleteDoc, writeBatch, increment
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // ===== Firebase 초기화 =====
  const firebaseConfig = {
    apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
    authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
    projectId: "cotyledons-of-stock-a1241",
    storageBucket: "cotyledons-of-stock-a1241.appspot.com",
    messagingSenderId: "962984742513",
    appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
    measurementId: "G-NRPT075Q3X"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== 전역 상태 =====
  let currentUser = null;
  let player = { holdings:{}, cash:0 };
  let unsubscribeUser = null;

  let ADMIN_MODE = false;
  let ADMIN_CODE_OK = false;
  let ADMIN_EMAIL_OK = false;

  const allowedAdminEmails = ["moast60@gmail.com"]; // ✅ 허용된 관리자 메일

  // ===== 유틸 =====
  const parseNumber = (str) => {
    const n = parseInt(String(str).replace(/[^0-9]/g,''), 10);
    return isNaN(n) ? 0 : Math.max(0, n);
  };
  const log = (msg) => {
    const logDiv = document.getElementById("log");
    if(!logDiv) return;
    logDiv.innerHTML = "<div>" + msg + "</div>" + logDiv.innerHTML;
  };

  // ===== 유저 로그인 (익명 + 커스텀 정보) =====
  async function ensureAuth(){
    return new Promise(resolve=>{
      onAuthStateChanged(auth, (user)=>{
        if(user){ resolve(user); }
        else{
          signInAnonymously(auth).then(res=>resolve(res.user))
            .catch(e=>{ console.error('익명 로그인 실패:', e); resolve(null); });
        }
      });
    });
  }

  document.getElementById("startBtn").onclick = async () => {
    const cid   = document.getElementById("customId").value.trim();
    const cname = document.getElementById("customName").value.trim();
    if(!cid||!cname){ alert("고유번호와 이름을 입력하세요."); return; }
    try{
      await ensureAuth();
      const userRef = doc(db,"users",cid);
      const snap = await getDoc(userRef);
      let nextCash=0; let nextHoldings={};
      if(snap.exists()){
        const d=snap.data();
        if(typeof d.cash==='number') nextCash=d.cash;
        if(d.holdings && typeof d.holdings==='object') nextHoldings=d.holdings;
      }
      currentUser = { id:cid, name:cname, cash:nextCash, active:true };
      player.cash=nextCash; player.holdings=nextHoldings;

      await setDoc(userRef,{ ...currentUser, holdings:nextHoldings, lastLoginAt:Date.now(), active:true },{merge:true});
      localStorage.setItem("stockUser", JSON.stringify({ id:cid, name:cname }));

      document.getElementById("loginModal").style.display='none';
      renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid);
    }catch(e){
      console.error("⚠️ 로그인 처리 오류:", e);
      alert("로그인 중 오류: " + (e.message || e));
    }
  };

  function subscribeCurrentUser(uid){
    if(unsubscribeUser){ try{unsubscribeUser();}catch(e){} unsubscribeUser=null; }
    const uref=doc(db,"users",uid);
    unsubscribeUser = onSnapshot(uref,(snap)=>{
      if(!snap.exists()) return;
      const d=snap.data();
      if(typeof d.cash==='number') player.cash=d.cash;
      if(d.holdings && typeof d.holdings==='object') player.holdings=d.holdings;
      renderUserInfo(); updateHoldingsUI();
    });
  }

  async function logout(){
    try{ if(currentUser){ await updateDoc(doc(db,"users",currentUser.id),{active:false, lastLogoutAt:Date.now()}); } }catch(e){}
    if(unsubscribeUser){ try{unsubscribeUser();}catch(e){} unsubscribeUser=null; }
    localStorage.removeItem('stockUser'); location.reload();
  }
  window.logout = logout;

  // ===== 관리자 로그인 (2단계) =====
  window.checkAdminCode = function(){
    const code = document.getElementById('adminCode').value.trim();
    if(code !== 'ADBEN7732'){
      alert('❌ 잘못된 관리자 코드');
      document.getElementById('adminCode').value='';
      document.getElementById('adminCodeStatus').textContent="❌ 코드 불일치";
      ADMIN_CODE_OK=false;
      return;
    }
    ADMIN_CODE_OK = true;
    document.getElementById('adminCodeStatus').textContent="✅ 관리자 코드 통과";
    document.getElementById('sendLinkBtn').disabled=false;
    alert("관리자 코드 확인됨. 이메일 인증 진행하세요.");
  };

  window.sendAdminEmailLink = async function(){
    if(!ADMIN_CODE_OK){ alert("먼저 관리자 코드를 통과하세요."); return; }
    const email = document.getElementById('adminEmail').value.trim();
    if(!allowedAdminEmails.includes(email)){
      alert("허용되지 않은 관리자 이메일");
      return;
    }
    try{
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true,
      };
      await sendSignInLinkToEmail(auth, email, actionCodeSettings);
      window.localStorage.setItem("adminEmailForSignIn", email);
      document.getElementById('adminEmailStatus').textContent="📩 이메일 링크 전송됨: " + email;
      document.getElementById('finishEmailLinkBtn').disabled=false;
      alert("이메일로 로그인 링크를 보냈습니다. 받은 메일을 확인하세요.");
    }catch(e){
      console.error("링크 전송 실패:", e);
      alert("링크 전송 실패: " + (e.message || e));
    }
  };

  window.finishAdminEmailLink = async function(){
    try{
      if(isSignInWithEmailLink(auth, window.location.href)){
        let email = window.localStorage.getItem("adminEmailForSignIn");
        if(!email){
          email = window.prompt("이메일을 입력하세요");
        }
        const res = await signInWithEmailLink(auth, email, window.location.href);
        console.log("관리자 이메일 로그인 성공:", res.user.email);
        if(!allowedAdminEmails.includes(res.user.email)){
          alert("허용되지 않은 이메일");
          return;
        }
        ADMIN_EMAIL_OK = true;
        checkAdminAllPassed();
      }else{
        alert("이 URL은 이메일 로그인 링크가 아닙니다.");
      }
    }catch(e){
      console.error("이메일 로그인 실패:", e);
      alert("이메일 로그인 실패: " + (e.message || e));
    }
  };

  function checkAdminAllPassed(){
    if(ADMIN_CODE_OK && ADMIN_EMAIL_OK){
      ADMIN_MODE = true;
      document.getElementById("adminAuthState").textContent="✅ 관리자 인증 완료";
      document.getElementById("adminPanelAll").style.display='block';
      alert("관리자 패널이 열렸습니다!");
      // 이후 PART 3, 4에서 렌더 함수 실행
      renderGraphAdjustPanel();
      renderUserList(true);
      renderFinanceQueues(true);
      renderStockTuner();
      renderChangePanel();
      renderNewsAdminList();
      renderNoticeAdminList();
      renderDelistPanel();
    }
  }

  // ====== 유저 UI 렌더러 (초기 버전) ======
  function renderUserInfo(){
    const userInfo=document.getElementById("userInfo");
    if(currentUser){
      userInfo.innerHTML=`👤 <strong>${currentUser.name}</strong> (${currentUser.id})
        &nbsp;|&nbsp; 💵 보유현금: <strong>${(player.cash||0).toLocaleString()} KRW</strong>`;
    }else{
      userInfo.textContent="⏳ 로그인 대기중...";
    }
  }

  function updateHoldingsUI(){ /* PART 3에서 구체 구현 */ }
  function initCompaniesUI(){ /* PART 3에서 구현 */ }

  // ===== 초기 로드 =====
  window.onload = async () => {
    await ensureAuth();
    const saved = localStorage.getItem('stockUser');
    if(saved){
      try{
        const parsed = JSON.parse(saved);
        if(parsed && parsed.id && parsed.name){
          currentUser = { id: parsed.id, name: parsed.name };
          document.getElementById("loginModal").style.display='none';
          try{ await updateDoc(doc(db,"users",parsed.id), { active:true, lastLoginAt: Date.now() }); }catch(e){}
          renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(parsed.id);
        }else{ document.getElementById("loginModal").style.display='flex'; }
      }catch(e){
        localStorage.removeItem('stockUser'); document.getElementById("loginModal").style.display='flex';
      }
    }else{
      document.getElementById("loginModal").style.display='flex';
    }

    // 이메일 링크 처리 (로그인 직후)
    if(isSignInWithEmailLink(auth, window.location.href)){
      let email = window.localStorage.getItem("adminEmailForSignIn");
      if(!email){
        email = window.prompt("관리자 이메일을 입력하세요");
      }
      try{
        const res = await signInWithEmailLink(auth, email, window.location.href);
        if(allowedAdminEmails.includes(res.user.email)){
          ADMIN_EMAIL_OK=true; checkAdminAllPassed();
          document.getElementById('adminEmailStatus').textContent="✅ 관리자 이메일 통과: " + res.user.email;
        }
      }catch(e){
        console.error("이메일 로그인 처리 오류:", e);
      }
    }
  };
</script>

<script type="module">
  import { 
    collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, 
    query, orderBy, deleteDoc, writeBatch, increment 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { db } from "./firebase-config.js"; // (PART2에서 초기화된 db 불러오기)

  // ===== 전역 =====
  let chart = null;
  let priceTimer = null;
  let updateInterval = 5000; // 5초 기본
  let deltaMax = 1000000;
  let marketOpenFlag = false;
  let volatility = 1.5;
  let lastChartTick = 0;

  const marketState = { bias: {} };
  const companyChances = {};

  // ===== 회사 목록 =====
  const companies = [
    {name:"떡잎방범대", basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"카스틸로",   basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"사쿠라",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"청룡",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"경찰청",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"EMS",        basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"올드보이",   basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"작두",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"빅딕",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"차카니",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"inback",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"리얼월드 관리자", basePrice:10000000, multiplier:1, livePrice:10000000},
  ].map(c => ({...c, id: safeId(c.name), delisted:false}));

  function safeId(name){ return String(name).replace(/[^a-zA-Z0-9가-힣]/g,'_'); }
  function ci(s){ return String(s||"").toLowerCase(); }
  function findCompanyById(id){ return companies.find(x=>ci(x.id)===ci(id)||ci(x.name)===ci(id)); }
  function getDisplayPrice(c){ return Math.max(1, Math.floor(typeof c.livePrice==='number' ? c.livePrice : c.basePrice)); }

  // ===== 거래 =====
  async function buy(name, qty){
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert('⛔ 상장폐지 종목은 거래할 수 없습니다.');
    if(!marketOpenFlag) return alert('⛔ 장 마감 중');
    if(!currentUser) return alert('로그인 후 이용해주세요.');

    const p = getDisplayPrice(c);
    const total = p*qty;
    if(player.cash < total) return alert('현금 부족');

    player.cash -= total;
    player.holdings[c.name] = (player.holdings[c.name]||0) + qty;

    try{
      await setDoc(doc(db,"users",currentUser.id),{
        cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
      },{merge:true});
      log(`🟢 매수: [${c.name}] ${qty}주 @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
    }catch(e){ console.error("매수 저장 실패:", e); alert("매수 저장 실패: " + (e.message||e)); }

    renderUserInfo(); updateHoldingsUI();
    impactPrice(c.id, qty, 'buy');
  }

  async function sell(name, qty){
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert('⛔ 상장폐지 종목은 거래할 수 없습니다.');
    if(!marketOpenFlag) return alert('⛔ 장 마감 중');
    if(!currentUser) return alert('로그인 후 이용해주세요.');

    const p = getDisplayPrice(c);
    if((player.holdings[c.name]||0) < qty) return alert('보유 부족');

    const total = p*qty;
    player.cash += total;
    player.holdings[c.name] -= qty;

    try{
      await setDoc(doc(db,"users",currentUser.id),{
        cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
      },{merge:true});
      log(`🔴 매도: [${c.name}] ${qty}주 @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
    }catch(e){ console.error("매도 저장 실패:", e); alert("매도 저장 실패: " + (e.message||e)); }

    renderUserInfo(); updateHoldingsUI();
    impactPrice(c.id, qty, 'sell');
  }

  function impactPrice(name, qty, mode){
    const c=findCompanyById(name);
    if(!c) return;
    const size = Math.max(1, qty);
    const step = Math.min(0.1, size / 10000);
    const sign = (mode==='buy') ? -1 : +1;
    const next = (marketState.bias[c.id]||0) + sign*step;
    marketState.bias[c.id] = Math.max(-1, Math.min(1,next));
  }

  // ===== 차트 =====
  function initChart(){
    if(chart) return;
    const ctx=document.getElementById("chart").getContext("2d");
    chart=new Chart(ctx,{
      type:"line",
      data:{ labels:[], datasets:companies.map(c=>({label:c.name,data:[],borderWidth:2,fill:false,tension:0.25})) },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{ legend:{position:"bottom"} },
        scales:{ x:{ title:{display:true,text:"시간"} }, y:{ title:{display:true,text:"가격(KRW)"}, beginAtZero:false } }
      }
    });
  }

  function appendChartPoint(tickMs){
    if(!chart) return;
    const label=new Date(tickMs||Date.now()).toLocaleTimeString();
    chart.data.labels.push(label);
    companies.forEach((c,i)=>{ chart.data.datasets[i].data.push(getDisplayPrice(c)); });
    const MAX=120;
    if(chart.data.labels.length>MAX){
      chart.data.labels.splice(0,chart.data.labels.length-MAX);
      chart.data.datasets.forEach(d=>{ if(d.data.length>MAX) d.data.splice(0,d.data.length-MAX); });
    }
    chart.update("none");
  }

  // ===== 가격 시뮬레이션 (자연틱) =====
  async function updatePrices(){
    if(!marketOpenFlag) return;
    const tickAt=Date.now();
    const batch=writeBatch(db);

    for(const c of companies){
      if(c.delisted) continue; // 상장폐지 제외

      const prev=c.livePrice||c.basePrice;
      const chance=companyChances[c.id]||{profit:0.4, loss:0.6};
      const denom=Math.max(1e-6,(chance.profit+chance.loss));
      let isUp=Math.random()<(chance.profit/denom);

      const b=marketState.bias[c.id]||0;
      if(b===-1) isUp=true;
      if(b===1)  isUp=false;
      marketState.bias[c.id]=b*0.5;

      const stepPct=(Math.random()*volatility/100)*Math.max(0,c.multiplier||1);
      const signed=isUp?stepPct:-stepPct;
      let nextRaw=prev*(1+signed);

      const diff=nextRaw-prev;
      if(Math.abs(diff)>deltaMax){ nextRaw=prev+Math.sign(diff)*deltaMax; }

      const next=Math.max(1,Math.round(nextRaw));
      c.livePrice=next;

      batch.set(doc(db,"companyPrices",c.id),{current:next,updatedAt:tickAt},{merge:true});
    }
    try{
      await batch.commit();
      await setDoc(doc(db,"marketState","main"),{lastTickAt:tickAt,driverId:localSimId},{merge:true});
    }catch(e){ console.error("시뮬 반영 실패:", e); }
  }

  // ===== 시장 열기/닫기 =====
  async function marketOpen(){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    marketOpenFlag=true;
    try{
      await setDoc(doc(db,"marketState","main"),{isOpen:true,interval:updateInterval,driverId:localSimId,updatedAt:Date.now()},{merge:true});
    }catch(e){ console.warn(e); }
    renderMarketStatus(); await updatePrices(); startLocalTimer(); alert("✅ 장 시작");
  }
  async function marketClose(){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    marketOpenFlag=false;
    try{
      await setDoc(doc(db,"marketState","main"),{isOpen:false,updatedAt:Date.now()},{merge:true});
    }catch(e){ console.warn(e); }
    stopLocalTimer(); renderMarketStatus(); alert("📉 장 마감");
  }

  function startLocalTimer(){
    if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
    priceTimer=setInterval(()=>{ updatePrices().catch(()=>{}); }, updateInterval);
  }
  function stopLocalTimer(){
    if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
  }

  // expose
  window.buy=buy; window.sell=sell;
  window.marketStart=marketOpen; window.marketEnd=marketClose;
</script>

<script type="module">
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { db } from "./firebase-config.js";

  // ===== 그래프 조정 패널 =====
  function renderGraphAdjustPanel(){
    const wrap=document.getElementById("graphCompanyAdjust"); if(!wrap) return;
    let html="";
    companies.forEach(c=>{
      const id="adj-"+c.id;
      html+=`
        <div class='req-card'>
          <div><strong>${c.name}</strong> | 현재가: 
            <span id='panel-price-${c.id}'>${getDisplayPrice(c).toLocaleString()}</span> KRW
            ${c.delisted? "<span style='margin-left:8px;color:#ef4444;'>⚫ 상장폐지</span>":""}
          </div>
          <div style='display:flex; gap:8px; align-items:center;'>
            <input type='number' id='${id}' placeholder='±금액' style='width:100px;' ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="adjustCompanyPrice('${c.name}')">적용</button>
          </div>
        </div>`;
    });
    wrap.innerHTML=html||"회사 데이터 없음";
  }

  async function adjustCompanyPrice(name, overrideDelta=null){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("⚫ 상장폐지 종목은 가격 조정 불가");

    const inputEl=document.getElementById("adj-"+c.id);
    const delta=(overrideDelta!==null&&!isNaN(overrideDelta))
      ? Number(overrideDelta):(parseInt(inputEl && inputEl.value)||0);

    const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
    await setDoc(doc(db,"companyPrices",c.id),{current:newVal,updatedAt:Date.now()},{merge:true});
    c.livePrice=newVal;

    const p=document.getElementById("panel-price-"+c.id);
    if(p) p.textContent=getDisplayPrice(c).toLocaleString();
    const el=document.getElementById("price-"+c.id);
    if(el) el.textContent=getDisplayPrice(c).toLocaleString();
    updateMaxBuyUI();
  }

  async function adjustAllPrices(){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const delta=parseInt(document.getElementById("allDelta").value)||0;
    const tickAt=Date.now();
    const batch=writeBatch(db);
    for(const c of companies){
      if(c.delisted) continue;
      const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
      c.livePrice=newVal;
      batch.set(doc(db,"companyPrices",c.id),{current:newVal,updatedAt:tickAt},{merge:true});
    }
    await batch.commit();
    await setDoc(doc(db,"marketState","main"),{lastTickAt:tickAt},{merge:true});
    updateMaxBuyUI();
  }

  // ===== 배율/확률 패널 =====
  function renderChangePanel(){
    const host=document.getElementById("changePanel"); if(!host) return;
    let html="";
    companies.forEach(c=>{
      const ch=companyChances[c.id]||{profit:0.4,loss:0.6};
      html+=`
        <div class="req-card">
          <div style="min-width:220px;">
            <div><strong>${c.name}</strong> ${c.delisted?"<span style='margin-left:8px;color:#ef4444;'>⚫ 상장폐지</span>":""}</div>
            <div class="tiny muted">배율: <strong id="mult-${c.id}">${Number(c.multiplier||1)}</strong> |
              확률: ↑${(ch.profit*100).toFixed(1)}% / ↓${(ch.loss*100).toFixed(1)}%</div>
          </div>
          <div class="row">
            <input type="number" id="inp-mul-${c.id}" step="0.1" value="${Number(c.multiplier||1)}" style="width:90px;" ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="applyMultiplier('${c.name}')">배율적용</button>
            <input type="number" id="inp-up-${c.id}" step="0.01" min="0" max="1" value="${ch.profit}" style="width:90px;" ${c.delisted?'disabled':''}>
            <input type="number" id="inp-down-${c.id}" step="0.01" min="0" max="1" value="${ch.loss}" style="width:90px;" ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="applyCompanyChance('${c.name}')">확률적용</button>
          </div>
        </div>`;
    });
    host.innerHTML=html||"종목 없음";
  }

  async function applyMultiplier(name){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("⚫ 상장폐지 종목 수정 불가");
    const el=document.getElementById("inp-mul-"+c.id);
    const val=Number(el?.value||1);
    const m=isNaN(val)?1:Math.max(0,val);
    await setDoc(doc(db,'companySettings',c.id),{multiplier:m,updatedAt:Date.now()},{merge:true});
    c.multiplier=m;
    const out=document.getElementById("mult-"+c.id);
    if(out) out.textContent=String(m);
    alert(`✅ ${c.name} 배율 ${m} 적용`);
  }

  async function applyCompanyChance(name){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("⚫ 상장폐지 종목 수정 불가");
    const upEl=document.getElementById("inp-up-"+c.id);
    const dnEl=document.getElementById("inp-down-"+c.id);
    let up=Number(upEl?.value||0.4);
    let dn=Number(dnEl?.value||0.6);
    if(up<0||dn<0||(up+dn)<=0){ return alert("0~1 범위, 합계>0 이어야 함"); }
    await setDoc(doc(db,'companyChances',c.id),{profit:up,loss:dn,updatedAt:Date.now()},{merge:true});
    companyChances[c.id]={profit:up,loss:dn};
    renderChangePanel();
    alert(`✅ ${c.name} 확률 적용 (↑${(up*100).toFixed(1)}% / ↓${(dn*100).toFixed(1)}%)`);
  }

  // expose
  window.renderGraphAdjustPanel=renderGraphAdjustPanel;
  window.adjustCompanyPrice=adjustCompanyPrice;
  window.adjustAllPrices=adjustAllPrices;
  window.renderChangePanel=renderChangePanel;
  window.applyMultiplier=applyMultiplier;
  window.applyCompanyChance=applyCompanyChance;
</script>

<!-- ===== PART 4-2: Admin Advanced (Delist Timer + Better Tuner + Withdraw Fee Fix) ===== -->
<script type="module">
  /* 이 스크립트는 페이지 상단에서 이미 선언된 다음 전역을 그대로 사용합니다.
     - const db, companies, companyChances, marketState, ADMIN_MODE, localSimId
     - Firestore helpers: doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, increment, query
     - 기존 바인딩(window.*)은 여기서 필요한 부분만 "덮어쓰기" (override) 됩니다.
  */

  /* ---------------------------------------------------------
   * 공통 상수/유틸
   * --------------------------------------------------------- */
  const WITHDRAW_FEE_RATE = 0.20; // ✅ UI/승인 로직 통일 20%
  const DELIST_TIMER_COL  = "delistTimers"; // { id: companyId, until, startedAt, durationMs, reason, by }
  const ms = n => Number(n)||0;

  const fmt2 = n => (n<10 ? "0"+n : ""+n);
  function formatRemain(msLeft){
    if(msLeft <= 0) return "00:00";
    const totalSec = Math.floor(msLeft/1000);
    const m = Math.floor(totalSec/60);
    const s = totalSec%60;
    return `${fmt2(m)}:${fmt2(s)}`;
  }

  // 슬라이더 보조(숫자 input과 range 동기화)
  function bindNumberAndRange(numEl, rangeEl){
    if(!numEl || !rangeEl) return;
    const syncToNum   = () => { numEl.value = rangeEl.value; };
    const syncToRange = () => { rangeEl.value = numEl.value; };
    rangeEl.addEventListener('input', syncToNum);
    numEl.addEventListener('input', syncToRange);
    syncToNum();
  }

  /* ---------------------------------------------------------
   * 🔧 출금 수수료 — 버그 픽스 (UI 20% ↔ 승인 10% 불일치 해결)
   * --------------------------------------------------------- */
  // 기존 함수 override
  window.updateWithdrawFee = function(){
    const amount = (()=>{
      const el = document.getElementById('withdrawAmount');
      if(!el) return 0;
      return parseInt(String(el.value||'').replace(/[^0-9]/g,''),10) || 0;
    })();
    const fee = Math.floor(amount * WITHDRAW_FEE_RATE);
    const info = document.getElementById('withdrawFeeInfo');
    if(info){
      const net = Math.max(0, amount - fee);
      info.textContent = `예상 수수료: ${fee.toLocaleString()} KRW (실지급: ${net.toLocaleString()} KRW)`;
    }
  };

  // 승인 로직도 20%에 맞춰 덮어쓰기
  window.approveWithdraw = async function(id, amount, userId){
    try{
      const uref = doc(db,"users",userId);
      const usnap = await getDoc(uref);
      const cash = Number(usnap.data()?.cash||0);
      const fee  = Math.floor(amount * WITHDRAW_FEE_RATE);
      const totalDebit = amount; // 사용자의 잔고에서 빠지는 값(요청액). 실지급=amount-fee 는 관리자 오프체인 처리 가정.
      if(cash < totalDebit){
        alert('사용자 보유 현금 부족으로 승인할 수 없습니다.');
        return;
      }
      await updateDoc(uref, { cash: increment(-totalDebit), updatedAt: Date.now() });
      await updateDoc(doc(db,"withdrawRequests",id),{
        status:'approved', updatedAt:Date.now(), feeApplied: fee, feeRate: WITHDRAW_FEE_RATE
      });
      alert(`✅ 출금 승인 완료 (요청액: ${amount.toLocaleString()} / 수수료: ${fee.toLocaleString()} / 실지급: ${(amount-fee).toLocaleString()})`);
    }catch(e){
      console.error(e);
      alert('승인 처리 실패: ' + (e.message || e));
    }
  };

  /* ---------------------------------------------------------
   * 🎛️ 주가 조작 UI — 보기 쉽고 조작 쉬운 패널 (슬라이더/프리셋)
   * --------------------------------------------------------- */
  // 기존 renderStockTuner 덮어쓰기: 슬라이더 + 프리셋 + 인라인 조정
  window.renderStockTuner = function(){
    const host = document.getElementById('stockTuner'); if(!host) return;
    let html = `
      <div class="req-card" style="gap:14px; align-items:flex-start;">
        <div style="min-width:220px">
          <div><strong>프리셋</strong></div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
            <button onclick="__presetBump(-1000000)">📉 -100만</button>
            <button onclick="__presetBump(-100000)">-10만</button>
            <button onclick="__presetBump(-10000)">-1만</button>
            <button onclick="__presetBump(10000)">+1만</button>
            <button onclick="__presetBump(100000)">+10만</button>
            <button onclick="__presetBump(1000000)">📈 +100만</button>
          </div>
          <div style="color:#9ca3af; font-size:12px; margin-top:8px;">프리셋 클릭 시, 아래 '선택 종목'에 바로 적용됩니다.</div>
        </div>

        <div style="flex:1; min-width:260px;">
          <div><strong>선택 종목 일괄 조정</strong></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px;">
            <select id="__tunerSelect" multiple size="6" style="min-width:200px; max-width:260px;">
              ${companies.map(c=>`<option value="${c.name}" ${c.delisted?'disabled':''}>
                ${c.delisted?'[폐지] ':''}${c.name} (${(c.livePrice||c.basePrice).toLocaleString()}원)
              </option>`).join('')}
            </select>

            <div style="min-width:220px;">
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="__tunerDeltaNum" type="number" step="1000" value="10000" style="width:120px;">
                <input id="__tunerDeltaRange" type="range" min="-1000000" max="1000000" step="1000" value="10000" style="width:200px;">
              </div>
              <div style="margin-top:6px; display:flex; gap:6px;">
                <button onclick="__applyDeltaToSelected()">선택 종목 조정</button>
                <button onclick="__refreshTuner()">새로고침</button>
              </div>
              <div style="color:#9ca3af; font-size:12px; margin-top:6px;">※ 상장폐지 종목은 자동 제외됩니다.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // 개별 카드(퀵 버튼)
    html += companies.map(c=>{
      const disabled = c.delisted ? "disabled" : "";
      return `
        <div class='req-card'>
          <div><strong>${c.name}</strong> | ${(c.livePrice||c.basePrice).toLocaleString()} KRW
            ${c.delisted ? "<span style='margin-left:8px;color:#ef4444;'>⚫ 상장폐지</span>" : ""}</div>
          <div style='display:flex; gap:6px; flex-wrap:wrap;'>
            <button ${disabled} onclick="applyStockTarget('${c.name}', -100000)">-10만</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', -10000)">-1만</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', 10000)">+1만</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', 100000)">+10만</button>
            <input ${disabled} type="number" id="__one-${c.id}" step="1000" value="10000" style="width:100px;">
            <button ${disabled} onclick="(function(){ const v=parseInt(document.getElementById('__one-${c.id}').value)||0; applyStockTarget('${c.name}', v); })()">적용</button>
          </div>
        </div>`;
    }).join('');

    host.innerHTML = html;

    // 슬라이더-숫자 동기화
    bindNumberAndRange(
      document.getElementById('__tunerDeltaNum'),
      document.getElementById('__tunerDeltaRange')
    );
  };

  // 프리셋 버튼 핸들러
  window.__presetBump = function(delta){
    const num = document.getElementById('__tunerDeltaNum');
    const rng = document.getElementById('__tunerDeltaRange');
    if(num && rng){ num.value = String(delta); rng.value = String(delta); }
  };

  // 선택 종목에 일괄 적용
  window.__applyDeltaToSelected = async function(){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const sel = Array.from((document.getElementById('__tunerSelect')||{}).selectedOptions||[]).map(o=>o.value);
    if(!sel.length) return alert("조정할 종목을 선택하세요.");
    const delta = parseInt((document.getElementById('__tunerDeltaNum')||{}).value)||0;

    let count = 0;
    for(const name of sel){
      const c = companies.find(x=>x.name===name);
      if(!c || c.delisted) continue;
      await window.applyStockTarget(name, delta);
      count++;
    }
    alert(`✅ ${count}개 종목 조정 완료 (${delta>0?'+':''}${delta.toLocaleString()}원)`);
  };

  window.__refreshTuner = function(){
    window.renderStockTuner();
  };

  /* ---------------------------------------------------------
   * ⚫ 상장폐지 타이머 — 즉시 폐지 + N분 후 자동 복구
   * --------------------------------------------------------- */
  const delistTimersMap = new Map(); // companyId -> { until, startedAt, durationMs, reason, by }
  let delistTickTimer = null;

  // UI: 상장폐지 탭(기존 함수 덮어쓰기)
  window.renderDelistPanel = function(){
    const host = document.getElementById("delistPanel"); if(!host) return;
    let html = "";
    companies.forEach(c=>{
      const isDelisted = !!c.delisted;
      const timer = delistTimersMap.get(c.id) || null;
      const remain = timer ? Math.max(0, ms(timer.until) - Date.now()) : 0;

      html += `
        <div class="req-card" style="align-items:flex-start;">
          <div style="min-width:260px;">
            <div><strong>${c.name}</strong>
              <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">
                ${isDelisted?'⚫ 상장폐지':'🟢 상장'}
              </span>
            </div>
            <div style="font-size:12px;color:#9ca3af;margin-top:4px;">
              현재가: ${(c.livePrice||c.basePrice).toLocaleString()} KRW, 배율: ${Number(c.multiplier||1)}
            </div>
            ${timer ? `
              <div style="margin-top:6px;">
                ⏳ 자동 복구까지: <strong id="delist-eta-${c.id}">${formatRemain(remain)}</strong>
                ${timer.reason ? `<div style="color:#cbd5e1; font-size:12px; margin-top:2px;">사유: ${escapeHtml(timer.reason)}</div>` : ""}
              </div>
            ` : ""}
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            ${!isDelisted ? `
              <input id="delist-min-${c.id}" type="number" min="1" value="10" style="width:80px;" placeholder="분">
              <input id="delist-reason-${c.id}" type="text" placeholder="사유(선택)" style="width:200px;">
              <button onclick="scheduleDelistWithTimer('${c.name}')">타이머 상장폐지</button>
              <button onclick="delistCompany('${c.name}')" style="background:#7f1d1d;">즉시 상장폐지</button>
            ` : `
              ${timer ? `
                <button onclick="cancelDelistTimer('${c.name}')">타이머 취소 + 즉시 복구</button>
              ` : `
                <button onclick="restoreCompany('${c.name}')">즉시 복구</button>
              `}
            `}
          </div>
        </div>
      `;
    });
    host.innerHTML = html || "기업 없음";
  };

  // HTML escape
  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, ch => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[ch]));
  }

  // Firestore 구독: delistTimers
  function subscribeDelistTimers(){
    onSnapshot(collection(db, DELIST_TIMER_COL), (snap)=>{
      delistTimersMap.clear();
      snap.forEach(docu=>{
        const d = docu.data() || {};
        delistTimersMap.set(docu.id, d);
      });
      // 새 데이터 반영 → UI 갱신
      window.renderDelistPanel();
    });

    // 1초 카운트다운 tick
    if(delistTickTimer) clearInterval(delistTickTimer);
    delistTickTimer = setInterval(async ()=>{
      // 남은 시간 갱신 및 자동 복구 체크
      for(const c of companies){
        const timer = delistTimersMap.get(c.id);
        const span = document.getElementById(`delist-eta-${c.id}`);
        if(timer && span){
          const left = Math.max(0, ms(timer.until) - Date.now());
          span.textContent = formatRemain(left);
          if(left <= 0){
            // 타임업 → 자동 복구 시도
            await autoRestoreIfDue(c.id);
          }
        }
      }
    }, 1000);
  }

  // 스케줄: 즉시 폐지 + N분 타이머 생성
  window.scheduleDelistWithTimer = async function(companyName){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const c = companies.find(x=>x.name===companyName); if(!c) return;
    const minEl  = document.getElementById(`delist-min-${c.id}`);
    const rsnEl  = document.getElementById(`delist-reason-${c.id}`);
    const minutes = Math.max(1, parseInt(minEl?.value||"10", 10));
    const reason  = String(rsnEl?.value||"").trim();

    const now = Date.now();
    const until = now + minutes*60*1000;

    try{
      // 즉시 상장폐지
      await setDoc(doc(db,"companySettings",c.id), { delisted:true, updatedAt: now }, { merge:true });
      c.delisted = true;

      // 타이머 문서 저장
      await setDoc(doc(db, DELIST_TIMER_COL, c.id), {
        startedAt: now,
        durationMs: minutes*60*1000,
        until,
        reason,
        by: (window.currentUser?.id || "admin"),
      }, { merge:true });

      alert(`⚫ ${c.name} 상장폐지 시작 — ${minutes}분 후 자동 복구`);
      window.renderDelistPanel();
    }catch(e){
      console.error(e);
      alert("상장폐지 타이머 설정 실패: " + (e.message||e));
    }
  };

  // 타임업시 자동 복구
  async function autoRestoreIfDue(companyId){
    try{
      const timer = delistTimersMap.get(companyId);
      if(!timer) return; // 이미 취소/복구됨
      if(Date.now() < ms(timer.until)) return; // 아직 남음

      // 회사가 현재 폐지 상태인지 확인
      const csnap = await getDoc(doc(db, "companySettings", companyId));
      const isDelistedNow = Boolean(csnap.data()?.delisted);

      if(isDelistedNow){
        // 복구 처리
        await setDoc(doc(db,"companySettings",companyId), { delisted:false, updatedAt: Date.now() }, { merge:true });
      }
      // 타이머 문서 제거
      await deleteDoc(doc(db, DELIST_TIMER_COL, companyId));

      // 로컬 맵/화면 갱신
      delistTimersMap.delete(companyId);
      const c = companies.find(x=>x.id===companyId);
      if(c) c.delisted = false;

      window.renderDelistPanel();
      alert(`🟢 ${c?.name||companyId} 자동 복구 완료`);
    }catch(e){
      console.error("자동 복구 실패:", e);
    }
  }

  // 타이머 취소 + 즉시 복구
  window.cancelDelistTimer = async function(companyName){
    if(!ADMIN_MODE) return alert("관리자만 가능합니다.");
    const c = companies.find(x=>x.name===companyName); if(!c) return;
    try{
      await setDoc(doc(db,"companySettings",c.id), { delisted:false, updatedAt: Date.now() }, { merge:true });
      await deleteDoc(doc(db, DELIST_TIMER_COL, c.id));
      delistTimersMap.delete(c.id);
      c.delisted = false;
      window.renderDelistPanel();
      alert(`🟢 ${c.name} 타이머 취소 및 복구 완료`);
    }catch(e){
      console.error(e);
      alert("타이머 취소 실패: " + (e.message||e));
    }
  };

  // 초기 구독 시작 (db가 준비돼 있어야 함)
  try { subscribeDelistTimers(); } catch(e){ console.warn("delistTimers 구독 실패(초기):", e); }

  /* ---------------------------------------------------------
   * ⏱️ 자연스러운 틱(옵션) — 미세 지터 & 모멘텀
   *  - 기존 setInterval 기반을 유지하되, bias 감쇠와 함께
   *    작은 지터(±15%)를 줄 수 있는 도우미 추가 (선택 적용)
   * --------------------------------------------------------- */
  // 필요 시 그래프 탭에서 호출해 쓰세요.
  window.enableTickJitter = function(enable=true){
    // 기존 코드에서 startLocalTimer/stopLocalTimer 를 쓰고 있으므로,
    // 여기서는 updateInterval 에 약간의 지터를 더해주는 헬퍼만 제공.
    // (원 코드의 타이머 흐름을 바꾸지 않음)
    const base = window.__baseInterval || 0;
    if(enable){
      if(!window.__baseInterval) window.__baseInterval = (window.updateInterval||5000);
      const j = Math.max(250, Math.floor(window.__baseInterval * (1 + (Math.random()*0.3 - 0.15))));
      window.updateInterval = j;
    }else{
      if(base > 0) window.updateInterval = base;
    }
  };

  /* ---------------------------------------------------------
   * DOM 이벤트 보조 (상세 탭 이동 시 즉시 UI 갱신)
   * --------------------------------------------------------- */
  // 관리자 탭 변환 함수가 기존에 존재하므로, 동일 id 사용 시 자동 반영됨.
  // 필요 시 다음 이벤트 바인딩:
  (function patchTabButtons(){
    const dtab = document.querySelector('button[onclick="showTab(\'delist\')"]');
    if(dtab){
      dtab.addEventListener('click', ()=> {
        // 타이머/상태 최신화
        window.renderDelistPanel();
      }, { once:false });
    }
    const stok = document.querySelector('button[onclick="showTab(\'stock\')"]');
    if(stok){
      stok.addEventListener('click', ()=> {
        window.renderStockTuner();
      }, { once:false });
    }
  })();
</script>
