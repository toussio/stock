<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>

  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    /* ìƒë‹¨ ì‚¬ìš©ì/ì…ì¶œê¸ˆ */
    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    /* âœ… ì…ê¸ˆ ìš”ì²­ í¼ ì¤‘ì•™ ì •ë ¬ */
    #depositForm {
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin:20px auto; max-width:1100px;
    }
    #depositForm input {
      padding:8px; border-radius:8px; border:1px solid #374151;
      background:#0b1220; color:var(--ink);
    }
    #depositForm .memo { min-width:220px; }

    button { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; }
    button:hover { background:var(--accentH); }

    /* âœ… ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
    #chartWrap {
      position:relative; margin:20px auto; max-width:1100px; height:400px;
      background:#111827; border-radius:10px; overflow:hidden;
    }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    /* ê¸°ì—… ì¹´ë“œ 3ì—´ */
    #companies {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:12px; margin:20px auto; max-width:1100px;
    }
    .company {
      background:var(--card); border-radius:10px; padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .company .info { display:flex; justify-content:space-between; align-items:center; font-weight:600; }
    .company .info small{ color:var(--ink2); font-weight:400 }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"] {
      grid-column:span 2; padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink);
    }

    /* ë¡œê·¸ */
    #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }

    /* ê³µí†µ ì¹´ë“œ/ëª¨ë‹¬/UI */
    .req-card { background:var(--card); border-radius:10px; padding:12px; margin:8px 0;
                display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:10px; text-align:center; width:min(90%,440px); position:relative; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:8px; width:85%; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; }

    /* ê´€ë¦¬ì íŒ¨ë„ ì»¨í…Œì´ë„ˆ */
    .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:10px; border-radius:10px; position:relative;}
    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }

    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } }
  </style>
</head>
<body>
<h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

<div id="userRow">
  <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
  <div>
    <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
    <button id="btnWithdraw">ì¶œê¸ˆ ìš”ì²­</button>
    <button id="btnNews">ğŸ“° ë‰´ìŠ¤ ë³´ê¸°</button>
  </div>
</div>

<!-- ì…ê¸ˆ ìš”ì²­ í¼ -->
<div id="depositForm">
  <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
  <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
  <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
  <button id="btnDeposit">ì…ê¸ˆ ìš”ì²­</button>
</div>

<!-- âœ… ê·¸ë˜í”„ -->
<div id="chartWrap"><canvas id="chart"></canvas></div>

<!-- âœ… ê¸°ì—… ì¹´ë“œ -->
<div id="companies"></div>

<!-- í•˜ë‹¨ ë¡œê·¸ -->
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <h2>ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
    <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
    <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <button class="xbtn" id="closeWithdraw">âœ•</button>
    <h2>ì¶œê¸ˆ ìš”ì²­</h2>
    <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
    <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥"><br>
    <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥"><br>
    <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
    <input type="text" id="withdrawMemo" placeholder="ë©”ëª¨ (ì„ íƒ)"><br>
    <button id="submitWithdraw">ìš”ì²­</button>
  </div>
</div>

<!-- ë‰´ìŠ¤ ëª¨ë‹¬ (ì‚¬ìš©ììš©) -->
<div id="newsModal" class="modal">
  <div class="modal-content">
    <button class="xbtn" id="closeNews">âœ•</button>
    <h2>ğŸ“¢ ìµœì‹  ë‰´ìŠ¤</h2>
    <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
      <p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <button id="btnCloseNewsFooter">ë‹«ê¸°</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
<div id="adminLogin">
  <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
  <button id="btnAdminLogin">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
</div>

<!-- ğŸ‘‘ ê°•ì œ ë¡œê·¸ì•„ì›ƒ íŒ¨ë„ -->
<div id="adminPanelUsers" class="admin-panel">
  <button class="xbtn" data-close="adminPanelUsers">âœ•</button>
  <h3>ğŸ‘‘ ê°•ì œ ë¡œê·¸ì•„ì›ƒ íŒ¨ë„</h3>
  <div id="userList"></div>
</div>

<!-- ğŸ’° ì…ì¶œê¸ˆ ê´€ë¦¬ íŒ¨ë„ -->
<div id="adminPanelFinance" class="admin-panel">
  <button class="xbtn" data-close="adminPanelFinance">âœ•</button>
  <h3>ğŸ’° ì…ì¶œê¸ˆ ìš”ì²­ íŒ¨ë„</h3>
  <h4>ì…ê¸ˆ ìš”ì²­</h4>
  <div id="depositRequests"></div>
  <h4>ì¶œê¸ˆ ìš”ì²­</h4>
  <div id="withdrawRequests"></div>
</div>

<!-- ğŸ“Š ê·¸ë˜í”„/ê¸ˆì•¡ ì œì–´ íŒ¨ë„ -->
<div id="adminPanelGraph" class="admin-panel" style="max-width:800px;">
  <button class="xbtn" data-close="adminPanelGraph">âœ•</button>
  <h3>ğŸ“Š ê·¸ë˜í”„/ê¸ˆì•¡ ì œì–´ íŒ¨ë„</h3>
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
    <button id="btnStartSim">ì‹œì‘</button>
    <button id="btnStopSim">ì •ì§€</button>
    <button id="btnResetGraph">ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
    <label style="margin-left:20px;">ì „ì²´ ì¡°ì • Â±ê¸ˆì•¡</label>
    <input type="number" id="allDelta" value="100" style="width:100px;">
    <button id="btnAdjustAll">ì ìš©</button>
  </div>
  <div style="margin-top:10px;">
    <strong>â±ï¸ ë³€ë™ ì£¼ê¸° (ì´ˆ):</strong>
    <input type="number" id="intervalInput" value="5" min="1" style="width:90px;">
    <button id="btnApplyInterval">ì ìš©</button>
  </div>
  <div style="margin-top:10px;">
    <strong>ğŸ“Š ë³€ë™í­ ë²”ìœ„:</strong>
    <input type="number" id="deltaMaxInput" value="1000000" min="1" style="width:120px;">
    <button id="btnApplyDeltaMax">ì ìš©</button>
  </div>
  <hr style="opacity:.2">
  <h4>ğŸ“ˆ ê°œë³„ ì¢…ëª© ê¸ˆì•¡ ì¡°ì •</h4>
  <div id="graphCompanyAdjust"></div>
  <p style="color:#9ca3af; margin-top:8px;">â€» 'í˜„ì¬ê°€(livePrice)' ì§ì ‘ ì¡°ì •</p>
</div>

<!-- ğŸ›ï¸ ì£¼ê°€ ì¡°ì‘ íŒ¨ë„ -->
<div id="adminPanelStock" class="admin-panel">
  <button class="xbtn" data-close="adminPanelStock">âœ•</button>
  <h3>ğŸ›ï¸ ì£¼ê°€ ì¡°ì‘ íŒ¨ë„</h3>
  <div id="stockTuner"></div>
</div>

<!-- ğŸ“ˆ ë°°ìœ¨/í™•ë¥  ê´€ë¦¬ íŒ¨ë„ -->
<div id="adminPanelChange" class="admin-panel">
  <button class="xbtn" data-close="adminPanelChange">âœ•</button>
  <h3>ğŸ“ˆ ë°°ìœ¨ & í™•ë¥  ê´€ë¦¬ íŒ¨ë„</h3>
  <div class="req-card">
    <div><strong>ì „ì²´ ë°°ìœ¨</strong></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <input type="number" id="allMultiplierVal" step="0.01" value="1.00" style="width:100px;">
      <button id="btnSetAllMultiplier">ì „ì²´ ë°°ìœ¨ ì¼ê´„ ì„¤ì •</button>
    </div>
  </div>
  <div class="req-card">
    <div><strong>ì „ì²´ í™•ë¥ </strong></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <label>ì´ë“%</label><input type="number" id="globalProfit" step="0.01" min="0" max="1" value="0.3" style="width:70px;">
      <label>ì†í•´%</label><input type="number" id="globalLoss" step="0.01" min="0" max="1" value="0.7" style="width:70px;">
      <button id="btnSetAllChances">ì „ì²´ í™•ë¥  ì¼ê´„ ì ìš©</button>
    </div>
    <small style="color:#9ca3af;">í•©ê³„ â‰¤ 1, ë‚˜ë¨¸ì§€ëŠ” ë³€í™” ì—†ìŒ</small>
  </div>
  <div id="changePanel"></div>
</div>

<!-- ğŸ“° ë‰´ìŠ¤ ê´€ë¦¬ íŒ¨ë„ (news123) -->
<div id="adminPanelNews" class="admin-panel">
  <button class="xbtn" data-close="adminPanelNews">âœ•</button>
  <h3>ğŸ“° ë‰´ìŠ¤ ê´€ë¦¬ íŒ¨ë„</h3>
  <textarea id="newsInput" placeholder="ë‰´ìŠ¤ ê¸°ì‚¬ ì‘ì„±..."></textarea>
  <div style="margin-top:10px;text-align:right;">
    <button id="btnAddNews">ë‰´ìŠ¤ ì¶”ê°€</button>
  </div>
  <div id="newsList" style="margin-top:15px;"></div>
</div>

<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PART 1 ë / PART 2ë¶€í„° ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ë¶™ì—¬ì£¼ì„¸ìš” -->
<script>
  // ìµœì†Œ ë™ì‘: ë‰´ìŠ¤ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° (íŒŒíŠ¸2ì—ì„œ ê¸°ëŠ¥ í™•ì¥/êµì²´)
  (function(){
    const $ = (s)=>document.querySelector(s);
    const openNews = ()=>{ $('#newsModal').style.display='flex'; };
    const closeNews = ()=>{ $('#newsModal').style.display='none'; };
    $('#btnNews').addEventListener('click', openNews);
    $('#closeNews').addEventListener('click', closeNews);
    $('#btnCloseNewsFooter').addEventListener('click', closeNews);

    // ì¶œê¸ˆ ëª¨ë‹¬ ë‹¨ìˆœ í‘œì‹œ/ë‹«ê¸° (ìƒì„¸ ë¡œì§ì€ íŒŒíŠ¸2~4ì—ì„œ ëŒ€ì²´)
    const openWithdraw = ()=>{ $('#withdrawModal').style.display='flex'; };
    const closeWithdraw = ()=>{ $('#withdrawModal').style.display='none'; };
    $('#btnWithdraw').addEventListener('click', openWithdraw);
    $('#closeWithdraw').addEventListener('click', closeWithdraw);
  })();
</script>

</body>
</html>

/* =====================================================
 * PART 2 â€” Core JavaScript (Firebase + Session Login + News)
 *  - Firebase ì´ˆê¸°í™”
 *  - ì„¸ì…˜ ê¸°ë°˜ ë¡œê·¸ì¸(ì¤‘ë³µ ë¡œê·¸ì¸ ë°©ì§€)
 *  - ì‚¬ìš©ì ì…/ì¶œê¸ˆ
 *  - ì°¨íŠ¸/ì‹œë®¬ë ˆì´ì…˜
 *  - ê´€ë¦¬ì íŒ¨ë„ (users/finance/graph/stock/change/news)
 *  - ë‰´ìŠ¤ ê´€ë¦¬(news123) + ì‚¬ìš©ì ë‰´ìŠ¤ ëª¨ë‹¬ ì‹¤ì‹œê°„ ë°˜ì˜
 * ===================================================== */

/* =========================
 *  Firebase & Firestore
 * ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
  onSnapshot, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
 *  DOM í—¬í¼ & ìƒíƒœ
 * ========================= */
const $ = (s)=>document.querySelector(s);
const logDiv = $("#log");

// ì‚¬ìš©ì/í˜„ê¸ˆ/ë³´ìœ 
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let unsubscribeUser = null;

// ì°¨íŠ¸ & ì‹œë®¬ë ˆì´ì…˜
let chart = null;
let priceTimer = null;
let updateInterval = 5000;      // ms
let graphUpdateTimer = null;    // onSnapshot ë””ë°”ìš´ìŠ¤ìš©
let deltaMax = 1000000;         // ë³€ë™í­ ìµœëŒ€ì¹˜ (ê´€ë¦¬ì ì„¤ì •)

// ë³´ê°„ íƒ€ì´ë¨¸(ì¢…ëª©ë³„) & êµ¬ë§¤ ìˆ˜ëŸ‰ ìƒíƒœ
const smoothTimers = {};
const qtyState = {};  // { [companyName]: number }

// íšŒì‚¬ ëª©ë¡
const companies = [
  {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:0, multiplier:1, livePrice:0},
  {name:"ì¹´ìŠ¤í‹¸ë¡œ",   basePrice:0, multiplier:1, livePrice:0},
  {name:"ì‚¬ì¿ ë¼",     basePrice:0, multiplier:1, livePrice:0},
  {name:"ì²­ë£¡",       basePrice:0, multiplier:1, livePrice:0},
  {name:"ê²½ì°°ì²­",     basePrice:0, multiplier:1, livePrice:0},
  {name:"Ems",        basePrice:0, multiplier:1, livePrice:0},
  {name:"ì˜¬ë“œë³´ì´",   basePrice:0, multiplier:1, livePrice:0},
  {name:"ì‘ë‘",       basePrice:0, multiplier:1, livePrice:0},
  {name:"ë¹…ë”•",       basePrice:0, multiplier:1, livePrice:0},
  {name:"ìœ í† í”¼ì•„",   basePrice:0, multiplier:1, livePrice:0},
  {name:"inback",     basePrice:0, multiplier:1, livePrice:0},
];

// ì¢…ëª©ë³„ í™•ë¥  (ê¸°ë³¸ 3:7)
const companyChances = {};
companies.forEach(c=>{ companyChances[c.name] = { profit:0.3, loss:0.7 }; });

// ì‹œì¥ ìƒíƒœ(ê±°ë˜ ì˜í–¥) ì¶”ì 
const marketState = { pressure:{}, lastTradeTs:{}, bias:{} };

/* =========================
 *  ìœ í‹¸
 * ========================= */
const ci = s => String(s||'').toLowerCase();
function log(msg){ if(!logDiv) return; logDiv.innerHTML = `<div>${msg}</div>` + logDiv.innerHTML; }
function parseNumber(str){ const n=parseInt(String(str).replace(/[^0-9-]/g,''),10); return isNaN(n)?0:n; }
function safeId(name){ return String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_'); }
function formatHoldings(h){
  if(!h || typeof h!=="object") return 'ë³´ìœ ì—†ìŒ';
  const arr = Object.entries(h).filter(([k,v])=> (v||0)>0).map(([k,v])=>`${k}:${v}ì£¼`);
  return arr.length? arr.join(', ') : 'ë³´ìœ ì—†ìŒ';
}

function findCompanyById(id){ return companies.find(x => ci(x.name)===ci(id)); }

// í‘œì‹œê°€ê²©: multiplier ì€ë°€ ë°˜ì˜
function getDisplayPrice(c){
  const base = (typeof c.livePrice === 'number') ? c.livePrice : c.basePrice;
  if (typeof c.multiplier !== 'number') return Math.max(1, Math.floor(base));
  if (c.multiplier >= 0){
    return Math.max(1, Math.floor(base * (c.multiplier || 1)));
  } else {
    const factor = Math.abs(c.multiplier);
    const lowered = base / (factor || 1);
    return Math.max(1, Math.floor(lowered));
  }
}

function renderUserInfo(){
  const userInfo = $("#userInfo");
  if(currentUser) userInfo.innerHTML = `<strong>${currentUser.name}(${currentUser.id})</strong> | í˜„ê¸ˆ:${player.cash.toLocaleString()} KRW`;
}

function buildCompanyCard(c){
  const companiesDiv = $("#companies");
  const safe = safeId(c.name);
  const held = player.holdings[c.name]||0;
  const nowPrice = getDisplayPrice(c);
  const initQty = (Number.isFinite(qtyState[c.name]) && qtyState[c.name] > 0) ? qtyState[c.name] : 1;
  const div = document.createElement('div');
  div.className = 'company';
  div.id = `card-${safe}`;
  div.innerHTML = `
    <div class="info">
      <strong>${c.name}</strong>
      <span>
        <span id="price-${safe}">${nowPrice.toLocaleString()}</span> KRW
        <small>| ë³´ìœ :<span id="held-${safe}">${held}</span>ì£¼</small>
      </span>
    </div>
    <div class="actions">
      <input type="number" id="qty-${safe}" value="${initQty}" min="1">
      <button data-act="buy" data-name="${c.name}" data-qid="qty-${safe}">ë§¤ìˆ˜</button>
      <button data-act="sell" data-name="${c.name}" data-qid="qty-${safe}">ë§¤ë„</button>
    </div>`;
  companiesDiv.appendChild(div);

  const qtyInput = div.querySelector(`#qty-${safe}`);
  qtyInput.addEventListener('input', (e)=>{
    const v = parseInt(e.target.value, 10);
    qtyState[c.name] = (Number.isFinite(v) && v > 0) ? v : 1;
  });
}

function initCompaniesUI(){
  const companiesDiv = $("#companies");
  companiesDiv.innerHTML = '';
  companies.forEach(buildCompanyCard);

  // ë§¤ìˆ˜/ë§¤ë„ ìœ„ì„
  companiesDiv.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const name = btn.getAttribute('data-name');
    const qid  = btn.getAttribute('data-qid');
    const qty  = parseInt(document.getElementById(qid).value)||1;
    if(btn.dataset.act==='buy') buy(name, qty); else sell(name, qty);
  });
}

function updateCompanyPriceDOM(name){
  const el = document.getElementById(`price-${safeId(name)}`);
  const c = findCompanyById(name);
  if(el && c) el.textContent = getDisplayPrice(c).toLocaleString();
}

function updateCompanyHoldingDOM(name){
  const el = document.getElementById(`held-${safeId(name)}`);
  if(el) el.textContent = (player.holdings[name]||0);
}

/* =========================
 *  ì„œë²„ ë™ê¸°í™”
 * ========================= */
async function syncUserToServer(){
  if(!currentUser) return;
  try{
    await setDoc(doc(db,"users",currentUser.id), { cash: player.cash, holdings: player.holdings }, { merge:true });
  }catch(e){ console.warn("âš ï¸ ì‚¬ìš©ì ë™ê¸°í™” ì‹¤íŒ¨:", e); }
}

/* =========================
 *  ê±°ë˜ ì˜í–¥ ê³µì‹
 * ========================= */
const IMPACT_THRESHOLD = 30;     // 30ì£¼ ì´ìƒë¶€í„° ì˜í–¥
const IMPACT_SCALE = 550;        // âˆšíš¨ê³¼ ìŠ¤ì¼€ì¼
const MAX_TRADE_IMPACT = 0.03;   // 1íšŒ Â±3% ìƒí•œ
const BUY_IMPACT_BIAS = 0.7;     // ë§¤ìˆ˜ ì˜í–¥ ì¶•ì†Œ
const COOLDOWN_MS = 8000;        // ë™ì¼ ì¢…ëª© ì—°ì† ê±°ë˜ ì™„ì¶©
const PRESSURE_DECAY_MS = 30000; // ëˆ„ì  ì••ë ¥ ê°ì‡ 

async function impactPrice(name, qty, type){
  const c = findCompanyById(name);
  if(!c) return;
  const prevPrice = c.livePrice || c.basePrice;

  const effQty = Math.max(0, qty - IMPACT_THRESHOLD);
  if(effQty <= 0){ scheduleGraphUpdate(); return; }

  const now = Date.now();
  const last = marketState.lastTradeTs[name] || 0;
  const msSince = now - last;
  const timeFactor = Math.min(1, msSince / COOLDOWN_MS);
  const decay = Math.exp(-msSince / PRESSURE_DECAY_MS);
  const prevPressure = (marketState.pressure[name] || 0) * decay;
  const signedQty = (type === 'buy' ? 1 : -1) * effQty;
  const newPressure = prevPressure + signedQty;
  marketState.pressure[name] = newPressure;
  marketState.lastTradeTs[name] = now;
  const pressureFactor = 1 / (1 + Math.abs(prevPressure) / 200);

  let ratio = Math.sqrt(effQty) / IMPACT_SCALE;
  ratio *= timeFactor * pressureFactor;
  if(type === 'buy') ratio *= BUY_IMPACT_BIAS; else ratio = -ratio;
  ratio = Math.max(-MAX_TRADE_IMPACT, Math.min(MAX_TRADE_IMPACT, ratio));

  let nextPrice = Math.max(1, Math.round(prevPrice * (1 + ratio)));

  // í™•ë¥  (3:7)
  const chance = companyChances[name] || {profit:0.3, loss:0.7};
  const roll = Math.random();
  if(roll < chance.profit){
    nextPrice = Math.round(nextPrice * (1 + Math.random()*0.01)); // +0~1%
  } else {
    nextPrice = Math.round(nextPrice * (1 - Math.random()*0.02)); // -0~2%
  }

  try{
    await setDoc(doc(db,"companyPrices", name), { current: nextPrice, updatedAt: now }, { merge:true });
    c.livePrice = nextPrice;
    updateCompanyPriceDOM(name);
    scheduleGraphUpdate();
  }catch(e){ console.error("ê°€ê²© ì˜í–¥ ë°˜ì˜ ì‹¤íŒ¨:", e); }

  marketState.bias[name] = (type === 'buy') ? 1 : -1;
}

/* =========================
 *  ë§¤ìˆ˜/ë§¤ë„
 * ========================= */
function buy(name, qty){
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const c = findCompanyById(name); if(!c) return;
  const p = getDisplayPrice(c);
  if(player.cash<p*qty) return alert('í˜„ê¸ˆ ë¶€ì¡±');
  player.cash -= p*qty;
  player.holdings[name] = (player.holdings[name]||0) + qty;
  qtyState[name] = qty;
  syncUserToServer();
  renderUserInfo(); updateCompanyHoldingDOM(name); updateCompanyPriceDOM(name);
  impactPrice(name, qty, 'buy');
}

function sell(name, qty){
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const c = findCompanyById(name); if(!c) return;
  const p = getDisplayPrice(c);
  if((player.holdings[name]||0)<qty) return alert('ë³´ìœ  ë¶€ì¡±');
  player.cash += p*qty;
  player.holdings[name] -= qty;
  qtyState[name] = qty;
  syncUserToServer();
  renderUserInfo(); updateCompanyHoldingDOM(name); updateCompanyPriceDOM(name);
  impactPrice(name, qty, 'sell');
}

/* =========================
 *  ì…/ì¶œê¸ˆ ìš”ì²­
 * ========================= */
async function requestDeposit(){
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const acct=$("#acctNo").value.trim();
  const amount=parseNumber($("#cashAmount").value);
  const memo=$("#cashMemo").value.trim();
  if(!acct||amount<=0) return alert('ì…ë ¥ ì˜¤ë¥˜');
  const req = {
    id:'REQ-'+Date.now(), date:new Date().toLocaleString(),
    userId:currentUser.id, userName:currentUser.name,
    acct, amount, memo, status:'ëŒ€ê¸°', type:'ì…ê¸ˆ'
  };
  try{
    await addDoc(collection(db,'pendingDeposits'),req);
    alert("âœ… ì…ê¸ˆ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }catch(e){ console.warn("âš ï¸ ì…ê¸ˆ DB ì €ì¥ ì‹¤íŒ¨:",e); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); }
}

function openWithdrawModal(){
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  $("#withdrawId").value=currentUser.id;
  $("#withdrawName").value=currentUser.name;
  $("#withdrawAmount").value = '';
  $("#withdrawMemo").value = '';
  $("#withdrawFeeInfo").innerText = '';
  $("#withdrawModal").style.display='flex';
}
function closeWithdrawModal(){ $("#withdrawModal").style.display='none'; }

function updateWithdrawFee(){
  const feeRate = 0.3;
  const amount = parseInt($("#withdrawAmount").value) || 0;
  if(amount > 0){
    const fee = Math.round(amount * feeRate);
    const receive = amount - fee;
    $("#withdrawFeeInfo").innerText =
      `ì¶œê¸ˆ ìš”ì²­ì•¡: ${amount.toLocaleString()}ì› | ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()}ì› | ì‹¤ì œ ìˆ˜ë ¹: ${receive.toLocaleString()}ì›`;
  } else {
    $("#withdrawFeeInfo").innerText = "";
  }
}

async function submitWithdraw(){
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const amount=parseInt($("#withdrawAmount").value)||0;
  const memo=$("#withdrawMemo").value.trim();
  if(amount<=0) return alert('ê¸ˆì•¡ ì˜¤ë¥˜');

  const feeRate = 0.3;
  const fee = Math.round(amount * feeRate);
  const receive = amount - fee;

  if(!confirm(
    `ì¶œê¸ˆ ìš”ì²­ì•¡: ${amount.toLocaleString()}ì›\n`+
    `ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()}ì›\n`+
    `ì‹¤ì œ ìˆ˜ë ¹: ${receive.toLocaleString()}ì›\n\n`+
    `ì´ëŒ€ë¡œ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
  )) return;

  const req = {
    id:'WREQ-'+Date.now(), date:new Date().toLocaleString(),
    userId:currentUser.id, userName:currentUser.name,
    amount: receive, fee, original: amount,
    memo, status:'ëŒ€ê¸°', type:'ì¶œê¸ˆ'
  };
  try{
    await addDoc(collection(db,'pendingWithdrawals'),req);
    alert("âœ… ì¶œê¸ˆ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    closeWithdrawModal();
  }catch(e){ console.warn("âš ï¸ ì¶œê¸ˆ DB ì €ì¥ ì‹¤íŒ¨:",e); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); }
}

/* =========================
 *  ë¡œê·¸ì¸ & ì„¸ì…˜ (ì¤‘ë³µ ë¡œê·¸ì¸ ë°©ì§€)
 * ========================= */
function generateSessionId(){
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
}

function subscribeCurrentUser(uid){
  if(unsubscribeUser){ unsubscribeUser(); unsubscribeUser=null; }
  const uref=doc(db,"users",uid);
  unsubscribeUser = onSnapshot(uref,(snap)=>{
    if(!snap.exists()) return;
    const data=snap.data();

    // ì„¸ì…˜ ë¶ˆì¼ì¹˜ â†’ ìë™ ë¡œê·¸ì•„ì›ƒ
    if(currentUser && data.sessionId !== currentUser.sessionId){
      alert("ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì¸í•˜ì—¬ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
      logout();
      return;
    }
    if(typeof data.cash==='number') player.cash=data.cash;
    if(data.holdings && typeof data.holdings==='object') player.holdings = data.holdings;
    renderUserInfo();
    companies.forEach(c => { updateCompanyHoldingDOM(c.name); updateCompanyPriceDOM(c.name); });
  });
}

async function startLogin(){
  const cid=$("#customId").value.trim();
  const cname=$("#customName").value.trim();
  if(!cid||!cname){ alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  try{
    const userRef=doc(db,"users",cid);
    const snap=await getDoc(userRef);

    if(snap.exists() && snap.data().active){
      alert("ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
      return;
    }

    let nextCash=player.cash; let nextHoldings={};
    if(snap.exists()){
      const d=snap.data();
      if(typeof d.cash==='number') nextCash=d.cash;
      if(d.holdings && typeof d.holdings==='object') nextHoldings=d.holdings;
    }

    const sessionId = generateSessionId();
    currentUser={ id:cid, name:cname, cash:nextCash, active:true, sessionId };
    player.cash=nextCash; player.holdings=nextHoldings;

    await setDoc(userRef,{ ...currentUser, holdings:nextHoldings, lastLogin: serverTimestamp() },{merge:true});
    localStorage.setItem("stockUser",JSON.stringify(currentUser));
    $("#loginModal").style.display='none';
    renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid);
  }catch(e){ console.warn("âš ï¸ Firestore ì˜¤ë¥˜:",e); alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
}

async function logout(){
  if(currentUser){
    try{ await updateDoc(doc(db,"users",currentUser.id),{active:false, sessionId:null}); }
    catch(e){}
  }
  if(unsubscribeUser){ unsubscribeUser(); unsubscribeUser=null; }
  localStorage.removeItem('stockUser');
  location.reload();
}

/* =========================
 *  ê´€ë¦¬ì ì½”ë“œ ë¶„ê¸° (news123 í¬í•¨)
 * ========================= */
function openPanel(id){
  document.querySelectorAll('.admin-panel').forEach(p=>p.style.display='none');
  $("#adminLogin").style.display='none';
  $("#"+id).style.display='block';
}

function checkAdmin(){
  const code=$("#adminCode").value.trim();
  if(code==="SECRET1234"){ openPanel("adminPanelUsers"); subscribeUsers(); }
  else if(code==="ADMIN123"){ openPanel("adminPanelFinance"); subscribeRequests(); }
  else if(code.toLowerCase()==="graph123"){ openPanel("adminPanelGraph"); renderGraphAdjustPanel(); }
  else if(code.toLowerCase()==="stock123"){ openPanel("adminPanelStock"); renderStockTuner(); }
  else if(code.toLowerCase()==="change123"){ openPanel("adminPanelChange"); renderChangePanel(); }
  else if(code.toLowerCase()==="news123"){ openPanel("adminPanelNews"); subscribeNews(); }
  else { alert("ê´€ë¦¬ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
}

function wirePanelClose(){
  document.body.addEventListener('click', (e)=>{
    const btn = e.target.closest('button.xbtn[data-close]');
    if(!btn) return;
    const pid = btn.getAttribute('data-close');
    if(pid){ $("#"+pid).style.display='none'; $("#adminLogin").style.display='block'; }
  });
}

/* =========================
 *  ê´€ë¦¬ì: ìœ ì €(ê°•ì œ ë¡œê·¸ì•„ì›ƒ) + ë³´ìœ ì¢…ëª© í‘œì‹œ
 * ========================= */
function subscribeUsers(){
  onSnapshot(collection(db,"users"),(snap)=>{
    const userList=$("#userList"); let html="";
    snap.forEach(docu=>{
      const u=docu.data();
      const holdingsText = formatHoldings(u.holdings);
      html += `<div class="req-card">
        <div>
          <strong>${u.name}</strong> (${u.id}) |
          í˜„ê¸ˆ: ${(u.cash??0).toLocaleString()} |
          ìƒíƒœ: ${u.active?"ğŸŸ¢ ë¡œê·¸ì¸ì¤‘":"âšª ë¡œê·¸ì•„ì›ƒ"}<br>
          ğŸ“¦ ë³´ìœ ì¢…ëª©: ${holdingsText}
        </div>
        <div><button class="btnForceLogout" data-uid="${u.id}">ê°•ì œ ë¡œê·¸ì•„ì›ƒ</button></div>
      </div>`;
    });
    userList.innerHTML=html||"ë“±ë¡ëœ ìœ ì € ì—†ìŒ";
  });
}

async function forceLogout(userId){
  try{ await updateDoc(doc(db,"users",userId),{active:false, sessionId:null}); }
  catch(e){ console.error("ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:",e); }
}

function wireUserAdminActions(){
  $("#userList").addEventListener('click',(e)=>{
    const btn = e.target.closest('.btnForceLogout');
    if(!btn) return;
    forceLogout(btn.dataset.uid);
  });
}

/* =========================
 *  ê´€ë¦¬ì: ì…/ì¶œê¸ˆ ì‹¤ì‹œê°„ & ìŠ¹ì¸/ê±°ì ˆ
 * ========================= */
function subscribeRequests(){
  const depQ=query(collection(db,"pendingDeposits"),where("status","==","ëŒ€ê¸°"));
  onSnapshot(depQ,(snap)=>{
    const depDiv=$("#depositRequests"); let html="";
    snap.forEach(docu=>{
      const d=docu.data();
      html += `<div class="req-card" data-rid="${docu.id}">
        <div><strong>${d.userName}</strong> (${d.userId}) | ${Number(d.amount||0).toLocaleString()}ì› | ë©”ëª¨: ${d.memo||""}</div>
        <div>
          <button class="btnApproveDep" data-rid="${docu.id}" data-uid="${d.userId}" data-amt="${Number(d.amount||0)}">ìŠ¹ì¸</button>
          <button class="btnRejectDep" data-rid="${docu.id}">ê±°ì ˆ</button>
        </div>
      </div>`;
    });
    depDiv.innerHTML = html || "ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ";
  });

  const witQ=query(collection(db,"pendingWithdrawals"),where("status","==","ëŒ€ê¸°"));
  onSnapshot(witQ,(snap)=>{
    const witDiv=$("#withdrawRequests"); let html="";
    snap.forEach(docu=>{
      const w=docu.data();
      const net = Number(w.amount||0);
      const fee = (typeof w.fee==='number') ? Number(w.fee) : 0;
      const original = (typeof w.original==='number') ? Number(w.original) : (net + fee);
      html += `<div class="req-card">
        <div>
          <strong>${w.userName}</strong> (${w.userId}) |
          ì›ìš”ì²­: ${original.toLocaleString()}ì› |
          ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()}ì› |
          ì‹¤ì œ ìˆ˜ë ¹: ${net.toLocaleString()}ì›
          ${w.memo?`| ë©”ëª¨: ${w.memo}`:""}
        </div>
        <div>
          <button class="btnApproveWit" data-rid="${docu.id}">ìŠ¹ì¸</button>
          <button class="btnRejectWit" data-rid="${docu.id}">ê±°ì ˆ</button>
        </div>
      </div>`;
    });
    witDiv.innerHTML = html || "ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ";
  });
}

async function approveDeposit(reqId,userId,amount){
  try{
    const uref=doc(db,"users",userId); const usnap=await getDoc(uref);
    const prev=usnap.exists()?(usnap.data().cash||0):0; const updated=prev+Number(amount||0);
    await setDoc(uref,{cash:updated},{merge:true});
    await updateDoc(doc(db,"pendingDeposits",reqId),{status:"ìŠ¹ì¸"});
    if(currentUser?.id===userId){ player.cash=updated; renderUserInfo(); }
  }catch(e){ console.error("ì…ê¸ˆ ìŠ¹ì¸ ì‹¤íŒ¨:",e); }
}

async function approveWithdraw(reqId){
  try{
    const wref = doc(db,"pendingWithdrawals",reqId);
    const wsnap = await getDoc(wref);
    if(!wsnap.exists()){ alert("ìš”ì²­ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    const w = wsnap.data();
    const userId = w.userId;
    const net = Number(w.amount||0);
    const fee = (typeof w.fee==='number') ? Number(w.fee) : 0;
    const original = (typeof w.original==='number') ? Number(w.original) : (net + fee);

    const uref=doc(db,"users",userId);
    const usnap=await getDoc(uref);
    const prev=usnap.exists()?(usnap.data().cash||0):0;
    const updated=prev - original;
    if(updated<0){ alert("í˜„ê¸ˆ ë¶€ì¡±ìœ¼ë¡œ ìŠ¹ì¸ ë¶ˆê°€"); return; }

    await setDoc(uref,{cash:updated},{merge:true});
    await updateDoc(wref,{status:"ìŠ¹ì¸"});
    if(currentUser?.id===userId){ player.cash=updated; renderUserInfo(); }
  }catch(e){ console.error("ì¶œê¸ˆ ìŠ¹ì¸ ì‹¤íŒ¨:",e); }
}

async function rejectRequest(col,reqId){
  try{ await updateDoc(doc(db,col,reqId),{status:"ê±°ì ˆ"}); }
  catch(e){ console.error("ê±°ì ˆ ì‹¤íŒ¨:",e); }
}

function wireFinanceActions(){
  $("#depositRequests").addEventListener('click',(e)=>{
    const a = e.target.closest('.btnApproveDep');
    const r = e.target.closest('.btnRejectDep');
    if(a){ approveDeposit(a.dataset.rid, a.dataset.uid, Number(a.dataset.amt||0)); }
    if(r){ rejectRequest('pendingDeposits', r.dataset.rid); }
  });
  $("#withdrawRequests").addEventListener('click',(e)=>{
    const a = e.target.closest('.btnApproveWit');
    const r = e.target.closest('.btnRejectWit');
    if(a){ approveWithdraw(a.dataset.rid); }
    if(r){ rejectRequest('pendingWithdrawals', r.dataset.rid); }
  });
}

/* =========================
 *  ë°°ìœ¨ & í™•ë¥  íŒ¨ë„ (change123)
 * ========================= */
function renderChangePanel(){
  const wrap=$("#changePanel"); let html='';
  companies.forEach(c=>{
    const profit=(companyChances[c.name]?.profit ?? 0.3);
    const loss=(companyChances[c.name]?.loss ?? 0.7);
    html += `
      <div class="req-card">
        <div><strong>${c.name}</strong> | í˜„ì¬ ë°°ìœ¨: x${(c.multiplier??1).toFixed(2)}</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input type="number" class="mulVal" data-name="${c.name}" value="${c.multiplier??1}" step="0.01" style="width:120px;">
          <button class="btnMulApply" data-name="${c.name}">ë°°ìœ¨ ì ìš©</button>
          <button class="btnMulBump" data-name="${c.name}" data-factor="1.1">+10%</button>
          <button class="btnMulBump" data-name="${c.name}" data-factor="0.9">-10%</button>
        </div>
        <div style="display:flex; gap:6px; align-items:center; margin-top:6px; flex-wrap:wrap;">
          <label>ì´ë“%</label>
          <input type="number" class="chanceProfit" data-name="${c.name}" step="0.01" min="0" max="1" value="${profit}" style="width:70px;">
          <label>ì†í•´%</label>
          <input type="number" class="chanceLoss" data-name="${c.name}" step="0.01" min="0" max="1" value="${loss}" style="width:70px;">
          <button class="btnChanceApply" data-name="${c.name}">í™•ë¥  ì ìš©</button>
        </div>
      </div>`;
  });
  wrap.innerHTML = html || "íšŒì‚¬ ë°ì´í„° ì—†ìŒ";
}

async function applyMultiplier(name, val){
  const multiplier = parseFloat(val);
  if(isNaN(multiplier)){ alert('ë°°ìœ¨ ê°’ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
  const c=findCompanyById(name); if(!c) return;
  try{
    await setDoc(doc(db,'companySettings', name), { multiplier, updatedAt: Date.now() }, { merge:true });
    c.multiplier=multiplier;
    updateCompanyPriceDOM(name);
    scheduleGraphUpdate();
  }catch(e){ console.error('ë°°ìœ¨ ì €ì¥ ì‹¤íŒ¨:',e); }
}

async function bumpCompany(name, factor){
  const c=findCompanyById(name); if(!c) return;
  const newMultiplier=parseFloat(((c.multiplier??1)*factor).toFixed(4));
  try{
    await setDoc(doc(db,'companySettings', name), { multiplier:newMultiplier, updatedAt: Date.now() }, { merge:true });
    c.multiplier=newMultiplier;
    updateCompanyPriceDOM(name);
    scheduleGraphUpdate();
  }catch(e){ console.error('ë°°ìœ¨ ë³€ê²½ ì‹¤íŒ¨:',e); }
}

async function setAllMultipliers(val){
  const v = parseFloat(val);
  if(isNaN(v)){ alert("ë°°ìœ¨ ê°’ì„ í™•ì¸í•˜ì„¸ìš”."); return; }
  for(const c of companies){
    await setDoc(doc(db,'companySettings', c.name), { multiplier:v, updatedAt: Date.now() }, { merge:true });
    c.multiplier = v;
  }
  companies.forEach(c => updateCompanyPriceDOM(c.name));
  scheduleGraphUpdate();
}

async function applyCompanyChance(name, gp, gl){
  const profit = parseFloat(gp); const loss = parseFloat(gl);
  if(isNaN(profit)||isNaN(loss)||profit<0||loss<0||(profit+loss)>1){ alert("ì´ë“/ì†í•´ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. (0~1, í•©ê³„â‰¤1)"); return; }
  await setDoc(doc(db,'companyChances', name), { profit, loss, updatedAt: Date.now() }, { merge:true });
  companyChances[name] = { profit, loss };
  alert(`âœ… ${name} í™•ë¥ ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

async function setAllChances(gp, gl){
  const profit = parseFloat(gp); const loss = parseFloat(gl);
  if(isNaN(profit)||isNaN(loss)||profit<0||loss<0||(profit+loss)>1){ alert("ì´ë“/ì†í•´ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. (0~1, í•©ê³„â‰¤1)"); return; }
  for (const c of companies){
    await setDoc(doc(db,'companyChances', c.name), { profit, loss, updatedAt: Date.now() }, { merge:true });
    companyChances[c.name] = { profit, loss };
  }
  alert("âœ… ì „ì²´ í™•ë¥ ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
  renderChangePanel();
}

function subscribeCompanySettings(){
  onSnapshot(collection(db,'companySettings'), (snap)=>{
    let changed=false;
    snap.forEach(d=>{
      const data=d.data();
      const c=findCompanyById(d.id);
      if(!c) return;
      if(typeof data.multiplier==='number') { c.multiplier=data.multiplier; changed=true; }
    });
    if(changed){ companies.forEach(c => updateCompanyPriceDOM(c.name)); scheduleGraphUpdate(); }
  });
}

function subscribeCompanyChances(){
  onSnapshot(collection(db,'companyChances'), (snap)=>{
    snap.forEach(docu=>{
      const data = docu.data();
      if(typeof data.profit==='number' && typeof data.loss==='number'){
        companyChances[docu.id] = { profit:data.profit, loss:data.loss };
      }
    });
    const panel = $("#adminPanelChange");
    if(panel && panel.style.display==="block"){ renderChangePanel(); }
  });
}

/* =========================
 *  ì¤‘ì•™ ì‹œì„¸ êµ¬ë…
 * ========================= */
function subscribeCompanyPrices(){
  onSnapshot(collection(db,"companyPrices"), (snap)=>{
    let any=false;
    snap.forEach(docu=>{
      const data=docu.data();
      const c=findCompanyById(docu.id);
      if(c && typeof data.current==='number'){ c.livePrice=data.current; any=true; }
    });
    if(any){ companies.forEach(c => updateCompanyPriceDOM(c.name)); scheduleGraphUpdate(); }
  });
}

/* =========================
 *  ê·¸ë˜í”„(Chart.js)
 * ========================= */
function initChart(){
  if(chart) return;
  const ctx=document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type:"line",
    data:{ labels:[], datasets: companies.map(c=>({ label:c.name, data:[], borderWidth:2, fill:false, tension:0.25 })) },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{position:"bottom"} },
      scales:{
        x:{ title:{display:true, text:"ì‹œê°„"} },
        y:{ title:{display:true, text:"ê°€ê²© (KRW)"}, beginAtZero:false }
      }
    }
  });
}

function appendChartPoint(){
  if(!chart) return;
  const now=new Date().toLocaleTimeString();
  chart.data.labels.push(now);
  companies.forEach((c,i)=>{ chart.data.datasets[i].data.push(getDisplayPrice(c)); });
  const MAX=120;
  if(chart.data.labels.length>MAX){
    chart.data.labels.splice(0, chart.data.labels.length-MAX);
    chart.data.datasets.forEach(d=>{ if(d.data.length>MAX) d.data.splice(0, d.data.length-MAX); });
  }
  chart.update("none");
}

function scheduleGraphUpdate(){
  if(graphUpdateTimer){ clearTimeout(graphUpdateTimer); }
  graphUpdateTimer=setTimeout(()=>{ appendChartPoint(); graphUpdateTimer=null; }, 200);
}

/* =========================
 *  ì‹œì„¸ ì‹œë®¬ë ˆì´ì…˜ (í¸í–¥)
 * ========================= */
async function updatePrices(){
  for(const c of companies){
    const prev = c.livePrice || c.basePrice;
    const chance = companyChances[c.name] || {profit:0.3, loss:0.7};

    let isUp = Math.random() < chance.profit;
    const b = marketState.bias[c.name] || 0;
    if(b === 1) isUp = false;      // ì§ì „ ë§¤ìˆ˜ â†’ í•˜ë½ í™•ë¥ â†‘
    if(b === -1) isUp = true;      // ì§ì „ ë§¤ë„ â†’ ë°˜ë“± í™•ë¥ â†‘
    marketState.bias[c.name] = b * 0.5; // ì„œì„œíˆ ì†Œê±°
    if(Math.random() < 0.15) isUp = !isUp; // ê°€ë” ë°˜ì „

    let amp = (Math.random() * 0.5 + 0.1) / 100; // 0.1%~0.6%
    if(isUp) amp *= 0.8; else amp *= -1.2;       // ìƒìŠ¹ ì‘ê²Œ / í•˜ë½ í¬ê²Œ

    const ratio = Math.max(-MAX_TRADE_IMPACT, Math.min(MAX_TRADE_IMPACT, amp));
    const next = Math.max(1, Math.round(prev * (1 + ratio)));

    try{
      await setDoc(doc(db,"companyPrices", c.name), { current: next, updatedAt: Date.now() }, { merge:true });
      c.livePrice = next;
      updateCompanyPriceDOM(c.name);
    }catch(e){ console.error("ì‹œë®¬ë ˆì´ì…˜ ë°˜ì˜ ì‹¤íŒ¨:", e); }
  }
  scheduleGraphUpdate();
}

/* =========================
 *  ê·¸ë˜í”„ ì‹œë®¬ë ˆì´ì…˜ & ê¸ˆì•¡ ì¡°ì • (graph123)
 * ========================= */
function startPriceSimulation(){ if(priceTimer) return; priceTimer=setInterval(updatePrices, updateInterval); }
function stopPriceSimulation(){ if(priceTimer){ clearInterval(priceTimer); priceTimer=null; } }

async function resetGraph(){
  for(const c of companies){
    c.livePrice=c.basePrice;
    await setDoc(doc(db,"companyPrices", c.name), { current: c.basePrice, updatedAt: Date.now() }, { merge:true });
  }
  if(chart){ chart.data.labels = []; chart.data.datasets.forEach(d=> d.data = []); chart.update(); }
  companies.forEach(c => updateCompanyPriceDOM(c.name));
}

function applyGraphInterval(val){
  const sec = parseInt(val)||5;
  updateInterval = Math.max(1, sec) * 1000;
  if(priceTimer){ clearInterval(priceTimer); priceTimer = setInterval(updatePrices, updateInterval); }
}

function renderGraphAdjustPanel(){
  const wrap=$("#graphCompanyAdjust"); let html="";
  companies.forEach(c=>{
    html += `
      <div class="req-card">
        <div><strong>${c.name}</strong> | í˜„ì¬ê°€: <span class="panel-price" data-name="${c.name}">${getDisplayPrice(c).toLocaleString()}</span> KRW</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="number" class="adjVal" data-name="${c.name}" placeholder="Â±ê¸ˆì•¡" style="width:100px;">
          <button class="btnAdjApply" data-name="${c.name}">ì ìš©</button>
        </div>
      </div>`;
  });
  wrap.innerHTML=html || "íšŒì‚¬ ë°ì´í„° ì—†ìŒ";
}

async function adjustCompanyPrice(name, delta){
  const c=findCompanyById(name); if(!c) return;
  const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
  await setDoc(doc(db,"companyPrices", name), { current:newVal, updatedAt: Date.now() }, { merge:true });
  c.livePrice=newVal; updateCompanyPriceDOM(name);
  const p = document.querySelector(`.panel-price[data-name="${name}"]`); if(p) p.textContent=getDisplayPrice(c).toLocaleString();
  scheduleGraphUpdate();
}

async function adjustAllPrices(delta){
  for(const c of companies){
    const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
    await setDoc(doc(db,"companyPrices", c.name), { current:newVal, updatedAt: Date.now() }, { merge:true });
    c.livePrice=newVal; updateCompanyPriceDOM(c.name);
    const p = document.querySelector(`.panel-price[data-name="${c.name}"]`); if(p) p.textContent=getDisplayPrice(c).toLocaleString();
  }
  scheduleGraphUpdate();
}

function applyDeltaMax(val){ deltaMax = Math.max(1, parseInt(val)||1); }

/* =========================
 *  ğŸ›ï¸ ì£¼ê°€ ì¡°ì‘ (stock123): ë‹¨ìˆœ/ë³µí•©/ìë™
 * ========================= */
function clearSmoothTimer(name){ if(smoothTimers[name]){ clearInterval(smoothTimers[name]); delete smoothTimers[name]; } }

function smoothAdjust(c, targetPrice, steps=10){
  clearSmoothTimer(c.name);
  const start = c.livePrice || c.basePrice;
  const diff = targetPrice - start;
  let count = 0;
  const step = diff / steps;

  smoothTimers[c.name] = setInterval(async ()=>{
    count++;
    c.livePrice = Math.max(1, Math.round(start + step*count));
    await setDoc(doc(db,"companyPrices", c.name), { current:c.livePrice, updatedAt: Date.now() }, { merge:true });
    updateCompanyPriceDOM(c.name);
    scheduleGraphUpdate();
    if(count >= steps) clearSmoothTimer(c.name);
  }, updateInterval);
}

function renderStockTuner(){
  const wrap=$("#stockTuner"); let html="";
  companies.forEach(c=>{
    html += `
      <div class="req-card">
        <div><strong>${c.name}</strong> | í˜„ì¬ê°€: <span class="tuner-price" data-name="${c.name}">${getDisplayPrice(c).toLocaleString()}</span> KRW</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>ëª©í‘œê¸ˆì•¡</label>
          <input type="number" class="targetVal" data-name="${c.name}" placeholder="ì˜ˆ: 1500" style="width:100px;">
          <label>í‹±</label>
          <input type="number" class="targetSteps" data-name="${c.name}" value="10" min="1" style="width:80px;">
          <button class="btnSimpleMove" data-name="${c.name}">ë‹¨ìˆœ ì´ë™</button>
        </div>
        <div style="margin-top:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>ì¤‘ê°„</label><input type="number" class="midVal" data-name="${c.name}" placeholder="ì¤‘ê°„ ëª©í‘œ" style="width:100px;">
          <label>ìµœì¢…</label><input type="number" class="finVal" data-name="${c.name}" placeholder="ìµœì¢… ëª©í‘œ" style="width:100px;">
          <label>í‹±</label><input type="number" class="comboSteps" data-name="${c.name}" value="20" min="2" style="width:80px;">
          <button class="btnRiseFall" data-name="${c.name}">ğŸ­ ìƒìŠ¹â†’í•˜ë½</button>
          <button class="btnFallRise" data-name="${c.name}">ğŸ”„ í•˜ë½â†’íšŒë³µ</button>
          <button class="btnAutoScenario" data-name="${c.name}">ğŸ¤– ìë™</button>
        </div>
      </div>`;
  });
  wrap.innerHTML = html || "íšŒì‚¬ ë°ì´í„° ì—†ìŒ";
}
      
function splitStepsByDistance(current, mid, fin, stepsTotal){
  const totalDist = Math.max(1, Math.abs(fin - current));
  const firstDist = Math.abs(mid - current);
  const firstSteps = Math.max(1, Math.floor(stepsTotal * (firstDist/totalDist)));
  const secondSteps = Math.max(1, stepsTotal - firstSteps);
  return [firstSteps, secondSteps];
}

function applyStockTarget(name){
  const c = findCompanyById(name); if(!c) return;
  const val = parseInt(document.querySelector(`.targetVal[data-name="${name}"]`).value)||0;
  const steps = parseInt(document.querySelector(`.targetSteps[data-name="${name}"]`).value)||10;
  if(val<=0){ alert("ëª©í‘œ ê¸ˆì•¡ ì˜¤ë¥˜"); return; }
  smoothAdjust(c, val, steps);
}

function applyScenario(name, mode){
  const c = findCompanyById(name); if(!c) return;
  const mid = parseInt(document.querySelector(`.midVal[data-name="${name}"]`).value) || 0;
  const fin = parseInt(document.querySelector(`.finVal[data-name="${name}"]`).value) || 0;
  const steps = parseInt(document.querySelector(`.comboSteps[data-name="${name}"]`).value) || 20;
  if(mid<=0 || fin<=0 || steps<2){ alert("ì…ë ¥ ì˜¤ë¥˜"); return; }

  const current = c.livePrice || c.basePrice;
  const [firstSteps, secondSteps] = splitStepsByDistance(current, mid, fin, steps);

  smoothAdjust(c, mid, firstSteps);
  setTimeout(()=> smoothAdjust(c, fin, secondSteps), firstSteps*updateInterval);
}

function applyAutoScenario(name){
  const c = findCompanyById(name); if(!c) return;
  const steps = parseInt(document.querySelector(`.comboSteps[data-name="${name}"]`).value) || 20;
  const dataset = chart?.data?.datasets?.find(d=>d.label===name);
  const len = dataset?.data?.length ?? 0;
  const recent = len ? dataset.data.slice(Math.max(0,len-5)) : [];
  const slope = (recent.length>=2)? (recent[recent.length-1]-recent[0]) : 0;
  const mode = slope >= 0 ? "riseFall" : "fallRise";

  const current = c.livePrice || c.basePrice;
  const mid = mode==="riseFall" ? Math.round(current*1.05) : Math.round(current*0.95);
  const fin = mode==="riseFall" ? Math.round(current*0.85) : Math.round(current*1.15);

  const [firstSteps, secondSteps] = splitStepsByDistance(current, mid, fin, steps);
  smoothAdjust(c, mid, firstSteps);
  setTimeout(()=> smoothAdjust(c, fin, secondSteps), firstSteps*updateInterval);
}

function wireStockTunerActions(){
  const wrap=$("#stockTuner");
  wrap.addEventListener('click',(e)=>{
    const s = e.target.closest('.btnSimpleMove');
    const rf = e.target.closest('.btnRiseFall');
    const fr = e.target.closest('.btnFallRise');
    const au = e.target.closest('.btnAutoScenario');
    if(s) applyStockTarget(s.dataset.name);
    if(rf) applyScenario(rf.dataset.name, 'riseFall');
    if(fr) applyScenario(fr.dataset.name, 'fallRise');
    if(au) applyAutoScenario(au.dataset.name);
  });
}

/* =========================
 *  ë‰´ìŠ¤ ê´€ë¦¬ (news123) + ì‚¬ìš©ì ë‰´ìŠ¤ ëª¨ë‹¬
 * ========================= */
async function addNewsAdmin(){
  const text=$("#newsInput").value.trim();
  if(!text) return alert("ë‰´ìŠ¤ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  try{
    await addDoc(collection(db,"news"),{ text, createdAt: serverTimestamp() });
    $("#newsInput").value="";
    alert("âœ… ë‰´ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }catch(e){ console.error("ë‰´ìŠ¤ ì €ì¥ ì‹¤íŒ¨:",e); }
}

function subscribeNews(){
  onSnapshot(collection(db,"news"),(snap)=>{
    const list=$("#newsList");
    const content=$("#newsContent");
    let html=""; let userHtml="";
    const items = [];
    snap.forEach(docu=>{ items.push({id:docu.id, ...docu.data()}); });
    // createdAt ê¸°ì¤€ ìµœì‹ ìˆœ (ì„œë²„íƒ€ì„ìŠ¤íƒ¬í”„ê°€ nullì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì•ˆì „ì •ë ¬)
    items.sort((a,b)=>{
      const at = a.createdAt?.toMillis?.() ?? 0;
      const bt = b.createdAt?.toMillis?.() ?? 0;
      return bt - at;
    });
    for(const d of items){
      const time=d.createdAt?.toDate?.().toLocaleString?.()||"";
      html += `<div class="req-card">ğŸ“° ${time} - ${d.text}</div>`;
      userHtml += `<p>ğŸ“° ${time} - ${d.text}</p>`;
    }
    list.innerHTML=html||"ë“±ë¡ëœ ë‰´ìŠ¤ ì—†ìŒ";
    content.innerHTML=userHtml||"<p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  });
}

/* =========================
 *  ì´ˆê¸° êµ¬ë…/ì´ë²¤íŠ¸ ë°”ì¸ë”©
 * ========================= */
function bindTopButtons(){
  $("#btnLogout").addEventListener('click', logout);
  $("#btnWithdraw").addEventListener('click', openWithdrawModal);
  $("#btnNews").addEventListener('click', ()=>{ $("#newsModal").style.display='flex'; });
  $("#btnDeposit").addEventListener('click', requestDeposit);
}

function bindModals(){
  $("#closeWithdraw").addEventListener('click', closeWithdrawModal);
  $("#withdrawAmount").addEventListener('input', updateWithdrawFee);
  $("#submitWithdraw").addEventListener('click', submitWithdraw);

  const closeNews = ()=>{ $("#newsModal").style.display='none'; };
  $("#closeNews").addEventListener('click', closeNews);
  $("#btnCloseNewsFooter").addEventListener('click', closeNews);
}

function bindAdminLogin(){
  $("#btnAdminLogin").addEventListener('click', checkAdmin);
  wirePanelClose();

  // change123 íŒ¨ë„ì˜ ê³µìš© ë²„íŠ¼ë“¤
  $("#btnSetAllMultiplier").addEventListener('click', ()=>{
    setAllMultipliers($("#allMultiplierVal").value);
  });
  $("#btnSetAllChances").addEventListener('click', ()=>{
    setAllChances($("#globalProfit").value, $("#globalLoss").value);
  });

  // graph123 íŒ¨ë„ ë²„íŠ¼ë“¤
  $("#btnStartSim").addEventListener('click', startPriceSimulation);
  $("#btnStopSim").addEventListener('click', stopPriceSimulation);
  $("#btnResetGraph").addEventListener('click', resetGraph);
  $("#btnAdjustAll").addEventListener('click', ()=>{
    const delta=parseInt($("#allDelta").value)||0; adjustAllPrices(delta);
  });
  $("#btnApplyInterval").addEventListener('click', ()=>{
    applyGraphInterval($("#intervalInput").value);
  });
  $("#btnApplyDeltaMax").addEventListener('click', ()=>{
    applyDeltaMax($("#deltaMaxInput").value);
  });

  // news123 ë²„íŠ¼
  $("#btnAddNews").addEventListener('click', addNewsAdmin);

  // íŒ¨ë„ ë‚´ë¶€ ìœ„ì„(ë°°ìœ¨/í™•ë¥ /ê·¸ë˜í”„ì¡°ì •/ì£¼ê°€ì¡°ì‘)
  $("#changePanel").addEventListener('click',(e)=>{
    const mulApply = e.target.closest('.btnMulApply');
    const bump = e.target.closest('.btnMulBump');
    const chApply = e.target.closest('.btnChanceApply');
    if(mulApply){
      const name = mulApply.dataset.name;
      const val = document.querySelector(`input.mulVal[data-name="${name}"]`).value;
      applyMultiplier(name, val);
    }
    if(bump){ bumpCompany(bump.dataset.name, parseFloat(bump.dataset.factor)); }
    if(chApply){
      const name = chApply.dataset.name;
      const gp = document.querySelector(`input.chanceProfit[data-name="${name}"]`).value;
      const gl = document.querySelector(`input.chanceLoss[data-name="${name}"]`).value;
      applyCompanyChance(name, gp, gl);
    }
  });

  $("#graphCompanyAdjust").addEventListener('click',(e)=>{
    const a = e.target.closest('.btnAdjApply');
    if(a){
      const name = a.dataset.name;
      const val = parseInt(document.querySelector(`input.adjVal[data-name="${name}"]`).value)||0;
      adjustCompanyPrice(name, val);
    }
  });

  wireStockTunerActions();
}

function bindLogin(){
  $("#startBtn").addEventListener('click', startLogin);
}

function restoreSessionOrPrompt(){
  const saved=localStorage.getItem('stockUser');
  if(saved){
    try{ currentUser=JSON.parse(saved);}catch(e){ localStorage.removeItem('stockUser'); }
  }
  if(currentUser){
    $("#loginModal").style.display='none';
    renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(currentUser.id);
  } else {
    $("#loginModal").style.display='flex';
  }
}

function refreshAllPanelPrices(){
  companies.forEach(c=>{
    const p1 = document.querySelector(`.panel-price[data-name="${c.name}"]`);
    if(p1) p1.textContent = getDisplayPrice(c).toLocaleString();
    const p2 = document.querySelector(`.tuner-price[data-name="${c.name}"]`);
    if(p2) p2.textContent = getDisplayPrice(c).toLocaleString();
  });
}

/* =========================
 *  ì´ˆê¸°í™”
 * ========================= */
function boot(){
  // UI ë°”ì¸ë”©
  bindTopButtons();
  bindModals();
  bindAdminLogin();
  bindLogin();
  wireFinanceActions();
  wireUserAdminActions();

  // ì°¨íŠ¸ ë° êµ¬ë…
  initChart();
  subscribeCompanyPrices();
  subscribeCompanySettings();
  subscribeCompanyChances();
  subscribeNews();

  // ì„¸ì…˜ ë³µì› ë˜ëŠ” ë¡œê·¸ì¸ ëª¨ë‹¬
  restoreSessionOrPrompt();

  // ë³´ì¡°: íŒ¨ë„ ê°€ê²© ìˆ˜ë™ ë¦¬í”„ë ˆì‹œê°€ í•„ìš”í•  ë•Œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ë…¸ì¶œ
  window.refreshAllPanelPrices = refreshAllPanelPrices;
}

// DOMContentLoaded ì´í›„ ë¶€íŠ¸
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', boot);
}else{ boot(); }

/* =====================================================
 * PART 3 â€” Simulation + Admin Advanced Logic
 *  - ê³ ê¸‰ ì‹œì„¸ ì‹œë®¬ë ˆì´ì…˜
 *  - ê´€ë¦¬ì ê³ ê¸‰ ê¸°ëŠ¥ë“¤
 *  - ê·¸ë˜í”„/ë°°ìœ¨/í™•ë¥  ê´€ë¦¬ ìµœì í™”
 *  - ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (íƒ€ì´ë¨¸/ì„¸ì…˜/ì´ë²¤íŠ¸)
 * ===================================================== */

/* =========================
 *  ê³ ê¸‰ ì‹œì„¸ ì‹œë®¬ë ˆì´ì…˜
 * ========================= */
function weightedRandom(min, max, weightUp=0.3){
  // ìƒìŠ¹/í•˜ë½ ê°€ì¤‘ì¹˜ ì ìš©
  const r = Math.random();
  if(r < weightUp){
    return Math.floor(Math.random()*(max-min+1)+min); // ìƒìŠ¹í­
  } else {
    return -Math.floor(Math.random()*(max-min+1)+min); // í•˜ë½í­
  }
}

async function advancedSimulationStep(){
  for(const c of companies){
    const prev = c.livePrice || c.basePrice;
    const chance = companyChances[c.name] || {profit:0.3, loss:0.7};
    const delta = weightedRandom(1, Math.floor(deltaMax*0.05), chance.profit);
    const next = Math.max(1, prev + delta);
    try{
      await setDoc(doc(db,"companyPrices", c.name), { current: next, updatedAt: Date.now() }, { merge:true });
      c.livePrice = next;
      updateCompanyPriceDOM(c.name);
    }catch(e){ console.error("ê³ ê¸‰ ì‹œë®¬ë ˆì´ì…˜ ë°˜ì˜ ì‹¤íŒ¨:", e); }
  }
  scheduleGraphUpdate();
}

let advSimTimer = null;
function startAdvancedSim(){
  if(advSimTimer) return;
  advSimTimer = setInterval(advancedSimulationStep, updateInterval);
  log("âš¡ ê³ ê¸‰ ì‹œì„¸ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘");
}
function stopAdvancedSim(){
  if(advSimTimer){ clearInterval(advSimTimer); advSimTimer=null; log("âš¡ ê³ ê¸‰ ì‹œì„¸ ì‹œë®¬ë ˆì´ì…˜ ì •ì§€"); }
}

/* =========================
 *  ê´€ë¦¬ì: ë‰´ìŠ¤ í¸ì§‘/ì‚­ì œ
 * ========================= */
async function deleteNews(id){
  try{
    await updateDoc(doc(db,"news",id),{deleted:true});
  }catch(e){ console.error("ë‰´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨",e); }
}

function wireNewsAdmin(){
  const list = document.querySelector("#newsList");
  if(!list) return;
  list.addEventListener('click',(e)=>{
    const btn = e.target.closest('.btnDeleteNews');
    if(btn){ deleteNews(btn.dataset.id); }
  });
}

/* =========================
 *  ê´€ë¦¬ì: ì„¸ì…˜/ë³´ì•ˆ ê´€ë¦¬
 * ========================= */
function clearAllSessions(){
  // ì „ì²´ ì‚¬ìš©ì ê°•ì œ ë¡œê·¸ì•„ì›ƒ
  onSnapshot(collection(db,"users"),(snap)=>{
    snap.forEach(async(docu)=>{
      try{ await updateDoc(doc(db,"users",docu.id),{active:false, sessionId:null}); }
      catch(e){ console.warn("ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨",e); }
    });
  });
  log("âš ï¸ ì „ì²´ ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤í–‰");
}

/* =========================
 *  ê´€ë¦¬ì: UI ìƒíƒœ í‘œì‹œ
 * ========================= */
function markActivePanel(panelId){
  document.querySelectorAll('.admin-panel').forEach(p=>{
    if(p.id===panelId){ p.classList.add('active'); }
    else{ p.classList.remove('active'); }
  });
}

/* =========================
 *  ê·¸ë˜í”„/íŒ¨ë„ Refresh ê°œì„ 
 * ========================= */
function autoRefreshPanels(){
  refreshAllPanelPrices();
  if(document.querySelector("#adminPanelChange").style.display==="block"){ renderChangePanel(); }
  if(document.querySelector("#adminPanelStock").style.display==="block"){ renderStockTuner(); }
  if(document.querySelector("#adminPanelGraph").style.display==="block"){ renderGraphAdjustPanel(); }
}

setInterval(autoRefreshPanels, 15000); // 15ì´ˆë§ˆë‹¤ ìë™ ë¦¬í”„ë ˆì‹œ

/* =========================
 *  ì´ë²¤íŠ¸ ë°”ì¸ë”© í™•ì¥
 * ========================= */
function bindExtendedAdmin(){
  // ë‰´ìŠ¤ ì‚­ì œ ë²„íŠ¼ ìœ„ì„
  wireNewsAdmin();

  // ì „ì²´ ì„¸ì…˜ ì´ˆê¸°í™” ë²„íŠ¼ (ì¶”ê°€)
  const btnClear = document.querySelector("#btnClearSessions");
  if(btnClear){ btnClear.addEventListener('click', clearAllSessions); }

  // ê³ ê¸‰ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ (ì¶”ê°€)
  const btnAdvStart = document.querySelector("#btnStartAdvSim");
  const btnAdvStop  = document.querySelector("#btnStopAdvSim");
  if(btnAdvStart) btnAdvStart.addEventListener('click', startAdvancedSim);
  if(btnAdvStop)  btnAdvStop.addEventListener('click', stopAdvancedSim);
}

/* =========================
 *  ì„¸ì…˜ ìœ ì§€ & ìë™ ë³µì› ìµœì í™”
 * ========================= */
function keepSessionAlive(){
  if(!currentUser) return;
  updateDoc(doc(db,"users",currentUser.id),{ lastPing: serverTimestamp() }).catch(()=>{});
}
setInterval(keepSessionAlive, 60000); // 1ë¶„ë§ˆë‹¤ ì„¸ì…˜ í•‘

/* =========================
 *  ë¦¬ì†ŒìŠ¤ ì •ë¦¬
 * ========================= */
window.addEventListener('beforeunload',()=>{
  if(currentUser){
    updateDoc(doc(db,"users",currentUser.id),{active:false}).catch(()=>{});
  }
  if(priceTimer) clearInterval(priceTimer);
  if(advSimTimer) clearInterval(advSimTimer);
  Object.keys(smoothTimers).forEach(k=> clearInterval(smoothTimers[k]));
});

/* =========================
 *  ì´ˆê¸°í™” í™•ì¥
 * ========================= */
function bootExtended(){
  bindExtendedAdmin();
}

document.addEventListener('DOMContentLoaded', bootExtended);

    /* =====================================================
 * PART 4 â€” Final Glue (Hotkeys, A11y, Connectivity, Guards)
 *  - ì „ì—­ ë‹¨ì¶•í‚¤/ì ‘ê·¼ì„±(ëª¨ë‹¬ ESC/í¬ì»¤ìŠ¤ íŠ¸ë©)
 *  - ë„¤íŠ¸ì›Œí¬ ì—°ê²° ê°ì§€ ë°°ë„ˆ
 *  - ë‰´ìŠ¤ íŒ¨ë„ í’ˆì§ˆ ê°œì„ (ì‚­ì œ ë²„íŠ¼ ì£¼ì…, CSV ë‚´ë³´ë‚´ê¸°)
 *  - ê´€ë¦¬ì ì…ë ¥ í¸ì˜(ë¹ ë¥¸ ì½”ë“œ ì „í™˜)
 *  - ë¦¬ì‚¬ì´ì¦ˆ/ë¡œê·¸ ë©”ëª¨ë¦¬ ê°€ë“œ
 *  - ë°©ì–´ì  ì´ˆê¸°í™” ë° ì•ˆì „ì¥ì¹˜
 * ===================================================== */

(function(){
  const $ = (s)=>document.querySelector(s);

  /* -------------------------
   * 1) ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë°°ë„ˆ
   * ------------------------- */
  function ensureNetBanner(){
    if(document.getElementById('netBanner')) return;
    const bar = document.createElement('div');
    bar.id = 'netBanner';
    bar.style.cssText = `
      position:fixed; left:0; right:0; top:0; z-index:1000; display:none;
      text-align:center; padding:8px 12px; background:#7f1d1d; color:#fff; font-weight:600;`;
    bar.textContent = 'ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì‘ì—…ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    document.body.appendChild(bar);
  }
  function showNetBanner(show){
    const bar = document.getElementById('netBanner'); if(!bar) return;
    bar.style.display = show ? 'block' : 'none';
  }
  function bindNetWatcher(){
    ensureNetBanner();
    window.addEventListener('offline', ()=> showNetBanner(true));
    window.addEventListener('online',  ()=> showNetBanner(false));
    // ì´ˆê¸° ìƒíƒœ
    showNetBanner(!navigator.onLine);
  }

  /* -------------------------
   * 2) ëª¨ë‹¬ ESC/í¬ì»¤ìŠ¤ íŠ¸ë©
   * ------------------------- */
  const modalSelectors = ['#loginModal','#withdrawModal','#newsModal'];
  function isModalOpen(sel){ const el=$(sel); return el && el.style.display==='flex'; }
  function closeAnyModal(){
    for(const sel of modalSelectors){ const el=$(sel); if(el && el.style.display==='flex'){ el.style.display='none'; return true; } }
    return false;
  }
  function focusTrap(e){
    const openSel = modalSelectors.find(isModalOpen);
    if(!openSel) return;
    const modal = $(openSel);
    const focusables = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(!focusables.length) return;
    const first = focusables[0];
    const last  = focusables[focusables.length-1];
    if(e.key==='Tab'){
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }
  }
  function bindModalA11y(){
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ if(closeAnyModal()) e.preventDefault(); }
      focusTrap(e);
    });
  }

  /* -------------------------
   * 3) í•«í‚¤(ë‹¨ì¶•í‚¤)
   * ------------------------- */
  function bindHotkeys(){
    document.addEventListener('keydown',(e)=>{
      // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì¤‘ì—ëŠ” ë‹¨ì¶•í‚¤ ë¬´ì‹œ(ì˜ˆ: íƒ€ì´í•‘ ì¤‘)
      const tag = (e.target.tagName||'').toLowerCase();
      if(tag==='input' || tag==='textarea' || e.target.isContentEditable) return;

      // n: ë‰´ìŠ¤ ëª¨ë‹¬ í† ê¸€
      if(e.key==='n' || e.key==='N'){
        const nm = $('#newsModal');
        if(nm.style.display==='flex') nm.style.display='none'; else nm.style.display='flex';
      }
      // w: ì¶œê¸ˆ ëª¨ë‹¬
      if(e.key==='w' || e.key==='W'){
        const btn = document.getElementById('btnWithdraw'); if(btn) btn.click();
      }
      // l: ë¡œê·¸ì•„ì›ƒ
      if(e.key==='l' || e.key==='L'){
        const btn = document.getElementById('btnLogout'); if(btn) btn.click();
      }
      // F2: ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ focus
      if(e.key==='F2'){
        const admin = document.getElementById('adminCode'); if(admin){ admin.focus(); admin.select(); }
      }
    });
  }

  /* -------------------------
   * 4) ë‰´ìŠ¤ íŒ¨ë„ í–¥ìƒ(ì‚­ì œ ë²„íŠ¼ ì£¼ì…, CSV ë‚´ë³´ë‚´ê¸°)
   * ------------------------- */
  function injectNewsDeleteButtons(){
    const panel = document.getElementById('adminPanelNews');
    if(!panel || panel.style.display!=='block') return; // ê´€ë¦¬ì íŒ¨ë„ ì—´ë ¤ ìˆì„ ë•Œë§Œ
    const list = document.getElementById('newsList'); if(!list) return;
    list.querySelectorAll('.req-card').forEach((card)=>{
      if(card.querySelector('.btnDeleteNews')) return; // ì¤‘ë³µ ì£¼ì… ë°©ì§€
      const idAttr = card.getAttribute('data-id'); // ì—†ìœ¼ë©´ ì•„ë˜ì„œ ì¶”ë¡ 
      const btn = document.createElement('button');
      btn.textContent = 'ì‚­ì œ';
      btn.className = 'btnDeleteNews';
      btn.style.marginLeft = '8px';
      // ë°ì´í„° id ì£¼ì…ì´ ì•ˆ ë˜ì–´ìˆì„ ìˆ˜ ìˆì–´ í…ìŠ¤íŠ¸ì—ì„œ í•´ì‹œ ì¶”ì¶œì€ ìƒëµ, ì‚­ì œëŠ” subscribeNews ê°œì„ ì„ ê¶Œì¥
      // ì—¬ê¸°ì„  ì‚­ì œ ë²„íŠ¼ë§Œ UI ì œê³µ
      card.appendChild(btn);
    });
  }

  function setupNewsMutationObserver(){
    const list = document.getElementById('newsList');
    if(!list) return;
    const mo = new MutationObserver(()=>{ injectNewsDeleteButtons(); });
    mo.observe(list,{ childList:true, subtree:true });
  }

  function exportNewsCSV(){
    const list = document.getElementById('newsList'); if(!list) return;
    const rows = [['time','text']];
    list.querySelectorAll('.req-card').forEach(card=>{
      const text = card.textContent.replace(/^\s*ğŸ“°\s*/,'').trim();
      const m = text.match(/^(\d{4}.*?\d{1,2}:\d{2}:\d{2}).*?\s-\s(.*)$/);
      if(m){ rows.push([m[1], m[2]]); }
      else { rows.push(['', text]); }
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='news.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }

  function addNewsExportButton(){
    const panel = document.getElementById('adminPanelNews'); if(!panel) return;
    if(panel.querySelector('#btnExportNews')) return;
    const wrap = document.createElement('div');
    wrap.style.textAlign='right'; wrap.style.marginTop='8px';
    const btn = document.createElement('button');
    btn.id='btnExportNews'; btn.textContent='CSV ë‚´ë³´ë‚´ê¸°';
    btn.addEventListener('click', exportNewsCSV);
    wrap.appendChild(btn); panel.appendChild(wrap);
  }

  /* -------------------------
   * 5) ê´€ë¦¬ì ì½”ë“œ ë¹ ë¥¸ ì „í™˜(ì‰¼í‘œ/ê³µë°± êµ¬ë¶„)
   * ------------------------- */
  function quickAdminEnter(){
    const input = document.getElementById('adminCode'); if(!input) return;
    input.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){
        // "code1, code2" í˜•íƒœë¡œ ì…ë ¥ë˜ë©´ ì²« ë²ˆì§¸ë¶€í„° ìˆœì°¨ ì‹¤í–‰
        const val = input.value.trim();
        const codes = val.split(/[\s,;]+/).filter(Boolean);
        if(!codes.length) return;
        // ì²« ì½”ë“œ ì‹¤í–‰
        input.value = codes[0];
        const btn = document.getElementById('btnAdminLogin'); if(btn) btn.click();
        // ë‚˜ë¨¸ì§€ëŠ” íì— ë„£ì–´ì„œ 600ms ê°„ê²©ìœ¼ë¡œ ì‹œë„
        if(codes.length>1){
          let idx = 1;
          const t = setInterval(()=>{
            if(idx>=codes.length){ clearInterval(t); return; }
            input.value = codes[idx++];
            const b = document.getElementById('btnAdminLogin'); if(b) b.click();
          }, 600);
        }
      }
    });
  }

  /* -------------------------
   * 6) ë¦¬ì‚¬ì´ì¦ˆ/ë¡œê·¸ ë©”ëª¨ë¦¬ ê°€ë“œ
   * ------------------------- */
  function bindResizeGuard(){
    let t=null; window.addEventListener('resize',()=>{
      if(t) cancelAnimationFrame(t);
      t = requestAnimationFrame(()=>{
        // ì°¨íŠ¸ í¬ê¸° ì•ˆì •í™”: Chart.js responsiveê°€ ì²˜ë¦¬í•˜ì§€ë§Œ ì¶”ê°€ í˜¸ì¶œë¡œ ê°±ì‹  ë³´ì¡°
        if(window.refreshAllPanelPrices) window.refreshAllPanelPrices();
      });
    });
  }

  function capLogLength(){
    const log = document.getElementById('log'); if(!log) return;
    const MAX = 120;
    const els = [...log.children];
    if(els.length>MAX){ for(let i=MAX;i<els.length;i++){ els[i].remove(); } }
  }
  setInterval(capLogLength, 5000);

  /* -------------------------
   * 7) ì•ˆì „ì¥ì¹˜: Chart.js ìœ ë¬´ ì²´í¬
   * ------------------------- */
  function ensureChartJS(){
    if(typeof Chart==='undefined'){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      document.head.appendChild(s);
    }
  }

  /* -------------------------
   * 8) ë¶€íŒ…
   * ------------------------- */
  function bootFinal(){
    bindNetWatcher();
    bindModalA11y();
    bindHotkeys();
    setupNewsMutationObserver();
    addNewsExportButton();
    quickAdminEnter();
    bindResizeGuard();
    ensureChartJS();
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bootFinal);
  else bootFinal();
})();
