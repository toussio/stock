<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:5px 10px; cursor:pointer; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (Firestore ì—°ë™)</h1>

<div id="userRow">
  <div id="userInfo"></div>
  <div>
    <input id="acctNo" type="text" placeholder="ê³„ì¢Œë²ˆí˜¸">
    <input id="cashAmount" type="number" placeholder="ê¸ˆì•¡">
    <input id="cashMemo" type="text" placeholder="ë©”ëª¨(ì„ íƒ)">
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection" style="text-align:center; margin-top:20px;">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
  <button onclick="openAdminPanel()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div style="background:#1f2937; padding:20px; border-radius:10px; width:500px; max-height:90%; overflow:auto; position:relative;">
    <button onclick="closeAdminPanel()" style="position:absolute; top:10px; right:10px;">âœ–</button>
    <h2>ê´€ë¦¬ì ë©”ë‰´</h2>

    <h3>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h3>
    <div id="requestsList"></div>

    <hr style="margin:20px 0;">

    <h3>ê·¸ë˜í”„ ì œì–´</h3>
    <button onclick="resetAllCompanies()">ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
    <button onclick="startAutoGraph()">ìë™ ì‹œì‘</button>
    <button onclick="stopAutoGraph()">ìë™ ë©ˆì¶¤</button>
    <div style="margin-top:10px;">
      <label>ì†ë„(ms): <input type="number" id="graphSpeed" value="5000" style="width:100px;"></label>
      <label>ë³€ë™í­(%): <input type="number" id="graphRange" value="5" style="width:60px;"></label>
      <button onclick="applyGraphConfig()">ì ìš©</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000] },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ", price:500, history:[500] },
  { name:"ì‚¬ì¿ ë¼", price:500, history:[500] },
  { name:"ì²­ë£¡", price:500, history:[500] },
  { name:"ê²½ì°°ì²­", price:500, history:[500] },
  { name:"EMS", price:500, history:[500] },
  { name:"ì˜¬ë“œë³´ì´", price:500, history:[500] },
  { name:"ì‘ë‘", price:800, history:[800] }
];

/* ===== ë¡œê·¸ì¸ ===== */
window.loginUser = async function(userId,userName){
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    player={ cash:data.cash??5000000, holdings:data.holdings??{} };
  } else {
    await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
    player={ cash:5000000, holdings:{} };
  }
  currentUser={ id:userId, name:userName };
  renderUserInfo(); renderCompanies();

  // íšŒì‚¬ ë¬¸ì„œ ì´ˆê¸°í™” + êµ¬ë…
  for(const c of companies){
    const ref=doc(db,"companies",c.name);
    const compSnap=await getDoc(ref);
    if(!compSnap.exists()){
      await setDoc(ref,{ price:c.price, history:[c.price] });
    }
    onSnapshot(ref,(snap)=>{
      if(snap.exists()){
        const data=snap.data();
        c.price=data.price; c.history=data.history;
        const priceSpan=document.getElementById(`price-${c.name}`);
        if(priceSpan) priceSpan.textContent=c.price.toLocaleString();
        updateChart();
      }
    });
  }
  log(`ğŸ‘¤ ë¡œê·¸ì¸: ${userName}(${userId})`);
}

/* ===== UI ===== */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=
    `<strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> | 
     í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW 
     <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>`;
}
function renderCompanies(){
  const container=document.getElementById('companies');
  container.innerHTML='';
  companies.forEach(c=>{
    const held=player.holdings[c.name]||0;
    const div=document.createElement('div');
    div.className='company';
    div.innerHTML=`
      <div><strong>${c.name}</strong><br>
      ê°€ê²©: <span id="price-${c.name}">${c.price.toLocaleString()}</span> KRW<br>
      ë³´ìœ : ${held}ì£¼</div>
      <div>
        <button onclick="buy('${c.name}')">ë§¤ìˆ˜</button>
        <button onclick="sell('${c.name}')">ë§¤ë„</button>
      </div>`;
    container.appendChild(div);
  });
  updateChart(); renderUserInfo();
}

/* ===== ê±°ë˜ ===== */
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

window.buy=async function(name){
  const c=companies.find(x=>x.name===name);
  if(player.cash<c.price){ alert("í˜„ê¸ˆ ë¶€ì¡±"); return; }
  player.cash-=c.price;
  player.holdings[name]=(player.holdings[name]||0)+1;
  log(`âœ… ${currentUser.name} ${name} ë§¤ìˆ˜ @ ${c.price}`);
  await updateDoc(doc(db,"users",currentUser.id),{ cash:player.cash, holdings:player.holdings });
  renderCompanies();
}
window.sell=async function(name){
  const c=companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<1){ alert("ë³´ìœ  ë¶€ì¡±"); return; }
  player.cash+=c.price;
  player.holdings[name]-=1;
  log(`âœ… ${currentUser.name} ${name} ë§¤ë„ @ ${c.price}`);
  await updateDoc(doc(db,"users",currentUser.id),{ cash:player.cash, holdings:player.holdings });
  renderCompanies();
}
window.logout=function(){ currentUser=null; document.getElementById("loginModal").style.display="flex"; }

/* ===== ì…ê¸ˆ ìš”ì²­ ===== */
window.requestDeposit=async function(){
  const acct=document.getElementById("acctNo").value.trim();
  const amt=parseInt(document.getElementById("cashAmount").value,10);
  const memo=document.getElementById("cashMemo").value.trim();
  if(!currentUser){ alert("ë¡œê·¸ì¸ í•„ìš”"); return; }
  if(!acct||!amt||amt<=0){ alert("ê³„ì¢Œ/ê¸ˆì•¡ í™•ì¸"); return; }
  await addDoc(collection(db,"depositRequests"),{
    userId:currentUser.id, userName:currentUser.name,
    account:acct, amount:amt, memo:memo,
    approved:null, createdAt:serverTimestamp()
  });
  log(`ğŸ“¨ ì…ê¸ˆìš”ì²­ ${amt.toLocaleString()} KRW / ê³„ì¢Œ:${acct}`);
}

/* ===== ê´€ë¦¬ì ===== */
window.openAdminPanel = async function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code!=="ADMIN123"){ alert("ê´€ë¦¬ì ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  document.getElementById("adminModal").style.display="flex";
  loadDepositRequests();
}
window.closeAdminPanel=function(){ document.getElementById("adminModal").style.display="none"; }

async function loadDepositRequests(){
  const q=await getDocs(query(collection(db,"depositRequests")));
  const list=document.getElementById("requestsList");
  list.innerHTML="";
  q.forEach(docSnap=>{
    const r=docSnap.data();
    const div=document.createElement("div");
    div.style.background="#111827";
    div.style.padding="10px";
    div.style.marginBottom="8px";
    div.style.borderRadius="6px";
    div.innerHTML=`
      <strong>${r.userName}(${r.userId})</strong><br>
      ê³„ì¢Œ: ${r.account}<br>
      ê¸ˆì•¡: ${r.amount.toLocaleString()} KRW<br>
      ìƒíƒœ: ${r.approved===true?"âœ… ìŠ¹ì¸ë¨":r.approved===false?"â›” ê±°ì ˆë¨":"â³ ëŒ€ê¸°ì¤‘"}<br>
      <button onclick="approveRequest('${docSnap.id}','${r.userId}',${r.amount})">ìŠ¹ì¸</button>
      <button onclick="rejectRequest('${docSnap.id}')">ê±°ì ˆ</button>
    `;
    list.appendChild(div);
  });
}
window.approveRequest=async function(reqId,userId,amount){
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    await updateDoc(userRef,{ cash:(data.cash||0)+amount });
  }
  await updateDoc(doc(db,"depositRequests",reqId),{ approved:true });
  log(`âœ… ìš”ì²­ ${reqId} ìŠ¹ì¸ë¨ (+${amount})`);
  loadDepositRequests();
}
window.rejectRequest=async function(reqId){
  await updateDoc(doc(db,"depositRequests",reqId),{ approved:false });
  log(`â›” ìš”ì²­ ${reqId} ê±°ì ˆë¨`);
  loadDepositRequests();
}

/* ===== ê·¸ë˜í”„ ì œì–´ ===== */
window.resetAllCompanies=async function(){
  for(const c of companies){
    const ref=doc(db,"companies",c.name);
    await setDoc(ref,{ price:c.price, history:[c.price] });
  }
  log("ğŸ”„ ì „ì²´ íšŒì‚¬ ê·¸ë˜í”„ ì´ˆê¸°í™” ì™„ë£Œ");
}
let autoInterval=null;
let updateSpeed=5000;
let changeRange=0.05;
window.startAutoGraph=function(){
  if(autoInterval) return;
  autoInterval=setInterval(async()=>{
    for(const c of companies){
      const ref=doc(db,"companies",c.name);
      const snap=await getDoc(ref);
      if(snap.exists()){
        const data=snap.data();
        const change=(Math.random()*2*changeRange - changeRange);
        const newPrice=Math.max(1, Math.round(data.price*(1+change)));
        const newHistory=[...data.history, newPrice];
        await updateDoc(ref,{ price:newPrice, history:newHistory });
      }
    }
  }, updateSpeed);
  log(`âš¡ ìë™ ê·¸ë˜í”„ ì‹œì‘ (ì†ë„:${updateSpeed}ms, ë³€ë™í­:Â±${(changeRange*100).toFixed(1)}%)`);
}
window.stopAutoGraph=function(){
  if(autoInterval){ clearInterval(autoInterval); autoInterval=null; }
  log("â¹ ìë™ ê·¸ë˜í”„ ë©ˆì¶¤");
}
window.applyGraphConfig=function(){
  const speedVal=parseInt(document.getElementById("graphSpeed").value,10);
  const rangeVal=parseFloat(document.getElementById("graphRange").value)/100;
  if(!isNaN(speedVal)&&speedVal>=500){ updateSpeed=speedVal; }
  if(!isNaN(rangeVal)&&rangeVal>0){ changeRange=rangeVal; }
  log(`âš™ï¸ ì„¤ì • ì ìš©ë¨ â†’ ì†ë„:${updateSpeed}ms, ë³€ë™í­:Â±${(changeRange*100).toFixed(1)}%`);
  if(autoInterval){ stopAutoGraph(); startAutoGraph(); }
}

/* ===== ì°¨íŠ¸ ===== */
const ctx=document.getElementById('chart').getContext('2d');
chart=new Chart(ctx,{ type:'line',
  data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:c.history,
    borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false}))},
  options:{ responsive:true, scales:{ x:{title:{display:true,text:"í‹±"}}, y:{title:{display:true,text:"ê°€ê²©"}}}}
});
function updateChart(){
  chart.data.labels=Array.from({length:companies[0].history.length},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

/* ===== ì‹œì‘ ë²„íŠ¼ ===== */
document.getElementById("startBtn").addEventListener("click",async()=>{
  const uid=document.getElementById("userId").value.trim();
  const uname=document.getElementById("userName").value.trim();
  if(!uid||!uname){ alert("ì…ë ¥í•„ìš”"); return; }
  await loginUser(uid,uname);
  document.getElementById("loginModal").style.display="none";
});
</script>
</body>
</html>
