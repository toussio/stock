<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì‘ë‘ íˆ¬ì ì„¼í„°</title>

  <style>
    :root{
      --bg:#0f172a;
      --card:#1f2937;
      --ink:#e5e7eb;
      --ink2:#cbd5e1;
      --accent:#334155;
      --accentH:#475569;
      --danger:#7f1d1d;
      --ok:#065f46;
    }

    *{box-sizing:border-box;}
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin: 4px 0 16px;
    }

    #userRow, #log {
      margin: 20px auto;
      max-width: 1100px;
    }

    #userRow {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    #userInfo { font-size: 16px; }

    button {
      background: var(--accent);
      color: var(--ink);
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover { background: var(--accentH); }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 460px;
      position: relative;
    }

    input, select {
      background: var(--card);
      border: 1px solid var(--accent);
      color: var(--ink);
      border-radius: 6px;
      padding: 6px 8px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid var(--accent);
      padding: 6px 8px;
      text-align: center;
    }

    th { background: var(--accent); }

    .ok { color: #16a34a; }
    .no { color: #dc2626; }

    .admin-section {
      margin: 20px auto;
      padding: 16px;
      background: var(--card);
      border-radius: 8px;
      max-width: 1100px;
    }

    .req-card {
      background: var(--accent);
      padding: 8px 10px;
      border-radius: 6px;
      margin: 6px 0;
    }

    /* === ì°¨íŠ¸ ì˜ì—­ === */
    #chartWrap {
      max-width: 1100px;
      height: 400px;
      background: #111827;
      margin: 20px auto;
      border-radius: 10px;
      overflow: hidden;
    }

    /* === íšŒì‚¬ ì¹´ë“œ === */
    #companies {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      max-width: 1100px;
      margin: 20px auto;
    }

    .company {
      background: var(--card);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: 0.2s;
    }

    .company.delisted {
      opacity: 0.6;
      filter: grayscale(0.3);
    }

    .company input[type=number] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      background: #0f172a;
      color: var(--ink);
      margin-top: 4px;
    }

    .company .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .status-badge {
      font-size: 13px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid #374151;
      color: var(--ink2);
    }

    .status-badge.delisted {
      background: #111827;
      border-color: #4b5563;
      color: #9ca3af;
    }

    #log {
      background: #111827;
      border-radius: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding: 12px;
    }
  </style>
</head>

  <body>
  <h1>ğŸ“ˆ ì‘ë‘ íˆ¬ì ì„¼í„°</h1>

  <!-- ìœ ì € ì •ë³´ & ìƒë‹¨ ë²„íŠ¼ -->
  <div id="userRow">
    <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
    <div>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <button onclick="openWithdrawModal()">ğŸ¦ ì¶œê¸ˆ ìš”ì²­</button>
      <button onclick="openNoticeModal()">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button onclick="openNewsModal()">ğŸ“° ë‰´ìŠ¤</button>
    </div>
  </div>

  <!-- ì…ê¸ˆ í¼ -->
  <div id="depositForm" style="display:flex;justify-content:center;align-items:center;gap:10px;margin:20px auto;max-width:1100px;">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <!-- ì°¨íŠ¸ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>

  <!-- ê¸°ì—… ë¦¬ìŠ¤íŠ¸ -->
  <div id="companies"></div>

  <!-- ê±°ë˜ ë¡œê·¸ -->
  <div id="log"></div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <h2>ë¡œê·¸ì¸</h2>
      <input id="customId" placeholder="ê³ ìœ ë²ˆí˜¸"><br>
      <input id="customName" placeholder="ì´ë¦„"><br>
      <button id="startBtn">ì‹œì‘</button>
    </div>
  </div>

  <!-- ì¶œê¸ˆ ëª¨ë‹¬ -->
  <div id="withdrawModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align:center;">
      <button class="xbtn" onclick="closeWithdrawModal()" style="position:absolute;top:8px;right:8px;">âœ•</button>
      <h2>ì¶œê¸ˆ ìš”ì²­</h2>
      <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸"><br>
      <input type="text" id="withdrawName" placeholder="ì´ë¦„"><br>
      <input type="number" id="withdrawAmount" placeholder="ê¸ˆì•¡"><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af;margin:6px 0;">ìˆ˜ìˆ˜ë£Œ 20% ì ìš©</div>
      <input type="text" id="withdrawAccount" placeholder="ê³„ì¢Œë²ˆí˜¸"><br>
      <button onclick="submitWithdraw()">ìš”ì²­</button>
    </div>
  </div>

  <!-- ê³µì§€ ëª¨ë‹¬ -->
  <div id="noticeModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align:center;width:500px;max-height:85vh;overflow:auto;">
      <button class="xbtn" onclick="closeNoticeModal()" style="position:absolute;top:8px;right:8px;">âœ•</button>
      <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
      <div id="noticeContent" style="text-align:left;"></div>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ -->
  <div id="newsModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align:center;width:500px;max-height:85vh;overflow:auto;">
      <button class="xbtn" onclick="closeNewsModal()" style="position:absolute;top:8px;right:8px;">âœ•</button>
      <h2>ğŸ“° ë‰´ìŠ¤</h2>
      <div id="newsContent" style="text-align:left;"></div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
  <div id="adminLogin" style="display:none;text-align:center;margin:20px auto;">
    <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
    <button onclick="checkAdmin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminPanelAll" class="modal" style="display:none;">
    <div class="modal-content" style="text-align:left;width:min(95%,1100px);max-height:85vh;overflow:auto;">
      <button class="xbtn" onclick="closeAdmin('adminPanelAll')" style="position:absolute;top:8px;right:8px;">âœ•</button>
      <h2>âš™ï¸ ê´€ë¦¬ì íŒ¨ë„</h2>
      <div id="adminSummary" style="margin:10px 0;color:#facc15;font-weight:bold;">ğŸ“Š ì£¼ì‹ í†µí•© ë³´ìœ ëŸ‰</div>
      <div id="graphCompanyAdjust"></div>
      <div style="margin-top:20px;">
        <h3>ğŸ“¤ ì…ê¸ˆ / ì¶œê¸ˆ ìš”ì²­</h3>
        <div style="display:flex;gap:20px;flex-wrap:wrap;">
          <div style="flex:1;min-width:320px;">
            <h4>ì…ê¸ˆ ìš”ì²­</h4>
            <div id="depositRequests"></div>
          </div>
          <div style="flex:1;min-width:320px;">
            <h4>ì¶œê¸ˆ ìš”ì²­</h4>
            <div id="withdrawRequests"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, getDocs, collection,
      onSnapshot, addDoc, updateDoc, increment, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
      authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
      projectId: "cotyledons-of-stock-a1241",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ======= ì „ì—­ ìƒíƒœ =======
    let currentUser = null;
    let player = { cash: 0, holdings: {} };
    let chart;
    let marketOpenFlag = false;

    const companies = [
      { name: "ì‚¬ì¿ ë¼", basePrice: 27000000, livePrice: 27000000 },
      { name: "ì¤‘ì•™ê²½ì°°", basePrice: 25000000, livePrice: 25000000 },
      { name: "ë²Œì§‘", basePrice: 24000000, livePrice: 24000000 },
      { name: "ì˜ë£Œêµ­", basePrice: 26000000, livePrice: 26000000 },
      { name: "ì‘ë‘", basePrice: 28000000, livePrice: 28000000 },
      { name: "ì¹ ì„±íŒŒ", basePrice: 25600000, livePrice: 25600000 },
      { name: "ë¬´ëª…", basePrice: 24000000, livePrice: 24000000 },
      { name: "ë°±í˜¸ìë™ì°¨", basePrice: 26700000, livePrice: 26700000 },
      { name: "ë¦¬ì–¼ì›”ë“œê´€ë¦¬ì", basePrice: 26300000, livePrice: 26300000 },
    ].map(c => ({ ...c, id: c.name, delisted: false }));

    const $ = id => document.getElementById(id);

    // ======= ê¸°ë³¸ ìœ í‹¸ =======
    function log(msg, color = "#e5e7eb") {
      const time = new Date().toLocaleTimeString();
      const line = `<div style="margin:2px 0;color:${color}">[${time}] ${msg}</div>`;
      $("log").insertAdjacentHTML("afterbegin", line);
      while ($("log").children.length > 120) $("log").removeChild($("log").lastChild);
    }

    function getDisplayPrice(c) {
      return Math.max(1, Math.floor(c.livePrice || c.basePrice));
    }

    // ======= ë¡œê·¸ì¸ =======
    $("startBtn").onclick = async () => {
      const id = $("customId").value.trim();
      const name = $("customName").value.trim();
      if (!id || !name) return alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      currentUser = { id, name };
      const ref = doc(db, "users", id);
      const snap = await getDoc(ref);
      if (snap.exists()) player = snap.data();
      else await setDoc(ref, { cash: 0, holdings: {} });
      $("loginModal").style.display = "none";
      renderUserInfo();
      renderCompanies();
      subscribeFinanceQueues();
      renderAdminSummary();
      initChart();
      log(`âœ… ë¡œê·¸ì¸ ì™„ë£Œ: ${name} (${id})`);
    };

    function logout() {
      location.reload();
    }

    // ======= UI ë Œë” =======
    function renderUserInfo() {
      if (!currentUser) return;
      $("userInfo").innerHTML = `ğŸ‘¤ <strong>${currentUser.name}</strong> | ğŸ’µ ${player.cash.toLocaleString()} KRW`;
    }

    function renderCompanies() {
      let html = "";
      companies.forEach(c => {
        html += `
          <div class="company ${c.delisted ? "delisted" : ""}">
            <div><strong>${c.name}</strong> <span class="status-badge">${marketOpenFlag ? "ğŸŸ¢ ê°œì¥" : "ğŸ”´ ë§ˆê°"}</span></div>
            <div>ê°€ê²©: <strong><span id="price-${c.id}">${getDisplayPrice(c).toLocaleString()}</span> KRW</strong></div>
            <div>ë³´ìœ : <span id="hold-${c.id}">${player.holdings[c.name] || 0}</span>ì£¼</div>
            <div class="actions">
              <input type="number" id="qty-${c.id}" min="1" value="1">
              <button onclick="buy('${c.name}', getQty('${c.name}'))">ë§¤ìˆ˜</button>
              <button onclick="sell('${c.name}', getQty('${c.name}'))">ë§¤ë„</button>
            </div>
          </div>`;
      });
      $("companies").innerHTML = html;
    }

    function getQty(name) {
      return Math.max(1, parseInt($(`qty-${name}`)?.value) || 1);
    }

    // ======= ë§¤ìˆ˜ / ë§¤ë„ =======
    async function buy(name, qty) {
      const c = companies.find(x => x.name === name);
      if (!marketOpenFlag) return alert("ì§€ê¸ˆì€ ì¥ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
      const price = getDisplayPrice(c);
      const total = price * qty;
      if (player.cash < total) return alert("í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      player.cash -= total;
      player.holdings[c.name] = (player.holdings[c.name] || 0) + qty;
      await setDoc(doc(db, "users", currentUser.id), player, { merge: true });
      log(`ğŸŸ¢ ë§¤ìˆ˜: ${c.name} ${qty}ì£¼ @ ${price.toLocaleString()}`);
      renderUserInfo(); renderCompanies();
    }

    async function sell(name, qty) {
      const c = companies.find(x => x.name === name);
      if (!marketOpenFlag) return alert("ì§€ê¸ˆì€ ì¥ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
      if ((player.holdings[c.name] || 0) < qty) return alert("ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±");
      const price = getDisplayPrice(c);
      const total = price * qty;
      player.cash += total;
      player.holdings[c.name] -= qty;
      await setDoc(doc(db, "users", currentUser.id), player, { merge: true });
      log(`ğŸ”´ ë§¤ë„: ${c.name} ${qty}ì£¼ @ ${price.toLocaleString()}`);
      renderUserInfo(); renderCompanies();
    }

    // ======= ì…ê¸ˆ / ì¶œê¸ˆ =======
    async function requestDeposit() {
      const account = $("acctNo").value.trim();
      const amount = parseInt($("cashAmount").value);
      if (!account || !amount) return alert("ê³„ì¢Œë²ˆí˜¸ì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");
      await addDoc(collection(db, "depositRequests"), {
        userId: currentUser.id,
        userName: currentUser.name,
        account,
        amount,
        status: "pending",
        createdAt: Date.now(),
      });
      log(`ğŸ’° ì…ê¸ˆ ìš”ì²­: ${amount.toLocaleString()} KRW`);
    }

    async function submitWithdraw() {
      const id = $("withdrawId").value.trim();
      const name = $("withdrawName").value.trim();
      const amount = parseInt($("withdrawAmount").value);
      const account = $("withdrawAccount").value.trim();
      if (!id || !name || !amount || !account) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      await addDoc(collection(db, "withdrawRequests"), {
        userId: id,
        userName: name,
        account,
        amount,
        status: "pending",
        createdAt: Date.now(),
      });
      log(`ğŸ“¤ ì¶œê¸ˆ ìš”ì²­: ${amount.toLocaleString()} KRW`);
      closeWithdrawModal();
    }

    // ======= ê´€ë¦¬ì íŒ¨ë„ =======
    function checkAdmin() {
      const code = $("adminCode").value.trim();
      if (code !== "ADBEN7732") return alert("ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      $("adminPanelAll").style.display = "flex";
      renderAdminSummary();
    }

    async function renderAdminSummary() {
      const all = await getDocs(collection(db, "users"));
      const totals = {};
      all.forEach(d => {
        const u = d.data() || {};
        const hold = u.holdings || {};
        Object.entries(hold).forEach(([name, qty]) => {
          totals[name] = (totals[name] || 0) + qty;
        });
      });
      const sumTxt = Object.entries(totals)
        .map(([k, v]) => `${k}: ${v.toLocaleString()}ì£¼`)
        .join(", ");
      $("adminSummary").textContent = `ğŸ“Š ì£¼ì‹ í†µí•© ë³´ìœ ëŸ‰\n${sumTxt}`;
    }

    function closeAdmin(id) {
      $(id).style.display = "none";
    }

    // ======= ì…ì¶œê¸ˆ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ =======
    function subscribeFinanceQueues() {
      // ì…ê¸ˆ ìš”ì²­
      onSnapshot(collection(db, "depositRequests"), snap => {
        let html = "";
        snap.forEach(docu => {
          const r = docu.data();
          if (r.status !== "pending") return;
          html += `
            <div class="req-card">
              <strong>${r.userName}</strong> (${r.userId}) - ${r.amount.toLocaleString()} KRW
              <div style="margin-top:6px;">
                <button onclick="approveDeposit('${docu.id}', ${r.amount}, '${r.userId}')">ìŠ¹ì¸</button>
                <button onclick="rejectDeposit('${docu.id}')">ê±°ì ˆ</button>
              </div>
            </div>`;
        });
        $("depositRequests").innerHTML = html || "ì…ê¸ˆ ìš”ì²­ ì—†ìŒ";
      });

      // ì¶œê¸ˆ ìš”ì²­
      onSnapshot(collection(db, "withdrawRequests"), snap => {
        let html = "";
        snap.forEach(docu => {
          const r = docu.data();
          if (r.status !== "pending") return;
          html += `
            <div class="req-card">
              <strong>${r.userName}</strong> (${r.userId}) - ${r.amount.toLocaleString()} KRW
              <div style="margin-top:6px;">
                <button onclick="approveWithdraw('${docu.id}', ${r.amount}, '${r.userId}')">ìŠ¹ì¸</button>
                <button onclick="rejectWithdraw('${docu.id}')">ê±°ì ˆ</button>
              </div>
            </div>`;
        });
        $("withdrawRequests").innerHTML = html || "ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ";
      });
    }

    // ìŠ¹ì¸/ê±°ì ˆ
    async function approveDeposit(id, amount, userId) {
      await updateDoc(doc(db, "users", userId), { cash: increment(amount) });
      await updateDoc(doc(db, "depositRequests", id), { status: "approved" });
      log(`âœ… ì…ê¸ˆ ìŠ¹ì¸: ${amount.toLocaleString()} KRW`);
      renderAdminSummary();
    }

    async function rejectDeposit(id) {
      await updateDoc(doc(db, "depositRequests", id), { status: "rejected" });
      log(`âŒ ì…ê¸ˆ ê±°ì ˆ`);
    }

    async function approveWithdraw(id, amount, userId) {
      const ref = doc(db, "users", userId);
      const snap = await getDoc(ref);
      const u = snap.data() || {};
      if ((u.cash || 0) < amount) return alert("ìœ ì € ì”ì•¡ ë¶€ì¡±");
      await updateDoc(ref, { cash: increment(-amount) });
      await updateDoc(doc(db, "withdrawRequests", id), { status: "approved" });
      log(`ğŸ’¸ ì¶œê¸ˆ ìŠ¹ì¸: ${amount.toLocaleString()} KRW`);
      renderAdminSummary();
    }

    async function rejectWithdraw(id) {
      await updateDoc(doc(db, "withdrawRequests", id), { status: "rejected" });
      log(`âŒ ì¶œê¸ˆ ê±°ì ˆ`);
    }

    // ======= ì°¨íŠ¸ =======
    function initChart() {
      const ctx = $("chart");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: companies.map(c => ({
            label: c.name,
            data: [c.basePrice],
            borderWidth: 1.8
          }))
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });

      setInterval(() => {
        companies.forEach((c, i) => {
          if (c.delisted) return;
          const change = c.livePrice * (Math.random() - 0.5) * 0.01;
          c.livePrice = Math.max(1, Math.floor(c.livePrice + change));
          chart.data.datasets[i].data.push(c.livePrice);
          if (chart.data.datasets[i].data.length > 30) chart.data.datasets[i].data.shift();
          const el = $("price-" + c.id);
          if (el) el.textContent = c.livePrice.toLocaleString();
        });
        chart.data.labels.push(new Date().toLocaleTimeString().slice(3,8));
        if (chart.data.labels.length > 30) chart.data.labels.shift();
        chart.update();
      }, 5000);
    }

    // ======= ëª¨ë‹¬ ì»¨íŠ¸ë¡¤ =======
    function openWithdrawModal() { $("withdrawModal").style.display = "flex"; }
    function closeWithdrawModal() { $("withdrawModal").style.display = "none"; }
    function openNoticeModal() { $("noticeModal").style.display = "flex"; }
    function closeNoticeModal() { $("noticeModal").style.display = "none"; }
    function openNewsModal() { $("newsModal").style.display = "flex"; }
    function closeNewsModal() { $("newsModal").style.display = "none"; }

    window.buy = buy;
    window.sell = sell;
    window.getQty = getQty;
    window.requestDeposit = requestDeposit;
    window.submitWithdraw = submitWithdraw;
    window.openWithdrawModal = openWithdrawModal;
    window.closeWithdrawModal = closeWithdrawModal;
    window.openNoticeModal = openNoticeModal;
    window.closeNoticeModal = closeNoticeModal;
    window.openNewsModal = openNewsModal;
    window.closeNewsModal = closeNewsModal;
    window.logout = logout;
    window.checkAdmin = checkAdmin;
    window.closeAdmin = closeAdmin;
    window.approveDeposit = approveDeposit;
    window.rejectDeposit = rejectDeposit;
    window.approveWithdraw = approveWithdraw;
    window.rejectWithdraw = rejectWithdraw;
  </script>
</body>
</html>
