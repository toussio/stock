<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:960px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:960px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:6px 10px; cursor:pointer; }
input[type="number"], input[type="text"] { padding:6px; }
#log { max-height:240px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }

/* ë¡œê·¸ì¸ ëª¨ë‹¬ */
#loginModal { display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; width:320px; }
#loginModal input { margin:10px 0; padding:8px; width:100%; box-sizing:border-box; }

/* ê´€ë¦¬ì */
#adminSection { text-align:center; margin-top:20px; }
#adminModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModal .panel { background:#1f2937; padding:20px; border-radius:10px; width:720px; max-height:90%; overflow:auto; position:relative; }
#adminModal .panel .close { position:absolute; top:10px; right:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #444; padding:6px; text-align:center; }
th { background:#374151; }
.badge { padding:2px 6px; border-radius:6px; font-size:12px; }
.badge.wait { background:#374151; }
.badge.approved { background:#065f46; }
.badge.rejected { background:#7f1d1d; }
.card { background:#111827; padding:10px; border-radius:8px; margin-bottom:8px; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (Firestore ì—°ë™)</h1>

<div id="userRow">
  <div id="userInfo"></div>
  <div>
    <input id="acctNo" type="text" placeholder="ê³„ì¢Œë²ˆí˜¸" />
    <input id="cashAmount" type="number" placeholder="ê¸ˆì•¡" />
    <input id="cashMemo" type="text" placeholder="ë©”ëª¨(ì„ íƒ)" />
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="960" height="420"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" />
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" />
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ (ADMIN123)" />
  <button onclick="openAdminPanel()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal">
  <div class="panel">
    <button class="close" onclick="closeAdminPanel()">âœ–</button>
    <h2>ê´€ë¦¬ì ë©”ë‰´</h2>

    <h3>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h3>
    <div id="requestsList"></div>

    <hr style="margin:20px 0;" />

    <h3>ê·¸ë˜í”„ ì œì–´</h3>
    <button onclick="startAutoGraph()">ìë™ ì‹œì‘</button>
    <button onclick="stopAutoGraph()">ìë™ ë©ˆì¶¤</button>
    <button onclick="resetGraphAndPrice()">ê·¸ë˜í”„+ê°€ê²© ì´ˆê¸°í™”</button>
    <div style="margin-top:10px;">
      <label>ì†ë„(ms): <input type="number" id="graphSpeed" value="5000" style="width:120px;" /></label>
      <button onclick="applyGraphConfig()">ì ìš©</button>
    </div>

    <hr style="margin:20px 0;" />

    <h3>ê¸°ì—…ë³„ ì‹œì‘ê°€ & ë³€ë™í­ ì„¤ì •</h3>
    <table>
      <thead>
        <tr><th>ê¸°ì—…ëª…</th><th>ì‹œì‘ê°€</th><th>ë³€ë™í­(%)</th></tr>
      </thead>
      <tbody id="companySettingsBody"></tbody>
    </table>
    <button onclick="applyCompanySettings()">ì €ì¥ & ì ìš©</button>

    <hr style="margin:20px 0;" />

    <h3>ë°ì´í„° ì •ë¦¬</h3>
    <button onclick="cleanupHistories()">ê¸°ì—…ë³„ íˆìŠ¤í† ë¦¬ ì •ë¦¬ (ìµœê·¼ 20ê°œë§Œ ìœ ì§€)</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, onSnapshot, getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.firebasestorage.app", /* â† í•„ìš”ì‹œ ì½˜ì†”ì—ì„œ ì •í™•í•œ ë²„í‚·ìœ¼ë¡œ êµì²´ */
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db  = getFirestore(app);

/* ================= ìƒíƒœ/ì„¤ì • ================= */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;
let tradeLog = []; // ìµœê·¼ 10ê°œë§Œ ìœ ì§€ (DBì— ì €ì¥ X)

let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000], range:0.05 },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ",   price:500,  history:[500],  range:0.05 },
  { name:"ì‚¬ì¿ ë¼",     price:500,  history:[500],  range:0.05 },
  { name:"ì²­ë£¡",       price:500,  history:[500],  range:0.05 },
  { name:"ê²½ì°°ì²­",     price:500,  history:[500],  range:0.05 },
  { name:"EMS",        price:500,  history:[500],  range:0.05 },
  { name:"ì˜¬ë“œë³´ì´",   price:500,  history:[500],  range:0.05 },
  { name:"ì‘ë‘",       price:800,  history:[800],  range:0.05 }
];

const BASE_VOLUME = 1000;   // ëŒ€ëŸ‰ë§¤ë§¤ ê¸°ì¤€
const IMPACT = 0.02;        // ê°€ê²© ì¶©ê²© ê³„ìˆ˜
const MAX_HISTORY = 20;     // âœ… ê¸°ì—… history ìµœê·¼ 20ê°œ ìœ ì§€
let autoInterval=null, updateSpeed=5000;

/* ================= ìœ í‹¸ ================= */
function saveUser(u){ localStorage.setItem("stockUser", JSON.stringify(u)); }
function loadUser(){ try { return JSON.parse(localStorage.getItem("stockUser")); } catch(e){ return null; } }
function clearUser(){ localStorage.removeItem("stockUser"); }
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }
function addTradeLog(entry){ tradeLog.unshift(entry); tradeLog = tradeLog.slice(0,10); }

/* ================= ë¡œê·¸ì¸ ================= */
async function loginUser(userId,userName){
  try{
    const userRef=doc(db,"users",userId);
    const snap=await getDoc(userRef);
    if(snap.exists()){
      const data=snap.data();
      player={ cash:data.cash??5000000, holdings:data.holdings??{} };
    } else {
      await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
      player={ cash:5000000, holdings:{} };
    }
    currentUser={ id:userId, name:userName };
    saveUser(currentUser);
    renderUserInfo(); renderCompanies();

    // ìœ ì € ì‹¤ì‹œê°„ êµ¬ë… (í˜„ê¸ˆ/ë³´ìœ  ë³€ë™)
    onSnapshot(userRef,(docSnap)=>{
      if(docSnap.exists()){
        const d=docSnap.data();
        player.cash=d.cash ?? player.cash;
        player.holdings=d.holdings ?? player.holdings;
        renderUserInfo();
      }
    });

    // íšŒì‚¬ ë¬¸ì„œ ë³´ì¥ + history ì •ë¦¬ + ì‹¤ì‹œê°„ êµ¬ë…
    for(const c of companies){
      const ref=doc(db,"companies",c.name);
      const compSnap=await getDoc(ref);
      if(!compSnap.exists()){
        await setDoc(ref,{ price:c.price, history:[c.price], range:c.range });
      } else {
        const d=compSnap.data();
        let hist = d.history || [d.price];
        if(hist.length > MAX_HISTORY){
          hist = hist.slice(-MAX_HISTORY);
          await setDoc(ref,{ price:hist[hist.length-1], history:hist, range:d.range ?? 0.05 });
          log(`ğŸ§¹ ${c.name} íˆìŠ¤í† ë¦¬ ì •ë¦¬ (ìµœê·¼ ${MAX_HISTORY})`);
        }
      }
      onSnapshot(ref,(s)=>{
        if(s.exists()){
          const d=s.data();
          c.price=d.price; c.history=d.history; c.range=d.range ?? 0.05;
          const priceSpan=document.getElementById(`price-${c.name}`);
          if(priceSpan) priceSpan.textContent=c.price.toLocaleString();
          updateChart();
        }
      });
    }

    log(`ğŸ‘¤ ë¡œê·¸ì¸: ${userName} (${userId})`);
  }catch(err){
    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", err);
    alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Firestore ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    // ì˜¤í”„ë¼ì¸ ëª¨ë“œ fallback
    currentUser={ id:userId, name:userName };
    saveUser(currentUser);
    renderUserInfo(); renderCompanies();
  }
}

document.getElementById("startBtn").addEventListener("click", async ()=>{
  const uid=document.getElementById("userId").value.trim();
  const uname=document.getElementById("userName").value.trim();
  if(!uid||!uname){ alert("ê³ ìœ ë²ˆí˜¸/ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  await loginUser(uid,uname);
  document.getElementById("loginModal").style.display="none";
});

document.addEventListener("DOMContentLoaded", async ()=>{
  const saved = loadUser();
  if(saved && saved.id && saved.name){
    await loginUser(saved.id, saved.name);
    document.getElementById("loginModal").style.display="none";
    log("ğŸ”“ ìë™ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
  } else {
    document.getElementById("loginModal").style.display="flex";
  }
});

/* ================= UI ë Œë” ================= */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=
    `<strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> | 
     í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW 
     <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>`;
}
function renderCompanies(){
  const container=document.getElementById('companies');
  container.innerHTML='';
  companies.forEach(c=>{
    const held=player.holdings[c.name]||0;
    const div=document.createElement('div');
    div.className='company';
    div.innerHTML=`
      <div>
        <strong>${c.name}</strong><br/>
        ê°€ê²©: <span id="price-${c.name}">${c.price.toLocaleString()}</span> KRW<br/>
        ë³´ìœ : ${held}ì£¼
      </div>
      <div>
        <input type="number" id="qty-${c.name}" value="1" min="1" style="width:70px; text-align:right; margin-right:6px;">
        <button onclick="buy('${c.name}')">ë§¤ìˆ˜</button>
        <button onclick="sell('${c.name}')">ë§¤ë„</button>
      </div>`;
    container.appendChild(div);
  });
  updateChart(); renderUserInfo();
}
window.logout=function(){ clearUser(); currentUser=null; document.getElementById("loginModal").style.display="flex"; };

/* ================= ê±°ë˜ ================= */
async function syncUser(){
  if(!currentUser) return;
  await updateDoc(doc(db,"users",currentUser.id),{ cash:player.cash, holdings:player.holdings });
}
window.buy=async function(name){
  try{
    const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
    const c=companies.find(x=>x.name===name);
    if(player.cash<c.price*qty){ alert("í˜„ê¸ˆ ë¶€ì¡±"); return; }

    player.cash-=c.price*qty;
    player.holdings[name]=(player.holdings[name]||0)+qty;

    // ëŒ€ëŸ‰ ë§¤ìˆ˜ â†’ ê°€ê²© ìƒìŠ¹
    const impactRate=(qty/BASE_VOLUME)*IMPACT;
    const newPrice=Math.max(1, Math.round(c.price*(1+impactRate)));

    const ref=doc(db,"companies",c.name);
    const snap=await getDoc(ref);
    const d=snap.data()||{};
    const newHistory=[...(d.history||c.history), newPrice].slice(-MAX_HISTORY);
    await updateDoc(ref,{ price:newPrice, history:newHistory });

    addTradeLog({date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, type:"ë§¤ìˆ˜", company:name, qty, price:c.price, cash:player.cash});
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price} â†’ ${newPrice}`);
    await syncUser();
    renderCompanies();
  }catch(err){ console.error(err); alert("ë§¤ìˆ˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜"); }
};
window.sell=async function(name){
  try{
    const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
    const c=companies.find(x=>x.name===name);
    if((player.holdings[name]||0)<qty){ alert("ë³´ìœ  ë¶€ì¡±"); return; }

    player.cash+=c.price*qty;
    player.holdings[name]-=qty;

    // ëŒ€ëŸ‰ ë§¤ë„ â†’ ê°€ê²© í•˜ë½
    const impactRate=(qty/BASE_VOLUME)*IMPACT;
    const newPrice=Math.max(1, Math.round(c.price*(1-impactRate)));

    const ref=doc(db,"companies",c.name);
    const snap=await getDoc(ref);
    const d=snap.data()||{};
    const newHistory=[...(d.history||c.history), newPrice].slice(-MAX_HISTORY);
    await updateDoc(ref,{ price:newPrice, history:newHistory });

    addTradeLog({date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, type:"ë§¤ë„", company:name, qty, price:c.price, cash:player.cash});
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price} â†’ ${newPrice}`);
    await syncUser();
    renderCompanies();
  }catch(err){ console.error(err); alert("ë§¤ë„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜"); }
};

/* ================= ì…ê¸ˆ ìš”ì²­ ================= */
window.requestDeposit=async function(){
  try{
    const acct=document.getElementById("acctNo").value.trim();
    const amt=parseInt(document.getElementById("cashAmount").value,10);
    const memo=document.getElementById("cashMemo").value.trim();
    if(!currentUser){ alert("ë¡œê·¸ì¸ í•„ìš”"); return; }
    if(!acct||!amt||amt<=0){ alert("ê³„ì¢Œ/ê¸ˆì•¡ í™•ì¸"); return; }
    await addDoc(collection(db,"depositRequests"),{
      userId:currentUser.id, userName:currentUser.name,
      account:acct, amount:amt, memo:memo||"",
      approved:null, createdAt:serverTimestamp()
    });
    log(`ğŸ“¨ ì…ê¸ˆìš”ì²­ ${amt.toLocaleString()} KRW / ê³„ì¢Œ:${acct}`);
    document.getElementById("acctNo").value="";
    document.getElementById("cashAmount").value="";
    document.getElementById("cashMemo").value="";
  }catch(err){ console.error(err); alert("ì…ê¸ˆ ìš”ì²­ ì¤‘ ì˜¤ë¥˜"); }
};

/* ================= ê´€ë¦¬ì ================= */
let unsubDeposit = null;

window.openAdminPanel = async function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code!=="ADMIN123"){ alert("ê´€ë¦¬ì ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  document.getElementById("adminModal").style.display="flex";
  renderCompanySettings();

  // ì‹¤ì‹œê°„ êµ¬ë… (approved==null ë§Œ ë³´ì—¬ì£¼ë„ë¡ í•„í„°)
  if (unsubDeposit) unsubDeposit();
  unsubDeposit = onSnapshot(collection(db,"depositRequests"), (snap)=>{
    const list=document.getElementById("requestsList");
    list.innerHTML="";
    const items=[];
    snap.forEach(ds=>{
      const r=ds.data();
      if(r.approved===null){
        items.push({id:ds.id, ...r});
      }
    });
    if(items.length===0){
      list.innerHTML="<div class='card'>ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    } else {
      items.sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
      for(const r of items){
        const div=document.createElement("div");
        div.className="card"; div.id="req-"+r.id;
        div.innerHTML=`
          <div><strong>${r.userName}(${r.userId})</strong> - ${Number(r.amount||0).toLocaleString()} KRW <span class="badge wait">ëŒ€ê¸°</span></div>
          <div>ê³„ì¢Œ: ${r.account} | ë©”ëª¨: ${r.memo||'-'}</div>
          <div style="margin-top:8px;">
            <button onclick="approveRequest('${r.id}','${r.userId}',${r.amount})">ìŠ¹ì¸</button>
            <button onclick="rejectRequest('${r.id}')">ê±°ì ˆ</button>
          </div>
        `;
        list.appendChild(div);
      }
    }
  });
};
window.closeAdminPanel=function(){
  document.getElementById("adminModal").style.display="none";
  if (unsubDeposit) { unsubDeposit(); unsubDeposit=null; }
};

window.approveRequest=async function(reqId,userId,amount){
  try{
    const userRef=doc(db,"users",userId);
    const snap=await getDoc(userRef);
    if(snap.exists()){
      const data=snap.data();
      await updateDoc(userRef,{ cash:(data.cash||0)+Number(amount||0) });
    }
    await updateDoc(doc(db,"depositRequests",reqId),{ approved:true });
    const el=document.getElementById("req-"+reqId); if(el) el.remove();
    addTradeLog({date:new Date().toLocaleString(), userId, userName:"(ê´€ë¦¬ì)", type:"ì…ê¸ˆ(ìŠ¹ì¸)", company:"í˜„ê¸ˆ", qty:0, price:0, cash:"-"});
    log(`âœ… ì…ê¸ˆ ìŠ¹ì¸: ${userId} +${Number(amount||0).toLocaleString()} KRW`);
  }catch(err){ console.error(err); alert("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜"); }
};
window.rejectRequest=async function(reqId){
  try{
    await updateDoc(doc(db,"depositRequests",reqId),{ approved:false });
    const el=document.getElementById("req-"+reqId); if(el) el.remove();
    addTradeLog({date:new Date().toLocaleString(), userId:"-", userName:"(ê´€ë¦¬ì)", type:"ì…ê¸ˆ(ê±°ì ˆ)", company:"í˜„ê¸ˆ", qty:0, price:0, cash:"-"});
    log(`â›” ì…ê¸ˆ ê±°ì ˆ: ${reqId}`);
  }catch(err){ console.error(err); alert("ê±°ì ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜"); }
};

/* ================= ê¸°ì—… ì„¤ì •/ê·¸ë˜í”„ ì œì–´ ================= */
function renderCompanySettings(){
  const body=document.getElementById("companySettingsBody");
  body.innerHTML="";
  companies.forEach(c=>{
    const currentRange = (c.range??0.05)*100;
    body.innerHTML+=`
      <tr>
        <td>${c.name}</td>
        <td><input type="number" id="set-price-${c.name}" value="${c.price}" style="width:120px;"></td>
        <td><input type="number" id="set-range-${c.name}" value="${currentRange}" style="width:90px;"></td>
      </tr>
    `;
  });
}
window.applyCompanySettings=async function(){
  for(const c of companies){
    const priceVal=parseInt(document.getElementById(`set-price-${c.name}`).value,10);
    const rangePct=parseFloat(document.getElementById(`set-range-${c.name}`).value);
    const newPrice=(!isNaN(priceVal)&&priceVal>0)?priceVal:c.price;
    const newRange=(!isNaN(rangePct)&&rangePct>0)?(rangePct/100):0.05;
    const ref=doc(db,"companies",c.name);
    await setDoc(ref,{ price:newPrice, history:[newPrice], range:newRange });
    c.price=newPrice; c.history=[newPrice]; c.range=newRange;
  }
  log("âœ… ê¸°ì—…ë³„ ì‹œì‘ê°€/ë³€ë™í­ ì„¤ì • ì €ì¥ ì™„ë£Œ");
  updateChart(); renderCompanies();
};

window.startAutoGraph=function(){
  if(autoInterval) return;
  autoInterval=setInterval(async()=>{
    for(const c of companies){
      const ref=doc(db,"companies",c.name);
      const s=await getDoc(ref);
      if(s.exists()){
        const d=s.data();
        const range=d.range ?? 0.05;
        const change=(Math.random()*2*range - range);
        const newPrice=Math.max(1, Math.round(d.price*(1+change)));
        const newHistory=[...(d.history||[d.price]), newPrice].slice(-MAX_HISTORY);
        await updateDoc(ref,{ price:newPrice, history:newHistory });
      }
    }
  }, updateSpeed);
  log(`âš¡ ìë™ ê·¸ë˜í”„ ì‹œì‘ (ì†ë„:${updateSpeed}ms, ìµœê·¼ ${MAX_HISTORY}ê°œ ìœ ì§€)`);
};
window.stopAutoGraph=function(){
  if(autoInterval){ clearInterval(autoInterval); autoInterval=null; }
  log("â¹ ìë™ ê·¸ë˜í”„ ë©ˆì¶¤");
};
window.applyGraphConfig=function(){
  const v=parseInt(document.getElementById("graphSpeed").value,10);
  if(!isNaN(v) && v>=300){ updateSpeed=v; }
  log(`âš™ï¸ ì†ë„ ì ìš©: ${updateSpeed}ms`);
  if(autoInterval){ stopAutoGraph(); startAutoGraph(); }
};
window.resetGraphAndPrice=async function(){
  for(const c of companies){
    const priceVal=parseInt(document.getElementById(`set-price-${c.name}`).value,10);
    const rangePct=parseFloat(document.getElementById(`set-range-${c.name}`).value);
    const newPrice=(!isNaN(priceVal)&&priceVal>0)?priceVal:c.price;
    const newRange=(!isNaN(rangePct)&&rangePct>0)?(rangePct/100):(c.range??0.05);
    const ref=doc(db,"companies",c.name);
    await setDoc(ref,{ price:newPrice, history:[newPrice], range:newRange });
    c.price=newPrice; c.history=[newPrice]; c.range=newRange;
  }
  log("ğŸ”„ ê·¸ë˜í”„+ê°€ê²© ì´ˆê¸°í™” (ì‹œì‘ê°€ ê¸°ì¤€)");
  updateChart(); renderCompanies();
};
window.cleanupHistories = async function(){
  for(const c of companies){
    const ref = doc(db,"companies",c.name);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const d = snap.data();
      let hist = d.history || [d.price];
      if(hist.length > MAX_HISTORY){
        hist = hist.slice(-MAX_HISTORY);
        await setDoc(ref,{ price: hist[hist.length-1], history: hist, range: d.range ?? 0.05 });
        log(`ğŸ§¹ ${c.name} íˆìŠ¤í† ë¦¬ ì •ë¦¬ (ìµœê·¼ ${MAX_HISTORY})`);
      }
    }
  }
  updateChart(); renderCompanies();
  alert(`âœ… ê¸°ì—…ë³„ íˆìŠ¤í† ë¦¬ë¥¼ ìµœê·¼ ${MAX_HISTORY}ê°œë§Œ ë‚¨ê¸°ê³  ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.`);
};

/* ================= ì°¨íŠ¸ ================= */
const ctx=document.getElementById('chart').getContext('2d');
function randColor(){ return '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); }
chart=new Chart(ctx,{ type:'line',
  data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:c.history,borderColor:randColor(), fill:false}))},
  options:{ responsive:true, animation:false, scales:{ x:{title:{display:true,text:"í‹±"}}, y:{title:{display:true,text:"ê°€ê²©(KRW)"}}}}
});
function updateChart(){
  const maxLen = Math.max(...companies.map(c=>c.history.length));
  chart.data.labels=Array.from({length:maxLen},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}
</script>
</body>
</html>
