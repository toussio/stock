<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userInfo,#depositSection,#log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.company div { flex:1; }
button { padding:5px 10px; cursor:pointer; margin-top:4px; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }

/* ê´€ë¦¬ì ëª¨ë‹¬ */
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModalContent { background:#1f2937; padding:20px; border-radius:10px; width:500px; max-height:90%; overflow:auto; position:relative; }
#adminModalContent h2 { margin-top:0; }
.tab-buttons { display:flex; gap:10px; margin-bottom:10px; }
.tab-buttons button { flex:1; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.requestBox { margin-bottom:10px; padding:10px; background:#111827; border-radius:6px; }
#adminModalContent .closeBtn { position:absolute; top:10px; right:10px; background:none; border:none; color:#e5e7eb; font-size:18px; cursor:pointer; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>
<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥">
  <input type="number" id="depositAmount" placeholder="ê¸ˆì•¡ ì…ë ¥">
  <button id="depositBtn">ì¶”ê°€ ìš”ì²­</button>
</div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
  <button onclick="checkAdminCode()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal">
  <div id="adminModalContent">
    <button class="closeBtn" onclick="closeAdminModal()">âœ–</button>
    <h2>ê´€ë¦¬ì ë©”ë‰´</h2>
    <div class="tab-buttons">
      <button onclick="showTab('requests')">ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</button>
      <button onclick="showTab('commands')">ê·¸ë˜í”„ ì œì–´</button>
    </div>

    <!-- ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬ -->
    <div id="tab-requests" class="tab-content active">
      <h3>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h3>
      <div id="requestsList"></div>
    </div>

    <!-- ê·¸ë˜í”„ ì œì–´ -->
    <div id="tab-commands" class="tab-content">
      <h3>ê·¸ë˜í”„ ì œì–´ ëª…ë ¹ì–´</h3>
      <input type="text" id="adminCommand" placeholder="start / stop / speed 2000 / range 2 / reset">
      <button onclick="runAdminCommand()">ëª…ë ¹ ì‹¤í–‰</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000] },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ", price:500, history:[500] },
  { name:"ì‚¬ì¿ ë¼", price:500, history:[500] },
  { name:"ì²­ë£¡", price:500, history:[500] },
  { name:"ê²½ì°°ì²­", price:500, history:[500] },
  { name:"EMS", price:500, history:[500] },
  { name:"ì˜¬ë“œë³´ì´", price:500, history:[500] },
  { name:"ì‘ë‘", price:800, history:[800] }
];

// ìë™ ê·¸ë˜í”„ ì œì–´ ë³€ìˆ˜
let autoInterval = null;
let updateSpeed = 3000;   // ê¸°ë³¸ 3ì´ˆ
let changeRange = 0.05;   // ê¸°ë³¸ Â±5%

// ğŸ”¥ ê·¸ë˜í”„ ì´ˆê¸°í™”
async function resetAllCompanies(){
  for(const c of companies){
    const ref = doc(db,"companies",c.name);
    await updateDoc(ref, { price:c.price, history:[c.price] });
  }
  log("ğŸ”„ ëª¨ë“  íšŒì‚¬ ê·¸ë˜í”„ ì´ˆê¸°í™” ì™„ë£Œ");
}

// ìë™ ê°€ê²© ë³€ë™
async function autoUpdatePrice(companyName) {
  const ref = doc(db,"companies",companyName);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const data = snap.data();
    const changeRate = (Math.random() * (2*changeRange) - changeRange); 
    const newPrice = Math.max(100, Math.round(data.price * (1 + changeRate)));
    const newHistory = [...data.history, newPrice];
    await updateDoc(ref, { price:newPrice, history:newHistory });
  }
}

// ì‹œì‘/ë©ˆì¶¤
window.startAutoGraph=function(){
  if(autoInterval) return;
  autoInterval = setInterval(()=>{
    companies.forEach(c=>autoUpdatePrice(c.name));
  }, updateSpeed);
  log("âš¡ ìë™ ê·¸ë˜í”„ ì‹œì‘");
};
window.stopAutoGraph=function(){
  if(autoInterval){ clearInterval(autoInterval); autoInterval = null; }
  log("â¹ ìë™ ê·¸ë˜í”„ ë©ˆì¶¤");
};

// ê´€ë¦¬ì ëª…ë ¹ì–´ ì‹¤í–‰
window.runAdminCommand = async function(){
  const cmd = document.getElementById("adminCommand").value.trim().toLowerCase();
  const parts = cmd.split(" ");
  if(parts[0] === "start"){ startAutoGraph(); }
  else if(parts[0] === "stop"){ stopAutoGraph(); }
  else if(parts[0] === "speed" && parts[1]){
    const val = parseInt(parts[1],10);
    if(!isNaN(val) && val>500){
      updateSpeed = val;
      if(autoInterval){ stopAutoGraph(); startAutoGraph(); }
      log(`â± ì£¼ê¸° ë³€ê²½: ${updateSpeed}ms`);
    }
  }
  else if(parts[0] === "range" && parts[1]){
    const val = parseFloat(parts[1]);
    if(!isNaN(val) && val>0){
      changeRange = val/100;
      log(`ğŸ“Š ë³€ë™í­ ë³€ê²½: Â±${val}%`);
    }
  }
  else if(parts[0] === "reset"){ await resetAllCompanies(); }
  else { alert("ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤."); }
  document.getElementById("adminCommand").value="";
};

// ğŸ”§ ê´€ë¦¬ì ëª¨ë‹¬ ê´€ë ¨
window.checkAdminCode=function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code==="ADMIN123"){
    loadDepositRequests();
    document.getElementById("adminModal").style.display="flex";
    showTab('requests');
  }
};
window.closeAdminModal=function(){ document.getElementById("adminModal").style.display="none"; };
window.showTab=function(tab){
  document.getElementById("tab-requests").classList.remove("active");
  document.getElementById("tab-commands").classList.remove("active");
  document.getElementById("tab-"+tab).classList.add("active");
};

// ğŸ”§ ë‚˜ë¨¸ì§€ í•¨ìˆ˜ (ë Œë”ë§, ìœ ì €, ì…ê¸ˆìš”ì²­ ë“±)
// ... (ìƒëµ: ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤)
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }
</script>
</body>
</html>
