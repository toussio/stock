<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
/* --- ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ --- */
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userInfo,#depositSection,#log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.company div { flex:1; }
button { padding:5px 10px; cursor:pointer; margin-top:4px; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModalContent { background:#1f2937; padding:20px; border-radius:10px; width:520px; max-height:85%; overflow:auto; position:relative; }
#adminModalContent h2 { margin:10px 0; }
.requestBox { margin-bottom:10px; padding:10px; background:#111827; border-radius:6px; }
#adminModalContent .closeBtn { position:absolute; top:10px; right:10px; background:none; border:none; color:#e5e7eb; font-size:18px; cursor:pointer; }
.graphRow { display:flex; align-items:center; gap:8px; padding:8px; background:#111827; border-radius:6px; margin-bottom:8px; }
.graphRow .name { width:110px; font-weight:bold; }
.graphRow input[type="number"] { width:80px; padding:4px; text-align:right; }
.graphControls { display:flex; gap:8px; margin:8px 0 12px; }
.small { font-size:12px; color:#9ca3af; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>
<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥">
  <input type="number" id="depositAmount" placeholder="ê¸ˆì•¡ ì…ë ¥">
  <button id="depositBtn">ì¶”ê°€ ìš”ì²­</button>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ (ADMIN123 / GRAPHSTART / GRAPHSTOP)">
  <button onclick="checkAdminCode()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal">
  <div id="adminModalContent">
    <button class="closeBtn" onclick="closeAdminModal()">âœ–</button>
    <h2>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h2>
    <div id="requestsList"></div>
    <hr>
    <h2>ê·¸ë˜í”„ ì œì–´</h2>
    <div class="graphControls">
      <button onclick="startCentralUpdates()">ì‹œì‘</button>
      <button onclick="stopCentralUpdates()">ì¤‘ì§€</button>
    </div>
    <div id="graphControl"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = { /* ğŸ”‘ Firebase ê°’ ì…ë ¥ */ };
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let player={ holdings:{}, cash:5000000 };
let currentUser=null;
let chart, chartInited=false;
let timer=null; let isGraphMaster=false;

// multiplier ì¶”ê°€
let companies=[
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000], multiplier:1.0 },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ",   price:500,  history:[500],  multiplier:1.5 },
  { name:"ì‚¬ì¿ ë¼",     price:500,  history:[500],  multiplier:0.8 },
  { name:"ì²­ë£¡",       price:500,  history:[500],  multiplier:2.0 },
  { name:"ê²½ì°°ì²­",     price:500,  history:[500],  multiplier:1.2 },
  { name:"EMS",        price:500,  history:[500],  multiplier:0.6 },
  { name:"ì˜¬ë“œë³´ì´",   price:500,  history:[500],  multiplier:1.8 },
  { name:"ì‘ë‘",       price:800,  history:[800],  multiplier:1.0 }
];

/* --- ì¤‘ì•™ ê°€ê²© ê°±ì‹  --- */
async function updateAllCompanies(){
  for(const c of companies){
    const ref=doc(db,"companies",c.name);
    const snap=await getDoc(ref);
    if(snap.exists()){
      const data=snap.data();
      const shock=(Math.random()-0.5)*0.1;
      const newPrice=Math.max(1, Math.floor(data.price*(1+shock*(c.multiplier||1))));
      const newHistory=[...(data.history||[]), newPrice];
      await updateDoc(ref,{ price:newPrice, history:newHistory });
    }
  }
}
function startCentralUpdates(){
  if(isGraphMaster) return;
  isGraphMaster=true;
  timer=setInterval(updateAllCompanies,5000);
  alert("ì¤‘ì•™ ëœë¤ ë³€ë™ ì‹œì‘");
}
function stopCentralUpdates(){
  clearInterval(timer); timer=null; isGraphMaster=false;
  alert("ì¤‘ì•™ ëœë¤ ë³€ë™ ì¤‘ì§€");
}

/* --- ê¸°ì—… êµ¬ë… (ëª¨ë“  ìœ ì € ë™ì¼) --- */
function subscribeCompanies(){
  companies.forEach(c=>{
    onSnapshot(doc(db,"companies",c.name),(snap)=>{
      if(snap.exists()){
        const data=snap.data();
        c.price=data.price; c.history=data.history;
        const priceEl=document.getElementById(`price-${c.name}`);
        if(priceEl) priceEl.textContent=c.price.toLocaleString();
        updateChart();
      }
    });
  });
}

/* --- ê´€ë¦¬ì ëª¨ë‹¬ multiplier ì¡°ì • --- */
function renderGraphControlPanel(){
  const panel=document.getElementById("graphControl");
  panel.innerHTML="";
  companies.forEach(c=>{
    const row=document.createElement("div");
    row.className="graphRow";
    row.innerHTML=`
      <span class="name">${c.name}</span>
      multiplier: <input type="number" id="multi-${c.name}" value="${c.multiplier}" step="0.1">
      <button onclick="saveMultiplier('${c.name}')">ì €ì¥</button>
    `;
    panel.appendChild(row);
  });
}
window.saveMultiplier=async function(name){
  const input=document.getElementById(`multi-${name}`);
  const val=parseFloat(input.value);
  if(val<=0){ alert("0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤"); return; }
  companies.find(c=>c.name===name).multiplier=val;
  await updateDoc(doc(db,"companies",name),{ multiplier:val });
  alert(`${name} multiplier ì €ì¥ë¨: ${val}`);
}

/* --- ê´€ë¦¬ì ì½”ë“œ --- */
window.checkAdminCode=function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code==="ADMIN123"){
    renderGraphControlPanel();
    document.getElementById("adminModal").style.display="flex";
  } else if(code==="GRAPHSTART"){ startCentralUpdates(); }
  else if(code==="GRAPHSTOP"){ stopCentralUpdates(); }
}
window.closeAdminModal=function(){ document.getElementById("adminModal").style.display="none"; }

/* --- ì°¨íŠ¸ --- */
function ensureChart(){
  if(chartInited) return;
  const ctx=document.getElementById('chart').getContext('2d');
  chart=new Chart(ctx,{ type:'line',
    data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:c.history,
      borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false}))},
    options:{ responsive:true, animation:false,
      scales:{ x:{title:{display:true,text:"í‹±"}}, y:{title:{display:true,text:"ê°€ê²©(KRW)"}}}}
  });
  chartInited=true;
}
function updateChart(){
  if(!chartInited) return;
  const maxLen=Math.max(...companies.map(c=>c.history.length));
  chart.data.labels=Array.from({length:maxLen},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}
</script>
</body>
</html>
