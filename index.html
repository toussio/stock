<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
h1 { text-align: center; }
#userInfo, #log { margin: 20px auto; max-width: 800px; }
#companies {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin: 20px auto; max-width: 800px;
}
.company {
  padding: 10px; background: #1f2937; border-radius: 8px;
  display: flex; justify-content: space-between; align-items: center; gap: 10px;
}
button { padding: 5px 10px; cursor: pointer; }
#log { max-height: 220px; overflow-y: auto; background: #111827; padding: 10px; border-radius: 8px; }
canvas { background: #111827; border-radius: 8px; display: block; margin: 20px auto; }
#loginModal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
#loginModalContent { background: #1f2937; padding: 20px; border-radius: 10px; text-align: center; }
#loginModal input { margin: 10px 0; padding: 5px; width: 80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<div id="userInfo"></div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>거래 시작 전 정보 입력</h2>
    <input type="text" id="userId" placeholder="고유번호 입력" /><br>
    <input type="text" id="userName" placeholder="이름 입력" /><br>
    <button id="startBtn">시작</button>
  </div>
</div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력">
  <button onclick="checkAdminCode()">실행</button>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (ES Module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
    authDomain: "cotyledons-of-stock.firebaseapp.com",
    projectId: "cotyledons-of-stock",
    storageBucket: "cotyledons-of-stock.appspot.com",
    messagingSenderId: "343488842605",
    appId: "1:343488842605:web:f4c1205568f5994d55e864",
    measurementId: "G-YB960D84W4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  signInAnonymously(auth).then(()=>console.log("익명 로그인 성공"));

  let player = { holdings: {}, cash: 5000000 };
  let currentUser = null;
  let chart;
  let tradeLog = [];
  let depositRequests = []; // 보류중인 입금 요청

  const companies = [
    { name: "떡잎방범대", price: 1000, history: [1000] },
    { name: "카스틸로", price: 500, history: [500] },
    { name: "사쿠라", price: 500, history: [500] },
    { name: "청룡", price: 500, history: [500] },
    { name: "경찰청", price: 500, history: [500] },
    { name: "EMS", price: 500, history: [500] },
    { name: "올드보이", price: 500, history: [500] },
    { name: "작두", price: 800, history: [800] }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    const loginModal = document.getElementById('loginModal');
    const startBtn = document.getElementById('startBtn');
    const ctx = document.getElementById('chart').getContext('2d');

    chart = new Chart(ctx,{
      type:'line',
      data:{
        labels:[0],
        datasets:companies.map(c=>({
          label:c.name,
          data:c.history,
          borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
          fill:false
        }))
      },
      options:{responsive:true,scales:{
        x:{ title:{display:true,text:'틱'} },
        y:{ title:{display:true,text:'가격(KRW)'}}
      }}
    });

    loginModal.style.display = 'flex';
    startBtn.addEventListener("click", () => {
      const userId = document.getElementById('userId').value.trim();
      const userName = document.getElementById('userName').value.trim();
      if (!userId || !userName) {
        alert("고유번호와 이름을 모두 입력해주세요."); return;
      }
      currentUser = { id: userId, name: userName };
      loginModal.style.display = "none";
      renderUserInfo();
      renderCompanies();
    });
  });

  function renderUserInfo(){
    document.getElementById('userInfo').innerHTML = `
      <strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> | 
      현금: ${player.cash.toLocaleString()} KRW
      <div style="margin-top:10px;">
        <input type="text" id="accountNumber" placeholder="계좌번호 입력">
        <input type="number" id="depositAmount" placeholder="금액 입력">
        <button onclick="requestDeposit()">추가 요청</button>
      </div>
    `;
  }

  function requestDeposit(){
    const acc = document.getElementById("accountNumber").value.trim();
    const amt = parseInt(document.getElementById("depositAmount").value.trim());
    if(!acc || !amt || amt<=0){
      alert("계좌번호와 금액을 올바르게 입력해주세요."); return;
    }
    depositRequests.push({userId: currentUser.id, userName: currentUser.name, account: acc, amount: amt});
    alert("추가 요청이 접수되었습니다. 관리자의 승인을 기다려주세요.");
    document.getElementById("accountNumber").value="";
    document.getElementById("depositAmount").value="";
  }

  function log(msg){ const l=document.getElementById('log'); l.innerHTML = `<div>${msg}</div>`+l.innerHTML; }

  async function saveTrade(type, company, qty, price, cashAfter) {
    if(!currentUser) return;
    const now = new Date().toLocaleString();
    tradeLog.push({date: now, userId: currentUser.id, userName: currentUser.name,
                   type, company, qty, price, cash: cashAfter});
    await addDoc(collection(db, "trades"), {
      userId: currentUser.id, userName: currentUser.name,
      type, company, qty, price, cashAfter, createdAt: serverTimestamp()
    });
  }

  window.buy = function(name, qty){
    const c = companies.find(x=>x.name===name);
    if(player.cash < c.price*qty){ alert('현금 부족'); return; }
    player.cash -= c.price*qty;
    player.holdings[name] = (player.holdings[name]||0)+qty;
    log(`✅ ${currentUser.name} ${name} ${qty}주 매수 @ ${c.price}`);
    saveTrade("매수", name, qty, c.price, player.cash);
    renderCompanies();
  }

  window.sell = function(name, qty){
    const c = companies.find(x=>x.name===name);
    if((player.holdings[name]||0)<qty){ alert('보유 주식 부족'); return; }
    player.cash += c.price*qty;
    player.holdings[name]-=qty;
    log(`✅ ${currentUser.name} ${name} ${qty}주 매도 @ ${c.price}`);
    saveTrade("매도", name, qty, c.price, player.cash);
    renderCompanies();
  }

  function updatePrices(){
    companies.forEach(c=>{
      const shock = (Math.random()-0.5)*0.1;
      c.price = Math.max(1, Math.floor(c.price*(1+shock)));
      c.history.push(c.price);
    });
    renderCompanies();
  }
  setInterval(updatePrices,5000);

  function updateChart(){
    if(!chart) return;
    chart.data.labels=Array.from({length:companies[0].history.length},(_,i)=>i);
    chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
    chart.update();
  }

  // 관리자 코드 실행
  window.checkAdminCode = function(){
    const code=document.getElementById("adminCode").value.trim();

    if(code==="ADMIN123"){
      if(tradeLog.length===0){ alert("거래 기록이 없습니다."); return; }
      const sortedLog = [...tradeLog].sort((a,b)=> new Date(b.date)-new Date(a.date));
      let csv = "날짜,고유번호,이름,타입,기업,가격,수량,현금\n";
      sortedLog.forEach(t=>{
        csv += `${t.date},${t.userId},${t.userName},${t.type},${t.company},${t.price},${t.qty},${t.cash}\n`;
      });
      const bom=new Uint8Array([0xEF,0xBB,0xBF]);
      const blob=new Blob([bom,csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`trade_log_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      alert("엑셀 파일이 다운로드 되었습니다.");
    }

    else if(code==="RESET123"){
      companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
      updateChart(); renderCompanies();
      alert("기업 가격/그래프가 초기화 되었습니다.");
    }

    else if(code==="RESETALL"){
      player={ holdings:{}, cash:5000000 };
      companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
      currentUser=null;
      document.getElementById('loginModal').style.display="flex";
      updateChart(); renderCompanies();
      alert("모든 데이터가 초기화 되었습니다. (다시 로그인 필요)");
    }

    else if(code==="APPROVE123"){
      if(depositRequests.length===0){ alert("승인 대기중인 요청이 없습니다."); return; }
      depositRequests.forEach(req=>{
        if(currentUser && req.userId===currentUser.id){
          player.cash += req.amount;
          log(`💰 관리자 승인: ${req.userName}(${req.userId}) 계좌 ${req.account} → ${req.amount} KRW 입금 완료`);
        }
      });
      depositRequests = [];
      renderUserInfo();
      alert("요청된 금액이 승인되었습니다.");
    }

    else {
      alert("잘못된 코드입니다.");
    }
  }
</script>
</body>
</html>
