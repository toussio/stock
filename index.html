<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:5px 10px; cursor:pointer; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
/* ê´€ë¦¬ì */
#adminSection { text-align:center; margin-top:20px; }
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModal .panel { background:#1f2937; padding:20px; border-radius:10px; width:650px; max-height:90%; overflow:auto; position:relative; }
#adminModal .panel .close { position:absolute; top:10px; right:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #444; padding:6px; text-align:center; }
th { background:#374151; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userRow">
  <div id="userInfo"></div>
  <div>
    <input id="acctNo" type="text" placeholder="ê³„ì¢Œë²ˆí˜¸" />
    <input id="cashAmount" type="number" placeholder="ê¸ˆì•¡" />
    <input id="cashMemo" type="text" placeholder="ë©”ëª¨(ì„ íƒ)" />
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br/>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br/>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥" />
  <button onclick="openAdminPanel()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal">
  <div class="panel">
    <button class="close" onclick="closeAdminPanel()">âœ–</button>
    <h2>ê´€ë¦¬ì ë©”ë‰´</h2>

    <h3>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h3>
    <div id="requestsList"></div>

    <hr style="margin:20px 0;" />

    <h3>ê·¸ë˜í”„ ì œì–´</h3>
    <button onclick="startAutoGraph()">ìë™ ì‹œì‘</button>
    <button onclick="stopAutoGraph()">ìë™ ë©ˆì¶¤</button>
    <button onclick="resetGraphAndPrice()">ê·¸ë˜í”„+ê°€ê²© ì´ˆê¸°í™”</button>
    <div style="margin-top:10px;">
      <label>ì†ë„(ms): <input type="number" id="graphSpeed" value="5000" style="width:100px;" /></label>
      <button onclick="applyGraphConfig()">ì ìš©</button>
    </div>

    <hr style="margin:20px 0;" />

    <h3>ê¸°ì—…ë³„ ì‹œì‘ê°€ & ë³€ë™í­ ì„¤ì •</h3>
    <table>
      <thead>
        <tr><th>ê¸°ì—…ëª…</th><th>ì‹œì‘ê°€</th><th>ë³€ë™í­(%)</th></tr>
      </thead>
      <tbody id="companySettingsBody"></tbody>
    </table>
    <button onclick="applyCompanySettings()">ì €ì¥ & ì ìš©</button>

    <hr style="margin:20px 0;" />

    <h3>ë°ì´í„° ì •ë¦¬</h3>
    <button onclick="cleanupHistories()">ê¸°ì—…ë³„ íˆìŠ¤í† ë¦¬ ì •ë¦¬ (ìµœê·¼ 20ê°œë§Œ ìœ ì§€)</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ìƒíƒœ */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

/* ê¸°ì—… ê¸°ë³¸ê°’ */
let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000], range:0.05 },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ", price:500, history:[500], range:0.05 },
  { name:"ì‚¬ì¿ ë¼", price:500, history:[500], range:0.05 },
  { name:"ì²­ë£¡", price:500, history:[500], range:0.05 },
  { name:"ê²½ì°°ì²­", price:500, history:[500], range:0.05 },
  { name:"EMS", price:500, history:[500], range:0.05 },
  { name:"ì˜¬ë“œë³´ì´", price:500, history:[500], range:0.05 },
  { name:"ì‘ë‘", price:800, history:[800], range:0.05 }
];

/* ì„¤ì • */
const BASE_VOLUME = 1000;
const IMPACT = 0.02;
const MAX_HISTORY = 20;   // âœ… ìµœê·¼ 20ê°œë§Œ ìœ ì§€

/* localStorage */
function saveUser(u){ localStorage.setItem("stockUser", JSON.stringify(u)); }
function loadUser(){ try { return JSON.parse(localStorage.getItem("stockUser")); } catch(e){ return null; } }
function clearUser(){ localStorage.removeItem("stockUser"); }

/* ë¡œê·¸ */
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

/* ë¡œê·¸ì¸ */
async function loginUser(userId,userName){
  const userRef=doc(db,"users",userId);   // âœ… users ì»¬ë ‰ì…˜
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    player={ cash:data.cash??5000000, holdings:data.holdings??{} };
  } else {
    await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
    player={ cash:5000000, holdings:{} };
  }
  currentUser={ id:userId, name:userName };
  saveUser(currentUser);
  renderUserInfo(); renderCompanies();
}
document.getElementById("startBtn").addEventListener("click", async ()=>{
  const uid=document.getElementById("userId").value.trim();
  const uname=document.getElementById("userName").value.trim();
  if(!uid||!uname){ alert("ì…ë ¥í•„ìš”"); return; }
  await loginUser(uid,uname);
  document.getElementById("loginModal").style.display="none";
});
document.addEventListener("DOMContentLoaded", async ()=>{
  const saved = loadUser();
  if(saved && saved.id && saved.name){
    await loginUser(saved.id, saved.name);
    document.getElementById("loginModal").style.display="none";
    log("ğŸ”“ ìë™ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
  } else {
    document.getElementById("loginModal").style.display="flex";
  }
});

/* --- ì´í•˜ ë§¤ìˆ˜/ë§¤ë„, depositRequests, adminPanel, chart update ì½”ë“œ ë™ì¼ (MAX_HISTORY=20 ë°˜ì˜ë¨) --- */
</script>
</body>
</html>
