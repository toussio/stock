<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1{text-align:center;} #userRow,#log{margin:20px auto; max-width:800px;}
#userRow{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;justify-content:space-between;}
#userInfo{font-size:16px;} #depositForm{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
#depositForm input{padding:6px;} #depositForm .memo{min-width:200px;}
#companies{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:20px auto;max-width:800px;}
.company{padding:10px;background:#1f2937;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
.company .left{display:flex;flex-direction:column;gap:6px;} .company .actions{display:flex;gap:6px;align-items:center;}
button{padding:5px 10px;cursor:pointer;} #log{max-height:220px;overflow-y:auto;background:#111827;padding:10px;border-radius:8px;}
canvas{background:#111827;border-radius:8px;display:block;margin:20px auto;}
#downloadSection{text-align:center;margin-top:20px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
#downloadSection input{padding:5px;} #adminQueue{max-width:800px;margin:14px auto 0;display:none;}
#adminQueue.active{display:block;} .req-card{background:#1f2937;border-radius:8px;padding:10px;margin:8px 0;
display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;}
.req-meta{font-size:12px;opacity:.9;} .req-actions button{margin-left:6px;}
.badge{padding:2px 6px;border-radius:6px;font-size:12px;} .badge.wait{background:#374151;}
.badge.approved{background:#065f46;} .badge.rejected{background:#7f1d1d;}
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userRow">
  <div id="userInfo">â³ ë¡œê·¸ì¸ ì¤‘...</div>
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<div id="downloadSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ (ADMIN123)" />
  <button onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="toggleAdminQueue()">ìŠ¹ì¸ ëŒ€ê¸°í•¨ ì—´ê¸°</button>
</div>

<div id="adminQueue">
  <h3>ì…ê¸ˆ ìŠ¹ì¸ ëŒ€ê¸°í•¨</h3>
  <div id="queueList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- âœ… Firebase ì´ˆê¸°í™” & Firestore + Auth -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, setDoc } 
    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
    authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
    projectId: "cotyledons-of-stock-a1241",
    storageBucket: "cotyledons-of-stock-a1241.appspot.com",
    messagingSenderId: "962984742513",
    appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
    measurementId: "G-NRPT075Q3X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let player = { holdings: {}, cash: 5000000 };
  let currentUser = null;
  let pendingDeposits = [];

  /* ===== ìµëª… ë¡œê·¸ì¸ ===== */
  signInAnonymously(auth).catch(err => console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", err));

  onAuthStateChanged(auth, async (user) => {
    if(user){
      currentUser = { id: user.uid, name: "ìµëª…ìœ ì €", cash: player.cash };
      // users ì»¬ë ‰ì…˜ì— ì €ì¥
      await setDoc(doc(db,"users",user.uid),{
        id: user.uid, name:"ìµëª…ìœ ì €", cash: player.cash, createdAt:new Date()
      });
      renderUserInfo(); renderCompanies(); startAuto(); listenDeposits();
      log(`âœ… ìµëª… ë¡œê·¸ì¸: ${user.uid}`);
    } else {
      document.getElementById("userInfo").innerText="âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨";
    }
  });

  /* ===== ìœ í‹¸ ===== */
  function log(msg){ document.getElementById('log').innerHTML = `<div>${msg}</div>`+document.getElementById('log').innerHTML; }
  function renderUserInfo(){ 
    if(currentUser) document.getElementById('userInfo').innerHTML = `<strong>${currentUser.name}(${currentUser.id})</strong> | í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW`; 
  }

  /* ===== ê±°ë˜ ë¡œê·¸ ì €ì¥ ===== */
  async function saveTradeLog(entry){ await addDoc(collection(db,"tradeLogs"), entry); }

  /* ===== ì…ê¸ˆ ===== */
  async function requestDeposit(){
    if(!currentUser){ alert("ë¡œê·¸ì¸ í•„ìš”"); return; }
    const acct=acctNo.value.trim(); const amount=parseInt(cashAmount.value.replace(/[^0-9]/g,''))||0; const memo=cashMemo.value.trim();
    if(!acct||amount<=0){ alert("ì˜ëª»ëœ ì…ë ¥"); return; }
    const req={id:"REQ-"+Date.now(), date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, acct, amount, memo, status:"ëŒ€ê¸°"};
    await addDoc(collection(db,"pendingDeposits"), req);
    log(`ğŸ“¨ ì…ê¸ˆ ìš”ì²­: ${amount.toLocaleString()} KRW`);
    acctNo.value=""; cashAmount.value=""; cashMemo.value="";
  }
  function listenDeposits(){ onSnapshot(collection(db,"pendingDeposits"), snap=>{ pendingDeposits=[]; snap.forEach(d=>pendingDeposits.push(d.data())); renderQueue(); }); }

  async function approveDeposit(id){
    const q=await getDocs(collection(db,"pendingDeposits"));
    q.forEach(async d=>{ const data=d.data();
      if(data.id===id && data.status==="ëŒ€ê¸°"){
        await updateDoc(doc(db,"pendingDeposits",d.id), {status:"ìŠ¹ì¸"});
        player.cash+=data.amount; await updateDoc(doc(db,"users",data.userId), {cash:player.cash});
        const entry={date:new Date().toLocaleString(), userId:data.userId, userName:data.userName, type:"ì…ê¸ˆìŠ¹ì¸", company:"í˜„ê¸ˆ", qty:0, price:0, amount:data.amount, cash:player.cash};
        await saveTradeLog(entry); renderUserInfo(); log(`âœ… ì…ê¸ˆ ìŠ¹ì¸: ${data.amount.toLocaleString()} KRW`);
      }
    });
  }
  async function rejectDeposit(id){
    const q=await getDocs(collection(db,"pendingDeposits"));
    q.forEach(async d=>{ const data=d.data();
      if(data.id===id && data.status==="ëŒ€ê¸°"){
        await updateDoc(doc(db,"pendingDeposits",d.id), {status:"ê±°ì ˆ"});
        const entry={date:new Date().toLocaleString(), userId:data.userId, userName:data.userName, type:"ì…ê¸ˆê±°ì ˆ", company:"í˜„ê¸ˆ", qty:0, price:0, amount:data.amount, cash:player.cash};
        await saveTradeLog(entry); log(`â›” ì…ê¸ˆ ê±°ì ˆ: ${data.amount.toLocaleString()} KRW`);
      }
    });
  }

  /* ===== ë§¤ìˆ˜/ë§¤ë„ ===== */
  function buy(name, qty){
    const c=companies.find(x=>x.name===name); if(player.cash<c.price*qty){alert("í˜„ê¸ˆ ë¶€ì¡±"); return;}
    player.cash-=c.price*qty; player.holdings[name]=(player.holdings[name]||0)+qty;
    const entry={date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, type:"ë§¤ìˆ˜", company:name, qty, price:c.price, amount:c.price*qty, cash:player.cash};
    saveTradeLog(entry); log(`âœ… ë§¤ìˆ˜: ${name} ${qty}ì£¼ @ ${c.price}`); renderCompanies();
  }
  function sell(name, qty){
    const c=companies.find(x=>x.name===name); if((player.holdings[name]||0)<qty){alert("ë³´ìœ  ë¶€ì¡±"); return;}
    player.cash+=c.price*qty; player.holdings[name]-=qty;
    const entry={date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, type:"ë§¤ë„", company:name, qty, price:c.price, amount:c.price*qty, cash:player.cash};
    saveTradeLog(entry); log(`âœ… ë§¤ë„: ${name} ${qty}ì£¼ @ ${c.price}`); renderCompanies();
  }

  /* ===== ì¢…ëª©/ì°¨íŠ¸ ===== */
  const companies=[
    {name:"ë–¡ìë°©ë²”ëŒ€",price:10000000,history:[1000],cfg:{vol:0.03,drift:0.002,jumpProb:0.01,jumpVol:0.10,min:1}},
    {name:"ì¹´ìŠ¤í‹¸ë¡œ",price:5000000,history:[500],cfg:{vol:0.06,drift:-0.001,jumpProb:0.02,jumpVol:0.20,min:1}},
    {name:"ì‚¬ì¿ ë¼",price:6500000,history:[500],cfg:{vol:0.04,drift:0.000,jumpProb:0.00,jumpVol:0.00,min:1}}
  ];
  function renderCompanies(){ const ctn=document.getElementById("companies"); ctn.innerHTML=""; companies.forEach(c=>{const held=player.holdings[c.name]||0; const div=document.createElement("div"); div.className="company"; div.innerHTML=`<div class="left"><strong>${c.name}</strong> ${c.price.toLocaleString()} KRW | ë³´ìœ : ${held}ì£¼</div><div class="actions"><button onclick="buy('${c.name}',1)">ë§¤ìˆ˜</button><button onclick="sell('${c.name}',1)">ë§¤ë„</button></div>`; ctn.appendChild(div);}); renderUserInfo();}
  function startAuto(){ setInterval(()=>{companies.forEach(c=>{let shock=(Math.random()*2-1)*c.cfg.vol+c.cfg.drift; if(Math.random()<c.cfg.jumpProb)shock+=(Math.random()*2-1)*c.cfg.jumpVol; c.price=Math.max(c.cfg.min,Math.floor(c.price*(1+shock))); c.history.push(c.price);}); renderCompanies();},5000);}
</script>
</body>
</html>
