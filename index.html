<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:5px 10px; cursor:pointer; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„° (Firestore ì—°ë™)</h1>

<div id="userRow">
  <div id="userInfo"></div>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br/>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br/>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  initializeFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* ğŸ”‘ Firebase ì„¤ì • (consoleì—ì„œ CDN ê°’ ë³µì‚¬) */
const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",   // âœ… ê¼­ appspot.com
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:c5dcbfcd64dacf9955e864",
  measurementId: "G-QWBTK3MQG8"
};

const app = initializeApp(firebaseConfig);

/* âœ… WebChannel 400 ì—ëŸ¬ ë°©ì§€ */
const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ìƒíƒœ */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

/* ê¸°ì—… ì´ˆê¸°ê°’ */
let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000], range:0.05 },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ", price:500, history:[500], range:0.05 },
  { name:"ì‚¬ì¿ ë¼", price:500, history:[500], range:0.05 },
  { name:"ì²­ë£¡", price:500, history:[500], range:0.05 }
];

/* ë¡œê·¸ */
function log(msg){ const l=document.getElementById("log"); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

/* Firestore ì—°ê²° í…ŒìŠ¤íŠ¸ */
async function testFirestore(){
  try {
    const ref = doc(db, "_health", "ping");
    await setDoc(ref, { last: serverTimestamp() }, { merge:true });
    const snap = await getDoc(ref);
    if(snap.exists()){
      log("âœ… Firestore ì—°ê²° ì„±ê³µ: " + JSON.stringify(snap.data()));
    } else {
      log("âŒ Firestore ì—°ê²° ì‹¤íŒ¨ (ë¬¸ì„œ ì—†ìŒ)");
    }
  } catch(e){
    log("âŒ Firestore ì˜¤ë¥˜: " + e.message);
    console.error(e);
  }
}
testFirestore();

/* ë¡œê·¸ì¸ */
async function loginUser(userId,userName){
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    player={ cash:data.cash??5000000, holdings:data.holdings??{} };
  } else {
    await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
  }
  currentUser={ id:userId, name:userName };
  renderUserInfo(); renderCompanies();
  log(`ğŸ‘¤ ë¡œê·¸ì¸: ${userName}(${userId})`);
}

/* UI */
function renderUserInfo(){
  document.getElementById("userInfo").innerHTML =
    `<strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> |
     í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW`;
}
function renderCompanies(){
  const container=document.getElementById("companies");
  container.innerHTML="";
  companies.forEach(c=>{
    const held=player.holdings[c.name]||0;
    const div=document.createElement("div");
    div.className="company";
    div.innerHTML=`
      <div>
        <strong>${c.name}</strong><br/>
        ê°€ê²©: <span id="price-${c.name}">${c.price.toLocaleString()}</span> KRW<br/>
        ë³´ìœ : ${held}ì£¼
      </div>
      <div>
        <input type="number" id="qty-${c.name}" value="1" min="1" style="width:60px;">
        <button onclick="buy('${c.name}')">ë§¤ìˆ˜</button>
        <button onclick="sell('${c.name}')">ë§¤ë„</button>
      </div>`;
    container.appendChild(div);
  });
  updateChart();
}

/* ê±°ë˜ */
window.buy=async function(name){
  const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
  const c=companies.find(x=>x.name===name);
  if(player.cash<c.price*qty){ alert("í˜„ê¸ˆ ë¶€ì¡±"); return; }
  player.cash-=c.price*qty;
  player.holdings[name]=(player.holdings[name]||0)+qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price}`);
  await updateDoc(doc(db,"users",currentUser.id),{ cash:player.cash, holdings:player.holdings });
  renderCompanies();
};
window.sell=async function(name){
  const qty=parseInt(document.getElementById(`qty-${name}`).value,10)||1;
  const c=companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<qty){ alert("ë³´ìœ  ë¶€ì¡±"); return; }
  player.cash+=c.price*qty;
  player.holdings[name]-=qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price}`);
  await updateDoc(doc(db,"users",currentUser.id),{ cash:player.cash, holdings:player.holdings });
  renderCompanies();
};

/* ì°¨íŠ¸ */
const ctx=document.getElementById("chart").getContext("2d");
chart=new Chart(ctx,{
  type:"line",
  data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:c.history,
    borderColor:"#"+Math.floor(Math.random()*16777215).toString(16), fill:false})) },
  options:{ responsive:true, scales:{ x:{title:{display:true,text:"í‹±"}}, y:{title:{display:true,text:"ê°€ê²©"}} } }
});
function updateChart(){
  chart.data.labels=Array.from({length:companies[0].history.length},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

/* ì‹œì‘ ë²„íŠ¼ */
document.getElementById("startBtn").addEventListener("click", async ()=>{
  const uid=document.getElementById("userId").value.trim();
  const uname=document.getElementById("userName").value.trim();
  if(!uid||!uname){ alert("ì…ë ¥ í•„ìš”"); return; }
  await loginUser(uid,uname);
  document.getElementById("loginModal").style.display="none";
});
</script>
</body>
</html>
