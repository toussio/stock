<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46; --warn:#92400e;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1100px; }
    #depositForm input { padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    #depositForm .memo { min-width:220px; }
    #depositForm button#requestDepositBtn { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    #depositForm button#requestDepositBtn:hover { background:var(--accentH); }

    button { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #chartWrap { position:relative; margin:20px auto; max-width:1100px; height:400px; background:#111827; border-radius:10px; overflow:hidden; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1100px; }
    .company { background:var(--card); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; position:relative; }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:600; }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    .status-badge{ font-size:14px; line-height:1; padding:4px 10px; border-radius:999px; background:#0b1220; border:1px solid #374151; color:var(--ink2); }
    .delisted-badge{ background:#331010; border-color:#7f1d1d; color:#fecaca; }

    #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }
    .log-item { padding:6px 0; border-bottom:1px dashed #374151; font-size:14px; }
    .req-card { background:var(--card); border-radius:10px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:10px; text-align:center; width:min(90%,520px); position:relative; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:8px; width:90%; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:10px; border-radius:10px; position:relative;}
    #adminPanelAll { position:fixed; top:50px; left:50px; z-index:9999; width:90%; max-width:1100px; pointer-events:auto; box-shadow:0 20px 40px rgba(0,0,0,.35); }
    #adminPanelHeader { background:#374151; padding:8px 44px 8px 12px; cursor:move; border-radius:10px 10px 0 0; font-weight:700; user-select:none; position:relative; }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

  <!-- ìƒë‹¨ ì‚¬ìš©ì ì˜ì—­ -->
  <div id="userRow">
    <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
    <div>
      <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btnOpenWithdraw">ì¶œê¸ˆ ìš”ì²­</button>
      <button id="btnOpenNotice">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button id="btnOpenNews">ğŸ“° ë‰´ìŠ¤ ë³´ê¸° <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span></button>
    </div>
  </div>

  <!-- ì…ê¸ˆ ìš”ì²­ -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button id="requestDepositBtn">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <!-- ì°¨íŠ¸ + ì¢…ëª© ì¹´ë“œ + ë¡œê·¸ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
      <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <button id="startBtn">ì‹œì‘</button>
    </div>
  </div>

  <!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseWithdraw">âœ•</button>
      <h2>ì¶œê¸ˆ ìš”ì²­</h2>
      <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥"><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
      <input type="text" id="withdrawAccount" placeholder="ë³¸ì¸ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥"><br>
      <button id="submitWithdrawBtn">ìš”ì²­</button>
    </div>
  </div>

  <!-- ê³µì§€ ëª¨ë‹¬ -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseNotice">âœ•</button>
      <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
      <div id="noticeContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button id="btnCloseNotice2">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ -->
  <div id="newsModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseNews">âœ•</button>
      <h2>ğŸ“° ìµœì‹  ë‰´ìŠ¤</h2>
      <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button id="btnCloseNews2">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
  <div id="adminLogin">
    <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
    <button id="btnAdminLogin">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminPanelAll" class="admin-panel">
    <div id="adminPanelHeader">
      âš™ï¸ ê´€ë¦¬ì í†µí•© íŒ¨ë„
      <button class="xbtn" id="btnAdminClose">âœ•</button>
    </div>
    <div style="padding:10px;">
      <div style="display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap;">
        <button data-tab="graph">ğŸ“Š ê·¸ë˜í”„</button>
        <button data-tab="users">ğŸ‘¥ ìœ ì €</button>
        <button data-tab="finance">ğŸ’³ ì…ì¶œê¸ˆ</button>
        <button data-tab="stock">ğŸ›ï¸ ì£¼ê°€ì¡°ì‘</button>
        <button data-tab="change">ğŸ“ˆ ë°°ìœ¨/í™•ë¥ </button>
        <button data-tab="news">ğŸ“° ë‰´ìŠ¤</button>
        <button data-tab="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
        <button data-tab="delist">ğŸš« ìƒì¥íì§€</button>
      </div>
      <div id="tab-graph" class="tab-section"></div>
      <div id="tab-users" class="tab-section" style="display:none;"></div>
      <div id="tab-finance" class="tab-section" style="display:none;"></div>
      <div id="tab-stock" class="tab-section" style="display:none;"></div>
      <div id="tab-change" class="tab-section" style="display:none;"></div>
      <div id="tab-news" class="tab-section" style="display:none;"></div>
      <div id="tab-notice" class="tab-section" style="display:none;"></div>
      <div id="tab-delist" class="tab-section" style="display:none;"></div>
    </div>
  </div>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
/* ================= Utils (ìµœìƒë‹¨) ================= */
const $ = (sel)=>document.querySelector(sel);
function safeId(name){ return String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_'); }
function parseNumber(str){
  const n = parseInt(String(str).replace(/[^0-9]/g,''),10);
  return isNaN(n)?0:Math.max(0,n);
}
function escapeHtml(s=''){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function log(msg){
  const div=document.createElement('div');
  div.className='log-item'; div.innerHTML=msg;
  $("#log").prepend(div);
}

/* ================= Firebase Init ================= */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
  onSnapshot, writeBatch, increment, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const auth=getAuth(app); const db=getFirestore(app);

/* ================= State ================= */
let chart=null; let updateInterval=5000; let marketOpenFlag=false;
let volatility=1.5; let lastChartTick=0;
const marketState={ bias:{} };
const companyChances={}; const companyStatus={};
let delistPlan=null; let player={holdings:{},cash:0};
let currentUser=null; let unsubscribeUser=null;

/* ================= Companies ================= */
const companies=[
  {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:10000000},
  {name:"ì¹´ìŠ¤í‹¸ë¡œ", basePrice:10000000},
  {name:"ì‚¬ì¿ ë¼", basePrice:10000000},
  {name:"ì²­ë£¡", basePrice:10000000},
  {name:"ê²½ì°°ì²­", basePrice:10000000},
  {name:"Ems", basePrice:10000000},
  {name:"ì˜¬ë“œë³´ì´", basePrice:10000000},
  {name:"ì‘ë‘", basePrice:10000000},
  {name:"ë¹…ë”•", basePrice:10000000},
  {name:"ìœ í† í”¼ì•„", basePrice:10000000},
  {name:"inback", basePrice:10000000},
].map(c=>({...c,id:safeId(c.name),multiplier:1,livePrice:c.basePrice}));

function findCompanyById(id){ return companies.find(x=>x.id===id||x.name===id); }
function getDisplayPrice(c){ return Math.max(1,Math.floor(c.livePrice||c.basePrice)); }
function companyIsDelisted(c){ return !!(companyStatus[c.id]?.delisted); }

/* ================= Chart ================= */
function initChart(){
  if(chart) return;
  const ctx=$("#chart").getContext("2d");
  chart=new Chart(ctx,{
    type:"line",
    data:{ labels:[], datasets:companies.map(c=>({label:c.name,data:[],borderWidth:2,fill:false,tension:0.25})) },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{legend:{position:"bottom"}},
      scales:{ x:{title:{display:true,text:"ì‹œê°„"}}, y:{title:{display:true,text:"ê°€ê²©(KRW)"},beginAtZero:false}}
    }
  });
}
function appendChartPoint(t){
  if(!chart) return;
  const label=new Date(t||Date.now()).toLocaleTimeString();
  chart.data.labels.push(label);
  companies.forEach((c,i)=>chart.data.datasets[i].data.push(getDisplayPrice(c)));
  if(chart.data.labels.length>120){
    chart.data.labels.splice(0,chart.data.labels.length-120);
    chart.data.datasets.forEach(d=>{if(d.data.length>120) d.data.splice(0,d.data.length-120);});
  }
  chart.update("none");
}

/* ================= UI Rendering ================= */
function getQty(name){
  const el=$("#qty-"+safeId(name));
  return Math.max(1,parseInt(el?.value)||1);
}
function updateMaxBuyUI(){
  companies.forEach(c=>{
    const el=$("#maxbuy-"+c.id);
    if(el){ const price=getDisplayPrice(c); const maxQty=Math.floor((player.cash||0)/price);
      el.textContent=`(ìµœëŒ€ ${maxQty}ì£¼ ë§¤ìˆ˜ ê°€ëŠ¥)`; }
  });
}
function updateHoldingsUI(){
  companies.forEach(c=>{ const el=$("#hold-"+c.id); if(el) el.textContent=(player.holdings[c.name]||0); });
  updateMaxBuyUI();
}
function renderUserInfo(){
  if(currentUser){
    $("#userInfo").innerHTML=`ğŸ‘¤ <strong>${escapeHtml(currentUser.name)}</strong> (${escapeHtml(currentUser.id)}) | ğŸ’µ ë³´ìœ í˜„ê¸ˆ: <strong>${(player.cash||0).toLocaleString()} KRW</strong>`;
  }else $("#userInfo").textContent="â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...";
  updateMaxBuyUI();
}
function initCompaniesUI(){
  $("#companies").innerHTML=companies.map(c=>{
    const delisted=companyIsDelisted(c);
    return `<div class="company" id="card-${c.id}">
      <div class="info"><span>${escapeHtml(c.name)}</span>
      <span class="status-badge ${delisted?'delisted-badge':''}" id="marketStatus-${c.id}">${delisted?'ğŸš« ìƒì¥íì§€':'ğŸŸ¡ ëŒ€ê¸°'}</span></div>
      <div>ê°€ê²©: <strong><span id="price-${c.id}">${getDisplayPrice(c).toLocaleString()}</span> KRW</strong></div>
      <div>ë³´ìœ : <span id="hold-${c.id}">${player.holdings[c.name]||0}</span> ì£¼
      <span id="maxbuy-${c.id}" style="color:#10b981;font-size:13px;margin-left:6px;">(ìµœëŒ€ ${Math.floor((player.cash||0)/getDisplayPrice(c))}ì£¼ ë§¤ìˆ˜ ê°€ëŠ¥)</span></div>
      <div class="actions">
        <input type="number" id="qty-${c.id}" min="1" value="1" ${(!marketOpenFlag||delisted)?'disabled':''}>
        <button data-role="buy" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>ë§¤ìˆ˜</button>
        <button data-role="sell" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>ë§¤ë„</button>
      </div></div>`;
  }).join("");
  $("#companies").onclick=(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    const comp=findCompanyById(btn.dataset.id); if(!comp) return;
    const qty=getQty(comp.name);
    if(btn.dataset.role==="buy") buy(comp.name,qty);
    if(btn.dataset.role==="sell") sell(comp.name,qty);
  };
  updateMaxBuyUI();
}

/* ================= Trade ================= */
function impactPrice(id,qty,mode){
  const c=findCompanyById(id); if(!c||companyIsDelisted(c)) return;
  const step=Math.min(0.1,Math.max(1,qty)/10000);
  marketState.bias[c.id]=Math.max(-1,Math.min(1,(marketState.bias[c.id]||0)+(mode==="buy"?-step:+step)));
}
async function buy(name,qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("ìƒì¥íì§€ ì¢…ëª© ê±°ë˜ ë¶ˆê°€");
  if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
  const p=getDisplayPrice(c), total=p*qty;
  if(player.cash<total) return alert("í˜„ê¸ˆ ë¶€ì¡±");
  player.cash-=total; player.holdings[c.name]=(player.holdings[c.name]||0)+qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`ğŸŸ¢ ë§¤ìˆ˜ì²´ê²°: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"buy");
}
async function sell(name,qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("ìƒì¥íì§€ ì¢…ëª© ê±°ë˜ ë¶ˆê°€");
  if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
  if((player.holdings[c.name]||0)<qty) return alert("ë³´ìœ  ë¶€ì¡±");
  const p=getDisplayPrice(c), total=p*qty;
  player.cash+=total; player.holdings[c.name]-=qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`ğŸ”´ ë§¤ë„ì²´ê²°: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"sell");
}

/* ================= Auth / Session ================= */
async function ensureAuth(){
  return new Promise(res=>{
    onAuthStateChanged(auth,u=>{ if(u) res(u); else signInAnonymously(auth).then(r=>res(r.user)).catch(()=>res(null)); });
  });
}
function subscribeCurrentUser(uid){
  if(unsubscribeUser){unsubscribeUser();unsubscribeUser=null;}
  unsubscribeUser=onSnapshot(doc(db,"users",uid),(snap)=>{
    if(!snap.exists()) return;
    const d=snap.data(); player.cash=d.cash||0; player.holdings=d.holdings||{};
    renderUserInfo(); updateHoldingsUI();
  });
}
$("#startBtn").onclick=async()=>{
  const cid=$("#customId").value.trim(), cname=$("#customName").value.trim();
  if(!cid||!cname) return alert("ê³ ìœ ë²ˆí˜¸/ì´ë¦„ ì…ë ¥");
  await ensureAuth();
  const ref=doc(db,"users",cid); const snap=await getDoc(ref);
  let cash=0,hold={}; if(snap.exists()){cash=snap.data().cash||0; hold=snap.data().holdings||{};}
  currentUser={id:cid,name:cname}; player.cash=cash; player.holdings=hold;
  await setDoc(ref,{id:cid,name:cname,cash,holdings:hold,active:true,lastLoginAt:Date.now()},{merge:true});
  localStorage.setItem("stockUser",JSON.stringify({id:cid,name:cname}));
  $("#loginModal").style.display="none"; renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid);
};
$("#btnLogout").onclick=async()=>{
  if(currentUser) await updateDoc(doc(db,"users",currentUser.id),{active:false,lastLogoutAt:Date.now()});
  localStorage.removeItem("stockUser"); location.reload();
};
window.addEventListener("load",async()=>{
  await ensureAuth();
  const saved=localStorage.getItem("stockUser");
  if(saved){ try{ const p=JSON.parse(saved); if(p.id){ currentUser=p; $("#loginModal").style.display="none"; subscribeCurrentUser(p.id); } }catch{} }
  initChart(); companies.forEach(c=>c.livePrice=c.basePrice); appendChartPoint(Date.now());
});
</script>

  <script type="module">
/* ================= Deposit / Withdraw ìš”ì²­ (ì‚¬ìš©ì) ================= */
async function requestDeposit(){
  const id=currentUser?.id||"", name=currentUser?.name||"";
  const account=$("#acctNo").value.trim();
  const amount=parseNumber($("#cashAmount").value);
  const memo=$("#cashMemo").value.trim();
  if(!id||!name||!account||amount<=0) return alert("âš ï¸ ê³„ì¢Œë²ˆí˜¸ì™€ ê¸ˆì•¡ ì…ë ¥ í•„ìš”");
  try{
    await addDoc(collection(db,"depositRequests"),{userId:id,userName:name,account,amount,memo,status:"pending",createdAt:Date.now()});
    alert(`ğŸ’° ${amount.toLocaleString()} KRW ì…ê¸ˆ ìš”ì²­ ì™„ë£Œ`);
    log(`ğŸ’° ì…ê¸ˆìš”ì²­: ${amount.toLocaleString()} (${escapeHtml(account)})`);
    $("#acctNo").value=""; $("#cashAmount").value=""; $("#cashMemo").value="";
  }catch(e){ alert("ì…ê¸ˆ ìš”ì²­ ì˜¤ë¥˜:"+e.message); }
}
$("#requestDepositBtn").onclick=requestDeposit;

async function submitWithdraw(){
  const id=$("#withdrawId").value.trim();
  const name=$("#withdrawName").value.trim();
  const amount=parseNumber($("#withdrawAmount").value);
  const account=$("#withdrawAccount").value.trim();
  if(!id||!name||!account||amount<=0) return alert("âš ï¸ ëª¨ë“  í•­ëª© ì…ë ¥ í•„ìš”");
  try{
    await addDoc(collection(db,"withdrawRequests"),{userId:id,userName:name,amount,account,status:"pending",createdAt:Date.now()});
    alert("ğŸ“¤ ì¶œê¸ˆ ìš”ì²­ ì ‘ìˆ˜ë¨");
    const fee=Math.floor(amount*0.1);
    log(`ğŸ“¤ ì¶œê¸ˆìš”ì²­: ${amount.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(amount-fee).toLocaleString()})`);
    $("#withdrawModal").style.display="none";
  }catch(e){ alert("ì¶œê¸ˆ ìš”ì²­ ì˜¤ë¥˜:"+e.message); }
}
$("#submitWithdrawBtn").onclick=submitWithdraw;

/* ================= ë‰´ìŠ¤ êµ¬ë… ================= */
let newsData=[],newsDataAll=[],lastReadNewsAt=Number(localStorage.getItem("lastReadNewsAt")||0);
function updateNewsBadge(count){
  if(count>0){ $("#newsBadge").style.display="inline"; $("#newsBadge").textContent=String(count);}
  else $("#newsBadge").style.display="none";
}
function renderNewsModal(){
  if(!newsData.length){ $("#newsContent").innerHTML="<p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
  $("#newsContent").innerHTML=newsData.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0;border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||'ì œëª© ì—†ìŒ')}</div>
      <div style="color:#9ca3af;font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||'').replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNews(){
  const qy=query(collection(db,"news"),orderBy("createdAt","desc"));
  onSnapshot(qy,snap=>{
    const vis=[],all=[];
    snap.forEach(d=>{const n={id:d.id,...d.data()}; all.push(n); if(n.visible!==false) vis.push(n);});
    newsData=vis; newsDataAll=all;
    const unread=vis.filter(n=>(n.createdAt||0)>lastReadNewsAt).length;
    updateNewsBadge(unread); renderNewsModal();
  });
}
$("#btnOpenNews").onclick=()=>{
  $("#newsModal").style.display="flex";
  lastReadNewsAt=Date.now(); localStorage.setItem("lastReadNewsAt",String(lastReadNewsAt));
  updateNewsBadge(0);
};
$("#btnCloseNews").onclick=()=>$("#newsModal").style.display="none";
$("#btnCloseNews2").onclick=()=>$("#newsModal").style.display="none";

/* ================= ê³µì§€ êµ¬ë… ================= */
let noticeDataAll=[];
function renderNoticeModal(){
  if(!noticeDataAll.length){ $("#noticeContent").innerHTML="<p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
  $("#noticeContent").innerHTML=noticeDataAll.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0;border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||'ê³µì§€')}</div>
      <div style="color:#9ca3af;font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||'').replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNotices(){
  const qy=query(collection(db,"notices"),orderBy("createdAt","desc"));
  onSnapshot(qy,snap=>{
    noticeDataAll=[]; snap.forEach(d=>noticeDataAll.push({id:d.id,...d.data()}));
    renderNoticeModal();
  });
}
$("#btnOpenNotice").onclick=()=>$("#noticeModal").style.display="flex";
$("#btnCloseNotice").onclick=()=>$("#noticeModal").style.display="none";
$("#btnCloseNotice2").onclick=()=>$("#noticeModal").style.display="none";

/* ================= íšŒì‚¬ ê°€ê²©/ìƒíƒœ êµ¬ë… ================= */
function subscribeCompanyPrices(){
  onSnapshot(collection(db,"companyPrices"),snap=>{
    let maxTick=0;
    snap.forEach(d=>{
      const data=d.data(),c=findCompanyById(d.id); if(!c) return;
      if(typeof data.current==="number") c.livePrice=data.current;
      if(data.updatedAt) maxTick=Math.max(maxTick,data.updatedAt);
      $("#price-"+c.id).textContent=getDisplayPrice(c).toLocaleString();
    });
    updateMaxBuyUI();
    if(maxTick>lastChartTick){ lastChartTick=maxTick; appendChartPoint(maxTick); }
  });
}
function subscribeCompanyStatus(){
  onSnapshot(collection(db,"companyStatus"),snap=>{
    snap.forEach(d=>{companyStatus[d.id]={delisted:!!d.data().delisted,delistedAt:d.data().delistedAt||null};});
    companies.forEach(c=>{
      const st=$("#marketStatus-"+c.id);
      if(st){ st.textContent=companyIsDelisted(c)?"ğŸš« ìƒì¥íì§€":(marketOpenFlag?"ğŸŸ¢ ê°œì¥":"ğŸ”´ ë§ˆê°");
        st.classList.toggle("delisted-badge",companyIsDelisted(c)); }
    });
  });
}
function subscribeMarketState(){
  onSnapshot(doc(db,"marketState","main"),snap=>{
    const d=snap.data()||{}; marketOpenFlag=!!d.isOpen;
    if(typeof d.interval==="number") updateInterval=d.interval;
    delistPlan=d.delistPlan||null;
  });
}
subscribeNews(); subscribeNotices(); subscribeCompanyPrices(); subscribeCompanyStatus(); subscribeMarketState();
</script>

  /* =========================
   Part 4-2: Admin Logic
   ========================= */

/* ê³µí†µ ìœ í‹¸ (íŒŒíŠ¸2ì—ì„œ ì´ë¯¸ ìˆìœ¼ë‚˜ ì•ˆì „ì°¨ì›) */
const parseIntSafe = (v, d=0)=>{ const n = parseInt(v,10); return Number.isFinite(n)?n:d; };

/* ----- ê·¸ë˜í”„/ê°€ê²© ì¡°ì • ----- */
function refreshCompanyIdsFromDOM(){
  return Array.from($("#companies").querySelectorAll(".company")).map(card=>{
    const id = (card.id||"").replace(/^card-/,'');
    const name = (card.querySelector('.info span')?.textContent||id).trim();
    return { id, name };
  });
}
async function setMarketOpen(open){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  await setDoc(doc(db,"marketState","main"), { isOpen: !!open, updatedAt: Date.now() }, { merge:true });
  alert(open?"âœ… ì¥ ì‹œì‘":"ğŸ“‰ ì¥ ë§ˆê°");
}
async function resetGraph(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current:10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  if(chart){ chart.data.labels=[]; chart.data.datasets.forEach(d=>d.data=[]); chart.update(); }
  alert("âœ… ê·¸ë˜í”„ ì´ˆê¸°í™” ì™„ë£Œ");
}
async function adjustAllPrices(){
  if(!ADMIN_MODE) return;
  const delta = parseIntSafe($("#allDelta").value, 0);
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current: increment(delta), updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert(`âœ… ì „ì²´ ì¼ê´„ ì¡°ì •: ${delta>=0?'+':''}${delta}`);
}
async function adjustCompanyPriceById(id, delta){
  if(!ADMIN_MODE) return;
  await setDoc(doc(db,"companyPrices",id), { current: increment(parseIntSafe(delta,0)), updatedAt: Date.now() }, { merge:true });
}
async function applyGraphInterval(){
  if(!ADMIN_MODE) return;
  const sec = Math.max(1, parseIntSafe($("#intervalInput").value, 5));
  await setDoc(doc(db,"marketState","main"), { interval: sec*1000, updatedAt: Date.now() }, { merge:true });
  alert(`âœ… ë³€ë™ ì£¼ê¸° ì ìš©: ${sec}s`);
}
function applyDeltaMax(){
  if(!ADMIN_MODE) return;
  deltaMax = Math.max(1, parseIntSafe($("#deltaMaxInput").value, 1000000));
  alert(`âœ… 1í‹± ìƒí•œ(Â±ì›) ë³€ê²½: ${deltaMax.toLocaleString()}`);
}
function renderGraphAdjustPanel(){
  const wrap = $("#graphCompanyAdjust");
  const items = refreshCompanyIdsFromDOM();
  wrap.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="number" data-role="adj-input" data-id="${id}" value="10000" style="width:110px;">
        <button data-role="adj-apply" data-id="${id}">ì ìš©</button>
      </div>
    </div>
  `).join('') || 'íšŒì‚¬ ì—†ìŒ';
  wrap.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="adj-apply"]'); if(!btn) return;
    const id = btn.dataset.id;
    const inp = wrap.querySelector(`input[data-role="adj-input"][data-id="${id}"]`);
    await adjustCompanyPriceById(id, parseIntSafe(inp?.value,0));
  };
}

/* ----- ìœ ì €/ê¶Œí•œ/ê°•ì œë¡œê·¸ì•„ì›ƒ ----- */
function subscribeUsersPanel(){
  const host = $("#userList"); if(!host) return;
  host.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  onSnapshot(collection(db,"users"), snap=>{
    let html = '';
    snap.forEach(d=>{
      const u = d.data()||{};
      const hold = u.holdings || {};
      const holdTxt = Object.entries(hold).map(([k,v])=>`${escapeHtml(k)}:${v}`).join(', ') || 'ë³´ìœ  ì—†ìŒ';
      html += `
        <div class="req-card">
          <div>
            <div><strong>${escapeHtml(u.name||'-')}</strong> (${d.id}) ${u.active?'ğŸŸ¢':'ğŸ”´'} ${u.isAdmin?'<span style="color:#10b981">ê´€ë¦¬ìğŸ›¡ï¸</span>':''}</div>
            <div>í˜„ê¸ˆ: ${Number(u.cash||0).toLocaleString()} KRW</div>
            <div>ë³´ìœ : ${holdTxt}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-action="force-logout" data-id="${d.id}">ê°•ì œ ë¡œê·¸ì•„ì›ƒ</button>
            ${u.isAdmin
              ? `<button data-action="demote" data-id="${d.id}">ê¶Œí•œ í•´ì œ</button>`
              : `<button data-action="promote" data-id="${d.id}">ê¶Œí•œ ë¶€ì—¬</button>`
            }
          </div>
        </div>`;
    });
    host.innerHTML = html || 'ìœ ì € ì—†ìŒ';
  });
  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const action = btn.dataset.action, uid = btn.dataset.id;
    if(action==="force-logout"){
      await updateDoc(doc(db,"users",uid), { active:false, lastLogoutAt: Date.now() });
      alert("ğŸ‘¤ ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
    }else if(action==="promote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:true, updatedAt: Date.now() });
      alert("ğŸ›¡ï¸ ê¶Œí•œ ë¶€ì—¬");
    }else if(action==="demote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:false, updatedAt: Date.now() });
      alert("âš ï¸ ê¶Œí•œ í•´ì œ");
    }
  };
}

/* ----- ì…ì¶œê¸ˆ í ----- */
function subscribeFinanceQueues(){
  const dep = $("#depositRequests"), wdr = $("#withdrawRequests");
  if(dep){
    dep.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    onSnapshot(collection(db,"depositRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ê³„ì¢Œ: ${escapeHtml(r.account||'')}</div>
              <div>ê¸ˆì•¡: ${Number(r.amount||0).toLocaleString()} KRW</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="dep" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${Number(r.amount||0)}">ìŠ¹ì¸</button>
              <button data-kind="dep" data-do="reject" data-id="${d.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      dep.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    dep.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='dep') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        await updateDoc(doc(db,"users",uid), { cash: increment(amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"depositRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"depositRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }

  if(wdr){
    wdr.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    onSnapshot(collection(db,"withdrawRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        const amt = Number(r.amount||0), fee=Math.floor(amt*0.1);
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ìš”ì²­ì•¡: ${amt.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(Math.max(0,amt-fee)).toLocaleString()})</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="wdr" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${amt}">ìŠ¹ì¸</button>
              <button data-kind="wdr" data-do="reject" data-id="${d.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      wdr.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    wdr.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='wdr') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        const us = await getDoc(doc(db,"users",uid));
        const cash = Number(us.data()?.cash||0);
        if(cash < amt) return alert("âŒ ì‚¬ìš©ì ë³´ìœ  í˜„ê¸ˆ ë¶€ì¡±");
        await updateDoc(doc(db,"users",uid), { cash: increment(-amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"withdrawRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"withdrawRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }
}

/* ----- ì£¼ê°€ì¡°ì‘(í‹± ë²„íŠ¼) ----- */
function renderStockTuner(){
  const host = $("#stockTuner"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:6px;">
        <button data-role="tune" data-id="${id}" data-delta="-100000">-10ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="-10000">-1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="10000">+1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="100000">+10ë§Œ</button>
      </div>
    </div>`).join('') || 'ì¢…ëª© ì—†ìŒ';
  host.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="tune"]'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    await adjustCompanyPriceById(btn.dataset.id, parseIntSafe(btn.dataset.delta,0));
  };
}

/* ----- ë°°ìœ¨/í™•ë¥  íŒ¨ë„ ----- */
function renderChangePanel(){
  const host = $("#changePanel"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div style="min-width:220px;">
        <div><strong>${escapeHtml(name)}</strong></div>
        <div style="font-size:12px;color:#9ca3af;">ë°°ìœ¨/í™•ë¥  ì €ì¥ ì‹œ ì¦‰ì‹œ ë°˜ì˜</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="number" step="0.1" value="1" style="width:90px;" data-role="mul" data-id="${id}">
        <button data-role="mul-apply" data-id="${id}">ë°°ìœ¨ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="0.01" min="0" max="1" value="0.4" style="width:90px;" data-role="up" data-id="${id}">
        <input type="number" step="0.01" min="0" max="1" value="0.6" style="width:90px;" data-role="down" data-id="${id}">
        <button data-role="chance-apply" data-id="${id}">í™•ë¥ ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="1" value="10000" style="width:100px;" data-role="bump" data-id="${id}">
        <button data-role="bump-apply" data-id="${id}">ì¦‰ì‹œÂ±ë°˜ì˜</button>
      </div>
    </div>
  `).join('') || 'ì¢…ëª© ì—†ìŒ';

  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const id = btn.dataset.id, role = btn.dataset.role;
    if(role==='mul-apply'){
      const v = Number(host.querySelector(`input[data-role="mul"][data-id="${id}"]`)?.value||1);
      const m = Number.isFinite(v)?Math.max(0,v):1;
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
      alert("ë°°ìœ¨ ì ìš©");
    }else if(role==='chance-apply'){
      const up = Number(host.querySelector(`input[data-role="up"][data-id="${id}"]`)?.value||0.4);
      const dn = Number(host.querySelector(`input[data-role="down"][data-id="${id}"]`)?.value||0.6);
      if(!(up>=0 && dn>=0 && (up+dn)>0 && up<=1 && dn<=1)) return alert("0~1, í•©ê³„>0");
      await setDoc(doc(db,"companyChances",id), { profit:up, loss:dn, updatedAt: Date.now() }, { merge:true });
      alert("í™•ë¥  ì ìš©");
    }else if(role==='bump-apply'){
      const delta = parseIntSafe(host.querySelector(`input[data-role="bump"][data-id="${id}"]`)?.value, 0);
      await adjustCompanyPriceById(id, delta);
    }
  };

  // ì „ì—­ ë²„íŠ¼
  $("#applyAllChanceBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const p = parseFloat($("#globalProfit").value), l = parseFloat($("#globalLoss").value);
    if(!(p>=0 && l>=0 && (p+l)>0 && p<=1 && l<=1)) return alert("0~1, í•©ê³„>0");
    for(const {id} of items){
      await setDoc(doc(db,"companyChances",id), { profit:p, loss:l, updatedAt: Date.now() }, { merge:true });
    }
    alert("âœ… ì „ì²´ í™•ë¥  ì ìš©");
  };
  $("#applyAllMultiplierBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const v = Number($("#allMultiplierVal").value);
    const m = Number.isFinite(v)?Math.max(0,v):1;
    for(const {id} of items){
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
    }
    alert("âœ… ì „ì²´ ë°°ìœ¨ ì ìš©");
  };
  $("#applyVolatilityBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const v = Number($("#volatilityInput").value);
    const vv = Number.isFinite(v)?Math.max(0,v):1.5;
    await setDoc(doc(db,"globals","settings"), { volatility: vv, updatedAt: Date.now() }, { merge:true });
    alert(`âœ… ì „ì—­ ë³€ë™í­ ${vv}% ì ìš©`);
  };
}

/* ----- ë‰´ìŠ¤/ê³µì§€ (ê´€ë¦¬ì) ----- */
function subscribeNewsAdmin(){
  const list = $("#newsList"); if(!list) return;
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  const qy = query(collection(db,"news"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"ì œëª© ì—†ìŒ");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      const vis = (n.visible!==false);
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
            <div style="color:${vis?'#10b981':'#ef4444'}; font-size:12px; margin-top:4px;">${vis?'í‘œì‹œì¤‘':'ìˆ¨ê¹€'}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="news-toggle" data-id="${n.id}" data-visible="${vis}">${vis?'ìˆ¨ê¹€':'í‘œì‹œ'}</button>
            <button data-role="news-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const role = btn.dataset.role, id = btn.dataset.id;
    if(role==='news-toggle'){
      const cur = btn.dataset.visible === 'true';
      await updateDoc(doc(db,"news",id), { visible: !cur, updatedAt: Date.now() });
    }else if(role==='news-del'){
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"news",id));
    }
  };
  $("#postNewsBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const title = ($("#newsTitleInput").value||"").trim();
    const content = ($("#newsBodyInput").value||"").trim();
    if(!title||!content) return alert("ì œëª©/ë‚´ìš© ì…ë ¥");
    await addDoc(collection(db,"news"), { title, content, createdAt: Date.now(), visible: true, author: currentUser?.name||'ê´€ë¦¬ì' });
    $("#newsTitleInput").value=''; $("#newsBodyInput").value='';
    alert("ğŸ“° ë‰´ìŠ¤ ë“±ë¡");
  };
}
function subscribeNoticeAdmin(){
  const list = $("#noticeList"); if(!list) return;
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  const qy = query(collection(db,"notices"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"ê³µì§€ì‚¬í•­");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="notice-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    if(btn.dataset.role==='notice-del'){
      const id = btn.dataset.id;
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"notices",id));
    }
  };
  $("#postNoticeBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const title = ($("#noticeTitleInput").value||"").trim();
    const content = ($("#noticeBodyInput").value||"").trim();
    if(!title||!content) return alert("ì œëª©/ë‚´ìš© ì…ë ¥");
    await addDoc(collection(db,"notices"), { title, content, createdAt: Date.now(), author: currentUser?.name||'ê´€ë¦¬ì' });
    $("#noticeTitleInput").value=''; $("#noticeBodyInput").value='';
    alert("ğŸ“¢ ê³µì§€ ë“±ë¡");
  };
}

/* ----- ìƒì¥íì§€/ë¶€í™œ ----- */
let __delistPlan = null;
function populateDelistSelect(){
  const sel = $("#delistCompanySel"); if(!sel) return;
  const items = refreshCompanyIdsFromDOM();
  sel.innerHTML = items.map(({id,name})=>`<option value="${id}">${escapeHtml(name)}</option>`).join('');
}
function renderDelistStatus(){
  const el = $("#delistStatus"); if(!el) return;
  if(!__delistPlan || !__delistPlan.active){
    el.style.color = '#9ca3af';
    el.textContent = 'ì§„í–‰ ì¤‘ì¸ ìƒì¥íì§€ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  const remain = Math.max(0, (__delistPlan.endAt - Date.now()));
  const mm = Math.floor(remain/60000), ss = Math.floor((remain%60000)/1000);
  el.style.color = '#fbbf24';
  el.textContent = `ì§„í–‰ ì¤‘: [${__delistPlan.companyId}] ${mm}ë¶„ ${ss}ì´ˆ í›„ 0ì› ë„ë‹¬ ë° ìƒì¥íì§€ ì˜ˆì •`;
}
function renderDelistedListSnap(snap){
  const host = $("#delistedItems"); if(!host) return;
  const items = [];
  const nameMap = Object.fromEntries(refreshCompanyIdsFromDOM().map(o=>[o.id,o.name]));
  snap?.forEach(s=>{
    const d=s.data()||{};
    if(d.delisted){
      items.push({ name: nameMap[s.id]||s.id, at: d.delistedAt? new Date(d.delistedAt).toLocaleString():'-' });
    }
  });
  host.innerHTML = items.length
    ? items.map(x=>`<div>â€¢ ${escapeHtml(x.name)} (íì§€ ì‹œê°: ${x.at})</div>`).join('')
    : 'ìƒì¥íì§€ëœ ì¢…ëª© ì—†ìŒ';
}
async function scheduleDelist(){
  if(!ADMIN_MODE) return;
  const id = $("#delistCompanySel").value;
  const mins = Math.max(1, parseIntSafe($("#delistMinutes").value,30));
  const now = Date.now();
  __delistPlan = { companyId: id, startAt: now, endAt: now + mins*60000, active:true, mode:'toZero' };
  await setDoc(doc(db,"marketState","main"), { delistPlan: __delistPlan, updatedAt: now }, { merge:true });
  renderDelistStatus();
  alert("ğŸš« ìƒì¥íì§€ ê³„íš ì‹œì‘");
}
async function cancelDelist(){
  if(!ADMIN_MODE) return;
  __delistPlan = null;
  await setDoc(doc(db,"marketState","main"), { delistPlan:{active:false}, updatedAt: Date.now() }, { merge:true });
  renderDelistStatus();
  alert("ì·¨ì†Œë¨");
}
async function reviveCompanies(){
  if(!ADMIN_MODE) return;
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyStatus",id), { delisted:false, revivedAt: now }, { merge:true });
    batch.set(doc(db,"companyPrices",id), { current: 10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert("âœ… ë¶€í™œ ì™„ë£Œ");
}

/* ----- Admin ë²„íŠ¼ ë°”ì¸ë”© + êµ¬ë… ----- */
function bindGraphActions(){
  $("#marketStartBtn").onclick = ()=> setMarketOpen(true);
  $("#marketEndBtn").onclick   = ()=> setMarketOpen(false);
  $("#resetGraphBtn").onclick  = resetGraph;
  $("#applyIntervalBtn").onclick = applyGraphInterval;
  $("#applyDeltaBtn").onclick    = applyDeltaMax;
  $("#adjustAllBtn").onclick     = adjustAllPrices;
}
function bindDelistActions(){
  $("#delistStartBtn").onclick = scheduleDelist;
  $("#delistCancelBtn").onclick = cancelDelist;
  $("#reviveNowBtn").onclick = reviveCompanies;
}
function subscribeDelistRealtime(){
  onSnapshot(doc(db,"marketState","main"), snap=>{
    const d = snap.data()||{};
    __delistPlan = d.delistPlan || null;
    renderDelistStatus();
  });
  onSnapshot(collection(db,"companyStatus"), snap=>{
    renderDelistedListSnap(snap);
  });
}

/* ----- ì´ˆê¸°í™”(ê´€ë¦¬ì ëª¨ë“œ ì§„ì… ì‹œ 1íšŒ í˜¸ì¶œ) ----- */
function initAdminPanelLogic(){
  // ê° íƒ­ UI ë Œë”
  renderGraphAdjustPanel();
  renderStockTuner();
  renderChangePanel();
  populateDelistSelect();

  // ì‹¤ì‹œê°„ êµ¬ë…
  subscribeUsersPanel();
  subscribeFinanceQueues();
  subscribeNewsAdmin();
  subscribeNoticeAdmin();
  subscribeDelistRealtime();

  // ë²„íŠ¼ ë°”ì¸ë”©
  bindGraphActions();
  bindDelistActions();
}

/* ----- ê·¸ë˜í”„ íƒ­ ê¸°ë³¸ ì˜¤í”ˆ ----- */
showTab("graph");

</script>
</body>
</html>
