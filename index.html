<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Îñ°ÏûéÎ∞©Î≤îÎåÄ Ï£ºÏãù ÏÑºÌÑ∞</title>

  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body { font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1100px; flex-wrap:wrap; }
    #depositForm input, #depositForm select { padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--ink); outline:none; }
    #depositForm input:focus { border-color:#64748b; box-shadow:0 0 0 3px rgba(100,116,139,.2); }
    #depositForm .memo { min-width:220px; }

    button { padding:10px 14px; cursor:pointer; border-radius:10px; background:var(--accent); color:var(--ink); border:none; transition:transform .05s ease, background .15s ease, opacity .2s ease; }
    button:hover { background:var(--accentH); }
    button:active { transform:translateY(1px) }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #chartWrap { position:relative; margin:20px auto; max-width:1100px; height:420px; background:#111827; border-radius:12px; overflow:hidden; border:1px solid #273043; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1100px; }
    @media (max-width:1100px){ #companies{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:860px){ #companies{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:620px){ #companies{grid-template-columns:1fr;} }

    .company { background:var(--card); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; transition:filter .2s ease, opacity .2s ease, box-shadow .2s ease; border:1px solid #2b364a; }
    .company:hover{ box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:700; }
    .status-badge{ font-size:13.5px; line-height:1; padding:6px 12px; border-radius:999px; background:#0b1220; border:1px solid #374151; color:var(--ink2); }
    .status-badge.delisted{ background:#111827; border-color:#4b5563; color:#9ca3af; }
    .company.delisted{ opacity:.6; filter:grayscale(.2); }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--ink); outline:none; }
    .company .actions input[type="number"]:focus{ border-color:#64748b; box-shadow:0 0 0 3px rgba(100,116,139,.2); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    #log { max-height:260px; overflow-y:auto; background:#111827; padding:12px; border-radius:12px; border:1px solid #273043; }

    .req-card { background:var(--card); border-radius:12px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; border:1px solid #2b364a; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:5000; }
    .modal-content { background:var(--card); padding:20px; border-radius:12px; text-align:center; width:min(92%,560px); position:relative; border:1px solid #2b364a; }
    .modal-content input, .modal-content textarea, .modal-content select { margin:8px 0; padding:10px 12px; width:92%; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--ink); outline:none; }
    .modal-content input:focus, .modal-content textarea:focus, .modal-content select:focus { border-color:#64748b; box-shadow:0 0 0 3px rgba(100,116,139,.2); }
    textarea { width:100%; min-height:140px; resize:vertical; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; box-shadow:0 4px 10px rgba(0,0,0,.35); }

    /* Ï±ÑÌåÖÏ∞Ω */
    #chatBox { position: fixed; top: 80px; right: 20px; width: 380px; height: 600px; min-height: 300px; max-height: 900px; background: var(--card); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 16px 40px rgba(0,0,0,0.55); z-index: 4000; border:1px solid #2b364a; }
    #chatHeader { background: linear-gradient(180deg, #334155, #2e3a4e); color: var(--ink); padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; letter-spacing:.2px; user-select: none; }
    #chatHeader .title{ display:flex; align-items:center; gap:8px; }
    #chatHeader .title .dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.2); }
    #chatMessages { flex: 1; padding: 12px; overflow-y: auto; font-size: 14px; background: #0b1220; }
    .chat-left { text-align: left; margin: 6px 0; }
    .chat-right { text-align: right; margin: 6px 0; }
    .chat-msg { display: inline-block; padding: 10px 12px; border-radius: 12px; max-width: 80%; word-wrap: break-word; box-shadow:0 6px 14px rgba(0,0,0,.25); border:1px solid #2b364a; }
    .chat-left .chat-msg { background: #1f2937; color: var(--ink); }
    .chat-right .chat-msg { background: #334155; color: var(--ink); }
    .chat-meta { margin-top: 6px; line-height: 1.2; }
    .chat-meta .name { font-size: 13.5px; font-weight: 900; color: #facc15; margin-right: 6px; }
    .chat-meta .uid { font-size: 12.5px; font-weight: 700; color: #38bdf8; opacity: .95; }
    .chat-meta .time { font-size: 11.5px; color: #9ca3af; margin-left: 6px; }
    #chatInputWrap { display: flex; border-top: 1px solid #374151; background: #0b1220; }
    #chatInputWrap input { flex: 1; padding: 12px; border: none; background: transparent; color: var(--ink); outline: none; font-size: 14px; }
    #chatInputWrap button { background: var(--accent); border: none; color: var(--ink); padding: 10px 12px; cursor: pointer; border-left:1px solid #2b364a; }
    #chatResizer { height: 8px; cursor: ns-resize; background: #0b1220; border-top: 1px solid #374151; }

    /* Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê */
    .admin-panel { position: fixed; top:120px; left:40px; background:#1f2937; border-radius:12px; min-width:560px; max-width:92vw; z-index:3600; border:1px solid #2b364a; box-shadow:0 18px 44px rgba(0,0,0,.45); }
    #adminPanelHeader { background:#334155; color:white; padding:10px 12px; cursor:move; border-top-left-radius:12px; border-top-right-radius:12px; display:flex; justify-content:space-between; align-items:center; user-select:none; }
    #adminPanelAll .tabbar{ display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
    #adminPanelAll .tab-section{ display:none; }
    #adminPanelAll .tab-section.active{ display:block; }
    .pill{ padding:8px 10px; border:1px solid #2b364a; border-radius:999px; background:#0b1220; color:#d1d5db; }
    .pill-input{ padding:8px 10px; border:1px solid #2b364a; border-radius:8px; background:#0b1220; color:#d1d5db; outline:none; }

    /* Ïä§ÌÅ¨Î°§Î∞î ÏÇ¥Ïßù Í∞úÏÑ† */
    ::-webkit-scrollbar { width: 10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: #334155; border:2px solid #0b1220; border-radius: 12px; }
    ::-webkit-scrollbar-track { background:#0b1220; }

    /* ÌÜ†Ïä§Ìä∏ */
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; z-index:6000; display:none; }
    #toast .bubble{ background:#111827; color:#e5e7eb; border:1px solid #2b364a; padding:10px 14px; border-radius:10px; box-shadow:0 12px 28px rgba(0,0,0,.45); }

  </style>
</head>
<body>
  <h1>Îñ°ÏûéÎ∞©Î≤îÎåÄ Ï£ºÏãù ÏÑºÌÑ∞</h1>

  <!-- ÏÉÅÎã® ÏÇ¨Ïö©Ïûê Ìå®ÎÑê -->
  <div id="userRow">
    <div id="userInfo">‚è≥ Î°úÍ∑∏Ïù∏ ÎåÄÍ∏∞Ï§ë...</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      <button onclick="openWithdrawModal()">Ï∂úÍ∏à ÏöîÏ≤≠</button>
      <button onclick="openNoticeModal()">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</button>
      <button onclick="openNewsModal()">üì∞ Îâ¥Ïä§ Î≥¥Í∏∞ 
        <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span>
      </button>
      <button onclick="toggleMarketMode()">üí± ÏΩîÏù∏ / Ï£ºÏãù Ï†ÑÌôò</button>
    </div>
  </div>

  <!-- ÏûÖÍ∏à ÏöîÏ≤≠ -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="Ïù∏Í≤åÏûÑ Í≥ÑÏ¢åÎ≤àÌò∏ (Ïòà: ACC-00123)" />
    <input id="cashAmount" type="text" inputmode="numeric" placeholder="Í∏àÏï° (Ïòà: 1000000)" />
    <input id="cashMemo" type="text" class="memo" placeholder="Î©îÎ™® (ÏÑ†ÌÉù)" />
    <button onclick="requestDeposit()">ÏûÖÍ∏à ÏöîÏ≤≠</button>
  </div>

  <!-- Ï∞®Ìä∏/Ï¢ÖÎ™©/Î°úÍ∑∏ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Ï†ïÎ≥¥ ÏûÖÎ†• ÌõÑ ÏãúÏûë</h2>
      <input type="text" id="customId" placeholder="Í≥†Ïú†Î≤àÌò∏ ÏûÖÎ†•"><br>
      <input type="text" id="customName" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•"><br>
      <button id="startBtn">ÏãúÏûë</button>
    </div>
  </div>

  <!-- Ï∂úÍ∏à ÏöîÏ≤≠ Î™®Îã¨ -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeWithdrawModal()">‚úï</button>
      <h2>Ï∂úÍ∏à ÏöîÏ≤≠</h2>
      <input type="text" id="withdrawId" placeholder="Í≥†Ïú†Î≤àÌò∏ ÏûÖÎ†•"><br>
      <input type="text" id="withdrawName" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•"><br>
      <input type="number" id="withdrawAmount" placeholder="Ï∂úÍ∏à Í∏àÏï° ÏûÖÎ†•" oninput="updateWithdrawFee()"><br>
      <select id="withdrawAsset">
        <option value="stock">Ï£ºÏãù (ÏàòÏàòÎ£å 15%)</option>
        <option value="coin">ÏΩîÏù∏ (ÏàòÏàòÎ£å 30%)</option>
      </select><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
      <input type="text" id="withdrawAccount" placeholder="Î≥∏Ïù∏ Í≥ÑÏ¢åÎ≤àÌò∏ ÏûÖÎ†•"><br>
      <button onclick="submitWithdraw()">ÏöîÏ≤≠</button>
    </div>
  </div>

  <!-- Í≥µÏßÄ Î™®Îã¨ -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeNoticeModal()">‚úï</button>
      <h2>üì¢ Í≥µÏßÄÏÇ¨Ìï≠</h2>
      <div id="noticeContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>ÌòÑÏû¨ Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
      </div>
      <button onclick="closeNoticeModal()">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- Îâ¥Ïä§ Î™®Îã¨ -->
  <div id="newsModal" class="modal">
    <div class="modal-content" style="margin-top:40px;">
      <button class="xbtn" onclick="closeNewsModal()">‚úï</button>
      <h2>üì∞ ÏµúÏã† Îâ¥Ïä§</h2>
      <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>ÌòÑÏû¨ Îì±Î°ùÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
      </div>
      <button onclick="closeNewsModal()">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ -->
  <div id="adminLogin" style="margin:16px auto; max-width:1100px; display:flex; gap:8px; align-items:center;">
    <input type="password" id="adminCode" placeholder="Í¥ÄÎ¶¨Ïûê ÏΩîÎìú ÏûÖÎ†•" style="flex:0 0 220px; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--ink);">
    <button onclick="checkAdmin()">Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</button>
  </div>

  <!-- Í¥ÄÎ¶¨Ïûê ÌÜµÌï© Ìå®ÎÑê (ÎìúÎûòÍ∑∏ Ïù¥Îèô Í∞ÄÎä•) -->
  <div id="adminPanelAll" class="admin-panel" style="display:none;">
    <div id="adminPanelHeader">
      <div style="display:flex; align-items:center; gap:10px;">
        <span>‚öôÔ∏è Í¥ÄÎ¶¨Ïûê ÌÜµÌï© Ìå®ÎÑê</span>
        <span class="pill" style="font-size:12px;">ÎìúÎûòÍ∑∏Î°ú Ïù¥Îèô</span>
      </div>
      <button class="xbtn" onclick="closeAdmin('adminPanelAll')">‚úï</button>
    </div>
    <div style="padding:12px; max-height:72vh; overflow:auto;">
      <!-- ÌÉ≠ Î≤ÑÌäº -->
      <div class="tabbar">
        <button onclick="showTab('graph')"  class="pill">üìä Í∑∏ÎûòÌîÑ</button>
        <button onclick="showTab('users')"  class="pill">üë• Ïú†Ï†Ä</button>
        <button onclick="showTab('finance')"class="pill">üí≥ ÏûÖÏ∂úÍ∏à</button>
        <button onclick="showTab('stock')"  class="pill">üéõÔ∏è Ï£ºÍ∞ÄÏ°∞Ïûë</button>
        <button onclick="showTab('change')" class="pill">üìà Î∞∞Ïú®/ÌôïÎ•†</button>
        <button onclick="showTab('news')"   class="pill">üì∞ Îâ¥Ïä§</button>
        <button onclick="showTab('notice')" class="pill">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</button>
        <button onclick="showTab('delist')" class="pill">‚ö´ ÏÉÅÏû•ÌèêÏßÄ</button>
      </div>

      <!-- Í∑∏ÎûòÌîÑ Ìå®ÎÑê -->
      <div id="tab-graph" class="tab-section active">
        <h3 style="margin:6px 0 10px;">üìä Í∑∏ÎûòÌîÑ/Í∏àÏï° Ï†úÏñ¥ Ìå®ÎÑê</h3>
        <div class="req-card">
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button onclick="marketStart()">Ïû• ÏãúÏûë + ÏãúÏÑ∏ ÏãúÏûë</button>
            <button onclick="marketEnd()">Ïû• ÎßàÍ∞ê + ÏãúÏÑ∏ Ï†ïÏßÄ</button>
            <button onclick="resetGraph()">Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî</button>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <span>Ï†ÑÏ≤¥ ÏùºÍ¥Ñ ¬±</span>
            <input id="allDelta" type="number" class="pill-input" placeholder="¬±Í∏àÏï°(Ïõê)" style="width:120px;">
            <button onclick="adjustAllPrices()">ÏùºÍ¥Ñ Ï†ÅÏö©</button>
          </div>
        </div>

        <div class="req-card">
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <span>Ìã± Ï£ºÍ∏∞(Ï¥à)</span>
            <input id="intervalInput" type="number" class="pill-input" value="5" min="1" style="width:100px;">
            <button onclick="applyGraphInterval()">Ï†ÅÏö©</button>
          </div>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <span>1Ìã± ÏÉÅÌïú(¬±Ïõê)</span>
            <input id="deltaMaxInput" type="number" class="pill-input" value="1000000" min="1" style="width:140px;">
            <button onclick="applyDeltaMax()">Ï†ÅÏö©</button>
          </div>
        </div>

        <div id="graphCompanyAdjust" style="margin-top:12px;"></div>
      </div>

      <!-- Ïú†Ï†Ä -->
      <div id="tab-users" class="tab-section">
        <h3 style="margin:6px 0 10px;">üë• Ïú†Ï†Ä ÏÉÅÌÉú Ìå®ÎÑê</h3>
        <div id="userList">Î°úÎìú Ï§ë...</div>
      </div>

      <!-- ÏûÖÏ∂úÍ∏à -->
      <div id="tab-finance" class="tab-section">
        <h3 style="margin:6px 0;">üí≥ ÏûÖ/Ï∂úÍ∏à ÏöîÏ≤≠ Ìå®ÎÑê</h3>
        <h4 style="margin:4px 0 8px;">ÏûÖÍ∏à ÏöîÏ≤≠</h4>
        <div id="depositRequests" class="req-card">ÎåÄÍ∏∞Ï§ëÏù∏ ÏûÖÍ∏à ÏöîÏ≤≠ ÏóÜÏùå</div>
        <h4 style="margin:14px 0 8px;">Ï∂úÍ∏à ÏöîÏ≤≠</h4>
        <div id="withdrawRequests" class="req-card">ÎåÄÍ∏∞Ï§ëÏù∏ Ï∂úÍ∏à ÏöîÏ≤≠ ÏóÜÏùå</div>
      </div>

      <!-- Ï£ºÍ∞ÄÏ°∞Ïûë -->
      <div id="tab-stock" class="tab-section">
        <h3 style="margin:6px 0 10px;">üéõÔ∏è Ï£ºÍ∞Ä Ï°∞Ïûë Ìå®ÎÑê (Ìã± Îã®ÏúÑ Ïù¥Îèô)</h3>
        <div id="stockTuner"></div>
      </div>

      <!-- Î∞∞Ïú®/ÌôïÎ•† -->
      <div id="tab-change" class="tab-section">
        <h3 style="margin:6px 0 10px;">üìà Î∞∞Ïú® & ÌôïÎ•† Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
        <div class="req-card" style="gap:14px;">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span>Ï†ÑÏ≤¥ Î∞∞Ïú®</span>
            <input id="allMultiplierVal" type="number" class="pill-input" step="0.1" value="1" style="width:120px;">
            <button onclick="setAllMultipliers()">Ï†ÑÏ≤¥ Ï†ÅÏö©</button>
          </div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span>Ï†ÑÏ≤¥ ÌôïÎ•†</span>
            <span>‚Üë</span><input id="globalProfit" type="number" class="pill-input" step="0.01" min="0" max="1" value="0.4" style="width:100px;">
            <span>‚Üì</span><input id="globalLoss" type="number" class="pill-input" step="0.01" min="0" max="1" value="0.6" style="width:100px;">
            <button onclick="setAllChances()">Ï†ÑÏ≤¥ Ï†ÅÏö©</button>
          </div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span>Ï†ÑÏó≠ Î≥ÄÎèôÌè≠(%)</span>
            <input id="volatilityInput" type="number" class="pill-input" step="0.1" value="1.5" style="width:120px;">
            <button onclick="applyVolatility()">Ï†ÅÏö©</button>
          </div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <button onclick="runScenario('riseEnd')">üìà Îã®Í∏∞ ÏÉÅÏäπ Ïú†ÎèÑ</button>
            <button onclick="runScenario('fallEnd')">üìâ Îã®Í∏∞ ÌïòÎùΩ Ïú†ÎèÑ</button>
          </div>
        </div>
        <div id="changePanel" style="margin-top:10px;"></div>
      </div>

      <!-- Îâ¥Ïä§ -->
      <div id="tab-news" class="tab-section">
        <h3 style="margin:6px 0 10px;">üì∞ Îâ¥Ïä§ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
        <div class="req-card" style="flex-direction:column; align-items:stretch;">
          <input type="text" id="newsTitleInput" placeholder="Îâ¥Ïä§ Ï†úÎ™©">
          <textarea id="newsBodyInput" placeholder="Îâ¥Ïä§ ÎÇ¥Ïö©"></textarea>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="postNews()">Îì±Î°ù</button>
          </div>
        </div>
        <h4 style="margin:12px 0 6px;">Îì±Î°ùÎêú Îâ¥Ïä§</h4>
        <div id="newsList">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>

      <!-- Í≥µÏßÄÏÇ¨Ìï≠ -->
      <div id="tab-notice" class="tab-section">
        <h3 style="margin:6px 0 10px;">üì¢ Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
        <div class="req-card" style="flex-direction:column; align-items:stretch;">
          <input type="text" id="noticeTitleInput" placeholder="Í≥µÏßÄ Ï†úÎ™©">
          <textarea id="noticeBodyInput" placeholder="Í≥µÏßÄ ÎÇ¥Ïö©"></textarea>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="postNotice()">Îì±Î°ù</button>
          </div>
        </div>
        <h4 style="margin:12px 0 6px;">Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠</h4>
        <div id="noticeList">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>

      <!-- ÏÉÅÏû•ÌèêÏßÄ -->
      <div id="tab-delist" class="tab-section">
        <h3 style="margin:6px 0 10px;">‚ö´ ÏÉÅÏû•ÌèêÏßÄ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
        <div id="delistPanel">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>
    </div>
  </div>

  <!-- Ï±ÑÌåÖ Î∞ïÏä§ (Î°úÏª¨/20Í∞ú Ï†úÌïú, Íµ¨ÎèÖÌòï) -->
  <div id="chatBox">
    <div id="chatHeader">
      <div class="title"><span class="dot"></span><span>Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</span></div>
      <button id="chatToggleBtn" style="padding:6px 10px; border-radius:8px;">‚Äî</button>
    </div>
    <div id="chatMessages"></div>
    <div id="chatResizer" title="ÎìúÎûòÍ∑∏Î°ú ÎÜíÏù¥ Ï°∞Ï†à"></div>
    <div id="chatInputWrap">
      <input id="chatInput" type="text" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• ÌõÑ Enter" />
      <button onclick="sendChat()">Î≥¥ÎÇ¥Í∏∞</button>
    </div>
  </div>

  <!-- ÌÜ†Ïä§Ìä∏ -->
  <div id="toast"><div class="bubble" id="toastMsg">ÏôÑÎ£å</div></div>

    <!-- ====== Ïä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûë ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs,
      updateDoc, onSnapshot, query, orderBy, deleteDoc, writeBatch, increment
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
      authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
      projectId: "cotyledons-of-stock-a1241",
      storageBucket: "cotyledons-of-stock-a1241.appspot.com",
      messagingSenderId: "962984742513",
      appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
      measurementId: "G-NRPT075Q3X"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== DOM =====
    const userInfo      = document.getElementById("userInfo");
    const companiesDiv  = document.getElementById("companies");
    const acctNo        = document.getElementById("acctNo");
    const cashAmount    = document.getElementById("cashAmount");
    const cashMemo      = document.getElementById("cashMemo");
    const logDiv        = document.getElementById("log");
    const loginBtn      = document.getElementById("startBtn");
    const loginModal    = document.getElementById("loginModal");
    const modeToggleBtn = document.querySelector('button[onclick="toggleMarketMode()"]');

    // ===== ÏÉÅÌÉú =====
    let chart = null;
    let priceTimer = null;
    let updateInterval = 5000;
    let deltaMax = 1_000_000;
    let marketOpenFlag = false;
    let ADMIN_MODE = false;

    let volatility = 1.5;
    let lastChartTick = 0;

    // Î™®Îìú: 'stock' | 'coin'
    let marketMode = 'stock';

    // Ï£ºÏãù/ÏΩîÏù∏ Î≥Ñ ÎÇ¥Î∂ÄÏÉÅÌÉú(Í±∞Îûò Ï∂©Í≤©Ïπò)
    const stockState = { bias: {} };
    const coinState  = { bias: {} };
    const companyChances = {};  // {id:{profit,loss}}
    const coinChances    = {};  // {id:{profit,loss}}

    // ÌîåÎ†àÏù¥Ïñ¥
    let player = { holdingsStock:{}, holdingsCoin:{}, cash:0 };
    let currentUser = null;

    // Íµ¨ÎèÖ Ìï¥Ï†ú Ìï∏Îì§
    let unsubscribeUser = null;
    let unsubUsers = null;
    let unsubDeposits = null;
    let unsubWithdraws = null;
    let unsubGlobals = null;
    let unsubNews = null;
    let unsubNotices = null;

    // Îâ¥Ïä§ Î±ÉÏßÄ
    let lastReadNewsAt = Number(localStorage.getItem('lastReadNewsAt') || 0);

    // ÏãúÎÆ¨ ÎìúÎùºÏù¥Î≤Ñ ÌÜ†ÌÅ∞
    const localSimId = (() => {
      let id = localStorage.getItem('simId');
      if(!id){
        id = 'sim-' + Math.random().toString(36).slice(2);
        localStorage.setItem('simId', id);
      }
      return id;
    })();

    // ===== Ïú†Ìã∏ =====
    const ci = s => String(s||"").toLowerCase();
    const safeId = name => String(name).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g,'_');
    const parseNumber = (str) => {
      const n = parseInt(String(str).replace(/[^0-9]/g,''), 10);
      return isNaN(n) ? 0 : Math.max(0, n);
    };
    const log = (msg) => { if(!logDiv) return; logDiv.innerHTML = "<div>" + msg + "</div>" + logDiv.innerHTML; };

    // ===== ÏûêÏÇ∞Î™©Î°ù =====
    const companies = [
      {name:"Îñ°ÏûéÎ∞©Î≤îÎåÄ", basePrice:8235460, multiplier:1, livePrice:8235460},
      {name:"Ïπ¥Ïä§Ìã∏Î°ú",   basePrice:8243313, multiplier:1, livePrice:8243313},
      {name:"ÏÇ¨Ïø†Îùº",     basePrice:8675827, multiplier:1, livePrice:8675827},
      {name:"Ï≤≠Î£°",       basePrice:8780548, multiplier:1, livePrice:8780548},
      {name:"ÎÇ®Î∂ÄÍ≤ΩÏ∞∞",   basePrice:7602028, multiplier:1, livePrice:8604028},
      {name:"Î∂ÅÎ∂ÄÍ≤ΩÏ∞∞",   basePrice:8304028, multiplier:1, livePrice:8604028},
      {name:"Ems",        basePrice:7368996, multiplier:1, livePrice:7368996},
      {name:"ÏûëÎëê",       basePrice:5212916, multiplier:1, livePrice:5212916},
      {name:"ÎπÖÎîï",       basePrice:8683470, multiplier:1, livePrice:8683470},
      {name:"Ï∞®Ïπ¥Îãà",     basePrice:8749821, multiplier:1, livePrice:8749821},
      {name:"inback",     basePrice:8585880, multiplier:1, livePrice:8585880},
      {name:"Î¶¨ÏñºÏõîÎìú/ Í¥ÄÎ¶¨Ïûê", basePrice:7244327, multiplier:1, livePrice:7244327},
    ].map(c => ({...c, id: safeId(c.name), delisted:false}));

    const coins = [
      {name:"ÎπÑÌä∏ÏΩîÏù∏",  basePrice:54000000, multiplier:1, livePrice:54000000},
      {name:"Ïù¥ÎçîÎ¶¨ÏõÄ",  basePrice:3600000,  multiplier:1, livePrice:3600000},
      {name:"Î¶¨Ìîå",      basePrice:700,      multiplier:1, livePrice:700}
    ].map(c => ({...c, id: safeId(c.name), delisted:false}));

    const getActiveList     = () => marketMode === 'coin' ? coins : companies;
    const getActiveState    = () => marketMode === 'coin' ? coinState : stockState;
    const getActiveChances  = () => marketMode === 'coin' ? coinChances : companyChances;
    const getDisplayPrice   = (a) => Math.max(1, Math.floor(typeof a.livePrice==='number' ? a.livePrice : a.basePrice));
    const findById          = (arr, id) => arr.find(x => ci(x.id)===ci(id) || ci(x.name)===ci(id));

    // ===== Ï∞®Ìä∏ =====
    function initChart(){
      if(chart) return;
      const ctx = document.getElementById("chart").getContext("2d");
      chart = new Chart(ctx, {
        type:"line",
        data:{ labels:[], datasets: [] },
        options:{
          responsive:true, maintainAspectRatio:false, animation:false,
          plugins:{ legend:{position:"bottom"} },
          scales:{
            x:{ title:{display:true, text:"ÏãúÍ∞Ñ"} },
            y:{ title:{display:true, text:"Í∞ÄÍ≤© (KRW)"}, beginAtZero:false }
          }
        }
      });
      rebuildChartDatasets();
    }
    function rebuildChartDatasets(){
      if(!chart) return;
      const list = getActiveList();
      chart.data.labels = [];
      chart.data.datasets = list.map(c => ({
        label:c.name, data:[], borderWidth:2, fill:false, tension:0.25
      }));
      chart.update();
    }
    function appendChartPoint(tickMs){
      if(!chart) return;
      const label = new Date(tickMs||Date.now()).toLocaleTimeString();
      chart.data.labels.push(label);
      const list = getActiveList();
      chart.data.datasets.forEach((d, i) => {
        const a = list[i];
        d.data.push(a ? getDisplayPrice(a) : 0);
      });
      const MAX=120;
      if(chart.data.labels.length>MAX){
        chart.data.labels.splice(0, chart.data.labels.length-MAX);
        chart.data.datasets.forEach(d=>{ if(d.data.length>MAX) d.data.splice(0, d.data.length-MAX); });
      }
      chart.update("none");
    }

        // ===== Î™®Îìú ÌÜ†Í∏Ä =====
    window.toggleMarketMode = function(){
      marketMode = (marketMode === 'stock') ? 'coin' : 'stock';
      if(modeToggleBtn){
        modeToggleBtn.textContent = (marketMode === 'stock') ? "üí± ÏΩîÏù∏ / Ï£ºÏãù Ï†ÑÌôò" : "üíπ Ï£ºÏãù / ÏΩîÏù∏ Ï†ÑÌôò";
      }
      renderMarketStatus();
      initAssetUI();
      rebuildChartDatasets();
      renderAllAdminPanels();
    };

    // ===== Í∏∞Î≥∏ Î†åÎçî =====
    function updateTradeButtons(){
      const list = getActiveList();
      list.forEach(a=>{
        const card = document.getElementById("card-" + a.id);
        if(!card) return;
        const btns = card.querySelectorAll("button");
        btns.forEach(b=>{
          const isTrade = b.textContent.includes('Îß§Ïàò') || b.textContent.includes('Îß§ÎèÑ');
          if(isTrade){ b.disabled = (!marketOpenFlag) || a.delisted; }
        });
        const qty = document.getElementById("qty-" + a.id);
        if(qty) qty.disabled = (!marketOpenFlag) || a.delisted;
      });
    }
    function renderMarketStatus(){
      const list = getActiveList();
      list.forEach(a=>{
        const el = document.getElementById("marketStatus-" + a.id);
        if(!el) return;
        if(a.delisted){
          el.textContent = "‚ö´ ÏÉÅÏû•ÌèêÏßÄ";
          el.classList.add('delisted');
          const card = document.getElementById("card-" + a.id);
          if(card) card.classList.add('delisted');
        }else{
          el.classList.remove('delisted');
          const statusText = marketOpenFlag ? "üü¢ Í∞úÏû• Ï§ë" : "üî¥ ÎßàÍ∞ê";
          if(el.dataset.initial==="true" && !marketOpenFlag){ el.textContent = "üü° ÎåÄÍ∏∞"; }
          else{ el.textContent = statusText; }
          const card = document.getElementById("card-" + a.id);
          if(card) card.classList.remove('delisted');
        }
        el.dataset.initial="false";
      });
      updateTradeButtons();
    }
    function updateHoldingsUI(){
      const list = getActiveList();
      const isCoin = (marketMode==='coin');
      list.forEach(a=>{
        const el = document.getElementById("hold-" + a.id);
        if(!el) return;
        const qty = isCoin ? (player.holdingsCoin[a.name]||0) : (player.holdingsStock[a.name]||0);
        el.textContent = qty;
      });
      updateMaxBuyUI();
    }
    function renderUserInfo(){
      if(currentUser){
        // ÏΩîÏù∏ Ï¥ùÌï©(Í∞ú)
        const totalCoins = Object.values(player.holdingsCoin||{}).reduce((s,v)=>s+(v||0),0);
        userInfo.innerHTML = `
          üë§ <strong>${currentUser.name}</strong> (${currentUser.id})
          &nbsp;|&nbsp; üíµ Î≥¥Ïú†ÌòÑÍ∏à: <strong>${(player.cash||0).toLocaleString()} KRW</strong>
          &nbsp;|&nbsp; ü™ô ÏΩîÏù∏: <strong>${totalCoins}</strong>Í∞ú
        `;
      }else{
        userInfo.textContent="‚è≥ Î°úÍ∑∏Ïù∏ ÎåÄÍ∏∞Ï§ë...";
      }
      updateMaxBuyUI();
    }
    function updateMaxBuyUI(){
      const list = getActiveList();
      list.forEach(a=>{
        const el = document.getElementById("maxbuy-" + a.id);
        if(el){
          const price = getDisplayPrice(a);
          const maxQty = Math.floor((player.cash||0) / price);
          el.textContent = `(ÏµúÎåÄ ${maxQty}${marketMode==='coin'?'Í∞ú':'Ï£º'} Îß§Ïàò Í∞ÄÎä•)`;
        }
      });
    }
    function initAssetUI(){
      let html="";
      const list = getActiveList();
      const isCoin = (marketMode==='coin');

      list.forEach(a=>{
        const disabledTrade = (!marketOpenFlag) || a.delisted;
        const priceText = getDisplayPrice(a).toLocaleString();
        const cardCls = "company" + (a.delisted ? " delisted" : "");
        const badgeCls = "status-badge" + (a.delisted ? " delisted" : "");
        html += `
          <div class="${cardCls}" id="card-${a.id}">
            <div class="info">
              <span>${a.name}</span>
              <span class="${badgeCls}" id="marketStatus-${a.id}" data-initial="true">${a.delisted ? "‚ö´ ÏÉÅÏû•ÌèêÏßÄ" : "üü° ÎåÄÍ∏∞"}</span>
            </div>
            <div>Í∞ÄÍ≤©: <strong><span id="price-${a.id}">${priceText}</span> KRW</strong></div>
            <div>
              Î≥¥Ïú†: <span id="hold-${a.id}">${isCoin ? (player.holdingsCoin[a.name]||0) : (player.holdingsStock[a.name]||0)}</span> ${isCoin?'Í∞ú':'Ï£º'}
              <span id="maxbuy-${a.id}" style="color:#10b981; font-size:13px; margin-left:6px;">
                (ÏµúÎåÄ ${Math.floor((player.cash||0)/getDisplayPrice(a))}${isCoin?'Í∞ú':'Ï£º'} Îß§Ïàò Í∞ÄÎä•)
              </span>
            </div>
            <div class="actions">
              <input type="number" id="qty-${a.id}" min="1" value="1" ${disabledTrade?'disabled':''}>
              <button ${disabledTrade?'disabled':''} onclick="buyAsset('${a.name}', getQty('${a.name}'))">Îß§Ïàò</button>
              <button ${disabledTrade?'disabled':''} onclick="sellAsset('${a.name}', getQty('${a.name}'))">Îß§ÎèÑ</button>
            </div>
          </div>
        `;
      });
      companiesDiv.innerHTML = html;
      updateMaxBuyUI();
    }
    function getQty(name){
      const id = "qty-" + safeId(name);
      const el = document.getElementById(id);
      const v  = parseInt(el?.value) || 1;
      return Math.max(1, v);
    }

    // ===== Í±∞Îûò Ï∂©Í≤©Ïπò =====
    function impactPrice(state, nameOrId, qty, mode){
      const list = (state===coinState) ? coins : companies;
      const c = findById(list, nameOrId);
      if(!c) return;
      const size = Math.max(1, qty);
      const step = Math.min(0.1, size / 10000);
      const sign = (mode === 'buy') ? -1 : +1;
      const next = (state.bias[c.id] || 0) + sign * step;
      state.bias[c.id] = Math.max(-1, Math.min(1, next));
    }

    // ===== Îß§Ïàò/Îß§ÎèÑ =====
    window.buyAsset = async function(name, qty){
      const list  = getActiveList();
      const state = getActiveState();
      const isCoin= (marketMode==='coin');
      const c = findById(list, name); if(!c) return;
      if(c.delisted) return alert('‚õî ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Í±∞Îûò Î∂àÍ∞Ä');
      if(!marketOpenFlag) return alert('‚õî Ïû• ÎßàÍ∞ê Ï§ë');
      if(!currentUser) return alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©');

      const p = getDisplayPrice(c);
      const total = p * qty;
      if(player.cash < total) return alert('ÌòÑÍ∏à Î∂ÄÏ°±');

      player.cash -= total;
      if(isCoin){
        player.holdingsCoin[c.name] = (player.holdingsCoin[c.name]||0) + qty;
      }else{
        player.holdingsStock[c.name] = (player.holdingsStock[c.name]||0) + qty;
      }

      try{
        await setDoc(doc(db,"users",currentUser.id),{
          cash:player.cash,
          holdingsStock: player.holdingsStock,
          holdingsCoin:  player.holdingsCoin,
          updatedAt:Date.now()
        },{merge:true});
        log(`üü¢ <strong>Îß§ÏàòÏ≤¥Í≤∞(${isCoin?'ÏΩîÏù∏':'Ï£ºÏãù'}):</strong> [${c.name}] ${qty}${isCoin?'Í∞ú':'Ï£º'} @ ${p.toLocaleString()} = <strong>${total.toLocaleString()}</strong>`);
      }catch(e){
        console.error("Îß§Ïàò Ï†ÄÏû• Ïã§Ìå®:", e);
        alert("Îß§Ïàò Ï†ÄÏû• Ïã§Ìå®: " + (e.message || e));
      }

      renderUserInfo(); updateHoldingsUI();
      impactPrice(state, c.id, qty, 'buy');
    };

    window.sellAsset = async function(name, qty){
      const list  = getActiveList();
      const state = getActiveState();
      const isCoin= (marketMode==='coin');
      const c = findById(list, name); if(!c) return;
      if(c.delisted) return alert('‚õî ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Í±∞Îûò Î∂àÍ∞Ä');
      if(!marketOpenFlag) return alert('‚õî Ïû• ÎßàÍ∞ê Ï§ë');
      if(!currentUser) return alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©');

      const p = getDisplayPrice(c);
      const owned = isCoin ? (player.holdingsCoin[c.name]||0) : (player.holdingsStock[c.name]||0);
      if(owned < qty) return alert('Î≥¥Ïú† ÏàòÎüâ Î∂ÄÏ°±');

      const total = p * qty;
      player.cash += total;
      if(isCoin){
        player.holdingsCoin[c.name] = owned - qty;
      }else{
        player.holdingsStock[c.name] = owned - qty;
      }

      try{
        await setDoc(doc(db,"users",currentUser.id),{
          cash:player.cash,
          holdingsStock: player.holdingsStock,
          holdingsCoin:  player.holdingsCoin,
          updatedAt:Date.now()
        },{merge:true});
        log(`üî¥ <strong>Îß§ÎèÑÏ≤¥Í≤∞(${isCoin?'ÏΩîÏù∏':'Ï£ºÏãù'}):</strong> [${c.name}] ${qty}${isCoin?'Í∞ú':'Ï£º'} @ ${p.toLocaleString()} = <strong>${total.toLocaleString()}</strong>`);
      }catch(e){
        console.error("Îß§ÎèÑ Ï†ÄÏû• Ïã§Ìå®:", e);
        alert("Îß§ÎèÑ Ï†ÄÏû• Ïã§Ìå®: " + (e.message || e));
      }

      renderUserInfo(); updateHoldingsUI();
      impactPrice(state, c.id, qty, 'sell');
    };

    // ===== Ïû• ÏãúÏûë/ÎßàÍ∞ê =====
    async function marketOpen(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      marketOpenFlag = true;
      try{
        await setDoc(doc(db,"marketState","main"), {
          isOpen:true, interval:updateInterval, driverId: localSimId, updatedAt: Date.now()
        }, { merge:true });
      }catch(e){ console.warn(e); }
      renderMarketStatus();
      await updatePrices();
      startLocalTimer();
      alert("‚úÖ Ïû• ÏãúÏûë (Ï£ºÏãù+ÏΩîÏù∏ ÎèôÏãú)");
    }
    async function marketClose(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      marketOpenFlag = false;
      try{
        await setDoc(doc(db,"marketState","main"), { isOpen:false, updatedAt: Date.now() }, { merge:true });
      }catch(e){ console.warn(e); }
      stopLocalTimer();
      renderMarketStatus();
      alert("üìâ Ïû• ÎßàÍ∞ê (Ï£ºÏãù+ÏΩîÏù∏ ÎèôÏãú)");
    }
    function startLocalTimer(){
      if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
      priceTimer = setInterval(()=>{ updatePrices().catch(()=>{}); }, updateInterval);
    }
    function stopLocalTimer(){
      if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
    }
    function subscribeMarketState(){
      onSnapshot(doc(db,"marketState","main"), (snap)=>{
        const d = snap.exists() ? snap.data() : {};
        marketOpenFlag = !!d.isOpen;
        if(typeof d.interval === "number" && d.interval >= 500){ updateInterval = d.interval; }
        const amDriver = d.driverId === localSimId;

        renderMarketStatus();

        if(priceTimer){ clearInterval(priceTimer); priceTimer = null; }
        if(marketOpenFlag && amDriver){ startLocalTimer(); }
      });
    }

    // ===== ÏãúÎÆ¨(Ï£ºÏãù+ÏΩîÏù∏ ÎèôÏãú) =====
    async function updatePrices(){
      if(!marketOpenFlag) return;
      const tickAt = Date.now();
      const batch = writeBatch(db);

      const stepAsset = (list, state, coll, chancesMap)=>{
        for(const a of list){
          if(a.delisted) continue;
          const prev = a.livePrice || a.basePrice;
          const chance = chancesMap[a.id] || {profit:0.4, loss:0.6};
          const denom = Math.max(1e-6, (chance.profit + chance.loss));
          let isUp = Math.random() < (chance.profit / denom);

          const b = state.bias[a.id] || 0;
          if(b === -1) isUp = true;
          if(b ===  1) isUp = false;
          state.bias[a.id] = b * 0.5;

          const stepPct = (Math.random() * volatility / 100) * Math.max(0, a.multiplier || 1);
          const signed = isUp ? stepPct : -stepPct;
          let nextRaw = prev * (1 + signed);

          const diff = nextRaw - prev;
          if(Math.abs(diff) > deltaMax){ nextRaw = prev + Math.sign(diff) * deltaMax; }

          const next = Math.max(1, Math.round(nextRaw));

          a.livePrice = next;
          batch.set(doc(db,coll, a.id), { current: next, updatedAt: tickAt }, { merge:true });
        }
      };

      stepAsset(companies, stockState, 'companyPrices', companyChances);
      stepAsset(coins,     coinState,  'coinPrices',    coinChances);

      try{
        await batch.commit();
        await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt, driverId: localSimId }, { merge:true });
      }catch(e){ console.error("ÏãúÎÆ¨ Î∞òÏòÅ Ïã§Ìå®:", e); }
    }

    // ===== Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ(Ï£ºÏãù/ÏΩîÏù∏ Í∞ÄÍ≤©¬∑ÏÑ§Ï†ï¬∑ÌôïÎ•†) =====
    function subscribeCompanyPrices(){
      onSnapshot(collection(db,"companyPrices"), (snap)=>{
        let maxTick = 0;
        snap.forEach(docu=>{
          const data=docu.data();
          const a= findById(companies, docu.id);
          if(!a) return;
          if(typeof data.current==='number'){ a.livePrice=data.current; }
          if(typeof data.updatedAt==='number'){ maxTick = Math.max(maxTick, data.updatedAt); }
          const el = document.getElementById("price-" + a.id);
          if(el) el.textContent = getDisplayPrice(a).toLocaleString();
        });
        updateMaxBuyUI();
        if(maxTick && maxTick > lastChartTick){
          lastChartTick = maxTick;
          if(marketMode==='stock') appendChartPoint(maxTick);
        }
      });
    }
    function subscribeCoinPrices(){
      onSnapshot(collection(db,"coinPrices"), (snap)=>{
        let maxTick = 0;
        snap.forEach(docu=>{
          const data=docu.data();
          const a= findById(coins, docu.id);
          if(!a) return;
          if(typeof data.current==='number'){ a.livePrice=data.current; }
          if(typeof data.updatedAt==='number'){ maxTick = Math.max(maxTick, data.updatedAt); }
          const el = document.getElementById("price-" + a.id);
          if(el) el.textContent = getDisplayPrice(a).toLocaleString();
        });
        updateMaxBuyUI();
        if(maxTick && maxTick > lastChartTick){
          lastChartTick = maxTick;
          if(marketMode==='coin') appendChartPoint(maxTick);
        }
      });
    }

        // ===== ÏûÖÍ∏à ÏöîÏ≤≠ =====
    async function requestDeposit(){
      const id   = currentUser?.id || "";
      const name = currentUser?.name || "";
      const account = acctNo.value.trim();
      const amount  = parseNumber(cashAmount.value);
      const memo    = cashMemo.value.trim();
      if(!id || !name || !account || amount<=0){
        alert("‚ö†Ô∏è Í≥ÑÏ¢åÎ≤àÌò∏ÏôÄ Í∏àÏï°ÏùÑ Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
        return;
      }
      try{
        await addDoc(collection(db,"depositRequests"),{
          userId:id, userName:name, account, amount, memo,
          status:"pending", createdAt: Date.now()
        });
        alert(`üí∞ ${amount.toLocaleString()} KRW ÏûÖÍ∏à ÏöîÏ≤≠ ÏôÑÎ£å`);
        log(`<strong>üí∞ ÏûÖÍ∏àÏöîÏ≤≠:</strong> ${amount.toLocaleString()} KRW (${account})`);
        cashAmount.value=""; cashMemo.value=""; acctNo.value="";
      }catch(e){
        console.error("ÏûÖÍ∏à ÏöîÏ≤≠ Ïã§Ìå®:", e);
        alert("ÏûÖÍ∏à ÏöîÏ≤≠ Ïò§Î•ò: " + (e.message || e));
      }
    }
    window.requestDeposit = requestDeposit;

    // ===== Ï∂úÍ∏à ÏöîÏ≤≠ =====
    window.openWithdrawModal = ()=>{ document.getElementById('withdrawModal').style.display='flex'; };
    window.closeWithdrawModal = ()=>{ document.getElementById('withdrawModal').style.display='none'; };

    window.updateWithdrawFee = function(){
      const amount = parseNumber(document.getElementById('withdrawAmount').value);
      const asset  = document.getElementById('withdrawAsset')?.value || 'stock';
      const feeRate = (asset==='coin') ? 0.30 : 0.15;  // ÏΩîÏù∏ 30%, Ï£ºÏãù 15%
      const fee = Math.floor(amount * feeRate);
      const info = document.getElementById('withdrawFeeInfo');
      if(amount>0){
        const unit = (asset==='coin') ? 'Í∞ú(ÏΩîÏù∏)' : 'KRW';
        info.textContent = `ÏòàÏÉÅ ÏàòÏàòÎ£å: ${fee.toLocaleString()} ${unit} / Ïã§ÏßÄÍ∏â: ${(Math.max(0,amount-fee)).toLocaleString()} ${unit}`;
      }else info.textContent = "";
    };

    window.submitWithdraw = async function(){
      const id     = document.getElementById('withdrawId').value.trim();
      const name   = document.getElementById('withdrawName').value.trim();
      const amount = parseNumber(document.getElementById('withdrawAmount').value);
      const account= document.getElementById('withdrawAccount').value.trim();
      const asset  = document.getElementById('withdrawAsset')?.value || 'stock';

      if(!id || !name || amount<=0 || !account){
        alert('‚ö†Ô∏è Í≥†Ïú†Î≤àÌò∏, Ïù¥Î¶Ñ, Í∏àÏï°/Í∞úÏàò, Í≥ÑÏ¢åÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }
      const feeRate = (asset==='coin') ? 0.30 : 0.15;

      try{
        await addDoc(collection(db,'withdrawRequests'), {
          userId:id, userName:name, amount, account, assetType:asset,
          feeRate, status:'pending', createdAt: Date.now()
        });
        const fee = Math.floor(amount*feeRate);
        const unit = (asset==='coin') ? 'Í∞ú(ÏΩîÏù∏)' : 'KRW';
        alert('üì§ Ï∂úÍ∏à ÏöîÏ≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.');
        log(`<strong>üì§ Ï∂úÍ∏àÏöîÏ≤≠(${asset==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'}):</strong> ${amount.toLocaleString()} ${unit} (ÏàòÏàòÎ£å ${fee.toLocaleString()} / Ïã§ÏßÄÍ∏â ${(amount-fee).toLocaleString()} ${unit})`);
        window.closeWithdrawModal();
      }catch(e){
        console.error('Ï∂úÍ∏à ÏöîÏ≤≠ Ïã§Ìå®:', e);
        alert('Ï∂úÍ∏à ÏöîÏ≤≠ Ïò§Î•ò: ' + (e.message || e));
      }
    };

    // ===== Í¥ÄÎ¶¨Ïûê ÏûÖÏ∂úÍ∏à ÌÅê Î†åÎçîÎßÅ =====
    function renderFinanceQueues(startListen=false){
      const d = document.getElementById('depositRequests');
      const w = document.getElementById('withdrawRequests');
      if(d) d.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë...';
      if(w) w.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë...';

      if(startListen){
        if(unsubDeposits){ try{unsubDeposits();}catch(e){} unsubDeposits=null; }
        if(unsubWithdraws){ try{unsubWithdraws();}catch(e){} unsubWithdraws=null; }

        unsubDeposits = onSnapshot(collection(db,"depositRequests"), (snap)=>{
          let html="";
          snap.forEach(docu=>{
            const r=docu.data();
            if(r.status!=='pending') return;
            html += `
              <div class="req-card" id="dep-${docu.id}">
                <div>
                  <div><strong>${r.userName}</strong> (${r.userId})</div>
                  <div>Í≥ÑÏ¢å: ${r.account}</div>
                  <div>Í∏àÏï°: ${Number(r.amount||0).toLocaleString()} KRW</div>
                  <div>ÏÉÅÌÉú: ${r.status}</div>
                </div>
                <div style="display:flex; gap:6px;">
                  <button onclick="approveDeposit('${docu.id}', ${Number(r.amount||0)}, '${r.userId}')">ÏäπÏù∏</button>
                  <button onclick="rejectDeposit('${docu.id}')">Í±∞Ï†à</button>
                </div>
              </div>`;
          });
          if(d) d.innerHTML = html || "ÎåÄÍ∏∞Ï§ëÏù∏ ÏûÖÍ∏à ÏöîÏ≤≠ ÏóÜÏùå";
        });

        unsubWithdraws = onSnapshot(collection(db,"withdrawRequests"), (snap)=>{
          let html="";
          snap.forEach(docu=>{
            const r=docu.data();
            if(r.status!=='pending') return;
            const fee = Math.floor((r.amount||0) * (r.feeRate ?? (r.assetType==='coin'?0.30:0.15)));
            const unit = (r.assetType==='coin') ? 'Í∞ú(ÏΩîÏù∏)' : 'KRW';
            html += `
              <div class="req-card" id="wd-${docu.id}">
                <div>
                  <div><strong>${r.userName}</strong> (${r.userId})</div>
                  <div>ÏûêÏÇ∞: ${r.assetType==='coin'?'ÏΩîÏù∏(ÏàòÏàòÎ£å 30%)':'Ï£ºÏãù(ÏàòÏàòÎ£å 15%)'}</div>
                  <div>ÏöîÏ≤≠Ïï°/Í∞úÏàò: ${Number(r.amount||0).toLocaleString()} ${unit}
                    &nbsp;|&nbsp; ÏàòÏàòÎ£å: ${fee.toLocaleString()} ${unit}
                    &nbsp;|&nbsp; Ïã§ÏßÄÍ∏â: ${(Math.max(0,(r.amount||0)-fee)).toLocaleString()} ${unit}
                  </div>
                  <div>Ï∂úÍ∏à Í≥ÑÏ¢åÎ≤àÌò∏: <strong>${r.account||'-'}</strong></div>
                  <div>ÏÉÅÌÉú: ${r.status}</div>
                </div>
                <div style="display:flex; gap:6px;">
                  <button onclick="approveWithdraw('${docu.id}', ${Number(r.amount||0)}, '${r.userId}', '${r.assetType||'stock'}')">ÏäπÏù∏</button>
                  <button onclick="rejectWithdraw('${docu.id}')">Í±∞Ï†à</button>
                </div>
              </div>`;
          });
          if(w) w.innerHTML = html || "ÎåÄÍ∏∞Ï§ëÏù∏ Ï∂úÍ∏à ÏöîÏ≤≠ ÏóÜÏùå";
        });
      }
    }
    window.renderFinanceQueues = renderFinanceQueues;

    // ===== ÏûÖÏ∂úÍ∏à ÏäπÏù∏/Í±∞Ï†à Ï≤òÎ¶¨ =====
    async function approveDeposit(id, amount, userId){
      try{
        await updateDoc(doc(db,"users",userId), { cash: increment(amount), updatedAt: Date.now() });
        await updateDoc(doc(db,"depositRequests",id),{
          status:'approved', approvedBy: currentUser?.id||'admin', updatedAt:Date.now()
        });
      }catch(e){ console.error(e); alert('ÏäπÏù∏ Ï≤òÎ¶¨ Ïã§Ìå®: ' + (e.message || e)); }
    }
    async function rejectDeposit(id){
      try{
        await updateDoc(doc(db,"depositRequests",id),{status:'rejected', updatedAt:Date.now()});
      }catch(e){ console.error(e); alert('Í±∞Ï†à Ï≤òÎ¶¨ Ïã§Ìå®: ' + (e.message || e)); }
    }
    async function approveWithdraw(id, amount, userId, assetType){
      try{
        // Ï∂úÍ∏à: ÏöîÏ≤≠Ïï° Ï†ÑÏ≤¥Î•º ÌòÑÍ∏àÏóêÏÑú Ï∞®Í∞ê(ÏàòÏàòÎ£å Ìè¨Ìï®)
        const uref = doc(db,"users",userId);
        const usnap = await getDoc(uref);
        const cash = Number(usnap.data()?.cash||0);
        if(cash < amount){ alert('ÏÇ¨Ïö©Ïûê Î≥¥Ïú† ÌòÑÍ∏à Î∂ÄÏ°±ÏúºÎ°ú ÏäπÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.'); return; }
        await updateDoc(uref, { cash: increment(-amount), updatedAt: Date.now() });
        await updateDoc(doc(db,"withdrawRequests",id),{
          status:'approved', approvedBy: currentUser?.id||'admin', updatedAt:Date.now()
        });
      }catch(e){ console.error(e); alert('ÏäπÏù∏ Ï≤òÎ¶¨ Ïã§Ìå®: ' + (e.message || e)); }
    }
    async function rejectWithdraw(id){
      try{
        await updateDoc(doc(db,"withdrawRequests",id),{status:'rejected', updatedAt:Date.now()});
      }catch(e){ console.error(e); alert('Í±∞Ï†à Ï≤òÎ¶¨ Ïã§Ìå®: ' + (e.message || e)); }
    }
    window.approveDeposit = approveDeposit;
    window.rejectDeposit  = rejectDeposit;
    window.approveWithdraw= approveWithdraw;
    window.rejectWithdraw = rejectWithdraw;

        /* =========================
       Part 5 ‚Äî Îâ¥Ïä§ / Í≥µÏßÄ ÏãúÏä§ÌÖú
       - Îâ¥Ïä§/Í≥µÏßÄ ÌÉ≠ DOM ÏÉùÏÑ±(Î∂ÄÏû¨ Ïãú ÏûêÎèô Ï£ºÏûÖ)
       - Îâ¥Ïä§/Í≥µÏßÄ Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ, Î™®Îã¨ Î†åÎçî
       - Í¥ÄÎ¶¨Ïûê Îì±Î°ù/ÌëúÏãú/Ïà®ÍπÄ/ÏÇ≠Ï†ú
       - Îâ¥Ïä§ Î±ÉÏßÄ/ÏùΩÏùå Ï≤òÎ¶¨
    ==========================*/

    // --- ÏÉÅÌÉú
    let newsData = [];
    let newsDataAll = [];
    let noticeDataAll = [];

    // --- Í≥µÏö©: Í¥ÄÎ¶¨Ïûê ÌÉ≠ DOM Î≥¥Ïû• (news / notice ÌÉ≠ UIÍ∞Ä ÏóÜÏúºÎ©¥ ÏûêÎèô ÏÉùÏÑ±)
    function ensureNewsNoticeTabDOM(){
      const panel = document.querySelector('#adminPanelAll > div:nth-child(2)'); // Ìó§Îçî Îã§Ïùå Ïª®ÌÖêÏ∏†ÏòÅÏó≠
      if(!panel) return;

      // Îâ¥Ïä§ ÌÉ≠
      if(!document.getElementById('tab-news')){
        const tabNews = document.createElement('div');
        tabNews.id = 'tab-news';
        tabNews.className = 'tab-section';
        tabNews.style.display = 'none';
        tabNews.innerHTML = `
          <h3>üì∞ Îâ¥Ïä§ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
          <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
            <input type="text" id="newsTitleInput" placeholder="Îâ¥Ïä§ Ï†úÎ™©">
            <textarea id="newsBodyInput" placeholder="Îâ¥Ïä§ ÎÇ¥Ïö©"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="postNews()">Îì±Î°ù</button>
            </div>
          </div>
          <h4>Îì±Î°ùÎêú Îâ¥Ïä§</h4>
          <div id="newsList">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tabNews);
      }

      // Í≥µÏßÄ ÌÉ≠
      if(!document.getElementById('tab-notice')){
        const tabNotice = document.createElement('div');
        tabNotice.id = 'tab-notice';
        tabNotice.className = 'tab-section';
        tabNotice.style.display = 'none';
        tabNotice.innerHTML = `
          <h3>üì¢ Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
          <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
            <input type="text" id="noticeTitleInput" placeholder="Í≥µÏßÄ Ï†úÎ™©">
            <textarea id="noticeBodyInput" placeholder="Í≥µÏßÄ ÎÇ¥Ïö©"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="postNotice()">Îì±Î°ù</button>
            </div>
          </div>
          <h4>Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠</h4>
          <div id="noticeList">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tabNotice);
      }
    }

    // --- Îâ¥Ïä§ Î±ÉÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
    function updateNewsBadge(count){
      const badge = document.getElementById('newsBadge');
      if(!badge) return;
      if(count > 0){
        badge.style.display = 'inline';
        badge.textContent = String(count);
      }else{
        badge.style.display = 'none';
      }
    }

    // --- Îâ¥Ïä§: Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ
    function subscribeNews(){
      if(unsubNews){ try{unsubNews();}catch(e){} unsubNews = null; }
      const qy = query(collection(db,'news'), orderBy('createdAt','desc'));
      unsubNews = onSnapshot(qy, (snap)=>{
        const visibleList = [];
        const allList = [];
        snap.forEach(docu=>{
          const n = { id:docu.id, ...(docu.data()||{}) };
          allList.push(n);
          if(n.visible !== false) visibleList.push(n);
        });
        newsData = visibleList;
        newsDataAll = allList;

        // ÏÉàÎ°ú Ïò¨ÎùºÏò®(visible) Îâ¥Ïä§ Í∞úÏàò Î±ÉÏßÄ
        const unread = visibleList.filter(n => (n.createdAt||0) > lastReadNewsAt).length;
        updateNewsBadge(unread);

        renderNewsModal();
        renderNewsAdminList();
      });
    }

    // --- Îâ¥Ïä§: ÏÇ¨Ïö©Ïûê Î™®Îã¨ Î†åÎçî
    function renderNewsModal(){
      const host = document.getElementById('newsContent');
      if(!host) return;
      if(!newsData.length){
        host.innerHTML = `<p>ÌòÑÏû¨ Îì±Î°ùÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
        return;
      }
      host.innerHTML = newsData.map(n=>{
        const dt = new Date(n.createdAt||Date.now()).toLocaleString();
        const title = (n.title||'Ï†úÎ™© ÏóÜÏùå');
        const body  = (n.content||'').replace(/\n/g,'<br>');
        return `
          <div style="padding:8px 0; border-bottom:1px solid #374151;">
            <div style="font-weight:700;">${title}</div>
            <div style="color:#9ca3af; font-size:12px;">${dt}</div>
            <div style="margin-top:6px;">${body}</div>
          </div>
        `;
      }).join('');
    }

    // --- Îâ¥Ïä§: Í¥ÄÎ¶¨Ïûê Î¶¨Ïä§Ìä∏ Î†åÎçî
    function renderNewsAdminList(){
      const list = document.getElementById('newsList');
      if(!list) return;
      if(!newsDataAll.length){
        list.textContent = 'Îì±Î°ùÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.';
        return;
      }
      list.innerHTML = newsDataAll.map(n=>{
        const dt = new Date(n.createdAt||Date.now()).toLocaleString();
        const title = (n.title||'Ï†úÎ™© ÏóÜÏùå');
        const body  = (n.content||'').slice(0,140) + ((n.content||'').length>140?'...':'');
        const vis   = (n.visible!==false);
        return `
          <div class="req-card" data-id="${n.id}">
            <div>
              <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
              <div style="color:#cbd5e1; font-size:14px;">${body}</div>
              <div style="color:${vis?'#10b981':'#ef4444'}; font-size:12px; margin-top:4px;">
                ${vis?'ÌëúÏãúÏ§ë':'Ïà®ÍπÄ'}
              </div>
            </div>
            <div style="display:flex; gap:6px;">
              <button onclick="toggleNewsVisibility('${n.id}', ${vis})">${vis?'Ïà®ÍπÄ':'ÌëúÏãú'}</button>
              <button onclick="deleteNews('${n.id}')" style="background:#7f1d1d;">ÏÇ≠Ï†ú</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Îâ¥Ïä§: Îì±Î°ù/ÌëúÏãú/ÏÇ≠Ï†ú
    window.postNews = async function(){
      const titleEl = document.getElementById('newsTitleInput');
      const bodyEl  = document.getElementById('newsBodyInput');
      const title = (titleEl?.value||'').trim();
      const content = (bodyEl?.value||'').trim();
      if(!title || !content){ alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
      try{
        await addDoc(collection(db,'news'), {
          title, content,
          createdAt: Date.now(),
          authorId: currentUser?.id || 'admin',
          authorName: currentUser?.name || 'Í¥ÄÎ¶¨Ïûê',
          visible: true
        });
        if(titleEl) titleEl.value = '';
        if(bodyEl) bodyEl.value = '';
        alert('üì∞ Îâ¥Ïä§Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
      }catch(e){
        console.error(e);
        alert('Îâ¥Ïä§ Îì±Î°ù Ïò§Î•ò: ' + (e.message || e));
      }
    };
    window.toggleNewsVisibility = async function(id, currentVisible){
      try{
        await updateDoc(doc(db,'news',id), { visible: !currentVisible, updatedAt: Date.now() });
      }catch(e){
        console.error(e);
        alert('ÌëúÏãú/Ïà®ÍπÄ Î≥ÄÍ≤Ω Ïò§Î•ò: ' + (e.message || e));
      }
    };
    window.deleteNews = async function(id){
      if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      try{
        await deleteDoc(doc(db,'news',id));
      }catch(e){
        console.error(e);
        alert('ÏÇ≠Ï†ú Ïò§Î•ò: ' + (e.message || e));
      }
    };

    // --- Í≥µÏßÄ: Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ
    function subscribeNotices(){
      if(unsubNotices){ try{unsubNotices();}catch(e){} unsubNotices = null; }
      const qy = query(collection(db,'notices'), orderBy('createdAt','desc'));
      unsubNotices = onSnapshot(qy, (snap)=>{
        const allList=[];
        snap.forEach(docu=>{
          const n = { id:docu.id, ...(docu.data()||{}) };
          allList.push(n);
        });
        noticeDataAll = allList;
        renderNoticeModal();
        renderNoticeAdminList();
      });
    }

    // --- Í≥µÏßÄ: ÏÇ¨Ïö©Ïûê Î™®Îã¨ Î†åÎçî
    function renderNoticeModal(){
      const host=document.getElementById('noticeContent');
      if(!host) return;
      if(!noticeDataAll.length){
        host.innerHTML="<p>ÌòÑÏû¨ Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>";
        return;
      }
      host.innerHTML = noticeDataAll.map(n=>{
        const dt=new Date(n.createdAt||Date.now()).toLocaleString();
        const title=(n.title||'Í≥µÏßÄÏÇ¨Ìï≠');
        const body=(n.content||'').replace(/\n/g,'<br>');
        return `
          <div style="padding:8px 0; border-bottom:1px solid #374151;">
            <div style="font-weight:700;">${title}</div>
            <div style="color:#9ca3af; font-size:12px;">${dt}</div>
            <div style="margin-top:6px;">${body}</div>
          </div>
        `;
      }).join('');
    }

    // --- Í≥µÏßÄ: Í¥ÄÎ¶¨Ïûê Î¶¨Ïä§Ìä∏ Î†åÎçî
    function renderNoticeAdminList(){
      const list=document.getElementById('noticeList');
      if(!list) return;
      if(!noticeDataAll.length){
        list.textContent="Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.";
        return;
      }
      list.innerHTML=noticeDataAll.map(n=>{
        const dt=new Date(n.createdAt||Date.now()).toLocaleString();
        const title=(n.title||'Í≥µÏßÄÏÇ¨Ìï≠');
        const body=(n.content||'').slice(0,140)+((n.content||'').length>140?'...':'');
        return `
          <div class="req-card" data-id="${n.id}">
            <div>
              <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
              <div style="color:#cbd5e1; font-size:14px;">${body}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button onclick="deleteNotice('${n.id}')" style="background:#7f1d1d;">ÏÇ≠Ï†ú</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- Í≥µÏßÄ: Îì±Î°ù/ÏÇ≠Ï†ú
    window.postNotice = async function(){
      const titleEl=document.getElementById('noticeTitleInput');
      const bodyEl=document.getElementById('noticeBodyInput');
      const title=(titleEl?.value||'').trim();
      const content=(bodyEl?.value||'').trim();
      if(!title||!content){ alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
      try{
        await addDoc(collection(db,'notices'),{
          title, content,
          createdAt:Date.now(),
          authorId: currentUser?.id||'admin',
          authorName: currentUser?.name||'Í¥ÄÎ¶¨Ïûê'
        });
        if(titleEl) titleEl.value='';
        if(bodyEl) bodyEl.value='';
        alert('üì¢ Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
      }catch(e){
        console.error(e);
        alert('Í≥µÏßÄÏÇ¨Ìï≠ Îì±Î°ù Ïã§Ìå®: ' + (e.message || e));
      }
    };
    window.deleteNotice = async function(id){
      if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      try{
        await deleteDoc(doc(db,'notices',id));
      }catch(e){
        console.error(e);
        alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + (e.message || e));
      }
    };

    // --- Îâ¥Ïä§ / Í≥µÏßÄ Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
    window.openNewsModal  = () => {
      const m = document.getElementById('newsModal');
      if(m){ m.style.display='flex'; }
      lastReadNewsAt = Date.now();
      localStorage.setItem('lastReadNewsAt', String(lastReadNewsAt));
      updateNewsBadge(0);
    };
    window.closeNewsModal = () => {
      const m = document.getElementById('newsModal');
      if(m){ m.style.display='none'; }
    };
    window.openNoticeModal = () => {
      const m = document.getElementById('noticeModal');
      if(m){ m.style.display='flex'; }
    };
    window.closeNoticeModal = () => {
      const m = document.getElementById('noticeModal');
      if(m){ m.style.display='none'; }
    };

    // --- Ï¥àÍ∏∞Ìôî ÌõÖ(ÌÉ≠DOM Î≥¥Ïû• + Íµ¨ÎèÖ ÏãúÏûë)
    function __initNewsNoticeUI(){
      ensureNewsNoticeTabDOM();
      subscribeNews();
      subscribeNotices();
    }
    // Î∞îÎ°ú Ï§ÄÎπÑ (Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎî© Ïãú ÏÉùÏÑ± Í∞ÄÎä•)
    __initNewsNoticeUI();

        /* ===========================================
       Part 6 ‚Äî ÏÉÅÏû•ÌèêÏßÄ/Î≥µÍµ¨ ¬∑ Î∞∞Ïú®/ÌôïÎ•† ¬∑ Í∑∏ÎûòÌîÑ/Ìã± ¬∑ ÏãúÎÇòÎ¶¨Ïò§
       - Í¥ÄÎ¶¨ÌÉ≠(Í∑∏ÎûòÌîÑ/Ï£ºÍ∞ÄÏ°∞Ïûë/Î∞∞Ïú®-ÌôïÎ•†/ÏÉÅÏû•ÌèêÏßÄ/Ïú†Ï†Ä/ÏûÖÏ∂úÍ∏à) DOM Î≥¥Ïû•
       - Í∑∏ÎûòÌîÑ Í∞úÎ≥Ñ/Ï†ÑÏ≤¥ Ï°∞Ï†ï, Î≥ÄÎèôÏ£ºÍ∏∞/ÏÉÅÌïú, Ï†ÑÏó≠ Î≥ÄÎèôÌè≠, ÏãúÎÇòÎ¶¨Ïò§
       - Ìã±(¬±Î≤ÑÌäº) Ï°∞Ï†ï
       - Î∞∞Ïú®/ÌôïÎ•† Í∞úÎ≥Ñ/Ï†ÑÏ≤¥ Ï†ÅÏö©
       - ÏÉÅÏû•ÌèêÏßÄ/Î≥µÍµ¨ (+Î≥¥Ïú†ÏàòÎüâ Ï†ïÎ¶¨)
    ============================================*/

    // --- ÏΩîÏñ¥ Í¥ÄÎ¶¨Ïûê ÌÉ≠ DOM Î≥¥Ïû• (ÌÉ≠ ÏÑπÏÖòÏù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±)
    function ensureCoreAdminTabsDOM(){
      const panel = document.querySelector('#adminPanelAll > div:nth-child(2)'); // Ïª®ÌÖêÏ∏† ÏòÅÏó≠
      if(!panel) return;

      // Í∑∏ÎûòÌîÑ ÌÉ≠
      if(!document.getElementById('tab-graph')){
        const tab = document.createElement('div');
        tab.id = 'tab-graph';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>üìä Í∑∏ÎûòÌîÑ/Í∏àÏï° Ï†úÏñ¥ Ìå®ÎÑê</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
            <button onclick="marketStart()">Ïû• ÏãúÏûë + ÏãúÏÑ∏ ÏãúÏûë</button>
            <button onclick="marketEnd()">Ïû• ÎßàÍ∞ê + ÏãúÏÑ∏ Ï†ïÏßÄ</button>
            <button onclick="resetGraph()">Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî</button>
          </div>

          <div class="req-card" style="gap:10px; align-items:center;">
            <div><strong>Ï†ÑÏ≤¥ ÏùºÍ¥Ñ Ï°∞Ï†ï</strong></div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input id="allDelta" type="number" placeholder="¬±Í∏àÏï°" style="width:120px;">
              <button onclick="adjustAllPrices()">Ï†ÑÏ≤¥ Ï†ÅÏö©</button>
              <span style="width:14px"></span>
              <label>Ï†ÑÏó≠ Î≥ÄÎèôÌè≠(%)</label>
              <input id="volatilityInput" type="number" step="0.1" value="1.5" style="width:90px;">
              <button onclick="applyVolatility()">Ï†ÅÏö©</button>
              <span style="width:14px"></span>
              <label>Î≥ÄÎèô Ï£ºÍ∏∞(Ï¥à)</label>
              <input id="intervalInput" type="number" step="1" value="5" style="width:90px;">
              <button onclick="applyGraphInterval()">Ï†ÅÏö©</button>
              <span style="width:14px"></span>
              <label>1Ìã± ÏÉÅÌïú(¬±Ïõê)</label>
              <input id="deltaMaxInput" type="number" step="1000" value="1000000" style="width:120px;">
              <button onclick="applyDeltaMax()">Ï†ÅÏö©</button>
            </div>
          </div>

          <div class="req-card" style="gap:10px; align-items:center;">
            <div><strong>Îπ†Î•∏ ÏãúÎÇòÎ¶¨Ïò§</strong></div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="runScenario('riseEnd')">üìà Îã®Í∏∞ ÏÉÅÏäπ Ïú†ÎèÑ(1Î∂Ñ)</button>
              <button onclick="runScenario('dropEnd')">üìâ Îã®Í∏∞ ÌïòÎùΩ Ïú†ÎèÑ(1Î∂Ñ)</button>
            </div>
          </div>

          <h4 style="margin:12px 0 6px;">Í∞úÎ≥Ñ Í∏àÏï° Ï°∞Ï†ï</h4>
          <div id="graphCompanyAdjust">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tab);
      }

      // Ï£ºÍ∞ÄÏ°∞Ïûë(Ìã±) ÌÉ≠
      if(!document.getElementById('tab-stock')){
        const tab = document.createElement('div');
        tab.id = 'tab-stock';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>üéõÔ∏è Ï£ºÍ∞Ä Ï°∞Ïûë Ìå®ÎÑê (Ìã± Îã®ÏúÑ Ïù¥Îèô)</h3>
          <div id="stockTuner">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tab);
      }

      // Î∞∞Ïú®/ÌôïÎ•† ÌÉ≠
      if(!document.getElementById('tab-change')){
        const tab = document.createElement('div');
        tab.id = 'tab-change';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>üìà Î∞∞Ïú® & ÌôïÎ•† Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
          <div class="req-card" style="gap:10px; align-items:center;">
            <div style="min-width:220px;">
              <div><strong>Ï†ÑÏ≤¥ Î∞∞Ïú®/ÌôïÎ•† ÏùºÍ¥Ñ Ï†ÅÏö©</strong></div>
              <div style="color:#9ca3af; font-size:12px;">ÌòÑÏû¨ ÌÉ≠Ïùò Î™®Îìú(Ï£ºÏãù/ÏΩîÏù∏)ÏóêÎßå Ï†ÅÏö©</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label>Ï†ÑÏ≤¥ Î∞∞Ïú®</label>
              <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:90px;">
              <button onclick="setAllMultipliers()">Ï†ÅÏö©</button>
              <span style="width:14px"></span>
              <label>Ïù¥Îìù(0~1)</label>
              <input id="globalProfit" type="number" step="0.01" min="0" max="1" value="0.4" style="width:90px;">
              <label>ÏÜêÌï¥(0~1)</label>
              <input id="globalLoss" type="number" step="0.01" min="0" max="1" value="0.6" style="width:90px;">
              <button onclick="setAllChances()">Ï†ÅÏö©</button>
            </div>
          </div>
          <div id="changePanel">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tab);
      }

      // ÏÉÅÏû•ÌèêÏßÄ ÌÉ≠
      if(!document.getElementById('tab-delist')){
        const tab = document.createElement('div');
        tab.id = 'tab-delist';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>‚ö´ ÏÉÅÏû•ÌèêÏßÄ Í¥ÄÎ¶¨ Ìå®ÎÑê</h3>
          <div id="delistPanel">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        `;
        panel.appendChild(tab);
      }

      // Ïú†Ï†Ä ÌÉ≠
      if(!document.getElementById('tab-users')){
        const tab = document.createElement('div');
        tab.id = 'tab-users';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>üë• Ïú†Ï†Ä ÏÉÅÌÉú Ìå®ÎÑê</h3>
          <div id="userList">Î°úÎìú Ï§ë...</div>
        `;
        panel.appendChild(tab);
      }

      // ÏûÖÏ∂úÍ∏à ÌÉ≠
      if(!document.getElementById('tab-finance')){
        const tab = document.createElement('div');
        tab.id = 'tab-finance';
        tab.className = 'tab-section';
        tab.style.display = 'none';
        tab.innerHTML = `
          <h3>üí≥ ÏûÖ/Ï∂úÍ∏à ÏöîÏ≤≠ Ìå®ÎÑê</h3>
          <h4>ÏûÖÍ∏à ÏöîÏ≤≠</h4>
          <div id="depositRequests">ÎåÄÍ∏∞Ï§ëÏù∏ ÏûÖÍ∏à ÏöîÏ≤≠ ÏóÜÏùå</div>
          <h4 style="margin-top:12px;">Ï∂úÍ∏à ÏöîÏ≤≠</h4>
          <div id="withdrawRequests">ÎåÄÍ∏∞Ï§ëÏù∏ Ï∂úÍ∏à ÏöîÏ≤≠ ÏóÜÏùå</div>
        `;
        panel.appendChild(tab);
      }
    }
    // ÌÉ≠ ÏÑπÏÖò Î≥¥Ïû•
    ensureCoreAdminTabsDOM();

    // --- Î†åÎçî Î™®Ïùå (Ïù¥ÎØ∏ Ï†ïÏùòÎèº ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
    if(typeof window.renderAllAdminPanels !== 'function'){
      window.renderAllAdminPanels = function(){
        renderGraphAdjustPanel();
        renderStockTuner();
        renderChangePanel();
        renderDelistPanel();
      };
    }

    /* ---------- Í∑∏ÎûòÌîÑ/Í∞úÎ≥Ñ Ï°∞Ï†ï ---------- */
    if(typeof window.renderGraphAdjustPanel !== 'function'){
      window.renderGraphAdjustPanel = function(){
        const wrap = document.getElementById("graphCompanyAdjust"); if(!wrap) return;
        let html="";
        const list = getActiveList();
        list.forEach(a=>{
          const id = "adj-" + a.id;
          html += `
            <div class='req-card'>
              <div><strong>${a.name}</strong> | ÌòÑÏû¨Í∞Ä:
                <span id='panel-price-${a.id}'>${getDisplayPrice(a).toLocaleString()}</span> KRW
                ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}
              </div>
              <div style='display:flex; gap:8px; align-items:center;'>
                <input type='number' id='${id}' placeholder='¬±Í∏àÏï°' style='width:120px;' ${a.delisted?'disabled':''}>
                <button ${a.delisted?'disabled':''} onclick="adjustActivePrice('${a.name}')">Ï†ÅÏö©</button>
              </div>
            </div>`;
        });
        wrap.innerHTML = html || "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå";
      };
    }
    if(typeof window.adjustActivePrice !== 'function'){
      window.adjustActivePrice = async function(name){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = getActiveList();
        const a = findById(list, name); if(!a) return;
        if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Ï°∞Ï†ï Î∂àÍ∞Ä");
        const inputEl = document.getElementById("adj-" + a.id);
        const delta = parseInt(inputEl && inputEl.value) || 0;
        const newVal=Math.max(1,(a.livePrice||a.basePrice)+delta);
        const coll = (marketMode==='coin') ? "coinPrices" : "companyPrices";
        await setDoc(doc(db,coll, a.id), { current:newVal, updatedAt: Date.now() }, { merge:true });
        a.livePrice=newVal;
        const p = document.getElementById("panel-price-" + a.id);
        if(p) p.textContent=getDisplayPrice(a).toLocaleString();
        const el = document.getElementById("price-" + a.id);
        if(el) el.textContent=getDisplayPrice(a).toLocaleString();
        updateMaxBuyUI();
      };
    }
    if(typeof window.adjustAllPrices !== 'function'){
      window.adjustAllPrices = async function(){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const v = document.getElementById("allDelta");
        const delta = parseInt(v?.value) || 0;
        const tickAt = Date.now();
        const batch = writeBatch(db);

        const writeAll = (list, coll) => {
          for(const a of list){
            if(a.delisted) continue;
            const newVal = Math.max(1,(a.livePrice||a.basePrice)+delta);
            a.livePrice = newVal;
            batch.set(doc(db,coll, a.id), { current:newVal, updatedAt: tickAt }, { merge:true });
          }
        };
        writeAll(companies,'companyPrices');
        writeAll(coins,    'coinPrices');

        await batch.commit();
        await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
        updateMaxBuyUI();
        renderGraphAdjustPanel();
      };
    }
    if(typeof window.applyDeltaMax !== 'function'){
      window.applyDeltaMax = function(){
        const val = parseInt(document.getElementById("deltaMaxInput")?.value) || 1;
        deltaMax = Math.max(1, val);
        alert("‚úÖ 1Ìã± ÏÉÅÌïú(¬±Ïõê) Ï†ÅÏö©: " + deltaMax.toLocaleString());
      };
    }
    if(typeof window.applyGraphInterval !== 'function'){
      window.applyGraphInterval = function(){
        const sec = parseInt(document.getElementById("intervalInput")?.value) || 5;
        updateInterval = Math.max(1, sec) * 1000;
        setDoc(doc(db,"marketState","main"), { interval:updateInterval, updatedAt:Date.now() }, { merge:true })
          .then(()=>{
            if(ADMIN_MODE){ if(priceTimer){ clearInterval(priceTimer); } if(marketOpenFlag) startLocalTimer(); }
            alert("‚úÖ Î≥ÄÎèôÏ£ºÍ∏∞ Ï†ÅÏö©Îê®: " + sec + "Ï¥à");
          })
          .catch(e=>console.error("Î≥ÄÎèôÏ£ºÍ∏∞ Ï†ÄÏû• Ïã§Ìå®:", e));
      };
    }
    if(typeof window.resetGraph !== 'function'){
      window.resetGraph = async function(){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const tickAt = Date.now();
        const batch = writeBatch(db);
        for(const a of companies){
          if(a.delisted) continue;
          a.livePrice=a.basePrice;
          batch.set(doc(db,"companyPrices", a.id), { current: a.basePrice, updatedAt: tickAt }, { merge:true });
        }
        for(const a of coins){
          if(a.delisted) continue;
          a.livePrice=a.basePrice;
          batch.set(doc(db,"coinPrices", a.id), { current: a.basePrice, updatedAt: tickAt }, { merge:true });
        }
        await batch.commit();
        await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
        if(chart){
          chart.data.labels = [];
          chart.data.datasets.forEach(d=> d.data = []);
          chart.update();
          lastChartTick = 0;
        }
        updateMaxBuyUI();
        renderGraphAdjustPanel();
      };
    }

    /* ---------- Ìã±(¬±Î≤ÑÌäº) Ï°∞Ïûë ---------- */
    if(typeof window.renderStockTuner !== 'function'){
      window.renderStockTuner = function(){
        const host = document.getElementById('stockTuner'); if(!host) return;
        let html = "";
        const list = getActiveList();
        list.forEach(a=>{
          const disabled = a.delisted ? "disabled" : "";
          html += `
            <div class='req-card'>
              <div><strong>${a.name}</strong> | ${getDisplayPrice(a).toLocaleString()} KRW ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}</div>
              <div style='display:flex; gap:6px; flex-wrap:wrap;'>
                <button ${disabled} onclick="applyTickDelta('${a.name}', -1000000)">-100Îßå</button>
                <button ${disabled} onclick="applyTickDelta('${a.name}', -100000)">-10Îßå</button>
                <button ${disabled} onclick="applyTickDelta('${a.name}', -10000)">-1Îßå</button>
                <button ${disabled} onclick="applyTickDelta('${a.name}', 10000)">+1Îßå</button>
                <button ${disabled} onclick="applyTickDelta('${a.name}', 100000)">+10Îßå</button>
                <button ${disabled} onclick="applyTickDelta('${a.name}', 1000000)">+100Îßå</button>
              </div>
            </div>`;
        });
        host.innerHTML = html || "ÏûêÏÇ∞ ÏóÜÏùå";
      };
    }
    if(typeof window.applyTickDelta !== 'function'){
      window.applyTickDelta = async function(name, delta){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = getActiveList();
        const a = findById(list, name); if(!a) return;
        if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Ï°∞Ï†ï Î∂àÍ∞Ä");
        const newVal=Math.max(1,(a.livePrice||a.basePrice)+delta);
        const coll = (marketMode==='coin') ? "coinPrices" : "companyPrices";
        await setDoc(doc(db,coll, a.id), { current:newVal, updatedAt: Date.now() }, { merge:true });
        a.livePrice=newVal;
        const el = document.getElementById("price-" + a.id);
        if(el) el.textContent=getDisplayPrice(a).toLocaleString();
        const p = document.getElementById("panel-price-" + a.id);
        if(p) p.textContent=getDisplayPrice(a).toLocaleString();
        updateMaxBuyUI();
      };
    }

    /* ---------- Î∞∞Ïú®/ÌôïÎ•† ---------- */
    if(typeof window.renderChangePanel !== 'function'){
      window.renderChangePanel = function(){
        const host = document.getElementById('changePanel'); if(!host) return;
        let html = "";
        const list = getActiveList();
        const map  = getActiveChances();
        list.forEach(a=>{
          const ch = map[a.id] || {profit:0.4, loss:0.6};
          html += `
            <div class="req-card">
              <div style="min-width:220px;">
                <div><strong>${a.name}</strong> ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}</div>
                <div style="font-size:12px;color:#9ca3af;">Î∞∞Ïú®: <strong id="mult-${a.id}">${Number(a.multiplier||1)}</strong> | ÌôïÎ•†: ‚Üë${(ch.profit*100).toFixed(1)}% / ‚Üì${(ch.loss*100).toFixed(1)}%</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="number" id="inp-mul-${a.id}" step="0.1" value="${Number(a.multiplier||1)}" style="width:90px;" ${a.delisted?'disabled':''}>
                <button ${a.delisted?'disabled':''} onclick="applyMultiplier('${a.name}')">Î∞∞Ïú®Ï†ÅÏö©</button>
                <span style="width:8px"></span>
                <input type="number" id="inp-up-${a.id}" step="0.01" min="0" max="1" value="${ch.profit}" style="width:90px;" ${a.delisted?'disabled':''}>
                <input type="number" id="inp-down-${a.id}" step="0.01" min="0" max="1" value="${ch.loss}" style="width:90px;" ${a.delisted?'disabled':''}>
                <button ${a.delisted?'disabled':''} onclick="applyChance('${a.name}')">ÌôïÎ•†Ï†ÅÏö©</button>
              </div>
            </div>
          `;
        });
        host.innerHTML = html || "ÏûêÏÇ∞ ÏóÜÏùå";
      };
    }
    if(typeof window.applyMultiplier !== 'function'){
      window.applyMultiplier = async function(name){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = getActiveList();
        const a = findById(list, name); if(!a) return;
        if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ ÏàòÏ†ï Î∂àÍ∞Ä");
        const el = document.getElementById("inp-mul-" + a.id);
        const val = Number(el?.value||1);
        const m = isNaN(val) ? 1 : Math.max(0, val);
        const coll = (marketMode==='coin') ? 'coinSettings' : 'companySettings';
        await setDoc(doc(db,coll, a.id), { multiplier:m, updatedAt:Date.now() }, { merge:true });
        a.multiplier = m;
        const out = document.getElementById("mult-" + a.id);
        if(out) out.textContent = String(m);
        alert(`‚úÖ ${a.name} Î∞∞Ïú® ${m} Ï†ÅÏö©`);
      };
    }
    if(typeof window.applyChance !== 'function'){
      window.applyChance = async function(name){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = getActiveList();
        const map  = getActiveChances();
        const a = findById(list, name); if(!a) return;
        if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ ÏàòÏ†ï Î∂àÍ∞Ä");
        const upEl = document.getElementById("inp-up-" + a.id);
        const dnEl = document.getElementById("inp-down-" + a.id);
        let up = Number(upEl?.value||0.4);
        let dn = Number(dnEl?.value||0.6);
        if(up<0||dn<0 || (up+dn)<=0){ return alert("0~1 Î≤îÏúÑ, Ìï©Í≥Ñ>0 Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§."); }
        const coll = (marketMode==='coin') ? 'coinChances' : 'companyChances';
        await setDoc(doc(db,coll, a.id), { profit:up, loss:dn, updatedAt:Date.now() }, { merge:true });
        map[a.id] = { profit:up, loss:dn };
        renderChangePanel();
        alert(`‚úÖ ${a.name} ÌôïÎ•† Ï†ÅÏö© (‚Üë${(up*100).toFixed(1)}% / ‚Üì${(dn*100).toFixed(1)}%)`);
      };
    }
    if(typeof window.setAllMultipliers !== 'function'){
      window.setAllMultipliers = async function(){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const v = Number(document.getElementById("allMultiplierVal")?.value);
        const m = isNaN(v) ? 1 : Math.max(0, v);
        const list = getActiveList();
        const coll = (marketMode==='coin') ? 'coinSettings' : 'companySettings';
        for(const a of list){
          if(a.delisted) continue;
          await setDoc(doc(db,coll, a.id), { multiplier:m, updatedAt:Date.now() }, { merge:true });
          a.multiplier = m;
        }
        renderChangePanel();
        alert(`‚úÖ (${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'}) Ï†ÑÏ≤¥ Î∞∞Ïú® ${m} Ï†ÅÏö© (ÏÉÅÏû•ÌèêÏßÄ Ï†úÏô∏)`);
      };
    }
    if(typeof window.setAllChances !== 'function'){
      window.setAllChances = async function(){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const p = parseFloat(document.getElementById('globalProfit')?.value);
        const l = parseFloat(document.getElementById('globalLoss')?.value);
        if(isNaN(p)||isNaN(l)||p<0||l<0||(p+l)<=0){ alert("ÏûòÎ™ªÎêú Í∞íÏûÖÎãàÎã§ (0~1, Ìï©Í≥Ñ>0)."); return; }
        const list = getActiveList();
        const coll = (marketMode==='coin') ? 'coinChances' : 'companyChances';
        const map  = getActiveChances();
        try{
          for(const a of list){
            if(a.delisted) continue;
            await setDoc(doc(db,coll, a.id), { profit:p, loss:l, updatedAt: Date.now() }, { merge:true });
            map[a.id] = { profit:p, loss:l };
          }
          alert(`‚úÖ (${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'}) Ï†ÑÏ≤¥ ÌôïÎ•† Ï†ÅÏö©: Ïù¥Îìù ${(p*100).toFixed(1)}% / ÏÜêÌï¥ ${(l*100).toFixed(1)}%`);
          renderChangePanel();
        }catch(e){ console.error("Ï†ÑÏ≤¥ ÌôïÎ•† Ï†ÅÏö© Ïã§Ìå®:", e); alert("Ïò§Î•ò: Î≥ÄÎèôÌè≠ Ï†ÅÏö© Ïã§Ìå®"); }
      };
    }
    if(typeof window.applyVolatility !== 'function'){
      window.applyVolatility = async function(){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const v = Number(document.getElementById('volatilityInput')?.value);
        const vv = isNaN(v) ? 1.5 : Math.max(0, v);
        try{
          await setDoc(doc(db,'globals','settings'), { volatility: vv, updatedAt: Date.now() }, { merge:true });
          volatility = vv;
          alert(`‚úÖ Ï†ÑÏó≠ Î≥ÄÎèôÌè≠ ${vv}% Ï†ÅÏö©`);
        }catch(e){ console.error(e); alert("Ïò§Î•ò: Î≥ÄÎèôÌè≠ Ï†ÅÏö© Ïã§Ìå®"); }
      };
    }
    if(typeof window.runScenario !== 'function'){
      window.runScenario = function(type){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const force = (type==='riseEnd') ? -1 : 1; // -1: ÏÉÅÏäπ Ïú†ÎèÑ, +1: ÌïòÎùΩ Ïú†ÎèÑ
        const list = getActiveList();
        const state= getActiveState();
        list.forEach(a=>{ if(!a.delisted) state.bias[a.id] = force; });
        alert(type==='riseEnd' ? "üìà Îã®Í∏∞ ÏÉÅÏäπ Ïú†ÎèÑ ÏãúÏûë (ÏÉÅÏû•ÌèêÏßÄ Ï†úÏô∏)" : "üìâ Îã®Í∏∞ ÌïòÎùΩ Ïú†ÎèÑ ÏãúÏûë (ÏÉÅÏû•ÌèêÏßÄ Ï†úÏô∏)");
        setTimeout(()=>{ list.forEach(a=>{ state.bias[a.id] = 0; }); }, 60000);
      };
    }

    /* ---------- ÏÉÅÏû•ÌèêÏßÄ/Î≥µÍµ¨ ---------- */
    if(typeof window.renderDelistPanel !== 'function'){
      window.renderDelistPanel = function(){
        const host = document.getElementById("delistPanel"); if(!host) return;
        let html = `<h4 style="margin:6px 0">Ï£ºÏãù</h4>`;
        companies.forEach(a=>{
          const isDelisted = !!a.delisted;
          html += `
            <div class="req-card">
              <div>
                <strong>${a.name}</strong>
                <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">${isDelisted?'‚ö´ ÏÉÅÏû•ÌèêÏßÄ':'üü¢ ÏÉÅÏû•'}</span>
                <div style="font-size:12px;color:#9ca3af;margin-top:4px;">ÌòÑÏû¨Í∞Ä: ${getDisplayPrice(a).toLocaleString()} KRW, Î∞∞Ïú®: ${Number(a.multiplier||1)}</div>
              </div>
              <div style="display:flex; gap:8px;">
                ${isDelisted
                  ? `<button onclick="restoreAsset('stock','${a.name}')">Î≥µÍµ¨</button>`
                  : `<button onclick="delistAsset('stock','${a.name}')" style="background:#7f1d1d;">ÏÉÅÏû•ÌèêÏßÄ</button>`}
              </div>
            </div>`;
        });
        html += `<h4 style="margin:12px 0 6px">ÏΩîÏù∏</h4>`;
        coins.forEach(a=>{
          const isDelisted = !!a.delisted;
          html += `
            <div class="req-card">
              <div>
                <strong>${a.name}</strong>
                <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">${isDelisted?'‚ö´ ÏÉÅÏû•ÌèêÏßÄ':'üü¢ ÏÉÅÏû•'}</span>
                <div style="font-size:12px;color:#9ca3af;margin-top:4px;">ÌòÑÏû¨Í∞Ä: ${getDisplayPrice(a).toLocaleString()} KRW, Î∞∞Ïú®: ${Number(a.multiplier||1)}</div>
              </div>
              <div style="display:flex; gap:8px;">
                ${isDelisted
                  ? `<button onclick="restoreAsset('coin','${a.name}')">Î≥µÍµ¨</button>`
                  : `<button onclick="delistAsset('coin','${a.name}')" style="background:#7f1d1d;">ÏÉÅÏû•ÌèêÏßÄ</button>`}
              </div>
            </div>`;
        });
        host.innerHTML = html || "ÏûêÏÇ∞ ÏóÜÏùå";
      };
    }
    if(typeof window.delistAsset !== 'function'){
      window.delistAsset = async function(kind, name){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = (kind==='coin') ? coins : companies;
        const coll = (kind==='coin') ? 'coinSettings' : 'companySettings';
        const a = findById(list, name); if(!a) return;

        await setDoc(doc(db,coll,a.id), { delisted:true, updatedAt:Date.now() }, { merge:true });
        a.delisted = true;

        try {
          const snap = await getDocs(collection(db, "users"));
          const batch = writeBatch(db);
          snap.forEach(docu => {
            const u = docu.data();
            if(kind==='stock'){
              if(u.holdingsStock && u.holdingsStock[a.name] > 0){
                const next = {...u.holdingsStock};
                next[a.name] = 0;
                batch.update(doc(db,"users",docu.id), { holdingsStock:next, updatedAt:Date.now() });
              }
            }else{
              if(u.holdingsCoin && u.holdingsCoin[a.name] > 0){
                const next = {...u.holdingsCoin};
                next[a.name] = 0;
                batch.update(doc(db,"users",docu.id), { holdingsCoin:next, updatedAt:Date.now() });
              }
            }
          });
          await batch.commit();
        } catch(e){ console.error("ÏÉÅÏû•ÌèêÏßÄ Î≥¥Ïú†Î∂Ñ Ï†ïÎ¶¨ Ïã§Ìå®:", e); }

        alert(`‚ö´ ${a.name} ÏÉÅÏû•ÌèêÏßÄ ÏôÑÎ£å (Î≥¥Ïú† ÏàòÎüâ 0ÏúºÎ°ú Î≥ÄÍ≤ΩÎê®)`);
        renderDelistPanel(); renderAllAdminPanels(); renderMarketStatus(); initAssetUI();
      };
    }
    if(typeof window.restoreAsset !== 'function'){
      window.restoreAsset = async function(kind, name){
        if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
        const list = (kind==='coin') ? coins : companies;
        const coll = (kind==='coin') ? 'coinSettings' : 'companySettings';
        const a = findById(list, name); if(!a) return;
        await setDoc(doc(db,coll,a.id), { delisted:false, updatedAt:Date.now() }, { merge:true });
        a.delisted = false;
        alert(`üü¢ ${a.name} Î≥µÍµ¨ ÏôÑÎ£å`);
        renderDelistPanel(); renderAllAdminPanels(); renderMarketStatus(); initAssetUI();
      };
    }

    // ÌÉ≠ ÎÇ¥Ïö© ÏÉàÎ°úÍ≥†Ïπ®
    renderAllAdminPanels();

        /* ===========================================
       Part 7 ‚Äî Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê Ï†ëÍ∑º ÏäπÏù∏(Í≤åÏù¥Ìä∏) + Ïú†Ï†Ä ÌÉ≠ Í≥†ÎèÑÌôî
       - Ìå®ÎÑê Ïó¥Í∏∞ ÏöîÏ≤≠/ÏäπÏù∏/Í±∞Ï†à(Í¥ÄÎ¶¨Ïûê ÏóÜÏùÑ ÎïåÎäî Î™®Îëê Î≥¥Í∏∞)
       - Ïú†Ï†Ä ÌÉ≠: Í≤ÄÏÉâ/ÌïÑÌÑ∞/Ï†ïÎ†¨, Í∞ïÏ†ú Î°úÍ∑∏ÏïÑÏõÉ
       - ÏùºÎ∞ò Ïú†Ï†ÄÏö©: "Ìå®ÎÑê Ïó¥Í∏∞ ÏöîÏ≤≠" Î≤ÑÌäº ÏûêÎèô Ï£ºÏûÖ
       - Ìå®ÎÑê Í∞ÄÏãúÏÑ± Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ(enforceAdminPanelVisibility)
    ============================================*/

    /* ---------- ÏùºÎ∞ò Ïú†Ï†Ä UI: Ìå®ÎÑê Ïó¥Í∏∞ ÏöîÏ≤≠ Î≤ÑÌäº Ï£ºÏûÖ ---------- */
    function ensurePanelRequestButton(){
      const host = document.getElementById('adminLogin');
      if(!host) return;
      if(document.getElementById('panelAskBtn')) return;

      const btn = document.createElement('button');
      btn.id = 'panelAskBtn';
      btn.textContent = 'Ìå®ÎÑê Ïó¥Í∏∞ ÏöîÏ≤≠';
      btn.style.marginLeft = '6px';
      btn.onclick = ()=> requestPanelAccess();
      host.appendChild(btn);

      // ÌòÑÏû¨ ÏöîÏ≤≠ ÏÉÅÌÉú Î∞∞ÏßÄ
      const badge = document.createElement('span');
      badge.id = 'panelAskBadge';
      badge.style.marginLeft = '8px';
      badge.style.fontSize = '13px';
      badge.style.color = '#facc15';
      host.appendChild(badge);
    }
    ensurePanelRequestButton();

    /* ---------- Ìå®ÎÑê ÏöîÏ≤≠/ÏäπÏù∏/Í±∞Ï†à Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ----------
      - collection: panelRequests
        { userId, userName, createdAt, status: 'pending'|'approved'|'rejected',
          decidedAt?, decidedBy? }
      - users/{id}: panelAccess: boolean
    ---------------------------------------------------- */

    async function requestPanelAccess(){
      if(!currentUser?.id){
        alert('Î®ºÏ†Ä Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.');
        return;
      }
      try{
        // Ïù¥ÎØ∏ ÏäπÏù∏Îêú Í≤ΩÏö∞
        const uref = doc(db,'users', currentUser.id);
        const usnap = await getDoc(uref);
        if(usnap.exists() && usnap.data()?.panelAccess){
          alert('Ïù¥ÎØ∏ Ìå®ÎÑê Ï†ëÍ∑ºÏù¥ ÌóàÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
          return;
        }
        // ÎèôÏùº Ïú†Ï†ÄÏùò pending Ïù¥ ÎßéÏùÄÏßÄ Ï≤¥ÌÅ¨Îäî ÏÉùÎûµ(Í∞ÑÎã® Ï≤òÎ¶¨)
        await addDoc(collection(db,'panelRequests'), {
          userId: currentUser.id,
          userName: currentUser.name || 'ÏùµÎ™Ö',
          createdAt: Date.now(),
          status: 'pending'
        });
        const badge = document.getElementById('panelAskBadge');
        if(badge) badge.textContent = 'ÏöîÏ≤≠Îê®(ÎåÄÍ∏∞Ï§ë)';
        alert('Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Ìå®ÎÑê Ï†ëÍ∑ºÏùÑ ÏöîÏ≤≠ÌñàÏäµÎãàÎã§.');
      }catch(e){
        console.error(e);
        alert('ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + (e.message || e));
      }
    }

    async function approvePanelAccess(reqId, userId){
      if(!ADMIN_MODE) return alert('Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
      try{
        const reqRef = doc(db, 'panelRequests', reqId);
        await updateDoc(reqRef, {
          status: 'approved',
          decidedAt: Date.now(),
          decidedBy: currentUser?.id || 'admin'
        });
        await updateDoc(doc(db,'users', userId), {
          panelAccess: true,
          panelAccessGrantedAt: Date.now()
        });
        alert('ÏäπÏù∏ ÏôÑÎ£å: Ìï¥Îãπ Ïú†Ï†ÄÎäî Ìå®ÎÑêÏùÑ Ïó¥ Ïàò ÏûàÏäµÎãàÎã§.');
      }catch(e){
        console.error(e);
        alert('ÏäπÏù∏ Ïã§Ìå®: ' + (e.message || e));
      }
    }

    async function rejectPanelAccess(reqId, userId){
      if(!ADMIN_MODE) return alert('Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
      try{
        const reqRef = doc(db, 'panelRequests', reqId);
        await updateDoc(reqRef, {
          status: 'rejected',
          decidedAt: Date.now(),
          decidedBy: currentUser?.id || 'admin'
        });
        await updateDoc(doc(db,'users', userId), {
          panelAccess: false
        });
        alert('Í±∞Ï†à Ï≤òÎ¶¨ÌñàÏäµÎãàÎã§.');
      }catch(e){
        console.error(e);
        alert('Í±∞Ï†à Ïã§Ìå®: ' + (e.message || e));
      }
    }

    /* ---------- Í¥ÄÎ¶¨Ïûê Ï°¥Ïû¨Ïó¨Î∂Ä + Í∞úÏù∏ Í∂åÌïúÏóê Îî∞Î•∏ Ìå®ÎÑê Í∞ÄÏãúÏÑ± ---------- */
    let unsubAdminGate = null;
    function subscribeAdminGate(){
      if(unsubAdminGate){ try{unsubAdminGate();}catch(e){} unsubAdminGate = null; }
      unsubAdminGate = onSnapshot(collection(db,'users'), (snap)=>{
        let adminCount = 0;
        let mePanelAccess = false;

        snap.forEach(u=>{
          const d = u.data() || {};
          if(d.isAdmin) adminCount++;
          if(currentUser && u.id === currentUser.id){
            mePanelAccess = !!d.panelAccess;
          }
        });

        enforceAdminPanelVisibility(adminCount, mePanelAccess);
      });
    }

    function enforceAdminPanelVisibility(adminCount, mePanelAccess){
      const panel = document.getElementById('adminPanelAll');
      if(!panel) return;

      // 1) Í¥ÄÎ¶¨ÏûêÍ∞Ä 1Î™ÖÏù¥ÎùºÎèÑ ÏûàÏúºÎ©¥ -> ADMIN_MODEÍ±∞ÎÇò panelAccess ÏäπÏù∏Îêú Ïú†Ï†ÄÎßå Î≥º Ïàò ÏûàÏùå
      // 2) Í¥ÄÎ¶¨ÏûêÍ∞Ä 0Î™ÖÏù¥Î©¥ -> ÎàÑÍµ¨ÎÇò Î≥º Ïàò ÏûàÏùå(ÏùΩÍ∏∞/ÌÉ≠ Ïù¥Îèô Í∞ÄÎä•)
      if(adminCount > 0){
        if(ADMIN_MODE || mePanelAccess){
          panel.style.display = 'block';
        }else{
          panel.style.display = 'none';
        }
      }else{
        // Í¥ÄÎ¶¨Ïûê ÏóÜÏùå => Î™®Îëê Ïò§Ìîà(Îã®, Ï°∞Ïûë/Ï†ÄÏû•ÌñâÏúÑÎäî ADMIN_MODEÏóêÏÑúÎßå ÎèôÏûë)
        panel.style.display = 'block';
      }

      // ÏöîÏ≤≠ Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
      const badge = document.getElementById('panelAskBadge');
      if(badge){
        if(ADMIN_MODE){
          badge.textContent = 'Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏Îê®';
          badge.style.color = '#10b981';
        }else if(mePanelAccess){
          badge.textContent = 'ÏäπÏù∏Îê®';
          badge.style.color = '#10b981';
        }else{
          badge.textContent = '';
          badge.style.color = '#facc15';
        }
      }
    }

    // ÏµúÏ¥à Íµ¨ÎèÖ ÏãúÏûë (Ïù¥ÎØ∏ Part 6ÏóêÏÑú Ìò∏Ï∂úÌïú Ï†Å ÏóÜÎã§Î©¥ Î≥¥Ïû•)
    try{ subscribeAdminGate(); }catch(e){ console.warn('adminGate Íµ¨ÎèÖ Ïã§Ìå®(Î¨¥Ïãú Í∞ÄÎä•):', e); }

    /* ---------- Ïú†Ï†Ä ÌÉ≠: Í≤ÄÏÉâ/ÌïÑÌÑ∞/Ï†ïÎ†¨ Ìó§Îçî DOM Ï£ºÏûÖ ---------- */
    function ensureUsersTabExtrasDOM(){
      const tab = document.getElementById('tab-users');
      if(!tab) return;
      if(document.getElementById('userFilterBar')) return;

      const bar = document.createElement('div');
      bar.id = 'userFilterBar';
      bar.className = 'req-card';
      bar.style.marginBottom = '8px';
      bar.innerHTML = `
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="userSearchInput" type="text" placeholder="Ïù¥Î¶Ñ/ID Í≤ÄÏÉâ" style="width:200px;">
          <select id="userSortSel">
            <option value="login">ÏµúÍ∑º Î°úÍ∑∏Ïù∏Ïàú</option>
            <option value="cashDesc">ÌòÑÍ∏à ÎÇ¥Î¶ºÏ∞®Ïàú</option>
            <option value="nameAsc">Ïù¥Î¶Ñ Ïò§Î¶ÑÏ∞®Ïàú</option>
          </select>
          <label style="display:flex; align-items:center; gap:6px;">
            <input id="onlyActiveChk" type="checkbox"> Ï†ëÏÜçÏ§ëÎßå
          </label>
          <button id="userApplyFilterBtn">Ï†ÅÏö©</button>
        </div>
      `;
      tab.insertBefore(bar, tab.querySelector('#userList'));

      const apply = ()=> renderUserList(true, true); // Ïû¨Íµ¨ÎèÖ ÏóÜÏù¥ Ï¶âÏãú ÌïÑÌÑ∞ Î∞òÏòÅ
      document.getElementById('userApplyFilterBtn')?.addEventListener('click', apply);
      document.getElementById('userSearchInput')?.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') apply();
      });
      document.getElementById('userSortSel')?.addEventListener('change', apply);
      document.getElementById('onlyActiveChk')?.addEventListener('change', apply);

      // Ìå®ÎÑê ÏöîÏ≤≠ ÌÅê Î∞ïÏä§(ÏÉÅÎã® Í≥µÏö©)
      const reqBox = document.createElement('div');
      reqBox.id = 'panelReqBox';
      reqBox.innerHTML = `
        <h4 style="margin:12px 0 6px;">üìÆ Ìå®ÎÑê Ï†ëÍ∑º ÏöîÏ≤≠(ÎåÄÍ∏∞)</h4>
        <div id="panelReqList">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      `;
      tab.insertBefore(reqBox, tab.querySelector('#userList'));
    }
    ensureUsersTabExtrasDOM();

    /* ---------- Ìå®ÎÑê ÏöîÏ≤≠ ÌÅê Íµ¨ÎèÖ(Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©) ---------- */
    let unsubPanelReq = null;
    function subscribePanelRequests(){
      if(unsubPanelReq){ try{unsubPanelReq();}catch(e){} unsubPanelReq = null; }

      const box = document.getElementById('panelReqList');
      if(!box) return;

      unsubPanelReq = onSnapshot(
        query(collection(db,'panelRequests'), orderBy('createdAt','desc')),
        (snap)=>{
          let html = '';
          snap.forEach(d=>{
            const r = d.data() || {};
            if(r.status !== 'pending') return; // ÎåÄÍ∏∞Ï§ëÎßå
            html += `
              <div class="req-card">
                <div>
                  <div><strong>${r.userName||'-'}</strong> (${r.userId||'-'})</div>
                  <div style="color:#9ca3af; font-size:12px;">ÏöîÏ≤≠ÏãúÍ∞Å: ${new Date(r.createdAt||Date.now()).toLocaleString()}</div>
                </div>
                <div style="display:flex; gap:6px;">
                  <button onclick="approvePanelAccess('${d.id}','${r.userId||''}')">ÏäπÏù∏</button>
                  <button onclick="rejectPanelAccess('${d.id}','${r.userId||''}')" style="background:#7f1d1d;">Í±∞Ï†à</button>
                </div>
              </div>
            `;
          });
          box.innerHTML = html || 'ÎåÄÍ∏∞Ï§ëÏù∏ ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§.';
        }
      );
    }
    // Í¥ÄÎ¶¨ÏûêÎ©¥ ÏöîÏ≤≠ ÌÅê ÌôúÏÑ±Ìôî
    if(ADMIN_MODE) subscribePanelRequests();
    // ADMIN_MODEÍ∞Ä ÎÇòÏ§ëÏóê Î∞îÎÄåÎäî ÏºÄÏù¥Ïä§ ÎåÄÎπÑ(Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ Ïãú Ïû¨Ìò∏Ï∂ú)
    document.addEventListener('admin-mode-changed', ()=>{
      if(ADMIN_MODE) subscribePanelRequests();
      else { if(unsubPanelReq){ try{unsubPanelReq();}catch(e){} unsubPanelReq=null; } }
    });

    /* ---------- Ïú†Ï†Ä Î™©Î°ù Î†åÎçî + Í∞ïÏ†ú Î°úÍ∑∏ÏïÑÏõÉ ---------- */
    let unsubUsersList = null;
    function summaryHoldings(map){
      const ent = Object.entries(map||{});
      if(!ent.length) return 'Î≥¥Ïú† ÏóÜÏùå';
      // Í∏∏Î©¥ ÏÉùÎûµ
      const s = ent.map(([k,v])=> `${k}:${v}`).join(', ');
      return s.length > 90 ? (s.slice(0,90) + '‚Ä¶') : s;
    }

    if(typeof window.forceLogout !== 'function'){
      window.forceLogout = async (uid)=>{
        if(!ADMIN_MODE) return alert('Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
        try{
          await updateDoc(doc(db,'users',uid),{active:false, lastLogoutAt:Date.now()});
          alert('Ìï¥Îãπ Ïú†Ï†ÄÎ•º Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨ÌñàÏäµÎãàÎã§.');
        }catch(e){ console.error(e); alert('Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨ Ïã§Ìå®: ' + (e.message || e)); }
      };
    }

    if(typeof window.renderUserList !== 'function'){
      window.renderUserList = function(startListen=false, applyFilterOnly=false){
        const box = document.getElementById('userList'); if(!box) return;

        // ÌïÑÌÑ∞ ÌååÎùºÎØ∏ÌÑ∞
        const kw  = (document.getElementById('userSearchInput')?.value || '').trim().toLowerCase();
        const sort= document.getElementById('userSortSel')?.value || 'login';
        const only= !!document.getElementById('onlyActiveChk')?.checked;

        // Ïû¨Íµ¨ÎèÖ ÏóÜÏù¥ ÌïÑÌÑ∞Îßå Ï†ÅÏö©ÌïòÎ†§Î©¥ Ï∫êÏãú ÌïÑÏöî -> Í∞ÑÎã®Ìûà startListen=trueÎ°ú Ïö¥Ïö©
        if(!startListen && applyFilterOnly) startListen = true;

        // Íµ¨ÎèÖ
        if(startListen){
          if(unsubUsersList){ try{unsubUsersList();}catch(e){} unsubUsersList = null; }
          unsubUsersList = onSnapshot(collection(db,'users'), (snap)=>{
            let arr = [];
            snap.forEach(docu=>{
              const u = docu.data() || {};
              arr.push({
                id: docu.id,
                name: u.name || '-',
                cash: Number(u.cash||0),
                holdingsStock: u.holdingsStock || {},
                holdingsCoin:  u.holdingsCoin  || {},
                isAdmin: !!u.isAdmin,
                active: !!u.active,
                lastLoginAt: u.lastLoginAt || 0,
                panelAccess: !!u.panelAccess
              });
            });

            // ÌïÑÌÑ∞
            if(kw){
              arr = arr.filter(x => (x.id.toLowerCase().includes(kw) || x.name.toLowerCase().includes(kw)));
            }
            if(only){
              arr = arr.filter(x => x.active);
            }
            // Ï†ïÎ†¨
            if(sort === 'cashDesc'){
              arr.sort((a,b)=> b.cash - a.cash);
            }else if(sort === 'nameAsc'){
              arr.sort((a,b)=> (a.name||'').localeCompare(b.name||'','ko'));
            }else{ // login
              arr.sort((a,b)=> (b.lastLoginAt||0) - (a.lastLoginAt||0));
            }

            // Î†åÎçî
            let html = '';
            arr.forEach(u=>{
              const holdS = summaryHoldings(u.holdingsStock);
              const holdC = summaryHoldings(u.holdingsCoin);
              html += `
                <div class="req-card">
                  <div>
                    <div>
                      <strong>${u.name}</strong> (${u.id})
                      ${u.active ? ' <span style="color:#10b981;">üü¢</span>' : ' <span style="color:#ef4444;">üî¥</span>'}
                      ${u.isAdmin ? ' <span style="color:#10b981;">Í¥ÄÎ¶¨Ïûêüõ°Ô∏è</span>' : ''}
                      ${u.panelAccess ? ' <span style="color:#60a5fa;">ÏäπÏù∏Îê®üîì</span>' : ''}
                    </div>
                    <div>ÌòÑÍ∏à: ${u.cash.toLocaleString()} KRW</div>
                    <div>Î≥¥Ïú†(Ï£ºÏãù): ${holdS}</div>
                    <div>Î≥¥Ïú†(ÏΩîÏù∏): ${holdC}</div>
                  </div>
                  <div style="display:flex; gap:6px; align-items:center;">
                    <button onclick="forceLogout('${u.id}')">Í∞ïÏ†ú Î°úÍ∑∏ÏïÑÏõÉ</button>
                  </div>
                </div>
              `;
            });
            box.innerHTML = html || 'Ïú†Ï†Ä ÏóÜÏùå';
          });
        }
      };
    }

    // Ï≤òÏùå Ïó¥Î¶¥ Îïå ÌïÑÌÑ∞Î∞î/ÏöîÏ≤≠ÌÅê Î≥¥Ïû• ÌõÑ Î†åÎçî
    try{ renderUserList(true); }catch(e){ console.warn('renderUserList Ï¥àÍ∏∞ Î†åÎçî Ïã§Ìå®(Î¨¥Ïãú Í∞ÄÎä•):', e); }

    /* ---------- Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ Ìï®Ïàò ÌôïÏû• Ïù¥Î≤§Ìä∏(Ï°¥Ïû¨ Ïãú Ïó∞Îèô) ---------- */
    // Í∏∞Ï°¥ checkAdmin()Ïù¥ Ïã§ÌñâÎê† Îïå ADMIN_MODEÍ∞Ä trueÍ∞Ä ÎêòÎ©¥
    // Ïö∞Î¶¨Í∞Ä Íµ¨ÎèÖÌï¥Ïïº Ìï† Í≤ÉÎì§(panelRequests Îì±)ÏùÑ Îã§Ïãú Ïº†Îã§.
    // Ïù¥ÎØ∏ Part 5Ïóê checkAdminÏù¥ ÏûàÏùÑ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏúºÎãà, Ïù¥Î≤§Ìä∏ ÎîîÏä§Ìå®ÏπòÌïòÎèÑÎ°ù ÌôïÏû• Ìï∏Îì§Îßå Îë†.
    (function patchAdminSignal(){
      // ADMIN_MODEÍ∞Ä trueÎ°ú Î∞îÎÄåÎäî ÏãúÏ†êÎßàÎã§ ÏïÑÎûò ÏàòÎèô Ìò∏Ï∂úÌï¥ÎèÑ Îê®:
      // document.dispatchEvent(new Event('admin-mode-changed'));
      // Î≥∏ Ìå®ÏπòÎäî Í∏∞Ï°¥ ÏΩîÎìúÍ∞Ä Ïù¥ Ïù¥Î≤§Ìä∏Î•º Î≥¥ÎÇ¥ÏßÄ ÏïäÎäî Í≤ΩÏö∞Î•º ÎåÄÎπÑÌï¥ Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÏÉÅÌÉú Ï≤¥ÌÅ¨(Í∞ÄÎ≤ºÏõÄ)
      let last = ADMIN_MODE;
      setInterval(()=>{
        if(ADMIN_MODE !== last){
          last = ADMIN_MODE;
          try{
            document.dispatchEvent(new Event('admin-mode-changed'));
          }catch(e){}
        }
      }, 800);
    })();

    /* ---------- Î≥¥Ï°∞: Ìå®ÎÑê Ìó§Îçî/ÎìúÎûòÍ∑∏ Î≥¥Ï†ï(Ï§ëÎ≥µ Î∞©ÏßÄ) ---------- */
    if(typeof window.enableDrag !== 'function'){
      window.enableDrag = function(panelId='adminPanelAll', handleId='adminPanelHeader'){
        const panel = document.getElementById(panelId);
        const handle = document.getElementById(handleId);
        if(!panel || !handle) return;
        let startX=0, startY=0, origX=0, origY=0, dragging=false;
        const THRESHOLD = 3;
        const onDown = (e) => {
          dragging = true;
          const pt = e.touches ? e.touches[0] : e;
          startX = pt.clientX; startY = pt.clientY;
          const rect = panel.getBoundingClientRect();
          origX = rect.left; origY = rect.top;
          document.body.style.userSelect = 'none';
          handle.style.cursor = 'grabbing';
        };
        const onMove = (e) => {
          if(!dragging) return;
          const pt = e.touches ? e.touches[0] : e;
          const dx = pt.clientX - startX;
          const dy = pt.clientY - startY;
          if(Math.abs(dx) > THRESHOLD || Math.abs(dy) > THRESHOLD){
            panel.style.left = (origX + dx) + 'px';
            panel.style.top  = (origY + dy) + 'px';
          }
          e.preventDefault();
        };
        const onUp = () => {
          dragging = false;
          document.body.style.userSelect = '';
          handle.style.cursor = 'move';
        };
        handle.addEventListener('mousedown', onDown);
        document.addEventListener('mousemove', onMove, {passive:false});
        document.addEventListener('mouseup', onUp);
        handle.addEventListener('touchstart', onDown, {passive:true});
        document.addEventListener('touchmove', onMove, {passive:false});
        document.addEventListener('touchend', onUp);
      };
    }

    // ÎìúÎûòÍ∑∏/Ïä§ÌÉÄÏùº Î≥¥Ï†ï Ïû¨Î≥¥Ïû•
    (function ensureAdminPanelStyles(){
      const panel = document.getElementById('adminPanelAll');
      const header = document.getElementById('adminPanelHeader');
      if(!panel || !header) return;
      panel.style.position = panel.style.position || 'fixed';
      panel.style.top = panel.style.top || '100px';
      panel.style.left = panel.style.left || '20px';
      panel.style.zIndex = panel.style.zIndex || 2600;
      panel.style.maxHeight = panel.style.maxHeight || '80vh';
      panel.style.overflow = panel.style.overflow || 'auto';
      header.style.cursor = 'move';
      try{ enableDrag('adminPanelAll','adminPanelHeader'); }catch(e){}
    })();

        /* ===========================================
       Part 8 ‚Äî Í≥µÏßÄ/Îâ¥Ïä§ Î™®Îã¨ Í≥†ÎèÑÌôî + Î∞∞ÏßÄ/Íµ¨ÎèÖ Î≥¥Í∞ï
                + ÏïàÏ†ÑÍ∞ÄÎìú + ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º
       - Í≥µÏßÄ(notices) / Îâ¥Ïä§(news) Íµ¨ÎèÖ & Î¶¨Ïä§Ìä∏ Î†åÎçî
       - Îâ¥Ïä§ Î±ÉÏßÄ(ÏùΩÏßÄ ÏïäÏùÄ Í∞úÏàò) Í¥ÄÎ¶¨
       - ÏïàÏ†ÑÍ∞ÄÎìú(Ï§ëÎ≥µ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ, ÎÑêÍ∞ÄÎìú)
       - Í∞ÑÎã® ÌÜ†Ïä§Ìä∏ ÏãúÏä§ÌÖú
    ============================================*/

    /* ---------- ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º (Ïû¨ÏÇ¨Ïö© Ïú†Ìã∏) ---------- */
    function ensureToastHost(){
      if(document.getElementById('toastHost')) return;
      const host = document.createElement('div');
      host.id = 'toastHost';
      host.style.position = 'fixed';
      host.style.right = '16px';
      host.style.bottom = '16px';
      host.style.display = 'flex';
      host.style.flexDirection = 'column';
      host.style.gap = '8px';
      host.style.zIndex = 4000;
      document.body.appendChild(host);
    }
    ensureToastHost();

    function toast(msg, type='info', ttl=2600){
      ensureToastHost();
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      el.style.padding = '10px 12px';
      el.style.borderRadius = '10px';
      el.style.boxShadow = '0 6px 16px rgba(0,0,0,.45)';
      el.style.fontSize = '14px';
      el.style.maxWidth = '380px';
      el.style.wordBreak = 'keep-all';
      el.style.color = '#e5e7eb';
      el.style.background = (type==='ok' ? '#065f46' : (type==='warn' ? '#7f1d1d' : '#334155'));
      document.getElementById('toastHost').appendChild(el);
      setTimeout(()=>{
        el.style.transition = 'opacity .2s ease, transform .2s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(4px)';
        setTimeout(()=> el.remove(), 200);
      }, ttl);
    }

    /* ---------- Í≥µÏßÄ(notices) ---------- */
    let noticeDataAll = [];
    let unsubNoticesPart8 = null;

    function renderNoticeModal(){
      const host = document.getElementById('noticeContent');
      if(!host) return;
      if(!noticeDataAll.length){
        host.innerHTML = `<p>ÌòÑÏû¨ Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>`;
        return;
      }
      host.innerHTML = noticeDataAll.map(n=>{
        const dt = new Date(n.createdAt || Date.now()).toLocaleString();
        const title = (n.title || 'Í≥µÏßÄÏÇ¨Ìï≠');
        const body  = (n.content || '').replace(/\n/g,'<br>');
        return `
          <div style="padding:8px 0; border-bottom:1px solid #374151;">
            <div style="font-weight:700;">${title}</div>
            <div style="color:#9ca3af; font-size:12px;">${dt}</div>
            <div style="margin-top:6px;">${body}</div>
          </div>
        `;
      }).join('');
    }

    function subscribeNoticesPart8(){
      // Í∏∞Ï°¥ Íµ¨ÎèÖÍ≥º Ï§ëÎ≥µÎêòÏßÄ ÏïäÎèÑÎ°ù Ìï¥Ï†ú ÌõÑ Îã§Ïãú Í±¥Îã§(ÏïàÏ†Ñ)
      if(unsubNoticesPart8){ try{unsubNoticesPart8();}catch(e){} unsubNoticesPart8=null; }
      try{
        unsubNoticesPart8 = onSnapshot(
          query(collection(db,'notices'), orderBy('createdAt','desc')),
          (snap)=>{
            const all = [];
            snap.forEach(d=>{
              all.push({ id:d.id, ...(d.data()||{}) });
            });
            noticeDataAll = all;
            renderNoticeModal();
          },
          (err)=> console.warn('notice Íµ¨ÎèÖ Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):', err)
        );
      }catch(e){
        console.warn('notice Íµ¨ÎèÖ Ïã§Ìå®(Î¨¥Ïãú Í∞ÄÎä•):', e);
      }
    }

    // Í≥µÏßÄ Î™®Îã¨ Ïó¥Í≥†-Îã´Í∏∞
    window.openNoticeModal = ()=>{
      const m = document.getElementById('noticeModal');
      if(m) m.style.display='flex';
    };
    window.closeNoticeModal = ()=>{
      const m = document.getElementById('noticeModal');
      if(m) m.style.display='none';
    };

    /* ---------- Îâ¥Ïä§(news) ---------- */
    let newsDataVisible = [];  // visible:trueÎßå
    let newsDataAll = [];      // Ï†ÑÏ≤¥
    let unsubNewsPart8 = null;

    function updateNewsBadge(count){
      const badge = document.getElementById('newsBadge');
      if(!badge) return;
      if(count > 0){
        badge.style.display = 'inline';
        badge.textContent = count;
      }else{
        badge.style.display = 'none';
      }
    }

    function renderNewsModal(){
      const host = document.getElementById('newsContent');
      if(!host) return;
      if(!newsDataVisible.length){
        host.innerHTML = `<p>ÌòÑÏû¨ Îì±Î°ùÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
        return;
      }
      host.innerHTML = newsDataVisible.map(n=>{
        const dt = new Date(n.createdAt||Date.now()).toLocaleString();
        const title = (n.title || 'Ï†úÎ™© ÏóÜÏùå');
        const body  = (n.content || '').replace(/\n/g,'<br>');
        return `
          <div style="padding:8px 0; border-bottom:1px solid #374151;">
            <div style="font-weight:700;">${title}</div>
            <div style="color:#9ca3af; font-size:12px;">${dt}</div>
            <div style="margin-top:6px;">${body}</div>
          </div>
        `;
      }).join('');
    }

    function subscribeNewsPart8(){
      // Ï§ëÎ≥µ Íµ¨ÎèÖ Î∞©ÏßÄ
      if(unsubNewsPart8){ try{unsubNewsPart8();}catch(e){} unsubNewsPart8=null; }
      try{
        unsubNewsPart8 = onSnapshot(
          query(collection(db,'news'), orderBy('createdAt','desc')),
          (snap)=>{
            const visible = [];
            const all = [];
            snap.forEach(docu=>{
              const n = { id:docu.id, ...(docu.data()||{}) };
              all.push(n);
              if(n.visible !== false) visible.push(n);
            });
            newsDataAll = all;
            newsDataVisible = visible;

            // Î∞∞ÏßÄ: ÏùΩÏßÄ ÏïäÏùÄ Í∞úÏàò(Î°úÏª¨ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Í∏∞Ï§Ä)
            const lastReadNewsAt = Number(localStorage.getItem('lastReadNewsAt') || 0);
            const unread = visible.filter(n => (n.createdAt||0) > lastReadNewsAt).length;
            updateNewsBadge(unread);

            renderNewsModal();
          },
          (err)=> console.warn('news Íµ¨ÎèÖ Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):', err)
        );
      }catch(e){
        console.warn('news Íµ¨ÎèÖ Ïã§Ìå®(Î¨¥Ïãú Í∞ÄÎä•):', e);
      }
    }

    // Îâ¥Ïä§ Î™®Îã¨ Ïó¥Í≥†-Îã´Í∏∞ + ÏùΩÏùå Ï≤òÎ¶¨
    window.openNewsModal = ()=>{
      const m = document.getElementById('newsModal');
      if(m) m.style.display='flex';
      const now = Date.now();
      localStorage.setItem('lastReadNewsAt', String(now));
      updateNewsBadge(0);
    };
    window.closeNewsModal = ()=>{
      const m = document.getElementById('newsModal');
      if(m) m.style.display='none';
    };

    /* ---------- ÏïàÏ†ÑÍ∞ÄÎìú & Î≥¥Ï°∞ Ïú†Ìã∏ ---------- */

    // Chart.js Î°úÎçî(Ïù¥ÎØ∏ Ïïû ÌååÌä∏Ïóê ÏûàÏñ¥ÎèÑ ÏïàÏ†ÑÌïòÍ≤å Î¨¥ÏãúÎê®)
    async function ensureChartJsSafe(){
      if(typeof Chart !== 'undefined') return true;
      return new Promise((resolve)=>{
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        s.onload = ()=> resolve(true);
        s.onerror = ()=> resolve(false);
        document.head.appendChild(s);
      });
    }

    // Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê Ïä§ÌÉÄÏùº Î≥¥Í∞ï(Ïù¥ÎØ∏ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ)
    function ensureAdminPanelStyleSafe(){
      const panel = document.getElementById('adminPanelAll');
      const header = document.getElementById('adminPanelHeader');
      if(!panel || !header) return;
      if(!panel.style.position) panel.style.position = 'fixed';
      if(!panel.style.zIndex) panel.style.zIndex = 2600;
      if(!panel.style.maxHeight) panel.style.maxHeight = '80vh';
      if(!panel.style.overflow) panel.style.overflow = 'auto';
      header.style.cursor = 'move';
      if(typeof enableDrag === 'function'){
        try{ enableDrag('adminPanelAll','adminPanelHeader'); }catch(e){}
      }
    }

    // Ï±ÑÌåÖ DOM Î≥¥Í∞ï(ÏóÜÏúºÎ©¥ Ï£ºÏûÖ) ‚Äî Î°úÏª¨ 20Í∞ú Ï†úÌïúÏùÄ Ïù¥ÎØ∏ Ïïû ÌååÌä∏ Íµ¨ÌòÑ
    function ensureChatDOMSafe(){
      if(document.getElementById('chatBox')) return;
      const box = document.createElement('div');
      box.id = 'chatBox';
      box.innerHTML = `
        <div id="chatHeader" style="cursor:move; display:flex; align-items:center; justify-content:space-between;">
          <span>üí¨ Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ (Î°úÏª¨/20Í∞ú Ï†úÌïú)</span>
          <button id="chatToggleBtn" style="padding:2px 8px;">‚Äî</button>
        </div>
        <div id="chatMessages"></div>
        <div id="chatResizer" title="ÎìúÎûòÍ∑∏Î°ú ÎÜíÏù¥ Ï°∞Ï†à"></div>
        <div id="chatInputWrap">
          <input id="chatInput" type="text" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• ÌõÑ Enter"/>
          <button onclick="sendChat()">Î≥¥ÎÇ¥Í∏∞</button>
        </div>
      `;
      box.style.position = 'fixed';
      box.style.top = '80px';
      box.style.right = '20px';
      box.style.width = '380px';
      box.style.height = '600px';
      box.style.minHeight = '300px';
      box.style.maxHeight = '900px';
      box.style.background = 'var(--card)';
      box.style.borderRadius = '12px';
      box.style.display = 'flex';
      box.style.flexDirection = 'column';
      box.style.overflow = 'hidden';
      box.style.boxShadow = '0 6px 18px rgba(0,0,0,0.5)';
      box.style.zIndex = 3000;
      document.body.appendChild(box);

      // ÏûÖÎ†• Ìï∏Îì§Îü¨
      const input = box.querySelector('#chatInput');
      input?.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          window.sendChat && window.sendChat();
        }
      });
    }

    /* ---------- onload Î≥¥Í∞ï(ÏïàÏ†ÑÌïòÍ≤å Ìïú Î≤à Îçî) ---------- */
    (async function part8BootStrap(){
      try{
        await ensureChartJsSafe();
      }catch(e){}
      ensureAdminPanelStyleSafe();
      ensureChatDOMSafe();

      // Í≥µÏßÄ/Îâ¥Ïä§ Íµ¨ÎèÖ Î≥¥Ïû•
      subscribeNoticesPart8();
      subscribeNewsPart8();

      // ÏµúÏ¥à Î†åÎçî(Î™®Îã¨Ïù¥ Ïó¥Î†§ ÏûàÏñ¥ÎèÑ ÏµúÏã† Î∞òÏòÅ)
      renderNoticeModal();
      renderNewsModal();

      // ÏïΩÍ∞ÑÏùò UX ÌÜ†Ïä§Ìä∏(ÏÑ†ÌÉù)
      setTimeout(()=>{
        if(marketOpenFlag){ toast('üü¢ Ïû•Ïù¥ Ïó¥Î†§ ÏûàÏäµÎãàÎã§.', 'ok', 1800); }
        else { toast('üî¥ Ïû•Ïù¥ ÎßàÍ∞ê ÏÉÅÌÉúÏûÖÎãàÎã§.', 'warn', 1800); }
      }, 600);
    })();

        /* ===========================================
       Part 9 ‚Äî ÏûêÏÇ∞ Ï°∞Ï†ï¬∑Ìã±Ìå®ÎÑê¬∑Î∞∞Ïú®/ÌôïÎ•† Ìå®ÎÑê Î≥¥Í∞ï
               + Ï†ÑÏ≤¥ Ï†ÅÏö© Î≤ÑÌäº/ÏãúÎÇòÎ¶¨Ïò§
               + Í∑∏ÎûòÌîÑ/ÏãúÏÑ∏ Ï¥àÍ∏∞Ìôî Í∞ïÌôî
    ============================================*/

    /* ---------- Í≥µÌÜµ Ìó¨Ìçº ---------- */
    const getActiveList     = () => (marketMode === 'coin' ? coins : companies);
    const getActiveState    = () => (marketMode === 'coin' ? coinState : stockState);
    const getActiveChances  = () => (marketMode === 'coin' ? coinChances : companyChances);
    const getDisplayPrice   = (a) => Math.max(1, Math.floor(typeof a.livePrice==='number' ? a.livePrice : a.basePrice));
    const findById          = (arr, id) => arr.find(x => String(x.id).toLowerCase()===String(id).toLowerCase() || String(x.name).toLowerCase()===String(id).toLowerCase());

    /* ---------- Í∑∏ÎûòÌîÑ/Í∞úÎ≥Ñ Í∏àÏï° Ï°∞Ï†ï Ìå®ÎÑê Î†åÎçî ---------- */
    function renderGraphAdjustPanel(){
      const wrap = document.getElementById("graphCompanyAdjust"); 
      if(!wrap) return;
      let html="";
      const list = getActiveList();
      list.forEach(a=>{
        const id = "adj-" + a.id;
        html += `
          <div class='req-card'>
            <div><strong>${a.name}</strong> | ÌòÑÏû¨Í∞Ä:
              <span id='panel-price-${a.id}'>${getDisplayPrice(a).toLocaleString()}</span> KRW
              ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}
            </div>
            <div style='display:flex; gap:8px; align-items:center; flex-wrap:wrap;'>
              <input type='number' id='${id}' placeholder='¬±Í∏àÏï°' style='width:120px;' ${a.delisted?'disabled':''}>
              <button ${a.delisted?'disabled':''} onclick="adjustActivePrice('${a.name}')">Ï†ÅÏö©</button>
              <span style="color:#9ca3af; font-size:12px;">(ÌòÑÏû¨ Î™®Îìú: ${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'})</span>
            </div>
          </div>`;
      });
      // Í∏ÄÎ°úÎ≤å Ïª®Ìä∏Î°§
      html += `
        <div class='req-card' style="flex-direction:column; align-items:flex-start;">
          <div style="font-weight:700; margin-bottom:6px;">Ï†ÑÏ≤¥ Ï°∞Ï†ï / ÏãúÏÑ∏ ÏÑ§Ï†ï</div>
          <div style='display:flex; gap:8px; flex-wrap:wrap; align-items:center;'>
            <input type='number' id='allDelta' placeholder='Ï†ÑÏ≤¥ ¬±Í∏àÏï°' style='width:140px;'>
            <button onclick="adjustAllPrices()">Ï†ÑÏ≤¥ Ï†ÅÏö©</button>
            <span style="width:12px"></span>
            <input type='number' id='deltaMaxInput' placeholder='Ìã± ÏµúÎåÄÎ≥ÄÌôî(Ïõê)' style='width:160px;'>
            <button onclick="applyDeltaMax()">Ìã± ÏÉÅÌïú Ï†ÅÏö©</button>
            <span style="width:12px"></span>
            <input type='number' id='intervalInput' placeholder='Ï£ºÍ∏∞(Ï¥à)' style='width:140px;'>
            <button onclick="applyGraphInterval()">Î≥ÄÎèôÏ£ºÍ∏∞ Ï†ÅÏö©</button>
            <span style="width:12px"></span>
            <button onclick="resetGraph()">Í∑∏ÎûòÌîÑ/ÏãúÏÑ∏ Ï¥àÍ∏∞Ìôî</button>
          </div>
        </div>
      `;
      wrap.innerHTML = html;
    }

    // Í∞úÎ≥Ñ ÏûêÏÇ∞ Ï¶âÏãú Ï°∞Ï†ï(ÌòÑÏû¨ Î™®ÎìúÎßå)
    window.adjustActivePrice = async function(name){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = getActiveList();
      const a = findById(list, name); if(!a) return;
      if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Ï°∞Ï†ï Î∂àÍ∞Ä");
      const inputEl = document.getElementById("adj-" + a.id);
      const delta = parseInt(inputEl && inputEl.value) || 0;
      const newVal=Math.max(1,(a.livePrice||a.basePrice)+delta);
      const coll = (marketMode==='coin') ? "coinPrices" : "companyPrices";
      await setDoc(doc(db,coll, a.id), { current:newVal, updatedAt: Date.now() }, { merge:true });
      a.livePrice=newVal;
      const p = document.getElementById("panel-price-" + a.id);
      if(p) p.textContent=getDisplayPrice(a).toLocaleString();
      const el = document.getElementById("price-" + a.id);
      if(el) el.textContent=getDisplayPrice(a).toLocaleString();
      updateMaxBuyUI && updateMaxBuyUI();
      toast(`üìà ${a.name} ${delta>=0?'+':''}${delta.toLocaleString()} Ï†ÅÏö©`, 'ok', 1400);
    };

    window.adjustAllPrices = async function(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const delta = parseInt(document.getElementById("allDelta").value) || 0;
      const tickAt = Date.now();
      const batch = writeBatch(db);

      const writeAll = (list, coll) => {
        for(const a of list){
          if(a.delisted) continue;
          const newVal = Math.max(1,(a.livePrice||a.basePrice)+delta);
          a.livePrice = newVal;
          batch.set(doc(db,coll, a.id), { current:newVal, updatedAt: tickAt }, { merge:true });
        }
      };
      writeAll(companies,'companyPrices');
      writeAll(coins,    'coinPrices');

      await batch.commit();
      await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
      updateMaxBuyUI && updateMaxBuyUI();
      toast(`üßÆ Ï†ÑÏ≤¥ ${delta>=0?'+':''}${delta.toLocaleString()} Ï†ÅÏö©(ÏÉÅÏû•ÌèêÏßÄ Ï†úÏô∏)`, 'ok');
    };

    window.applyDeltaMax = function(){
      const val = parseInt(document.getElementById("deltaMaxInput").value) || 1;
      deltaMax = Math.max(1, val);
      toast("‚úÖ 1Ìã± ÏÉÅÌïú(¬±Ïõê) Ï†ÅÏö©: " + deltaMax.toLocaleString(), 'ok');
    };

    window.applyGraphInterval = function(){
      const sec = parseInt(document.getElementById("intervalInput").value) || 5;
      updateInterval = Math.max(1, sec) * 1000;
      setDoc(doc(db,"marketState","main"), { interval:updateInterval, updatedAt:Date.now() }, { merge:true })
        .then(()=>{
          if(ADMIN_MODE){ if(priceTimer){ clearInterval(priceTimer); } if(marketOpenFlag) startLocalTimer(); }
          toast("‚è±Ô∏è Î≥ÄÎèôÏ£ºÍ∏∞ Ï†ÅÏö©: " + sec + "Ï¥à", 'ok');
        })
        .catch(e=>console.error("Î≥ÄÎèôÏ£ºÍ∏∞ Ï†ÄÏû• Ïã§Ìå®:", e));
    };

    window.resetGraph = async function(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const tickAt = Date.now();
      const batch = writeBatch(db);
      for(const a of companies){
        if(a.delisted) continue;
        a.livePrice=a.basePrice;
        batch.set(doc(db,"companyPrices", a.id), { current: a.basePrice, updatedAt: tickAt }, { merge:true });
      }
      for(const a of coins){
        if(a.delisted) continue;
        a.livePrice=a.basePrice;
        batch.set(doc(db,"coinPrices", a.id), { current: a.basePrice, updatedAt: tickAt }, { merge:true });
      }
      await batch.commit();
      await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
      if(chart){
        chart.data.labels = [];
        chart.data.datasets.forEach(d=> d.data = []);
        chart.update();
        lastChartTick = 0;
      }
      updateMaxBuyUI && updateMaxBuyUI();
      toast('üîÑ Í∑∏ÎûòÌîÑ/ÏãúÏÑ∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å', 'ok');
    };

    /* ---------- Ï£ºÍ∞Ä Ï°∞Ïûë(Ìã± Î≤ÑÌäº) ---------- */
    function renderStockTuner(){
      const host = document.getElementById('stockTuner'); 
      if(!host) return;
      let html = "";
      const list = getActiveList();
      list.forEach(a=>{
        const disabled = a.delisted ? "disabled" : "";
        html += `
          <div class='req-card'>
            <div><strong>${a.name}</strong> | ${getDisplayPrice(a).toLocaleString()} KRW ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}</div>
            <div style='display:flex; gap:6px; flex-wrap:wrap;'>
              <button ${disabled} onclick="applyTickDelta('${a.name}', -100000)">-10Îßå</button>
              <button ${disabled} onclick="applyTickDelta('${a.name}', -10000)">-1Îßå</button>
              <button ${disabled} onclick="applyTickDelta('${a.name}', 10000)">+1Îßå</button>
              <button ${disabled} onclick="applyTickDelta('${a.name}', 100000)">+10Îßå</button>
              <span style="color:#9ca3af; font-size:12px;">(ÌòÑÏû¨ Î™®Îìú: ${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'})</span>
            </div>
          </div>`;
      });
      host.innerHTML = html || "<div class='req-card'>ÏûêÏÇ∞ ÏóÜÏùå</div>";
    }

    window.applyTickDelta = async function(name, delta){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = getActiveList();
      const a = findById(list, name); if(!a) return;
      if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ Ï°∞Ï†ï Î∂àÍ∞Ä");
      // ÌòÑÏû¨ Î≥¥Ïù¥Îäî Î™®Îìú Í∞ÄÍ≤©Îßå Ï°∞Ï†ï
      const coll = (marketMode==='coin') ? 'coinPrices' : 'companyPrices';
      const next = Math.max(1, (a.livePrice || a.basePrice) + delta);
      await setDoc(doc(db,coll, a.id), { current: next, updatedAt: Date.now() }, { merge: true });
      a.livePrice = next;
      document.getElementById("price-"+a.id)?.textContent = getDisplayPrice(a).toLocaleString();
      document.getElementById("panel-price-"+a.id)?.textContent = getDisplayPrice(a).toLocaleString();
      updateMaxBuyUI && updateMaxBuyUI();
      toast(`üéöÔ∏è ${a.name} ${delta>=0?'+':''}${delta.toLocaleString()} Ìã±`, 'ok', 1200);
    };

    /* ---------- Î∞∞Ïú®/ÌôïÎ•† Ìå®ÎÑê ---------- */
    function renderChangePanel(){
      const host = document.getElementById('changePanel'); 
      if(!host) return;
      let html = "";
      const list = getActiveList();
      const map  = getActiveChances();
      list.forEach(a=>{
        const ch = map[a.id] || {profit:0.4, loss:0.6};
        html += `
          <div class="req-card">
            <div style="min-width:220px;">
              <div><strong>${a.name}</strong> ${a.delisted ? "<span style='margin-left:8px;color:#ef4444;'>‚ö´ ÏÉÅÏû•ÌèêÏßÄ</span>" : ""}</div>
              <div style="font-size:12px;color:#9ca3af;">Î∞∞Ïú®: <strong id="mult-${a.id}">${Number(a.multiplier||1)}</strong> | ÌôïÎ•†: ‚Üë${(ch.profit*100).toFixed(1)}% / ‚Üì${(ch.loss*100).toFixed(1)}%</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input type="number" id="inp-mul-${a.id}" step="0.1" value="${Number(a.multiplier||1)}" style="width:90px;" ${a.delisted?'disabled':''}>
              <button ${a.delisted?'disabled':''} onclick="applyMultiplier('${a.name}')">Î∞∞Ïú®Ï†ÅÏö©</button>
              <span style="width:8px"></span>
              <input type="number" id="inp-up-${a.id}" step="0.01" min="0" max="1" value="${ch.profit}" style="width:90px;" ${a.delisted?'disabled':''}>
              <input type="number" id="inp-down-${a.id}" step="0.01" min="0" max="1" value="${ch.loss}" style="width:90px;" ${a.delisted?'disabled':''}>
              <button ${a.delisted?'disabled':''} onclick="applyChance('${a.name}')">ÌôïÎ•†Ï†ÅÏö©</button>
            </div>
          </div>
        `;
      });

      // Í∏ÄÎ°úÎ≤å ÏûÖÎ†• Î∞ïÏä§Í∞Ä ÏóÜÏùÑ Ïàò ÏûàÏúºÎãà Ìï®Íªò Ï†úÍ≥µ
      html += `
        <div class="req-card" style="flex-direction:column; align-items:flex-start;">
          <div style="font-weight:700; margin-bottom:6px;">Ï†ÑÏ≤¥ Ï†ÅÏö©</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input type="number" id="allMultiplierVal" placeholder="Ï†ÑÏ≤¥ Î∞∞Ïú®" step="0.1" style="width:140px;">
            <button onclick="setAllMultipliers()">Ï†ÑÏ≤¥ Î∞∞Ïú® Ï†ÅÏö©</button>
            <span style="width:10px"></span>
            <input type="number" id="globalProfit" placeholder="Ïù¥Îìù ÌôïÎ•†(0~1)" step="0.01" style="width:160px;">
            <input type="number" id="globalLoss"   placeholder="ÏÜêÌï¥ ÌôïÎ•†(0~1)" step="0.01" style="width:160px;">
            <button onclick="setAllChances()">Ï†ÑÏ≤¥ ÌôïÎ•† Ï†ÅÏö©</button>
            <span style="width:10px"></span>
            <input type="number" id="volatilityInput" placeholder="Ï†ÑÏó≠ Î≥ÄÎèôÌè≠(%)" step="0.1" style="width:160px;">
            <button onclick="applyVolatility()">Î≥ÄÎèôÌè≠ Ï†ÅÏö©</button>
          </div>
        </div>

        <div class="req-card">
          <div style="font-weight:700;">üìà/üìâ Îã®Í∏∞ ÏãúÎÇòÎ¶¨Ïò§</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="runScenario('riseEnd')">üìà Îã®Í∏∞ ÏÉÅÏäπ Ïú†ÎèÑ(1Î∂Ñ)</button>
            <button onclick="runScenario('fallEnd')">üìâ Îã®Í∏∞ ÌïòÎùΩ Ïú†ÎèÑ(1Î∂Ñ)</button>
          </div>
        </div>
      `;

      host.innerHTML = html || "<div class='req-card'>ÏûêÏÇ∞ ÏóÜÏùå</div>";
    }

    window.applyMultiplier = async function(name){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = getActiveList();
      const a = findById(list, name); if(!a) return;
      if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ ÏàòÏ†ï Î∂àÍ∞Ä");
      const el = document.getElementById("inp-mul-" + a.id);
      const val = Number(el?.value||1);
      const m = isNaN(val) ? 1 : Math.max(0, val);
      const coll = (marketMode==='coin') ? 'coinSettings' : 'companySettings';
      await setDoc(doc(db,coll, a.id), { multiplier:m, updatedAt:Date.now() }, { merge:true });
      a.multiplier = m;
      document.getElementById("mult-" + a.id)?.textContent = String(m);
      toast(`‚úÖ ${a.name} Î∞∞Ïú® ${m} Ï†ÅÏö©`, 'ok');
    };

    window.applyChance = async function(name){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = getActiveList();
      const map  = getActiveChances();
      const a = findById(list, name); if(!a) return;
      if(a.delisted) return alert("‚ö´ ÏÉÅÏû•ÌèêÏßÄ ÏûêÏÇ∞ÏùÄ ÏàòÏ†ï Î∂àÍ∞Ä");
      const upEl = document.getElementById("inp-up-" + a.id);
      const dnEl = document.getElementById("inp-down-" + a.id);
      let up = Number(upEl?.value||0.4);
      let dn = Number(dnEl?.value||0.6);
      if(up<0||dn<0 || (up+dn)<=0){ return alert("0~1 Î≤îÏúÑ, Ìï©Í≥Ñ>0 Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§."); }
      const coll = (marketMode==='coin') ? 'coinChances' : 'companyChances';
      await setDoc(doc(db,coll, a.id), { profit:up, loss:dn, updatedAt:Date.now() }, { merge:true });
      map[a.id] = { profit:up, loss:dn };
      renderChangePanel();
      toast(`‚úÖ ${a.name} ÌôïÎ•† Ï†ÅÏö© (‚Üë${(up*100).toFixed(1)}% / ‚Üì${(dn*100).toFixed(1)}%)`, 'ok');
    };

    window.setAllMultipliers = async function(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const v = Number(document.getElementById("allMultiplierVal").value);
      const m = isNaN(v) ? 1 : Math.max(0, v);
      const list = getActiveList();
      const coll = (marketMode==='coin') ? 'coinSettings' : 'companySettings';
      for(const a of list){
        if(a.delisted) continue;
        await setDoc(doc(db,coll, a.id), { multiplier:m, updatedAt:Date.now() }, { merge:true });
        a.multiplier = m;
      }
      renderChangePanel();
      toast(`‚úÖ (${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'}) Ï†ÑÏ≤¥ Î∞∞Ïú® ${m} Ï†ÅÏö©(ÏÉÅÏû•ÌèêÏßÄ Ï†úÏô∏)`, 'ok');
    };

    window.setAllChances = async function(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const p = parseFloat(document.getElementById('globalProfit').value);
      const l = parseFloat(document.getElementById('globalLoss').value);
      if(isNaN(p)||isNaN(l)||p<0||l<0||(p+l)<=0){ alert("ÏûòÎ™ªÎêú Í∞íÏûÖÎãàÎã§ (0~1, Ìï©Í≥Ñ>0)."); return; }
      const list = getActiveList();
      const coll = (marketMode==='coin') ? 'coinChances' : 'companyChances';
      const map  = getActiveChances();
      try{
        for(const a of list){
          if(a.delisted) continue;
          await setDoc(doc(db,coll, a.id), { profit:p, loss:l, updatedAt: Date.now() }, { merge:true });
          map[a.id] = { profit:p, loss:l };
        }
        renderChangePanel();
        toast(`‚úÖ (${marketMode==='coin'?'ÏΩîÏù∏':'Ï£ºÏãù'}) Ï†ÑÏ≤¥ ÌôïÎ•† Ï†ÅÏö©: ‚Üë${(p*100).toFixed(1)}% / ‚Üì${(l*100).toFixed(1)}%`, 'ok');
      }catch(e){ console.error("Ï†ÑÏ≤¥ ÌôïÎ•† Ï†ÅÏö© Ïã§Ìå®:", e); alert("Ïò§Î•ò: Î≥ÄÎèôÌè≠/ÌôïÎ•† Ï†ÅÏö© Ïã§Ìå®"); }
    };

    window.applyVolatility = async function(){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const v = Number(document.getElementById('volatilityInput').value);
      const vv = isNaN(v) ? 1.5 : Math.max(0, v);
      try{
        await setDoc(doc(db,'globals','settings'), { volatility: vv, updatedAt: Date.now() }, { merge:true });
        volatility = vv;
        toast(`‚úÖ Ï†ÑÏó≠ Î≥ÄÎèôÌè≠ ${vv}% Ï†ÅÏö©`, 'ok');
      }catch(e){ console.error(e); alert("Ïò§Î•ò: Î≥ÄÎèôÌè≠ Ï†ÅÏö© Ïã§Ìå®"); }
    };

    window.runScenario = function(type){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const force = (type==='riseEnd') ? -1 : 1;
      const list = getActiveList();
      const state= getActiveState();
      list.forEach(a=>{ if(!a.delisted) state.bias[a.id] = force; });
      toast(type==='riseEnd' ? "üìà Îã®Í∏∞ ÏÉÅÏäπ Ïú†ÎèÑ ÏãúÏûë (1Î∂Ñ)" : "üìâ Îã®Í∏∞ ÌïòÎùΩ Ïú†ÎèÑ ÏãúÏûë (1Î∂Ñ)", 'ok');
      setTimeout(()=>{ list.forEach(a=>{ state.bias[a.id] = 0; }); }, 60000);
    };

    /* ---------- ÏÉÅÏû•ÌèêÏßÄ/Î≥µÍµ¨(ÏÜçÏÑ± ÌÜ†Í∏Ä + Î≥¥Ïú† 0 Ï≤òÎ¶¨) ---------- */
    function renderDelistPanel(){
      const host = document.getElementById("delistPanel"); 
      if(!host) return;
      let html = `<h4 style="margin:6px 0">Ï£ºÏãù</h4>`;
      companies.forEach(a=>{
        const isDelisted = !!a.delisted;
        html += `
          <div class="req-card">
            <div>
              <strong>${a.name}</strong>
              <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">${isDelisted?'‚ö´ ÏÉÅÏû•ÌèêÏßÄ':'üü¢ ÏÉÅÏû•'}</span>
              <div style="font-size:12px;color:#9ca3af;margin-top:4px;">ÌòÑÏû¨Í∞Ä: ${getDisplayPrice(a).toLocaleString()} KRW, Î∞∞Ïú®: ${Number(a.multiplier||1)}</div>
            </div>
            <div style="display:flex; gap:8px;">
              ${isDelisted
                ? `<button onclick="restoreAsset('stock','${a.name}')">Î≥µÍµ¨</button>`
                : `<button onclick="delistAsset('stock','${a.name}')" style="background:#7f1d1d;">ÏÉÅÏû•ÌèêÏßÄ</button>`}
            </div>
          </div>`;
      });
      html += `<h4 style="margin:12px 0 6px">ÏΩîÏù∏</h4>`;
      coins.forEach(a=>{
        const isDelisted = !!a.delisted;
        html += `
          <div class="req-card">
            <div>
              <strong>${a.name}</strong>
              <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">${isDelisted?'‚ö´ ÏÉÅÏû•ÌèêÏßÄ':'üü¢ ÏÉÅÏû•'}</span>
              <div style="font-size:12px;color:#9ca3af;margin-top:4px;">ÌòÑÏû¨Í∞Ä: ${getDisplayPrice(a).toLocaleString()} KRW, Î∞∞Ïú®: ${Number(a.multiplier||1)}</div>
            </div>
            <div style="display:flex; gap:8px;">
              ${isDelisted
                ? `<button onclick="restoreAsset('coin','${a.name}')">Î≥µÍµ¨</button>`
                : `<button onclick="delistAsset('coin','${a.name}')" style="background:#7f1d1d;">ÏÉÅÏû•ÌèêÏßÄ</button>`}
            </div>
          </div>`;
      });
      host.innerHTML = html;
    }

    window.delistAsset = async function(kind, name){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = (kind==='coin') ? coins : companies;
      const coll = (kind==='coin') ? 'coinSettings' : 'companySettings';
      const a = findById(list, name); if(!a) return;

      await setDoc(doc(db,coll,a.id), { delisted:true, updatedAt:Date.now() }, { merge:true });
      a.delisted = true;

      // Î™®Îì† Ïú†Ï†Ä Î≥¥Ïú†Î∂Ñ 0 Ï≤òÎ¶¨
      try {
        const snap = await getDocs(collection(db, "users"));
        const batch = writeBatch(db);
        snap.forEach(docu => {
          const u = docu.data();
          if(kind==='stock'){
            if(u.holdingsStock && u.holdingsStock[a.name] > 0){
              const next = {...u.holdingsStock};
              next[a.name] = 0;
              batch.update(doc(db,"users",docu.id), { holdingsStock:next, updatedAt:Date.now() });
            }
          }else{
            if(u.holdingsCoin && u.holdingsCoin[a.name] > 0){
              const next = {...u.holdingsCoin};
              next[a.name] = 0;
              batch.update(doc(db,"users",docu.id), { holdingsCoin:next, updatedAt:Date.now() });
            }
          }
        });
        await batch.commit();
      } catch(e){ console.error("ÏÉÅÏû•ÌèêÏßÄ Î≥¥Ïú†Î∂Ñ Ï†ïÎ¶¨ Ïã§Ìå®:", e); }

      renderDelistPanel();
      renderAllAdminPanels && renderAllAdminPanels();
      renderMarketStatus && renderMarketStatus();
      initAssetUI && initAssetUI();
      toast(`‚ö´ ${a.name} ÏÉÅÏû•ÌèêÏßÄ ÏôÑÎ£å (Î≥¥Ïú† ÏàòÎüâ 0 Ï≤òÎ¶¨)`, 'warn');
    };

    window.restoreAsset = async function(kind, name){
      if(!ADMIN_MODE) return alert("Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.");
      const list = (kind==='coin') ? coins : companies;
      const coll = (kind==='coin') ? 'coinSettings' : 'companySettings';
      const a = findById(list, name); if(!a) return;
      await setDoc(doc(db,coll,a.id), { delisted:false, updatedAt:Date.now() }, { merge:true });
      a.delisted = false;
      renderDelistPanel();
      renderAllAdminPanels && renderAllAdminPanels();
      renderMarketStatus && renderMarketStatus();
      initAssetUI && initAssetUI();
      toast(`üü¢ ${a.name} Î≥µÍµ¨ ÏôÑÎ£å`, 'ok');
    };

    /* ---------- ÌÉ≠ Î†åÎçî Î¨∂Ïùå(Ìò∏Ï∂ú ÏßÄÏ†êÏóêÏÑú Ìïú Î≤àÏóê) ---------- */
    function renderAllAdminPanels(){
      // Í∞Å ÏÑπÏÖò Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÏûàÏùÑ ÎïåÎßå Î†åÎçî
      try{ renderGraphAdjustPanel(); }catch(e){ }
      try{ renderStockTuner(); }catch(e){ }
      try{ renderChangePanel(); }catch(e){ }
      try{ renderDelistPanel(); }catch(e){ }
    }

        /* ===========================================
       Part 10 ‚Äî Í¥ÄÎ¶¨Ïûê Ï†ëÍ∑º Ï†úÏñ¥, Ïú†Ï†Ä Ìå®ÎÑê,
                  Î°úÍ∑∏Ïù∏/ÏÑ∏ÏÖò, Ï±ÑÌåÖ/ÎìúÎûòÍ∑∏ ÎßàÎ¨¥Î¶¨
    ============================================*/

    /* ---------- Í¥ÄÎ¶¨Ïûê Ï†ëÍ∑º Ï†úÏñ¥ ---------- */
    window.checkAdmin = function(){
      const code = document.getElementById('adminCode').value.trim();
      if(code !== 'ADBEN7732'){
        alert('‚ùå ÏûòÎ™ªÎêú ÏΩîÎìúÏûÖÎãàÎã§.');
        document.getElementById('adminCode').value = '';
        return;
      }
      ADMIN_MODE = true;
      const panel = document.getElementById('adminPanelAll');
      if(panel) panel.style.display='block';
      window.showTab('graph');
      renderAllAdminPanels();
      renderUserList(true);
      renderFinanceQueues(true);
      document.getElementById('adminCode').value = '';
      alert("‚úÖ Í¥ÄÎ¶¨Ïûê Ìå®ÎÑêÏù¥ Ïó¥Î†∏ÏäµÎãàÎã§.");
    };

    // Í¥ÄÎ¶¨ÏûêÍ∞Ä 1Î™ÖÏù¥ÎùºÎèÑ ÏûàÏúºÎ©¥ ÏùºÎ∞ò Ïú†Ï†ÄÎäî Ìå®ÎÑê Ï†ëÍ∑º Î∂àÍ∞Ä
    async function restrictAdminPanel(){
      const users = await getDocs(collection(db,"users"));
      let adminCount = 0;
      users.forEach(u=>{
        if(u.data()?.isAdmin) adminCount++;
      });
      if(adminCount > 0 && !ADMIN_MODE){
        document.getElementById('adminPanelAll').style.display='none';
      }
    }

    /* ---------- Ìå®ÎÑê ÎìúÎûòÍ∑∏ Ïù¥Îèô ---------- */
    function enableDrag(panelId, headerId){
      const panel = document.getElementById(panelId);
      const header = document.getElementById(headerId);
      if(!panel || !header) return;
      let offsetX=0, offsetY=0, dragging=false;
      header.addEventListener('mousedown', (e)=>{
        dragging=true; offsetX=e.clientX-panel.offsetLeft; offsetY=e.clientY-panel.offsetTop;
        document.body.style.userSelect='none';
      });
      document.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        panel.style.left = (e.clientX-offsetX)+'px';
        panel.style.top  = (e.clientY-offsetY)+'px';
      });
      document.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    }

    /* ---------- Ïú†Ï†Ä Ìå®ÎÑê Î†åÎçî ---------- */
    function renderUserList(startListen=false){
      const host = document.getElementById("userList");
      if(!host) return;
      if(startListen){
        if(unsubUsers){ try{unsubUsers();}catch(e){} unsubUsers=null; }
        unsubUsers = onSnapshot(collection(db,"users"), (snap)=>{
          let html="";
          snap.forEach(docu=>{
            const u=docu.data();
            html+=`
              <div class='req-card'>
                <div><strong>${u.userName||u.name||docu.id}</strong> (${docu.id})</div>
                <div>Î≥¥Ïú†ÌòÑÍ∏à: ${(u.cash||0).toLocaleString()} KRW</div>
                <div>Ï£ºÏãùÎ≥¥Ïú†: ${JSON.stringify(u.holdingsStock||{})}</div>
                <div>ÏΩîÏù∏Î≥¥Ïú†: ${JSON.stringify(u.holdingsCoin||{})}</div>
              </div>
            `;
          });
          host.innerHTML = html || "Ïú†Ï†Ä ÏóÜÏùå";
        });
      }
    }

    /* ---------- Ï±ÑÌåÖÏ∞Ω Ï¥àÍ∏∞Ìôî(Î¶¨ÏÇ¨Ïù¥Ï¶à+ÌÜ†Í∏Ä Ïù¥ÎØ∏ Part 7/8ÏóêÏÑú Íµ¨ÌòÑÎê®) ---------- */
    // Ïù¥ÎØ∏ initChatUI, ensureChatDOMSafe Îì± ÏûàÏùå ‚Üí ÏÉùÎûµ (Ïó¨Í∏∞ÏÑ† Î≥¥Í∞ïÎßå)

    /* ---------- Î°úÍ∑∏Ïù∏/ÏÑ∏ÏÖò ---------- */
    async function ensureAuth(){
      try{ await signInAnonymously(auth); }catch(e){ console.error(e); }
      return new Promise(res=>{
        onAuthStateChanged(auth,(u)=>{ res(u); });
      });
    }

    function subscribeCurrentUser(uid){
      if(unsubscribeUser){ try{unsubscribeUser();}catch(e){} unsubscribeUser=null; }
      const uref=doc(db,"users",uid);
      unsubscribeUser = onSnapshot(uref,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data();
        if(typeof d.cash==='number') player.cash=d.cash;
        if(d.holdingsStock && typeof d.holdingsStock==='object') player.holdingsStock=d.holdingsStock;
        if(d.holdingsCoin  && typeof d.holdingsCoin==='object') player.holdingsCoin =d.holdingsCoin;
        renderUserInfo(); updateHoldingsUI();
      });
    }

    /* ---------- Admin ÌÉ≠ Ï†ÑÌôò ---------- */
    window.showTab = function(name){
      document.querySelectorAll('#adminPanelAll .tab-section').forEach(sec => sec.style.display = 'none');
      const t = document.getElementById('tab-'+name);
      if(t) t.style.display='block';
    };

    window.closeAdmin = function(id){
      const el=document.getElementById(id);
      if(el) el.style.display='none';
      if(id==='adminPanelAll'){
        if(unsubUsers){ try{unsubUsers();}catch(e){} unsubUsers=null; }
        if(unsubDeposits){ try{unsubDeposits();}catch(e){} unsubDeposits=null; }
        if(unsubWithdraws){ try{unsubWithdraws();}catch(e){} unsubWithdraws=null; }
      }
    };

    /* ---------- onload ÎßàÎ¨¥Î¶¨ ---------- */
    window.onload = async () => {
      await ensureAuth();

      // Î°úÍ∑∏Ïù∏ Î≥µÏõê
      const saved = localStorage.getItem('stockUser');
      if(saved){
        try{
          const parsed = JSON.parse(saved);
          if(parsed && parsed.id && parsed.name){
            currentUser = { id: parsed.id, name: parsed.name };
            loginModal.style.display='none';
            try{ await updateDoc(doc(db,"users",parsed.id), { active:true, lastLoginAt: Date.now() }); }catch(e){}
            renderUserInfo(); initAssetUI(); subscribeCurrentUser(parsed.id);
          }else{ loginModal.style.display='flex'; }
        }catch(e){
          localStorage.removeItem('stockUser'); loginModal.style.display='flex';
        }
      }else{
        loginModal.style.display='flex';
      }

      await ensureChartJsSafe();
      initChart();

      subscribeCompanyPrices();
      subscribeCoinPrices();
      subscribeCompanySettings();
      subscribeCoinSettings();
      subscribeCompanyChances();
      subscribeCoinChances();
      subscribeMarketState();
      subscribeGlobals();
      subscribeNewsPart8();
      subscribeNoticesPart8();
      subscribeAdminGate();

      ensureChatDOMSafe();
      initChatUI();

      ensureAdminPanelStyleSafe();
      enableDrag('adminPanelAll','adminPanelHeader');

      renderMarketStatus();
      initAssetUI();

      if(modeToggleBtn){
        modeToggleBtn.textContent = "üí± ÏΩîÏù∏ / Ï£ºÏãù Ï†ÑÌôò";
      }
    };

    // ÌéòÏù¥ÏßÄ Ïù¥ÌÉàÏãú ÏÑ∏ÏÖò Ï†ïÎ¶¨
    window.addEventListener("beforeunload", async ()=>{
      try{
        if(currentUser){
          await updateDoc(doc(db,"users",currentUser.id),{active:false, lastLogoutAt: Date.now()});
        }
      }catch(e){}
    });
  </script>
</body>
</html>
