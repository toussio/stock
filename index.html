<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>

  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
      --muted:#94a3b8; --chip:#0b1220; --chipbd:#374151;
      --good:#10b981; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    #userRow,#log { margin:20px auto; max-width:1200px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1200px; flex-wrap:wrap; }
    #depositForm input { padding:10px; border-radius:10px; border:1px solid var(--chipbd); background:var(--chip); color:var(--ink); }
    #depositForm .memo { min-width:240px; }

    button { padding:10px 14px; cursor:pointer; border-radius:10px; background:var(--accent); color:var(--ink); border:none; transition:.15s ease; }
    button:hover { background:var(--accentH); transform:translateY(-1px) }
    button:active{ transform:translateY(0) }
    button.ghost{ background:transparent; border:1px solid var(--chipbd); }
    button:disabled { opacity:.45; cursor:not-allowed; transform:none; }

    #chartWrap { position:relative; margin:20px auto; max-width:1200px; height:420px; background:#111827; border-radius:12px; overflow:hidden; border:1px solid #0b1324; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1200px; }
    .company { background:var(--card); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; transition:filter .2s ease, opacity .2s ease, transform .15s ease; border:1px solid #0e162b; }
    .company:hover{ transform:translateY(-1px); }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:700; }
    .status-badge{ font-size:13px; line-height:1; padding:5px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipbd); color:var(--ink2); }
    .status-badge.delisted{ background:#111827; border-color:#4b5563; color:#9ca3af; }
    .company.delisted{ opacity:.6; filter:grayscale(.2); }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"],
    .company .actions input[type="text"] { grid-column:span 2; padding:9px; border-radius:10px; border:1px solid var(--chipbd); background:var(--chip); color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    #log { max-height:260px; overflow-y:auto; background:#111827; padding:12px; border-radius:12px; border:1px solid #0b1324; }

    .req-card { background:var(--card); border-radius:12px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; border:1px solid #0e162b; }
    .req-col { display:flex; flex-direction:column; gap:8px; }
    .small { font-size:12px; color:var(--muted) }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:12px; text-align:center; width:min(92%,560px); position:relative; border:1px solid #0e162b; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:10px; width:92%; border-radius:10px; border:1px solid var(--chipbd); background:var(--chip); color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:30px; height:30px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    /* í†µí•© ê´€ë¦¬ì íŒ¨ë„ */
    .admin-panel{display:none; max-width:1200px; margin:20px auto; background:var(--card); padding:10px; border-radius:12px; position:relative; border:1px solid #0e162b;}
    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:10px; border-radius:10px; border:1px solid var(--chipbd); background:var(--chip); color:var(--ink) }

    /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ê´€ë¦¬ì í†µí•© íŒ¨ë„ (í™”ë©´ ë°– ì´ë™ í—ˆìš©) */
    #adminPanelAll {
      position:fixed; top:50px; left:50px; z-index:9999;
      width:94%; max-width:1200px;
      pointer-events:auto;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
    }
    #adminPanelHeader {
      background:#374151; padding:8px 44px 8px 12px; cursor:move;
      border-radius:12px 12px 0 0; font-weight:800; user-select:none;
      position:relative; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px; font-size:12px;
      background:var(--chip); border:1px solid var(--chipbd); color:var(--ink2);
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .grid { display:grid; gap:10px; }
    .grid.cols-2 { grid-template-columns:repeat(2,1fr); }
    .grid.cols-3 { grid-template-columns:repeat(3,1fr); }
    .grid.cols-4 { grid-template-columns:repeat(4,1fr); }
    .grid.cols-5 { grid-template-columns:repeat(5,1fr); }
    .grid.auto-fit { grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace; background:#0b1324; border:1px solid #0e162b; padding:2px 6px; border-radius:6px; font-size:12px; color:#cbd5e1;}

    .danger { background:var(--danger)!important }
    .ok { background:var(--ok)!important }
    .good { color:var(--good) }
    .bad { color:var(--bad) }
    .warn{ color:var(--warn) }

    .divider{height:1px; background:#0e162b; margin:10px 0;}

    .table {
      width:100%; border-collapse:separate; border-spacing:0 8px;
    }
    .table th { text-align:left; color:#9ca3af; font-weight:600; font-size:13px; padding:2px 6px; }
    .table td { background:var(--card); border:1px solid #0e162b; padding:10px; border-radius:10px; }

    /* ìƒì¥íì§€ íƒ€ì´ë¨¸ ETA í‘œì‹œìš© */
    .eta { font-variant-numeric: tabular-nums; }

    /* ë°˜ì‘í˜• */
    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:600px){ 
      #companies{ grid-template-columns:1fr }
      #chartWrap{ height:320px }
    }
  </style>
</head>
<body>
  <h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

  <!-- ìƒë‹¨ ì‚¬ìš©ì íŒ¨ë„ -->
  <div id="userRow">
    <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
    <div class="row">
      <span id="marketBadge" class="chip">ì‹œì¥ìƒíƒœ: <strong id="marketStateText">ëŒ€ê¸°</strong></span>
      <span id="driverBadge" class="chip">ë“œë¼ì´ë²„: <span id="driverText">-</span></span>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <button onclick="openWithdrawModal()">ì¶œê¸ˆ ìš”ì²­</button>
      <button onclick="openNoticeModal()">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button onclick="openNewsModal()">ğŸ“° ë‰´ìŠ¤ ë³´ê¸° 
        <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span>
      </button>
    </div>
  </div>

  <!-- ì…ê¸ˆ ìš”ì²­ -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <!-- ì°¨íŠ¸/ì¢…ëª©/ë¡œê·¸ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
      <p class="small">í•œ ë²ˆ ë¡œê·¸ì¸í•˜ë©´ ë¸Œë¼ìš°ì €ì— ì„¸ì…˜ì´ ì €ì¥ë©ë‹ˆë‹¤.</p>
      <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <button id="startBtn">ì‹œì‘</button>
    </div>
  </div>

  <!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeWithdrawModal()">âœ•</button>
      <h2>ì¶œê¸ˆ ìš”ì²­</h2>
      <div class="small">ìˆ˜ìˆ˜ë£ŒëŠ” ê¸ˆì•¡ì˜ 20%ê°€ ê¸°ë³¸ ì„¤ì •ì…ë‹ˆë‹¤.</div>
      <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
      <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥" oninput="updateWithdrawFee()"><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
      <input type="text" id="withdrawAccount" placeholder="ë³¸ì¸ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥"><br>
      <button onclick="submitWithdraw()">ìš”ì²­</button>
    </div>
  </div>

  <!-- ê³µì§€ ëª¨ë‹¬ -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeNoticeModal()">âœ•</button>
      <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
      <div id="noticeContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button onclick="closeNoticeModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ -->
  <div id="newsModal" class="modal">
    <div class="modal-content" style="margin-top:40px;">
      <button class="xbtn" onclick="closeNewsModal()">âœ•</button>
      <h2>ğŸ“° ìµœì‹  ë‰´ìŠ¤</h2>
      <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <button onclick="closeNewsModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ (1ë‹¨ê³„: ì½”ë“œ) -->
  <div id="adminLogin">
    <div class="row" style="justify-content:center; gap:12px;">
      <span class="chip">ê´€ë¦¬ì ìƒíƒœ: <strong id="adminStateText">OFF</strong></span>
      <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
      <button onclick="checkAdmin()">ê´€ë¦¬ì 1ë‹¨ê³„ í†µê³¼</button>
      <button class="ghost" id="openAdminEmailBtn" onclick="openAdminEmailModal()" disabled>2ë‹¨ê³„: ì´ë©”ì¼ ë¡œê·¸ì¸</button>
    </div>
    <div class="small" style="margin-top:8px;">
      * ê´€ë¦¬ì íŒ¨ë„ì€ <span class="kbd">ì½”ë“œ</span> í†µê³¼ í›„ <span class="kbd">ì´ë©”ì¼ ë§í¬ ë¡œê·¸ì¸</span>ê¹Œì§€ ì™„ë£Œë˜ì–´ì•¼ ì—´ë¦½ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ (2ë‹¨ê³„: ì´ë©”ì¼ ë§í¬) -->
  <div id="adminEmailModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeAdminEmailModal()">âœ•</button>
      <h2>ê´€ë¦¬ì 2ë‹¨ê³„ â€” ì´ë©”ì¼ ë§í¬ ë¡œê·¸ì¸</h2>
      <p class="small">
        ë“±ë¡ëœ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ <strong>ë§¤ì§ ë§í¬</strong>ë¥¼ ë³´ë‚´ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
        (ì˜ˆ: <span class="kbd">moast60@gmail.com</span>)
      </p>
      <input type="email" id="adminEmailInput" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ ì£¼ì†Œ">
      <div class="row" style="justify-content:center;">
        <button id="sendMagicLinkBtn">ë¡œê·¸ì¸ ë§í¬ ë³´ë‚´ê¸°</button>
        <button class="ghost" id="checkMagicLinkBtn">ë¡œê·¸ì¸ ì™„ë£Œ ì²´í¬</button>
      </div>
      <div id="adminEmailStatus" class="small" style="margin-top:10px; color:#cbd5e1;">ì¤€ë¹„ë¨</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:center;">
        <span class="chip">í˜„ì¬ ê´€ë¦¬ì ì´ë©”ì¼: <strong id="adminEmailCurrent">-</strong></span>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì í†µí•© íŒ¨ë„ (ë“œë˜ê·¸ ê°€ëŠ¥, í™”ë©´ ë°– ì´ë™ í—ˆìš©) -->
  <div id="adminPanelAll" class="admin-panel" style="display:none;">
    <div id="adminPanelHeader">
      âš™ï¸ ê´€ë¦¬ì í†µí•© íŒ¨ë„
      <span class="chip">ê´€ë¦¬ì: <strong id="adminWho">-</strong></span>
      <span class="chip">ì´ë©”ì¼ ì¸ì¦: <strong id="adminEmailOK">NO</strong></span>
      <span class="chip">ìì—°í‹±: <strong id="nlTickState">OFF</strong></span>
      <button class="xbtn" onclick="closeAdmin('adminPanelAll')">âœ•</button>
    </div>

    <div style="padding:12px;">
      <!-- íƒ­ ë²„íŠ¼ -->
      <div class="row" style="margin-bottom:12px;">
        <button onclick="showTab('graph')">ğŸ“Š ê·¸ë˜í”„</button>
        <button onclick="showTab('users')">ğŸ‘¥ ìœ ì €</button>
        <button onclick="showTab('finance')">ğŸ’³ ì…ì¶œê¸ˆ</button>
        <button onclick="showTab('stock')">ğŸ›ï¸ ì£¼ê°€ë³€ë™</button>
        <button onclick="showTab('change')">ğŸ“ˆ ë°°ìœ¨/í™•ë¥ </button>
        <button onclick="showTab('news')">ğŸ“° ë‰´ìŠ¤</button>
        <button onclick="showTab('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
        <button onclick="showTab('delist')">âš« ìƒì¥íì§€</button>
      </div>

      <!-- ê·¸ë˜í”„ -->
      <div id="tab-graph" class="tab-section">
        <h3>ğŸ“Š ê·¸ë˜í”„/ê¸ˆì•¡ ì œì–´ íŒ¨ë„</h3>

        <div class="req-card">
          <div class="row">
            <button onclick="marketStart()">ì¥ ì‹œì‘ + ì‹œì„¸ ì‹œì‘</button>
            <button onclick="marketEnd()">ì¥ ë§ˆê° + ì‹œì„¸ ì •ì§€</button>
            <button onclick="resetGraph()">ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
          </div>
          <div class="row">
            <label>ì „ì²´ ì¡°ì • Â±ê¸ˆì•¡</label>
            <input type="number" id="allDelta" value="100" style="width:120px;">
            <button onclick="adjustAllPrices()">ì ìš©</button>
          </div>
        </div>

        <div class="grid cols-3">
          <div class="req-card req-col">
            <strong>â±ï¸ ë³€ë™ ì£¼ê¸° (ì´ˆ)</strong>
            <div class="row">
              <input type="number" id="intervalInput" value="5" min="1" style="width:120px;">
              <button onclick="applyGraphInterval()">ì ìš©</button>
            </div>
            <div class="small">â€» ë“œë¼ì´ë²„(ê°±ì‹  ë‹´ë‹¹) ë¸Œë¼ìš°ì €ì—ì„œë§Œ íƒ€ì´ë¨¸ê°€ ëŒê³  ì „ì²´ì— ë™ê¸°í™”ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="req-card req-col">
            <strong>ğŸ“Š ë³€ë™í­ ìƒí•œ(Â±ì›)</strong>
            <div class="row">
              <input type="number" id="deltaMaxInput" value="1000000" min="1" style="width:140px;">
              <button onclick="applyDeltaMax()">ì ìš©</button>
            </div>
          </div>

          <!-- ìì—°í‹±/ìŠ¤ë¬´ë”© UI (JSëŠ” PART 4ì—ì„œ êµ¬í˜„) -->
          <div class="req-card req-col">
            <strong>ğŸŒ¿ ìì—°í‹± ì„¤ì •</strong>
            <div class="row">
              <label style="width:130px;">í‹± ëœë¤í™” (Â±ms)</label>
              <input type="number" id="tickJitterInput" value="500" min="0" step="50" style="width:140px;">
            </div>
            <div class="row">
              <label style="width:130px;">í‰í™œ(ìŠ¤ë¬´ë”©) ë‹¨ê³„</label>
              <input type="number" id="smoothingInput" value="2" min="0" max="10" step="1" style="width:140px;">
            </div>
            <div class="row">
              <label style="width:130px;">ë…¸ì´ì¦ˆ ê°•ë„(%)</label>
              <input type="number" id="noiseScaleInput" value="0.15" min="0" step="0.01" style="width:140px;">
            </div>
            <div class="row">
              <label style="width:130px;">ë“œë¦¬í”„íŠ¸(ìƒìŠ¹/í•˜ë½)</label>
              <input type="number" id="driftInput" value="0" step="0.01" style="width:140px;">
              <span class="small">(+ë©´ ìƒìŠ¹ ì ë¦¼, -ë©´ í•˜ë½ ì ë¦¼)</span>
            </div>
            <div class="row">
              <button id="applyNaturalTickBtn">ìì—°í‹± ì ìš©</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <h4>ğŸ“ˆ ê°œë³„ ì¢…ëª© ê¸ˆì•¡ ì¡°ì •</h4>
        <div id="graphCompanyAdjust"></div>
        <p class="small">â€» 'í˜„ì¬ê°€(livePrice)'ë¥¼ ì§ì ‘ ì¡°ì •í•©ë‹ˆë‹¤.</p>
      </div>

      <!-- ìœ ì € -->
      <div id="tab-users" class="tab-section" style="display:none;">
        <h3>ğŸ‘¥ ìœ ì € ìƒíƒœ íŒ¨ë„</h3>

        <div class="req-card">
          <div>
            <div><strong>ê´€ë¦¬ì ê¶Œí•œ ê´€ë¦¬</strong></div>
            <div class="small">ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬/í•´ì œ</div>
          </div>
          <div class="row">
            <input id="promoteIdInput" type="text" placeholder="ê³ ìœ ë²ˆí˜¸" style="width:160px;">
            <input id="promoteNameInput" type="text" placeholder="ì´ë¦„" style="width:160px;">
            <button onclick="promoteAdmin()">ê¶Œí•œ ë¶€ì—¬</button>
            <button onclick="demoteAdmin()">ê¶Œí•œ í•´ì œ</button>
          </div>
        </div>

        <div id="userList">ë¡œë“œ ì¤‘...</div>
      </div>

      <!-- ì…ì¶œê¸ˆ -->
      <div id="tab-finance" class="tab-section" style="display:none;">
        <h3>ğŸ’³ ì…/ì¶œê¸ˆ ìš”ì²­ íŒ¨ë„</h3>
        <h4>ì…ê¸ˆ ìš”ì²­</h4>
        <div id="depositRequests">ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ</div>
        <h4 style="margin-top:12px;">ì¶œê¸ˆ ìš”ì²­</h4>
        <div id="withdrawRequests">ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ</div>
      </div>

      <!-- ì£¼ê°€ë³€ë™ (ì¡°ì‘ UI ì—…ê·¸ë ˆì´ë“œ) -->
      <div id="tab-stock" class="tab-section" style="display:none;">
        <h3>ğŸ›ï¸ ì£¼ê°€ ë³€ë™ íŒ¨ë„</h3>

        <!-- ë¹ ë¥¸ ì¡°ì‘ ë°” -->
        <div class="req-card">
          <div><strong>ë¹ ë¥¸ ì¡°ì‘</strong></div>
          <div class="row">
            <label>ë‹¨ê³„(Â±ì›)</label>
            <input type="number" id="quickDeltaInput" value="10000" step="1000" style="width:140px;">
            <button onclick="setQuickPreset(-100000)">-10ë§Œ</button>
            <button onclick="setQuickPreset(-10000)">-1ë§Œ</button>
            <button onclick="setQuickPreset(10000)">+1ë§Œ</button>
            <button onclick="setQuickPreset(100000)">+10ë§Œ</button>
          </div>
        </div>

        <!-- ì „ì—­ í‹± íŒŒë¼ë¯¸í„° -->
        <div class="grid cols-3">
          <div class="req-card req-col">
            <strong>í‹± í¬ê¸°(%)</strong>
            <div class="row">
              <input type="number" id="tickStepInput" value="1.5" min="0" step="0.1" style="width:140px;">
              <button onclick="applyTickStep()">ì ìš©</button>
            </div>
            <div class="small">ê¸°ë³¸ ë³€ë™í­(%). ë°°ìœ¨ê³¼ ê²°í•©ë©ë‹ˆë‹¤.</div>
          </div>
          <div class="req-card req-col">
            <strong>ì‹œë‚˜ë¦¬ì˜¤</strong>
            <div class="row">
              <button onclick="runScenario('riseEnd')">ğŸ“ˆ ìƒìŠ¹ ìœ ë„</button>
              <button onclick="runScenario('fallEnd')">ğŸ“‰ í•˜ë½ ìœ ë„</button>
            </div>
            <div class="small">1ë¶„ê°„ ë°”ì´ì–´ìŠ¤ ê°•ì œ ì ìš©</div>
          </div>
          <div class="req-card req-col">
            <strong>ì¢…ëª©ë³„ ë¯¸ì„¸ì¡°ì •</strong>
            <div class="small">ì•„ë˜ í…Œì´ë¸”ì—ì„œ +/âˆ’ ë¡œ ë¯¸ì„¸ì¡°ì •</div>
          </div>
        </div>

        <!-- ì¢…ëª© í…Œì´ë¸”í˜• ë¯¸ì„¸ì¡°ì‘ -->
        <div class="req-card" style="overflow:auto;">
          <table class="table" id="stockTunerTable">
            <thead>
              <tr>
                <th>ì¢…ëª©</th>
                <th>í˜„ì¬ê°€</th>
                <th>Â±</th>
                <th>ë¯¸ì„¸ -</th>
                <th>ë¯¸ì„¸ +</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="stockTunerBody">
              <!-- JSë¡œ ì±„ì›€ -->
            </tbody>
          </table>
        </div>

        <!-- ê¸°ì¡´ ë²„íŠ¼í˜• ì»¨íŠ¸ë¡¤ ìœ ì§€ (í˜¸í™˜) -->
        <div id="stockTuner"></div>
      </div>

      <!-- ë°°ìœ¨/í™•ë¥  -->
      <div id="tab-change" class="tab-section" style="display:none;">
        <h3>ğŸ“ˆ ë°°ìœ¨ & í™•ë¥  ê´€ë¦¬ íŒ¨ë„</h3>
        <div class="grid cols-3">
          <div class="req-card req-col">
            <div class="row">
              <label>ì „ì²´ ì´ë“%</label>
              <input id="globalProfit" type="number" step="0.01" min="0" max="1" value="0.4" style="width:100px;">
            </div>
            <div class="row">
              <label>ì „ì²´ ì†í•´%</label>
              <input id="globalLoss" type="number" step="0.01" min="0" max="1" value="0.6" style="width:100px;">
            </div>
            <button onclick="setAllChances()">ì „ì²´ í™•ë¥  ì ìš©</button>
          </div>

          <div class="req-card req-col">
            <div class="row">
              <label>ì „ì²´ ë°°ìœ¨(ë³€ë™í­ ë°°ìˆ˜)</label>
              <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:120px;">
            </div>
            <button onclick="setAllMultipliers()">ì „ì²´ ë°°ìœ¨ ì ìš©</button>
          </div>

          <div class="req-card req-col">
            <div class="row">
              <label>ì „ì—­ ë³€ë™í­ (%)</label>
              <input id="volatilityInput" type="number" step="0.1" value="1.5" style="width:120px;">
            </div>
            <button onclick="applyVolatility()">ë³€ë™í­ ì ìš©</button>
          </div>
        </div>

        <div class="divider"></div>
        <div id="changePanel" style="margin-top:10px;"></div>
      </div>

      <!-- ë‰´ìŠ¤ -->
      <div id="tab-news" class="tab-section" style="display:none;">
        <h3>ğŸ“° ë‰´ìŠ¤ ê´€ë¦¬ íŒ¨ë„</h3>
        <div class="grid cols-2">
          <div class="req-card req-col">
            <input type="text" id="newsTitleInput" placeholder="ë‰´ìŠ¤ ì œëª©">
            <textarea id="newsBodyInput" placeholder="ë‰´ìŠ¤ ë‚´ìš©"></textarea>
            <div class="row">
              <button onclick="postNews()">ë“±ë¡</button>
            </div>
          </div>

          <div class="req-card req-col">
            <strong>ë“±ë¡ëœ ë‰´ìŠ¤</strong>
            <div id="newsList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <!-- ê³µì§€ì‚¬í•­ -->
      <div id="tab-notice" class="tab-section" style="display:none;">
        <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬ íŒ¨ë„</h3>
        <div class="grid cols-2">
          <div class="req-card req-col">
            <input type="text" id="noticeTitleInput" placeholder="ê³µì§€ ì œëª©">
            <textarea id="noticeBodyInput" placeholder="ê³µì§€ ë‚´ìš©"></textarea>
            <div class="row">
              <button onclick="postNotice()">ë“±ë¡</button>
            </div>
          </div>

          <div class="req-card req-col">
            <strong>ë“±ë¡ëœ ê³µì§€ì‚¬í•­</strong>
            <div id="noticeList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <!-- âœ… ìƒì¥íì§€ (íƒ€ì´ë¨¸ í¬í•¨ UI) -->
      <div id="tab-delist" class="tab-section" style="display:none;">
        <h3>âš« ìƒì¥íì§€ ê´€ë¦¬ íŒ¨ë„</h3>
        <p class="small">ìƒì¥íì§€ëœ ì¢…ëª©ì€ ê±°ë˜(ë§¤ìˆ˜/ë§¤ë„)ê°€ ë¶ˆê°€ëŠ¥í•˜ë©° ê°€ê²© ì‹œë®¬ë ˆì´ì…˜ì—ì„œë„ ì œì™¸ë©ë‹ˆë‹¤.</p>

        <!-- ë°°ì¹˜ ì‘ì—… -->
        <div class="req-card">
          <div class="row">
            <strong>ë°°ì¹˜ ì‘ì—…</strong>
            <button class="ghost" onclick="delistAllSelected()">ì„ íƒ ì¢…ëª© ìƒì¥íì§€</button>
            <button class="ghost" onclick="restoreAllSelected()">ì„ íƒ ì¢…ëª© ë³µêµ¬</button>
          </div>
          <div class="row">
            <span class="small">ì²´í¬ë°•ìŠ¤ëŠ” ì•„ë˜ í‘œì—ì„œ ì„ íƒ</span>
          </div>
        </div>

        <!-- ì˜ˆì•½ ìƒì¥íì§€ ì»¨íŠ¸ë¡¤ -->
        <div class="grid cols-2">
          <div class="req-card req-col">
            <strong>ì˜ˆì•½ ìƒì¥íì§€(ê°œë³„)</strong>
            <div class="small">ê° ì¢…ëª© í–‰ì˜ ì‹œê°„(ë¶„/ì´ˆ) ì…ë ¥ í›„ "ì˜ˆì•½" ë²„íŠ¼</div>
            <div id="delistPanel">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>

          <div class="req-card req-col">
            <strong>â³ ì˜ˆì•½ëœ ìƒì¥íì§€ ëª©ë¡</strong>
            <div class="small">ë‚¨ì€ ì‹œê°„ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
            <div id="delistScheduleList">í˜„ì¬ ì˜ˆì•½ ì—†ìŒ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì°¨íŠ¸) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PART 2~4ì—ì„œ JS ë¡œì§ ì£¼ì…: ì•„ë˜ ëª¨ë“ˆì— ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì±„ì›Œë„£ìŠµë‹ˆë‹¤. -->
  <script type="module">
    // ì´ ìœ„ì¹˜ì— PART 2 (Firebase ì´ˆê¸°í™”/ì„¸ì…˜), PART 3 (ë©”ì¸ ë¡œì§),
    // PART 4-1/4-2 (ê´€ë¦¬ì ê¸°ëŠ¥/ìì—°í‹±/ìƒì¥íì§€ íƒ€ì´ë¨¸/ì—…ê·¸ë ˆì´ë“œëœ ì¡°ì‘ UI) ìŠ¤í¬ë¦½íŠ¸ë¥¼
    // ìˆœì„œëŒ€ë¡œ ì±„ì›Œ ë„£ìŠµë‹ˆë‹¤.
  </script>
</body>
</html>

/* ===============================
   PART 2 : Firebase ì´ˆê¸°í™” & ì „ì—­ ìƒíƒœ
   =============================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  sendSignInLinkToEmail,
  signInWithEmailLink,
  isSignInWithEmailLink 
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot,
  query, orderBy, deleteDoc, writeBatch, increment
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* ===============================
   Firebase ì´ˆê¸°í™”
   =============================== */
const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===============================
   ì „ì—­ ìƒíƒœ ë³€ìˆ˜
   =============================== */
let chart = null;
let priceTimer = null;
let updateInterval = 5000;
let deltaMax = 1000000;
let marketOpenFlag = false;
let ADMIN_MODE = false;

let volatility = 1.5;
let lastChartTick = 0;

const marketState = { bias: {} };
const companyChances = {};

let player = { holdings:{}, cash:0 };
let currentUser = null;
let unsubscribeUser = null;
let unsubUsers = null;
let unsubDeposits = null;
let unsubWithdraws = null;
let unsubGlobals = null;
let unsubNews = null;
let unsubNotices = null;

let lastReadNewsAt = Number(localStorage.getItem('lastReadNewsAt') || 0);

// ë¡œì»¬ ì‹œë®¬ë ˆì´í„° ID (ë“œë¼ì´ë²„ íŒë³„)
const localSimId = (() => {
  let id = localStorage.getItem('simId');
  if(!id){
    id = 'sim-' + Math.random().toString(36).slice(2);
    localStorage.setItem('simId', id);
  }
  return id;
})();

// ê´€ë¦¬ì ì´ë©”ì¼ ì¸ì¦ ìƒíƒœ
let adminEmailAuthed = false;
let adminEmailAccount = null;

/* ===============================
   ìœ í‹¸ í•¨ìˆ˜
   =============================== */
const ci = s => String(s||"").toLowerCase();
const safeId = name => String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_');
const parseNumber = (str) => {
  const n = parseInt(String(str).replace(/[^0-9]/g,''), 10);
  return isNaN(n) ? 0 : Math.max(0, n);
};
const logDiv = document.getElementById("log");
const log = (msg) => { 
  if(!logDiv) return; 
  logDiv.innerHTML = "<div>" + msg + "</div>" + logDiv.innerHTML; 
};

/* ===============================
   íšŒì‚¬ ì´ˆê¸° ëª©ë¡
   =============================== */
const companies = [
  {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì¹´ìŠ¤í‹¸ë¡œ",   basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì‚¬ì¿ ë¼",     basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì²­ë£¡",       basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ê²½ì°°ì²­",     basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"Ems",        basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì˜¬ë“œë³´ì´",   basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì‘ë‘",       basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ë¹…ë”•",       basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ì°¨ì¹´ë‹ˆ",     basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"inback",     basePrice:10000000, multiplier:1, livePrice:10000000},
  {name:"ë¦¬ì–¼ì›”ë“œ ê´€ë¦¬ì", basePrice:10000000, multiplier:1, livePrice:10000000},
].map(c => ({...c, id: safeId(c.name), delisted:false}));

const findCompanyById = id => companies.find(x => ci(x.id)===ci(id) || ci(x.name)===ci(id));
const getDisplayPrice = (c) => Math.max(1, Math.floor(typeof c.livePrice==='number' ? c.livePrice : c.basePrice));

/* ===============================
   Firebase ì¸ì¦ (ìµëª… ë¡œê·¸ì¸ + ì´ë©”ì¼ ë§í¬ ë¡œê·¸ì¸ ì§€ì›)
   =============================== */

// ìµëª… ë¡œê·¸ì¸ ë³´ì¥
async function ensureAuth(){
  return new Promise(resolve=>{
    onAuthStateChanged(auth, (user)=>{
      if(user){ resolve(user); }
      else{
        signInAnonymously(auth).then(res=>resolve(res.user))
          .catch(e=>{ console.error('ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', e); resolve(null); });
      }
    });
  });
}

// ì´ë©”ì¼ ë§í¬ ì „ì†¡
async function sendMagicLink(email){
  const actionCodeSettings = {
    url: window.location.href,
    handleCodeInApp: true
  };
  try{
    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
    window.localStorage.setItem("adminEmailForSignIn", email);
    document.getElementById("adminEmailStatus").textContent = "ğŸ“§ ë¡œê·¸ì¸ ë§í¬ê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
  }catch(e){
    console.error("ì´ë©”ì¼ ë§í¬ ì „ì†¡ ì˜¤ë¥˜:", e);
    alert("ë¡œê·¸ì¸ ë§í¬ ì „ì†¡ ì‹¤íŒ¨: " + (e.message || e));
  }
}

// ì´ë©”ì¼ ë§í¬ ë¡œê·¸ì¸ ì²˜ë¦¬
async function checkMagicLink(){
  if(isSignInWithEmailLink(auth, window.location.href)){
    let email = window.localStorage.getItem("adminEmailForSignIn");
    if(!email){
      email = window.prompt("ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”");
    }
    try{
      const result = await signInWithEmailLink(auth, email, window.location.href);
      adminEmailAuthed = true;
      adminEmailAccount = result.user.email;
      document.getElementById("adminEmailStatus").textContent = "âœ… ì´ë©”ì¼ ë¡œê·¸ì¸ ì„±ê³µ: " + adminEmailAccount;
      document.getElementById("adminEmailCurrent").textContent = adminEmailAccount;
      document.getElementById("adminEmailOK").textContent = "YES";
    }catch(e){
      console.error("ì´ë©”ì¼ ë¡œê·¸ì¸ ì˜¤ë¥˜:", e);
      alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + (e.message || e));
    }
  }
}

/* ===============================
   ë¡œê·¸ì¸ ëª¨ë‹¬ ë™ì‘
   =============================== */
const loginBtn   = document.getElementById("startBtn");
const loginModal = document.getElementById("loginModal");
const userInfo   = document.getElementById("userInfo");

loginBtn.onclick = async () => {
  const cid   = document.getElementById("customId").value.trim();
  const cname = document.getElementById("customName").value.trim();
  if(!cid||!cname){ alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  try{
    await ensureAuth();
    const userRef = doc(db,"users",cid);
    const snap = await getDoc(userRef);
    if(snap.exists() && snap.data().active){
      alert("ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤. ê¸°ì¡´ ì„¸ì…˜ì„ ë¨¼ì € ì¢…ë£Œí•˜ì„¸ìš”.");
      return;
    }
    let nextCash=0; let nextHoldings={};
    if(snap.exists()){
      const d=snap.data();
      if(typeof d.cash==='number') nextCash=d.cash;
      if(d.holdings && typeof d.holdings==='object') nextHoldings=d.holdings;
    }
    currentUser = { id:cid, name:cname, cash:nextCash, active:true };
    player.cash=nextCash; player.holdings=nextHoldings;

    await setDoc(userRef,{ ...currentUser, holdings:nextHoldings, lastLoginAt:Date.now(), active:true },{merge:true});
    localStorage.setItem("stockUser", JSON.stringify({ id:cid, name:cname }));

    loginModal.style.display='none';
    renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid); renderMarketStatus();
  }catch(e){
    console.error("âš ï¸ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
    alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || e));
  }
};

function renderUserInfo(){
  if(currentUser){
    userInfo.innerHTML = `
      ğŸ‘¤ <strong>${currentUser.name}</strong> (${currentUser.id})
      &nbsp;&nbsp;|&nbsp;&nbsp; ğŸ’µ ë³´ìœ í˜„ê¸ˆ: <strong>${(player.cash||0).toLocaleString()} KRW</strong>
    `;
  }else{
    userInfo.textContent="â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...";
  }
}

/* ===============================
   PART 3 : ê±°ë˜ / ì°¨íŠ¸ / ì‹œì„¸ ì—…ë°ì´íŠ¸
   =============================== */

/* ===== ê±°ë˜ ê´€ë ¨ ===== */
function impactPrice(name, qty, mode){
  const c = findCompanyById(name);
  if(!c) return;
  const size = Math.max(1, qty);
  const step = Math.min(0.1, size / 10000);
  const sign = (mode === 'buy') ? -1 : +1;
  const next = (marketState.bias[c.id] || 0) + sign * step;
  marketState.bias[c.id] = Math.max(-1, Math.min(1, next));
}

async function buy(name, qty){
  const c = findCompanyById(name); if(!c) return;
  if(c.delisted) return alert('â›” ìƒì¥íì§€ ì¢…ëª©ì€ ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(!marketOpenFlag) return alert('â›” ì¥ ë§ˆê° ì¤‘');
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const p = getDisplayPrice(c);
  const total = p*qty;
  if(player.cash < total) return alert('í˜„ê¸ˆ ë¶€ì¡±');

  player.cash -= total;
  player.holdings[c.name] = (player.holdings[c.name]||0) + qty;

  try{
    await setDoc(doc(db,"users",currentUser.id),{
      cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
    },{merge:true});
    log(`ğŸŸ¢ <strong>ë§¤ìˆ˜ì²´ê²°:</strong> [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = <strong>${total.toLocaleString()}</strong>`);
  }catch(e){
    console.error("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨:", e);
    alert("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨: " + (e.message || e));
  }

  renderUserInfo(); updateHoldingsUI();
  impactPrice(c.id, qty, 'buy');
}

async function sell(name, qty){
  const c = findCompanyById(name); if(!c) return;
  if(c.delisted) return alert('â›” ìƒì¥íì§€ ì¢…ëª©ì€ ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(!marketOpenFlag) return alert('â›” ì¥ ë§ˆê° ì¤‘');
  if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
  const p = getDisplayPrice(c);
  if((player.holdings[c.name]||0) < qty) return alert('ë³´ìœ  ë¶€ì¡±');

  const total = p*qty;
  player.cash += total;
  player.holdings[c.name] -= qty;

  try{
    await setDoc(doc(db,"users",currentUser.id),{
      cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
    },{merge:true});
    log(`ğŸ”´ <strong>ë§¤ë„ì²´ê²°:</strong> [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = <strong>${total.toLocaleString()}</strong>`);
  }catch(e){
    console.error("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨:", e);
    alert("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨: " + (e.message || e));
  }

  renderUserInfo(); updateHoldingsUI();
  impactPrice(c.id, qty, 'sell');
}

/* ===== ì¥ ì‹œì‘/ë§ˆê° ===== */
async function marketOpen(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  marketOpenFlag = true;
  try{
    await setDoc(doc(db,"marketState","main"), {
      isOpen:true, interval:updateInterval, driverId: localSimId, updatedAt: Date.now()
    }, { merge:true });
  }catch(e){ console.warn(e); }
  renderMarketStatus();
  await updatePrices();
  startLocalTimer();
  alert("âœ… ì¥ ì‹œì‘");
}

async function marketClose(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  marketOpenFlag = false;
  try{
    await setDoc(doc(db,"marketState","main"), { isOpen:false, updatedAt: Date.now() }, { merge:true });
  }catch(e){ console.warn(e); }
  stopLocalTimer();
  renderMarketStatus();
  alert("ğŸ“‰ ì¥ ë§ˆê°");
}

function startLocalTimer(){
  if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
  priceTimer = setInterval(()=>{ updatePrices().catch(()=>{}); }, updateInterval);
}
function stopLocalTimer(){
  if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
}

/* ===== ì‹œì„¸ ì—…ë°ì´íŠ¸ ===== */
async function updatePrices(){
  if(!marketOpenFlag) return;
  const tickAt = Date.now();
  const batch = writeBatch(db);

  for(const c of companies){
    // ìƒì¥íì§€ ì œì™¸
    if(c.delisted) continue;

    const prev = c.livePrice || c.basePrice;
    const chance = companyChances[c.id] || {profit:0.4, loss:0.6};
    const denom = Math.max(1e-6, (chance.profit + chance.loss));
    let isUp = Math.random() < (chance.profit / denom);

    const b = marketState.bias[c.id] || 0;
    if(b === -1) isUp = true;
    if(b ===  1) isUp = false;
    marketState.bias[c.id] = b * 0.5;

    const stepPct = (Math.random() * volatility / 100) * Math.max(0, c.multiplier || 1);
    const signed = isUp ? stepPct : -stepPct;
    let nextRaw = prev * (1 + signed);

    const diff = nextRaw - prev;
    if(Math.abs(diff) > deltaMax){ nextRaw = prev + Math.sign(diff) * deltaMax; }

    const next = Math.max(1, Math.round(nextRaw));

    c.livePrice = next;
    batch.set(doc(db,"companyPrices", c.id), { current: next, updatedAt: tickAt }, { merge:true });
  }
  try{
    await batch.commit();
    await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt, driverId: localSimId }, { merge:true });
  }catch(e){ console.error("ì‹œë®¬ë ˆì´ì…˜ ë°˜ì˜ ì‹¤íŒ¨:", e); }
}

/* ===== ì°¨íŠ¸ ===== */
function initChart(){
  if(chart) return;
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type:"line",
    data:{
      labels:[],
      datasets: companies.map(c => ({ label:c.name, data:[], borderWidth:2, fill:false, tension:0.25 }))
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{position:"bottom"} },
      scales:{ x:{ title:{display:true, text:"ì‹œê°„"} }, y:{ title:{display:true, text:"ê°€ê²© (KRW)"}, beginAtZero:false } }
    }
  });
}

function appendChartPoint(tickMs){
  if(!chart) return;
  const label = new Date(tickMs||Date.now()).toLocaleTimeString();
  chart.data.labels.push(label);
  companies.forEach((c,i)=>{ chart.data.datasets[i].data.push(getDisplayPrice(c)); });
  const MAX=120;
  if(chart.data.labels.length>MAX){
    chart.data.labels.splice(0, chart.data.labels.length-MAX);
    chart.data.datasets.forEach(d=>{ if(d.data.length>MAX) d.data.splice(0, d.data.length-MAX); });
  }
  chart.update("none");
}

/* ===== ì…ì¶œê¸ˆ ===== */
async function requestDeposit(){
  const id   = currentUser?.id || "";
  const name = currentUser?.name || "";
  const account = document.getElementById("acctNo").value.trim();
  const amount  = parseNumber(document.getElementById("cashAmount").value);
  const memo    = document.getElementById("cashMemo").value.trim();
  if(!id || !name || !account || amount<=0){
    alert("âš ï¸ ê³„ì¢Œë²ˆí˜¸ì™€ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  try{
    await addDoc(collection(db,"depositRequests"),{
      userId:id, userName:name, account, amount, memo, status:"pending", createdAt: Date.now()
    });
    alert("ğŸ’° " + amount.toLocaleString() + " KRW ì…ê¸ˆ ìš”ì²­ ì™„ë£Œ");
    log("<strong>ğŸ’° ì…ê¸ˆìš”ì²­:</strong> " + amount.toLocaleString() + " KRW (" + account + ")");
    document.getElementById("cashAmount").value="";
    document.getElementById("cashMemo").value="";
    document.getElementById("acctNo").value="";
  }catch(e){
    console.error("ì…ê¸ˆ ìš”ì²­ ì‹¤íŒ¨:", e);
    alert("ì…ê¸ˆ ìš”ì²­ ì˜¤ë¥˜: " + (e.message || e));
  }
}

function openWithdrawModal(){ document.getElementById('withdrawModal').style.display='flex'; }
function closeWithdrawModal(){ document.getElementById('withdrawModal').style.display='none'; }

function updateWithdrawFee(){
  const amount = parseNumber(document.getElementById('withdrawAmount').value);
  const fee = Math.floor(amount * 0.20);
  const info = document.getElementById('withdrawFeeInfo');
  if(amount>0) info.textContent = "ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: " + fee.toLocaleString() + " KRW (ì‹¤ì§€ê¸‰: " + Math.max(0,(amount-fee)).toLocaleString() + " KRW)";
  else info.textContent = "";
}

async function submitWithdraw(){
  const id     = document.getElementById('withdrawId').value.trim();
  const name   = document.getElementById('withdrawName').value.trim();
  const amount = parseNumber(document.getElementById('withdrawAmount').value);
  const account= document.getElementById('withdrawAccount').value.trim();

  if(!id || !name || amount<=0 || !account){
    alert('âš ï¸ ê³ ìœ ë²ˆí˜¸, ì´ë¦„, ê¸ˆì•¡, ê³„ì¢Œë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try{
    await addDoc(collection(db,'withdrawRequests'), {
      userId:id, userName:name, amount, account, status:'pending', createdAt: Date.now()
    });
    alert('ğŸ“¤ ì¶œê¸ˆ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
    const fee = Math.floor(amount*0.1);
    log(`<strong>ğŸ“¤ ì¶œê¸ˆìš”ì²­:</strong> ${amount.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(amount-fee).toLocaleString()})`);
    closeWithdrawModal();
  }catch(e){
    console.error('ì¶œê¸ˆ ìš”ì²­ ì‹¤íŒ¨:', e);
    alert('ì¶œê¸ˆ ìš”ì²­ ì˜¤ë¥˜: ' + (e.message || e));
  }
}

    /* ===============================
   PART 4-1 : ê´€ë¦¬ì ê¸°ëŠ¥ (ë¡œê·¸ì¸ + ê¸°ë³¸ ì œì–´)
   =============================== */

/* ===== ê´€ë¦¬ì 2ë‹¨ê³„ ë¡œê·¸ì¸ ===== */
async function checkAdmin(){
  const code = document.getElementById('adminCode').value.trim();
  if(code !== 'ADBEN7732'){   // 1ë‹¨ê³„: ê´€ë¦¬ì ì½”ë“œ
    alert('âŒ ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.');
    document.getElementById('adminCode').value = '';
    return;
  }

  // 2ë‹¨ê³„: ê´€ë¦¬ì ì´ë©”ì¼ ë¡œê·¸ì¸ í™•ì¸
  const adminEmail = "moast60@gmail.com";
  if(!adminEmailAuthed || adminEmailAccount !== adminEmail){
    alert("ğŸ“§ ì´ë©”ì¼ ë¡œê·¸ì¸ í•„ìš”: " + adminEmail);
    sendMagicLink(adminEmail); // ì´ë©”ì¼ ë§í¬ ë°œì†¡
    return;
  }

  ADMIN_MODE = true;

  const panel = document.getElementById('adminPanelAll');
  if(panel) panel.style.display='block';

  showTab('stock');
  renderGraphAdjustPanel();
  renderChangePanel();
  renderDelistPanel();

  document.getElementById('adminCode').value = '';
  alert("âœ… ê´€ë¦¬ì íŒ¨ë„ ì˜¤í”ˆ: " + adminEmailAccount);
}

function closeAdmin(id){
  const el=document.getElementById(id);
  if(el) el.style.display='none';
  if(id==='adminPanelAll'){
    if(unsubUsers){ try{unsubUsers();}catch(e){} unsubUsers=null; }
    if(unsubDeposits){ try{unsubDeposits();}catch(e){} unsubDeposits=null; }
    if(unsubWithdraws){ try{unsubWithdraws();}catch(e){} unsubWithdraws=null; }
  }
}

/* ===== ê·¸ë˜í”„/ê°€ê²© ê´€ë¦¬ ===== */
function renderGraphAdjustPanel(){
  const wrap = document.getElementById("graphCompanyAdjust"); 
  if(!wrap) return;
  let html="";
  companies.forEach(c=>{
    const id = "adj-" + c.id;
    html += `
      <div class='req-card'>
        <div><strong>${c.name}</strong> | í˜„ì¬ê°€:
          <span id='panel-price-${c.id}'>${getDisplayPrice(c).toLocaleString()}</span> KRW
          ${c.delisted ? "<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>" : ""}
        </div>
        <div style='display:flex; gap:8px; align-items:center;'>
          <input type='number' id='${id}' placeholder='Â±ê¸ˆì•¡' style='width:100px;' ${c.delisted?'disabled':''}>
          <button ${c.delisted?'disabled':''} onclick="adjustCompanyPrice('${c.name}')">ì ìš©</button>
        </div>
      </div>`;
  });
  wrap.innerHTML = html || "íšŒì‚¬ ë°ì´í„° ì—†ìŒ";
}

async function adjustCompanyPrice(name, overrideDelta=null){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c = findCompanyById(name); if(!c) return;
  if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª©ì€ ê°€ê²© ì¡°ì • ë¶ˆê°€");
  const inputEl = document.getElementById("adj-" + c.id);
  const delta = (overrideDelta!==null && !isNaN(overrideDelta)) ? Number(overrideDelta) : (parseInt(inputEl && inputEl.value) || 0);
  const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
  await setDoc(doc(db,"companyPrices", c.id), { current:newVal, updatedAt: Date.now() }, { merge:true });
  c.livePrice=newVal;
  const p = document.getElementById("panel-price-" + c.id);
  if(p) p.textContent=getDisplayPrice(c).toLocaleString();
  const el = document.getElementById("price-" + c.id);
  if(el) el.textContent=getDisplayPrice(c).toLocaleString();
  updateMaxBuyUI();
}

async function adjustAllPrices(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const delta = parseInt(document.getElementById("allDelta").value) || 0;
  const tickAt = Date.now();
  const batch = writeBatch(db);
  for(const c of companies){
    if(c.delisted) continue; // ìƒì¥íì§€ ì œì™¸
    const newVal = Math.max(1,(c.livePrice||c.basePrice)+delta);
    c.livePrice = newVal;
    batch.set(doc(db,"companyPrices", c.id), { current:newVal, updatedAt: tickAt }, { merge:true });
  }
  await batch.commit();
  await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
  updateMaxBuyUI();
}

function applyDeltaMax(){
  const val = parseInt(document.getElementById("deltaMaxInput").value) || 1;
  deltaMax = Math.max(1, val);
  alert("âœ… 1í‹± ìƒí•œ(Â±ì›) ì ìš©: " + deltaMax.toLocaleString());
}

function applyGraphInterval(){
  const sec = parseInt(document.getElementById("intervalInput").value) || 5;
  updateInterval = Math.max(1, sec) * 1000;
  setDoc(doc(db,"marketState","main"), { interval:updateInterval, updatedAt:Date.now() }, { merge:true })
    .then(()=>{
      if(ADMIN_MODE){ if(priceTimer){ clearInterval(priceTimer); } if(marketOpenFlag) startLocalTimer(); }
      alert("âœ… ë³€ë™ì£¼ê¸° ì ìš©ë¨: " + sec + "ì´ˆ");
    })
    .catch(e=>console.error("ë³€ë™ì£¼ê¸° ì €ì¥ ì‹¤íŒ¨:", e));
}

async function resetGraph(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const tickAt = Date.now();
  const batch = writeBatch(db);
  for(const c of companies){
    if(c.delisted) continue;
    c.livePrice=c.basePrice;
    batch.set(doc(db,"companyPrices", c.id), { current: c.basePrice, updatedAt: tickAt }, { merge:true });
  }
  await batch.commit();
  await setDoc(doc(db,"marketState","main"), { lastTickAt: tickAt }, { merge:true });
  if(chart){
    chart.data.labels = [];
    chart.data.datasets.forEach(d=> d.data = []);
    chart.update();
    lastChartTick = 0;
  }
  updateMaxBuyUI();
}

/* ===== ë°°ìœ¨/í™•ë¥  ===== */
function renderChangePanel(){
  const host = document.getElementById('changePanel'); if(!host) return;
  let html = "";
  companies.forEach(c=>{
    const ch = companyChances[c.id] || {profit:0.4, loss:0.6};
    html += `
      <div class="req-card">
        <div style="min-width:220px;">
          <div><strong>${c.name}</strong> ${c.delisted ? "<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>" : ""}</div>
          <div style="font-size:12px;color:#9ca3af;">ë°°ìœ¨: <strong id="mult-${c.id}">${Number(c.multiplier||1)}</strong> | í™•ë¥ : â†‘${(ch.profit*100).toFixed(1)}% / â†“${(ch.loss*100).toFixed(1)}%</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input type="number" id="inp-mul-${c.id}" step="0.1" value="${Number(c.multiplier||1)}" style="width:90px;" ${c.delisted?'disabled':''}>
          <button ${c.delisted?'disabled':''} onclick="applyMultiplier('${c.name}')">ë°°ìœ¨ì ìš©</button>
          <span style="width:8px"></span>
          <input type="number" id="inp-up-${c.id}" step="0.01" min="0" max="1" value="${ch.profit}" style="width:90px;" ${c.delisted?'disabled':''}>
          <input type="number" id="inp-down-${c.id}" step="0.01" min="0" max="1" value="${ch.loss}" style="width:90px;" ${c.delisted?'disabled':''}>
          <button ${c.delisted?'disabled':''} onclick="applyCompanyChance('${c.name}')">í™•ë¥ ì ìš©</button>
        </div>
      </div>
    `;
  });
  host.innerHTML = html || "ì¢…ëª© ì—†ìŒ";
}

async function applyMultiplier(name){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c = findCompanyById(name); if(!c) return;
  if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª©ì€ ìˆ˜ì • ë¶ˆê°€");
  const el = document.getElementById("inp-mul-" + c.id);
  const val = Number(el?.value||1);
  const m = isNaN(val) ? 1 : Math.max(0, val);
  await setDoc(doc(db,'companySettings', c.id), { multiplier:m, updatedAt:Date.now() }, { merge:true });
  c.multiplier = m;
  const out = document.getElementById("mult-" + c.id);
  if(out) out.textContent = String(m);
  alert(`âœ… ${c.name} ë°°ìœ¨ ${m} ì ìš©`);
}

async function applyCompanyChance(name){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c = findCompanyById(name); if(!c) return;
  if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª©ì€ ìˆ˜ì • ë¶ˆê°€");
  const upEl = document.getElementById("inp-up-" + c.id);
  const dnEl = document.getElementById("inp-down-" + c.id);
  let up = Number(upEl?.value||0.4);
  let dn = Number(dnEl?.value||0.6);
  if(up<0||dn<0 || (up+dn)<=0){ return alert("0~1 ë²”ìœ„, í•©ê³„>0 ì´ì–´ì•¼ í•©ë‹ˆë‹¤."); }
  await setDoc(doc(db,'companyChances', c.id), { profit:up, loss:dn, updatedAt:Date.now() }, { merge:true });
  companyChances[c.id] = { profit:up, loss:dn };
  renderChangePanel();
  alert(`âœ… ${c.name} í™•ë¥  ì ìš© (â†‘${(up*100).toFixed(1)}% / â†“${(dn*100).toFixed(1)}%)`);
}

    /* ===============================
   PART 4-2 : ê´€ë¦¬ì ê¸°ëŠ¥ (ì‹¬í™”)
   =============================== */

/* ===== ì£¼ê°€ ì¡°ì‘ (í‹± ë‹¨ìœ„ ì´ë™) ===== */
function renderStockTuner(){
  const host = document.getElementById('stockTuner'); if(!host) return;
  let html = "";
  companies.forEach(c=>{
    const disabled = c.delisted ? "disabled" : "";
    html += `
      <div class='req-card'>
        <div><strong>${c.name}</strong> | ${getDisplayPrice(c).toLocaleString()} KRW ${c.delisted ? "<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>" : ""}</div>
        <div style='display:flex; gap:6px;'>
          <button ${disabled} onclick="applyStockTarget('${c.name}', -100000)">-10ë§Œ</button>
          <button ${disabled} onclick="applyStockTarget('${c.name}', -10000)">-1ë§Œ</button>
          <button ${disabled} onclick="applyStockTarget('${c.name}', 10000)">+1ë§Œ</button>
          <button ${disabled} onclick="applyStockTarget('${c.name}', 100000)">+10ë§Œ</button>
        </div>
      </div>`;
  });
  host.innerHTML = html;
}

async function applyStockTarget(name, delta){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c=findCompanyById(name); if(!c) return;
  if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª©ì€ ì¡°ì • ë¶ˆê°€");
  await adjustCompanyPrice(c.name, delta);
}

/* ===== ì‹œë‚˜ë¦¬ì˜¤ (ìƒìŠ¹ ì¢…ë£Œ / í•˜ë½ ì¢…ë£Œ) ===== */
function runScenario(type){ applyScenario(type); }
function applyScenario(type){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const force = (type==='riseEnd') ? -1 : 1;
  companies.forEach(c=>{ if(!c.delisted) marketState.bias[c.id] = force; });
  alert(type==='riseEnd' ? "ğŸ“ˆ ë‹¨ê¸° ìƒìŠ¹ ìœ ë„ ì‹œì‘" : "ğŸ“‰ ë‹¨ê¸° í•˜ë½ ìœ ë„ ì‹œì‘");
  // 1ë¶„ í›„ ìë™ ì´ˆê¸°í™”
  setTimeout(()=>{ companies.forEach(c=>{ marketState.bias[c.id] = 0; }); }, 60000);
}

/* ===== ìƒì¥íì§€ ê´€ë¦¬ + íƒ€ì´ë¨¸ ===== */
function renderDelistPanel(){
  const host = document.getElementById("delistPanel"); if(!host) return;
  let html = "";
  companies.forEach(c=>{
    const isDelisted = !!c.delisted;
    html += `
      <div class="req-card">
        <div>
          <strong>${c.name}</strong>
          <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">${isDelisted?'âš« ìƒì¥íì§€':'ğŸŸ¢ ìƒì¥'}</span>
          <div style="font-size:12px;color:#9ca3af;margin-top:4px;">í˜„ì¬ê°€: ${getDisplayPrice(c).toLocaleString()} KRW</div>
        </div>
        <div style="display:flex; gap:8px;">
          ${isDelisted
            ? `<button onclick="restoreCompany('${c.name}')">ë³µêµ¬</button>`
            : `<button onclick="delistCompany('${c.name}')" style="background:#7f1d1d;">ìƒì¥íì§€</button>
               <input type="number" id="timer-${c.id}" placeholder="ì´ˆ" style="width:80px;">
               <button onclick="delistWithTimer('${c.name}')">íƒ€ì´ë¨¸</button>`}
        </div>
      </div>`;
  });
  host.innerHTML = html || "ê¸°ì—… ì—†ìŒ";
}

async function delistCompany(name){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c = findCompanyById(name); if(!c) return;
  await setDoc(doc(db,"companySettings",c.id), { delisted:true, updatedAt:Date.now() }, { merge:true });
  c.delisted = true;
  alert(`âš« ${c.name} ìƒì¥íì§€ ì™„ë£Œ`);
  renderDelistPanel(); renderChangePanel(); renderStockTuner(); renderGraphAdjustPanel();
  renderMarketStatus(); initCompaniesUI();
}

async function restoreCompany(name){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const c = findCompanyById(name); if(!c) return;
  await setDoc(doc(db,"companySettings",c.id), { delisted:false, updatedAt:Date.now() }, { merge:true });
  c.delisted = false;
  alert(`ğŸŸ¢ ${c.name} ë³µêµ¬ ì™„ë£Œ`);
  renderDelistPanel(); renderChangePanel(); renderStockTuner(); renderGraphAdjustPanel();
  renderMarketStatus(); initCompaniesUI();
}

// íƒ€ì´ë¨¸ë¡œ ìƒì¥íì§€
function delistWithTimer(name){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const sec = parseInt(document.getElementById("timer-"+safeId(name))?.value) || 0;
  if(sec<=0) return alert("íƒ€ì´ë¨¸ ì´ˆë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  alert(`â±ï¸ ${sec}ì´ˆ í›„ ${name} ìƒì¥íì§€ ì˜ˆì •`);
  setTimeout(()=>{ delistCompany(name); }, sec*1000);
}

/* ===== ìœ ì €/ì…ì¶œê¸ˆ íŒ¨ë„ ===== */
function renderUserList(startListen=false){
  const box = document.getElementById('userList'); if(!box) return;
  box.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  if(startListen){
    if(unsubUsers){ try{unsubUsers();}catch(e){} unsubUsers=null; }
    unsubUsers = onSnapshot(collection(db,"users"), (snap)=>{
      let html = "";
      snap.forEach(docu=>{
        const u = docu.data();
        const hold = u.holdings || {};
        const holdTxt = Object.entries(hold).map(([k,v])=>`${k}:${v}`).join(', ') || 'ë³´ìœ  ì—†ìŒ';
        html += `
          <div class="req-card">
            <div>
              <div><strong>${u.name||'-'}</strong> (${docu.id}) ${u.active?'ğŸŸ¢':'ğŸ”´'} ${u.isAdmin ? ' <span style="color:#10b981;">ê´€ë¦¬ìğŸ›¡ï¸</span>' : ''}</div>
              <div>í˜„ê¸ˆ: ${Number(u.cash||0).toLocaleString()} KRW</div>
              <div>ë³´ìœ : ${holdTxt}</div>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <button onclick="forceLogout('${docu.id}')">ê°•ì œ ë¡œê·¸ì•„ì›ƒ</button>
              ${u.isAdmin
                ? `<button onclick="demoteAdmin('${docu.id}')">ê¶Œí•œ í•´ì œ</button>`
                : `<button onclick="promoteAdmin('${docu.id}','${(u.name||'').replace(/'/g,"\\'")}')">ê¶Œí•œ ë¶€ì—¬</button>`}
            </div>
          </div>
        `;
      });
      box.innerHTML = html || "ìœ ì € ì—†ìŒ";
    });
  }
}

function renderFinanceQueues(startListen=false){
  const d = document.getElementById('depositRequests');
  const w = document.getElementById('withdrawRequests');
  if(d) d.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  if(w) w.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

  if(startListen){
    if(unsubDeposits){ try{unsubDeposits();}catch(e){} unsubDeposits=null; }
    if(unsubWithdraws){ try{unsubWithdraws();}catch(e){} unsubWithdraws=null; }

    unsubDeposits = onSnapshot(collection(db,"depositRequests"), (snap)=>{
      let html="";
      snap.forEach(docu=>{
        const r=docu.data();
        if(r.status!=='pending') return;
        html += `
          <div class="req-card" id="dep-${docu.id}">
            <div>
              <div><strong>${r.userName}</strong> (${r.userId})</div>
              <div>ê³„ì¢Œ: ${r.account}</div>
              <div>ê¸ˆì•¡: ${Number(r.amount||0).toLocaleString()} KRW</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button onclick="approveDeposit('${docu.id}', ${Number(r.amount||0)}, '${r.userId}')">ìŠ¹ì¸</button>
              <button onclick="rejectDeposit('${docu.id}')">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      if(d) d.innerHTML = html || "ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ";
    });

    unsubWithdraws = onSnapshot(collection(db,"withdrawRequests"), (snap)=>{
      let html="";
      snap.forEach(docu=>{
        const r=docu.data();
        if(r.status!=='pending') return;
        const fee = Math.floor((r.amount||0)*0.1);
        html += `
          <div class="req-card" id="wd-${docu.id}">
            <div>
              <div><strong>${r.userName}</strong> (${r.userId})</div>
              <div>ìš”ì²­ì•¡: ${Number(r.amount||0).toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(Math.max(0,(r.amount||0)-fee)).toLocaleString()})</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button onclick="approveWithdraw('${docu.id}', ${Number(r.amount||0)}, '${r.userId}')">ìŠ¹ì¸</button>
              <button onclick="rejectWithdraw('${docu.id}')">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      if(w) w.innerHTML = html || "ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ";
    });
  }
}

/* ===== ë‰´ìŠ¤ ê´€ë¦¬ ===== */
async function postNews(){
  const titleEl = document.getElementById('newsTitleInput');
  const bodyEl  = document.getElementById('newsBodyInput');
  const title = (titleEl?.value||'').trim();
  const content = (bodyEl?.value||'').trim();
  if(!title || !content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  try{
    await addDoc(collection(db,'news'), {
      title, content,
      createdAt: Date.now(),
      authorId: currentUser?.id || 'admin',
      authorName: currentUser?.name || 'ê´€ë¦¬ì',
      visible: true
    });
    if(titleEl) titleEl.value='';
    if(bodyEl) bodyEl.value='';
    alert('ğŸ“° ë‰´ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){
    console.error(e);
    alert('ë‰´ìŠ¤ ë“±ë¡ ì˜¤ë¥˜: ' + (e.message || e));
  }
}

async function deleteNews(id){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try{
    await deleteDoc(doc(db,'news',id));
  }catch(e){
    console.error(e);
    alert('ì‚­ì œ ì˜¤ë¥˜: ' + (e.message || e));
  }
}

/* ===== ê³µì§€ ê´€ë¦¬ ===== */
async function postNotice(){
  const titleEl=document.getElementById('noticeTitleInput');
  const bodyEl=document.getElementById('noticeBodyInput');
  const title=(titleEl?.value||'').trim();
  const content=(bodyEl?.value||'').trim();
  if(!title||!content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  try{
    await addDoc(collection(db,'notices'),{
      title, content,
      createdAt:Date.now(),
      authorId: currentUser?.id||'admin',
      authorName: currentUser?.name||'ê´€ë¦¬ì'
    });
    if(titleEl) titleEl.value='';
    if(bodyEl) bodyEl.value='';
    alert('ğŸ“¢ ê³µì§€ì‚¬í•­ ë“±ë¡ ì™„ë£Œ');
  }catch(e){
    console.error(e);
    alert('ê³µì§€ì‚¬í•­ ë“±ë¡ ì‹¤íŒ¨: ' + (e.message || e));
  }
}

async function deleteNotice(id){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try{
    await deleteDoc(doc(db,'notices',id));
  }catch(e){
    console.error(e);
    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (e.message || e));
  }
}

    </script>
</body>
</html>
