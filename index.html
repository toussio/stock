<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userInfo,#depositSection,#log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.company div { flex:1; }
button { padding:5px 10px; cursor:pointer; margin-top:4px; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }

/* 관리자 모달 */
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModalContent { background:#1f2937; padding:20px; border-radius:10px; width:400px; max-height:80%; overflow:auto; position:relative; }
#adminModalContent h2 { margin-top:0; }
.requestBox { margin-bottom:10px; padding:10px; background:#111827; border-radius:6px; }
#adminModalContent .closeBtn { position:absolute; top:10px; right:10px; background:none; border:none; color:#e5e7eb; font-size:18px; cursor:pointer; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<div id="userInfo"></div>
<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="계좌번호 입력">
  <input type="number" id="depositAmount" placeholder="금액 입력">
  <button id="depositBtn">추가 요청</button>
</div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>거래 시작 전 정보 입력</h2>
    <input type="text" id="userId" placeholder="고유번호 입력" /><br>
    <input type="text" id="userName" placeholder="이름 입력" /><br>
    <button id="startBtn">시작</button>
  </div>
</div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력">
  <button onclick="checkAdminCode()">실행</button>
</div>

<!-- 관리자 요청 모달 -->
<div id="adminModal">
  <div id="adminModalContent">
    <button class="closeBtn" onclick="closeAdminModal()">✖</button>
    <h2>입금 요청 관리</h2>
    <div id="requestsList"></div>
    <hr>
    <h3>관리자 명령어</h3>
    <input type="text" id="adminCommand" placeholder="예: start / stop / speed 2000 / range 2">
    <button onclick="runAdminCommand()">명령 실행</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

let companies = [
  { name:"떡잎방범대", price:10000000, basePrice:10000000, history:[10000000] },
  { name:"카스틸로", price:500, basePrice:500, history:[500] },
  { name:"사쿠라", price:500, basePrice:500, history:[500] },
  { name:"청룡", price:500, basePrice:500, history:[500] },
  { name:"경찰청", price:500, basePrice:500, history:[500] },
  { name:"EMS", price:500, basePrice:500, history:[500] },
  { name:"올드보이", price:500, basePrice:500, history:[500] },
  { name:"작두", price:800, basePrice:800, history:[800] }
];

// 🔥 자동 그래프 제어 변수
let autoInterval = null;
let updateSpeed = 3000;   // 기본 3초
let changeRange = 0.05;   // 기본 ±5%

// ... [기존 로그인/입금/매수매도/렌더링 함수 동일] ...

function updateChart(){
  if(!chart) return;
  const maxLen = Math.max(...companies.map(c => c.history.length));
  chart.data.labels = Array.from({length:maxLen},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

// 🔑 관리자 코드 실행
window.checkAdminCode = async function(){
  const code = document.getElementById("adminCode").value.trim().toUpperCase();

  if(code === "ADMIN123"){
    loadDepositRequests();
    document.getElementById("adminModal").style.display="flex";
  }
  else if(code === "RESETBASE"){   // 가격 리셋
    for(const c of companies){
      c.price = c.basePrice;
      c.history = [c.basePrice];
      await updateDoc(doc(db,"companies",c.name),{ price:c.basePrice, history:[c.basePrice] });
    }
    updateChart(); renderCompanies();
    alert("📉 모든 기업이 시작 가격으로 초기화되었습니다.");
  }
  else if(code === "CHARTOFF"){    // 그래프 숨기기
    document.getElementById("chart").style.display = "none";
    alert("📉 그래프가 숨겨졌습니다.");
  }
  else if(code === "CHARTON"){     // 그래프 보이기
    document.getElementById("chart").style.display = "block";
    alert("📈 그래프가 표시되었습니다.");
  }
  else if(code === "CHARTRESET"){  // 그래프 데이터 초기화
    companies.forEach(c => { c.history = [c.price]; });
    updateChart();
    alert("♻️ 그래프가 초기화되었습니다.");
  }
  else{
    alert("알 수 없는 코드입니다.");
  }
};

</script>
</body>
</html>
