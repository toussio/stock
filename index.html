<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46; --warn:#92400e;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }
    button { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1100px; }
    #depositForm input { padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    #depositForm .memo { min-width:220px; }
    #depositForm button { background:var(--accent); }

    #chartWrap { position:relative; margin:20px auto; max-width:1100px; height:400px; background:#111827; border-radius:10px; overflow:hidden; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1100px; }
    .company { background:var(--card); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .company .info { display:flex; justify-content:space-between; font-weight:600; }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }

    #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }
    .log-item { padding:6px 0; border-bottom:1px dashed #374151; font-size:14px; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:10px; width:min(90%,500px); text-align:center; }

    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:10px; border-radius:10px;}
    #adminPanelAll { position:fixed; top:50px; left:50px; z-index:9999; width:90%; max-width:1100px; box-shadow:0 20px 40px rgba(0,0,0,.35); }
    #adminPanelHeader { background:#374151; padding:8px; border-radius:10px 10px 0 0; font-weight:700; }
  </style>
</head>
<body>
  <h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

  <div id="userRow">
    <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
    <div>
      <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btnOpenWithdraw">ì¶œê¸ˆ ìš”ì²­</button>
      <button id="btnOpenNotice">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button id="btnOpenNews">ğŸ“° ë‰´ìŠ¤ <span id="newsBadge" style="display:none;color:red;font-weight:bold;margin-left:6px;">0</span></button>
    </div>
  </div>

  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ê³„ì¢Œë²ˆí˜¸">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨">
    <button id="requestDepositBtn">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- ëª¨ë‹¬ë“¤ -->
  <div id="loginModal" class="modal"><div class="modal-content">
    <h2>ë¡œê·¸ì¸</h2>
    <input id="customId" placeholder="ID"><br>
    <input id="customName" placeholder="ì´ë¦„"><br>
    <button id="startBtn">ì‹œì‘</button>
  </div></div>

  <div id="withdrawModal" class="modal"><div class="modal-content">
    <h2>ì¶œê¸ˆ ìš”ì²­</h2>
    <input id="withdrawId" placeholder="ID"><br>
    <input id="withdrawName" placeholder="ì´ë¦„"><br>
    <input id="withdrawAmount" placeholder="ê¸ˆì•¡"><br>
    <input id="withdrawAccount" placeholder="ê³„ì¢Œë²ˆí˜¸"><br>
    <button id="submitWithdrawBtn">ìš”ì²­</button>
  </div></div>

  <div id="noticeModal" class="modal"><div class="modal-content">
    <h2>ê³µì§€ì‚¬í•­</h2>
    <div id="noticeContent"></div>
    <button id="btnCloseNotice2">ë‹«ê¸°</button>
  </div></div>

  <div id="newsModal" class="modal"><div class="modal-content">
    <h2>ë‰´ìŠ¤</h2>
    <div id="newsContent"></div>
    <button id="btnCloseNews2">ë‹«ê¸°</button>
  </div></div>

  <div id="adminLogin">
    <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
    <button id="btnAdminLogin">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
  </div>

  <div id="adminPanelAll" class="admin-panel">
    <div id="adminPanelHeader">âš™ï¸ ê´€ë¦¬ì íŒ¨ë„
      <button id="btnAdminClose">âœ•</button>
    </div>
    <div id="tab-graph"></div>
    <div id="tab-users" style="display:none;"></div>
    <div id="tab-finance" style="display:none;"></div>
    <div id="tab-stock" style="display:none;"></div>
    <div id="tab-change" style="display:none;"></div>
    <div id="tab-news" style="display:none;"></div>
    <div id="tab-notice" style="display:none;"></div>
    <div id="tab-delist" style="display:none;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">

    /* ================= Utils ================= */
const $ = (sel)=>document.querySelector(sel);
function safeId(name){ return String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_'); }
function parseNumber(str){
  const n = parseInt(String(str).replace(/[^0-9]/g,''),10);
  return isNaN(n)?0:Math.max(0,n);
}
function escapeHtml(s=''){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function log(msg){
  const div=document.createElement('div');
  div.className='log-item';
  div.innerHTML=msg;
  $("#log").prepend(div);
}

/* ================= Firebase Init ================= */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
  onSnapshot, writeBatch, increment, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const auth=getAuth(app); const db=getFirestore(app);

/* ================= State ================= */
let chart=null;
let updateInterval=5000;
let marketOpenFlag=false;
let volatility=1.5;
let lastChartTick=0;
const marketState={ bias:{} };
const companyChances={};
const companyStatus={};
let delistPlan=null;
let player={holdings:{},cash:0};
let currentUser=null;
let unsubscribeUser=null;
let ADMIN_MODE=false;

/* ================= Companies ================= */
const companies=[
  {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:10000000},
  {name:"ì¹´ìŠ¤í‹¸ë¡œ", basePrice:10000000},
  {name:"ì‚¬ì¿ ë¼", basePrice:10000000},
  {name:"ì²­ë£¡", basePrice:10000000},
  {name:"ê²½ì°°ì²­", basePrice:10000000},
  {name:"Ems", basePrice:10000000},
  {name:"ì˜¬ë“œë³´ì´", basePrice:10000000},
  {name:"ì‘ë‘", basePrice:10000000},
  {name:"ë¹…ë”•", basePrice:10000000},
  {name:"ìœ í† í”¼ì•„", basePrice:10000000},
  {name:"inback", basePrice:10000000},
].map(c=>({...c,id:safeId(c.name),multiplier:1,livePrice:c.basePrice}));

function findCompanyById(id){ return companies.find(x=>x.id===id||x.name===id); }
function getDisplayPrice(c){ return Math.max(1,Math.floor(c.livePrice||c.basePrice)); }
function companyIsDelisted(c){ return !!(companyStatus[c.id]?.delisted); }

/* ================= Chart ================= */
function initChart(){
  if(chart) return;
  const ctx=$("#chart").getContext("2d");
  chart=new Chart(ctx,{
    type:"line",
    data:{ labels:[], datasets:companies.map(c=>({label:c.name,data:[],borderWidth:2,fill:false,tension:0.25})) },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{legend:{position:"bottom"}},
      scales:{ x:{title:{display:true,text:"ì‹œê°„"}}, y:{title:{display:true,text:"ê°€ê²©(KRW)"},beginAtZero:false}}
    }
  });
}
function appendChartPoint(t){
  if(!chart) return;
  const label=new Date(t||Date.now()).toLocaleTimeString();
  chart.data.labels.push(label);
  companies.forEach((c,i)=>chart.data.datasets[i].data.push(getDisplayPrice(c)));
  if(chart.data.labels.length>120){
    chart.data.labels.splice(0,chart.data.labels.length-120);
    chart.data.datasets.forEach(d=>{if(d.data.length>120) d.data.splice(0,d.data.length-120);});
  }
  chart.update("none");
}

/* ================= UI Rendering ================= */
function getQty(name){
  const el=$("#qty-"+safeId(name));
  return Math.max(1,parseInt(el?.value)||1);
}
function updateMaxBuyUI(){
  companies.forEach(c=>{
    const el=$("#maxbuy-"+c.id);
    if(el){ const price=getDisplayPrice(c); const maxQty=Math.floor((player.cash||0)/price);
      el.textContent=`(ìµœëŒ€ ${maxQty}ì£¼ ë§¤ìˆ˜ ê°€ëŠ¥)`; }
  });
}
function updateHoldingsUI(){
  companies.forEach(c=>{ const el=$("#hold-"+c.id); if(el) el.textContent=(player.holdings[c.name]||0); });
  updateMaxBuyUI();
}
function renderUserInfo(){
  if(currentUser){
    $("#userInfo").innerHTML=`ğŸ‘¤ <strong>${escapeHtml(currentUser.name)}</strong> (${escapeHtml(currentUser.id)}) | ğŸ’µ ë³´ìœ í˜„ê¸ˆ: <strong>${(player.cash||0).toLocaleString()} KRW</strong>`;
  }else $("#userInfo").textContent="â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...";
  updateMaxBuyUI();
}
function initCompaniesUI(){
  $("#companies").innerHTML=companies.map(c=>{
    const delisted=companyIsDelisted(c);
    return `<div class="company" id="card-${c.id}">
      <div class="info"><span>${escapeHtml(c.name)}</span>
      <span class="status-badge ${delisted?'delisted-badge':''}" id="marketStatus-${c.id}">${delisted?'ğŸš« ìƒì¥íì§€':'ğŸŸ¡ ëŒ€ê¸°'}</span></div>
      <div>ê°€ê²©: <strong><span id="price-${c.id}">${getDisplayPrice(c).toLocaleString()}</span> KRW</strong></div>
      <div>ë³´ìœ : <span id="hold-${c.id}">${player.holdings[c.name]||0}</span> ì£¼
      <span id="maxbuy-${c.id}" style="color:#10b981;font-size:13px;margin-left:6px;">(ìµœëŒ€ ${Math.floor((player.cash||0)/getDisplayPrice(c))}ì£¼ ë§¤ìˆ˜ ê°€ëŠ¥)</span></div>
      <div class="actions">
        <input type="number" id="qty-${c.id}" min="1" value="1" ${(!marketOpenFlag||delisted)?'disabled':''}>
        <button data-role="buy" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>ë§¤ìˆ˜</button>
        <button data-role="sell" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>ë§¤ë„</button>
      </div></div>`;
  }).join("");
  $("#companies").onclick=(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    const comp=findCompanyById(btn.dataset.id); if(!comp) return;
    const qty=getQty(comp.name);
    if(btn.dataset.role==="buy") buy(comp.name,qty);
    if(btn.dataset.role==="sell") sell(comp.name,qty);
  };
  updateMaxBuyUI();
}

/* ================= Trade ================= */
function impactPrice(id,qty,mode){
  const c=findCompanyById(id); if(!c||companyIsDelisted(c)) return;
  const step=Math.min(0.1,Math.max(1,qty)/10000);
  marketState.bias[c.id]=Math.max(-1,Math.min(1,(marketState.bias[c.id]||0)+(mode==="buy"?-step:+step)));
}
async function buy(name,qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("ìƒì¥íì§€ ì¢…ëª© ê±°ë˜ ë¶ˆê°€");
  if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
  const p=getDisplayPrice(c), total=p*qty;
  if(player.cash<total) return alert("í˜„ê¸ˆ ë¶€ì¡±");
  player.cash-=total; player.holdings[c.name]=(player.holdings[c.name]||0)+qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`ğŸŸ¢ ë§¤ìˆ˜ì²´ê²°: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"buy");
}
async function sell(name,qty){
  if(!marketOpenFlag) return alert("â›” ì¥ ë§ˆê° ì¤‘");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("ìƒì¥íì§€ ì¢…ëª© ê±°ë˜ ë¶ˆê°€");
  if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
  if((player.holdings[c.name]||0)<qty) return alert("ë³´ìœ  ë¶€ì¡±");
  const p=getDisplayPrice(c), total=p*qty;
  player.cash+=total; player.holdings[c.name]-=qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`ğŸ”´ ë§¤ë„ì²´ê²°: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"sell");
}

    /* ================= Auth / Session ================= */
async function ensureAuth(){
  return new Promise(resolve=>{
    onAuthStateChanged(auth,(user)=>{
      if(user){ resolve(user); }
      else{
        signInAnonymously(auth)
          .then(res=>resolve(res.user))
          .catch(()=>resolve(null));
      }
    });
  });
}

function subscribeCurrentUser(uid){
  if(unsubscribeUser){ try{unsubscribeUser();}catch{} unsubscribeUser=null; }
  const uref = doc(db,"users",uid);
  unsubscribeUser = onSnapshot(uref,(snap)=>{
    if(!snap.exists()) return;
    const d = snap.data()||{};
    player.cash = Number(d.cash||0);
    player.holdings = d.holdings||{};
    renderUserInfo();
    updateHoldingsUI();
  });
}

$("#startBtn").onclick = async ()=>{
  const cid = ($("#customId").value||"").trim();
  const cname = ($("#customName").value||"").trim();
  if(!cid || !cname) return alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  await ensureAuth();
  const uref = doc(db,"users",cid);
  const snap = await getDoc(uref);
  let nextCash = 0, nextHold = {};
  if(snap.exists()){
    const d = snap.data()||{};
    nextCash = Number(d.cash||0);
    nextHold = d.holdings||{};
  }
  currentUser = { id: cid, name: cname };
  player.cash = nextCash; player.holdings = nextHold;

  await setDoc(uref, {
    id: cid, name: cname, cash: nextCash, holdings: nextHold,
    active: true, lastLoginAt: Date.now()
  }, { merge:true });

  localStorage.setItem("stockUser", JSON.stringify({ id: cid, name: cname }));
  $("#loginModal").style.display = "none";
  renderUserInfo();
  initCompaniesUI();
  subscribeCurrentUser(cid);
};

async function logout(){
  try{
    if(currentUser) await updateDoc(doc(db,"users",currentUser.id), { active:false, lastLogoutAt: Date.now() });
  }catch{}
  if(unsubscribeUser){ try{unsubscribeUser();}catch{} unsubscribeUser=null; }
  localStorage.removeItem("stockUser");
  location.reload();
}
$("#btnLogout").onclick = logout;

window.addEventListener("load", async ()=>{
  await ensureAuth();
  const saved = localStorage.getItem("stockUser");
  if(saved){
    try{
      const p = JSON.parse(saved);
      if(p && p.id && p.name){
        currentUser = { id:p.id, name:p.name };
        $("#loginModal").style.display = "none";
        try{ await updateDoc(doc(db,"users",p.id), { active:true, lastLoginAt: Date.now() }); }catch{}
        renderUserInfo();
        initCompaniesUI();
        subscribeCurrentUser(p.id);
      }else{
        $("#loginModal").style.display = "flex";
      }
    }catch{
      localStorage.removeItem("stockUser");
      $("#loginModal").style.display = "flex";
    }
  }else{
    $("#loginModal").style.display = "flex";
  }
  // ì°¨íŠ¸ ì´ˆê¸°í™”
  initChart();
  companies.forEach(c=>c.livePrice=c.basePrice);
  appendChartPoint(Date.now());
});

/* ================= ì…Â·ì¶œê¸ˆ ëª¨ë‹¬/ìš”ì²­ ================= */
$("#btnOpenWithdraw").onclick = ()=> $("#withdrawModal").style.display="flex";
$("#btnCloseWithdraw").onclick = ()=> $("#withdrawModal").style.display="none";

$("#withdrawAmount").oninput = ()=>{
  const amount = parseNumber($("#withdrawAmount").value);
  const fee = Math.floor(amount * 0.10);
  $("#withdrawFeeInfo").textContent = amount>0
    ? `ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()} KRW (ì‹¤ì§€ê¸‰: ${(Math.max(0,amount-fee)).toLocaleString()} KRW)`
    : '';
};

async function requestDeposit(){
  const id = currentUser?.id||"";
  const name = currentUser?.name||"";
  const account = ($("#acctNo").value||"").trim();
  const amount = parseNumber($("#cashAmount").value);
  const memo = ($("#cashMemo").value||"").trim();
  if(!id || !name || !account || amount<=0) return alert("âš ï¸ ê³„ì¢Œë²ˆí˜¸ì™€ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
  try{
    await addDoc(collection(db,"depositRequests"), {
      userId:id, userName:name, account, amount, memo,
      status:"pending", createdAt: Date.now()
    });
    alert(`ğŸ’° ${amount.toLocaleString()} KRW ì…ê¸ˆ ìš”ì²­ ì™„ë£Œ`);
    log(`<strong>ğŸ’° ì…ê¸ˆìš”ì²­:</strong> ${amount.toLocaleString()} KRW (${escapeHtml(account)})`);
    $("#acctNo").value=""; $("#cashAmount").value=""; $("#cashMemo").value="";
  }catch(e){ alert("ì…ê¸ˆ ìš”ì²­ ì˜¤ë¥˜: " + (e.message||e)); }
}
$("#requestDepositBtn").onclick = requestDeposit;

async function submitWithdraw(){
  const id = ($("#withdrawId").value||"").trim();
  const name = ($("#withdrawName").value||"").trim();
  const amount = parseNumber($("#withdrawAmount").value);
  const account = ($("#withdrawAccount").value||"").trim();
  if(!id || !name || !account || amount<=0) return alert("âš ï¸ ê³ ìœ ë²ˆí˜¸/ì´ë¦„/ê³„ì¢Œ/ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
  try{
    await addDoc(collection(db,"withdrawRequests"), {
      userId:id, userName:name, amount, account,
      status:"pending", createdAt: Date.now()
    });
    alert("ğŸ“¤ ì¶œê¸ˆ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    const fee = Math.floor(amount*0.1);
    log(`<strong>ğŸ“¤ ì¶œê¸ˆìš”ì²­:</strong> ${amount.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(Math.max(0,amount-fee)).toLocaleString()})`);
    $("#withdrawModal").style.display="none";
  }catch(e){ alert("ì¶œê¸ˆ ìš”ì²­ ì˜¤ë¥˜: " + (e.message||e)); }
}
$("#submitWithdrawBtn").onclick = submitWithdraw;

/* ================= ê³µì§€/ë‰´ìŠ¤ ëª¨ë‹¬ ë²„íŠ¼ ================= */
$("#btnOpenNotice").onclick = ()=> $("#noticeModal").style.display="flex";
$("#btnCloseNotice").onclick = ()=> $("#noticeModal").style.display="none";
$("#btnCloseNotice2").onclick = ()=> $("#noticeModal").style.display="none";

let lastReadNewsAt = Number(localStorage.getItem("lastReadNewsAt")||0);
$("#btnOpenNews").onclick = ()=>{
  $("#newsModal").style.display="flex";
  lastReadNewsAt = Date.now();
  localStorage.setItem("lastReadNewsAt", String(lastReadNewsAt));
  const badge = $("#newsBadge"); if(badge){ badge.style.display="none"; badge.textContent="0"; }
};
$("#btnCloseNews").onclick = ()=> $("#newsModal").style.display="none";
$("#btnCloseNews2").onclick = ()=> $("#newsModal").style.display="none";

/* ================= ë‰´ìŠ¤/ê³µì§€ êµ¬ë… ================= */
let newsData=[], newsDataAll=[], noticeDataAll=[];

function updateNewsBadge(count){
  const badge = $("#newsBadge");
  if(!badge) return;
  if(count>0){ badge.style.display='inline'; badge.textContent=String(count); }
  else { badge.style.display='none'; }
}
function renderNewsModal(){
  const host = $("#newsContent"); if(!host) return;
  if(!newsData.length){ host.innerHTML = `<p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return; }
  host.innerHTML = newsData.map(n=>{
    const dt = new Date(n.createdAt||Date.now()).toLocaleString();
    const title = escapeHtml(n.title||'ì œëª© ì—†ìŒ');
    const body = escapeHtml(n.content||'').replace(/\n/g,'<br>');
    return `<div style="padding:8px 0; border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${title}</div>
      <div style="color:#9ca3af; font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${body}</div>
    </div>`;
  }).join('');
}
function renderNoticeModal(){
  const host = $("#noticeContent"); if(!host) return;
  if(!noticeDataAll.length){ host.innerHTML = `<p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`; return; }
  host.innerHTML = noticeDataAll.map(n=>{
    const dt = new Date(n.createdAt||Date.now()).toLocaleString();
    const title = escapeHtml(n.title||'ê³µì§€ì‚¬í•­');
    const body = escapeHtml(n.content||'').replace(/\n/g,'<br>');
    return `<div style="padding:8px 0; border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${title}</div>
      <div style="color:#9ca3af; font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${body}</div>
    </div>`;
  }).join('');
}

function subscribeNews(){
  const qy = query(collection(db,'news'), orderBy('createdAt','desc'));
  onSnapshot(qy,(snap)=>{
    const visible=[], all=[];
    snap.forEach(docu=>{
      const n={ id:docu.id, ...(docu.data()||{}) };
      all.push(n);
      if(n.visible!==false) visible.push(n);
    });
    newsData = visible; newsDataAll = all;
    const unread = visible.filter(n=>(n.createdAt||0) > lastReadNewsAt).length;
    updateNewsBadge(unread);
    renderNewsModal();
  });
}
function subscribeNotices(){
  const qy = query(collection(db,'notices'), orderBy('createdAt','desc'));
  onSnapshot(qy,(snap)=>{
    const all=[];
    snap.forEach(docu=> all.push({ id:docu.id, ...(docu.data()||{}) }));
    noticeDataAll = all;
    renderNoticeModal();
  });
}

/* ================= íšŒì‚¬/ì‹œì¥ ì‹¤ì‹œê°„ êµ¬ë… ================= */
function subscribeCompanyPrices(){
  onSnapshot(collection(db,"companyPrices"), (snap)=>{
    let maxTick = 0;
    snap.forEach(docu=>{
      const data = docu.data()||{};
      const c = findCompanyById(docu.id); if(!c) return;
      if(typeof data.current==='number') c.livePrice = data.current;
      if(typeof data.updatedAt==='number') maxTick = Math.max(maxTick, data.updatedAt);
      const el = $("#price-"+c.id); if(el) el.textContent = getDisplayPrice(c).toLocaleString();
    });
    updateMaxBuyUI();
    if(maxTick && maxTick > lastChartTick){
      lastChartTick = maxTick;
      appendChartPoint(maxTick);
    }
  });
}
function subscribeCompanySettings(){
  onSnapshot(collection(db,'companySettings'), (snap)=>{
    snap.forEach(d=>{
      const data=d.data()||{};
      const c=findCompanyById(d.id);
      if(!c) return;
      if(typeof data.multiplier==='number') c.multiplier = data.multiplier;
    });
  });
}
function subscribeCompanyChances(){
  onSnapshot(collection(db,'companyChances'), (snap)=>{
    snap.forEach(docu=>{
      const data=docu.data()||{};
      if(typeof data.profit==='number' && typeof data.loss==='number'){
        companyChances[docu.id] = { profit:data.profit, loss:data.loss };
      }
    });
  });
}
function subscribeCompanyStatus(){
  onSnapshot(collection(db,'companyStatus'), (snap)=>{
    snap.forEach(s=>{
      const data=s.data()||{};
      companyStatus[s.id] = { delisted: !!data.delisted, delistedAt: data.delistedAt||null };
    });
    // ì¹´ë“œ ìƒíƒœ ë°°ì§€/ë²„íŠ¼ ê°±ì‹ 
    companies.forEach(c=>{
      const card = $("#card-"+c.id); if(!card) return;
      const delisted = companyIsDelisted(c);
      const st = $("#marketStatus-"+c.id);
      if(st){
        st.textContent = delisted ? 'ğŸš« ìƒì¥íì§€' : (marketOpenFlag ? 'ğŸŸ¢ ê°œì¥' : 'ğŸ”´ ë§ˆê°');
        st.classList.toggle('delisted-badge', delisted);
      }
      const qty = $("#qty-"+c.id);
      const disabled = !marketOpenFlag || delisted;
      if(qty) qty.disabled = disabled;
      card.querySelectorAll('button').forEach(b=>{
        if(b.dataset.role==='buy' || b.dataset.role==='sell') b.disabled = disabled;
      });
    });
  });
}
function subscribeGlobals(){
  onSnapshot(doc(db,"globals","settings"), (snap)=>{
    if(!snap.exists()) return;
    const d = snap.data()||{};
    if(typeof d.volatility==='number') volatility = d.volatility;
  });
}
function subscribeMarketState(){
  onSnapshot(doc(db,"marketState","main"), (snap)=>{
    const d = snap.exists()? (snap.data()||{}) : {};
    marketOpenFlag = !!d.isOpen;
    if(typeof d.interval==="number" && d.interval>=500) updateInterval = d.interval;
    delistPlan = d.delistPlan || null;

    // ìƒíƒœ ë±ƒì§€ ê°±ì‹ 
    companies.forEach(c=>{
      const st = $("#marketStatus-"+c.id);
      if(st && !companyIsDelisted(c))
        st.textContent = marketOpenFlag ? 'ğŸŸ¢ ê°œì¥' : 'ğŸ”´ ë§ˆê°';
      const qty = $("#qty-"+c.id);
      const disabled = !marketOpenFlag || companyIsDelisted(c);
      if(qty) qty.disabled = disabled;
      const card = $("#card-"+c.id);
      if(card) card.querySelectorAll('button').forEach(b=>{
        if(b.dataset.role==='buy' || b.dataset.role==='sell') b.disabled = disabled;
      });
    });
  });
}

/* ================= êµ¬ë… ì‹œì‘ (ì•± ê³µí†µ) ================= */
subscribeNews();
subscribeNotices();
subscribeCompanyPrices();
subscribeCompanySettings();
subscribeCompanyChances();
subscribeCompanyStatus();
subscribeGlobals();
subscribeMarketState();

    /* ================= ê´€ë¦¬ì ë¡œê·¸ì¸/íŒ¨ë„ ================= */
let ADMIN_MODE = false;
const ADMIN_PASS = "graph703"; // ê´€ë¦¬ì ì½”ë“œ

$("#btnAdminLogin").onclick = ()=>{
  const code = ($("#adminCode").value||"").trim();
  if(code === ADMIN_PASS){
    ADMIN_MODE = true;
    $("#adminLogin").style.display="none";
    $("#adminPanelAll").style.display="block";
    alert("âœ… ê´€ë¦¬ì ëª¨ë“œ ì§„ì…");
    initAdminPanelLogic(); // ê´€ë¦¬ì ê¸°ëŠ¥ ì´ˆê¸°í™”
  }else{
    alert("âŒ ê´€ë¦¬ì ì½”ë“œ ë¶ˆì¼ì¹˜");
  }
};
$("#btnAdminClose").onclick = ()=>{
  $("#adminPanelAll").style.display="none";
  $("#adminLogin").style.display="block";
  ADMIN_MODE = false;
};

/* ----- íŒ¨ë„ íƒ­ ì „í™˜ ----- */
function showTab(tab){
  document.querySelectorAll(".tab-section").forEach(div=>div.style.display="none");
  const tgt = $("#tab-"+tab); if(tgt) tgt.style.display="block";
}
document.querySelectorAll("#adminPanelAll [data-tab]").forEach(btn=>{
  btn.onclick = ()=> showTab(btn.dataset.tab);
});

/* ================= ê·¸ë˜í”„ ì œì–´ UI ================= */
function renderGraphPanel(){
  $("#tab-graph").innerHTML = `
    <div style="margin-bottom:12px;">
      <button id="marketStartBtn">ğŸŸ¢ ì¥ ì‹œì‘</button>
      <button id="marketEndBtn">ğŸ”´ ì¥ ë§ˆê°</button>
      <button id="resetGraphBtn">â™»ï¸ ê·¸ë˜í”„ ì´ˆê¸°í™”</button>
    </div>
    <div style="margin-bottom:12px;">
      <input id="intervalInput" type="number" value="5" style="width:80px;"> ì´ˆ
      <button id="applyIntervalBtn">ë³€ë™ì£¼ê¸° ì ìš©</button>
      <input id="deltaMaxInput" type="number" value="1000000" style="width:120px;"> Â±1í‹± ìƒí•œ
      <button id="applyDeltaBtn">ìƒí•œ ì ìš©</button>
    </div>
    <div style="margin-bottom:12px;">
      <input id="allDelta" type="number" value="10000" style="width:100px;">
      <button id="adjustAllBtn">ì „ì²´ ì¼ê´„ ê°€ê²©ì¡°ì •</button>
    </div>
    <div id="graphCompanyAdjust"></div>
  `;
}

/* ================= ìœ ì € ëª©ë¡ UI ================= */
function renderUsersPanel(){
  $("#tab-users").innerHTML = `<div id="userList">â³ ë¡œë”©ì¤‘...</div>`;
}

/* ================= ì…ì¶œê¸ˆ ìš”ì²­ UI ================= */
function renderFinancePanel(){
  $("#tab-finance").innerHTML = `
    <h3>ğŸ’° ì…ê¸ˆ ìš”ì²­</h3>
    <div id="depositRequests"></div>
    <h3 style="margin-top:20px;">ğŸ“¤ ì¶œê¸ˆ ìš”ì²­</h3>
    <div id="withdrawRequests"></div>
  `;
}

/* ================= ì£¼ê°€ì¡°ì‘ íŒ¨ë„ ================= */
function renderStockPanel(){
  $("#tab-stock").innerHTML = `<div id="stockTuner">â³ ë¡œë”©ì¤‘...</div>`;
}

/* ================= ë°°ìœ¨/í™•ë¥  íŒ¨ë„ ================= */
function renderChangePanelUI(){
  $("#tab-change").innerHTML = `
    <div style="margin-bottom:12px;">
      ì „ì²´ í™•ë¥ : <input id="globalProfit" type="number" step="0.01" value="0.4" style="width:80px;">
      / <input id="globalLoss" type="number" step="0.01" value="0.6" style="width:80px;">
      <button id="applyAllChanceBtn">ì „ì²´ í™•ë¥  ì ìš©</button>
    </div>
    <div style="margin-bottom:12px;">
      ì „ì²´ ë°°ìœ¨: <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:80px;">
      <button id="applyAllMultiplierBtn">ì „ì²´ ë°°ìœ¨ ì ìš©</button>
    </div>
    <div style="margin-bottom:12px;">
      ì „ì—­ ë³€ë™í­(%): <input id="volatilityInput" type="number" step="0.1" value="1.5" style="width:80px;">
      <button id="applyVolatilityBtn">ì ìš©</button>
    </div>
    <div id="changePanel"></div>
  `;
}

/* ================= ë‰´ìŠ¤/ê³µì§€ íŒ¨ë„ ================= */
function renderNewsNoticePanel(){
  $("#tab-news").innerHTML = `
    <h3>ğŸ“° ë‰´ìŠ¤ ê´€ë¦¬</h3>
    <input id="newsTitleInput" placeholder="ì œëª©" style="width:90%; margin:4px 0;"><br>
    <textarea id="newsBodyInput" placeholder="ë‚´ìš©"></textarea><br>
    <button id="postNewsBtn">ë‰´ìŠ¤ ë“±ë¡</button>
    <div id="newsList" style="margin-top:12px;"></div>
  `;
  $("#tab-notice").innerHTML = `
    <h3>ğŸ“¢ ê³µì§€ ê´€ë¦¬</h3>
    <input id="noticeTitleInput" placeholder="ì œëª©" style="width:90%; margin:4px 0;"><br>
    <textarea id="noticeBodyInput" placeholder="ë‚´ìš©"></textarea><br>
    <button id="postNoticeBtn">ê³µì§€ ë“±ë¡</button>
    <div id="noticeList" style="margin-top:12px;"></div>
  `;
}

/* ================= ìƒì¥íì§€ íŒ¨ë„ ================= */
function renderDelistPanel(){
  $("#tab-delist").innerHTML = `
    <div style="margin-bottom:10px;">
      <select id="delistCompanySel"></select>
      <input id="delistMinutes" type="number" value="30" style="width:70px;"> ë¶„ í›„ ìƒì¥íì§€
      <button id="delistStartBtn">ìƒì¥íì§€ ì‹œì‘</button>
      <button id="delistCancelBtn">ì·¨ì†Œ</button>
      <button id="reviveNowBtn">ë¶€í™œ</button>
    </div>
    <div id="delistStatus" style="margin:8px 0; color:#9ca3af;">ì§„í–‰ ì¤‘ì¸ ê³„íš ì—†ìŒ</div>
    <h4>ğŸš« ìƒì¥íì§€ ëª©ë¡</h4>
    <div id="delistedItems"></div>
  `;
}

/* ================= ê´€ë¦¬ì ì´ˆê¸°í™” ================= */
function initAdminPanelLogic(){
  renderGraphPanel();
  renderUsersPanel();
  renderFinancePanel();
  renderStockPanel();
  renderChangePanelUI();
  renderNewsNoticePanel();
  renderDelistPanel();

  // ê°ê°ì˜ ìƒì„¸ ë¡œì§ì€ Part 4-2ì—ì„œ ì •ì˜
}

    /* =========================
   Part 4-2: Admin Logic
   ========================= */

/* ë³´ì¡° ìœ í‹¸ */
const parseIntSafe = (v, d=0)=>{ const n = parseInt(v,10); return Number.isFinite(n)?n:d; };
let deltaMax = 1000000;

/* ----- ê·¸ë˜í”„/ê°€ê²© ì¡°ì • ----- */
function refreshCompanyIdsFromDOM(){
  const host = $("#companies");
  if(!host) return [];
  return Array.from(host.querySelectorAll(".company")).map(card=>{
    const id = (card.id||"").replace(/^card-/, '');
    const name = (card.querySelector('.info span')?.textContent||id).trim();
    return { id, name };
  });
}
async function setMarketOpen(open){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  updateInterval = updateInterval || 5000;
  await setDoc(doc(db,"marketState","main"), { isOpen: !!open, updatedAt: Date.now(), interval: updateInterval }, { merge:true });
  alert(open ? "ğŸŸ¢ ì¥ ì‹œì‘" : "ğŸ”´ ì¥ ë§ˆê°");
}
async function resetGraph(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current: 10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  if(chart){ chart.data.labels=[]; chart.data.datasets.forEach(d=> d.data=[]); chart.update(); }
  alert("â™»ï¸ ê·¸ë˜í”„ ì´ˆê¸°í™” ì™„ë£Œ");
}
async function adjustAllPrices(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const delta = parseIntSafe($("#allDelta").value, 0);
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current: increment(delta), updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert(`âœ… ì „ì²´ ì¼ê´„ ì¡°ì •: ${delta>=0?'+':''}${delta.toLocaleString()}ì›`);
}
async function adjustCompanyPriceById(id, delta){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  await setDoc(doc(db,"companyPrices",id), { current: increment(parseIntSafe(delta,0)), updatedAt: Date.now() }, { merge:true });
}
async function applyGraphInterval(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const sec = Math.max(1, parseIntSafe($("#intervalInput").value, 5));
  updateInterval = sec*1000;
  await setDoc(doc(db,"marketState","main"), { interval: updateInterval, updatedAt: Date.now() }, { merge:true });
  alert(`â±ï¸ ë³€ë™ ì£¼ê¸° ì ìš©: ${sec}s`);
}
function applyDeltaMax(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  deltaMax = Math.max(1, parseIntSafe($("#deltaMaxInput").value, 1000000));
  alert(`ğŸ“ˆ 1í‹± ìƒí•œ(Â±ì›) ë³€ê²½: ${deltaMax.toLocaleString()}`);
}
function renderGraphAdjustPanel(){
  const wrap = $("#graphCompanyAdjust"); if(!wrap) return;
  const items = refreshCompanyIdsFromDOM();
  wrap.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="number" data-role="adj-input" data-id="${id}" value="10000" style="width:110px;">
        <button data-role="adj-apply" data-id="${id}">ì ìš©</button>
      </div>
    </div>
  `).join('') || 'íšŒì‚¬ ì—†ìŒ';
  wrap.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="adj-apply"]'); if(!btn) return;
    const id = btn.dataset.id;
    const inp = wrap.querySelector(`input[data-role="adj-input"][data-id="${id}"]`);
    await adjustCompanyPriceById(id, parseIntSafe(inp?.value,0));
  };
}

/* ----- ìœ ì €/ê¶Œí•œ/ê°•ì œë¡œê·¸ì•„ì›ƒ ----- */
function subscribeUsersPanel(){
  const host = $("#userList"); if(!host) return;
  host.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  onSnapshot(collection(db,"users"), snap=>{
    let html = '';
    snap.forEach(d=>{
      const u = d.data()||{};
      const hold = u.holdings || {};
      const holdTxt = Object.entries(hold).map(([k,v])=>`${escapeHtml(k)}:${v}`).join(', ') || 'ë³´ìœ  ì—†ìŒ';
      html += `
        <div class="req-card">
          <div>
            <div><strong>${escapeHtml(u.name||'-')}</strong> (${d.id}) ${u.active?'ğŸŸ¢':'ğŸ”´'} ${u.isAdmin?'<span style="color:#10b981">ê´€ë¦¬ìğŸ›¡ï¸</span>':''}</div>
            <div>í˜„ê¸ˆ: ${Number(u.cash||0).toLocaleString()} KRW</div>
            <div>ë³´ìœ : ${holdTxt}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-action="force-logout" data-id="${d.id}">ê°•ì œ ë¡œê·¸ì•„ì›ƒ</button>
            ${u.isAdmin
              ? `<button data-action="demote" data-id="${d.id}">ê¶Œí•œ í•´ì œ</button>`
              : `<button data-action="promote" data-id="${d.id}">ê¶Œí•œ ë¶€ì—¬</button>`
            }
          </div>
        </div>`;
    });
    host.innerHTML = html || 'ìœ ì € ì—†ìŒ';
  });
  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const action = btn.dataset.action, uid = btn.dataset.id;
    if(action==="force-logout"){
      await updateDoc(doc(db,"users",uid), { active:false, lastLogoutAt: Date.now() });
      alert("ğŸ‘¤ ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
    }else if(action==="promote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:true, updatedAt: Date.now() });
      alert("ğŸ›¡ï¸ ê¶Œí•œ ë¶€ì—¬");
    }else if(action==="demote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:false, updatedAt: Date.now() });
      alert("âš ï¸ ê¶Œí•œ í•´ì œ");
    }
  };
}

/* ----- ì…ì¶œê¸ˆ í ----- */
function subscribeFinanceQueues(){
  const dep = $("#depositRequests"), wdr = $("#withdrawRequests");
  if(dep){
    dep.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    onSnapshot(collection(db,"depositRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ê³„ì¢Œ: ${escapeHtml(r.account||'')}</div>
              <div>ê¸ˆì•¡: ${Number(r.amount||0).toLocaleString()} KRW</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="dep" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${Number(r.amount||0)}">ìŠ¹ì¸</button>
              <button data-kind="dep" data-do="reject" data-id="${d.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      dep.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    dep.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='dep') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        await updateDoc(doc(db,"users",uid), { cash: increment(amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"depositRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"depositRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }

  if(wdr){
    wdr.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    onSnapshot(collection(db,"withdrawRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        const amt = Number(r.amount||0), fee=Math.floor(amt*0.1);
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>ìš”ì²­ì•¡: ${amt.toLocaleString()} KRW (ìˆ˜ìˆ˜ë£Œ ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰ ${(Math.max(0,amt-fee)).toLocaleString()})</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="wdr" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${amt}">ìŠ¹ì¸</button>
              <button data-kind="wdr" data-do="reject" data-id="${d.id}">ê±°ì ˆ</button>
            </div>
          </div>`;
      });
      wdr.innerHTML = html || 'ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ';
    });
    wdr.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='wdr') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        const us = await getDoc(doc(db,"users",uid));
        const cash = Number(us.data()?.cash||0);
        if(cash < amt) return alert("âŒ ì‚¬ìš©ì ë³´ìœ  í˜„ê¸ˆ ë¶€ì¡±");
        await updateDoc(doc(db,"users",uid), { cash: increment(-amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"withdrawRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"withdrawRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }
}

/* ----- ì£¼ê°€ì¡°ì‘(ë¹ ë¥¸ Â±ë²„íŠ¼) ----- */
function renderStockTuner(){
  const host = $("#stockTuner"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:6px;">
        <button data-role="tune" data-id="${id}" data-delta="-100000">-10ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="-10000">-1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="10000">+1ë§Œ</button>
        <button data-role="tune" data-id="${id}" data-delta="100000">+10ë§Œ</button>
      </div>
    </div>`).join('') || 'ì¢…ëª© ì—†ìŒ';
  host.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="tune"]'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    await adjustCompanyPriceById(btn.dataset.id, parseIntSafe(btn.dataset.delta,0));
  };
}

/* ----- ë°°ìœ¨/í™•ë¥  íŒ¨ë„ ìƒì„¸ ----- */
function renderChangePanel(){
  const host = $("#changePanel"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div style="min-width:220px;">
        <div><strong>${escapeHtml(name)}</strong></div>
        <div style="font-size:12px;color:#9ca3af;">ë°°ìœ¨/í™•ë¥  ì €ì¥ ì‹œ ì¦‰ì‹œ ë°˜ì˜</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="number" step="0.1" value="1" style="width:90px;" data-role="mul" data-id="${id}">
        <button data-role="mul-apply" data-id="${id}">ë°°ìœ¨ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="0.01" min="0" max="1" value="0.4" style="width:90px;" data-role="up" data-id="${id}">
        <input type="number" step="0.01" min="0" max="1" value="0.6" style="width:90px;" data-role="down" data-id="${id}">
        <button data-role="chance-apply" data-id="${id}">í™•ë¥ ì ìš©</button>
        <span style="width:8px"></span>
        <input type="number" step="1" value="10000" style="width:100px;" data-role="bump" data-id="${id}">
        <button data-role="bump-apply" data-id="${id}">ì¦‰ì‹œÂ±ë°˜ì˜</button>
      </div>
    </div>
  `).join('') || 'ì¢…ëª© ì—†ìŒ';

  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const id = btn.dataset.id, role = btn.dataset.role;
    if(role==='mul-apply'){
      const v = Number(host.querySelector(`input[data-role="mul"][data-id="${id}"]`)?.value||1);
      const m = Number.isFinite(v)?Math.max(0,v):1;
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
      alert("ë°°ìœ¨ ì ìš©");
    }else if(role==='chance-apply'){
      const up = Number(host.querySelector(`input[data-role="up"][data-id="${id}"]`)?.value||0.4);
      const dn = Number(host.querySelector(`input[data-role="down"][data-id="${id}"]`)?.value||0.6);
      if(!(up>=0 && dn>=0 && (up+dn)>0 && up<=1 && dn<=1)) return alert("0~1, í•©ê³„>0");
      await setDoc(doc(db,"companyChances",id), { profit:up, loss:dn, updatedAt: Date.now() }, { merge:true });
      alert("í™•ë¥  ì ìš©");
    }else if(role==='bump-apply'){
      const delta = parseIntSafe(host.querySelector(`input[data-role="bump"][data-id="${id}"]`)?.value, 0);
      await adjustCompanyPriceById(id, delta);
    }
  };

  // ì „ì—­ ë²„íŠ¼
  $("#applyAllChanceBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const p = parseFloat($("#globalProfit").value), l = parseFloat($("#globalLoss").value);
    if(!(p>=0 && l>=0 && (p+l)>0 && p<=1 && l<=1)) return alert("0~1, í•©ê³„>0");
    for(const {id} of items){
      await setDoc(doc(db,"companyChances",id), { profit:p, loss:l, updatedAt: Date.now() }, { merge:true });
    }
    alert("âœ… ì „ì²´ í™•ë¥  ì ìš©");
  };
  $("#applyAllMultiplierBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const v = Number($("#allMultiplierVal").value);
    const m = Number.isFinite(v)?Math.max(0,v):1;
    for(const {id} of items){
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
    }
    alert("âœ… ì „ì²´ ë°°ìœ¨ ì ìš©");
  };
  $("#applyVolatilityBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const v = Number($("#volatilityInput").value);
    const vv = Number.isFinite(v)?Math.max(0,v):1.5;
    await setDoc(doc(db,"globals","settings"), { volatility: vv, updatedAt: Date.now() }, { merge:true });
    alert(`âœ… ì „ì—­ ë³€ë™í­ ${vv}% ì ìš©`);
  };
}

/* ----- ë‰´ìŠ¤/ê³µì§€ (ê´€ë¦¬ì) ----- */
function subscribeNewsAdmin(){
  const list = $("#newsList"); if(!list) return;
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  const qy = query(collection(db,"news"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"ì œëª© ì—†ìŒ");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      const vis = (n.visible!==false);
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
            <div style="color:${vis?'#10b981':'#ef4444'}; font-size:12px; margin-top:4px;">${vis?'í‘œì‹œì¤‘':'ìˆ¨ê¹€'}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="news-toggle" data-id="${n.id}" data-visible="${vis}">${vis?'ìˆ¨ê¹€':'í‘œì‹œ'}</button>
            <button data-role="news-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const role = btn.dataset.role, id = btn.dataset.id;
    if(role==='news-toggle'){
      const cur = btn.dataset.visible === 'true';
      await updateDoc(doc(db,"news",id), { visible: !cur, updatedAt: Date.now() });
    }else if(role==='news-del'){
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"news",id));
    }
  };
  $("#postNewsBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const title = ($("#newsTitleInput").value||"").trim();
    const content = ($("#newsBodyInput").value||"").trim();
    if(!title||!content) return alert("ì œëª©/ë‚´ìš© ì…ë ¥");
    await addDoc(collection(db,"news"), { title, content, createdAt: Date.now(), visible: true, author: currentUser?.name||'ê´€ë¦¬ì' });
    $("#newsTitleInput").value=''; $("#newsBodyInput").value='';
    alert("ğŸ“° ë‰´ìŠ¤ ë“±ë¡");
  };
}
function subscribeNoticeAdmin(){
  const list = $("#noticeList"); if(!list) return;
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  const qy = query(collection(db,"notices"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"ê³µì§€ì‚¬í•­");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="notice-del" data-id="${n.id}" style="background:#7f1d1d;">ì‚­ì œ</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || 'ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    if(btn.dataset.role==='notice-del'){
      const id = btn.dataset.id;
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"notices",id));
    }
  };
  $("#postNoticeBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
    const title = ($("#noticeTitleInput").value||"").trim();
    const content = ($("#noticeBodyInput").value||"").trim();
    if(!title||!content) return alert("ì œëª©/ë‚´ìš© ì…ë ¥");
    await addDoc(collection(db,"notices"), { title, content, createdAt: Date.now(), author: currentUser?.name||'ê´€ë¦¬ì' });
    $("#noticeTitleInput").value=''; $("#noticeBodyInput").value='';
    alert("ğŸ“¢ ê³µì§€ ë“±ë¡");
  };
}

/* ----- ìƒì¥íì§€/ë¶€í™œ ----- */
let __delistPlan = null;
function populateDelistSelect(){
  const sel = $("#delistCompanySel"); if(!sel) return;
  const items = refreshCompanyIdsFromDOM();
  sel.innerHTML = items.map(({id,name})=>`<option value="${id}">${escapeHtml(name)}</option>`).join('');
}
function renderDelistStatus(){
  const el = $("#delistStatus"); if(!el) return;
  if(!__delistPlan || !__delistPlan.active){
    el.style.color = '#9ca3af';
    el.textContent = 'ì§„í–‰ ì¤‘ì¸ ìƒì¥íì§€ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  const remain = Math.max(0, (__delistPlan.endAt - Date.now()));
  const mm = Math.floor(remain/60000), ss = Math.floor((remain%60000)/1000);
  el.style.color = '#fbbf24';
  el.textContent = `ì§„í–‰ ì¤‘: [${__delistPlan.companyId}] ${mm}ë¶„ ${ss}ì´ˆ í›„ 0ì› ë„ë‹¬ ë° ìƒì¥íì§€ ì˜ˆì •`;
}
function renderDelistedListSnap(snap){
  const host = $("#delistedItems"); if(!host) return;
  const items = [];
  const nameMap = Object.fromEntries(refreshCompanyIdsFromDOM().map(o=>[o.id,o.name]));
  snap?.forEach(s=>{
    const d=s.data()||{};
    if(d.delisted){
      items.push({ name: nameMap[s.id]||s.id, at: d.delistedAt? new Date(d.delistedAt).toLocaleString():'-' });
    }
  });
  host.innerHTML = items.length
    ? items.map(x=>`<div>â€¢ ${escapeHtml(x.name)} (íì§€ ì‹œê°: ${x.at})</div>`).join('')
    : 'ìƒì¥íì§€ëœ ì¢…ëª© ì—†ìŒ';
}
async function scheduleDelist(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const id = $("#delistCompanySel").value;
  const mins = Math.max(1, parseIntSafe($("#delistMinutes").value,30));
  const now = Date.now();
  __delistPlan = { companyId: id, startAt: now, endAt: now + mins*60000, active:true, mode:'toZero' };
  await setDoc(doc(db,"marketState","main"), { delistPlan: __delistPlan, updatedAt: now }, { merge:true });
  renderDelistStatus();
  alert("ğŸš« ìƒì¥íì§€ ê³„íš ì‹œì‘");
}
async function cancelDelist(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  __delistPlan = null;
  await setDoc(doc(db,"marketState","main"), { delistPlan:{active:false}, updatedAt: Date.now() }, { merge:true });
  renderDelistStatus();
  alert("ì·¨ì†Œë¨");
}
async function reviveCompanies(){
  if(!ADMIN_MODE) return alert("ê´€ë¦¬ì ì „ìš©");
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyStatus",id), { delisted:false, revivedAt: now }, { merge:true });
    batch.set(doc(db,"companyPrices",id), { current: 10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert("âœ… ë¶€í™œ ì™„ë£Œ");
}

/* ----- Admin ë²„íŠ¼ ë°”ì¸ë”© + êµ¬ë… ----- */
function bindGraphActions(){
  $("#marketStartBtn").onclick = ()=> setMarketOpen(true);
  $("#marketEndBtn").onclick   = ()=> setMarketOpen(false);
  $("#resetGraphBtn").onclick  = resetGraph;
  $("#applyIntervalBtn").onclick = applyGraphInterval;
  $("#applyDeltaBtn").onclick    = applyDeltaMax;
  $("#adjustAllBtn").onclick     = adjustAllPrices;
}
function bindDelistActions(){
  $("#delistStartBtn").onclick = scheduleDelist;
  $("#delistCancelBtn").onclick = cancelDelist;
  $("#reviveNowBtn").onclick = reviveCompanies;
}
function subscribeDelistRealtime(){
  onSnapshot(doc(db,"marketState","main"), snap=>{
    const d = snap.data()||{};
    __delistPlan = d.delistPlan || null;
    renderDelistStatus();
  });
  onSnapshot(collection(db,"companyStatus"), snap=>{
    renderDelistedListSnap(snap);
  });
}

/* ----- íŒ¨ë„ ë“œë˜ê·¸(ì„ íƒ) ----- */
(function enableAdminDrag(){
  const panel = $("#adminPanelAll"); const header = $("#adminPanelHeader");
  if(!panel || !header) return;
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  header.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY;
    const rect = panel.getBoundingClientRect(); ox=rect.left; oy=rect.top; e.preventDefault(); });
  window.addEventListener('mousemove', (e)=>{ if(!dragging) return;
    const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; });
  window.addEventListener('mouseup', ()=> dragging=false);
})();

/* ----- ê´€ë¦¬ì ì´ˆê¸°í™” (Part 4-1ì—ì„œ í˜¸ì¶œ) ----- */
const __adminInitOnce = { done:false };
function initAdminPanelLogic(){
  // UI ë¼ˆëŒ€ ë Œë”(Part 4-1ì—ì„œ ë§Œë“  í•¨ìˆ˜ í˜¸ì¶œ)
  renderGraphPanel();
  renderUsersPanel();
  renderFinancePanel();
  renderStockPanel();
  renderChangePanelUI();
  renderNewsNoticePanel();
  renderDelistPanel();

  // ìƒì„¸ ìœ„ì ¯ ë Œë” + ì‹¤ì‹œê°„ êµ¬ë… + ë²„íŠ¼ ë°”ì¸ë”©
  renderGraphAdjustPanel();
  renderStockTuner();
  renderChangePanel();
  populateDelistSelect();

  subscribeUsersPanel();
  subscribeFinanceQueues();
  subscribeNewsAdmin();
  subscribeNoticeAdmin();
  subscribeDelistRealtime();

  bindGraphActions();
  bindDelistActions();

  showTab("graph");

  __adminInitOnce.done = true;
}
