<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
h1 { text-align: center; }
#userInfo, #log { margin: 20px auto; max-width: 800px; }
#companies {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin: 20px auto; max-width: 800px;
}
.company {
  padding: 10px; background: #1f2937; border-radius: 8px;
  display: flex; justify-content: space-between; align-items: center; gap: 10px;
}
button { padding: 5px 10px; cursor: pointer; }
#log { max-height: 220px; overflow-y: auto; background: #111827; padding: 10px; border-radius: 8px; }
canvas { background: #111827; border-radius: 8px; display: block; margin: 20px auto; }
#loginModal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
#loginModalContent { background: #1f2937; padding: 20px; border-radius: 10px; text-align: center; }
#loginModal input { margin: 10px 0; padding: 5px; width: 80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
  <button onclick="checkAdminCode()">ì‹¤í–‰</button>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (ES Module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
    authDomain: "cotyledons-of-stock.firebaseapp.com",
    projectId: "cotyledons-of-stock",
    storageBucket: "cotyledons-of-stock.appspot.com",
    messagingSenderId: "343488842605",
    appId: "1:343488842605:web:f4c1205568f5994d55e864",
    measurementId: "G-YB960D84W4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  signInAnonymously(auth).then(()=>console.log("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ"));

  let player = { holdings: {}, cash: 5000000 };
  let currentUser = null;
  let chart;
  let tradeLog = [];
  let depositRequests = []; // ë³´ë¥˜ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­

  const companies = [
    { name: "ë–¡ìë°©ë²”ëŒ€", price: 1000, history: [1000] },
    { name: "ì¹´ìŠ¤í‹¸ë¡œ", price: 500, history: [500] },
    { name: "ì‚¬ì¿ ë¼", price: 500, history: [500] },
    { name: "ì²­ë£¡", price: 500, history: [500] },
    { name: "ê²½ì°°ì²­", price: 500, history: [500] },
    { name: "EMS", price: 500, history: [500] },
    { name: "ì˜¬ë“œë³´ì´", price: 500, history: [500] },
    { name: "ì‘ë‘", price: 800, history: [800] }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    const loginModal = document.getElementById('loginModal');
    const startBtn = document.getElementById('startBtn');
    const ctx = document.getElementById('chart').getContext('2d');

    chart = new Chart(ctx,{
      type:'line',
      data:{
        labels:[0],
        datasets:companies.map(c=>({
          label:c.name,
          data:c.history,
          borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
          fill:false
        }))
      },
      options:{responsive:true,scales:{
        x:{ title:{display:true,text:'í‹±'} },
        y:{ title:{display:true,text:'ê°€ê²©(KRW)'}}
      }}
    });

    loginModal.style.display = 'flex';
    startBtn.addEventListener("click", () => {
      const userId = document.getElementById('userId').value.trim();
      const userName = document.getElementById('userName').value.trim();
      if (!userId || !userName) {
        alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
      }
      currentUser = { id: userId, name: userName };
      loginModal.style.display = "none";
      renderUserInfo();
      renderCompanies();
    });
  });

  function renderUserInfo(){
    document.getElementById('userInfo').innerHTML = `
      <strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> | 
      í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW
      <div style="margin-top:10px;">
        <input type="text" id="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥">
        <input type="number" id="depositAmount" placeholder="ê¸ˆì•¡ ì…ë ¥">
        <button onclick="requestDeposit()">ì¶”ê°€ ìš”ì²­</button>
      </div>
    `;
  }

  function requestDeposit(){
    const acc = document.getElementById("accountNumber").value.trim();
    const amt = parseInt(document.getElementById("depositAmount").value.trim());
    if(!acc || !amt || amt<=0){
      alert("ê³„ì¢Œë²ˆí˜¸ì™€ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
    }
    depositRequests.push({userId: currentUser.id, userName: currentUser.name, account: acc, amount: amt});
    alert("ì¶”ê°€ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
    document.getElementById("accountNumber").value="";
    document.getElementById("depositAmount").value="";
  }

  function log(msg){ const l=document.getElementById('log'); l.innerHTML = `<div>${msg}</div>`+l.innerHTML; }

  async function saveTrade(type, company, qty, price, cashAfter) {
    if(!currentUser) return;
    const now = new Date().toLocaleString();
    tradeLog.push({date: now, userId: currentUser.id, userName: currentUser.name,
                   type, company, qty, price, cash: cashAfter});
    await addDoc(collection(db, "trades"), {
      userId: currentUser.id, userName: currentUser.name,
      type, company, qty, price, cashAfter, createdAt: serverTimestamp()
    });
  }

  window.buy = function(name, qty){
    const c = companies.find(x=>x.name===name);
    if(player.cash < c.price*qty){ alert('í˜„ê¸ˆ ë¶€ì¡±'); return; }
    player.cash -= c.price*qty;
    player.holdings[name] = (player.holdings[name]||0)+qty;
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price}`);
    saveTrade("ë§¤ìˆ˜", name, qty, c.price, player.cash);
    renderCompanies();
  }

  window.sell = function(name, qty){
    const c = companies.find(x=>x.name===name);
    if((player.holdings[name]||0)<qty){ alert('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±'); return; }
    player.cash += c.price*qty;
    player.holdings[name]-=qty;
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price}`);
    saveTrade("ë§¤ë„", name, qty, c.price, player.cash);
    renderCompanies();
  }

  function updatePrices(){
    companies.forEach(c=>{
      const shock = (Math.random()-0.5)*0.1;
      c.price = Math.max(1, Math.floor(c.price*(1+shock)));
      c.history.push(c.price);
    });
    renderCompanies();
  }
  setInterval(updatePrices,5000);

  function updateChart(){
    if(!chart) return;
    chart.data.labels=Array.from({length:companies[0].history.length},(_,i)=>i);
    chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
    chart.update();
  }

  // ê´€ë¦¬ì ì½”ë“œ ì‹¤í–‰
  window.checkAdminCode = function(){
    const code=document.getElementById("adminCode").value.trim();

    if(code==="ADMIN123"){
      if(tradeLog.length===0){ alert("ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      const sortedLog = [...tradeLog].sort((a,b)=> new Date(b.date)-new Date(a.date));
      let csv = "ë‚ ì§œ,ê³ ìœ ë²ˆí˜¸,ì´ë¦„,íƒ€ì…,ê¸°ì—…,ê°€ê²©,ìˆ˜ëŸ‰,í˜„ê¸ˆ\n";
      sortedLog.forEach(t=>{
        csv += `${t.date},${t.userId},${t.userName},${t.type},${t.company},${t.price},${t.qty},${t.cash}\n`;
      });
      const bom=new Uint8Array([0xEF,0xBB,0xBF]);
      const blob=new Blob([bom,csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`trade_log_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      alert("ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    else if(code==="RESET123"){
      companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
      updateChart(); renderCompanies();
      alert("ê¸°ì—… ê°€ê²©/ê·¸ë˜í”„ê°€ ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    else if(code==="RESETALL"){
      player={ holdings:{}, cash:5000000 };
      companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
      currentUser=null;
      document.getElementById('loginModal').style.display="flex";
      updateChart(); renderCompanies();
      alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”)");
    }

    else if(code==="APPROVE123"){
      if(depositRequests.length===0){ alert("ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      depositRequests.forEach(req=>{
        if(currentUser && req.userId===currentUser.id){
          player.cash += req.amount;
          log(`ğŸ’° ê´€ë¦¬ì ìŠ¹ì¸: ${req.userName}(${req.userId}) ê³„ì¢Œ ${req.account} â†’ ${req.amount} KRW ì…ê¸ˆ ì™„ë£Œ`);
        }
      });
      depositRequests = [];
      renderUserInfo();
      alert("ìš”ì²­ëœ ê¸ˆì•¡ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    else {
      alert("ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.");
    }
  }
</script>
</body>
</html>
