<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>떡잎방범대 주식 센터</title>
<style>
  :root{
    --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
    --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
  }
  *{box-sizing:border-box}
  body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
  h1 { text-align:center; margin:4px 0 16px }

  /* ✅ 그래프 고정 */
  #chartWrap {
    margin:20px auto;
    max-width:1100px;
    height:400px;          /* 높이 고정 */
    background:#111827;
    border-radius:10px;
    overflow:hidden;
  }
  #chart {
    width:100% !important;
    height:100% !important;
  }

  /* 기업 카드 */
  #companies {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:12px;
    margin:20px auto;
    max-width:1100px;
  }
  .company {
    background:var(--card);
    border-radius:10px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .company .info { display:flex; justify-content:space-between; align-items:center; font-weight:600; }
  .company .info small{ color:var(--ink2); font-weight:400 }
  .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  .company .actions input[type="number"] {
    grid-column:span 2; padding:8px;
    border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink);
  }

  /* 로그창 */
  #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }

  /* 모달/관리자 */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
  .modal-content { background:var(--card); padding:20px; border-radius:10px; text-align:center; width:min(90%,440px); }
  .modal-content input { margin:8px 0; padding:8px; width:85%; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
  .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:10px; border-radius:10px; position:relative;}
  .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<!-- 그래프 -->
<div id="chartWrap"><canvas id="chart"></canvas></div>

<!-- 기업 카드 -->
<div id="companies"></div>

<!-- 로그 -->
<div id="log"></div>

<!-- 관리자 로그인 -->
<div id="adminLogin" style="text-align:center;margin-top:20px;">
  <input type="password" id="adminCode" placeholder="관리자 코드 입력">
  <button onclick="checkAdmin()">관리자 로그인</button>
</div>

<!-- 관리자 패널 예시 -->
<div id="adminPanelGraph" class="admin-panel">
  <button class="xbtn" onclick="closeAdmin('adminPanelGraph')">✕</button>
  <h3>📊 그래프 제어 패널</h3>
  <div>
    <button onclick="startPriceSimulation()">시작</button>
    <button onclick="stopPriceSimulation()">정지</button>
    <button onclick="resetGraph()">초기화</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const companies = [
  {name:"떡잎방범대", basePrice:1000, livePrice:1000},
  {name:"카스틸로", basePrice:500, livePrice:500},
  {name:"사쿠라", basePrice:500, livePrice:500},
  {name:"청룡", basePrice:500, livePrice:500},
  {name:"경찰청", basePrice:500, livePrice:500},
  {name:"Ems", basePrice:500, livePrice:500},
  {name:"올드보이", basePrice:500, livePrice:500},
  {name:"작두", basePrice:800, livePrice:800},
  {name:"빅딕", basePrice:700, livePrice:700},
  {name:"유토피아", basePrice:600, livePrice:600},
  {name:"inback", basePrice:550, livePrice:550},
];

let chart=null;
function initChart(){
  if(chart) return;
  const ctx=document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:[],
      datasets:companies.map(c=>({ label:c.name, data:[], borderWidth:2, fill:false }))
    },
    options:{
      responsive:false,           // ✅ 반응형 꺼짐
      maintainAspectRatio:false,  // ✅ 비율 무시
      animation:false,
      plugins:{ legend:{position:"bottom"} },
      scales:{
        x:{ title:{display:true,text:"시간"} },
        y:{ 
          title:{display:true,text:"가격(KRW)"}, 
          min:0, max:2000         // ✅ Y축 범위 고정
        }
      }
    }
  });
}
function appendChartPoint(){
  if(!chart) return;
  const now=new Date().toLocaleTimeString();
  chart.data.labels.push(now);
  companies.forEach((c,i)=>chart.data.datasets[i].data.push(c.livePrice));
  if(chart.data.labels.length>50){
    chart.data.labels.shift();
    chart.data.datasets.forEach(d=>d.data.shift());
  }
  chart.update();
}

/* 그래프 시뮬레이션 */
let timer=null;
function updatePrices(){
  companies.forEach(c=>{
    const change=(Math.random()-0.5)*50;
    c.livePrice=Math.max(0,c.livePrice+change);
    setDoc(doc(db,"companyPrices",c.name),{current:c.livePrice},{merge:true});
  });
  appendChartPoint();
}
function startPriceSimulation(){
  if(timer) return;
  timer=setInterval(updatePrices,2000);
}
function stopPriceSimulation(){
  clearInterval(timer); timer=null;
}
function resetGraph(){
  if(chart){
    chart.data.labels=[]; chart.data.datasets.forEach(d=>d.data=[]);
    chart.update();
  }
}

window.onload=()=>{ initChart(); };
</script>
</body>
</html>
