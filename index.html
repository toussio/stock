<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userInfo,#depositSection,#log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.company div { flex:1; }
button { padding:5px 10px; cursor:pointer; margin-top:4px; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }

/* ê´€ë¦¬ì ëª¨ë‹¬ */
#adminModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModalContent { background:#1f2937; padding:20px; border-radius:10px; width:560px; max-height:85%; overflow:auto; position:relative; }
#adminModalContent h2 { margin:10px 0; }
.requestBox { margin-bottom:10px; padding:10px; background:#111827; border-radius:6px; }
#adminModalContent .closeBtn { position:absolute; top:10px; right:10px; background:none; border:none; color:#e5e7eb; font-size:18px; cursor:pointer; }
.graphRow { display:flex; align-items:center; gap:8px; padding:8px; background:#111827; border-radius:6px; margin-bottom:8px; }
.graphRow .name { width:120px; font-weight:bold; }
.graphRow input[type="number"] { width:120px; padding:4px; text-align:right; }
.graphControls { display:flex; gap:8px; margin:8px 0 12px; align-items:center; flex-wrap:wrap; }
.small { font-size:12px; color:#9ca3af; }
hr { border:0; border-top:1px solid #374151; margin:14px 0; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>

<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥" />
  <input type="number" id="depositAmount" placeholder="ê¸ˆì•¡ ì…ë ¥" />
  <button id="depositBtn">ì¶”ê°€ ìš”ì²­</button>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br />
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br />
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ (ADMIN123 / GRAPHSTART / GRAPHSTOP / SEED123)" />
  <button onclick="checkAdminCode()">ì‹¤í–‰</button>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ (ì…ê¸ˆìš”ì²­ + ê·¸ë˜í”„ ì œì–´) -->
<div id="adminModal">
  <div id="adminModalContent">
    <button class="closeBtn" onclick="closeAdminModal()">âœ–</button>
    <h2>ì…ê¸ˆ ìš”ì²­ ê´€ë¦¬</h2>
    <div id="requestsList"></div>
    <hr/>
    <h2>ê·¸ë˜í”„ ì œì–´(ì¤‘ì•™)</h2>
    <div class="small">ëª¨ë“  ê¸°ì—…ì´ ë™ì‹œì— ê°±ì‹ ë©ë‹ˆë‹¤. multiplier(ë°°ìœ¨)ë¡œ ë³€ë™í­ì„ ê¸°ì—…ë³„ë¡œ ì¡°ì •í•˜ì„¸ìš”.</div>
    <div class="graphControls">
      <label>ì „ì—­ ê°„ê²©(ms):
        <input type="number" id="globalInterval" value="5000" min="1000" step="500" />
      </label>
      <button id="startGraphBtn">ì‹œì‘</button>
      <button id="stopGraphBtn">ì¤‘ì§€</button>
    </div>
    <div id="graphControl"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
/* ========== Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ========== ìƒíƒœ ========== */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart, chartInited=false;

/* ê¸°ì—… ëª©ë¡ + multiplier(ë°°ìœ¨) */
let companies = [
  { name:"ë–¡ìë°©ë²”ëŒ€", price:5000, history:[5000], multiplier:10.0 },
  { name:"ì¹´ìŠ¤í‹¸ë¡œ",   price:500,  history:[500],  multiplier:1.5 },
  { name:"ì‚¬ì¿ ë¼",     price:500,  history:[500],  multiplier:0.8 },
  { name:"ì²­ë£¡",       price:500,  history:[500],  multiplier:2.0 },
  { name:"ê²½ì°°ì²­",     price:500,  history:[500],  multiplier:1.2 },
  { name:"EMS",        price:500,  history:[500],  multiplier:0.6 },
  { name:"ì˜¬ë“œë³´ì´",   price:500,  history:[500],  multiplier:1.8 },
  { name:"ì‘ë‘",       price:800,  history:[800],  multiplier:1.0 }
];

/* ì¤‘ì•™ ëœë¤ ë³€ë™ (ë™ì‹œ ê°±ì‹ ) ì œì–´ */
let isGraphMaster = false;
let masterTimer   = null;

/* ========== ê³µí†µ UI ========== */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML = `
    <strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> |
    í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW
    <button style="margin-left:8px" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;
}
function log(msg){
  const l=document.getElementById('log');
  l.innerHTML = `<div>${msg}</div>` + l.innerHTML;
}

/* ========== ë¡œê·¸ì¸/ìœ ì € ========== */
async function loginUser(userId, userName){
  // ìœ ì € ìƒì„±/ë¡œë“œ
  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const data = snap.data();
    player = { cash: data.cash ?? 5000000, holdings: data.holdings ?? {} };
  } else {
    await setDoc(ref, { id:userId, name:userName, cash:5000000, holdings:{} });
    player = { cash:5000000, holdings:{} };
  }
  currentUser = { id:userId, name:userName };
  renderUserInfo();
  renderCompanies();
  ensureChart();

  // companies ì—†ìœ¼ë©´ ìë™ ì‹œë“œ
  await ensureCompaniesSeed();

  // ëª¨ë“  ìœ ì € â†’ ê¸°ì—… êµ¬ë… (ë™ì¼ ê·¸ë˜í”„)
  subscribeCompanies();
}
async function syncUserData(){
  if(!currentUser) return;
  await updateDoc(doc(db, "users", currentUser.id), {
    cash: player.cash,
    holdings: player.holdings
  });
}

/* ========== ê¸°ì—…/ì°¨íŠ¸ UI ========== */
function renderCompanies(){
  const container=document.getElementById('companies');
  container.innerHTML='';
  companies.forEach(c=>{
    const held=player.holdings[c.name]||0;
    const div=document.createElement('div');
    div.className='company';
    div.innerHTML=`
      <div>
        <strong>${c.name}</strong><br/>
        ê°€ê²©: <span id="price-${c.name}">${c.price.toLocaleString()}</span> KRW<br/>
        ë³´ìœ : <span id="holding-${c.name}">${held}</span>ì£¼
      </div>
      <div style="text-align:right;">
        <input type="number" id="qty-${c.name}" value="1" min="1"
               style="min-width:60px; max-width:100px; text-align:right; margin-bottom:5px;">
        <div style="display:flex; gap:5px; justify-content:flex-end;">
          <button onclick="buy('${c.name}')">ë§¤ìˆ˜</button>
          <button onclick="sell('${c.name}')">ë§¤ë„</button>
        </div>
      </div>`;
    container.appendChild(div);
  });
  updateChart();
  renderUserInfo();
}
function ensureChart(){
  if(chartInited) return;
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data: {
      labels:[0],
      datasets: companies.map(c=>({
        label:c.name,
        data:c.history,
        borderColor:'#' + Math.floor(Math.random()*16777215).toString(16),
        fill:false
      }))
    },
    options:{
      responsive:true, animation:false,
      scales:{ x:{title:{display:true,text:"í‹±"}}, y:{title:{display:true,text:"ê°€ê²©(KRW)"}} }
    }
  });
  chartInited = true;
}
function updateChart(){
  if(!chartInited) return;
  const maxLen = Math.max(...companies.map(c => c.history.length));
  chart.data.labels = Array.from({length:maxLen}, (_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data = companies[i].history; });
  chart.update();
}

/* ========== ë§¤ìˆ˜/ë§¤ë„ ========== */
window.buy = async function(name){
  const qty = Math.max(1, parseInt(document.getElementById(`qty-${name}`).value,10) || 1);
  const c = companies.find(x=>x.name===name);
  if(player.cash < c.price*qty){ alert('í˜„ê¸ˆ ë¶€ì¡±'); return; }
  player.cash -= c.price*qty;
  player.holdings[name] = (player.holdings[name]||0) + qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price}`);
  await syncUserData();
  const holdingSpan=document.getElementById(`holding-${c.name}`);
  if(holdingSpan) holdingSpan.textContent = player.holdings[c.name];
  renderUserInfo();
}
window.sell = async function(name){
  const qty = Math.max(1, parseInt(document.getElementById(`qty-${name}`).value,10) || 1);
  const c = companies.find(x=>x.name===name);
  if((player.holdings[name]||0) < qty){ alert('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±'); return; }
  player.cash += c.price*qty;
  player.holdings[name] -= qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price}`);
  await syncUserData();
  const holdingSpan=document.getElementById(`holding-${c.name}`);
  if(holdingSpan) holdingSpan.textContent = player.holdings[c.name];
  renderUserInfo();
}

/* ========== ì…ê¸ˆ ìš”ì²­(ìœ ì €) ========== */
document.getElementById("depositBtn").addEventListener("click", ()=>{
  const acc = document.getElementById("accountNumber").value.trim();
  const amt = parseInt(document.getElementById("depositAmount").value,10);
  if(!currentUser){ alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”."); return; }
  if(!acc || !amt || amt<=0){ alert("ê³„ì¢Œë²ˆí˜¸/ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”."); return; }
  alert("í˜„ê¸ˆì¶”ê°€ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ê²Œì„ ë¨¸ë‹ˆ ì§€ë¶ˆ í›„ ë³€ë™ë©ë‹ˆë‹¤");

  addDoc(collection(db,"depositRequests"),{
    userId: currentUser.id,
    userName: currentUser.name,
    account: acc,
    amount: amt,
    createdAt: serverTimestamp()
  });

  // ì…ë ¥ì¹¸ ì´ˆê¸°í™”
  document.getElementById("accountNumber").value = "";
  document.getElementById("depositAmount").value = "";
});

/* ========== ê´€ë¦¬ì: ì½”ë“œ ì²˜ë¦¬ ========== */
window.checkAdminCode = async function(){
  const code = document.getElementById("adminCode").value.trim();
  if(code === "ADMIN123"){
    await loadDepositRequests();
    renderGraphControlPanel();
    document.getElementById("adminModal").style.display = "flex";
  } else if(code === "SEED123"){
    await seedCompanies(true);
    alert("companies ì‹œë“œ ì™„ë£Œ(ì´ë¯¸ ìˆë˜ ë¬¸ì„œëŠ” ë®ì–´ì”ë‹ˆë‹¤).");
  } else if(code === "GRAPHSTART"){
    startCentralUpdates();
  } else if(code === "GRAPHSTOP"){
    stopCentralUpdates();
  } else {
    alert("ì•Œ ìˆ˜ ì—†ëŠ” ì½”ë“œì…ë‹ˆë‹¤.");
  }
}

/* ========== ê´€ë¦¬ì: ì…ê¸ˆìš”ì²­ ê´€ë¦¬ ========== */
async function loadDepositRequests(){
  const q = await getDocs(collection(db,"depositRequests"));
  const list = document.getElementById("requestsList");
  list.innerHTML = "";
  q.forEach(docSnap=>{
    const r = docSnap.data();
    const div = document.createElement("div");
    div.className = "requestBox";
    div.id = "req-"+docSnap.id;
    div.innerHTML = `
      <strong>${r.userName}(${r.userId})</strong><br/>
      ê³„ì¢Œ: ${r.account}<br/>
      ê¸ˆì•¡: ${Number(r.amount||0).toLocaleString()} KRW<br/>
      <button onclick="approveRequest('${docSnap.id}','${r.userId}',${Number(r.amount||0)})">ìŠ¹ì¸</button>
      <button onclick="rejectRequest('${docSnap.id}')">ê±°ì ˆ</button>
    `;
    list.appendChild(div);
  });
}
window.approveRequest = async function(reqId, userId, amount){
  const userRef = doc(db,"users",userId);
  const snap = await getDoc(userRef);
  if(snap.exists()){
    const data = snap.data();
    await updateDoc(userRef, { cash: (data.cash||0) + amount });
  }
  await addDoc(collection(db,"depositHistory"),{
    userId, amount, status:"approved", processedAt:serverTimestamp()
  });
  await deleteDoc(doc(db,"depositRequests",reqId));
  const el = document.getElementById("req-"+reqId);
  if(el) el.remove();
}
window.rejectRequest = async function(reqId){
  await addDoc(collection(db,"depositHistory"),{
    requestId:reqId, status:"rejected", processedAt:serverTimestamp()
  });
  await deleteDoc(doc(db,"depositRequests",reqId));
  const el = document.getElementById("req-"+reqId);
  if(el) el.remove();
}
window.closeAdminModal = function(){ document.getElementById("adminModal").style.display="none"; }

/* ========== ê´€ë¦¬ì: ê·¸ë˜í”„ ì œì–´(ë™ì‹œ ê°±ì‹  + ë°°ìœ¨) ========== */
function renderGraphControlPanel(){
  const panel = document.getElementById("graphControl");
  panel.innerHTML = "";
  companies.forEach(c=>{
    const row=document.createElement("div");
    row.className="graphRow";
    row.innerHTML = `
      <span class="name">${c.name}</span>
      multiplier: <input type="number" id="multi-${c.name}" value="${c.multiplier}" step="0.1" />
      <button onclick="saveMultiplier('${c.name}')">ì €ì¥</button>
    `;
    panel.appendChild(row);
  });
  document.getElementById("startGraphBtn").onclick = startCentralUpdates;
  document.getElementById("stopGraphBtn").onclick = stopCentralUpdates;
}
window.saveMultiplier = async function(name){
  const input = document.getElementById(`multi-${name}`);
  const val = parseFloat(input.value);
  if(!(val>0)){ alert("ë°°ìœ¨ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤."); return; }
  const c = companies.find(x=>x.name===name);
  if(c) c.multiplier = val;
  // Firestoreì—ë„ ì €ì¥(ì—†ì–´ë„ ë¬´ë°©í•˜ë‚˜ ê´€ë¦¬ í¸ì˜ë¥¼ ìœ„í•´)
  const ref = doc(db,"companies",name);
  const snap = await getDoc(ref);
  if(snap.exists()){
    await updateDoc(ref, { multiplier: val });
  } else {
    await setDoc(ref, { price:c?.price||1000, history:c?.history||[1000], multiplier: val });
  }
  alert(`${name} multiplier ì €ì¥ë¨: ${val}`);
}

/* ì „ì—­ ê°„ê²©(ms) ì½ê¸° */
function getGlobalIntervalMs(){
  const v = parseInt(document.getElementById("globalInterval").value,10);
  return (!isNaN(v) && v>=1000) ? v : 5000;
}

/* ëª¨ë“  ê¸°ì—…ì„ "ë™ì‹œì—" ê°±ì‹  */
async function updateAllCompaniesOnce(){
  for(const c of companies){
    const ref = doc(db,"companies",c.name);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data();
      const basePrice = Number(data.price)||1;
      const mult = (typeof data.multiplier === "number") ? data.multiplier : (c.multiplier||1);
      const shock = (Math.random()-0.5)*0.1; // ê¸°ë³¸ Â±10%
      const newPrice = Math.max(1, Math.floor(basePrice * (1 + shock * mult)));
      let history = Array.isArray(data.history) ? [...data.history] : [basePrice];
      history.push(newPrice);
      const MAX_LEN = 300;
      if(history.length > MAX_LEN) history = history.slice(history.length - MAX_LEN);
      await updateDoc(ref, { price:newPrice, history, multiplier: mult });
    } else {
      // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ì‹œë“œ ìƒì„±
      await setDoc(ref, { price:c.price, history:c.history, multiplier:c.multiplier });
    }
  }
}

/* ì¤‘ì•™ ëœë¤ ë³€ë™ ì‹œì‘/ì¤‘ì§€ (í•œ íƒ€ì´ë¨¸ë¡œ ì „ì²´ ë™ì‹œ ê°±ì‹ ) */
function startCentralUpdates(){
  if(isGraphMaster){ alert("ì´ë¯¸ ì‹¤í–‰ì¤‘ì…ë‹ˆë‹¤."); return; }
  const ms = getGlobalIntervalMs();
  isGraphMaster=true;
  masterTimer = setInterval(updateAllCompaniesOnce, ms);
  alert(`ì¤‘ì•™ ëœë¤ ë³€ë™ ì‹œì‘ (ê°„ê²©: ${ms}ms, ë™ì‹œ ê°±ì‹ )`);
}
function stopCentralUpdates(){
  if(masterTimer){ clearInterval(masterTimer); masterTimer=null; }
  isGraphMaster=false;
  alert("ì¤‘ì•™ ëœë¤ ë³€ë™ ì¤‘ì§€");
}

/* ========== Firestore ì´ˆê¸° ì‹œë“œ/êµ¬ë… ========== */
async function ensureCompaniesSeed(){
  for(const c of companies){
    const ref = doc(db,"companies",c.name);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{ price:c.price, history:c.history, multiplier:c.multiplier });
    } else {
      const data = snap.data();
      if(typeof data.multiplier !== "number"){
        await updateDoc(ref,{ multiplier: c.multiplier });
      }
    }
  }
}
async function seedCompanies(force=false){
  for(const c of companies){
    const ref = doc(db,"companies",c.name);
    if(force){
      await setDoc(ref,{ price:c.price, history:c.history, multiplier:c.multiplier });
    } else {
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{ price:c.price, history:c.history, multiplier:c.multiplier });
      }
    }
  }
}
function subscribeCompanies(){
  companies.forEach(c=>{
    onSnapshot(doc(db,"companies",c.name),(snap)=>{
      if(snap.exists()){
        const data = snap.data();
        c.price = data.price;
        c.history = data.history || [c.price];
        if(typeof data.multiplier === "number") c.multiplier = data.multiplier;

        const priceEl = document.getElementById(`price-${c.name}`);
        if(priceEl) priceEl.textContent = c.price.toLocaleString();
        updateChart();
      }
    });
  });
}

/* ========== ë¡œê·¸ì•„ì›ƒ ========== */
window.logout = function(){
  currentUser = null; player = { holdings:{}, cash:5000000 };
  document.getElementById('loginModal').style.display="flex";
  renderUserInfo(); renderCompanies();
  log("ğŸšª ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/* ========== ì´ˆê¸° ë°”ì¸ë”© ========== */
document.addEventListener("DOMContentLoaded", ()=>{
  // ì°¨íŠ¸ ì¤€ë¹„ëŠ” ë¡œê·¸ì¸ í›„ ensureChartì—ì„œ
  document.getElementById("startBtn").addEventListener("click", async ()=>{
    const userId = document.getElementById("userId").value.trim();
    const userName = document.getElementById("userName").value.trim();
    if(!userId || !userName){ alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    await loginUser(userId, userName);
    document.getElementById("loginModal").style.display="none";
  });

  // ê´€ë¦¬ì ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ì€ renderGraphControlPanelì—ì„œ ë°”ì¸ë”©
});
</script>
</body>
</html>




