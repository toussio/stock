<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 20px; }
h1 { text-align: center; }
#userInfo, #log { margin: 20px auto; max-width: 800px; }
#companies {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin: 20px auto; max-width: 800px;
}
.company {
  padding: 10px; background: #1f2937; border-radius: 8px;
  display: flex; justify-content: space-between; align-items: center; gap: 10px;
}
button { padding: 5px 10px; cursor: pointer; }
#log { max-height: 220px; overflow-y: auto; background: #111827; padding: 10px; border-radius: 8px; }
canvas { background: #111827; border-radius: 8px; display: block; margin: 20px auto; }
#loginModal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
#loginModalContent { background: #1f2937; padding: 20px; border-radius: 10px; text-align: center; }
#loginModal input { margin: 10px 0; padding: 5px; width: 80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<div id="userInfo"></div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>ê±°ë˜ ì‹œì‘ ì „ ì •ë³´ ì…ë ¥</h2>
    <input type="text" id="userId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥" /><br>
    <input type="text" id="userName" placeholder="ì´ë¦„ ì…ë ¥" /><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ì„¹ì…˜ -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
  <button onclick="checkAdminCode()">ì‹¤í–‰</button>
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let player = { holdings: {}, cash: 5000000 };
let currentUser = null;
let chart;
let tradeLog = [];

// ê¸°ì—… ë°ì´í„°
const companies = [
  { name: "ë–¡ìë°©ë²”ëŒ€", price: 1000, history: [1000] },
  { name: "ì¹´ìŠ¤í‹¸ë¡œ", price: 500, history: [500] },
  { name: "ì‚¬ì¿ ë¼", price: 500, history: [500] },
  { name: "ì²­ë£¡", price: 500, history: [500] },
  { name: "ê²½ì°°ì²­", price: 500, history: [500] },
  { name: "EMS", price: 500, history: [500] },
  { name: "ì˜¬ë“œë³´ì´", price: 500, history: [500] },
  { name: "ì‘ë‘", price: 800, history: [800] }
];

// í˜ì´ì§€ ë¡œë“œ ì‹œ localStorage í™•ì¸
document.addEventListener("DOMContentLoaded", () => {
  const savedUser = localStorage.getItem("currentUser");
  const savedPlayer = localStorage.getItem("player");
  const ctx = document.getElementById('chart').getContext('2d');

  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels:[0],
      datasets:companies.map(c=>({
        label:c.name,
        data:c.history,
        borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
        fill:false
      }))
    },
    options:{responsive:true,scales:{
      x:{ title:{display:true,text:'í‹±'} },
      y:{ title:{display:true,text:'ê°€ê²©(KRW)'}}
    }}
  });

  if(savedUser && savedPlayer){
    currentUser = JSON.parse(savedUser);
    player = JSON.parse(savedPlayer);
    renderUserInfo();
    renderCompanies();
  } else {
    document.getElementById('loginModal').style.display = 'flex';
  }

  document.getElementById('startBtn').addEventListener("click", () => {
    const userId = document.getElementById('userId').value.trim();
    const userName = document.getElementById('userName').value.trim();
    if (!userId || !userName) {
      alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
    }
    currentUser = { id: userId, name: userName };
    player = { holdings:{}, cash:5000000 };
    saveState();
    document.getElementById('loginModal').style.display = "none";
    renderUserInfo();
    renderCompanies();
  });
});

function saveState(){
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  localStorage.setItem("player", JSON.stringify(player));
}

function renderUserInfo(){
  document.getElementById('userInfo').innerHTML =
    `<strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> | í˜„ê¸ˆ: ${player.cash.toLocaleString()} KRW`;
}

function renderCompanies() {
  const container = document.getElementById('companies');
  container.innerHTML = '';
  companies.forEach(c => {
    const held = player.holdings[c.name] || 0;
    const div = document.createElement('div');
    div.className = 'company';
    div.innerHTML = `
      <div><strong>${c.name}</strong> ${c.price.toLocaleString()} KRW | ë³´ìœ : ${held}ì£¼</div>
      <div>
        <button onclick="buy('${c.name}',1)">ë§¤ìˆ˜</button>
        <button onclick="sell('${c.name}',1)">ë§¤ë„</button>
      </div>
    `;
    container.appendChild(div);
  });
  updateChart(); renderUserInfo();
}

function log(msg){ const l=document.getElementById('log'); l.innerHTML = `<div>${msg}</div>`+l.innerHTML; }

window.buy = function(name, qty){
  const c = companies.find(x=>x.name===name);
  if(player.cash < c.price*qty){ alert('í˜„ê¸ˆ ë¶€ì¡±'); return; }
  player.cash -= c.price*qty;
  player.holdings[name] = (player.holdings[name]||0)+qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${c.price}`);
  saveState();
  renderCompanies();
}

window.sell = function(name, qty){
  const c = companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<qty){ alert('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±'); return; }
  player.cash += c.price*qty;
  player.holdings[name]-=qty;
  log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${c.price}`);
  saveState();
  renderCompanies();
}

function updatePrices(){
  companies.forEach(c=>{
    const shock = (Math.random()-0.5)*0.1;
    c.price = Math.max(1, Math.floor(c.price*(1+shock)));
    c.history.push(c.price);
  });
  renderCompanies();
}
setInterval(updatePrices,5000);

function updateChart(){
  if(!chart) return;
  chart.data.labels=Array.from({length:companies[0].history.length},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

// ë¡œê·¸ì•„ì›ƒ
function logout(){
  localStorage.removeItem("currentUser");
  localStorage.removeItem("player");
  currentUser = null;
  player = { holdings:{}, cash:5000000 };
  document.getElementById('loginModal').style.display="flex";
  renderUserInfo();
  renderCompanies();
  log("ğŸšª ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ê´€ë¦¬ì ì½”ë“œ ì‹¤í–‰
window.checkAdminCode = function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code==="ADMIN123"){
    if(tradeLog.length===0){ alert("ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„ë¨");
  }
  else if(code==="RESET123"){
    companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
    updateChart(); renderCompanies();
    alert("ê¸°ì—… ê°€ê²©/ê·¸ë˜í”„ê°€ ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  else if(code==="RESETALL"){
    localStorage.clear();
    player={ holdings:{}, cash:5000000 };
    companies.forEach(c=>{ c.price=1000; c.history=[1000]; });
    currentUser=null;
    document.getElementById('loginModal').style.display="flex";
    updateChart(); renderCompanies();
    alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”)");
  }
  else {
    alert("ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.");
  }
}
</script>
</body>
</html>
