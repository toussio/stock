<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1{text-align:center;} #userRow,#log{margin:20px auto; max-width:800px;}
#userRow{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;justify-content:space-between;}
#userInfo{font-size:16px;} #depositForm{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
#depositForm input{padding:6px;} #depositForm .memo{min-width:200px;}
#companies{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:20px auto;max-width:800px;}
.company{padding:10px;background:#1f2937;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
.company .left{display:flex;flex-direction:column;gap:6px;} .company .actions{display:flex;gap:6px;align-items:center;}
button{padding:5px 10px;cursor:pointer;} #log{max-height:220px;overflow-y:auto;background:#111827;padding:10px;border-radius:8px;}
canvas{background:#111827;border-radius:8px;display:block;margin:20px auto;}
#downloadSection{text-align:center;margin-top:20px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
#downloadSection input{padding:5px;} #adminQueue{max-width:800px;margin:14px auto 0;display:none;}
#adminQueue.active{display:block;} .req-card{background:#1f2937;border-radius:8px;padding:10px;margin:8px 0;
display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;}
.req-meta{font-size:12px;opacity:.9;} .req-actions button{margin-left:6px;}
.badge{padding:2px 6px;border-radius:6px;font-size:12px;} .badge.wait{background:#374151;}
.badge.approved{background:#065f46;} .badge.rejected{background:#7f1d1d;}
/* 로그인 모달 */
#loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;}
#loginModalContent{background:#1f2937;padding:20px;border-radius:10px;text-align:center;}
#loginModal input{margin:8px 0;padding:6px;width:80%;}
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<div id="userRow">
  <div id="userInfo">⏳ 로그인 대기중...</div>
  <div>
    <button onclick="logout()">로그아웃</button>
  </div>
</div>

<div id="depositForm">
  <input id="acctNo" type="text" placeholder="인게임 계좌번호 (예: ACC-00123)">
  <input id="cashAmount" type="text" placeholder="금액 (예: 1000000)">
  <input id="cashMemo" type="text" class="memo" placeholder="메모 (선택)">
  <button onclick="requestDeposit()">입금 요청</button>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<div id="downloadSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 (ADMIN123)" />
  <button onclick="toggleAdminQueue()">승인 대기함 열기</button>
</div>

<div id="adminQueue">
  <h3>입금 승인 대기함</h3>
  <div id="queueList"></div>
</div>

<!-- 로그인 모달 -->
<div id="loginModal" style="display:none;">
  <div id="loginModalContent">
    <h2>정보 입력 후 시작</h2>
    <input type="text" id="customId" placeholder="고유번호 입력" /><br>
    <input type="text" id="customName" placeholder="이름 입력" /><br>
    <button id="startBtn">시작</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { 
    initializeFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, setDoc, query, where 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut, deleteUser } 
    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
    authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
    projectId: "cotyledons-of-stock-a1241",
    storageBucket: "cotyledons-of-stock-a1241.appspot.com",
    messagingSenderId: "962984742513",
    appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
    measurementId: "G-NRPT075Q3X"
  };

  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, { experimentalForceLongPolling: true, useFetchStreams: false });
  const auth = getAuth(app);

  let player = { holdings: {}, cash: 5000000 };
  let currentUser = null;
  let pendingDeposits = [];

  /* ===== 항상 새로운 익명 계정 발급 ===== */
  async function newAnonymousLogin(){
    if(auth.currentUser){
      try { await deleteUser(auth.currentUser); } catch(e){ console.warn("삭제 실패:", e); }
      await signOut(auth);
    }
    return signInAnonymously(auth);
  }
  newAnonymousLogin().catch(err => console.error("익명 로그인 실패:", err));

  onAuthStateChanged(auth, (user) => {
    if(user){
      document.getElementById("loginModal").style.display="flex";

      document.getElementById("startBtn").onclick = async () => {
        const customId = document.getElementById("customId").value.trim();
        const customName = document.getElementById("customName").value.trim();
        if(!customId || !customName){ alert("고유번호와 이름을 모두 입력하세요."); return; }

        // 🔎 같은 고유번호가 active=true 인지 체크
        const qSnap = await getDocs(query(collection(db,"users"), where("id","==",customId), where("active","==",true)));
        if(!qSnap.empty){
          alert("❌ 이미 다른 곳에서 사용 중인 계정입니다.");
          return;
        }

        currentUser = { uid:user.uid, id:customId, name:customName, cash:player.cash };

        await setDoc(doc(db, "users", user.uid), {
          uid: user.uid, id: customId, name: customName, cash: player.cash,
          active: true, createdAt: new Date()
        });

        document.getElementById("loginModal").style.display="none";
        renderUserInfo(); renderCompanies(); startAuto(); listenDeposits();
        log(`✅ 로그인 완료: ${customName} (${customId})`);
      };
    }
  });

  /* ===== 로그아웃 ===== */
  async function logout(){
    if(currentUser){
      await updateDoc(doc(db,"users", currentUser.uid), { active:false });
    }
    if(auth.currentUser){
      try { await deleteUser(auth.currentUser); } catch(e){ console.log("이미 삭제됨:", e); }
      await signOut(auth);
    }
    location.reload();
  }
  window.logout = logout;

  /* ===== 공통 함수 ===== */
  function log(msg){ document.getElementById('log').innerHTML = `<div>${msg}</div>`+document.getElementById('log').innerHTML; }
  function renderUserInfo(){ if(currentUser) document.getElementById('userInfo').innerHTML = `<strong>${currentUser.name}(${currentUser.id})</strong> | 현금: ${player.cash.toLocaleString()} KRW`; }
  async function saveTradeLog(entry){ await addDoc(collection(db,"tradeLogs"), entry); }

  /* ===== 기업 리스트 ===== */
  const companies = [
    { name: "떡잎방범대", price: 1000, history: [1000], cfg:{vol:0.03,drift:0.002,jumpProb:0.01,jumpVol:0.10,min:1}},
    { name: "카스틸로", price: 500, history: [500], cfg:{vol:0.06,drift:-0.001,jumpProb:0.02,jumpVol:0.20,min:1}},
    { name: "사쿠라", price: 500, history: [500], cfg:{vol:0.04,drift:0.000,jumpProb:0.00,jumpVol:0.00,min:1}},
    { name: "청룡", price: 500, history: [500], cfg:{vol:0.08,drift:0.003,jumpProb:0.03,jumpVol:0.25,min:1}},
    { name: "경찰청", price: 500, history: [500], cfg:{vol:0.02,drift:0.001,jumpProb:0.00,jumpVol:0.00,min:1}},
    { name: "EMS", price: 500, history: [500], cfg:{vol:0.05,drift:-0.002,jumpProb:0.01,jumpVol:0.15,min:1}},
    { name: "올드보이", price: 500, history: [500], cfg:{vol:0.07,drift:0.000,jumpProb:0.02,jumpVol:0.30,min:1}},
    { name: "작두", price: 800, history: [800], cfg:{vol:0.10,drift:0.004,jumpProb:0.05,jumpVol:0.40,min:1}}
  ];

  function renderCompanies(){ 
    const ctn=document.getElementById("companies"); ctn.innerHTML=""; 
    companies.forEach(c=>{
      const held=player.holdings[c.name]||0; 
      const div=document.createElement("div"); div.className="company"; 
      div.innerHTML=`<div class="left"><strong>${c.name}</strong> ${c.price.toLocaleString()} KRW | 보유: ${held}주</div><div class="actions"><button onclick="buy('${c.name}',1)">매수</button><button onclick="sell('${c.name}',1)">매도</button></div>`; 
      ctn.appendChild(div);
    }); 
    renderUserInfo();
  }
  function startAuto(){ setInterval(()=>{companies.forEach(c=>{let shock=(Math.random()*2-1)*c.cfg.vol+c.cfg.drift; if(Math.random()<c.cfg.jumpProb)shock+=(Math.random()*2-1)*c.cfg.jumpVol; c.price=Math.max(c.cfg.min,Math.floor(c.price*(1+shock))); c.history.push(c.price);}); renderCompanies();},5000);}

  /* ===== 매수/매도 ===== */
  function buy(name, qty){ const c=companies.find(x=>x.name===name); if(player.cash<c.price*qty){alert("현금 부족"); return;} player.cash-=c.price*qty; player.holdings[name]=(player.holdings[name]||0)+qty; const entry={date:new Date().toLocaleString(), uid:currentUser.uid, userId:currentUser.id, userName:currentUser.name, type:"매수", company:name, qty, price:c.price, amount:c.price*qty, cash:player.cash}; saveTradeLog(entry); log(`✅ 매수: ${name} ${qty}주 @ ${c.price}`); renderCompanies(); }
  function sell(name, qty){ const c=companies.find(x=>x.name===name); if((player.holdings[name]||0)<qty){alert("보유 부족"); return;} player.cash+=c.price*qty; player.holdings[name]-=qty; const entry={date:new Date().toLocaleString(), uid:currentUser.uid, userId:currentUser.id, userName:currentUser.name, type:"매도", company:name, qty, price:c.price, amount:c.price*qty, cash:player.cash}; saveTradeLog(entry); log(`✅ 매도: ${name} ${qty}주 @ ${c.price}`); renderCompanies(); }

  /* ===== 입금 ===== */
  async function requestDeposit(){
    if(!currentUser){ alert("로그인 필요"); return; }
    const acct=acctNo.value.trim(); const amount=parseInt(cashAmount.value.replace(/[^0-9]/g,''))||0; const memo=cashMemo.value.trim();
    if(!acct||amount<=0){ alert("잘못된 입력"); return; }
    const req={id:"REQ-"+Date.now(), date:new Date().toLocaleString(), userId:currentUser.id, userName:currentUser.name, acct, amount, memo, status:"대기"};
    await addDoc(collection(db,"pendingDeposits"), req);
    log(`📨 입금 요청: ${amount.toLocaleString()} KRW`);
    acctNo.value=""; cashAmount.value=""; cashMemo.value="";
  }
  function listenDeposits(){ onSnapshot(collection(db,"pendingDeposits"), snap=>{ pendingDeposits=[]; snap.forEach(d=>pendingDeposits.push(d.data())); renderQueue(); }); }
  async function approveDeposit(id){ /* 승인 로직 */ }
  async function rejectDeposit(id){ /* 거절 로직 */ }
  function toggleAdminQueue(){ /* 관리자 대기열 열기 */ }
  function renderQueue(){ /* 대기열 렌더링 */ }

  /* ===== 버튼 window 바인딩 ===== */
  window.buy=buy; window.sell=sell; window.requestDeposit=requestDeposit;
  window.approveDeposit=approveDeposit; window.rejectDeposit=rejectDeposit;
  window.toggleAdminQueue=toggleAdminQueue;
</script>
</body>
</html>
