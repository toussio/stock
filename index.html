<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>떡잎방범대 주식 센터</title>
<style>
/* 스타일 동일 (생략 가능) */
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<div id="userInfo"></div>
<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="계좌번호 입력">
  <input type="number" id="depositAmount" placeholder="금액 입력">
  <button id="depositBtn">추가 요청</button>
</div>
<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal"> ... </div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력 (ADMIN123/GRAPH123)">
  <button onclick="checkAdminCode()">실행</button>
</div>

<!-- 관리자 요청 모달 -->
<div id="adminModal"> ... </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = { /* 발급받은 config */ };
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

// 기업 목록 (Firestore에 같은 구조가 있어야 함)
let companies = [
  { name:"떡잎방범대", price:1000, history:[1000], interval:5000 },
  { name:"카스틸로", price:500, history:[500], interval:8000 },
  { name:"사쿠라", price:500, history:[500], interval:10000 }
];

/* --- 유저 로그인/매수/매도, 입금 요청 등 기존 로직 동일 --- */

/* ✅ Firestore 기업 구독 */
companies.forEach(c => {
  onSnapshot(doc(db,"companies",c.name),(snap)=>{
    if(snap.exists()){
      const data=snap.data();
      c.price=data.price;
      c.history=data.history;
      const priceEl=document.getElementById(`price-${c.name}`);
      if(priceEl) priceEl.textContent=c.price.toLocaleString();
      updateChart();
    }
  });
});

/* ✅ 중앙 랜덤 변동 (관리자만 실행) */
async function randomUpdateCompany(name){
  const ref=doc(db,"companies",name);
  const snap=await getDoc(ref);
  if(snap.exists()){
    const data=snap.data();
    const shock=(Math.random()-0.5)*0.1;
    const newPrice=Math.max(1,Math.floor(data.price*(1+shock)));
    const newHistory=[...(data.history||[]),newPrice];
    await updateDoc(ref,{ price:newPrice, history:newHistory });
  }
}
function startGlobalRandom(){
  companies.forEach(c=>{
    setInterval(()=>{ randomUpdateCompany(c.name); }, c.interval||5000);
  });
}

/* ✅ 관리자 코드 체크 */
window.checkAdminCode = async function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code==="ADMIN123"){
    loadDepositRequests();
    document.getElementById("adminModal").style.display="flex";
  }
  else if(code==="GRAPH123"){
    startGlobalRandom();
    alert("중앙 랜덤 변동이 시작되었습니다 (관리자만 실행하세요)");
  }
}
</script>
</body>
</html>
