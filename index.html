<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>
<style>
  /* ===== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
  body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
  h1 { text-align:center; }
  #userRow, #log { margin:20px auto; max-width:900px; }
  #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
  #userInfo { font-size:16px; }

  /* ===== ì…ê¸ˆ ìš”ì²­ ì¤„(ê°€ìš´ë° ì •ë ¬) ===== */
  #depositForm { display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; margin:20px auto; max-width:900px; }
  #depositForm input { padding:6px; }
  #depositForm .memo { min-width:200px; }

  /* ===== ì¢…ëª© ì¹´ë“œ ===== */
  #companies { display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin:20px auto; max-width:900px; }
  .company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .company .left { display:flex; flex-direction:column; gap:6px; }
  .company .actions { display:flex; gap:6px; align-items:center; }
  .company .actions input[type="number"] { width:60px; padding:4px; }

  /* ===== ë²„íŠ¼ / ë¡œê·¸ / ì°¨íŠ¸ ===== */
  button { padding:6px 12px; cursor:pointer; border-radius:6px; background:#334155; color:#e5e7eb; border:none; }
  button:hover { background:#475569; }
  #log { max-height:240px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
  canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }

  /* ===== ëª¨ë‹¬ ê³µí†µ ===== */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
  .modal-content { background:#1f2937; padding:20px; border-radius:10px; text-align:center; width:min(90%, 520px); max-height:80vh; overflow-y:auto; }
  .modal-content input { margin:8px 0; padding:6px; width:80%; }

  /* ===== ê´€ë¦¬ì ìŠ¹ì¸ ì¹´ë“œ ===== */
  .req-card { background:#111827; border-radius:8px; padding:12px; margin:10px 0; text-align:left; }
  .req-meta { font-size:12px; opacity:.9; margin-top:6px; }
  .badge { padding:2px 6px; border-radius:6px; font-size:12px; margin-left:6px; }
  .badge.wait { background:#374151; }
  .badge.approved { background:#065f46; }
  .badge.rejected { background:#7f1d1d; }
</style>
</head>
<body>
<h1>ì¸ê²Œì„ ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</h1>

<!-- ìƒë‹¨ ì‚¬ìš©ì ì •ë³´/ë²„íŠ¼ -->
<div id="userRow">
  <div id="userInfo">â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</div>
  <div>
    <button onclick="openWithdrawModal()">ì¶œê¸ˆ ìš”ì²­</button>
    <button onclick="openAdminModal()">ê´€ë¦¬ì ìŠ¹ì¸ì°½</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- ì…ê¸ˆ ìš”ì²­ ì¤„ (ê°€ìš´ë° ì •ë ¬) -->
<div id="depositForm">
  <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
  <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
  <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
  <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
</div>

<!-- ì¢…ëª©/ì°¨íŠ¸/ë¡œê·¸ -->
<div id="companies"></div>
<canvas id="chart" width="900" height="400"></canvas>
<div id="log"></div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <h2>ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
    <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
    <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
    <button id="startBtn">ì‹œì‘</button>
  </div>
</div>

<!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <h2>ì¶œê¸ˆ ìš”ì²­</h2>
    <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥"><br>
    <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥"><br>
    <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥"><br>
    <input type="text" id="withdrawMemo" placeholder="ë©”ëª¨ (ì„ íƒ)"><br>
    <button onclick="submitWithdraw()">ìš”ì²­</button>
    <button onclick="closeWithdrawModal()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ìŠ¹ì¸ ëª¨ë‹¬ -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <h2>ê´€ë¦¬ì ìŠ¹ì¸ì°½</h2>
    <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ (ADMIN123)"><br>
    <button onclick="checkAdmin()">í™•ì¸</button>
    <button onclick="closeAdminModal()">ë‹«ê¸°</button>
    <div id="adminQueue" style="margin-top:15px;"></div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (CDN ëª¨ë“ˆ) -->
<script type="module">
  /**************************************************************
   * Firebase ì´ˆê¸°í™” (Auth ì—†ì´ Firestoreë§Œ ì‚¬ìš©)
   **************************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    initializeFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs,
    updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  // 400 Listen ì—ëŸ¬ íšŒí”¼ ì˜µì…˜(ë¡œì»¬/ì¼ë¶€ í˜¸ìŠ¤íŒ… í™˜ê²½)
  const db  = initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false });

  /**************************************************************
   * ì „ì—­ ìƒíƒœ / DOM ì°¸ì¡°
   **************************************************************/
  let player = { holdings:{}, cash: 5_000_000 };
  let currentUser = null;
  let chart = null;
  let autoTimer = null;

  // ê´€ë¦¬ì ëŒ€ê¸°ì—´(ì‹¤ì‹œê°„)
  let deposits = [];       // Firestore pendingDeposits
  let withdrawals = [];    // Firestore pendingWithdrawals
  let unsubDeposits = null;
  let unsubWithdrawals = null;
  let unsubUserCash = null;

  // DOM
  const userInfo     = document.getElementById('userInfo');
  const companiesDiv = document.getElementById('companies');
  const logDiv       = document.getElementById('log');
  const loginModal   = document.getElementById('loginModal');

  const acctNo    = document.getElementById('acctNo');
  const cashAmount= document.getElementById('cashAmount');
  const cashMemo  = document.getElementById('cashMemo');

  const withdrawModal  = document.getElementById('withdrawModal');
  const withdrawId     = document.getElementById('withdrawId');
  const withdrawName   = document.getElementById('withdrawName');
  const withdrawAmount = document.getElementById('withdrawAmount');
  const withdrawMemo   = document.getElementById('withdrawMemo');

  const adminModal = document.getElementById('adminModal');
  const adminQueue = document.getElementById('adminQueue');

  /**************************************************************
   * ìœ í‹¸
   **************************************************************/
  function log(msg){ logDiv.innerHTML = `<div>${msg}</div>` + logDiv.innerHTML; }
  function parseNumber(str){ const n = parseInt(String(str).replace(/[^0-9-]/g,''),10); return isNaN(n)?0:n; }
  function fmt(n){ return Number(n).toLocaleString(); }

  function renderUserInfo(){
    if(currentUser){
      userInfo.innerHTML = `<strong>${currentUser.name}(${currentUser.id})</strong> | í˜„ê¸ˆ: ${fmt(player.cash)} KRW`;
    } else {
      userInfo.textContent = 'â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...';
    }
  }

  /**************************************************************
   * ì¢…ëª© / ì‹œì„¸ / ì°¨íŠ¸
   **************************************************************/
  const companies = [
    { name:"ë–¡ìë°©ë²”ëŒ€", price:1000, history:[1000], cfg:{ vol:0.03, drift:0.002, jumpProb:0.01, jumpVol:0.10, min:1 } },
    { name:"ì¹´ìŠ¤í‹¸ë¡œ",   price:500,  history:[500],  cfg:{ vol:0.06, drift:-0.001,jumpProb:0.02, jumpVol:0.20, min:1 } },
    { name:"ì‚¬ì¿ ë¼",     price:500,  history:[500],  cfg:{ vol:0.04, drift:0.000, jumpProb:0.00, jumpVol:0.00, min:1 } },
    { name:"ì²­ë£¡",       price:500,  history:[500],  cfg:{ vol:0.08, drift:0.003, jumpProb:0.03, jumpVol:0.25, min:1 } },
    { name:"ê²½ì°°ì²­",     price:500,  history:[500],  cfg:{ vol:0.02, drift:0.001, jumpProb:0.00, jumpVol:0.00, min:1 } },
    { name:"EMS",       price:500,  history:[500],  cfg:{ vol:0.05, drift:-0.002,jumpProb:0.01, jumpVol:0.15, min:1 } },
    { name:"ì˜¬ë“œë³´ì´",   price:500,  history:[500],  cfg:{ vol:0.07, drift:0.000, jumpProb:0.02, jumpVol:0.30, min:1 } },
    { name:"ì‘ë‘",       price:800,  history:[800],  cfg:{ vol:0.10, drift:0.004, jumpProb:0.05, jumpVol:0.40, min:1 } }
  ];

  function renderCompanies(){
    companiesDiv.innerHTML = '';
    companies.forEach(c => {
      const held = player.holdings[c.name] || 0;
      const inputId = `qty-${c.name}`;
      const card = document.createElement('div');
      card.className = 'company';
      card.innerHTML = `
        <div class="left">
          <strong>${c.name}</strong>
          ${fmt(c.price)} KRW | ë³´ìœ : ${held}ì£¼
        </div>
        <div class="actions">
          <input type="number" id="${inputId}" value="1" min="1">
          <button onclick="buy('${c.name}', parseInt(document.getElementById('${inputId}').value)||1)">ë§¤ìˆ˜</button>
          <button onclick="sell('${c.name}', parseInt(document.getElementById('${inputId}').value)||1)">ë§¤ë„</button>
        </div>`;
      companiesDiv.appendChild(card);
    });
    renderUserInfo();
    updateChart();
  }

  function nextTick(){
    companies.forEach(c=>{
      const {vol, drift, jumpProb, jumpVol, min} = c.cfg;
      let shock = (Math.random()*2-1)*vol + drift;
      if(Math.random() < jumpProb) shock += (Math.random()*2-1)*jumpVol;
      c.price = Math.max(min, Math.floor(c.price*(1+shock)));
      c.history.push(c.price);
    });
    renderCompanies();
  }

  function startAuto(){
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(nextTick, 5000);
  }
  function stopAuto(){ if(autoTimer) clearInterval(autoTimer); }

  function updateChart(){
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = companies[0].history.map((_,i)=>i);
    const datasets = companies.map(c => ({ label:c.name, data:c.history, borderWidth:2, fill:false, tension:0.2 }));
    if(!chart){
      chart = new Chart(ctx, { type:'line', data:{ labels, datasets }, options:{ responsive:true } });
    } else {
      chart.data.labels = labels;
      chart.data.datasets.forEach((d,i)=> d.data = companies[i].history);
      chart.update();
    }
  }

  /**************************************************************
   * ê±°ë˜ & ë¡œê·¸ (Firestore ê¸°ë¡ + í˜„ê¸ˆ ë™ê¸°í™”)
   **************************************************************/
  async function saveTradeLog(entry){
    try{
      await addDoc(collection(db, "tradeLogs"), {
        createdAt: serverTimestamp(),
        date: new Date().toLocaleString(),
        userId: currentUser.id,
        userName: currentUser.name,
        ...entry
      });
    }catch(e){ console.error("tradeLogs ê¸°ë¡ ì˜¤ë¥˜:", e); }
  }

  async function syncCashToDB(){
    try {
      await updateDoc(doc(db, "users", currentUser.id), { cash: player.cash });
    } catch(e){
      console.error("í˜„ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:", e);
    }
  }

  function buy(name, qty){
    if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
    const c = companies.find(x=>x.name===name);
    if(player.cash < c.price*qty) return alert('í˜„ê¸ˆ ë¶€ì¡±');
    player.cash -= c.price*qty;
    player.holdings[name] = (player.holdings[name]||0) + qty;

    saveTradeLog({ type:'ë§¤ìˆ˜', company:name, qty, price:c.price, cash:player.cash });
    syncCashToDB();
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ìˆ˜ @ ${fmt(c.price)}`);
    renderCompanies();
  }

  function sell(name, qty){
    if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
    const c = companies.find(x=>x.name===name);
    if((player.holdings[name]||0) < qty) return alert('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±');
    player.cash += c.price*qty;
    player.holdings[name] -= qty;

    saveTradeLog({ type:'ë§¤ë„', company:name, qty, price:c.price, cash:player.cash });
    syncCashToDB();
    log(`âœ… ${currentUser.name} ${name} ${qty}ì£¼ ë§¤ë„ @ ${fmt(c.price)}`);
    renderCompanies();
  }

  /**************************************************************
   * ì…/ì¶œê¸ˆ ìš”ì²­ (Firestoreì— ì €ì¥)
   **************************************************************/
  async function requestDeposit(){
    if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
    const acct = acctNo.value.trim();
    const amount = parseNumber(cashAmount.value);
    const memo = cashMemo.value.trim();
    if(!acct) return alert('ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if(amount <= 0) return alert('ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');

    const req = {
      id: 'REQ-' + Date.now(),
      createdAt: serverTimestamp(),
      date: new Date().toLocaleString(),
      userId: currentUser.id,
      userName: currentUser.name,
      acct, amount, memo, status: 'ëŒ€ê¸°', type: 'ì…ê¸ˆ'
    };
    try {
      await addDoc(collection(db, 'pendingDeposits'), req);
      log(`ğŸ“¨ ì…ê¸ˆ ìš”ì²­: ${fmt(amount)} KRW / ê³„ì¢Œ:${acct}`);
      acctNo.value=''; cashAmount.value=''; cashMemo.value='';
    } catch(e){ console.error("ì…ê¸ˆ ìš”ì²­ ì˜¤ë¥˜:", e); }
  }

  function openWithdrawModal(){
    if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
    withdrawId.value = currentUser.id;
    withdrawName.value = currentUser.name;
    withdrawAmount.value = '';
    withdrawMemo.value = '';
    withdrawModal.style.display = 'flex';
  }
  function closeWithdrawModal(){ withdrawModal.style.display='none'; }

  async function submitWithdraw(){
    if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
    const amount = parseInt(withdrawAmount.value)||0;
    const memo = withdrawMemo.value.trim();
    if(amount <= 0) return alert('ì¶œê¸ˆ ê¸ˆì•¡ ì˜¤ë¥˜');

    const req = {
      id: 'WREQ-' + Date.now(),
      createdAt: serverTimestamp(),
      date: new Date().toLocaleString(),
      userId: currentUser.id,
      userName: currentUser.name,
      amount, memo, status:'ëŒ€ê¸°', type:'ì¶œê¸ˆ'
    };
    try {
      await addDoc(collection(db, 'pendingWithdrawals'), req);
      log(`ğŸ’¸ ì¶œê¸ˆ ìš”ì²­: ${fmt(amount)} KRW`);
      closeWithdrawModal();
    } catch(e){ console.error("ì¶œê¸ˆ ìš”ì²­ ì˜¤ë¥˜:", e); }
  }

  /**************************************************************
   * ê´€ë¦¬ì ìŠ¹ì¸ ëª¨ë‹¬ / ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´
   **************************************************************/
  function openAdminModal(){
    adminModal.style.display = 'flex';
    // ëª¨ë‹¬ì„ ì—´ ë•Œ ìµœì‹  ìƒíƒœ ë°˜ì˜
    renderAdminQueue();
  }
  function closeAdminModal(){ adminModal.style.display = 'none'; }

  function checkAdmin(){
    const code = document.getElementById('adminCode').value.trim();
    if(code !== 'ADMIN123'){ alert('ê´€ë¦¬ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    renderAdminQueue();
  }

  // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
  function startRequestsListeners(){
    // ì…ê¸ˆ ëŒ€ê¸°ì—´
    const depCol = collection(db, 'pendingDeposits');
    unsubDeposits = onSnapshot(depCol, snap=>{
      deposits = [];
      snap.forEach(d => deposits.push({ _ref:d.ref, ...d.data() }));
      renderAdminQueue();
    });

    // ì¶œê¸ˆ ëŒ€ê¸°ì—´
    const wdrCol = collection(db, 'pendingWithdrawals');
    unsubWithdrawals = onSnapshot(wdrCol, snap=>{
      withdrawals = [];
      snap.forEach(d => withdrawals.push({ _ref:d.ref, ...d.data() }));
      renderAdminQueue();
    });
  }

  function renderAdminQueue(){
    if(adminModal.style.display !== 'flex') return; // ëª¨ë‹¬ ì—´ë ¸ì„ ë•Œë§Œ ê·¸ë¦¼
    const code = document.getElementById('adminCode').value.trim();
    const container = adminQueue;
    container.innerHTML = '';

    const list = [...deposits, ...withdrawals].sort((a,b)=>{
      // createdAt íƒ€ì„ìŠ¤íƒ¬í”„ ìš°ì„ , ì—†ìœ¼ë©´ date ë¬¸ìì—´ë¡œ ë¹„êµ
      const ta = a.createdAt?.toMillis?.() ?? Date.parse(a.date) ?? 0;
      const tb = b.createdAt?.toMillis?.() ?? Date.parse(b.date) ?? 0;
      return tb - ta;
    });

    if(list.length === 0){
      container.innerHTML = `<div class="req-card">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    list.forEach(req=>{
      const badgeClass = req.status==='ëŒ€ê¸°' ? 'wait' : (req.status==='ìŠ¹ì¸' ? 'approved' : 'rejected');
      const div = document.createElement('div');
      div.className = 'req-card';
      div.innerHTML = `
        <div>
          <strong>${req.userName}(${req.userId})</strong>
          - ${fmt(req.amount)} KRW
          <span class="badge ${badgeClass}">${req.status}</span>
          [${req.type}]
        </div>
        <div class="req-meta">
          ID: ${req.id} | ${req.date} ${req.acct ? '| ê³„ì¢Œ:'+req.acct : ''} ${req.memo ? '| ë©”ëª¨:'+req.memo : ''}
        </div>
        <div style="margin-top:8px;">
          ${req.status==='ëŒ€ê¸°' ? `
            <button onclick="approveRequest('${req.id}','${req.type}')">ìŠ¹ì¸</button>
            <button onclick="rejectRequest('${req.id}','${req.type}')">ê±°ì ˆ</button>
          ` : `<em>ì²˜ë¦¬ë¨</em>`}
        </div>`;
      container.appendChild(div);
    });

    if(code !== 'ADMIN123'){
      const tip = document.createElement('div');
      tip.style.marginTop = '10px';
      tip.style.opacity = '.9';
      tip.innerHTML = 'ğŸ”’ ìŠ¹ì¸/ê±°ì ˆì„ í•˜ë ¤ë©´ ìƒë‹¨ì— ê´€ë¦¬ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
      container.appendChild(tip);
    }
  }

  async function approveRequest(reqId, type){
    const code = document.getElementById('adminCode').value.trim();
    if(code !== 'ADMIN123'){ alert('ê´€ë¦¬ì ì½”ë“œ í•„ìš”'); return; }

    // í•´ë‹¹ ìš”ì²­ ì°¾ê¸°
    const arr = type === 'ì…ê¸ˆ' ? deposits : withdrawals;
    const req = arr.find(r => r.id === reqId);
    if(!req || req.status !== 'ëŒ€ê¸°'){ alert('ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }

    try{
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      await updateDoc(req._ref, { status:'ìŠ¹ì¸' });

      // ìœ ì € í˜„ê¸ˆ ë³€ê²½
      const userRef = doc(db, 'users', req.userId);
      await updateDoc(userRef, { cash: increment(type==='ì…ê¸ˆ' ? req.amount : -req.amount) });

      log(`âœ… ${type} ìŠ¹ì¸: ${req.userName} ${fmt(req.amount)} KRW`);
    } catch(e){
      console.error("ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
      alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜');
    }
  }

  async function rejectRequest(reqId, type){
    const code = document.getElementById('adminCode').value.trim();
    if(code !== 'ADMIN123'){ alert('ê´€ë¦¬ì ì½”ë“œ í•„ìš”'); return; }

    const arr = type === 'ì…ê¸ˆ' ? deposits : withdrawals;
    const req = arr.find(r => r.id === reqId);
    if(!req || req.status !== 'ëŒ€ê¸°'){ alert('ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }

    try{
      await updateDoc(req._ref, { status:'ê±°ì ˆ' });
      log(`â›” ${type} ê±°ì ˆ: ${req.userName} ${fmt(req.amount)} KRW`);
    } catch(e){
      console.error("ê±°ì ˆ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
      alert('ê±°ì ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜');
    }
  }

  /**************************************************************
   * ë¡œê·¸ì¸ (Auth ì—†ìŒ) - Firestore + localStorage
   **************************************************************/
  function watchMyCash(){
    // ë‚´ cash ì‹¤ì‹œê°„ ë°˜ì˜
    if(unsubUserCash) unsubUserCash();
    unsubUserCash = onSnapshot(doc(db, 'users', currentUser.id), snap=>{
      if(snap.exists()){
        const data = snap.data();
        if(typeof data.cash === 'number'){
          player.cash = data.cash;
          renderUserInfo();
        }
      }
    });
  }

  async function initAfterLogin(){
    renderUserInfo();
    renderCompanies();
    updateChart();
    startAuto();
    watchMyCash();
    startRequestsListeners(); // ê´€ë¦¬ì ëŒ€ê¸°ì—´
  }

  // F5 ì‹œ ìë™ ë¡œê·¸ì¸ or ëª¨ë‹¬ ë³´ì¥
  window.onload = async () => {
    const saved = localStorage.getItem('stockUser');
    if(saved){
      try{ currentUser = JSON.parse(saved); } catch(e){ localStorage.removeItem('stockUser'); }
    }
    if(currentUser){
      loginModal.style.display = 'none';
      await initAfterLogin();
      log(`ğŸ”„ ìë™ ë¡œê·¸ì¸: ${currentUser.name}`);
    } else {
      loginModal.style.display = 'flex';
    }
    // ì•ˆì „ì¥ì¹˜: 1ì´ˆ í›„ì—ë„ ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë‹¬ ìœ ì§€
    setTimeout(()=>{ if(!currentUser){ loginModal.style.display='flex'; } }, 1000);
  };

  // ì‹œì‘ ë²„íŠ¼: users/{id} ì¡´ì¬ ì‹œ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ ìƒì„±
  document.getElementById('startBtn').onclick = async () => {
    const cid   = document.getElementById('customId').value.trim();
    const cname = document.getElementById('customName').value.trim();
    if(!cid || !cname){ alert('ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const userRef = doc(db, 'users', cid);
    try{
      const snap = await getDoc(userRef);
      if(snap.exists()){
        // ê¸°ì¡´ ì‚¬ìš©ì â†’ DB ë°ì´í„° ì‚¬ìš© (ì´ë¦„ ë³€ê²½ë„ ë°˜ì˜)
        const data = snap.data();
        const next = { id: cid, name: cname || data.name || cid, cash: typeof data.cash==='number' ? data.cash : player.cash };
        await setDoc(userRef, next, { merge:true }); // ì´ë¦„ ê°±ì‹ 
        currentUser = next;
        player.cash = next.cash;
      } else {
        // ì‹ ê·œ ì‚¬ìš©ì ìƒì„±
        currentUser = { id: cid, name: cname, cash: player.cash };
        await setDoc(userRef, { ...currentUser, createdAt: serverTimestamp() });
      }

      localStorage.setItem('stockUser', JSON.stringify(currentUser));
      loginModal.style.display = 'none';
      await initAfterLogin();
      log(`âœ… ë¡œê·¸ì¸: ${currentUser.name}`);
    } catch(e){
      console.error('ë¡œê·¸ì¸(ìœ ì € ìƒì„±/ì¡°íšŒ) ì˜¤ë¥˜:', e);
      alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };

  function logout(){
    // ê³„ì •ì€ ë³´ì¡´, í´ë¼ì´ì–¸íŠ¸ë§Œ ë¡œê·¸ì•„ì›ƒ
    if(unsubUserCash) unsubUserCash();
    if(unsubDeposits) unsubDeposits();
    if(unsubWithdrawals) unsubWithdrawals();
    localStorage.removeItem('stockUser');
    location.reload();
  }

  /**************************************************************
   * ì „ì—­ ë°”ì¸ë”© (onclick í•¸ë“¤ëŸ¬ì—ì„œ ì ‘ê·¼)
   **************************************************************/
  window.buy = buy;
  window.sell = sell;
  window.requestDeposit = requestDeposit;

  window.openWithdrawModal = openWithdrawModal;
  window.closeWithdrawModal = closeWithdrawModal;
  window.submitWithdraw = submitWithdraw;

  window.openAdminModal = openAdminModal;
  window.closeAdminModal = closeAdminModal;
  window.checkAdmin = checkAdmin;
  window.approveRequest = approveRequest;
  window.rejectRequest = rejectRequest;

  window.logout = logout;
</script>
</body>
</html>
