<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userRow, #log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
button { padding:5px 10px; cursor:pointer; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
/* 관리자 */
#adminSection { text-align:center; margin-top:20px; }
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModal .panel { background:#1f2937; padding:20px; border-radius:10px; width:650px; max-height:90%; overflow:auto; position:relative; }
#adminModal .panel .close { position:absolute; top:10px; right:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #444; padding:6px; text-align:center; }
th { background:#374151; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터 (Firestore 연동)</h1>

<div id="userRow">
  <div id="userInfo"></div>
  <div>
    <input id="acctNo" type="text" placeholder="계좌번호" />
    <input id="cashAmount" type="number" placeholder="금액" />
    <input id="cashMemo" type="text" placeholder="메모(선택)" />
    <button onclick="requestDeposit()">입금 요청</button>
  </div>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>거래 시작 전 정보 입력</h2>
    <input type="text" id="userId" placeholder="고유번호 입력" /><br/>
    <input type="text" id="userName" placeholder="이름 입력" /><br/>
    <button id="startBtn">시작</button>
  </div>
</div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력" />
  <button onclick="openAdminPanel()">실행</button>
</div>

<!-- 관리자 모달 -->
<div id="adminModal">
  <div class="panel">
    <button class="close" onclick="closeAdminPanel()">✖</button>
    <h2>관리자 메뉴</h2>

    <h3>입금 요청 관리</h3>
    <div id="requestsList"></div>

    <hr style="margin:20px 0;" />

    <h3>그래프 제어</h3>
    <button onclick="startAutoGraph()">자동 시작</button>
    <button onclick="stopAutoGraph()">자동 멈춤</button>
    <button onclick="resetGraphAndPrice()">그래프+가격 초기화</button>
    <div style="margin-top:10px;">
      <label>속도(ms): <input type="number" id="graphSpeed" value="5000" style="width:100px;" /></label>
      <button onclick="applyGraphConfig()">적용</button>
    </div>

    <hr style="margin:20px 0;" />

    <h3>기업별 시작가 & 변동폭 설정</h3>
    <table>
      <thead>
        <tr><th>기업명</th><th>시작가</th><th>변동폭(%)</th></tr>
      </thead>
      <tbody id="companySettingsBody"></tbody>
    </table>
    <button onclick="applyCompanySettings()">저장 & 적용</button>

    <hr style="margin:20px 0;" />

    <h3>데이터 정리</h3>
    <button onclick="cleanupHistories()">기업별 히스토리 정리 (최근 20개만 유지)</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, onSnapshot, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* 상태 */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

/* 기업 기본값 */
let companies = [
  { name:"떡잎방범대", price:1000, history:[1000], range:0.05 },
  { name:"카스틸로", price:500, history:[500], range:0.05 },
  { name:"사쿠라", price:500, history:[500], range:0.05 },
  { name:"청룡", price:500, history:[500], range:0.05 },
  { name:"경찰청", price:500, history:[500], range:0.05 },
  { name:"EMS", price:500, history:[500], range:0.05 },
  { name:"올드보이", price:500, history:[500], range:0.05 },
  { name:"작두", price:800, history:[800], range:0.05 }
];

/* 설정 */
const BASE_VOLUME = 1000;
const IMPACT = 0.02;
const MAX_HISTORY = 20;   // ✅ 최근 20개만 유지

/* localStorage */
function saveUser(u){ localStorage.setItem("stockUser", JSON.stringify(u)); }
function loadUser(){ try { return JSON.parse(localStorage.getItem("stockUser")); } catch(e){ return null; } }
function clearUser(){ localStorage.removeItem("stockUser"); }

/* 로그 */
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

/* --- 로그인 함수, 거래 함수, 입금요청, 관리자 메뉴, 그래프 제어, cleanupHistories 등 기존 코드 전체 포함 --- */
/* (이 부분은 너무 길어서 생략했지만, 이전에 드린 통합본 그대로 두시고 MAX_HISTORY = 20만 수정하면 됩니다) */
</script>
</body>
</html>
