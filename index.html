<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</title>

  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46;
      --chip:#0b1220; --chipBorder:#374151;
      --muted:#9ca3af; --muted2:#6b7280;
      --green:#10b981; --red:#ef4444; --yellow:#eab308;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }
    h2,h3,h4{margin:0 0 10px}
    small{color:var(--muted)}

    /* ìƒë‹¨ ì‚¬ìš©ì/ë²„íŠ¼ì¤„ */
    #userRow,#log { margin:20px auto; max-width:1200px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; display:flex; align-items:center; gap:10px; }

    /* í¼/ë²„íŠ¼ */
    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1200px; flex-wrap:wrap; }
    #depositForm input { padding:10px 12px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); }
    #depositForm .memo { min-width:260px; }

    button {
      padding:10px 12px; cursor:pointer; border-radius:10px; background:var(--accent); color:var(--ink);
      border:1px solid transparent; transition:filter .15s ease, background .15s;
    }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    .btn-outline { background:transparent; border-color:var(--chipBorder); }
    .btn-danger  { background:var(--danger); }
    .btn-ok      { background:var(--ok); }
    .btn-green   { background:#14532d; }
    .btn-red     { background:#7f1d1d; }
    .btn-chip    { background:var(--chip); border:1px solid var(--chipBorder); }

    /* ì°¨íŠ¸ */
    #chartWrap { position:relative; margin:20px auto; max-width:1200px; height:420px; background:#111827; border-radius:12px; overflow:hidden; border:1px solid #1f2937; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    /* ì¢…ëª© ì¹´ë“œ */
    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1200px; }
    .company { background:var(--card); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; transition:filter .2s ease, opacity .2s ease, transform .08s ease; border:1px solid #273244; }
    .company:hover{ transform: translateY(-1px); }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:700; }
    .status-badge{ font-size:13px; line-height:1; padding:5px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder); color:var(--ink2); }
    .status-badge.delisted{ background:#111827; border-color:#4b5563; color:#9ca3af; }
    .company.delisted{ opacity:.6; filter:grayscale(.2); }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:10px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    /* ë¡œê·¸ */
    #log { max-height:260px; overflow-y:auto; background:#111827; padding:12px; border-radius:12px; border:1px solid #1f2937; }

    /* ì¹´ë“œ & ëª¨ë‹¬ ë“± ê³µí†µ */
    .req-card { background:var(--card); border-radius:12px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; border:1px solid #273244; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grow { flex:1 1 auto; }
    .muted { color:var(--muted); }
    .muted2 { color:var(--muted2); }
    .chip { background:var(--chip); border:1px solid var(--chipBorder); padding:6px 10px; border-radius:999px; font-size:12px; }
    .kbd { padding:3px 6px; border-radius:6px; background:#0b1220; border:1px solid #374151; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#e5e7eb; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:12px; text-align:center; width:min(92%,540px); position:relative; border:1px solid #273244; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:10px; width:92%; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--red); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    /* ê´€ë¦¬ì íŒ¨ë„ */
    .admin-panel{display:none; max-width:1200px; margin:20px auto; background:var(--card); padding:10px; border-radius:12px; position:relative; border:1px solid #273244; }
    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:10px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); width:260px; }
    #adminLogin .row{justify-content:center}

    /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ê´€ë¦¬ì íŒ¨ë„ (í™”ë©´ ë°– ì´ë™ í—ˆìš©) */
    #adminPanelAll {
      position:fixed; top:50px; left:50px; z-index:9999;
      width:92%; max-width:1200px;
      pointer-events:auto;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #adminPanelHeader {
      background:#374151; padding:10px 44px 10px 12px; cursor:move;
      border-radius:12px 12px 0 0; font-weight:700; user-select:none;
      position:relative; border-bottom:1px solid #1f2937;
      display:flex; align-items:center; justify-content:space-between;
    }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    /* íƒ­ ë²„íŠ¼ë°” */
    .tabbar{ display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
    .tabbar button{ border-radius:999px; padding:8px 12px; }
    .tab-section{ display:block; }

    /* ì„¹ì…˜ ì¹´ë“œ */
    .section { background:#111827; border-radius:12px; padding:12px; border:1px solid #1f2937; }
    .section h3{ margin-bottom:6px; }

    /* ë¹ ë¥¸ ì£¼ê°€ì¡°ì‘ ìƒë‹¨ íˆ´ë°” */
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px; border-radius:10px; background:#0b1220; border:1px solid #1f2937; }
    .toolbar select, .toolbar input[type="number"], .toolbar input[type="range"]{
      padding:8px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink);
    }
    .toolbar .value{ min-width:78px; text-align:center; }

    /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .grid-4{ display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; }

    /* ìƒì¥íì§€ íƒ€ì´ë¨¸ ë¦¬ìŠ¤íŠ¸ */
    .delist-row { display:grid; grid-template-columns: 1.4fr 1fr 1.2fr 1fr; gap:10px; align-items:center; }
    .delist-row .cell{ padding:8px; border:1px solid var(--chipBorder); background:var(--chip); border-radius:10px; }
    .delist-row .cell strong{ display:block; margin-bottom:4px; }
    .badge { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #374151; font-size:12px; }
    .badge.green{ color:#34d399; border-color:#14532d; background:#082516; }
    .badge.red{ color:#f87171; border-color:#7f1d1d; background:#290e0e; }
    .badge.yellow{ color:#facc15; border-color:#854d0e; background:#2b1b07; }

    /* ë°˜ì‘í˜• */
    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } .grid-4{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } .delist-row{ grid-template-columns:1fr; } .grid-4{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } .grid-3{ grid-template-columns:1fr; } .grid-4{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h1>ë–¡ìë°©ë²”ëŒ€ ì£¼ì‹ ì„¼í„°</h1>

  <!-- ìƒë‹¨ ì‚¬ìš©ì íŒ¨ë„ -->
  <div id="userRow">
    <div id="userInfo">
      <span>â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...</span>
      <span id="marketStatusChip" class="chip">ì‹œì¥ ìƒíƒœ: <strong id="marketStatusText">ëŒ€ê¸°</strong></span>
    </div>
    <div class="row">
      <button class="btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <button onclick="openWithdrawModal()">ì¶œê¸ˆ ìš”ì²­</button>
      <button onclick="openNoticeModal()">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
      <button onclick="openNewsModal()">ğŸ“° ë‰´ìŠ¤ ë³´ê¸° <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span></button>
    </div>
  </div>

  <!-- ì…ê¸ˆ ìš”ì²­ -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="ì¸ê²Œì„ ê³„ì¢Œë²ˆí˜¸ (ì˜ˆ: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="ê¸ˆì•¡ (ì˜ˆ: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <button onclick="requestDeposit()">ì…ê¸ˆ ìš”ì²­</button>
  </div>

  <!-- ì°¨íŠ¸/ì¢…ëª©/ë¡œê·¸ -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (ìœ ì €) -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>ì •ë³´ ì…ë ¥ í›„ ì‹œì‘</h2>
      <p class="muted">ê²Œì„ìš© ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="text" id="customId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: U-0001)"><br>
      <input type="text" id="customName" placeholder="ì´ë¦„ ì…ë ¥"><br>
      <button id="startBtn">ì‹œì‘</button>
    </div>
  </div>

  <!-- ì¶œê¸ˆ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeWithdrawModal()">âœ•</button>
      <h2>ì¶œê¸ˆ ìš”ì²­</h2>
      <div class="stack">
        <input type="text" id="withdrawId" placeholder="ê³ ìœ ë²ˆí˜¸ ì…ë ¥">
        <input type="text" id="withdrawName" placeholder="ì´ë¦„ ì…ë ¥">
        <input type="number" id="withdrawAmount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥" oninput="updateWithdrawFee()">
        <div id="withdrawFeeInfo" class="muted" style="min-height:20px;"></div>
        <input type="text" id="withdrawAccount" placeholder="ë³¸ì¸ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥">
        <div class="row" style="justify-content:center;">
          <button class="btn-ok" onclick="submitWithdraw()">ìš”ì²­</button>
          <button class="btn-outline" onclick="closeWithdrawModal()">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê³µì§€ ëª¨ë‹¬ -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" onclick="closeNoticeModal()">âœ•</button>
      <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
      <div id="noticeContent" style="text-align:left; max-height:360px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="row" style="justify-content:center; margin-top:8px;">
        <button class="btn-outline" onclick="closeNoticeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ -->
  <div id="newsModal" class="modal">
    <div class="modal-content" style="margin-top:40px;">
      <button class="xbtn" onclick="closeNewsModal()">âœ•</button>
      <h2>ğŸ“° ìµœì‹  ë‰´ìŠ¤</h2>
      <div id="newsContent" style="text-align:left; max-height:360px; overflow-y:auto; margin-top:10px;">
        <p>í˜„ì¬ ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="row" style="justify-content:center; margin-top:8px;">
        <button class="btn-outline" onclick="closeNewsModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ (2ë‹¨ê³„) -->
  <div id="adminLogin" class="section" style="margin: 28px auto; max-width: 1200px;">
    <h3>ğŸ›¡ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ (2ë‹¨ê³„)</h3>
    <div class="row" style="margin-top:6px;">
      <div class="stack">
        <label class="muted">1) ê´€ë¦¬ì ì½”ë“œ</label>
        <div class="row">
          <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ (ì˜ˆ: ADBEN7732)">
          <button onclick="checkAdminCode()">í™•ì¸</button>
        </div>
        <small id="adminCodeStatus" class="muted">ê´€ë¦¬ì ì½”ë“œ ê²€ì¦ í•„ìš”</small>
      </div>

      <div class="stack">
        <label class="muted">2) ê´€ë¦¬ì ì´ë©”ì¼ (ë§í¬ ë¡œê·¸ì¸)</label>
        <div class="row">
          <input id="adminEmail" type="email" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ (ì˜ˆ: moast60@gmail.com)" style="width:320px;">
          <button id="sendLinkBtn" class="btn-green" onclick="sendAdminEmailLink()" disabled>ë§í¬ ì „ì†¡</button>
          <button id="finishEmailLinkBtn" class="btn-outline" onclick="finishAdminEmailLink()" disabled>ë§í¬ë¡œ ë¡œê·¸ì¸ ì™„ë£Œ</button>
        </div>
        <small class="muted">â€» ë°›ì€ ë©”ì¼ì˜ ë§í¬ë¥¼ í´ë¦­í•œ ë’¤, ì´ ë²„íŠ¼ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬</small>
        <small id="adminEmailStatus" class="muted">ê´€ë¦¬ì ë©”ì¼ ë¯¸ê²€ì¦</small>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <span class="chip">í—ˆìš© ê´€ë¦¬ì: <strong id="adminAllowListChip">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</strong></span>
      <span class="chip">ìƒíƒœ: <strong id="adminAuthState">ë¯¸ì¸ì¦</strong></span>
    </div>
  </div>

  <!-- ê´€ë¦¬ì í†µí•© íŒ¨ë„ (ë“œë˜ê·¸ ê°€ëŠ¥, í™”ë©´ ë°– ì´ë™ í—ˆìš©) -->
  <div id="adminPanelAll" class="admin-panel" style="display:none;">
    <div id="adminPanelHeader">
      <div>âš™ï¸ ê´€ë¦¬ì í†µí•© íŒ¨ë„</div>
      <button class="xbtn" onclick="closeAdmin('adminPanelAll')">âœ•</button>
    </div>

    <div style="padding:10px;">
      <!-- íƒ­ ë²„íŠ¼ -->
      <div class="tabbar">
        <button onclick="showTab('graph')">ğŸ“Š ê·¸ë˜í”„</button>
        <button onclick="showTab('users')">ğŸ‘¥ ìœ ì €</button>
        <button onclick="showTab('finance')">ğŸ’³ ì…ì¶œê¸ˆ</button>
        <button onclick="showTab('stock')">ğŸ›ï¸ ì£¼ê°€ì¡°ì‘</button>
        <button onclick="showTab('change')">ğŸ“ˆ ë°°ìœ¨/í™•ë¥ </button>
        <button onclick="showTab('news')">ğŸ“° ë‰´ìŠ¤</button>
        <button onclick="showTab('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
        <button onclick="showTab('delist')">âš« ìƒì¥íì§€</button>
      </div>

      <!-- ê·¸ë˜í”„ -->
      <div id="tab-graph" class="tab-section">
        <div class="section">
          <h3>ğŸ“Š ê·¸ë˜í”„/ê¸ˆì•¡ ì œì–´ íŒ¨ë„</h3>
          <div class="row" style="margin-top:6px;">
            <button class="btn-ok" onclick="marketStart()">ì¥ ì‹œì‘ + ì‹œì„¸ ì‹œì‘</button>
            <button class="btn-outline" onclick="marketEnd()">ì¥ ë§ˆê° + ì‹œì„¸ ì •ì§€</button>
            <button class="btn-chip" onclick="resetGraph()">ê·¸ë˜í”„ ì´ˆê¸°í™”</button>

            <label class="chip">ì „ì²´ ì¡°ì • Â±ê¸ˆì•¡</label>
            <input type="number" id="allDelta" value="100" style="width:120px;">
            <button class="btn-chip" onclick="adjustAllPrices()">ì ìš©</button>
          </div>

          <div class="grid-3" style="margin-top:12px;">
            <div class="stack">
              <strong>â±ï¸ ë³€ë™ ì£¼ê¸° (ì´ˆ)</strong>
              <div class="row">
                <input type="number" id="intervalInput" value="5" min="1" style="width:120px;">
                <button onclick="applyGraphInterval()">ì ìš©</button>
              </div>
              <small class="muted">ë“œë¼ì´ë²„(ê°±ì‹  ë‹´ë‹¹) ë¸Œë¼ìš°ì €ì—ì„œë§Œ íƒ€ì´ë¨¸ê°€ ëŒê³  ì „ì²´ì— ë™ê¸°í™”ë©ë‹ˆë‹¤.</small>
            </div>
            <div class="stack">
              <strong>ğŸ“Š ë³€ë™í­ ìƒí•œ(Â±ì›)</strong>
              <div class="row">
                <input type="number" id="deltaMaxInput" value="1000000" min="1" style="width:160px;">
                <button onclick="applyDeltaMax()">ì ìš©</button>
              </div>
            </div>
            <div class="stack">
              <strong>ğŸ“ˆ ì „ì—­ ë³€ë™í­ (%)</strong>
              <div class="row">
                <input type="number" id="volatilityInput" step="0.1" value="1.5" style="width:140px;">
                <button onclick="applyVolatility()">ì ìš©</button>
              </div>
            </div>
          </div>

          <hr style="opacity:.2; margin:12px 0">

          <h4>ğŸ“ˆ ê°œë³„ ì¢…ëª© ê¸ˆì•¡ ì¡°ì •</h4>
          <div id="graphCompanyAdjust" class="stack"></div>
          <p class="muted" style="margin-top:6px;">â€» 'í˜„ì¬ê°€(livePrice)'ë¥¼ ì§ì ‘ ì¡°ì •í•©ë‹ˆë‹¤.</p>
        </div>
      </div>

      <!-- ìœ ì € -->
      <div id="tab-users" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ‘¥ ìœ ì € ìƒíƒœ íŒ¨ë„</h3>
          <div class="req-card">
            <div>
              <div><strong>ê´€ë¦¬ì ê¶Œí•œ ê´€ë¦¬</strong></div>
              <div class="muted" style="font-size:12px;">ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬/í•´ì œ</div>
            </div>
            <div class="row">
              <input id="promoteIdInput" type="text" placeholder="ê³ ìœ ë²ˆí˜¸" style="width:160px;">
              <input id="promoteNameInput" type="text" placeholder="ì´ë¦„" style="width:160px;">
              <button onclick="promoteAdmin()">ê¶Œí•œ ë¶€ì—¬</button>
              <button class="btn-outline" onclick="demoteAdmin()">ê¶Œí•œ í•´ì œ</button>
            </div>
          </div>
          <div id="userList">ë¡œë“œ ì¤‘...</div>
        </div>
      </div>

      <!-- ì…ì¶œê¸ˆ -->
      <div id="tab-finance" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ’³ ì…/ì¶œê¸ˆ ìš”ì²­ íŒ¨ë„</h3>
          <h4 style="margin-top:8px;">ì…ê¸ˆ ìš”ì²­</h4>
          <div id="depositRequests" class="stack">ëŒ€ê¸°ì¤‘ì¸ ì…ê¸ˆ ìš”ì²­ ì—†ìŒ</div>
          <h4 style="margin-top:12px;">ì¶œê¸ˆ ìš”ì²­</h4>
          <div id="withdrawRequests" class="stack">ëŒ€ê¸°ì¤‘ì¸ ì¶œê¸ˆ ìš”ì²­ ì—†ìŒ</div>
        </div>
      </div>

      <!-- ì£¼ê°€ì¡°ì‘ (ê°œì„  UI í¬í•¨) -->
      <div id="tab-stock" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ›ï¸ ì£¼ê°€ ì¡°ì‘ íŒ¨ë„</h3>

          <!-- ë¹ ë¥¸ ì¡°ì‘ íˆ´ë°” -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">ì¢…ëª©</label>
            <select id="quickCompanySelect"></select>

            <label class="chip">í‹± í¬ê¸°(ì›)</label>
            <input type="range" id="quickTickRange" min="100" max="1000000" step="100">
            <span class="value" id="quickTickValue">10,000</span>

            <button class="btn-green" onclick="quickNudge(+1)">+ í‹±</button>
            <button class="btn-red" onclick="quickNudge(-1)">- í‹±</button>

            <span style="width:12px"></span>

            <label class="chip">ì—°ì† í‹±</label>
            <input type="number" id="quickBurstCount" value="1" min="1" max="50" style="width:80px;">
            <button class="btn-chip" onclick="quickBurst(+1)">ìƒìŠ¹ ì—°ì†</button>
            <button class="btn-chip" onclick="quickBurst(-1)">í•˜ë½ ì—°ì†</button>
          </div>

          <!-- ìì—°í‹± ì„¤ì • -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">ìì—°í‹± ê°„ê²©(ms)</label>
            <input type="number" id="stockTickIntervalInput" value="1200" min="200" step="100" style="width:120px;">

            <label class="chip">ê¸°ë³¸ í‹±(ì›)</label>
            <input type="number" id="stockTickSizeInput" value="10000" min="100" step="100" style="width:120px;">

            <label class="chip">ë¶€ë“œëŸ¬ì›€(0~1)</label>
            <input type="number" id="stockSmoothingInput" value="0.35" min="0" max="1" step="0.05" style="width:100px;">

            <label class="chip">ëœë¤ì„± Ïƒ</label>
            <input type="number" id="stockSigmaInput" value="0.8" min="0" max="5" step="0.1" style="width:100px;">

            <button onclick="applyNaturalTick()" class="btn-chip">ìì—°í‹± ì ìš©</button>
            <button onclick="toggleNaturalTick()" class="btn-outline" id="toggleNaturalTickBtn">ìì—°í‹± ì‹œì‘</button>
          </div>

          <div class="stack" style="margin-top:10px;">
            <div id="stockTuner"></div>
          </div>
        </div>
      </div>

      <!-- ë°°ìœ¨/í™•ë¥  -->
      <div id="tab-change" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ“ˆ ë°°ìœ¨ & í™•ë¥  ê´€ë¦¬ íŒ¨ë„</h3>

          <div class="grid-3" style="margin-top:8px;">
            <div class="row">
              <label class="chip">ì „ì²´ ì´ë“%</label>
              <input id="globalProfit" type="number" step="0.01" min="0" max="1" value="0.4" style="width:100px;">
              <label class="chip">ì „ì²´ ì†í•´%</label>
              <input id="globalLoss" type="number" step="0.01" min="0" max="1" value="0.6" style="width:100px;">
              <button onclick="setAllChances()">ì „ì²´ í™•ë¥  ì ìš©</button>
            </div>

            <div class="row">
              <label class="chip">ì „ì²´ ë°°ìœ¨(ë³€ë™í­ ë°°ìˆ˜)</label>
              <input id="allMultiplierVal" type="number" step="0.1" value="1" style="width:120px;">
              <button onclick="setAllMultipliers()">ì „ì²´ ë°°ìœ¨ ì ìš©</button>
            </div>

            <div class="row">
              <button onclick="runScenario('riseEnd')">ğŸ“ˆ ìƒìŠ¹ì¢…ë£Œ</button>
              <button class="btn-outline" onclick="runScenario('fallEnd')">ğŸ“‰ í•˜ë½ì¢…ë£Œ</button>
            </div>
          </div>

          <div id="changePanel" class="stack" style="margin-top:12px;"></div>
        </div>
      </div>

      <!-- ë‰´ìŠ¤ -->
      <div id="tab-news" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ“° ë‰´ìŠ¤ ê´€ë¦¬ íŒ¨ë„</h3>
          <div class="stack" style="margin-bottom:10px;">
            <input type="text" id="newsTitleInput" placeholder="ë‰´ìŠ¤ ì œëª©">
            <textarea id="newsBodyInput" placeholder="ë‰´ìŠ¤ ë‚´ìš©"></textarea>
            <div class="row">
              <button onclick="postNews()">ë“±ë¡</button>
            </div>
          </div>
          <h4>ë“±ë¡ëœ ë‰´ìŠ¤</h4>
          <div id="newsList" class="stack">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <!-- ê³µì§€ì‚¬í•­ -->
      <div id="tab-notice" class="tab-section" style="display:none;">
        <div class="section">
          <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬ íŒ¨ë„</h3>
          <div class="stack" style="margin-bottom:10px;">
            <input type="text" id="noticeTitleInput" placeholder="ê³µì§€ ì œëª©">
            <textarea id="noticeBodyInput" placeholder="ê³µì§€ ë‚´ìš©"></textarea>
            <div class="row">
              <button onclick="postNotice()">ë“±ë¡</button>
            </div>
          </div>
          <h4>ë“±ë¡ëœ ê³µì§€ì‚¬í•­</h4>
          <div id="noticeList" class="stack">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <!-- ìƒì¥íì§€ (íƒ€ì´ë¨¸ UI í¬í•¨) -->
      <div id="tab-delist" class="tab-section" style="display:none;">
        <div class="section">
          <h3>âš« ìƒì¥íì§€ ê´€ë¦¬ íŒ¨ë„</h3>
          <p class="muted" style="margin:6px 0 10px;">ìƒì¥íì§€ëœ ì¢…ëª©ì€ ê±°ë˜(ë§¤ìˆ˜/ë§¤ë„)ê°€ ë¶ˆê°€ëŠ¥í•˜ë©° ê°€ê²© ì‹œë®¬ë ˆì´ì…˜ì—ì„œë„ ì œì™¸ë©ë‹ˆë‹¤.</p>

          <!-- ë¹ ë¥¸ ì˜ˆì•½/ë³µêµ¬ -->
          <div class="toolbar">
            <label class="chip">ì¢…ëª©</label>
            <select id="delistCompanySelect"></select>

            <label class="chip">ìƒì¥íì§€ê¹Œì§€ ì§€ì—°(ë¶„)</label>
            <input type="number" id="delistDelayMinutes" value="10" min="1" step="1" style="width:100px;">

            <label class="chip">ìë™ ë³µêµ¬(ë¶„)</label>
            <input type="number" id="delistAutoRestoreMinutes" value="0" min="0" step="1" style="width:100px;">
            <span class="muted">(0=ë³µêµ¬ ì—†ìŒ)</span>

            <button onclick="scheduleDelist()" class="btn-red">ìƒì¥íì§€ ì˜ˆì•½</button>
            <button onclick="cancelScheduledDelist()" class="btn-outline">ì˜ˆì•½ ì·¨ì†Œ</button>
            <button onclick="forceDelistNow()" class="btn-red">ì¦‰ì‹œ ìƒì¥íì§€</button>
            <button onclick="restoreDelistedNow()" class="btn-chip">ì¦‰ì‹œ ë³µêµ¬</button>
          </div>

          <!-- íŠ¹ì • ì‹œê° ì˜ˆì•½ -->
          <div class="toolbar" style="margin-top:8px;">
            <label class="chip">íŠ¹ì • ì‹œê° ì˜ˆì•½</label>
            <input type="datetime-local" id="delistAtDatetime">
            <button onclick="scheduleDelistAt()" class="btn-chip">í•´ë‹¹ ì‹œê°ì— ìƒì¥íì§€</button>
            <span class="muted">â€» ìë™ ë³µêµ¬(ë¶„)ëŠ” ìœ„ ì…ë ¥ê°’ì„ ì‚¬ìš©</span>
          </div>

          <!-- íƒ€ì´ë¨¸ í˜„í™© -->
          <div class="stack" style="margin-top:10px;">
            <div class="row" style="align-items:center; gap:12px;">
              <h4 style="margin:0;">â²ï¸ ì˜ˆì•½ í˜„í™©</h4>
              <span class="badge yellow" id="delistTimerHeartbeat">ëŒ€ê¸°</span>
              <button class="btn-outline" onclick="refreshDelistTimers()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="delistTimersList" class="stack">
              <!-- JSì—ì„œ ì˜ˆì•½ëœ íƒ€ì´ë¨¸ í–‰ ë Œë”ë§ -->
              <div class="muted">ì˜ˆì•½ëœ ìƒì¥íì§€ íƒ€ì´ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          </div>

          <hr style="opacity:.2; margin:12px 0">

          <!-- ì¢…ëª©ë³„ ìƒíƒœ/ë²„íŠ¼ -->
          <div id="delistPanel" class="stack">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js (PART 3ì—ì„œ ì‚¬ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PART 2~4ì—ì„œ ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì±„ì›Œ ë„£ìŒ -->
  <script>
    /* ì´ ë¸”ë¡ì€ PART 2~4ì—ì„œ êµ¬í˜„ë  í•¨ìˆ˜ê°€ ë¶ˆë ¤ë„,
       HTML íŒŒíŠ¸ë§Œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì—ëŸ¬ê°€ ì•ˆë‚˜ë„ë¡ ì•ˆì „ no-op ë°”ì¸ë”©ë§Œ ë‘¡ë‹ˆë‹¤. */

    const noop = ()=>{};
    window.logout = noop;
    window.openWithdrawModal = noop; window.closeWithdrawModal = noop; window.submitWithdraw = noop; window.updateWithdrawFee = noop;
    window.openNoticeModal = noop; window.closeNoticeModal = noop;
    window.openNewsModal = noop; window.closeNewsModal = noop;

    window.requestDeposit = noop;

    window.showTab = function(name){
      document.querySelectorAll('#adminPanelAll .tab-section').forEach(sec => sec.style.display = 'none');
      const t = document.getElementById('tab-'+name);
      if(t) t.style.display='block';
    };

    // ê´€ë¦¬ì 2ë‹¨ê³„ ê´€ë ¨ no-op (PART 2ì—ì„œ êµ¬í˜„)
    window.checkAdminCode = noop;
    window.sendAdminEmailLink = noop;
    window.finishAdminEmailLink = noop;

    // ê·¸ë˜í”„/ê°€ê²©
    window.marketStart = noop;
    window.marketEnd = noop;
    window.resetGraph = noop;
    window.adjustAllPrices = noop;
    window.applyGraphInterval = noop;
    window.applyDeltaMax = noop;
    window.applyVolatility = noop;

    // ë³€ê²½/í™•ë¥ /ë°°ìœ¨
    window.setAllMultipliers = noop;
    window.setAllChances = noop;
    window.runScenario = noop;

    // ì£¼ê°€ì¡°ì‘(í–¥ìƒ UI)
    window.quickNudge = noop;
    window.quickBurst = noop;
    window.applyNaturalTick = noop;
    window.toggleNaturalTick = noop;

    // ìƒì¥íì§€ íƒ€ì´ë¨¸
    window.scheduleDelist = noop;
    window.cancelScheduledDelist = noop;
    window.forceDelistNow = noop;
    window.restoreDelistedNow = noop;
    window.scheduleDelistAt = noop;
    window.refreshDelistTimers = noop;

    // ê´€ë¦¬ì ê¶Œí•œ/ìœ ì €/ì…ì¶œê¸ˆ/ë‰´ìŠ¤/ê³µì§€
    window.promoteAdmin = noop;
    window.demoteAdmin = noop;
    window.postNews = noop;
    window.deleteNews = noop;
    window.toggleNewsVisibility = noop;
    window.postNotice = noop;
    window.deleteNotice = noop;
  </script>
</body>
</html>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged,
    sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
    onSnapshot, query, orderBy, deleteDoc, writeBatch, increment
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
    authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
    projectId: "cotyledons-of-stock-a1241",
    storageBucket: "cotyledons-of-stock-a1241.appspot.com",
    messagingSenderId: "962984742513",
    appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
    measurementId: "G-NRPT075Q3X"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== ì „ì—­ ìƒíƒœ =====
  let currentUser = null;
  let player = { holdings:{}, cash:0 };
  let unsubscribeUser = null;

  let ADMIN_MODE = false;
  let ADMIN_CODE_OK = false;
  let ADMIN_EMAIL_OK = false;

  const allowedAdminEmails = ["moast60@gmail.com"]; // âœ… í—ˆìš©ëœ ê´€ë¦¬ì ë©”ì¼

  // ===== ìœ í‹¸ =====
  const parseNumber = (str) => {
    const n = parseInt(String(str).replace(/[^0-9]/g,''), 10);
    return isNaN(n) ? 0 : Math.max(0, n);
  };
  const log = (msg) => {
    const logDiv = document.getElementById("log");
    if(!logDiv) return;
    logDiv.innerHTML = "<div>" + msg + "</div>" + logDiv.innerHTML;
  };

  // ===== ìœ ì € ë¡œê·¸ì¸ (ìµëª… + ì»¤ìŠ¤í…€ ì •ë³´) =====
  async function ensureAuth(){
    return new Promise(resolve=>{
      onAuthStateChanged(auth, (user)=>{
        if(user){ resolve(user); }
        else{
          signInAnonymously(auth).then(res=>resolve(res.user))
            .catch(e=>{ console.error('ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', e); resolve(null); });
        }
      });
    });
  }

  document.getElementById("startBtn").onclick = async () => {
    const cid   = document.getElementById("customId").value.trim();
    const cname = document.getElementById("customName").value.trim();
    if(!cid||!cname){ alert("ê³ ìœ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    try{
      await ensureAuth();
      const userRef = doc(db,"users",cid);
      const snap = await getDoc(userRef);
      let nextCash=0; let nextHoldings={};
      if(snap.exists()){
        const d=snap.data();
        if(typeof d.cash==='number') nextCash=d.cash;
        if(d.holdings && typeof d.holdings==='object') nextHoldings=d.holdings;
      }
      currentUser = { id:cid, name:cname, cash:nextCash, active:true };
      player.cash=nextCash; player.holdings=nextHoldings;

      await setDoc(userRef,{ ...currentUser, holdings:nextHoldings, lastLoginAt:Date.now(), active:true },{merge:true});
      localStorage.setItem("stockUser", JSON.stringify({ id:cid, name:cname }));

      document.getElementById("loginModal").style.display='none';
      renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid);
    }catch(e){
      console.error("âš ï¸ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
      alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: " + (e.message || e));
    }
  };

  function subscribeCurrentUser(uid){
    if(unsubscribeUser){ try{unsubscribeUser();}catch(e){} unsubscribeUser=null; }
    const uref=doc(db,"users",uid);
    unsubscribeUser = onSnapshot(uref,(snap)=>{
      if(!snap.exists()) return;
      const d=snap.data();
      if(typeof d.cash==='number') player.cash=d.cash;
      if(d.holdings && typeof d.holdings==='object') player.holdings=d.holdings;
      renderUserInfo(); updateHoldingsUI();
    });
  }

  async function logout(){
    try{ if(currentUser){ await updateDoc(doc(db,"users",currentUser.id),{active:false, lastLogoutAt:Date.now()}); } }catch(e){}
    if(unsubscribeUser){ try{unsubscribeUser();}catch(e){} unsubscribeUser=null; }
    localStorage.removeItem('stockUser'); location.reload();
  }
  window.logout = logout;

  // ===== ê´€ë¦¬ì ë¡œê·¸ì¸ (2ë‹¨ê³„) =====
  window.checkAdminCode = function(){
    const code = document.getElementById('adminCode').value.trim();
    if(code !== 'ADBEN7732'){
      alert('âŒ ì˜ëª»ëœ ê´€ë¦¬ì ì½”ë“œ');
      document.getElementById('adminCode').value='';
      document.getElementById('adminCodeStatus').textContent="âŒ ì½”ë“œ ë¶ˆì¼ì¹˜";
      ADMIN_CODE_OK=false;
      return;
    }
    ADMIN_CODE_OK = true;
    document.getElementById('adminCodeStatus').textContent="âœ… ê´€ë¦¬ì ì½”ë“œ í†µê³¼";
    document.getElementById('sendLinkBtn').disabled=false;
    alert("ê´€ë¦¬ì ì½”ë“œ í™•ì¸ë¨. ì´ë©”ì¼ ì¸ì¦ ì§„í–‰í•˜ì„¸ìš”.");
  };

  window.sendAdminEmailLink = async function(){
    if(!ADMIN_CODE_OK){ alert("ë¨¼ì € ê´€ë¦¬ì ì½”ë“œë¥¼ í†µê³¼í•˜ì„¸ìš”."); return; }
    const email = document.getElementById('adminEmail').value.trim();
    if(!allowedAdminEmails.includes(email)){
      alert("í—ˆìš©ë˜ì§€ ì•Šì€ ê´€ë¦¬ì ì´ë©”ì¼");
      return;
    }
    try{
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true,
      };
      await sendSignInLinkToEmail(auth, email, actionCodeSettings);
      window.localStorage.setItem("adminEmailForSignIn", email);
      document.getElementById('adminEmailStatus').textContent="ğŸ“© ì´ë©”ì¼ ë§í¬ ì „ì†¡ë¨: " + email;
      document.getElementById('finishEmailLinkBtn').disabled=false;
      alert("ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤. ë°›ì€ ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”.");
    }catch(e){
      console.error("ë§í¬ ì „ì†¡ ì‹¤íŒ¨:", e);
      alert("ë§í¬ ì „ì†¡ ì‹¤íŒ¨: " + (e.message || e));
    }
  };

  window.finishAdminEmailLink = async function(){
    try{
      if(isSignInWithEmailLink(auth, window.location.href)){
        let email = window.localStorage.getItem("adminEmailForSignIn");
        if(!email){
          email = window.prompt("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");
        }
        const res = await signInWithEmailLink(auth, email, window.location.href);
        console.log("ê´€ë¦¬ì ì´ë©”ì¼ ë¡œê·¸ì¸ ì„±ê³µ:", res.user.email);
        if(!allowedAdminEmails.includes(res.user.email)){
          alert("í—ˆìš©ë˜ì§€ ì•Šì€ ì´ë©”ì¼");
          return;
        }
        ADMIN_EMAIL_OK = true;
        checkAdminAllPassed();
      }else{
        alert("ì´ URLì€ ì´ë©”ì¼ ë¡œê·¸ì¸ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.");
      }
    }catch(e){
      console.error("ì´ë©”ì¼ ë¡œê·¸ì¸ ì‹¤íŒ¨:", e);
      alert("ì´ë©”ì¼ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e.message || e));
    }
  };

  function checkAdminAllPassed(){
    if(ADMIN_CODE_OK && ADMIN_EMAIL_OK){
      ADMIN_MODE = true;
      document.getElementById("adminAuthState").textContent="âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ";
      document.getElementById("adminPanelAll").style.display='block';
      alert("ê´€ë¦¬ì íŒ¨ë„ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!");
      // ì´í›„ PART 3, 4ì—ì„œ ë Œë” í•¨ìˆ˜ ì‹¤í–‰
      renderGraphAdjustPanel();
      renderUserList(true);
      renderFinanceQueues(true);
      renderStockTuner();
      renderChangePanel();
      renderNewsAdminList();
      renderNoticeAdminList();
      renderDelistPanel();
    }
  }

  // ====== ìœ ì € UI ë Œë”ëŸ¬ (ì´ˆê¸° ë²„ì „) ======
  function renderUserInfo(){
    const userInfo=document.getElementById("userInfo");
    if(currentUser){
      userInfo.innerHTML=`ğŸ‘¤ <strong>${currentUser.name}</strong> (${currentUser.id})
        &nbsp;|&nbsp; ğŸ’µ ë³´ìœ í˜„ê¸ˆ: <strong>${(player.cash||0).toLocaleString()} KRW</strong>`;
    }else{
      userInfo.textContent="â³ ë¡œê·¸ì¸ ëŒ€ê¸°ì¤‘...";
    }
  }

  function updateHoldingsUI(){ /* PART 3ì—ì„œ êµ¬ì²´ êµ¬í˜„ */ }
  function initCompaniesUI(){ /* PART 3ì—ì„œ êµ¬í˜„ */ }

  // ===== ì´ˆê¸° ë¡œë“œ =====
  window.onload = async () => {
    await ensureAuth();
    const saved = localStorage.getItem('stockUser');
    if(saved){
      try{
        const parsed = JSON.parse(saved);
        if(parsed && parsed.id && parsed.name){
          currentUser = { id: parsed.id, name: parsed.name };
          document.getElementById("loginModal").style.display='none';
          try{ await updateDoc(doc(db,"users",parsed.id), { active:true, lastLoginAt: Date.now() }); }catch(e){}
          renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(parsed.id);
        }else{ document.getElementById("loginModal").style.display='flex'; }
      }catch(e){
        localStorage.removeItem('stockUser'); document.getElementById("loginModal").style.display='flex';
      }
    }else{
      document.getElementById("loginModal").style.display='flex';
    }

    // ì´ë©”ì¼ ë§í¬ ì²˜ë¦¬ (ë¡œê·¸ì¸ ì§í›„)
    if(isSignInWithEmailLink(auth, window.location.href)){
      let email = window.localStorage.getItem("adminEmailForSignIn");
      if(!email){
        email = window.prompt("ê´€ë¦¬ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");
      }
      try{
        const res = await signInWithEmailLink(auth, email, window.location.href);
        if(allowedAdminEmails.includes(res.user.email)){
          ADMIN_EMAIL_OK=true; checkAdminAllPassed();
          document.getElementById('adminEmailStatus').textContent="âœ… ê´€ë¦¬ì ì´ë©”ì¼ í†µê³¼: " + res.user.email;
        }
      }catch(e){
        console.error("ì´ë©”ì¼ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
      }
    }
  };
</script>

<script type="module">
  import { 
    collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, 
    query, orderBy, deleteDoc, writeBatch, increment 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { db } from "./firebase-config.js"; // (PART2ì—ì„œ ì´ˆê¸°í™”ëœ db ë¶ˆëŸ¬ì˜¤ê¸°)

  // ===== ì „ì—­ =====
  let chart = null;
  let priceTimer = null;
  let updateInterval = 5000; // 5ì´ˆ ê¸°ë³¸
  let deltaMax = 1000000;
  let marketOpenFlag = false;
  let volatility = 1.5;
  let lastChartTick = 0;

  const marketState = { bias: {} };
  const companyChances = {};

  // ===== íšŒì‚¬ ëª©ë¡ =====
  const companies = [
    {name:"ë–¡ìë°©ë²”ëŒ€", basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì¹´ìŠ¤í‹¸ë¡œ",   basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì‚¬ì¿ ë¼",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì²­ë£¡",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ê²½ì°°ì²­",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"EMS",        basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì˜¬ë“œë³´ì´",   basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì‘ë‘",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ë¹…ë”•",       basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ì°¨ì¹´ë‹ˆ",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"inback",     basePrice:10000000, multiplier:1, livePrice:10000000},
    {name:"ë¦¬ì–¼ì›”ë“œ ê´€ë¦¬ì", basePrice:10000000, multiplier:1, livePrice:10000000},
  ].map(c => ({...c, id: safeId(c.name), delisted:false}));

  function safeId(name){ return String(name).replace(/[^a-zA-Z0-9ê°€-í£]/g,'_'); }
  function ci(s){ return String(s||"").toLowerCase(); }
  function findCompanyById(id){ return companies.find(x=>ci(x.id)===ci(id)||ci(x.name)===ci(id)); }
  function getDisplayPrice(c){ return Math.max(1, Math.floor(typeof c.livePrice==='number' ? c.livePrice : c.basePrice)); }

  // ===== ê±°ë˜ =====
  async function buy(name, qty){
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert('â›” ìƒì¥íì§€ ì¢…ëª©ì€ ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if(!marketOpenFlag) return alert('â›” ì¥ ë§ˆê° ì¤‘');
    if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');

    const p = getDisplayPrice(c);
    const total = p*qty;
    if(player.cash < total) return alert('í˜„ê¸ˆ ë¶€ì¡±');

    player.cash -= total;
    player.holdings[c.name] = (player.holdings[c.name]||0) + qty;

    try{
      await setDoc(doc(db,"users",currentUser.id),{
        cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
      },{merge:true});
      log(`ğŸŸ¢ ë§¤ìˆ˜: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
    }catch(e){ console.error("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨:", e); alert("ë§¤ìˆ˜ ì €ì¥ ì‹¤íŒ¨: " + (e.message||e)); }

    renderUserInfo(); updateHoldingsUI();
    impactPrice(c.id, qty, 'buy');
  }

  async function sell(name, qty){
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert('â›” ìƒì¥íì§€ ì¢…ëª©ì€ ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    if(!marketOpenFlag) return alert('â›” ì¥ ë§ˆê° ì¤‘');
    if(!currentUser) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');

    const p = getDisplayPrice(c);
    if((player.holdings[c.name]||0) < qty) return alert('ë³´ìœ  ë¶€ì¡±');

    const total = p*qty;
    player.cash += total;
    player.holdings[c.name] -= qty;

    try{
      await setDoc(doc(db,"users",currentUser.id),{
        cash:player.cash, holdings:player.holdings, updatedAt:Date.now()
      },{merge:true});
      log(`ğŸ”´ ë§¤ë„: [${c.name}] ${qty}ì£¼ @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
    }catch(e){ console.error("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨:", e); alert("ë§¤ë„ ì €ì¥ ì‹¤íŒ¨: " + (e.message||e)); }

    renderUserInfo(); updateHoldingsUI();
    impactPrice(c.id, qty, 'sell');
  }

  function impactPrice(name, qty, mode){
    const c=findCompanyById(name);
    if(!c) return;
    const size = Math.max(1, qty);
    const step = Math.min(0.1, size / 10000);
    const sign = (mode==='buy') ? -1 : +1;
    const next = (marketState.bias[c.id]||0) + sign*step;
    marketState.bias[c.id] = Math.max(-1, Math.min(1,next));
  }

  // ===== ì°¨íŠ¸ =====
  function initChart(){
    if(chart) return;
    const ctx=document.getElementById("chart").getContext("2d");
    chart=new Chart(ctx,{
      type:"line",
      data:{ labels:[], datasets:companies.map(c=>({label:c.name,data:[],borderWidth:2,fill:false,tension:0.25})) },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{ legend:{position:"bottom"} },
        scales:{ x:{ title:{display:true,text:"ì‹œê°„"} }, y:{ title:{display:true,text:"ê°€ê²©(KRW)"}, beginAtZero:false } }
      }
    });
  }

  function appendChartPoint(tickMs){
    if(!chart) return;
    const label=new Date(tickMs||Date.now()).toLocaleTimeString();
    chart.data.labels.push(label);
    companies.forEach((c,i)=>{ chart.data.datasets[i].data.push(getDisplayPrice(c)); });
    const MAX=120;
    if(chart.data.labels.length>MAX){
      chart.data.labels.splice(0,chart.data.labels.length-MAX);
      chart.data.datasets.forEach(d=>{ if(d.data.length>MAX) d.data.splice(0,d.data.length-MAX); });
    }
    chart.update("none");
  }

  // ===== ê°€ê²© ì‹œë®¬ë ˆì´ì…˜ (ìì—°í‹±) =====
  async function updatePrices(){
    if(!marketOpenFlag) return;
    const tickAt=Date.now();
    const batch=writeBatch(db);

    for(const c of companies){
      if(c.delisted) continue; // ìƒì¥íì§€ ì œì™¸

      const prev=c.livePrice||c.basePrice;
      const chance=companyChances[c.id]||{profit:0.4, loss:0.6};
      const denom=Math.max(1e-6,(chance.profit+chance.loss));
      let isUp=Math.random()<(chance.profit/denom);

      const b=marketState.bias[c.id]||0;
      if(b===-1) isUp=true;
      if(b===1)  isUp=false;
      marketState.bias[c.id]=b*0.5;

      const stepPct=(Math.random()*volatility/100)*Math.max(0,c.multiplier||1);
      const signed=isUp?stepPct:-stepPct;
      let nextRaw=prev*(1+signed);

      const diff=nextRaw-prev;
      if(Math.abs(diff)>deltaMax){ nextRaw=prev+Math.sign(diff)*deltaMax; }

      const next=Math.max(1,Math.round(nextRaw));
      c.livePrice=next;

      batch.set(doc(db,"companyPrices",c.id),{current:next,updatedAt:tickAt},{merge:true});
    }
    try{
      await batch.commit();
      await setDoc(doc(db,"marketState","main"),{lastTickAt:tickAt,driverId:localSimId},{merge:true});
    }catch(e){ console.error("ì‹œë®¬ ë°˜ì˜ ì‹¤íŒ¨:", e); }
  }

  // ===== ì‹œì¥ ì—´ê¸°/ë‹«ê¸° =====
  async function marketOpen(){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    marketOpenFlag=true;
    try{
      await setDoc(doc(db,"marketState","main"),{isOpen:true,interval:updateInterval,driverId:localSimId,updatedAt:Date.now()},{merge:true});
    }catch(e){ console.warn(e); }
    renderMarketStatus(); await updatePrices(); startLocalTimer(); alert("âœ… ì¥ ì‹œì‘");
  }
  async function marketClose(){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    marketOpenFlag=false;
    try{
      await setDoc(doc(db,"marketState","main"),{isOpen:false,updatedAt:Date.now()},{merge:true});
    }catch(e){ console.warn(e); }
    stopLocalTimer(); renderMarketStatus(); alert("ğŸ“‰ ì¥ ë§ˆê°");
  }

  function startLocalTimer(){
    if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
    priceTimer=setInterval(()=>{ updatePrices().catch(()=>{}); }, updateInterval);
  }
  function stopLocalTimer(){
    if(priceTimer){ clearInterval(priceTimer); priceTimer=null; }
  }

  // expose
  window.buy=buy; window.sell=sell;
  window.marketStart=marketOpen; window.marketEnd=marketClose;
</script>

<script type="module">
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { db } from "./firebase-config.js";

  // ===== ê·¸ë˜í”„ ì¡°ì • íŒ¨ë„ =====
  function renderGraphAdjustPanel(){
    const wrap=document.getElementById("graphCompanyAdjust"); if(!wrap) return;
    let html="";
    companies.forEach(c=>{
      const id="adj-"+c.id;
      html+=`
        <div class='req-card'>
          <div><strong>${c.name}</strong> | í˜„ì¬ê°€: 
            <span id='panel-price-${c.id}'>${getDisplayPrice(c).toLocaleString()}</span> KRW
            ${c.delisted? "<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>":""}
          </div>
          <div style='display:flex; gap:8px; align-items:center;'>
            <input type='number' id='${id}' placeholder='Â±ê¸ˆì•¡' style='width:100px;' ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="adjustCompanyPrice('${c.name}')">ì ìš©</button>
          </div>
        </div>`;
    });
    wrap.innerHTML=html||"íšŒì‚¬ ë°ì´í„° ì—†ìŒ";
  }

  async function adjustCompanyPrice(name, overrideDelta=null){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª©ì€ ê°€ê²© ì¡°ì • ë¶ˆê°€");

    const inputEl=document.getElementById("adj-"+c.id);
    const delta=(overrideDelta!==null&&!isNaN(overrideDelta))
      ? Number(overrideDelta):(parseInt(inputEl && inputEl.value)||0);

    const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
    await setDoc(doc(db,"companyPrices",c.id),{current:newVal,updatedAt:Date.now()},{merge:true});
    c.livePrice=newVal;

    const p=document.getElementById("panel-price-"+c.id);
    if(p) p.textContent=getDisplayPrice(c).toLocaleString();
    const el=document.getElementById("price-"+c.id);
    if(el) el.textContent=getDisplayPrice(c).toLocaleString();
    updateMaxBuyUI();
  }

  async function adjustAllPrices(){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const delta=parseInt(document.getElementById("allDelta").value)||0;
    const tickAt=Date.now();
    const batch=writeBatch(db);
    for(const c of companies){
      if(c.delisted) continue;
      const newVal=Math.max(1,(c.livePrice||c.basePrice)+delta);
      c.livePrice=newVal;
      batch.set(doc(db,"companyPrices",c.id),{current:newVal,updatedAt:tickAt},{merge:true});
    }
    await batch.commit();
    await setDoc(doc(db,"marketState","main"),{lastTickAt:tickAt},{merge:true});
    updateMaxBuyUI();
  }

  // ===== ë°°ìœ¨/í™•ë¥  íŒ¨ë„ =====
  function renderChangePanel(){
    const host=document.getElementById("changePanel"); if(!host) return;
    let html="";
    companies.forEach(c=>{
      const ch=companyChances[c.id]||{profit:0.4,loss:0.6};
      html+=`
        <div class="req-card">
          <div style="min-width:220px;">
            <div><strong>${c.name}</strong> ${c.delisted?"<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>":""}</div>
            <div class="tiny muted">ë°°ìœ¨: <strong id="mult-${c.id}">${Number(c.multiplier||1)}</strong> |
              í™•ë¥ : â†‘${(ch.profit*100).toFixed(1)}% / â†“${(ch.loss*100).toFixed(1)}%</div>
          </div>
          <div class="row">
            <input type="number" id="inp-mul-${c.id}" step="0.1" value="${Number(c.multiplier||1)}" style="width:90px;" ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="applyMultiplier('${c.name}')">ë°°ìœ¨ì ìš©</button>
            <input type="number" id="inp-up-${c.id}" step="0.01" min="0" max="1" value="${ch.profit}" style="width:90px;" ${c.delisted?'disabled':''}>
            <input type="number" id="inp-down-${c.id}" step="0.01" min="0" max="1" value="${ch.loss}" style="width:90px;" ${c.delisted?'disabled':''}>
            <button ${c.delisted?'disabled':''} onclick="applyCompanyChance('${c.name}')">í™•ë¥ ì ìš©</button>
          </div>
        </div>`;
    });
    host.innerHTML=html||"ì¢…ëª© ì—†ìŒ";
  }

  async function applyMultiplier(name){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª© ìˆ˜ì • ë¶ˆê°€");
    const el=document.getElementById("inp-mul-"+c.id);
    const val=Number(el?.value||1);
    const m=isNaN(val)?1:Math.max(0,val);
    await setDoc(doc(db,'companySettings',c.id),{multiplier:m,updatedAt:Date.now()},{merge:true});
    c.multiplier=m;
    const out=document.getElementById("mult-"+c.id);
    if(out) out.textContent=String(m);
    alert(`âœ… ${c.name} ë°°ìœ¨ ${m} ì ìš©`);
  }

  async function applyCompanyChance(name){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const c=findCompanyById(name); if(!c) return;
    if(c.delisted) return alert("âš« ìƒì¥íì§€ ì¢…ëª© ìˆ˜ì • ë¶ˆê°€");
    const upEl=document.getElementById("inp-up-"+c.id);
    const dnEl=document.getElementById("inp-down-"+c.id);
    let up=Number(upEl?.value||0.4);
    let dn=Number(dnEl?.value||0.6);
    if(up<0||dn<0||(up+dn)<=0){ return alert("0~1 ë²”ìœ„, í•©ê³„>0 ì´ì–´ì•¼ í•¨"); }
    await setDoc(doc(db,'companyChances',c.id),{profit:up,loss:dn,updatedAt:Date.now()},{merge:true});
    companyChances[c.id]={profit:up,loss:dn};
    renderChangePanel();
    alert(`âœ… ${c.name} í™•ë¥  ì ìš© (â†‘${(up*100).toFixed(1)}% / â†“${(dn*100).toFixed(1)}%)`);
  }

  // expose
  window.renderGraphAdjustPanel=renderGraphAdjustPanel;
  window.adjustCompanyPrice=adjustCompanyPrice;
  window.adjustAllPrices=adjustAllPrices;
  window.renderChangePanel=renderChangePanel;
  window.applyMultiplier=applyMultiplier;
  window.applyCompanyChance=applyCompanyChance;
</script>

<!-- ===== PART 4-2: Admin Advanced (Delist Timer + Better Tuner + Withdraw Fee Fix) ===== -->
<script type="module">
  /* ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” í˜ì´ì§€ ìƒë‹¨ì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ë‹¤ìŒ ì „ì—­ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
     - const db, companies, companyChances, marketState, ADMIN_MODE, localSimId
     - Firestore helpers: doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, increment, query
     - ê¸°ì¡´ ë°”ì¸ë”©(window.*)ì€ ì—¬ê¸°ì„œ í•„ìš”í•œ ë¶€ë¶„ë§Œ "ë®ì–´ì“°ê¸°" (override) ë©ë‹ˆë‹¤.
  */

  /* ---------------------------------------------------------
   * ê³µí†µ ìƒìˆ˜/ìœ í‹¸
   * --------------------------------------------------------- */
  const WITHDRAW_FEE_RATE = 0.20; // âœ… UI/ìŠ¹ì¸ ë¡œì§ í†µì¼ 20%
  const DELIST_TIMER_COL  = "delistTimers"; // { id: companyId, until, startedAt, durationMs, reason, by }
  const ms = n => Number(n)||0;

  const fmt2 = n => (n<10 ? "0"+n : ""+n);
  function formatRemain(msLeft){
    if(msLeft <= 0) return "00:00";
    const totalSec = Math.floor(msLeft/1000);
    const m = Math.floor(totalSec/60);
    const s = totalSec%60;
    return `${fmt2(m)}:${fmt2(s)}`;
  }

  // ìŠ¬ë¼ì´ë” ë³´ì¡°(ìˆ«ì inputê³¼ range ë™ê¸°í™”)
  function bindNumberAndRange(numEl, rangeEl){
    if(!numEl || !rangeEl) return;
    const syncToNum   = () => { numEl.value = rangeEl.value; };
    const syncToRange = () => { rangeEl.value = numEl.value; };
    rangeEl.addEventListener('input', syncToNum);
    numEl.addEventListener('input', syncToRange);
    syncToNum();
  }

  /* ---------------------------------------------------------
   * ğŸ”§ ì¶œê¸ˆ ìˆ˜ìˆ˜ë£Œ â€” ë²„ê·¸ í”½ìŠ¤ (UI 20% â†” ìŠ¹ì¸ 10% ë¶ˆì¼ì¹˜ í•´ê²°)
   * --------------------------------------------------------- */
  // ê¸°ì¡´ í•¨ìˆ˜ override
  window.updateWithdrawFee = function(){
    const amount = (()=>{
      const el = document.getElementById('withdrawAmount');
      if(!el) return 0;
      return parseInt(String(el.value||'').replace(/[^0-9]/g,''),10) || 0;
    })();
    const fee = Math.floor(amount * WITHDRAW_FEE_RATE);
    const info = document.getElementById('withdrawFeeInfo');
    if(info){
      const net = Math.max(0, amount - fee);
      info.textContent = `ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()} KRW (ì‹¤ì§€ê¸‰: ${net.toLocaleString()} KRW)`;
    }
  };

  // ìŠ¹ì¸ ë¡œì§ë„ 20%ì— ë§ì¶° ë®ì–´ì“°ê¸°
  window.approveWithdraw = async function(id, amount, userId){
    try{
      const uref = doc(db,"users",userId);
      const usnap = await getDoc(uref);
      const cash = Number(usnap.data()?.cash||0);
      const fee  = Math.floor(amount * WITHDRAW_FEE_RATE);
      const totalDebit = amount; // ì‚¬ìš©ìì˜ ì”ê³ ì—ì„œ ë¹ ì§€ëŠ” ê°’(ìš”ì²­ì•¡). ì‹¤ì§€ê¸‰=amount-fee ëŠ” ê´€ë¦¬ì ì˜¤í”„ì²´ì¸ ì²˜ë¦¬ ê°€ì •.
      if(cash < totalDebit){
        alert('ì‚¬ìš©ì ë³´ìœ  í˜„ê¸ˆ ë¶€ì¡±ìœ¼ë¡œ ìŠ¹ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      await updateDoc(uref, { cash: increment(-totalDebit), updatedAt: Date.now() });
      await updateDoc(doc(db,"withdrawRequests",id),{
        status:'approved', updatedAt:Date.now(), feeApplied: fee, feeRate: WITHDRAW_FEE_RATE
      });
      alert(`âœ… ì¶œê¸ˆ ìŠ¹ì¸ ì™„ë£Œ (ìš”ì²­ì•¡: ${amount.toLocaleString()} / ìˆ˜ìˆ˜ë£Œ: ${fee.toLocaleString()} / ì‹¤ì§€ê¸‰: ${(amount-fee).toLocaleString()})`);
    }catch(e){
      console.error(e);
      alert('ìŠ¹ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (e.message || e));
    }
  };

  /* ---------------------------------------------------------
   * ğŸ›ï¸ ì£¼ê°€ ì¡°ì‘ UI â€” ë³´ê¸° ì‰½ê³  ì¡°ì‘ ì‰¬ìš´ íŒ¨ë„ (ìŠ¬ë¼ì´ë”/í”„ë¦¬ì…‹)
   * --------------------------------------------------------- */
  // ê¸°ì¡´ renderStockTuner ë®ì–´ì“°ê¸°: ìŠ¬ë¼ì´ë” + í”„ë¦¬ì…‹ + ì¸ë¼ì¸ ì¡°ì •
  window.renderStockTuner = function(){
    const host = document.getElementById('stockTuner'); if(!host) return;
    let html = `
      <div class="req-card" style="gap:14px; align-items:flex-start;">
        <div style="min-width:220px">
          <div><strong>í”„ë¦¬ì…‹</strong></div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
            <button onclick="__presetBump(-1000000)">ğŸ“‰ -100ë§Œ</button>
            <button onclick="__presetBump(-100000)">-10ë§Œ</button>
            <button onclick="__presetBump(-10000)">-1ë§Œ</button>
            <button onclick="__presetBump(10000)">+1ë§Œ</button>
            <button onclick="__presetBump(100000)">+10ë§Œ</button>
            <button onclick="__presetBump(1000000)">ğŸ“ˆ +100ë§Œ</button>
          </div>
          <div style="color:#9ca3af; font-size:12px; margin-top:8px;">í”„ë¦¬ì…‹ í´ë¦­ ì‹œ, ì•„ë˜ 'ì„ íƒ ì¢…ëª©'ì— ë°”ë¡œ ì ìš©ë©ë‹ˆë‹¤.</div>
        </div>

        <div style="flex:1; min-width:260px;">
          <div><strong>ì„ íƒ ì¢…ëª© ì¼ê´„ ì¡°ì •</strong></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px;">
            <select id="__tunerSelect" multiple size="6" style="min-width:200px; max-width:260px;">
              ${companies.map(c=>`<option value="${c.name}" ${c.delisted?'disabled':''}>
                ${c.delisted?'[íì§€] ':''}${c.name} (${(c.livePrice||c.basePrice).toLocaleString()}ì›)
              </option>`).join('')}
            </select>

            <div style="min-width:220px;">
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="__tunerDeltaNum" type="number" step="1000" value="10000" style="width:120px;">
                <input id="__tunerDeltaRange" type="range" min="-1000000" max="1000000" step="1000" value="10000" style="width:200px;">
              </div>
              <div style="margin-top:6px; display:flex; gap:6px;">
                <button onclick="__applyDeltaToSelected()">ì„ íƒ ì¢…ëª© ì¡°ì •</button>
                <button onclick="__refreshTuner()">ìƒˆë¡œê³ ì¹¨</button>
              </div>
              <div style="color:#9ca3af; font-size:12px; margin-top:6px;">â€» ìƒì¥íì§€ ì¢…ëª©ì€ ìë™ ì œì™¸ë©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // ê°œë³„ ì¹´ë“œ(í€µ ë²„íŠ¼)
    html += companies.map(c=>{
      const disabled = c.delisted ? "disabled" : "";
      return `
        <div class='req-card'>
          <div><strong>${c.name}</strong> | ${(c.livePrice||c.basePrice).toLocaleString()} KRW
            ${c.delisted ? "<span style='margin-left:8px;color:#ef4444;'>âš« ìƒì¥íì§€</span>" : ""}</div>
          <div style='display:flex; gap:6px; flex-wrap:wrap;'>
            <button ${disabled} onclick="applyStockTarget('${c.name}', -100000)">-10ë§Œ</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', -10000)">-1ë§Œ</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', 10000)">+1ë§Œ</button>
            <button ${disabled} onclick="applyStockTarget('${c.name}', 100000)">+10ë§Œ</button>
            <input ${disabled} type="number" id="__one-${c.id}" step="1000" value="10000" style="width:100px;">
            <button ${disabled} onclick="(function(){ const v=parseInt(document.getElementById('__one-${c.id}').value)||0; applyStockTarget('${c.name}', v); })()">ì ìš©</button>
          </div>
        </div>`;
    }).join('');

    host.innerHTML = html;

    // ìŠ¬ë¼ì´ë”-ìˆ«ì ë™ê¸°í™”
    bindNumberAndRange(
      document.getElementById('__tunerDeltaNum'),
      document.getElementById('__tunerDeltaRange')
    );
  };

  // í”„ë¦¬ì…‹ ë²„íŠ¼ í•¸ë“¤ëŸ¬
  window.__presetBump = function(delta){
    const num = document.getElementById('__tunerDeltaNum');
    const rng = document.getElementById('__tunerDeltaRange');
    if(num && rng){ num.value = String(delta); rng.value = String(delta); }
  };

  // ì„ íƒ ì¢…ëª©ì— ì¼ê´„ ì ìš©
  window.__applyDeltaToSelected = async function(){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const sel = Array.from((document.getElementById('__tunerSelect')||{}).selectedOptions||[]).map(o=>o.value);
    if(!sel.length) return alert("ì¡°ì •í•  ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    const delta = parseInt((document.getElementById('__tunerDeltaNum')||{}).value)||0;

    let count = 0;
    for(const name of sel){
      const c = companies.find(x=>x.name===name);
      if(!c || c.delisted) continue;
      await window.applyStockTarget(name, delta);
      count++;
    }
    alert(`âœ… ${count}ê°œ ì¢…ëª© ì¡°ì • ì™„ë£Œ (${delta>0?'+':''}${delta.toLocaleString()}ì›)`);
  };

  window.__refreshTuner = function(){
    window.renderStockTuner();
  };

  /* ---------------------------------------------------------
   * âš« ìƒì¥íì§€ íƒ€ì´ë¨¸ â€” ì¦‰ì‹œ íì§€ + Në¶„ í›„ ìë™ ë³µêµ¬
   * --------------------------------------------------------- */
  const delistTimersMap = new Map(); // companyId -> { until, startedAt, durationMs, reason, by }
  let delistTickTimer = null;

  // UI: ìƒì¥íì§€ íƒ­(ê¸°ì¡´ í•¨ìˆ˜ ë®ì–´ì“°ê¸°)
  window.renderDelistPanel = function(){
    const host = document.getElementById("delistPanel"); if(!host) return;
    let html = "";
    companies.forEach(c=>{
      const isDelisted = !!c.delisted;
      const timer = delistTimersMap.get(c.id) || null;
      const remain = timer ? Math.max(0, ms(timer.until) - Date.now()) : 0;

      html += `
        <div class="req-card" style="align-items:flex-start;">
          <div style="min-width:260px;">
            <div><strong>${c.name}</strong>
              <span style="margin-left:6px; ${isDelisted?'color:#ef4444;':'color:#10b981;'}">
                ${isDelisted?'âš« ìƒì¥íì§€':'ğŸŸ¢ ìƒì¥'}
              </span>
            </div>
            <div style="font-size:12px;color:#9ca3af;margin-top:4px;">
              í˜„ì¬ê°€: ${(c.livePrice||c.basePrice).toLocaleString()} KRW, ë°°ìœ¨: ${Number(c.multiplier||1)}
            </div>
            ${timer ? `
              <div style="margin-top:6px;">
                â³ ìë™ ë³µêµ¬ê¹Œì§€: <strong id="delist-eta-${c.id}">${formatRemain(remain)}</strong>
                ${timer.reason ? `<div style="color:#cbd5e1; font-size:12px; margin-top:2px;">ì‚¬ìœ : ${escapeHtml(timer.reason)}</div>` : ""}
              </div>
            ` : ""}
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            ${!isDelisted ? `
              <input id="delist-min-${c.id}" type="number" min="1" value="10" style="width:80px;" placeholder="ë¶„">
              <input id="delist-reason-${c.id}" type="text" placeholder="ì‚¬ìœ (ì„ íƒ)" style="width:200px;">
              <button onclick="scheduleDelistWithTimer('${c.name}')">íƒ€ì´ë¨¸ ìƒì¥íì§€</button>
              <button onclick="delistCompany('${c.name}')" style="background:#7f1d1d;">ì¦‰ì‹œ ìƒì¥íì§€</button>
            ` : `
              ${timer ? `
                <button onclick="cancelDelistTimer('${c.name}')">íƒ€ì´ë¨¸ ì·¨ì†Œ + ì¦‰ì‹œ ë³µêµ¬</button>
              ` : `
                <button onclick="restoreCompany('${c.name}')">ì¦‰ì‹œ ë³µêµ¬</button>
              `}
            `}
          </div>
        </div>
      `;
    });
    host.innerHTML = html || "ê¸°ì—… ì—†ìŒ";
  };

  // HTML escape
  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, ch => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[ch]));
  }

  // Firestore êµ¬ë…: delistTimers
  function subscribeDelistTimers(){
    onSnapshot(collection(db, DELIST_TIMER_COL), (snap)=>{
      delistTimersMap.clear();
      snap.forEach(docu=>{
        const d = docu.data() || {};
        delistTimersMap.set(docu.id, d);
      });
      // ìƒˆ ë°ì´í„° ë°˜ì˜ â†’ UI ê°±ì‹ 
      window.renderDelistPanel();
    });

    // 1ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ tick
    if(delistTickTimer) clearInterval(delistTickTimer);
    delistTickTimer = setInterval(async ()=>{
      // ë‚¨ì€ ì‹œê°„ ê°±ì‹  ë° ìë™ ë³µêµ¬ ì²´í¬
      for(const c of companies){
        const timer = delistTimersMap.get(c.id);
        const span = document.getElementById(`delist-eta-${c.id}`);
        if(timer && span){
          const left = Math.max(0, ms(timer.until) - Date.now());
          span.textContent = formatRemain(left);
          if(left <= 0){
            // íƒ€ì„ì—… â†’ ìë™ ë³µêµ¬ ì‹œë„
            await autoRestoreIfDue(c.id);
          }
        }
      }
    }, 1000);
  }

  // ìŠ¤ì¼€ì¤„: ì¦‰ì‹œ íì§€ + Në¶„ íƒ€ì´ë¨¸ ìƒì„±
  window.scheduleDelistWithTimer = async function(companyName){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const c = companies.find(x=>x.name===companyName); if(!c) return;
    const minEl  = document.getElementById(`delist-min-${c.id}`);
    const rsnEl  = document.getElementById(`delist-reason-${c.id}`);
    const minutes = Math.max(1, parseInt(minEl?.value||"10", 10));
    const reason  = String(rsnEl?.value||"").trim();

    const now = Date.now();
    const until = now + minutes*60*1000;

    try{
      // ì¦‰ì‹œ ìƒì¥íì§€
      await setDoc(doc(db,"companySettings",c.id), { delisted:true, updatedAt: now }, { merge:true });
      c.delisted = true;

      // íƒ€ì´ë¨¸ ë¬¸ì„œ ì €ì¥
      await setDoc(doc(db, DELIST_TIMER_COL, c.id), {
        startedAt: now,
        durationMs: minutes*60*1000,
        until,
        reason,
        by: (window.currentUser?.id || "admin"),
      }, { merge:true });

      alert(`âš« ${c.name} ìƒì¥íì§€ ì‹œì‘ â€” ${minutes}ë¶„ í›„ ìë™ ë³µêµ¬`);
      window.renderDelistPanel();
    }catch(e){
      console.error(e);
      alert("ìƒì¥íì§€ íƒ€ì´ë¨¸ ì„¤ì • ì‹¤íŒ¨: " + (e.message||e));
    }
  };

  // íƒ€ì„ì—…ì‹œ ìë™ ë³µêµ¬
  async function autoRestoreIfDue(companyId){
    try{
      const timer = delistTimersMap.get(companyId);
      if(!timer) return; // ì´ë¯¸ ì·¨ì†Œ/ë³µêµ¬ë¨
      if(Date.now() < ms(timer.until)) return; // ì•„ì§ ë‚¨ìŒ

      // íšŒì‚¬ê°€ í˜„ì¬ íì§€ ìƒíƒœì¸ì§€ í™•ì¸
      const csnap = await getDoc(doc(db, "companySettings", companyId));
      const isDelistedNow = Boolean(csnap.data()?.delisted);

      if(isDelistedNow){
        // ë³µêµ¬ ì²˜ë¦¬
        await setDoc(doc(db,"companySettings",companyId), { delisted:false, updatedAt: Date.now() }, { merge:true });
      }
      // íƒ€ì´ë¨¸ ë¬¸ì„œ ì œê±°
      await deleteDoc(doc(db, DELIST_TIMER_COL, companyId));

      // ë¡œì»¬ ë§µ/í™”ë©´ ê°±ì‹ 
      delistTimersMap.delete(companyId);
      const c = companies.find(x=>x.id===companyId);
      if(c) c.delisted = false;

      window.renderDelistPanel();
      alert(`ğŸŸ¢ ${c?.name||companyId} ìë™ ë³µêµ¬ ì™„ë£Œ`);
    }catch(e){
      console.error("ìë™ ë³µêµ¬ ì‹¤íŒ¨:", e);
    }
  }

  // íƒ€ì´ë¨¸ ì·¨ì†Œ + ì¦‰ì‹œ ë³µêµ¬
  window.cancelDelistTimer = async function(companyName){
    if(!ADMIN_MODE) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    const c = companies.find(x=>x.name===companyName); if(!c) return;
    try{
      await setDoc(doc(db,"companySettings",c.id), { delisted:false, updatedAt: Date.now() }, { merge:true });
      await deleteDoc(doc(db, DELIST_TIMER_COL, c.id));
      delistTimersMap.delete(c.id);
      c.delisted = false;
      window.renderDelistPanel();
      alert(`ğŸŸ¢ ${c.name} íƒ€ì´ë¨¸ ì·¨ì†Œ ë° ë³µêµ¬ ì™„ë£Œ`);
    }catch(e){
      console.error(e);
      alert("íƒ€ì´ë¨¸ ì·¨ì†Œ ì‹¤íŒ¨: " + (e.message||e));
    }
  };

  // ì´ˆê¸° êµ¬ë… ì‹œì‘ (dbê°€ ì¤€ë¹„ë¼ ìˆì–´ì•¼ í•¨)
  try { subscribeDelistTimers(); } catch(e){ console.warn("delistTimers êµ¬ë… ì‹¤íŒ¨(ì´ˆê¸°):", e); }

  /* ---------------------------------------------------------
   * â±ï¸ ìì—°ìŠ¤ëŸ¬ìš´ í‹±(ì˜µì…˜) â€” ë¯¸ì„¸ ì§€í„° & ëª¨ë©˜í…€
   *  - ê¸°ì¡´ setInterval ê¸°ë°˜ì„ ìœ ì§€í•˜ë˜, bias ê°ì‡ ì™€ í•¨ê»˜
   *    ì‘ì€ ì§€í„°(Â±15%)ë¥¼ ì¤„ ìˆ˜ ìˆëŠ” ë„ìš°ë¯¸ ì¶”ê°€ (ì„ íƒ ì ìš©)
   * --------------------------------------------------------- */
  // í•„ìš” ì‹œ ê·¸ë˜í”„ íƒ­ì—ì„œ í˜¸ì¶œí•´ ì“°ì„¸ìš”.
  window.enableTickJitter = function(enable=true){
    // ê¸°ì¡´ ì½”ë“œì—ì„œ startLocalTimer/stopLocalTimer ë¥¼ ì“°ê³  ìˆìœ¼ë¯€ë¡œ,
    // ì—¬ê¸°ì„œëŠ” updateInterval ì— ì•½ê°„ì˜ ì§€í„°ë¥¼ ë”í•´ì£¼ëŠ” í—¬í¼ë§Œ ì œê³µ.
    // (ì› ì½”ë“œì˜ íƒ€ì´ë¨¸ íë¦„ì„ ë°”ê¾¸ì§€ ì•ŠìŒ)
    const base = window.__baseInterval || 0;
    if(enable){
      if(!window.__baseInterval) window.__baseInterval = (window.updateInterval||5000);
      const j = Math.max(250, Math.floor(window.__baseInterval * (1 + (Math.random()*0.3 - 0.15))));
      window.updateInterval = j;
    }else{
      if(base > 0) window.updateInterval = base;
    }
  };

  /* ---------------------------------------------------------
   * DOM ì´ë²¤íŠ¸ ë³´ì¡° (ìƒì„¸ íƒ­ ì´ë™ ì‹œ ì¦‰ì‹œ UI ê°±ì‹ )
   * --------------------------------------------------------- */
  // ê´€ë¦¬ì íƒ­ ë³€í™˜ í•¨ìˆ˜ê°€ ê¸°ì¡´ì— ì¡´ì¬í•˜ë¯€ë¡œ, ë™ì¼ id ì‚¬ìš© ì‹œ ìë™ ë°˜ì˜ë¨.
  // í•„ìš” ì‹œ ë‹¤ìŒ ì´ë²¤íŠ¸ ë°”ì¸ë”©:
  (function patchTabButtons(){
    const dtab = document.querySelector('button[onclick="showTab(\'delist\')"]');
    if(dtab){
      dtab.addEventListener('click', ()=> {
        // íƒ€ì´ë¨¸/ìƒíƒœ ìµœì‹ í™”
        window.renderDelistPanel();
      }, { once:false });
    }
    const stok = document.querySelector('button[onclick="showTab(\'stock\')"]');
    if(stok){
      stok.addEventListener('click', ()=> {
        window.renderStockTuner();
      }, { once:false });
    }
  })();
</script>
