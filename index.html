<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>떡잎방범대 주식 센터</title>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; }
#userInfo,#depositSection,#log { margin:20px auto; max-width:800px; }
#companies { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:20px auto; max-width:800px; }
.company { padding:10px; background:#1f2937; border-radius:8px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.company div { flex:1; }
button { padding:5px 10px; cursor:pointer; margin-top:4px; }
input[type="number"]{ -moz-appearance: textfield; }
#log { max-height:220px; overflow-y:auto; background:#111827; padding:10px; border-radius:8px; }
canvas { background:#111827; border-radius:8px; display:block; margin:20px auto; }
#loginModal { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#loginModalContent { background:#1f2937; padding:20px; border-radius:10px; text-align:center; }
#loginModal input { margin:10px 0; padding:5px; width:80%; }
#adminSection { text-align:center; margin-top:20px; }
#adminSection input { padding:5px; }

/* 관리자 모달 */
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#adminModalContent { background:#1f2937; padding:20px; border-radius:10px; width:520px; max-height:85%; overflow:auto; position:relative; }
#adminModalContent h2 { margin:10px 0; }
.requestBox { margin-bottom:10px; padding:10px; background:#111827; border-radius:6px; }
#adminModalContent .closeBtn { position:absolute; top:10px; right:10px; background:none; border:none; color:#e5e7eb; font-size:18px; cursor:pointer; }
.sectionTitle { margin-top:16px; font-weight:bold; }
.graphRow { display:flex; align-items:center; gap:8px; padding:8px; background:#111827; border-radius:6px; margin-bottom:8px; }
.graphRow .name { width:110px; font-weight:bold; }
.graphRow input[type="number"] { width:120px; padding:4px; text-align:right; }
.graphControls { display:flex; gap:8px; margin:8px 0 12px; }
.small { font-size:12px; color:#9ca3af; }
hr { border:0; border-top:1px solid #374151; margin:14px 0; }
</style>
</head>
<body>
<h1>인게임 주식 시뮬레이터</h1>

<div id="userInfo"></div>
<div id="depositSection">
  <input type="text" id="accountNumber" placeholder="계좌번호 입력">
  <input type="number" id="depositAmount" placeholder="금액 입력">
  <button id="depositBtn">추가 요청</button>
</div>

<div id="companies"></div>
<canvas id="chart" width="800" height="400"></canvas>
<div id="log"></div>

<!-- 로그인 모달 -->
<div id="loginModal">
  <div id="loginModalContent">
    <h2>거래 시작 전 정보 입력</h2>
    <input type="text" id="userId" placeholder="고유번호 입력" /><br>
    <input type="text" id="userName" placeholder="이름 입력" /><br>
    <button id="startBtn">시작</button>
  </div>
</div>

<!-- 관리자 섹션 -->
<div id="adminSection">
  <input type="text" id="adminCode" placeholder="관리자 코드 입력 (ADMIN123 / SEED123)">
  <button onclick="checkAdminCode()">실행</button>
</div>

<!-- 관리자 요청 & 그래프 제어 모달 -->
<div id="adminModal">
  <div id="adminModalContent">
    <button class="closeBtn" onclick="closeAdminModal()">✖</button>
    <h2>입금 요청 관리</h2>
    <div id="requestsList"></div>

    <hr>
    <h2>그래프 제어(중앙)</h2>
    <div class="small">한 명의 관리자만 시작하세요. 모든 유저는 Firestore 구독으로 동일 그래프를 보게 됩니다.</div>
    <div class="graphControls">
      <button id="startGraphBtn">시작(중앙 랜덤 변동)</button>
      <button id="stopGraphBtn">중지</button>
    </div>
    <div id="graphControl"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, deleteDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQf-ofDMSTwOBsopBsx5ZXCy1XhIWLeVY",
  authDomain: "cotyledons-of-stock.firebaseapp.com",
  projectId: "cotyledons-of-stock",
  storageBucket: "cotyledons-of-stock.appspot.com",
  messagingSenderId: "343488842605",
  appId: "1:343488842605:web:f4c1205568f5994d55e864",
  measurementId: "G-YB960D84W4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== 상태 ===== */
let player = { holdings:{}, cash:5000000 };
let currentUser = null;
let chart;

let companies = [
  { name:"떡잎방범대", price:1000, history:[1000], interval:5000 },
  { name:"카스틸로",   price:500,  history:[500],  interval:7000 },
  { name:"사쿠라",     price:500,  history:[500],  interval:10000 },
  { name:"청룡",       price:500,  history:[500],  interval:8000 },
  { name:"경찰청",     price:500,  history:[500],  interval:6000 },
  { name:"EMS",        price:500,  history:[500],  interval:9000 },
  { name:"올드보이",   price:500,  history:[500],  interval:12000 },
  { name:"작두",       price:800,  history:[800],  interval:5000 }
];

// 중앙 그래프 컨트롤(이 클라이언트에서만 동작)
let isGraphMaster = false;
let timers = {}; // { [name]: intervalId }

/* ===== 공통 렌더 ===== */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=`
    <strong>${currentUser?.name||""}(${currentUser?.id||""})</strong> |
    현금: ${player.cash.toLocaleString()} KRW
    <button style="margin-left:8px" onclick="logout()">로그아웃</button>
  `;
}
function log(msg){ const l=document.getElementById('log'); l.innerHTML=`<div>${msg}</div>`+l.innerHTML; }

/* ===== 로그인/유저 동기화 ===== */
async function loginUser(userId,userName){
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    player={ cash:data.cash??5000000, holdings:data.holdings??{} };
  } else {
    await setDoc(userRef,{ id:userId, name:userName, cash:5000000, holdings:{} });
    player={ cash:5000000, holdings:{} };
  }
  currentUser={ id:userId, name:userName };
  renderUserInfo(); renderCompanies();

  // 모든 유저: 회사 문서 구독 → 동일 그래프
  companies.forEach(c=>{
    onSnapshot(doc(db,"companies",c.name),(snap)=>{
      if(snap.exists()){
        const data=snap.data();
        c.price   = data.price;
        c.history = data.history || [c.price];
        c.interval = data.interval || c.interval || 5000;

        const priceSpan=document.getElementById(`price-${c.name}`);
        if(priceSpan) priceSpan.textContent=c.price.toLocaleString();

        // 관리자 모달 열려있다면 표시 업데이트
        const curSpan = document.getElementById(`interval-cur-${c.name}`);
        if(curSpan) curSpan.textContent = `${c.interval} ms`;

        updateChart();

        // 중앙 컨트롤 중이라면 간격 변경 시 해당 타이머 재시작
        if(isGraphMaster && timers[c.name]){
          setCompanyTimer(c.name); // 내부에서 clear 후 재설정
        }
      }
    });
  });
}

async function syncUserData(){
  if(!currentUser) return;
  await updateDoc(doc(db,"users",currentUser.id),{
    cash:player.cash,
    holdings:player.holdings
  });
}

/* ===== 기업/차트 UI ===== */
function renderCompanies(){
  const container=document.getElementById('companies');
  container.innerHTML='';
  companies.forEach(c=>{
    const held=player.holdings[c.name]||0;
    const div=document.createElement('div');
    div.className='company';
    div.innerHTML=`
      <div>
        <strong>${c.name}</strong><br>
        가격: <span id="price-${c.name}">${c.price.toLocaleString()}</span> KRW<br>
        보유: <span id="holding-${c.name}">${held}</span>주
      </div>
      <div style="text-align:right;">
        <input type="number" id="qty-${c.name}" value="1" min="1"
               style="min-width:60px; max-width:100px; text-align:right; margin-bottom:5px;">
        <div style="display:flex; gap:5px; justify-content:flex-end;">
          <button onclick="buy('${c.name}')">매수</button>
          <button onclick="sell('${c.name}')">매도</button>
        </div>
      </div>`;
    container.appendChild(div);
  });
  updateChart(); renderUserInfo();
}

let chartInited = false;
function ensureChart(){
  if(chartInited) return;
  const ctx=document.getElementById('chart').getContext('2d');
  chart=new Chart(ctx,{ type:'line',
    data:{ labels:[0], datasets:companies.map(c=>({label:c.name,data:c.history,
      borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), fill:false}))},
    options:{ responsive:true, animation:false,
      scales:{ x:{title:{display:true,text:"틱"}}, y:{title:{display:true,text:"가격(KRW)"}}}}
  });
  chartInited = true;
}
function updateChart(){
  ensureChart();
  // 히스토리 가장 긴 길이 기준으로 라벨 생성
  const maxLen = Math.max(...companies.map(c => c.history.length));
  chart.data.labels = Array.from({length:maxLen},(_,i)=>i);
  chart.data.datasets.forEach((d,i)=>{ d.data=companies[i].history; });
  chart.update();
}

/* ===== 매수/매도 ===== */
window.buy=async function(name){
  const qty=Math.max(1, parseInt(document.getElementById(`qty-${name}`).value,10) || 1);
  const c=companies.find(x=>x.name===name);
  if(player.cash<c.price*qty){ alert("현금 부족"); return; }
  player.cash-=c.price*qty;
  player.holdings[name]=(player.holdings[name]||0)+qty;
  log(`✅ ${currentUser.name} ${name} ${qty}주 매수 @ ${c.price}`);
  await syncUserData();
  // 숫자 너무 길어져 줄바꿈되는 문제 방지: 값만 갱신
  const holdingSpan=document.getElementById(`holding-${c.name}`);
  if(holdingSpan) holdingSpan.textContent = player.holdings[c.name];
  renderUserInfo();
}
window.sell=async function(name){
  const qty=Math.max(1, parseInt(document.getElementById(`qty-${name}`).value,10) || 1);
  const c=companies.find(x=>x.name===name);
  if((player.holdings[name]||0)<qty){ alert("보유 주식 부족"); return; }
  player.cash+=c.price*qty;
  player.holdings[name]-=qty;
  log(`✅ ${currentUser.name} ${name} ${qty}주 매도 @ ${c.price}`);
  await syncUserData();
  const holdingSpan=document.getElementById(`holding-${c.name}`);
  if(holdingSpan) holdingSpan.textContent = player.holdings[c.name];
  renderUserInfo();
}

/* ===== 입금 요청 ===== */
document.getElementById("depositBtn").addEventListener("click",()=>{
  const acc=document.getElementById("accountNumber").value.trim();
  const amt=parseInt(document.getElementById("depositAmount").value,10);
  if(!currentUser){ alert("먼저 로그인하세요."); return; }
  if(!acc||!amt||amt<=0){ alert("계좌번호/금액을 확인하세요."); return; }
  alert("현금추가 요청이 완료되었습니다. 인게임 머니 지불 후 변동됩니다");
  addDoc(collection(db,"depositRequests"),{
    userId:currentUser.id,
    userName:currentUser.name,
    account:acc, amount:amt,
    createdAt:serverTimestamp()
  });
  // 입력칸 초기화
  document.getElementById("accountNumber").value="";
  document.getElementById("depositAmount").value="";
});

/* ===== 관리자 코드 처리 ===== */
window.checkAdminCode=async function(){
  const code=document.getElementById("adminCode").value.trim();
  if(code==="ADMIN123"){
    loadDepositRequests();
    renderGraphControlPanel();
    document.getElementById("adminModal").style.display="flex";
  } else if(code==="SEED123"){
    await seedCompanies();
    alert("companies 컬렉션 초기 세팅 완료(존재하지 않는 문서만 생성).");
  } else {
    alert("알 수 없는 코드입니다.");
  }
}

/* ===== 입금 요청 모달 ===== */
async function loadDepositRequests(){
  const q=await getDocs(collection(db,"depositRequests"));
  const list=document.getElementById("requestsList");
  list.innerHTML="";
  q.forEach(docSnap=>{
    const r=docSnap.data();
    const div=document.createElement("div");
    div.className="requestBox";
    div.id="req-"+docSnap.id;
    div.innerHTML=`
      <strong>${r.userName}(${r.userId})</strong><br>
      계좌: ${r.account}<br>
      금액: ${Number(r.amount||0).toLocaleString()} KRW<br>
      <button onclick="approveRequest('${docSnap.id}','${r.userId}',${Number(r.amount||0)})">승인</button>
      <button onclick="rejectRequest('${docSnap.id}')">거절</button>
    `;
    list.appendChild(div);
  });
}
window.approveRequest=async function(reqId,userId,amount){
  const userRef=doc(db,"users",userId);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    await updateDoc(userRef,{ cash:(data.cash||0)+amount });
  }
  await addDoc(collection(db,"depositHistory"),{
    userId:userId, amount:amount, status:"approved", processedAt:serverTimestamp()
  });
  await deleteDoc(doc(db,"depositRequests",reqId));
  const el=document.getElementById("req-"+reqId);
  if(el) el.remove();
}
window.rejectRequest=async function(reqId){
  await addDoc(collection(db,"depositHistory"),{
    requestId:reqId, status:"rejected", processedAt:serverTimestamp()
  });
  await deleteDoc(doc(db,"depositRequests",reqId));
  const el=document.getElementById("req-"+reqId);
  if(el) el.remove();
}
window.closeAdminModal=function(){ document.getElementById("adminModal").style.display="none"; }

/* ===== 그래프 중앙 제어 패널 ===== */
function renderGraphControlPanel(){
  const wrap = document.getElementById("graphControl");
  wrap.innerHTML = "";
  companies.forEach(c=>{
    const row = document.createElement('div');
    row.className = 'graphRow';
    row.innerHTML = `
      <div class="name">${c.name}</div>
      <div>현재 간격: <span id="interval-cur-${c.name}">${c.interval} ms</span></div>
      <input type="number" id="interval-input-${c.name}" placeholder="새 간격(ms)" min="1000">
      <button onclick="saveInterval('${c.name}')">간격 저장</button>
    `;
    wrap.appendChild(row);
  });
  document.getElementById("startGraphBtn").onclick = startCentralUpdates;
  document.getElementById("stopGraphBtn").onclick = stopCentralUpdates;
}

window.saveInterval = async function(name){
  const input = document.getElementById(`interval-input-${name}`);
  const ms = parseInt(input.value,10);
  if(!ms || ms<1000){ alert("간격(ms)은 1000 이상이어야 합니다."); return; }
  // Firestore에 저장
  const ref = doc(db,"companies",name);
  const snap = await getDoc(ref);
  if(snap.exists()){
    await updateDoc(ref,{ interval: ms });
  } else {
    // 문서가 없으면 기본값으로 생성
    await setDoc(ref,{ price: 1000, history:[1000], interval: ms });
  }
  // 로컬에도 반영
  const c = companies.find(x=>x.name===name);
  if(c){ c.interval = ms; }
  const curSpan = document.getElementById(`interval-cur-${name}`);
  if(curSpan) curSpan.textContent = `${ms} ms`;

  // 중앙 컨트롤 중이면 해당 기업 타이머 재설정
  if(isGraphMaster){ setCompanyTimer(name); }
  input.value="";
  log(`🛠 ${name} 변동 간격이 ${ms}ms 로 저장됨`);
}

/* ===== 중앙 랜덤 변동 ===== */
async function randomUpdateCompany(name){
  const ref = doc(db,"companies",name);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    // 문서 없으면 기본 생성
    const initPrice = companies.find(c=>c.name===name)?.price || 1000;
    await setDoc(ref,{ price:initPrice, history:[initPrice], interval:5000 });
    return;
  }
  const data = snap.data();
  const current = Number(data.price)||1;
  const shock = (Math.random()-0.5)*0.1; // ±10%
  const newPrice = Math.max(1, Math.floor(current*(1+shock)));
  let history = Array.isArray(data.history) ? [...data.history] : [current];
  history.push(newPrice);
  const MAX_LEN = 200; // 차트 메모리 방지
  if(history.length > MAX_LEN) history = history.slice(history.length - MAX_LEN);

  await updateDoc(ref,{ price:newPrice, history:history });
}

function setCompanyTimer(name){
  // 기존 타이머 제거
  if(timers[name]) { clearInterval(timers[name]); timers[name] = null; }
  const c = companies.find(x=>x
