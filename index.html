<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>떡잎방범대 주식 센터</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1f2937; --ink:#e5e7eb; --ink2:#cbd5e1;
      --accent:#334155; --accentH:#475569; --danger:#7f1d1d; --ok:#065f46; --warn:#92400e;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px; }
    h1 { text-align:center; margin:4px 0 16px }

    #userRow,#log { margin:20px auto; max-width:1100px; }
    #userRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    #userInfo { font-size:16px; }

    #depositForm { display:flex; justify-content:center; align-items:center; gap:10px; margin:20px auto; max-width:1100px; }
    #depositForm input { padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    #depositForm .memo { min-width:220px; }
    #depositForm button#requestDepositBtn { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    #depositForm button#requestDepositBtn:hover { background:var(--accentH); }

    button { padding:8px 12px; cursor:pointer; border-radius:8px; background:var(--accent); color:var(--ink); border:none; transition:opacity .15s ease; }
    button:hover { background:var(--accentH); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #chartWrap { position:relative; margin:20px auto; max-width:1100px; height:400px; background:#111827; border-radius:10px; overflow:hidden; }
    #chart { position:absolute; inset:0; width:100% !important; height:100% !important; }

    #companies { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:20px auto; max-width:1100px; }
    .company { background:var(--card); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; position:relative; }
    .company .info { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; align-items:center; font-weight:600; }
    .company .actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .company .actions input[type="number"] { grid-column:span 2; padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
    .company .actions input[type="number"]:disabled { opacity:.45; cursor:not-allowed; }

    .status-badge{ font-size:14px; line-height:1; padding:4px 10px; border-radius:999px; background:#0b1220; border:1px solid #374151; color:var(--ink2); }
    .delisted-badge{ background:#331010; border-color:#7f1d1d; color:#fecaca; }

    #log { max-height:240px; overflow-y:auto; background:#111827; padding:12px; border-radius:10px; }
    .log-item { padding:6px 0; border-bottom:1px dashed #374151; font-size:14px; }
    .req-card { background:var(--card); border-radius:10px; padding:12px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:50; }
    .modal-content { background:var(--card); padding:20px; border-radius:10px; text-align:center; width:min(90%,520px); position:relative; }
    .modal-content input, .modal-content textarea { margin:8px 0; padding:8px; width:90%; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    textarea { width:100%; min-height:120px; }
    .xbtn { position:absolute; top:8px; right:8px; background:var(--danger); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1; }

    #adminLogin{ text-align:center; margin-top:20px }
    #adminLogin input{ padding:8px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--ink) }
    .admin-panel{display:none; max-width:1100px; margin:20px auto; background:var(--card); padding:10px; border-radius:10px; position:relative;}
    #adminPanelAll { position:fixed; top:50px; left:50px; z-index:9999; width:90%; max-width:1100px; pointer-events:auto; box-shadow:0 20px 40px rgba(0,0,0,.35); }
    #adminPanelHeader { background:#374151; padding:8px 44px 8px 12px; cursor:move; border-radius:10px 10px 0 0; font-weight:700; user-select:none; position:relative; }
    #adminPanelAll .xbtn { top:6px; right:6px; }

    @media (max-width:1200px){ #companies{ grid-template-columns:repeat(3,1fr) } }
    @media (max-width:900px){ #companies{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:600px){ #companies{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <h1>떡잎방범대 주식 센터</h1>

  <!-- 상단 사용자 영역 -->
  <div id="userRow">
    <div id="userInfo">⏳ 로그인 대기중...</div>
    <div>
      <button id="btnLogout">로그아웃</button>
      <button id="btnOpenWithdraw">출금 요청</button>
      <button id="btnOpenNotice">📢 공지사항</button>
      <button id="btnOpenNews">📰 뉴스 보기 <span id="newsBadge" style="display:none; color:#ef4444; font-weight:bold; margin-left:6px;">0</span></button>
    </div>
  </div>

  <!-- 입금 요청 -->
  <div id="depositForm">
    <input id="acctNo" type="text" placeholder="인게임 계좌번호 (예: ACC-00123)">
    <input id="cashAmount" type="text" placeholder="금액 (예: 1000000)">
    <input id="cashMemo" type="text" class="memo" placeholder="메모 (선택)">
    <button id="requestDepositBtn">입금 요청</button>
  </div>

  <!-- 차트 + 종목 카드 + 로그 -->
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="companies"></div>
  <div id="log"></div>

  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>정보 입력 후 시작</h2>
      <input type="text" id="customId" placeholder="고유번호 입력"><br>
      <input type="text" id="customName" placeholder="이름 입력"><br>
      <button id="startBtn">시작</button>
    </div>
  </div>

  <!-- 출금 요청 모달 -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseWithdraw">✕</button>
      <h2>출금 요청</h2>
      <input type="text" id="withdrawId" placeholder="고유번호 입력"><br>
      <input type="text" id="withdrawName" placeholder="이름 입력"><br>
      <input type="number" id="withdrawAmount" placeholder="출금 금액 입력"><br>
      <div id="withdrawFeeInfo" style="color:#9ca3af; margin:6px 0;"></div>
      <input type="text" id="withdrawAccount" placeholder="본인 계좌번호 입력"><br>
      <button id="submitWithdrawBtn">요청</button>
    </div>
  </div>

  <!-- 공지 모달 -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseNotice">✕</button>
      <h2>📢 공지사항</h2>
      <div id="noticeContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>현재 등록된 공지사항이 없습니다.</p>
      </div>
      <button id="btnCloseNotice2">닫기</button>
    </div>
  </div>

  <!-- 뉴스 모달 -->
  <div id="newsModal" class="modal">
    <div class="modal-content">
      <button class="xbtn" id="btnCloseNews">✕</button>
      <h2>📰 최신 뉴스</h2>
      <div id="newsContent" style="text-align:left; max-height:300px; overflow-y:auto; margin-top:10px;">
        <p>현재 등록된 뉴스가 없습니다.</p>
      </div>
      <button id="btnCloseNews2">닫기</button>
    </div>
  </div>

  <!-- 관리자 로그인 -->
  <div id="adminLogin">
    <input type="password" id="adminCode" placeholder="관리자 코드 입력">
    <button id="btnAdminLogin">관리자 로그인</button>
  </div>

  <!-- 관리자 패널 -->
  <div id="adminPanelAll" class="admin-panel">
    <div id="adminPanelHeader">
      ⚙️ 관리자 통합 패널
      <button class="xbtn" id="btnAdminClose">✕</button>
    </div>
    <div style="padding:10px;">
      <div style="display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap;">
        <button data-tab="graph">📊 그래프</button>
        <button data-tab="users">👥 유저</button>
        <button data-tab="finance">💳 입출금</button>
        <button data-tab="stock">🎛️ 주가조작</button>
        <button data-tab="change">📈 배율/확률</button>
        <button data-tab="news">📰 뉴스</button>
        <button data-tab="notice">📢 공지사항</button>
        <button data-tab="delist">🚫 상장폐지</button>
      </div>
      <div id="tab-graph" class="tab-section"></div>
      <div id="tab-users" class="tab-section" style="display:none;"></div>
      <div id="tab-finance" class="tab-section" style="display:none;"></div>
      <div id="tab-stock" class="tab-section" style="display:none;"></div>
      <div id="tab-change" class="tab-section" style="display:none;"></div>
      <div id="tab-news" class="tab-section" style="display:none;"></div>
      <div id="tab-notice" class="tab-section" style="display:none;"></div>
      <div id="tab-delist" class="tab-section" style="display:none;"></div>
    </div>
  </div>

  <!-- 외부 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
/* ================= Utils (최상단) ================= */
const $ = (sel)=>document.querySelector(sel);
function safeId(name){ return String(name).replace(/[^a-zA-Z0-9가-힣]/g,'_'); }
function parseNumber(str){
  const n = parseInt(String(str).replace(/[^0-9]/g,''),10);
  return isNaN(n)?0:Math.max(0,n);
}
function escapeHtml(s=''){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function log(msg){
  const div=document.createElement('div');
  div.className='log-item'; div.innerHTML=msg;
  $("#log").prepend(div);
}

/* ================= Firebase Init ================= */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc,
  onSnapshot, writeBatch, increment, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVCFjQ0ton4HPtkcYAHMeuMubH1gD1KWg",
  authDomain: "cotyledons-of-stock-a1241.firebaseapp.com",
  projectId: "cotyledons-of-stock-a1241",
  storageBucket: "cotyledons-of-stock-a1241.appspot.com",
  messagingSenderId: "962984742513",
  appId: "1:962984742513:web:25082eed6cdcc9c37b95d0",
  measurementId: "G-NRPT075Q3X"
};
let app; try{ app=getApp(); }catch{ app=initializeApp(firebaseConfig); }
const auth=getAuth(app); const db=getFirestore(app);

/* ================= State ================= */
let chart=null; let updateInterval=5000; let marketOpenFlag=false;
let volatility=1.5; let lastChartTick=0;
const marketState={ bias:{} };
const companyChances={}; const companyStatus={};
let delistPlan=null; let player={holdings:{},cash:0};
let currentUser=null; let unsubscribeUser=null;

/* ================= Companies ================= */
const companies=[
  {name:"떡잎방범대", basePrice:10000000},
  {name:"카스틸로", basePrice:10000000},
  {name:"사쿠라", basePrice:10000000},
  {name:"청룡", basePrice:10000000},
  {name:"경찰청", basePrice:10000000},
  {name:"Ems", basePrice:10000000},
  {name:"올드보이", basePrice:10000000},
  {name:"작두", basePrice:10000000},
  {name:"빅딕", basePrice:10000000},
  {name:"유토피아", basePrice:10000000},
  {name:"inback", basePrice:10000000},
].map(c=>({...c,id:safeId(c.name),multiplier:1,livePrice:c.basePrice}));

function findCompanyById(id){ return companies.find(x=>x.id===id||x.name===id); }
function getDisplayPrice(c){ return Math.max(1,Math.floor(c.livePrice||c.basePrice)); }
function companyIsDelisted(c){ return !!(companyStatus[c.id]?.delisted); }

/* ================= Chart ================= */
function initChart(){
  if(chart) return;
  const ctx=$("#chart").getContext("2d");
  chart=new Chart(ctx,{
    type:"line",
    data:{ labels:[], datasets:companies.map(c=>({label:c.name,data:[],borderWidth:2,fill:false,tension:0.25})) },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{legend:{position:"bottom"}},
      scales:{ x:{title:{display:true,text:"시간"}}, y:{title:{display:true,text:"가격(KRW)"},beginAtZero:false}}
    }
  });
}
function appendChartPoint(t){
  if(!chart) return;
  const label=new Date(t||Date.now()).toLocaleTimeString();
  chart.data.labels.push(label);
  companies.forEach((c,i)=>chart.data.datasets[i].data.push(getDisplayPrice(c)));
  if(chart.data.labels.length>120){
    chart.data.labels.splice(0,chart.data.labels.length-120);
    chart.data.datasets.forEach(d=>{if(d.data.length>120) d.data.splice(0,d.data.length-120);});
  }
  chart.update("none");
}

/* ================= UI Rendering ================= */
function getQty(name){
  const el=$("#qty-"+safeId(name));
  return Math.max(1,parseInt(el?.value)||1);
}
function updateMaxBuyUI(){
  companies.forEach(c=>{
    const el=$("#maxbuy-"+c.id);
    if(el){ const price=getDisplayPrice(c); const maxQty=Math.floor((player.cash||0)/price);
      el.textContent=`(최대 ${maxQty}주 매수 가능)`; }
  });
}
function updateHoldingsUI(){
  companies.forEach(c=>{ const el=$("#hold-"+c.id); if(el) el.textContent=(player.holdings[c.name]||0); });
  updateMaxBuyUI();
}
function renderUserInfo(){
  if(currentUser){
    $("#userInfo").innerHTML=`👤 <strong>${escapeHtml(currentUser.name)}</strong> (${escapeHtml(currentUser.id)}) | 💵 보유현금: <strong>${(player.cash||0).toLocaleString()} KRW</strong>`;
  }else $("#userInfo").textContent="⏳ 로그인 대기중...";
  updateMaxBuyUI();
}
function initCompaniesUI(){
  $("#companies").innerHTML=companies.map(c=>{
    const delisted=companyIsDelisted(c);
    return `<div class="company" id="card-${c.id}">
      <div class="info"><span>${escapeHtml(c.name)}</span>
      <span class="status-badge ${delisted?'delisted-badge':''}" id="marketStatus-${c.id}">${delisted?'🚫 상장폐지':'🟡 대기'}</span></div>
      <div>가격: <strong><span id="price-${c.id}">${getDisplayPrice(c).toLocaleString()}</span> KRW</strong></div>
      <div>보유: <span id="hold-${c.id}">${player.holdings[c.name]||0}</span> 주
      <span id="maxbuy-${c.id}" style="color:#10b981;font-size:13px;margin-left:6px;">(최대 ${Math.floor((player.cash||0)/getDisplayPrice(c))}주 매수 가능)</span></div>
      <div class="actions">
        <input type="number" id="qty-${c.id}" min="1" value="1" ${(!marketOpenFlag||delisted)?'disabled':''}>
        <button data-role="buy" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>매수</button>
        <button data-role="sell" data-id="${c.id}" ${(!marketOpenFlag||delisted)?'disabled':''}>매도</button>
      </div></div>`;
  }).join("");
  $("#companies").onclick=(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    const comp=findCompanyById(btn.dataset.id); if(!comp) return;
    const qty=getQty(comp.name);
    if(btn.dataset.role==="buy") buy(comp.name,qty);
    if(btn.dataset.role==="sell") sell(comp.name,qty);
  };
  updateMaxBuyUI();
}

/* ================= Trade ================= */
function impactPrice(id,qty,mode){
  const c=findCompanyById(id); if(!c||companyIsDelisted(c)) return;
  const step=Math.min(0.1,Math.max(1,qty)/10000);
  marketState.bias[c.id]=Math.max(-1,Math.min(1,(marketState.bias[c.id]||0)+(mode==="buy"?-step:+step)));
}
async function buy(name,qty){
  if(!marketOpenFlag) return alert("⛔ 장 마감 중");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("상장폐지 종목 거래 불가");
  if(!currentUser) return alert("로그인 필요");
  const p=getDisplayPrice(c), total=p*qty;
  if(player.cash<total) return alert("현금 부족");
  player.cash-=total; player.holdings[c.name]=(player.holdings[c.name]||0)+qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`🟢 매수체결: [${c.name}] ${qty}주 @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("매수 저장 실패:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"buy");
}
async function sell(name,qty){
  if(!marketOpenFlag) return alert("⛔ 장 마감 중");
  const c=findCompanyById(name); if(!c) return;
  if(companyIsDelisted(c)) return alert("상장폐지 종목 거래 불가");
  if(!currentUser) return alert("로그인 필요");
  if((player.holdings[c.name]||0)<qty) return alert("보유 부족");
  const p=getDisplayPrice(c), total=p*qty;
  player.cash+=total; player.holdings[c.name]-=qty;
  try{
    await setDoc(doc(db,"users",currentUser.id),{cash:player.cash,holdings:player.holdings,updatedAt:Date.now()},{merge:true});
    log(`🔴 매도체결: [${c.name}] ${qty}주 @ ${p.toLocaleString()} = ${total.toLocaleString()}`);
  }catch(e){ alert("매도 저장 실패:"+e.message); }
  renderUserInfo(); updateHoldingsUI(); impactPrice(c.id,qty,"sell");
}

/* ================= Auth / Session ================= */
async function ensureAuth(){
  return new Promise(res=>{
    onAuthStateChanged(auth,u=>{ if(u) res(u); else signInAnonymously(auth).then(r=>res(r.user)).catch(()=>res(null)); });
  });
}
function subscribeCurrentUser(uid){
  if(unsubscribeUser){unsubscribeUser();unsubscribeUser=null;}
  unsubscribeUser=onSnapshot(doc(db,"users",uid),(snap)=>{
    if(!snap.exists()) return;
    const d=snap.data(); player.cash=d.cash||0; player.holdings=d.holdings||{};
    renderUserInfo(); updateHoldingsUI();
  });
}
$("#startBtn").onclick=async()=>{
  const cid=$("#customId").value.trim(), cname=$("#customName").value.trim();
  if(!cid||!cname) return alert("고유번호/이름 입력");
  await ensureAuth();
  const ref=doc(db,"users",cid); const snap=await getDoc(ref);
  let cash=0,hold={}; if(snap.exists()){cash=snap.data().cash||0; hold=snap.data().holdings||{};}
  currentUser={id:cid,name:cname}; player.cash=cash; player.holdings=hold;
  await setDoc(ref,{id:cid,name:cname,cash,holdings:hold,active:true,lastLoginAt:Date.now()},{merge:true});
  localStorage.setItem("stockUser",JSON.stringify({id:cid,name:cname}));
  $("#loginModal").style.display="none"; renderUserInfo(); initCompaniesUI(); subscribeCurrentUser(cid);
};
$("#btnLogout").onclick=async()=>{
  if(currentUser) await updateDoc(doc(db,"users",currentUser.id),{active:false,lastLogoutAt:Date.now()});
  localStorage.removeItem("stockUser"); location.reload();
};
window.addEventListener("load",async()=>{
  await ensureAuth();
  const saved=localStorage.getItem("stockUser");
  if(saved){ try{ const p=JSON.parse(saved); if(p.id){ currentUser=p; $("#loginModal").style.display="none"; subscribeCurrentUser(p.id); } }catch{} }
  initChart(); companies.forEach(c=>c.livePrice=c.basePrice); appendChartPoint(Date.now());
});
</script>

  <script type="module">
/* ================= Deposit / Withdraw 요청 (사용자) ================= */
async function requestDeposit(){
  const id=currentUser?.id||"", name=currentUser?.name||"";
  const account=$("#acctNo").value.trim();
  const amount=parseNumber($("#cashAmount").value);
  const memo=$("#cashMemo").value.trim();
  if(!id||!name||!account||amount<=0) return alert("⚠️ 계좌번호와 금액 입력 필요");
  try{
    await addDoc(collection(db,"depositRequests"),{userId:id,userName:name,account,amount,memo,status:"pending",createdAt:Date.now()});
    alert(`💰 ${amount.toLocaleString()} KRW 입금 요청 완료`);
    log(`💰 입금요청: ${amount.toLocaleString()} (${escapeHtml(account)})`);
    $("#acctNo").value=""; $("#cashAmount").value=""; $("#cashMemo").value="";
  }catch(e){ alert("입금 요청 오류:"+e.message); }
}
$("#requestDepositBtn").onclick=requestDeposit;

async function submitWithdraw(){
  const id=$("#withdrawId").value.trim();
  const name=$("#withdrawName").value.trim();
  const amount=parseNumber($("#withdrawAmount").value);
  const account=$("#withdrawAccount").value.trim();
  if(!id||!name||!account||amount<=0) return alert("⚠️ 모든 항목 입력 필요");
  try{
    await addDoc(collection(db,"withdrawRequests"),{userId:id,userName:name,amount,account,status:"pending",createdAt:Date.now()});
    alert("📤 출금 요청 접수됨");
    const fee=Math.floor(amount*0.1);
    log(`📤 출금요청: ${amount.toLocaleString()} KRW (수수료 ${fee.toLocaleString()} / 실지급 ${(amount-fee).toLocaleString()})`);
    $("#withdrawModal").style.display="none";
  }catch(e){ alert("출금 요청 오류:"+e.message); }
}
$("#submitWithdrawBtn").onclick=submitWithdraw;

/* ================= 뉴스 구독 ================= */
let newsData=[],newsDataAll=[],lastReadNewsAt=Number(localStorage.getItem("lastReadNewsAt")||0);
function updateNewsBadge(count){
  if(count>0){ $("#newsBadge").style.display="inline"; $("#newsBadge").textContent=String(count);}
  else $("#newsBadge").style.display="none";
}
function renderNewsModal(){
  if(!newsData.length){ $("#newsContent").innerHTML="<p>현재 등록된 뉴스가 없습니다.</p>"; return; }
  $("#newsContent").innerHTML=newsData.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0;border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||'제목 없음')}</div>
      <div style="color:#9ca3af;font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||'').replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNews(){
  const qy=query(collection(db,"news"),orderBy("createdAt","desc"));
  onSnapshot(qy,snap=>{
    const vis=[],all=[];
    snap.forEach(d=>{const n={id:d.id,...d.data()}; all.push(n); if(n.visible!==false) vis.push(n);});
    newsData=vis; newsDataAll=all;
    const unread=vis.filter(n=>(n.createdAt||0)>lastReadNewsAt).length;
    updateNewsBadge(unread); renderNewsModal();
  });
}
$("#btnOpenNews").onclick=()=>{
  $("#newsModal").style.display="flex";
  lastReadNewsAt=Date.now(); localStorage.setItem("lastReadNewsAt",String(lastReadNewsAt));
  updateNewsBadge(0);
};
$("#btnCloseNews").onclick=()=>$("#newsModal").style.display="none";
$("#btnCloseNews2").onclick=()=>$("#newsModal").style.display="none";

/* ================= 공지 구독 ================= */
let noticeDataAll=[];
function renderNoticeModal(){
  if(!noticeDataAll.length){ $("#noticeContent").innerHTML="<p>현재 등록된 공지사항이 없습니다.</p>"; return; }
  $("#noticeContent").innerHTML=noticeDataAll.map(n=>{
    const dt=new Date(n.createdAt||Date.now()).toLocaleString();
    return `<div style="padding:8px 0;border-bottom:1px solid #374151;">
      <div style="font-weight:700;">${escapeHtml(n.title||'공지')}</div>
      <div style="color:#9ca3af;font-size:12px;">${dt}</div>
      <div style="margin-top:6px;">${escapeHtml(n.content||'').replace(/\n/g,"<br>")}</div>
    </div>`;
  }).join("");
}
function subscribeNotices(){
  const qy=query(collection(db,"notices"),orderBy("createdAt","desc"));
  onSnapshot(qy,snap=>{
    noticeDataAll=[]; snap.forEach(d=>noticeDataAll.push({id:d.id,...d.data()}));
    renderNoticeModal();
  });
}
$("#btnOpenNotice").onclick=()=>$("#noticeModal").style.display="flex";
$("#btnCloseNotice").onclick=()=>$("#noticeModal").style.display="none";
$("#btnCloseNotice2").onclick=()=>$("#noticeModal").style.display="none";

/* ================= 회사 가격/상태 구독 ================= */
function subscribeCompanyPrices(){
  onSnapshot(collection(db,"companyPrices"),snap=>{
    let maxTick=0;
    snap.forEach(d=>{
      const data=d.data(),c=findCompanyById(d.id); if(!c) return;
      if(typeof data.current==="number") c.livePrice=data.current;
      if(data.updatedAt) maxTick=Math.max(maxTick,data.updatedAt);
      $("#price-"+c.id).textContent=getDisplayPrice(c).toLocaleString();
    });
    updateMaxBuyUI();
    if(maxTick>lastChartTick){ lastChartTick=maxTick; appendChartPoint(maxTick); }
  });
}
function subscribeCompanyStatus(){
  onSnapshot(collection(db,"companyStatus"),snap=>{
    snap.forEach(d=>{companyStatus[d.id]={delisted:!!d.data().delisted,delistedAt:d.data().delistedAt||null};});
    companies.forEach(c=>{
      const st=$("#marketStatus-"+c.id);
      if(st){ st.textContent=companyIsDelisted(c)?"🚫 상장폐지":(marketOpenFlag?"🟢 개장":"🔴 마감");
        st.classList.toggle("delisted-badge",companyIsDelisted(c)); }
    });
  });
}
function subscribeMarketState(){
  onSnapshot(doc(db,"marketState","main"),snap=>{
    const d=snap.data()||{}; marketOpenFlag=!!d.isOpen;
    if(typeof d.interval==="number") updateInterval=d.interval;
    delistPlan=d.delistPlan||null;
  });
}
subscribeNews(); subscribeNotices(); subscribeCompanyPrices(); subscribeCompanyStatus(); subscribeMarketState();
</script>

  /* =========================
   Part 4-2: Admin Logic
   ========================= */

/* 공통 유틸 (파트2에서 이미 있으나 안전차원) */
const parseIntSafe = (v, d=0)=>{ const n = parseInt(v,10); return Number.isFinite(n)?n:d; };

/* ----- 그래프/가격 조정 ----- */
function refreshCompanyIdsFromDOM(){
  return Array.from($("#companies").querySelectorAll(".company")).map(card=>{
    const id = (card.id||"").replace(/^card-/,'');
    const name = (card.querySelector('.info span')?.textContent||id).trim();
    return { id, name };
  });
}
async function setMarketOpen(open){
  if(!ADMIN_MODE) return alert("관리자 전용");
  await setDoc(doc(db,"marketState","main"), { isOpen: !!open, updatedAt: Date.now() }, { merge:true });
  alert(open?"✅ 장 시작":"📉 장 마감");
}
async function resetGraph(){
  if(!ADMIN_MODE) return alert("관리자 전용");
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current:10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  if(chart){ chart.data.labels=[]; chart.data.datasets.forEach(d=>d.data=[]); chart.update(); }
  alert("✅ 그래프 초기화 완료");
}
async function adjustAllPrices(){
  if(!ADMIN_MODE) return;
  const delta = parseIntSafe($("#allDelta").value, 0);
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyPrices",id), { current: increment(delta), updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert(`✅ 전체 일괄 조정: ${delta>=0?'+':''}${delta}`);
}
async function adjustCompanyPriceById(id, delta){
  if(!ADMIN_MODE) return;
  await setDoc(doc(db,"companyPrices",id), { current: increment(parseIntSafe(delta,0)), updatedAt: Date.now() }, { merge:true });
}
async function applyGraphInterval(){
  if(!ADMIN_MODE) return;
  const sec = Math.max(1, parseIntSafe($("#intervalInput").value, 5));
  await setDoc(doc(db,"marketState","main"), { interval: sec*1000, updatedAt: Date.now() }, { merge:true });
  alert(`✅ 변동 주기 적용: ${sec}s`);
}
function applyDeltaMax(){
  if(!ADMIN_MODE) return;
  deltaMax = Math.max(1, parseIntSafe($("#deltaMaxInput").value, 1000000));
  alert(`✅ 1틱 상한(±원) 변경: ${deltaMax.toLocaleString()}`);
}
function renderGraphAdjustPanel(){
  const wrap = $("#graphCompanyAdjust");
  const items = refreshCompanyIdsFromDOM();
  wrap.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="number" data-role="adj-input" data-id="${id}" value="10000" style="width:110px;">
        <button data-role="adj-apply" data-id="${id}">적용</button>
      </div>
    </div>
  `).join('') || '회사 없음';
  wrap.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="adj-apply"]'); if(!btn) return;
    const id = btn.dataset.id;
    const inp = wrap.querySelector(`input[data-role="adj-input"][data-id="${id}"]`);
    await adjustCompanyPriceById(id, parseIntSafe(inp?.value,0));
  };
}

/* ----- 유저/권한/강제로그아웃 ----- */
function subscribeUsersPanel(){
  const host = $("#userList"); if(!host) return;
  host.textContent = "불러오는 중...";
  onSnapshot(collection(db,"users"), snap=>{
    let html = '';
    snap.forEach(d=>{
      const u = d.data()||{};
      const hold = u.holdings || {};
      const holdTxt = Object.entries(hold).map(([k,v])=>`${escapeHtml(k)}:${v}`).join(', ') || '보유 없음';
      html += `
        <div class="req-card">
          <div>
            <div><strong>${escapeHtml(u.name||'-')}</strong> (${d.id}) ${u.active?'🟢':'🔴'} ${u.isAdmin?'<span style="color:#10b981">관리자🛡️</span>':''}</div>
            <div>현금: ${Number(u.cash||0).toLocaleString()} KRW</div>
            <div>보유: ${holdTxt}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-action="force-logout" data-id="${d.id}">강제 로그아웃</button>
            ${u.isAdmin
              ? `<button data-action="demote" data-id="${d.id}">권한 해제</button>`
              : `<button data-action="promote" data-id="${d.id}">권한 부여</button>`
            }
          </div>
        </div>`;
    });
    host.innerHTML = html || '유저 없음';
  });
  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("관리자 전용");
    const action = btn.dataset.action, uid = btn.dataset.id;
    if(action==="force-logout"){
      await updateDoc(doc(db,"users",uid), { active:false, lastLogoutAt: Date.now() });
      alert("👤 강제 로그아웃 완료");
    }else if(action==="promote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:true, updatedAt: Date.now() });
      alert("🛡️ 권한 부여");
    }else if(action==="demote"){
      await updateDoc(doc(db,"users",uid), { isAdmin:false, updatedAt: Date.now() });
      alert("⚠️ 권한 해제");
    }
  };
}

/* ----- 입출금 큐 ----- */
function subscribeFinanceQueues(){
  const dep = $("#depositRequests"), wdr = $("#withdrawRequests");
  if(dep){
    dep.textContent = "불러오는 중...";
    onSnapshot(collection(db,"depositRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>계좌: ${escapeHtml(r.account||'')}</div>
              <div>금액: ${Number(r.amount||0).toLocaleString()} KRW</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="dep" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${Number(r.amount||0)}">승인</button>
              <button data-kind="dep" data-do="reject" data-id="${d.id}">거절</button>
            </div>
          </div>`;
      });
      dep.innerHTML = html || '대기중인 입금 요청 없음';
    });
    dep.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("관리자 전용");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='dep') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        await updateDoc(doc(db,"users",uid), { cash: increment(amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"depositRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"depositRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }

  if(wdr){
    wdr.textContent = "불러오는 중...";
    onSnapshot(collection(db,"withdrawRequests"), snap=>{
      let html = '';
      snap.forEach(d=>{
        const r = d.data()||{};
        if(r.status!=="pending") return;
        const amt = Number(r.amount||0), fee=Math.floor(amt*0.1);
        html += `
          <div class="req-card">
            <div>
              <div><strong>${escapeHtml(r.userName||'')}</strong> (${escapeHtml(r.userId||'')})</div>
              <div>요청액: ${amt.toLocaleString()} KRW (수수료 ${fee.toLocaleString()} / 실지급 ${(Math.max(0,amt-fee)).toLocaleString()})</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button data-kind="wdr" data-do="approve" data-id="${d.id}" data-uid="${escapeHtml(r.userId||'')}" data-amt="${amt}">승인</button>
              <button data-kind="wdr" data-do="reject" data-id="${d.id}">거절</button>
            </div>
          </div>`;
      });
      wdr.innerHTML = html || '대기중인 출금 요청 없음';
    });
    wdr.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(!ADMIN_MODE) return alert("관리자 전용");
      const kind=btn.dataset.kind, act=btn.dataset.do, id=btn.dataset.id;
      if(kind!=='wdr') return;
      if(act==='approve'){
        const uid=btn.dataset.uid, amt=parseIntSafe(btn.dataset.amt,0);
        const us = await getDoc(doc(db,"users",uid));
        const cash = Number(us.data()?.cash||0);
        if(cash < amt) return alert("❌ 사용자 보유 현금 부족");
        await updateDoc(doc(db,"users",uid), { cash: increment(-amt), updatedAt: Date.now() });
        await updateDoc(doc(db,"withdrawRequests",id), { status:"approved", updatedAt: Date.now() });
      }else if(act==='reject'){
        await updateDoc(doc(db,"withdrawRequests",id), { status:"rejected", updatedAt: Date.now() });
      }
    };
  }
}

/* ----- 주가조작(틱 버튼) ----- */
function renderStockTuner(){
  const host = $("#stockTuner"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div><strong>${escapeHtml(name)}</strong></div>
      <div style="display:flex; gap:6px;">
        <button data-role="tune" data-id="${id}" data-delta="-100000">-10만</button>
        <button data-role="tune" data-id="${id}" data-delta="-10000">-1만</button>
        <button data-role="tune" data-id="${id}" data-delta="10000">+1만</button>
        <button data-role="tune" data-id="${id}" data-delta="100000">+10만</button>
      </div>
    </div>`).join('') || '종목 없음';
  host.onclick = async (e)=>{
    const btn = e.target.closest('button[data-role="tune"]'); if(!btn) return;
    if(!ADMIN_MODE) return alert("관리자 전용");
    await adjustCompanyPriceById(btn.dataset.id, parseIntSafe(btn.dataset.delta,0));
  };
}

/* ----- 배율/확률 패널 ----- */
function renderChangePanel(){
  const host = $("#changePanel"); if(!host) return;
  const items = refreshCompanyIdsFromDOM();
  host.innerHTML = items.map(({id,name})=>`
    <div class="req-card">
      <div style="min-width:220px;">
        <div><strong>${escapeHtml(name)}</strong></div>
        <div style="font-size:12px;color:#9ca3af;">배율/확률 저장 시 즉시 반영</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="number" step="0.1" value="1" style="width:90px;" data-role="mul" data-id="${id}">
        <button data-role="mul-apply" data-id="${id}">배율적용</button>
        <span style="width:8px"></span>
        <input type="number" step="0.01" min="0" max="1" value="0.4" style="width:90px;" data-role="up" data-id="${id}">
        <input type="number" step="0.01" min="0" max="1" value="0.6" style="width:90px;" data-role="down" data-id="${id}">
        <button data-role="chance-apply" data-id="${id}">확률적용</button>
        <span style="width:8px"></span>
        <input type="number" step="1" value="10000" style="width:100px;" data-role="bump" data-id="${id}">
        <button data-role="bump-apply" data-id="${id}">즉시±반영</button>
      </div>
    </div>
  `).join('') || '종목 없음';

  host.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("관리자 전용");
    const id = btn.dataset.id, role = btn.dataset.role;
    if(role==='mul-apply'){
      const v = Number(host.querySelector(`input[data-role="mul"][data-id="${id}"]`)?.value||1);
      const m = Number.isFinite(v)?Math.max(0,v):1;
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
      alert("배율 적용");
    }else if(role==='chance-apply'){
      const up = Number(host.querySelector(`input[data-role="up"][data-id="${id}"]`)?.value||0.4);
      const dn = Number(host.querySelector(`input[data-role="down"][data-id="${id}"]`)?.value||0.6);
      if(!(up>=0 && dn>=0 && (up+dn)>0 && up<=1 && dn<=1)) return alert("0~1, 합계>0");
      await setDoc(doc(db,"companyChances",id), { profit:up, loss:dn, updatedAt: Date.now() }, { merge:true });
      alert("확률 적용");
    }else if(role==='bump-apply'){
      const delta = parseIntSafe(host.querySelector(`input[data-role="bump"][data-id="${id}"]`)?.value, 0);
      await adjustCompanyPriceById(id, delta);
    }
  };

  // 전역 버튼
  $("#applyAllChanceBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const p = parseFloat($("#globalProfit").value), l = parseFloat($("#globalLoss").value);
    if(!(p>=0 && l>=0 && (p+l)>0 && p<=1 && l<=1)) return alert("0~1, 합계>0");
    for(const {id} of items){
      await setDoc(doc(db,"companyChances",id), { profit:p, loss:l, updatedAt: Date.now() }, { merge:true });
    }
    alert("✅ 전체 확률 적용");
  };
  $("#applyAllMultiplierBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const v = Number($("#allMultiplierVal").value);
    const m = Number.isFinite(v)?Math.max(0,v):1;
    for(const {id} of items){
      await setDoc(doc(db,"companySettings",id), { multiplier:m, updatedAt: Date.now() }, { merge:true });
    }
    alert("✅ 전체 배율 적용");
  };
  $("#applyVolatilityBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const v = Number($("#volatilityInput").value);
    const vv = Number.isFinite(v)?Math.max(0,v):1.5;
    await setDoc(doc(db,"globals","settings"), { volatility: vv, updatedAt: Date.now() }, { merge:true });
    alert(`✅ 전역 변동폭 ${vv}% 적용`);
  };
}

/* ----- 뉴스/공지 (관리자) ----- */
function subscribeNewsAdmin(){
  const list = $("#newsList"); if(!list) return;
  list.textContent = "불러오는 중...";
  const qy = query(collection(db,"news"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"제목 없음");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      const vis = (n.visible!==false);
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
            <div style="color:${vis?'#10b981':'#ef4444'}; font-size:12px; margin-top:4px;">${vis?'표시중':'숨김'}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="news-toggle" data-id="${n.id}" data-visible="${vis}">${vis?'숨김':'표시'}</button>
            <button data-role="news-del" data-id="${n.id}" style="background:#7f1d1d;">삭제</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || '등록된 뉴스가 없습니다.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("관리자 전용");
    const role = btn.dataset.role, id = btn.dataset.id;
    if(role==='news-toggle'){
      const cur = btn.dataset.visible === 'true';
      await updateDoc(doc(db,"news",id), { visible: !cur, updatedAt: Date.now() });
    }else if(role==='news-del'){
      if(!confirm("정말 삭제하시겠습니까?")) return;
      await deleteDoc(doc(db,"news",id));
    }
  };
  $("#postNewsBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const title = ($("#newsTitleInput").value||"").trim();
    const content = ($("#newsBodyInput").value||"").trim();
    if(!title||!content) return alert("제목/내용 입력");
    await addDoc(collection(db,"news"), { title, content, createdAt: Date.now(), visible: true, author: currentUser?.name||'관리자' });
    $("#newsTitleInput").value=''; $("#newsBodyInput").value='';
    alert("📰 뉴스 등록");
  };
}
function subscribeNoticeAdmin(){
  const list = $("#noticeList"); if(!list) return;
  list.textContent = "불러오는 중...";
  const qy = query(collection(db,"notices"), orderBy("createdAt","desc"));
  onSnapshot(qy, snap=>{
    let html=''; snap.forEach(d=>{
      const n = { id:d.id, ...(d.data()||{}) };
      const dt = new Date(n.createdAt||Date.now()).toLocaleString();
      const title = escapeHtml(n.title||"공지사항");
      const body = escapeHtml(n.content||"");
      const short = body.length>140 ? (body.slice(0,140)+'...') : body;
      html += `
        <div class="req-card">
          <div>
            <div><strong>${title}</strong> <small style="color:#9ca3af;">${dt}</small></div>
            <div style="color:#cbd5e1; font-size:14px;">${short}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button data-role="notice-del" data-id="${n.id}" style="background:#7f1d1d;">삭제</button>
          </div>
        </div>`;
    });
    list.innerHTML = html || '등록된 공지사항이 없습니다.';
  });
  list.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(!ADMIN_MODE) return alert("관리자 전용");
    if(btn.dataset.role==='notice-del'){
      const id = btn.dataset.id;
      if(!confirm("정말 삭제하시겠습니까?")) return;
      await deleteDoc(doc(db,"notices",id));
    }
  };
  $("#postNoticeBtn").onclick = async ()=>{
    if(!ADMIN_MODE) return;
    const title = ($("#noticeTitleInput").value||"").trim();
    const content = ($("#noticeBodyInput").value||"").trim();
    if(!title||!content) return alert("제목/내용 입력");
    await addDoc(collection(db,"notices"), { title, content, createdAt: Date.now(), author: currentUser?.name||'관리자' });
    $("#noticeTitleInput").value=''; $("#noticeBodyInput").value='';
    alert("📢 공지 등록");
  };
}

/* ----- 상장폐지/부활 ----- */
let __delistPlan = null;
function populateDelistSelect(){
  const sel = $("#delistCompanySel"); if(!sel) return;
  const items = refreshCompanyIdsFromDOM();
  sel.innerHTML = items.map(({id,name})=>`<option value="${id}">${escapeHtml(name)}</option>`).join('');
}
function renderDelistStatus(){
  const el = $("#delistStatus"); if(!el) return;
  if(!__delistPlan || !__delistPlan.active){
    el.style.color = '#9ca3af';
    el.textContent = '진행 중인 상장폐지 계획이 없습니다.';
    return;
  }
  const remain = Math.max(0, (__delistPlan.endAt - Date.now()));
  const mm = Math.floor(remain/60000), ss = Math.floor((remain%60000)/1000);
  el.style.color = '#fbbf24';
  el.textContent = `진행 중: [${__delistPlan.companyId}] ${mm}분 ${ss}초 후 0원 도달 및 상장폐지 예정`;
}
function renderDelistedListSnap(snap){
  const host = $("#delistedItems"); if(!host) return;
  const items = [];
  const nameMap = Object.fromEntries(refreshCompanyIdsFromDOM().map(o=>[o.id,o.name]));
  snap?.forEach(s=>{
    const d=s.data()||{};
    if(d.delisted){
      items.push({ name: nameMap[s.id]||s.id, at: d.delistedAt? new Date(d.delistedAt).toLocaleString():'-' });
    }
  });
  host.innerHTML = items.length
    ? items.map(x=>`<div>• ${escapeHtml(x.name)} (폐지 시각: ${x.at})</div>`).join('')
    : '상장폐지된 종목 없음';
}
async function scheduleDelist(){
  if(!ADMIN_MODE) return;
  const id = $("#delistCompanySel").value;
  const mins = Math.max(1, parseIntSafe($("#delistMinutes").value,30));
  const now = Date.now();
  __delistPlan = { companyId: id, startAt: now, endAt: now + mins*60000, active:true, mode:'toZero' };
  await setDoc(doc(db,"marketState","main"), { delistPlan: __delistPlan, updatedAt: now }, { merge:true });
  renderDelistStatus();
  alert("🚫 상장폐지 계획 시작");
}
async function cancelDelist(){
  if(!ADMIN_MODE) return;
  __delistPlan = null;
  await setDoc(doc(db,"marketState","main"), { delistPlan:{active:false}, updatedAt: Date.now() }, { merge:true });
  renderDelistStatus();
  alert("취소됨");
}
async function reviveCompanies(){
  if(!ADMIN_MODE) return;
  const now = Date.now();
  const batch = writeBatch(db);
  refreshCompanyIdsFromDOM().forEach(({id})=>{
    batch.set(doc(db,"companyStatus",id), { delisted:false, revivedAt: now }, { merge:true });
    batch.set(doc(db,"companyPrices",id), { current: 10000000, updatedAt: now }, { merge:true });
  });
  await batch.commit();
  alert("✅ 부활 완료");
}

/* ----- Admin 버튼 바인딩 + 구독 ----- */
function bindGraphActions(){
  $("#marketStartBtn").onclick = ()=> setMarketOpen(true);
  $("#marketEndBtn").onclick   = ()=> setMarketOpen(false);
  $("#resetGraphBtn").onclick  = resetGraph;
  $("#applyIntervalBtn").onclick = applyGraphInterval;
  $("#applyDeltaBtn").onclick    = applyDeltaMax;
  $("#adjustAllBtn").onclick     = adjustAllPrices;
}
function bindDelistActions(){
  $("#delistStartBtn").onclick = scheduleDelist;
  $("#delistCancelBtn").onclick = cancelDelist;
  $("#reviveNowBtn").onclick = reviveCompanies;
}
function subscribeDelistRealtime(){
  onSnapshot(doc(db,"marketState","main"), snap=>{
    const d = snap.data()||{};
    __delistPlan = d.delistPlan || null;
    renderDelistStatus();
  });
  onSnapshot(collection(db,"companyStatus"), snap=>{
    renderDelistedListSnap(snap);
  });
}

/* ----- 초기화(관리자 모드 진입 시 1회 호출) ----- */
function initAdminPanelLogic(){
  // 각 탭 UI 렌더
  renderGraphAdjustPanel();
  renderStockTuner();
  renderChangePanel();
  populateDelistSelect();

  // 실시간 구독
  subscribeUsersPanel();
  subscribeFinanceQueues();
  subscribeNewsAdmin();
  subscribeNoticeAdmin();
  subscribeDelistRealtime();

  // 버튼 바인딩
  bindGraphActions();
  bindDelistActions();
}

/* ----- 그래프 탭 기본 오픈 ----- */
showTab("graph");

</script>
</body>
</html>
